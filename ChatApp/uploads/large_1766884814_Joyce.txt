import sqlite3
import os
import time
import threading
import random
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í™˜ê²½] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "multiverse_empire.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {}

# Gemini AI í´ë¼ì´ì–¸íŠ¸ ì„¤ì •
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key:
        client = genai.Client(api_key=api_key)
except:
    print("Gemini SDKê°€ ì—†ê±°ë‚˜ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. !gemini ê¸°ëŠ¥ì€ ë¹„í™œì„±í™”ë©ë‹ˆë‹¤.")

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("""
            CREATE TABLE IF NOT EXISTS users (
                nickname TEXT PRIMARY KEY, 
                money INTEGER DEFAULT 1000, 
                bank_money INTEGER DEFAULT 0
            )
        """)
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ë° ë‰´ìŠ¤ ì‹œìŠ¤í…œ]
def background_scheduler():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤ ì‹¤í–‰
        with sqlite3.connect(DB_FILE) as conn:
            # 1. ì´ì ì§€ê¸‰ (1%)
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()
        
        # 2. ì‹¤ì‹œê°„ ê²½ì œ ë‰´ìŠ¤ ì´ë²¤íŠ¸
        news_list = [
            "ğŸ“¢ [ê²½ì œ] ì œêµ­ ì€í–‰ì˜ ê¸ˆë¦¬ê°€ ìƒìŠ¹ ì¡°ì§ì„ ë³´ì…ë‹ˆë‹¤!",
            "ğŸ“¢ [ì†Œì‹] ëŒ€ê·œëª¨ ë‡Œì ˆ ì—ë„ˆì§€ê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ì±„êµ´ íš¨ìœ¨ì´ ì¦ê°€í•©ë‹ˆë‹¤.",
            "ğŸ“¢ [ê³µì§€] í˜„ì¬ ìµœê³  ë¶€ìëŠ” 'ì´ˆì›”ì' ë“±ê¸‰ì„ ìœ ì§€í•˜ê³  ìˆìŠµë‹ˆë‹¤.",
            "ğŸ“¢ [ì´ë²¤íŠ¸] ì§€ê¸ˆ ì±„íŒ…ì„ ì…ë ¥í•˜ë©´ ë³´ë„ˆìŠ¤ í¬ì¸íŠ¸ê°€ ì§€ê¸‰ë  í™•ë¥ ì´ ë†’ìŠµë‹ˆë‹¤!"
        ]
        socketio.emit('message', {'msg': random.choice(news_list), 'type': 'system'}, room='main')

# --- [3. íŠ¹ìˆ˜ ê¸°ëŠ¥ ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 1
        reward = 5000
        update_money(nick, reward, bank=True)
        pattern = f"ğŸŒ€ [{nick}] ë‡Œì ˆ ë™ë ¥ ê°€ë™ ì¤‘... (+{reward}â‚© ì…ê¸ˆ)"
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"{pattern}\në¬´í•œ ë£¨í”„ íšŸìˆ˜: {m_count}íšŒì°¨", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3)

def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [4. ë¼ìš°íŒ… ë° ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸš€ {data['nickname']}ë‹˜ì´ ë©€í‹°ë²„ìŠ¤ ì„œë²„ì— ì ‘ì†í–ˆìŠµë‹ˆë‹¤!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ìˆ˜ìµ ê³µì‹]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ [ëŒ€ìš©ëŸ‰ ë°ì´í„° ë³€í™˜]\nê¸¸ì´: {msg_len}ì\në³´ìƒ: {reward}â‚© ì ë¦½ ì™„ë£Œ\nğŸ”— íŒŒì¼ ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ ì²˜ë¦¬]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        total = user['money'] + user['bank_money']
        res = f"ğŸ’° {nick}ë‹˜ì˜ ìì‚° ë³´ê³ ì„œ\n" \
              f"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" \
              f"ğŸ’µ í˜„ê¸ˆ: {user['money']:,}â‚©\n" \
              f"ğŸ¦ ì€í–‰: {user['bank_money']:,}â‚©\n" \
              f"ğŸ’³ ì´í•©: {total:,}â‚©\n" \
              f"ğŸ† ë“±ê¸‰: {'ì´ˆì›”ì' if total >= 10000000 else 'VIP' if total >= 1000000 else 'í‰ë¯¼'}"
        emit('message', {'msg': res, 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt:,}â‚©ì„ ì€í–‰ì— ì•ˆì „í•˜ê²Œ ë³´ê´€í–ˆìŠµë‹ˆë‹¤. (ë¶„ë‹¹ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ ì€í–‰ì—ì„œ {amt:,}â‚©ì„ ì¶œê¸ˆí–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ì´ ê°€ë™ë˜ì—ˆìŠµë‹ˆë‹¤! (3ì´ˆë‹¹ 5000â‚©)", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆ ì—”ì§„ì„ ì •ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            prompt = " ".join(cmd_parts[1:])
            res = client.models.generate_content(model="gemini-2.0-flash", contents=prompt)
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except Exception as e:
            emit('message', {'msg': f"âŒ ì—ëŸ¬: {str(e)}", 'type': 'system'})

    elif cmd == "!ëª…ë ¹ì–´":
        help_msg = "ğŸ“œ [ëª…ë ¹ì–´ ë¦¬ìŠ¤íŠ¸]\n!ì”ì•¡ - ë‚´ ìì‚° í™•ì¸\n!ì €ê¸ˆ [ì•¡ìˆ˜] - ì€í–‰ì— ì…ê¸ˆ\n!ì¶œê¸ˆ [ì•¡ìˆ˜] - í˜„ê¸ˆí™”\n!ë‡Œì ˆ - ë¬´í•œ ëˆ ë²Œê¸° ì‹œì‘\n!ë‡Œì ˆì¤‘ë‹¨ - ì¤‘ì§€\n!gemini [ì§ˆë¬¸] - AI ë‹µë³€\n!ëª…ë ¹ì–´ - ë„ì›€ë§"
        emit('message', {'msg': help_msg, 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ…
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=background_scheduler, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
import random
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í™˜ê²½] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "multiverse_empire.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {}

# Gemini AI í´ë¼ì´ì–¸íŠ¸ ì„¤ì •
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key:
        client = genai.Client(api_key=api_key)
except:
    print("Gemini SDKê°€ ì—†ê±°ë‚˜ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. !gemini ê¸°ëŠ¥ì€ ë¹„í™œì„±í™”ë©ë‹ˆë‹¤.")

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("""
            CREATE TABLE IF NOT EXISTS users (
                nickname TEXT PRIMARY KEY, 
                money INTEGER DEFAULT 1000, 
                bank_money INTEGER DEFAULT 0
            )
        """)
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ë° ë‰´ìŠ¤ ì‹œìŠ¤í…œ]
def background_scheduler():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤ ì‹¤í–‰
        with sqlite3.connect(DB_FILE) as conn:
            # 1. ì´ì ì§€ê¸‰ (1%)
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()
        
        # 2. ì‹¤ì‹œê°„ ê²½ì œ ë‰´ìŠ¤ ì´ë²¤íŠ¸
        news_list = [
            "ğŸ“¢ [ê²½ì œ] ì œêµ­ ì€í–‰ì˜ ê¸ˆë¦¬ê°€ ìƒìŠ¹ ì¡°ì§ì„ ë³´ì…ë‹ˆë‹¤!",
            "ğŸ“¢ [ì†Œì‹] ëŒ€ê·œëª¨ ë‡Œì ˆ ì—ë„ˆì§€ê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ì±„êµ´ íš¨ìœ¨ì´ ì¦ê°€í•©ë‹ˆë‹¤.",
            "ğŸ“¢ [ê³µì§€] í˜„ì¬ ìµœê³  ë¶€ìëŠ” 'ì´ˆì›”ì' ë“±ê¸‰ì„ ìœ ì§€í•˜ê³  ìˆìŠµë‹ˆë‹¤.",
            "ğŸ“¢ [ì´ë²¤íŠ¸] ì§€ê¸ˆ ì±„íŒ…ì„ ì…ë ¥í•˜ë©´ ë³´ë„ˆìŠ¤ í¬ì¸íŠ¸ê°€ ì§€ê¸‰ë  í™•ë¥ ì´ ë†’ìŠµë‹ˆë‹¤!"
        ]
        socketio.emit('message', {'msg': random.choice(news_list), 'type': 'system'}, room='main')

# --- [3. íŠ¹ìˆ˜ ê¸°ëŠ¥ ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 1
        reward = 5000
        update_money(nick, reward, bank=True)
        pattern = f"ğŸŒ€ [{nick}] ë‡Œì ˆ ë™ë ¥ ê°€ë™ ì¤‘... (+{reward}â‚© ì…ê¸ˆ)"
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"{pattern}\në¬´í•œ ë£¨í”„ íšŸìˆ˜: {m_count}íšŒì°¨", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3)

def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [4. ë¼ìš°íŒ… ë° ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸš€ {data['nickname']}ë‹˜ì´ ë©€í‹°ë²„ìŠ¤ ì„œë²„ì— ì ‘ì†í–ˆìŠµë‹ˆë‹¤!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ìˆ˜ìµ ê³µì‹]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ [ëŒ€ìš©ëŸ‰ ë°ì´í„° ë³€í™˜]\nê¸¸ì´: {msg_len}ì\në³´ìƒ: {reward}â‚© ì ë¦½ ì™„ë£Œ\nğŸ”— íŒŒì¼ ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ ì²˜ë¦¬]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        total = user['money'] + user['bank_money']
        res = f"ğŸ’° {nick}ë‹˜ì˜ ìì‚° ë³´ê³ ì„œ\n" \
              f"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" \
              f"ğŸ’µ í˜„ê¸ˆ: {user['money']:,}â‚©\n" \
              f"ğŸ¦ ì€í–‰: {user['bank_money']:,}â‚©\n" \
              f"ğŸ’³ ì´í•©: {total:,}â‚©\n" \
              f"ğŸ† ë“±ê¸‰: {'ì´ˆì›”ì' if total >= 10000000 else 'VIP' if total >= 1000000 else 'í‰ë¯¼'}"
        emit('message', {'msg': res, 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt:,}â‚©ì„ ì€í–‰ì— ì•ˆì „í•˜ê²Œ ë³´ê´€í–ˆìŠµë‹ˆë‹¤. (ë¶„ë‹¹ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ ì€í–‰ì—ì„œ {amt:,}â‚©ì„ ì¶œê¸ˆí–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ì´ ê°€ë™ë˜ì—ˆìŠµë‹ˆë‹¤! (3ì´ˆë‹¹ 5000â‚©)", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆ ì—”ì§„ì„ ì •ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            prompt = " ".join(cmd_parts[1:])
            res = client.models.generate_content(model="gemini-2.0-flash", contents=prompt)
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except Exception as e:
            emit('message', {'msg': f"âŒ ì—ëŸ¬: {str(e)}", 'type': 'system'})

    elif cmd == "!ëª…ë ¹ì–´":
        help_msg = "ğŸ“œ [ëª…ë ¹ì–´ ë¦¬ìŠ¤íŠ¸]\n!ì”ì•¡ - ë‚´ ìì‚° í™•ì¸\n!ì €ê¸ˆ [ì•¡ìˆ˜] - ì€í–‰ì— ì…ê¸ˆ\n!ì¶œê¸ˆ [ì•¡ìˆ˜] - í˜„ê¸ˆí™”\n!ë‡Œì ˆ - ë¬´í•œ ëˆ ë²Œê¸° ì‹œì‘\n!ë‡Œì ˆì¤‘ë‹¨ - ì¤‘ì§€\n!gemini [ì§ˆë¬¸] - AI ë‹µë³€\n!ëª…ë ¹ì–´ - ë„ì›€ë§"
        emit('message', {'msg': help_msg, 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ…
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=background_scheduler, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
import random
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í™˜ê²½] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "multiverse_empire.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {}

# Gemini AI í´ë¼ì´ì–¸íŠ¸ ì„¤ì •
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key:
        client = genai.Client(api_key=api_key)
except:
    print("Gemini SDKê°€ ì—†ê±°ë‚˜ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. !gemini ê¸°ëŠ¥ì€ ë¹„í™œì„±í™”ë©ë‹ˆë‹¤.")

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("""
            CREATE TABLE IF NOT EXISTS users (
                nickname TEXT PRIMARY KEY, 
                money INTEGER DEFAULT 1000, 
                bank_money INTEGER DEFAULT 0
            )
        """)
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ë° ë‰´ìŠ¤ ì‹œìŠ¤í…œ]
def background_scheduler():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤ ì‹¤í–‰
        with sqlite3.connect(DB_FILE) as conn:
            # 1. ì´ì ì§€ê¸‰ (1%)
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()
        
        # 2. ì‹¤ì‹œê°„ ê²½ì œ ë‰´ìŠ¤ ì´ë²¤íŠ¸
        news_list = [
            "ğŸ“¢ [ê²½ì œ] ì œêµ­ ì€í–‰ì˜ ê¸ˆë¦¬ê°€ ìƒìŠ¹ ì¡°ì§ì„ ë³´ì…ë‹ˆë‹¤!",
            "ğŸ“¢ [ì†Œì‹] ëŒ€ê·œëª¨ ë‡Œì ˆ ì—ë„ˆì§€ê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ì±„êµ´ íš¨ìœ¨ì´ ì¦ê°€í•©ë‹ˆë‹¤.",
            "ğŸ“¢ [ê³µì§€] í˜„ì¬ ìµœê³  ë¶€ìëŠ” 'ì´ˆì›”ì' ë“±ê¸‰ì„ ìœ ì§€í•˜ê³  ìˆìŠµë‹ˆë‹¤.",
            "ğŸ“¢ [ì´ë²¤íŠ¸] ì§€ê¸ˆ ì±„íŒ…ì„ ì…ë ¥í•˜ë©´ ë³´ë„ˆìŠ¤ í¬ì¸íŠ¸ê°€ ì§€ê¸‰ë  í™•ë¥ ì´ ë†’ìŠµë‹ˆë‹¤!"
        ]
        socketio.emit('message', {'msg': random.choice(news_list), 'type': 'system'}, room='main')

# --- [3. íŠ¹ìˆ˜ ê¸°ëŠ¥ ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 1
        reward = 5000
        update_money(nick, reward, bank=True)
        pattern = f"ğŸŒ€ [{nick}] ë‡Œì ˆ ë™ë ¥ ê°€ë™ ì¤‘... (+{reward}â‚© ì…ê¸ˆ)"
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"{pattern}\në¬´í•œ ë£¨í”„ íšŸìˆ˜: {m_count}íšŒì°¨", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3)

def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [4. ë¼ìš°íŒ… ë° ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸš€ {data['nickname']}ë‹˜ì´ ë©€í‹°ë²„ìŠ¤ ì„œë²„ì— ì ‘ì†í–ˆìŠµë‹ˆë‹¤!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ìˆ˜ìµ ê³µì‹]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ [ëŒ€ìš©ëŸ‰ ë°ì´í„° ë³€í™˜]\nê¸¸ì´: {msg_len}ì\në³´ìƒ: {reward}â‚© ì ë¦½ ì™„ë£Œ\nğŸ”— íŒŒì¼ ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ ì²˜ë¦¬]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        total = user['money'] + user['bank_money']
        res = f"ğŸ’° {nick}ë‹˜ì˜ ìì‚° ë³´ê³ ì„œ\n" \
              f"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" \
              f"ğŸ’µ í˜„ê¸ˆ: {user['money']:,}â‚©\n" \
              f"ğŸ¦ ì€í–‰: {user['bank_money']:,}â‚©\n" \
              f"ğŸ’³ ì´í•©: {total:,}â‚©\n" \
              f"ğŸ† ë“±ê¸‰: {'ì´ˆì›”ì' if total >= 10000000 else 'VIP' if total >= 1000000 else 'í‰ë¯¼'}"
        emit('message', {'msg': res, 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt:,}â‚©ì„ ì€í–‰ì— ì•ˆì „í•˜ê²Œ ë³´ê´€í–ˆìŠµë‹ˆë‹¤. (ë¶„ë‹¹ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ ì€í–‰ì—ì„œ {amt:,}â‚©ì„ ì¶œê¸ˆí–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ì´ ê°€ë™ë˜ì—ˆìŠµë‹ˆë‹¤! (3ì´ˆë‹¹ 5000â‚©)", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆ ì—”ì§„ì„ ì •ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            prompt = " ".join(cmd_parts[1:])
            res = client.models.generate_content(model="gemini-2.0-flash", contents=prompt)
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except Exception as e:
            emit('message', {'msg': f"âŒ ì—ëŸ¬: {str(e)}", 'type': 'system'})

    elif cmd == "!ëª…ë ¹ì–´":
        help_msg = "ğŸ“œ [ëª…ë ¹ì–´ ë¦¬ìŠ¤íŠ¸]\n!ì”ì•¡ - ë‚´ ìì‚° í™•ì¸\n!ì €ê¸ˆ [ì•¡ìˆ˜] - ì€í–‰ì— ì…ê¸ˆ\n!ì¶œê¸ˆ [ì•¡ìˆ˜] - í˜„ê¸ˆí™”\n!ë‡Œì ˆ - ë¬´í•œ ëˆ ë²Œê¸° ì‹œì‘\n!ë‡Œì ˆì¤‘ë‹¨ - ì¤‘ì§€\n!gemini [ì§ˆë¬¸] - AI ë‹µë³€\n!ëª…ë ¹ì–´ - ë„ì›€ë§"
        emit('message', {'msg': help_msg, 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ…
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=background_scheduler, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
import random
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í™˜ê²½] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "multiverse_empire.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {}

# Gemini AI í´ë¼ì´ì–¸íŠ¸ ì„¤ì •
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key:
        client = genai.Client(api_key=api_key)
except:
    print("Gemini SDKê°€ ì—†ê±°ë‚˜ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. !gemini ê¸°ëŠ¥ì€ ë¹„í™œì„±í™”ë©ë‹ˆë‹¤.")

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("""
            CREATE TABLE IF NOT EXISTS users (
                nickname TEXT PRIMARY KEY, 
                money INTEGER DEFAULT 1000, 
                bank_money INTEGER DEFAULT 0
            )
        """)
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ë° ë‰´ìŠ¤ ì‹œìŠ¤í…œ]
def background_scheduler():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤ ì‹¤í–‰
        with sqlite3.connect(DB_FILE) as conn:
            # 1. ì´ì ì§€ê¸‰ (1%)
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()
        
        # 2. ì‹¤ì‹œê°„ ê²½ì œ ë‰´ìŠ¤ ì´ë²¤íŠ¸
        news_list = [
            "ğŸ“¢ [ê²½ì œ] ì œêµ­ ì€í–‰ì˜ ê¸ˆë¦¬ê°€ ìƒìŠ¹ ì¡°ì§ì„ ë³´ì…ë‹ˆë‹¤!",
            "ğŸ“¢ [ì†Œì‹] ëŒ€ê·œëª¨ ë‡Œì ˆ ì—ë„ˆì§€ê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ì±„êµ´ íš¨ìœ¨ì´ ì¦ê°€í•©ë‹ˆë‹¤.",
            "ğŸ“¢ [ê³µì§€] í˜„ì¬ ìµœê³  ë¶€ìëŠ” 'ì´ˆì›”ì' ë“±ê¸‰ì„ ìœ ì§€í•˜ê³  ìˆìŠµë‹ˆë‹¤.",
            "ğŸ“¢ [ì´ë²¤íŠ¸] ì§€ê¸ˆ ì±„íŒ…ì„ ì…ë ¥í•˜ë©´ ë³´ë„ˆìŠ¤ í¬ì¸íŠ¸ê°€ ì§€ê¸‰ë  í™•ë¥ ì´ ë†’ìŠµë‹ˆë‹¤!"
        ]
        socketio.emit('message', {'msg': random.choice(news_list), 'type': 'system'}, room='main')

# --- [3. íŠ¹ìˆ˜ ê¸°ëŠ¥ ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 1
        reward = 5000
        update_money(nick, reward, bank=True)
        pattern = f"ğŸŒ€ [{nick}] ë‡Œì ˆ ë™ë ¥ ê°€ë™ ì¤‘... (+{reward}â‚© ì…ê¸ˆ)"
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"{pattern}\në¬´í•œ ë£¨í”„ íšŸìˆ˜: {m_count}íšŒì°¨", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3)

def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [4. ë¼ìš°íŒ… ë° ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸš€ {data['nickname']}ë‹˜ì´ ë©€í‹°ë²„ìŠ¤ ì„œë²„ì— ì ‘ì†í–ˆìŠµë‹ˆë‹¤!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ìˆ˜ìµ ê³µì‹]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ [ëŒ€ìš©ëŸ‰ ë°ì´í„° ë³€í™˜]\nê¸¸ì´: {msg_len}ì\në³´ìƒ: {reward}â‚© ì ë¦½ ì™„ë£Œ\nğŸ”— íŒŒì¼ ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ ì²˜ë¦¬]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        total = user['money'] + user['bank_money']
        res = f"ğŸ’° {nick}ë‹˜ì˜ ìì‚° ë³´ê³ ì„œ\n" \
              f"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" \
              f"ğŸ’µ í˜„ê¸ˆ: {user['money']:,}â‚©\n" \
              f"ğŸ¦ ì€í–‰: {user['bank_money']:,}â‚©\n" \
              f"ğŸ’³ ì´í•©: {total:,}â‚©\n" \
              f"ğŸ† ë“±ê¸‰: {'ì´ˆì›”ì' if total >= 10000000 else 'VIP' if total >= 1000000 else 'í‰ë¯¼'}"
        emit('message', {'msg': res, 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt:,}â‚©ì„ ì€í–‰ì— ì•ˆì „í•˜ê²Œ ë³´ê´€í–ˆìŠµë‹ˆë‹¤. (ë¶„ë‹¹ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ ì€í–‰ì—ì„œ {amt:,}â‚©ì„ ì¶œê¸ˆí–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ì´ ê°€ë™ë˜ì—ˆìŠµë‹ˆë‹¤! (3ì´ˆë‹¹ 5000â‚©)", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆ ì—”ì§„ì„ ì •ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            prompt = " ".join(cmd_parts[1:])
            res = client.models.generate_content(model="gemini-2.0-flash", contents=prompt)
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except Exception as e:
            emit('message', {'msg': f"âŒ ì—ëŸ¬: {str(e)}", 'type': 'system'})

    elif cmd == "!ëª…ë ¹ì–´":
        help_msg = "ğŸ“œ [ëª…ë ¹ì–´ ë¦¬ìŠ¤íŠ¸]\n!ì”ì•¡ - ë‚´ ìì‚° í™•ì¸\n!ì €ê¸ˆ [ì•¡ìˆ˜] - ì€í–‰ì— ì…ê¸ˆ\n!ì¶œê¸ˆ [ì•¡ìˆ˜] - í˜„ê¸ˆí™”\n!ë‡Œì ˆ - ë¬´í•œ ëˆ ë²Œê¸° ì‹œì‘\n!ë‡Œì ˆì¤‘ë‹¨ - ì¤‘ì§€\n!gemini [ì§ˆë¬¸] - AI ë‹µë³€\n!ëª…ë ¹ì–´ - ë„ì›€ë§"
        emit('message', {'msg': help_msg, 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ…
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=background_scheduler, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
import random
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í™˜ê²½] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "multiverse_empire.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {}

# Gemini AI í´ë¼ì´ì–¸íŠ¸ ì„¤ì •
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key:
        client = genai.Client(api_key=api_key)
except:
    print("Gemini SDKê°€ ì—†ê±°ë‚˜ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. !gemini ê¸°ëŠ¥ì€ ë¹„í™œì„±í™”ë©ë‹ˆë‹¤.")

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("""
            CREATE TABLE IF NOT EXISTS users (
                nickname TEXT PRIMARY KEY, 
                money INTEGER DEFAULT 1000, 
                bank_money INTEGER DEFAULT 0
            )
        """)
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ë° ë‰´ìŠ¤ ì‹œìŠ¤í…œ]
def background_scheduler():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤ ì‹¤í–‰
        with sqlite3.connect(DB_FILE) as conn:
            # 1. ì´ì ì§€ê¸‰ (1%)
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()
        
        # 2. ì‹¤ì‹œê°„ ê²½ì œ ë‰´ìŠ¤ ì´ë²¤íŠ¸
        news_list = [
            "ğŸ“¢ [ê²½ì œ] ì œêµ­ ì€í–‰ì˜ ê¸ˆë¦¬ê°€ ìƒìŠ¹ ì¡°ì§ì„ ë³´ì…ë‹ˆë‹¤!",
            "ğŸ“¢ [ì†Œì‹] ëŒ€ê·œëª¨ ë‡Œì ˆ ì—ë„ˆì§€ê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ì±„êµ´ íš¨ìœ¨ì´ ì¦ê°€í•©ë‹ˆë‹¤.",
            "ğŸ“¢ [ê³µì§€] í˜„ì¬ ìµœê³  ë¶€ìëŠ” 'ì´ˆì›”ì' ë“±ê¸‰ì„ ìœ ì§€í•˜ê³  ìˆìŠµë‹ˆë‹¤.",
            "ğŸ“¢ [ì´ë²¤íŠ¸] ì§€ê¸ˆ ì±„íŒ…ì„ ì…ë ¥í•˜ë©´ ë³´ë„ˆìŠ¤ í¬ì¸íŠ¸ê°€ ì§€ê¸‰ë  í™•ë¥ ì´ ë†’ìŠµë‹ˆë‹¤!"
        ]
        socketio.emit('message', {'msg': random.choice(news_list), 'type': 'system'}, room='main')

# --- [3. íŠ¹ìˆ˜ ê¸°ëŠ¥ ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 1
        reward = 5000
        update_money(nick, reward, bank=True)
        pattern = f"ğŸŒ€ [{nick}] ë‡Œì ˆ ë™ë ¥ ê°€ë™ ì¤‘... (+{reward}â‚© ì…ê¸ˆ)"
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"{pattern}\në¬´í•œ ë£¨í”„ íšŸìˆ˜: {m_count}íšŒì°¨", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3)

def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [4. ë¼ìš°íŒ… ë° ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸš€ {data['nickname']}ë‹˜ì´ ë©€í‹°ë²„ìŠ¤ ì„œë²„ì— ì ‘ì†í–ˆìŠµë‹ˆë‹¤!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ìˆ˜ìµ ê³µì‹]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ [ëŒ€ìš©ëŸ‰ ë°ì´í„° ë³€í™˜]\nê¸¸ì´: {msg_len}ì\në³´ìƒ: {reward}â‚© ì ë¦½ ì™„ë£Œ\nğŸ”— íŒŒì¼ ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ ì²˜ë¦¬]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        total = user['money'] + user['bank_money']
        res = f"ğŸ’° {nick}ë‹˜ì˜ ìì‚° ë³´ê³ ì„œ\n" \
              f"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" \
              f"ğŸ’µ í˜„ê¸ˆ: {user['money']:,}â‚©\n" \
              f"ğŸ¦ ì€í–‰: {user['bank_money']:,}â‚©\n" \
              f"ğŸ’³ ì´í•©: {total:,}â‚©\n" \
              f"ğŸ† ë“±ê¸‰: {'ì´ˆì›”ì' if total >= 10000000 else 'VIP' if total >= 1000000 else 'í‰ë¯¼'}"
        emit('message', {'msg': res, 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt:,}â‚©ì„ ì€í–‰ì— ì•ˆì „í•˜ê²Œ ë³´ê´€í–ˆìŠµë‹ˆë‹¤. (ë¶„ë‹¹ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ ì€í–‰ì—ì„œ {amt:,}â‚©ì„ ì¶œê¸ˆí–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ì´ ê°€ë™ë˜ì—ˆìŠµë‹ˆë‹¤! (3ì´ˆë‹¹ 5000â‚©)", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆ ì—”ì§„ì„ ì •ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            prompt = " ".join(cmd_parts[1:])
            res = client.models.generate_content(model="gemini-2.0-flash", contents=prompt)
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except Exception as e:
            emit('message', {'msg': f"âŒ ì—ëŸ¬: {str(e)}", 'type': 'system'})

    elif cmd == "!ëª…ë ¹ì–´":
        help_msg = "ğŸ“œ [ëª…ë ¹ì–´ ë¦¬ìŠ¤íŠ¸]\n!ì”ì•¡ - ë‚´ ìì‚° í™•ì¸\n!ì €ê¸ˆ [ì•¡ìˆ˜] - ì€í–‰ì— ì…ê¸ˆ\n!ì¶œê¸ˆ [ì•¡ìˆ˜] - í˜„ê¸ˆí™”\n!ë‡Œì ˆ - ë¬´í•œ ëˆ ë²Œê¸° ì‹œì‘\n!ë‡Œì ˆì¤‘ë‹¨ - ì¤‘ì§€\n!gemini [ì§ˆë¬¸] - AI ë‹µë³€\n!ëª…ë ¹ì–´ - ë„ì›€ë§"
        emit('message', {'msg': help_msg, 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ…
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=background_scheduler, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
import random
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í™˜ê²½] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "multiverse_empire.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {}

# Gemini AI í´ë¼ì´ì–¸íŠ¸ ì„¤ì •
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key:
        client = genai.Client(api_key=api_key)
except:
    print("Gemini SDKê°€ ì—†ê±°ë‚˜ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. !gemini ê¸°ëŠ¥ì€ ë¹„í™œì„±í™”ë©ë‹ˆë‹¤.")

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("""
            CREATE TABLE IF NOT EXISTS users (
                nickname TEXT PRIMARY KEY, 
                money INTEGER DEFAULT 1000, 
                bank_money INTEGER DEFAULT 0
            )
        """)
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ë° ë‰´ìŠ¤ ì‹œìŠ¤í…œ]
def background_scheduler():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤ ì‹¤í–‰
        with sqlite3.connect(DB_FILE) as conn:
            # 1. ì´ì ì§€ê¸‰ (1%)
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()
        
        # 2. ì‹¤ì‹œê°„ ê²½ì œ ë‰´ìŠ¤ ì´ë²¤íŠ¸
        news_list = [
            "ğŸ“¢ [ê²½ì œ] ì œêµ­ ì€í–‰ì˜ ê¸ˆë¦¬ê°€ ìƒìŠ¹ ì¡°ì§ì„ ë³´ì…ë‹ˆë‹¤!",
            "ğŸ“¢ [ì†Œì‹] ëŒ€ê·œëª¨ ë‡Œì ˆ ì—ë„ˆì§€ê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ì±„êµ´ íš¨ìœ¨ì´ ì¦ê°€í•©ë‹ˆë‹¤.",
            "ğŸ“¢ [ê³µì§€] í˜„ì¬ ìµœê³  ë¶€ìëŠ” 'ì´ˆì›”ì' ë“±ê¸‰ì„ ìœ ì§€í•˜ê³  ìˆìŠµë‹ˆë‹¤.",
            "ğŸ“¢ [ì´ë²¤íŠ¸] ì§€ê¸ˆ ì±„íŒ…ì„ ì…ë ¥í•˜ë©´ ë³´ë„ˆìŠ¤ í¬ì¸íŠ¸ê°€ ì§€ê¸‰ë  í™•ë¥ ì´ ë†’ìŠµë‹ˆë‹¤!"
        ]
        socketio.emit('message', {'msg': random.choice(news_list), 'type': 'system'}, room='main')

# --- [3. íŠ¹ìˆ˜ ê¸°ëŠ¥ ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 1
        reward = 5000
        update_money(nick, reward, bank=True)
        pattern = f"ğŸŒ€ [{nick}] ë‡Œì ˆ ë™ë ¥ ê°€ë™ ì¤‘... (+{reward}â‚© ì…ê¸ˆ)"
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"{pattern}\në¬´í•œ ë£¨í”„ íšŸìˆ˜: {m_count}íšŒì°¨", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3)

def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [4. ë¼ìš°íŒ… ë° ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸš€ {data['nickname']}ë‹˜ì´ ë©€í‹°ë²„ìŠ¤ ì„œë²„ì— ì ‘ì†í–ˆìŠµë‹ˆë‹¤!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ìˆ˜ìµ ê³µì‹]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ [ëŒ€ìš©ëŸ‰ ë°ì´í„° ë³€í™˜]\nê¸¸ì´: {msg_len}ì\në³´ìƒ: {reward}â‚© ì ë¦½ ì™„ë£Œ\nğŸ”— íŒŒì¼ ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ ì²˜ë¦¬]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        total = user['money'] + user['bank_money']
        res = f"ğŸ’° {nick}ë‹˜ì˜ ìì‚° ë³´ê³ ì„œ\n" \
              f"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" \
              f"ğŸ’µ í˜„ê¸ˆ: {user['money']:,}â‚©\n" \
              f"ğŸ¦ ì€í–‰: {user['bank_money']:,}â‚©\n" \
              f"ğŸ’³ ì´í•©: {total:,}â‚©\n" \
              f"ğŸ† ë“±ê¸‰: {'ì´ˆì›”ì' if total >= 10000000 else 'VIP' if total >= 1000000 else 'í‰ë¯¼'}"
        emit('message', {'msg': res, 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt:,}â‚©ì„ ì€í–‰ì— ì•ˆì „í•˜ê²Œ ë³´ê´€í–ˆìŠµë‹ˆë‹¤. (ë¶„ë‹¹ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ ì€í–‰ì—ì„œ {amt:,}â‚©ì„ ì¶œê¸ˆí–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ì´ ê°€ë™ë˜ì—ˆìŠµë‹ˆë‹¤! (3ì´ˆë‹¹ 5000â‚©)", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆ ì—”ì§„ì„ ì •ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            prompt = " ".join(cmd_parts[1:])
            res = client.models.generate_content(model="gemini-2.0-flash", contents=prompt)
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except Exception as e:
            emit('message', {'msg': f"âŒ ì—ëŸ¬: {str(e)}", 'type': 'system'})

    elif cmd == "!ëª…ë ¹ì–´":
        help_msg = "ğŸ“œ [ëª…ë ¹ì–´ ë¦¬ìŠ¤íŠ¸]\n!ì”ì•¡ - ë‚´ ìì‚° í™•ì¸\n!ì €ê¸ˆ [ì•¡ìˆ˜] - ì€í–‰ì— ì…ê¸ˆ\n!ì¶œê¸ˆ [ì•¡ìˆ˜] - í˜„ê¸ˆí™”\n!ë‡Œì ˆ - ë¬´í•œ ëˆ ë²Œê¸° ì‹œì‘\n!ë‡Œì ˆì¤‘ë‹¨ - ì¤‘ì§€\n!gemini [ì§ˆë¬¸] - AI ë‹µë³€\n!ëª…ë ¹ì–´ - ë„ì›€ë§"
        emit('message', {'msg': help_msg, 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ…
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=background_scheduler, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
import random
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í™˜ê²½] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "multiverse_empire.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {}

# Gemini AI í´ë¼ì´ì–¸íŠ¸ ì„¤ì •
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key:
        client = genai.Client(api_key=api_key)
except:
    print("Gemini SDKê°€ ì—†ê±°ë‚˜ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. !gemini ê¸°ëŠ¥ì€ ë¹„í™œì„±í™”ë©ë‹ˆë‹¤.")

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("""
            CREATE TABLE IF NOT EXISTS users (
                nickname TEXT PRIMARY KEY, 
                money INTEGER DEFAULT 1000, 
                bank_money INTEGER DEFAULT 0
            )
        """)
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ë° ë‰´ìŠ¤ ì‹œìŠ¤í…œ]
def background_scheduler():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤ ì‹¤í–‰
        with sqlite3.connect(DB_FILE) as conn:
            # 1. ì´ì ì§€ê¸‰ (1%)
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()
        
        # 2. ì‹¤ì‹œê°„ ê²½ì œ ë‰´ìŠ¤ ì´ë²¤íŠ¸
        news_list = [
            "ğŸ“¢ [ê²½ì œ] ì œêµ­ ì€í–‰ì˜ ê¸ˆë¦¬ê°€ ìƒìŠ¹ ì¡°ì§ì„ ë³´ì…ë‹ˆë‹¤!",
            "ğŸ“¢ [ì†Œì‹] ëŒ€ê·œëª¨ ë‡Œì ˆ ì—ë„ˆì§€ê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ì±„êµ´ íš¨ìœ¨ì´ ì¦ê°€í•©ë‹ˆë‹¤.",
            "ğŸ“¢ [ê³µì§€] í˜„ì¬ ìµœê³  ë¶€ìëŠ” 'ì´ˆì›”ì' ë“±ê¸‰ì„ ìœ ì§€í•˜ê³  ìˆìŠµë‹ˆë‹¤.",
            "ğŸ“¢ [ì´ë²¤íŠ¸] ì§€ê¸ˆ ì±„íŒ…ì„ ì…ë ¥í•˜ë©´ ë³´ë„ˆìŠ¤ í¬ì¸íŠ¸ê°€ ì§€ê¸‰ë  í™•ë¥ ì´ ë†’ìŠµë‹ˆë‹¤!"
        ]
        socketio.emit('message', {'msg': random.choice(news_list), 'type': 'system'}, room='main')

# --- [3. íŠ¹ìˆ˜ ê¸°ëŠ¥ ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 1
        reward = 5000
        update_money(nick, reward, bank=True)
        pattern = f"ğŸŒ€ [{nick}] ë‡Œì ˆ ë™ë ¥ ê°€ë™ ì¤‘... (+{reward}â‚© ì…ê¸ˆ)"
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"{pattern}\në¬´í•œ ë£¨í”„ íšŸìˆ˜: {m_count}íšŒì°¨", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3)

def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [4. ë¼ìš°íŒ… ë° ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸš€ {data['nickname']}ë‹˜ì´ ë©€í‹°ë²„ìŠ¤ ì„œë²„ì— ì ‘ì†í–ˆìŠµë‹ˆë‹¤!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ìˆ˜ìµ ê³µì‹]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ [ëŒ€ìš©ëŸ‰ ë°ì´í„° ë³€í™˜]\nê¸¸ì´: {msg_len}ì\në³´ìƒ: {reward}â‚© ì ë¦½ ì™„ë£Œ\nğŸ”— íŒŒì¼ ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ ì²˜ë¦¬]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        total = user['money'] + user['bank_money']
        res = f"ğŸ’° {nick}ë‹˜ì˜ ìì‚° ë³´ê³ ì„œ\n" \
              f"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" \
              f"ğŸ’µ í˜„ê¸ˆ: {user['money']:,}â‚©\n" \
              f"ğŸ¦ ì€í–‰: {user['bank_money']:,}â‚©\n" \
              f"ğŸ’³ ì´í•©: {total:,}â‚©\n" \
              f"ğŸ† ë“±ê¸‰: {'ì´ˆì›”ì' if total >= 10000000 else 'VIP' if total >= 1000000 else 'í‰ë¯¼'}"
        emit('message', {'msg': res, 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt:,}â‚©ì„ ì€í–‰ì— ì•ˆì „í•˜ê²Œ ë³´ê´€í–ˆìŠµë‹ˆë‹¤. (ë¶„ë‹¹ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ ì€í–‰ì—ì„œ {amt:,}â‚©ì„ ì¶œê¸ˆí–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ì´ ê°€ë™ë˜ì—ˆìŠµë‹ˆë‹¤! (3ì´ˆë‹¹ 5000â‚©)", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆ ì—”ì§„ì„ ì •ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            prompt = " ".join(cmd_parts[1:])
            res = client.models.generate_content(model="gemini-2.0-flash", contents=prompt)
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except Exception as e:
            emit('message', {'msg': f"âŒ ì—ëŸ¬: {str(e)}", 'type': 'system'})

    elif cmd == "!ëª…ë ¹ì–´":
        help_msg = "ğŸ“œ [ëª…ë ¹ì–´ ë¦¬ìŠ¤íŠ¸]\n!ì”ì•¡ - ë‚´ ìì‚° í™•ì¸\n!ì €ê¸ˆ [ì•¡ìˆ˜] - ì€í–‰ì— ì…ê¸ˆ\n!ì¶œê¸ˆ [ì•¡ìˆ˜] - í˜„ê¸ˆí™”\n!ë‡Œì ˆ - ë¬´í•œ ëˆ ë²Œê¸° ì‹œì‘\n!ë‡Œì ˆì¤‘ë‹¨ - ì¤‘ì§€\n!gemini [ì§ˆë¬¸] - AI ë‹µë³€\n!ëª…ë ¹ì–´ - ë„ì›€ë§"
        emit('message', {'msg': help_msg, 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ…
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=background_scheduler, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
import random
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í™˜ê²½] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "multiverse_empire.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {}

# Gemini AI í´ë¼ì´ì–¸íŠ¸ ì„¤ì •
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key:
        client = genai.Client(api_key=api_key)
except:
    print("Gemini SDKê°€ ì—†ê±°ë‚˜ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. !gemini ê¸°ëŠ¥ì€ ë¹„í™œì„±í™”ë©ë‹ˆë‹¤.")

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("""
            CREATE TABLE IF NOT EXISTS users (
                nickname TEXT PRIMARY KEY, 
                money INTEGER DEFAULT 1000, 
                bank_money INTEGER DEFAULT 0
            )
        """)
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ë° ë‰´ìŠ¤ ì‹œìŠ¤í…œ]
def background_scheduler():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤ ì‹¤í–‰
        with sqlite3.connect(DB_FILE) as conn:
            # 1. ì´ì ì§€ê¸‰ (1%)
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()
        
        # 2. ì‹¤ì‹œê°„ ê²½ì œ ë‰´ìŠ¤ ì´ë²¤íŠ¸
        news_list = [
            "ğŸ“¢ [ê²½ì œ] ì œêµ­ ì€í–‰ì˜ ê¸ˆë¦¬ê°€ ìƒìŠ¹ ì¡°ì§ì„ ë³´ì…ë‹ˆë‹¤!",
            "ğŸ“¢ [ì†Œì‹] ëŒ€ê·œëª¨ ë‡Œì ˆ ì—ë„ˆì§€ê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ì±„êµ´ íš¨ìœ¨ì´ ì¦ê°€í•©ë‹ˆë‹¤.",
            "ğŸ“¢ [ê³µì§€] í˜„ì¬ ìµœê³  ë¶€ìëŠ” 'ì´ˆì›”ì' ë“±ê¸‰ì„ ìœ ì§€í•˜ê³  ìˆìŠµë‹ˆë‹¤.",
            "ğŸ“¢ [ì´ë²¤íŠ¸] ì§€ê¸ˆ ì±„íŒ…ì„ ì…ë ¥í•˜ë©´ ë³´ë„ˆìŠ¤ í¬ì¸íŠ¸ê°€ ì§€ê¸‰ë  í™•ë¥ ì´ ë†’ìŠµë‹ˆë‹¤!"
        ]
        socketio.emit('message', {'msg': random.choice(news_list), 'type': 'system'}, room='main')

# --- [3. íŠ¹ìˆ˜ ê¸°ëŠ¥ ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 1
        reward = 5000
        update_money(nick, reward, bank=True)
        pattern = f"ğŸŒ€ [{nick}] ë‡Œì ˆ ë™ë ¥ ê°€ë™ ì¤‘... (+{reward}â‚© ì…ê¸ˆ)"
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"{pattern}\në¬´í•œ ë£¨í”„ íšŸìˆ˜: {m_count}íšŒì°¨", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3)

def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [4. ë¼ìš°íŒ… ë° ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸš€ {data['nickname']}ë‹˜ì´ ë©€í‹°ë²„ìŠ¤ ì„œë²„ì— ì ‘ì†í–ˆìŠµë‹ˆë‹¤!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ìˆ˜ìµ ê³µì‹]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ [ëŒ€ìš©ëŸ‰ ë°ì´í„° ë³€í™˜]\nê¸¸ì´: {msg_len}ì\në³´ìƒ: {reward}â‚© ì ë¦½ ì™„ë£Œ\nğŸ”— íŒŒì¼ ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ ì²˜ë¦¬]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        total = user['money'] + user['bank_money']
        res = f"ğŸ’° {nick}ë‹˜ì˜ ìì‚° ë³´ê³ ì„œ\n" \
              f"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" \
              f"ğŸ’µ í˜„ê¸ˆ: {user['money']:,}â‚©\n" \
              f"ğŸ¦ ì€í–‰: {user['bank_money']:,}â‚©\n" \
              f"ğŸ’³ ì´í•©: {total:,}â‚©\n" \
              f"ğŸ† ë“±ê¸‰: {'ì´ˆì›”ì' if total >= 10000000 else 'VIP' if total >= 1000000 else 'í‰ë¯¼'}"
        emit('message', {'msg': res, 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt:,}â‚©ì„ ì€í–‰ì— ì•ˆì „í•˜ê²Œ ë³´ê´€í–ˆìŠµë‹ˆë‹¤. (ë¶„ë‹¹ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ ì€í–‰ì—ì„œ {amt:,}â‚©ì„ ì¶œê¸ˆí–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ì´ ê°€ë™ë˜ì—ˆìŠµë‹ˆë‹¤! (3ì´ˆë‹¹ 5000â‚©)", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆ ì—”ì§„ì„ ì •ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            prompt = " ".join(cmd_parts[1:])
            res = client.models.generate_content(model="gemini-2.0-flash", contents=prompt)
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except Exception as e:
            emit('message', {'msg': f"âŒ ì—ëŸ¬: {str(e)}", 'type': 'system'})

    elif cmd == "!ëª…ë ¹ì–´":
        help_msg = "ğŸ“œ [ëª…ë ¹ì–´ ë¦¬ìŠ¤íŠ¸]\n!ì”ì•¡ - ë‚´ ìì‚° í™•ì¸\n!ì €ê¸ˆ [ì•¡ìˆ˜] - ì€í–‰ì— ì…ê¸ˆ\n!ì¶œê¸ˆ [ì•¡ìˆ˜] - í˜„ê¸ˆí™”\n!ë‡Œì ˆ - ë¬´í•œ ëˆ ë²Œê¸° ì‹œì‘\n!ë‡Œì ˆì¤‘ë‹¨ - ì¤‘ì§€\n!gemini [ì§ˆë¬¸] - AI ë‹µë³€\n!ëª…ë ¹ì–´ - ë„ì›€ë§"
        emit('message', {'msg': help_msg, 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ…
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=background_scheduler, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
import random
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í™˜ê²½] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "multiverse_empire.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {}

# Gemini AI í´ë¼ì´ì–¸íŠ¸ ì„¤ì •
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key:
        client = genai.Client(api_key=api_key)
except:
    print("Gemini SDKê°€ ì—†ê±°ë‚˜ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. !gemini ê¸°ëŠ¥ì€ ë¹„í™œì„±í™”ë©ë‹ˆë‹¤.")

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("""
            CREATE TABLE IF NOT EXISTS users (
                nickname TEXT PRIMARY KEY, 
                money INTEGER DEFAULT 1000, 
                bank_money INTEGER DEFAULT 0
            )
        """)
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ë° ë‰´ìŠ¤ ì‹œìŠ¤í…œ]
def background_scheduler():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤ ì‹¤í–‰
        with sqlite3.connect(DB_FILE) as conn:
            # 1. ì´ì ì§€ê¸‰ (1%)
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()
        
        # 2. ì‹¤ì‹œê°„ ê²½ì œ ë‰´ìŠ¤ ì´ë²¤íŠ¸
        news_list = [
            "ğŸ“¢ [ê²½ì œ] ì œêµ­ ì€í–‰ì˜ ê¸ˆë¦¬ê°€ ìƒìŠ¹ ì¡°ì§ì„ ë³´ì…ë‹ˆë‹¤!",
            "ğŸ“¢ [ì†Œì‹] ëŒ€ê·œëª¨ ë‡Œì ˆ ì—ë„ˆì§€ê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ì±„êµ´ íš¨ìœ¨ì´ ì¦ê°€í•©ë‹ˆë‹¤.",
            "ğŸ“¢ [ê³µì§€] í˜„ì¬ ìµœê³  ë¶€ìëŠ” 'ì´ˆì›”ì' ë“±ê¸‰ì„ ìœ ì§€í•˜ê³  ìˆìŠµë‹ˆë‹¤.",
            "ğŸ“¢ [ì´ë²¤íŠ¸] ì§€ê¸ˆ ì±„íŒ…ì„ ì…ë ¥í•˜ë©´ ë³´ë„ˆìŠ¤ í¬ì¸íŠ¸ê°€ ì§€ê¸‰ë  í™•ë¥ ì´ ë†’ìŠµë‹ˆë‹¤!"
        ]
        socketio.emit('message', {'msg': random.choice(news_list), 'type': 'system'}, room='main')

# --- [3. íŠ¹ìˆ˜ ê¸°ëŠ¥ ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 1
        reward = 5000
        update_money(nick, reward, bank=True)
        pattern = f"ğŸŒ€ [{nick}] ë‡Œì ˆ ë™ë ¥ ê°€ë™ ì¤‘... (+{reward}â‚© ì…ê¸ˆ)"
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"{pattern}\në¬´í•œ ë£¨í”„ íšŸìˆ˜: {m_count}íšŒì°¨", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3)

def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [4. ë¼ìš°íŒ… ë° ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸš€ {data['nickname']}ë‹˜ì´ ë©€í‹°ë²„ìŠ¤ ì„œë²„ì— ì ‘ì†í–ˆìŠµë‹ˆë‹¤!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ìˆ˜ìµ ê³µì‹]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ [ëŒ€ìš©ëŸ‰ ë°ì´í„° ë³€í™˜]\nê¸¸ì´: {msg_len}ì\në³´ìƒ: {reward}â‚© ì ë¦½ ì™„ë£Œ\nğŸ”— íŒŒì¼ ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ ì²˜ë¦¬]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        total = user['money'] + user['bank_money']
        res = f"ğŸ’° {nick}ë‹˜ì˜ ìì‚° ë³´ê³ ì„œ\n" \
              f"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" \
              f"ğŸ’µ í˜„ê¸ˆ: {user['money']:,}â‚©\n" \
              f"ğŸ¦ ì€í–‰: {user['bank_money']:,}â‚©\n" \
              f"ğŸ’³ ì´í•©: {total:,}â‚©\n" \
              f"ğŸ† ë“±ê¸‰: {'ì´ˆì›”ì' if total >= 10000000 else 'VIP' if total >= 1000000 else 'í‰ë¯¼'}"
        emit('message', {'msg': res, 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt:,}â‚©ì„ ì€í–‰ì— ì•ˆì „í•˜ê²Œ ë³´ê´€í–ˆìŠµë‹ˆë‹¤. (ë¶„ë‹¹ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ ì€í–‰ì—ì„œ {amt:,}â‚©ì„ ì¶œê¸ˆí–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ì´ ê°€ë™ë˜ì—ˆìŠµë‹ˆë‹¤! (3ì´ˆë‹¹ 5000â‚©)", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆ ì—”ì§„ì„ ì •ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            prompt = " ".join(cmd_parts[1:])
            res = client.models.generate_content(model="gemini-2.0-flash", contents=prompt)
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except Exception as e:
            emit('message', {'msg': f"âŒ ì—ëŸ¬: {str(e)}", 'type': 'system'})

    elif cmd == "!ëª…ë ¹ì–´":
        help_msg = "ğŸ“œ [ëª…ë ¹ì–´ ë¦¬ìŠ¤íŠ¸]\n!ì”ì•¡ - ë‚´ ìì‚° í™•ì¸\n!ì €ê¸ˆ [ì•¡ìˆ˜] - ì€í–‰ì— ì…ê¸ˆ\n!ì¶œê¸ˆ [ì•¡ìˆ˜] - í˜„ê¸ˆí™”\n!ë‡Œì ˆ - ë¬´í•œ ëˆ ë²Œê¸° ì‹œì‘\n!ë‡Œì ˆì¤‘ë‹¨ - ì¤‘ì§€\n!gemini [ì§ˆë¬¸] - AI ë‹µë³€\n!ëª…ë ¹ì–´ - ë„ì›€ë§"
        emit('message', {'msg': help_msg, 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ…
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=background_scheduler, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
import random
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í™˜ê²½] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "multiverse_empire.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {}

# Gemini AI í´ë¼ì´ì–¸íŠ¸ ì„¤ì •
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key:
        client = genai.Client(api_key=api_key)
except:
    print("Gemini SDKê°€ ì—†ê±°ë‚˜ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. !gemini ê¸°ëŠ¥ì€ ë¹„í™œì„±í™”ë©ë‹ˆë‹¤.")

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("""
            CREATE TABLE IF NOT EXISTS users (
                nickname TEXT PRIMARY KEY, 
                money INTEGER DEFAULT 1000, 
                bank_money INTEGER DEFAULT 0
            )
        """)
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ë° ë‰´ìŠ¤ ì‹œìŠ¤í…œ]
def background_scheduler():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤ ì‹¤í–‰
        with sqlite3.connect(DB_FILE) as conn:
            # 1. ì´ì ì§€ê¸‰ (1%)
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()
        
        # 2. ì‹¤ì‹œê°„ ê²½ì œ ë‰´ìŠ¤ ì´ë²¤íŠ¸
        news_list = [
            "ğŸ“¢ [ê²½ì œ] ì œêµ­ ì€í–‰ì˜ ê¸ˆë¦¬ê°€ ìƒìŠ¹ ì¡°ì§ì„ ë³´ì…ë‹ˆë‹¤!",
            "ğŸ“¢ [ì†Œì‹] ëŒ€ê·œëª¨ ë‡Œì ˆ ì—ë„ˆì§€ê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ì±„êµ´ íš¨ìœ¨ì´ ì¦ê°€í•©ë‹ˆë‹¤.",
            "ğŸ“¢ [ê³µì§€] í˜„ì¬ ìµœê³  ë¶€ìëŠ” 'ì´ˆì›”ì' ë“±ê¸‰ì„ ìœ ì§€í•˜ê³  ìˆìŠµë‹ˆë‹¤.",
            "ğŸ“¢ [ì´ë²¤íŠ¸] ì§€ê¸ˆ ì±„íŒ…ì„ ì…ë ¥í•˜ë©´ ë³´ë„ˆìŠ¤ í¬ì¸íŠ¸ê°€ ì§€ê¸‰ë  í™•ë¥ ì´ ë†’ìŠµë‹ˆë‹¤!"
        ]
        socketio.emit('message', {'msg': random.choice(news_list), 'type': 'system'}, room='main')

# --- [3. íŠ¹ìˆ˜ ê¸°ëŠ¥ ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 1
        reward = 5000
        update_money(nick, reward, bank=True)
        pattern = f"ğŸŒ€ [{nick}] ë‡Œì ˆ ë™ë ¥ ê°€ë™ ì¤‘... (+{reward}â‚© ì…ê¸ˆ)"
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"{pattern}\në¬´í•œ ë£¨í”„ íšŸìˆ˜: {m_count}íšŒì°¨", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3)

def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [4. ë¼ìš°íŒ… ë° ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸš€ {data['nickname']}ë‹˜ì´ ë©€í‹°ë²„ìŠ¤ ì„œë²„ì— ì ‘ì†í–ˆìŠµë‹ˆë‹¤!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ìˆ˜ìµ ê³µì‹]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ [ëŒ€ìš©ëŸ‰ ë°ì´í„° ë³€í™˜]\nê¸¸ì´: {msg_len}ì\në³´ìƒ: {reward}â‚© ì ë¦½ ì™„ë£Œ\nğŸ”— íŒŒì¼ ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ ì²˜ë¦¬]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        total = user['money'] + user['bank_money']
        res = f"ğŸ’° {nick}ë‹˜ì˜ ìì‚° ë³´ê³ ì„œ\n" \
              f"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" \
              f"ğŸ’µ í˜„ê¸ˆ: {user['money']:,}â‚©\n" \
              f"ğŸ¦ ì€í–‰: {user['bank_money']:,}â‚©\n" \
              f"ğŸ’³ ì´í•©: {total:,}â‚©\n" \
              f"ğŸ† ë“±ê¸‰: {'ì´ˆì›”ì' if total >= 10000000 else 'VIP' if total >= 1000000 else 'í‰ë¯¼'}"
        emit('message', {'msg': res, 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt:,}â‚©ì„ ì€í–‰ì— ì•ˆì „í•˜ê²Œ ë³´ê´€í–ˆìŠµë‹ˆë‹¤. (ë¶„ë‹¹ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ ì€í–‰ì—ì„œ {amt:,}â‚©ì„ ì¶œê¸ˆí–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ì´ ê°€ë™ë˜ì—ˆìŠµë‹ˆë‹¤! (3ì´ˆë‹¹ 5000â‚©)", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆ ì—”ì§„ì„ ì •ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            prompt = " ".join(cmd_parts[1:])
            res = client.models.generate_content(model="gemini-2.0-flash", contents=prompt)
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except Exception as e:
            emit('message', {'msg': f"âŒ ì—ëŸ¬: {str(e)}", 'type': 'system'})

    elif cmd == "!ëª…ë ¹ì–´":
        help_msg = "ğŸ“œ [ëª…ë ¹ì–´ ë¦¬ìŠ¤íŠ¸]\n!ì”ì•¡ - ë‚´ ìì‚° í™•ì¸\n!ì €ê¸ˆ [ì•¡ìˆ˜] - ì€í–‰ì— ì…ê¸ˆ\n!ì¶œê¸ˆ [ì•¡ìˆ˜] - í˜„ê¸ˆí™”\n!ë‡Œì ˆ - ë¬´í•œ ëˆ ë²Œê¸° ì‹œì‘\n!ë‡Œì ˆì¤‘ë‹¨ - ì¤‘ì§€\n!gemini [ì§ˆë¬¸] - AI ë‹µë³€\n!ëª…ë ¹ì–´ - ë„ì›€ë§"
        emit('message', {'msg': help_msg, 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ…
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=background_scheduler, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
import random
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í™˜ê²½] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "multiverse_empire.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {}

# Gemini AI í´ë¼ì´ì–¸íŠ¸ ì„¤ì •
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key:
        client = genai.Client(api_key=api_key)
except:
    print("Gemini SDKê°€ ì—†ê±°ë‚˜ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. !gemini ê¸°ëŠ¥ì€ ë¹„í™œì„±í™”ë©ë‹ˆë‹¤.")

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("""
            CREATE TABLE IF NOT EXISTS users (
                nickname TEXT PRIMARY KEY, 
                money INTEGER DEFAULT 1000, 
                bank_money INTEGER DEFAULT 0
            )
        """)
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ë° ë‰´ìŠ¤ ì‹œìŠ¤í…œ]
def background_scheduler():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤ ì‹¤í–‰
        with sqlite3.connect(DB_FILE) as conn:
            # 1. ì´ì ì§€ê¸‰ (1%)
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()
        
        # 2. ì‹¤ì‹œê°„ ê²½ì œ ë‰´ìŠ¤ ì´ë²¤íŠ¸
        news_list = [
            "ğŸ“¢ [ê²½ì œ] ì œêµ­ ì€í–‰ì˜ ê¸ˆë¦¬ê°€ ìƒìŠ¹ ì¡°ì§ì„ ë³´ì…ë‹ˆë‹¤!",
            "ğŸ“¢ [ì†Œì‹] ëŒ€ê·œëª¨ ë‡Œì ˆ ì—ë„ˆì§€ê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ì±„êµ´ íš¨ìœ¨ì´ ì¦ê°€í•©ë‹ˆë‹¤.",
            "ğŸ“¢ [ê³µì§€] í˜„ì¬ ìµœê³  ë¶€ìëŠ” 'ì´ˆì›”ì' ë“±ê¸‰ì„ ìœ ì§€í•˜ê³  ìˆìŠµë‹ˆë‹¤.",
            "ğŸ“¢ [ì´ë²¤íŠ¸] ì§€ê¸ˆ ì±„íŒ…ì„ ì…ë ¥í•˜ë©´ ë³´ë„ˆìŠ¤ í¬ì¸íŠ¸ê°€ ì§€ê¸‰ë  í™•ë¥ ì´ ë†’ìŠµë‹ˆë‹¤!"
        ]
        socketio.emit('message', {'msg': random.choice(news_list), 'type': 'system'}, room='main')

# --- [3. íŠ¹ìˆ˜ ê¸°ëŠ¥ ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 1
        reward = 5000
        update_money(nick, reward, bank=True)
        pattern = f"ğŸŒ€ [{nick}] ë‡Œì ˆ ë™ë ¥ ê°€ë™ ì¤‘... (+{reward}â‚© ì…ê¸ˆ)"
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"{pattern}\në¬´í•œ ë£¨í”„ íšŸìˆ˜: {m_count}íšŒì°¨", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3)

def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [4. ë¼ìš°íŒ… ë° ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸš€ {data['nickname']}ë‹˜ì´ ë©€í‹°ë²„ìŠ¤ ì„œë²„ì— ì ‘ì†í–ˆìŠµë‹ˆë‹¤!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ìˆ˜ìµ ê³µì‹]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ [ëŒ€ìš©ëŸ‰ ë°ì´í„° ë³€í™˜]\nê¸¸ì´: {msg_len}ì\në³´ìƒ: {reward}â‚© ì ë¦½ ì™„ë£Œ\nğŸ”— íŒŒì¼ ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ ì²˜ë¦¬]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        total = user['money'] + user['bank_money']
        res = f"ğŸ’° {nick}ë‹˜ì˜ ìì‚° ë³´ê³ ì„œ\n" \
              f"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" \
              f"ğŸ’µ í˜„ê¸ˆ: {user['money']:,}â‚©\n" \
              f"ğŸ¦ ì€í–‰: {user['bank_money']:,}â‚©\n" \
              f"ğŸ’³ ì´í•©: {total:,}â‚©\n" \
              f"ğŸ† ë“±ê¸‰: {'ì´ˆì›”ì' if total >= 10000000 else 'VIP' if total >= 1000000 else 'í‰ë¯¼'}"
        emit('message', {'msg': res, 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt:,}â‚©ì„ ì€í–‰ì— ì•ˆì „í•˜ê²Œ ë³´ê´€í–ˆìŠµë‹ˆë‹¤. (ë¶„ë‹¹ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ ì€í–‰ì—ì„œ {amt:,}â‚©ì„ ì¶œê¸ˆí–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ì´ ê°€ë™ë˜ì—ˆìŠµë‹ˆë‹¤! (3ì´ˆë‹¹ 5000â‚©)", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆ ì—”ì§„ì„ ì •ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            prompt = " ".join(cmd_parts[1:])
            res = client.models.generate_content(model="gemini-2.0-flash", contents=prompt)
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except Exception as e:
            emit('message', {'msg': f"âŒ ì—ëŸ¬: {str(e)}", 'type': 'system'})

    elif cmd == "!ëª…ë ¹ì–´":
        help_msg = "ğŸ“œ [ëª…ë ¹ì–´ ë¦¬ìŠ¤íŠ¸]\n!ì”ì•¡ - ë‚´ ìì‚° í™•ì¸\n!ì €ê¸ˆ [ì•¡ìˆ˜] - ì€í–‰ì— ì…ê¸ˆ\n!ì¶œê¸ˆ [ì•¡ìˆ˜] - í˜„ê¸ˆí™”\n!ë‡Œì ˆ - ë¬´í•œ ëˆ ë²Œê¸° ì‹œì‘\n!ë‡Œì ˆì¤‘ë‹¨ - ì¤‘ì§€\n!gemini [ì§ˆë¬¸] - AI ë‹µë³€\n!ëª…ë ¹ì–´ - ë„ì›€ë§"
        emit('message', {'msg': help_msg, 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ…
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=background_scheduler, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
import random
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í™˜ê²½] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "multiverse_empire.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {}

# Gemini AI í´ë¼ì´ì–¸íŠ¸ ì„¤ì •
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key:
        client = genai.Client(api_key=api_key)
except:
    print("Gemini SDKê°€ ì—†ê±°ë‚˜ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. !gemini ê¸°ëŠ¥ì€ ë¹„í™œì„±í™”ë©ë‹ˆë‹¤.")

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("""
            CREATE TABLE IF NOT EXISTS users (
                nickname TEXT PRIMARY KEY, 
                money INTEGER DEFAULT 1000, 
                bank_money INTEGER DEFAULT 0
            )
        """)
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ë° ë‰´ìŠ¤ ì‹œìŠ¤í…œ]
def background_scheduler():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤ ì‹¤í–‰
        with sqlite3.connect(DB_FILE) as conn:
            # 1. ì´ì ì§€ê¸‰ (1%)
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()
        
        # 2. ì‹¤ì‹œê°„ ê²½ì œ ë‰´ìŠ¤ ì´ë²¤íŠ¸
        news_list = [
            "ğŸ“¢ [ê²½ì œ] ì œêµ­ ì€í–‰ì˜ ê¸ˆë¦¬ê°€ ìƒìŠ¹ ì¡°ì§ì„ ë³´ì…ë‹ˆë‹¤!",
            "ğŸ“¢ [ì†Œì‹] ëŒ€ê·œëª¨ ë‡Œì ˆ ì—ë„ˆì§€ê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ì±„êµ´ íš¨ìœ¨ì´ ì¦ê°€í•©ë‹ˆë‹¤.",
            "ğŸ“¢ [ê³µì§€] í˜„ì¬ ìµœê³  ë¶€ìëŠ” 'ì´ˆì›”ì' ë“±ê¸‰ì„ ìœ ì§€í•˜ê³  ìˆìŠµë‹ˆë‹¤.",
            "ğŸ“¢ [ì´ë²¤íŠ¸] ì§€ê¸ˆ ì±„íŒ…ì„ ì…ë ¥í•˜ë©´ ë³´ë„ˆìŠ¤ í¬ì¸íŠ¸ê°€ ì§€ê¸‰ë  í™•ë¥ ì´ ë†’ìŠµë‹ˆë‹¤!"
        ]
        socketio.emit('message', {'msg': random.choice(news_list), 'type': 'system'}, room='main')

# --- [3. íŠ¹ìˆ˜ ê¸°ëŠ¥ ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 1
        reward = 5000
        update_money(nick, reward, bank=True)
        pattern = f"ğŸŒ€ [{nick}] ë‡Œì ˆ ë™ë ¥ ê°€ë™ ì¤‘... (+{reward}â‚© ì…ê¸ˆ)"
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"{pattern}\në¬´í•œ ë£¨í”„ íšŸìˆ˜: {m_count}íšŒì°¨", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3)

def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [4. ë¼ìš°íŒ… ë° ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸš€ {data['nickname']}ë‹˜ì´ ë©€í‹°ë²„ìŠ¤ ì„œë²„ì— ì ‘ì†í–ˆìŠµë‹ˆë‹¤!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ìˆ˜ìµ ê³µì‹]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ [ëŒ€ìš©ëŸ‰ ë°ì´í„° ë³€í™˜]\nê¸¸ì´: {msg_len}ì\në³´ìƒ: {reward}â‚© ì ë¦½ ì™„ë£Œ\nğŸ”— íŒŒì¼ ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ ì²˜ë¦¬]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        total = user['money'] + user['bank_money']
        res = f"ğŸ’° {nick}ë‹˜ì˜ ìì‚° ë³´ê³ ì„œ\n" \
              f"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" \
              f"ğŸ’µ í˜„ê¸ˆ: {user['money']:,}â‚©\n" \
              f"ğŸ¦ ì€í–‰: {user['bank_money']:,}â‚©\n" \
              f"ğŸ’³ ì´í•©: {total:,}â‚©\n" \
              f"ğŸ† ë“±ê¸‰: {'ì´ˆì›”ì' if total >= 10000000 else 'VIP' if total >= 1000000 else 'í‰ë¯¼'}"
        emit('message', {'msg': res, 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt:,}â‚©ì„ ì€í–‰ì— ì•ˆì „í•˜ê²Œ ë³´ê´€í–ˆìŠµë‹ˆë‹¤. (ë¶„ë‹¹ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ ì€í–‰ì—ì„œ {amt:,}â‚©ì„ ì¶œê¸ˆí–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ì´ ê°€ë™ë˜ì—ˆìŠµë‹ˆë‹¤! (3ì´ˆë‹¹ 5000â‚©)", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆ ì—”ì§„ì„ ì •ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            prompt = " ".join(cmd_parts[1:])
            res = client.models.generate_content(model="gemini-2.0-flash", contents=prompt)
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except Exception as e:
            emit('message', {'msg': f"âŒ ì—ëŸ¬: {str(e)}", 'type': 'system'})

    elif cmd == "!ëª…ë ¹ì–´":
        help_msg = "ğŸ“œ [ëª…ë ¹ì–´ ë¦¬ìŠ¤íŠ¸]\n!ì”ì•¡ - ë‚´ ìì‚° í™•ì¸\n!ì €ê¸ˆ [ì•¡ìˆ˜] - ì€í–‰ì— ì…ê¸ˆ\n!ì¶œê¸ˆ [ì•¡ìˆ˜] - í˜„ê¸ˆí™”\n!ë‡Œì ˆ - ë¬´í•œ ëˆ ë²Œê¸° ì‹œì‘\n!ë‡Œì ˆì¤‘ë‹¨ - ì¤‘ì§€\n!gemini [ì§ˆë¬¸] - AI ë‹µë³€\n!ëª…ë ¹ì–´ - ë„ì›€ë§"
        emit('message', {'msg': help_msg, 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ…
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=background_scheduler, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
import random
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í™˜ê²½] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "multiverse_empire.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {}

# Gemini AI í´ë¼ì´ì–¸íŠ¸ ì„¤ì •
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key:
        client = genai.Client(api_key=api_key)
except:
    print("Gemini SDKê°€ ì—†ê±°ë‚˜ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. !gemini ê¸°ëŠ¥ì€ ë¹„í™œì„±í™”ë©ë‹ˆë‹¤.")

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("""
            CREATE TABLE IF NOT EXISTS users (
                nickname TEXT PRIMARY KEY, 
                money INTEGER DEFAULT 1000, 
                bank_money INTEGER DEFAULT 0
            )
        """)
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ë° ë‰´ìŠ¤ ì‹œìŠ¤í…œ]
def background_scheduler():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤ ì‹¤í–‰
        with sqlite3.connect(DB_FILE) as conn:
            # 1. ì´ì ì§€ê¸‰ (1%)
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()
        
        # 2. ì‹¤ì‹œê°„ ê²½ì œ ë‰´ìŠ¤ ì´ë²¤íŠ¸
        news_list = [
            "ğŸ“¢ [ê²½ì œ] ì œêµ­ ì€í–‰ì˜ ê¸ˆë¦¬ê°€ ìƒìŠ¹ ì¡°ì§ì„ ë³´ì…ë‹ˆë‹¤!",
            "ğŸ“¢ [ì†Œì‹] ëŒ€ê·œëª¨ ë‡Œì ˆ ì—ë„ˆì§€ê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ì±„êµ´ íš¨ìœ¨ì´ ì¦ê°€í•©ë‹ˆë‹¤.",
            "ğŸ“¢ [ê³µì§€] í˜„ì¬ ìµœê³  ë¶€ìëŠ” 'ì´ˆì›”ì' ë“±ê¸‰ì„ ìœ ì§€í•˜ê³  ìˆìŠµë‹ˆë‹¤.",
            "ğŸ“¢ [ì´ë²¤íŠ¸] ì§€ê¸ˆ ì±„íŒ…ì„ ì…ë ¥í•˜ë©´ ë³´ë„ˆìŠ¤ í¬ì¸íŠ¸ê°€ ì§€ê¸‰ë  í™•ë¥ ì´ ë†’ìŠµë‹ˆë‹¤!"
        ]
        socketio.emit('message', {'msg': random.choice(news_list), 'type': 'system'}, room='main')

# --- [3. íŠ¹ìˆ˜ ê¸°ëŠ¥ ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 1
        reward = 5000
        update_money(nick, reward, bank=True)
        pattern = f"ğŸŒ€ [{nick}] ë‡Œì ˆ ë™ë ¥ ê°€ë™ ì¤‘... (+{reward}â‚© ì…ê¸ˆ)"
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"{pattern}\në¬´í•œ ë£¨í”„ íšŸìˆ˜: {m_count}íšŒì°¨", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3)

def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [4. ë¼ìš°íŒ… ë° ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸš€ {data['nickname']}ë‹˜ì´ ë©€í‹°ë²„ìŠ¤ ì„œë²„ì— ì ‘ì†í–ˆìŠµë‹ˆë‹¤!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ìˆ˜ìµ ê³µì‹]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ [ëŒ€ìš©ëŸ‰ ë°ì´í„° ë³€í™˜]\nê¸¸ì´: {msg_len}ì\në³´ìƒ: {reward}â‚© ì ë¦½ ì™„ë£Œ\nğŸ”— íŒŒì¼ ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ ì²˜ë¦¬]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        total = user['money'] + user['bank_money']
        res = f"ğŸ’° {nick}ë‹˜ì˜ ìì‚° ë³´ê³ ì„œ\n" \
              f"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" \
              f"ğŸ’µ í˜„ê¸ˆ: {user['money']:,}â‚©\n" \
              f"ğŸ¦ ì€í–‰: {user['bank_money']:,}â‚©\n" \
              f"ğŸ’³ ì´í•©: {total:,}â‚©\n" \
              f"ğŸ† ë“±ê¸‰: {'ì´ˆì›”ì' if total >= 10000000 else 'VIP' if total >= 1000000 else 'í‰ë¯¼'}"
        emit('message', {'msg': res, 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt:,}â‚©ì„ ì€í–‰ì— ì•ˆì „í•˜ê²Œ ë³´ê´€í–ˆìŠµë‹ˆë‹¤. (ë¶„ë‹¹ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ ì€í–‰ì—ì„œ {amt:,}â‚©ì„ ì¶œê¸ˆí–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ì´ ê°€ë™ë˜ì—ˆìŠµë‹ˆë‹¤! (3ì´ˆë‹¹ 5000â‚©)", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆ ì—”ì§„ì„ ì •ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            prompt = " ".join(cmd_parts[1:])
            res = client.models.generate_content(model="gemini-2.0-flash", contents=prompt)
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except Exception as e:
            emit('message', {'msg': f"âŒ ì—ëŸ¬: {str(e)}", 'type': 'system'})

    elif cmd == "!ëª…ë ¹ì–´":
        help_msg = "ğŸ“œ [ëª…ë ¹ì–´ ë¦¬ìŠ¤íŠ¸]\n!ì”ì•¡ - ë‚´ ìì‚° í™•ì¸\n!ì €ê¸ˆ [ì•¡ìˆ˜] - ì€í–‰ì— ì…ê¸ˆ\n!ì¶œê¸ˆ [ì•¡ìˆ˜] - í˜„ê¸ˆí™”\n!ë‡Œì ˆ - ë¬´í•œ ëˆ ë²Œê¸° ì‹œì‘\n!ë‡Œì ˆì¤‘ë‹¨ - ì¤‘ì§€\n!gemini [ì§ˆë¬¸] - AI ë‹µë³€\n!ëª…ë ¹ì–´ - ë„ì›€ë§"
        emit('message', {'msg': help_msg, 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ…
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=background_scheduler, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
import random
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í™˜ê²½] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "multiverse_empire.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {}

# Gemini AI í´ë¼ì´ì–¸íŠ¸ ì„¤ì •
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key:
        client = genai.Client(api_key=api_key)
except:
    print("Gemini SDKê°€ ì—†ê±°ë‚˜ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. !gemini ê¸°ëŠ¥ì€ ë¹„í™œì„±í™”ë©ë‹ˆë‹¤.")

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("""
            CREATE TABLE IF NOT EXISTS users (
                nickname TEXT PRIMARY KEY, 
                money INTEGER DEFAULT 1000, 
                bank_money INTEGER DEFAULT 0
            )
        """)
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ë° ë‰´ìŠ¤ ì‹œìŠ¤í…œ]
def background_scheduler():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤ ì‹¤í–‰
        with sqlite3.connect(DB_FILE) as conn:
            # 1. ì´ì ì§€ê¸‰ (1%)
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()
        
        # 2. ì‹¤ì‹œê°„ ê²½ì œ ë‰´ìŠ¤ ì´ë²¤íŠ¸
        news_list = [
            "ğŸ“¢ [ê²½ì œ] ì œêµ­ ì€í–‰ì˜ ê¸ˆë¦¬ê°€ ìƒìŠ¹ ì¡°ì§ì„ ë³´ì…ë‹ˆë‹¤!",
            "ğŸ“¢ [ì†Œì‹] ëŒ€ê·œëª¨ ë‡Œì ˆ ì—ë„ˆì§€ê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ì±„êµ´ íš¨ìœ¨ì´ ì¦ê°€í•©ë‹ˆë‹¤.",
            "ğŸ“¢ [ê³µì§€] í˜„ì¬ ìµœê³  ë¶€ìëŠ” 'ì´ˆì›”ì' ë“±ê¸‰ì„ ìœ ì§€í•˜ê³  ìˆìŠµë‹ˆë‹¤.",
            "ğŸ“¢ [ì´ë²¤íŠ¸] ì§€ê¸ˆ ì±„íŒ…ì„ ì…ë ¥í•˜ë©´ ë³´ë„ˆìŠ¤ í¬ì¸íŠ¸ê°€ ì§€ê¸‰ë  í™•ë¥ ì´ ë†’ìŠµë‹ˆë‹¤!"
        ]
        socketio.emit('message', {'msg': random.choice(news_list), 'type': 'system'}, room='main')

# --- [3. íŠ¹ìˆ˜ ê¸°ëŠ¥ ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 1
        reward = 5000
        update_money(nick, reward, bank=True)
        pattern = f"ğŸŒ€ [{nick}] ë‡Œì ˆ ë™ë ¥ ê°€ë™ ì¤‘... (+{reward}â‚© ì…ê¸ˆ)"
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"{pattern}\në¬´í•œ ë£¨í”„ íšŸìˆ˜: {m_count}íšŒì°¨", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3)

def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [4. ë¼ìš°íŒ… ë° ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸš€ {data['nickname']}ë‹˜ì´ ë©€í‹°ë²„ìŠ¤ ì„œë²„ì— ì ‘ì†í–ˆìŠµë‹ˆë‹¤!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ìˆ˜ìµ ê³µì‹]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ [ëŒ€ìš©ëŸ‰ ë°ì´í„° ë³€í™˜]\nê¸¸ì´: {msg_len}ì\në³´ìƒ: {reward}â‚© ì ë¦½ ì™„ë£Œ\nğŸ”— íŒŒì¼ ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ ì²˜ë¦¬]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        total = user['money'] + user['bank_money']
        res = f"ğŸ’° {nick}ë‹˜ì˜ ìì‚° ë³´ê³ ì„œ\n" \
              f"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" \
              f"ğŸ’µ í˜„ê¸ˆ: {user['money']:,}â‚©\n" \
              f"ğŸ¦ ì€í–‰: {user['bank_money']:,}â‚©\n" \
              f"ğŸ’³ ì´í•©: {total:,}â‚©\n" \
              f"ğŸ† ë“±ê¸‰: {'ì´ˆì›”ì' if total >= 10000000 else 'VIP' if total >= 1000000 else 'í‰ë¯¼'}"
        emit('message', {'msg': res, 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt:,}â‚©ì„ ì€í–‰ì— ì•ˆì „í•˜ê²Œ ë³´ê´€í–ˆìŠµë‹ˆë‹¤. (ë¶„ë‹¹ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ ì€í–‰ì—ì„œ {amt:,}â‚©ì„ ì¶œê¸ˆí–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ì´ ê°€ë™ë˜ì—ˆìŠµë‹ˆë‹¤! (3ì´ˆë‹¹ 5000â‚©)", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆ ì—”ì§„ì„ ì •ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            prompt = " ".join(cmd_parts[1:])
            res = client.models.generate_content(model="gemini-2.0-flash", contents=prompt)
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except Exception as e:
            emit('message', {'msg': f"âŒ ì—ëŸ¬: {str(e)}", 'type': 'system'})

    elif cmd == "!ëª…ë ¹ì–´":
        help_msg = "ğŸ“œ [ëª…ë ¹ì–´ ë¦¬ìŠ¤íŠ¸]\n!ì”ì•¡ - ë‚´ ìì‚° í™•ì¸\n!ì €ê¸ˆ [ì•¡ìˆ˜] - ì€í–‰ì— ì…ê¸ˆ\n!ì¶œê¸ˆ [ì•¡ìˆ˜] - í˜„ê¸ˆí™”\n!ë‡Œì ˆ - ë¬´í•œ ëˆ ë²Œê¸° ì‹œì‘\n!ë‡Œì ˆì¤‘ë‹¨ - ì¤‘ì§€\n!gemini [ì§ˆë¬¸] - AI ë‹µë³€\n!ëª…ë ¹ì–´ - ë„ì›€ë§"
        emit('message', {'msg': help_msg, 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ…
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=background_scheduler, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
import random
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í™˜ê²½] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "multiverse_empire.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {}

# Gemini AI í´ë¼ì´ì–¸íŠ¸ ì„¤ì •
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key:
        client = genai.Client(api_key=api_key)
except:
    print("Gemini SDKê°€ ì—†ê±°ë‚˜ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. !gemini ê¸°ëŠ¥ì€ ë¹„í™œì„±í™”ë©ë‹ˆë‹¤.")

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("""
            CREATE TABLE IF NOT EXISTS users (
                nickname TEXT PRIMARY KEY, 
                money INTEGER DEFAULT 1000, 
                bank_money INTEGER DEFAULT 0
            )
        """)
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ë° ë‰´ìŠ¤ ì‹œìŠ¤í…œ]
def background_scheduler():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤ ì‹¤í–‰
        with sqlite3.connect(DB_FILE) as conn:
            # 1. ì´ì ì§€ê¸‰ (1%)
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()
        
        # 2. ì‹¤ì‹œê°„ ê²½ì œ ë‰´ìŠ¤ ì´ë²¤íŠ¸
        news_list = [
            "ğŸ“¢ [ê²½ì œ] ì œêµ­ ì€í–‰ì˜ ê¸ˆë¦¬ê°€ ìƒìŠ¹ ì¡°ì§ì„ ë³´ì…ë‹ˆë‹¤!",
            "ğŸ“¢ [ì†Œì‹] ëŒ€ê·œëª¨ ë‡Œì ˆ ì—ë„ˆì§€ê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ì±„êµ´ íš¨ìœ¨ì´ ì¦ê°€í•©ë‹ˆë‹¤.",
            "ğŸ“¢ [ê³µì§€] í˜„ì¬ ìµœê³  ë¶€ìëŠ” 'ì´ˆì›”ì' ë“±ê¸‰ì„ ìœ ì§€í•˜ê³  ìˆìŠµë‹ˆë‹¤.",
            "ğŸ“¢ [ì´ë²¤íŠ¸] ì§€ê¸ˆ ì±„íŒ…ì„ ì…ë ¥í•˜ë©´ ë³´ë„ˆìŠ¤ í¬ì¸íŠ¸ê°€ ì§€ê¸‰ë  í™•ë¥ ì´ ë†’ìŠµë‹ˆë‹¤!"
        ]
        socketio.emit('message', {'msg': random.choice(news_list), 'type': 'system'}, room='main')

# --- [3. íŠ¹ìˆ˜ ê¸°ëŠ¥ ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 1
        reward = 5000
        update_money(nick, reward, bank=True)
        pattern = f"ğŸŒ€ [{nick}] ë‡Œì ˆ ë™ë ¥ ê°€ë™ ì¤‘... (+{reward}â‚© ì…ê¸ˆ)"
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"{pattern}\në¬´í•œ ë£¨í”„ íšŸìˆ˜: {m_count}íšŒì°¨", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3)

def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [4. ë¼ìš°íŒ… ë° ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸš€ {data['nickname']}ë‹˜ì´ ë©€í‹°ë²„ìŠ¤ ì„œë²„ì— ì ‘ì†í–ˆìŠµë‹ˆë‹¤!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ìˆ˜ìµ ê³µì‹]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ [ëŒ€ìš©ëŸ‰ ë°ì´í„° ë³€í™˜]\nê¸¸ì´: {msg_len}ì\në³´ìƒ: {reward}â‚© ì ë¦½ ì™„ë£Œ\nğŸ”— íŒŒì¼ ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ ì²˜ë¦¬]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        total = user['money'] + user['bank_money']
        res = f"ğŸ’° {nick}ë‹˜ì˜ ìì‚° ë³´ê³ ì„œ\n" \
              f"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" \
              f"ğŸ’µ í˜„ê¸ˆ: {user['money']:,}â‚©\n" \
              f"ğŸ¦ ì€í–‰: {user['bank_money']:,}â‚©\n" \
              f"ğŸ’³ ì´í•©: {total:,}â‚©\n" \
              f"ğŸ† ë“±ê¸‰: {'ì´ˆì›”ì' if total >= 10000000 else 'VIP' if total >= 1000000 else 'í‰ë¯¼'}"
        emit('message', {'msg': res, 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt:,}â‚©ì„ ì€í–‰ì— ì•ˆì „í•˜ê²Œ ë³´ê´€í–ˆìŠµë‹ˆë‹¤. (ë¶„ë‹¹ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ ì€í–‰ì—ì„œ {amt:,}â‚©ì„ ì¶œê¸ˆí–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ì´ ê°€ë™ë˜ì—ˆìŠµë‹ˆë‹¤! (3ì´ˆë‹¹ 5000â‚©)", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆ ì—”ì§„ì„ ì •ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            prompt = " ".join(cmd_parts[1:])
            res = client.models.generate_content(model="gemini-2.0-flash", contents=prompt)
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except Exception as e:
            emit('message', {'msg': f"âŒ ì—ëŸ¬: {str(e)}", 'type': 'system'})

    elif cmd == "!ëª…ë ¹ì–´":
        help_msg = "ğŸ“œ [ëª…ë ¹ì–´ ë¦¬ìŠ¤íŠ¸]\n!ì”ì•¡ - ë‚´ ìì‚° í™•ì¸\n!ì €ê¸ˆ [ì•¡ìˆ˜] - ì€í–‰ì— ì…ê¸ˆ\n!ì¶œê¸ˆ [ì•¡ìˆ˜] - í˜„ê¸ˆí™”\n!ë‡Œì ˆ - ë¬´í•œ ëˆ ë²Œê¸° ì‹œì‘\n!ë‡Œì ˆì¤‘ë‹¨ - ì¤‘ì§€\n!gemini [ì§ˆë¬¸] - AI ë‹µë³€\n!ëª…ë ¹ì–´ - ë„ì›€ë§"
        emit('message', {'msg': help_msg, 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ…
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=background_scheduler, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
import random
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í™˜ê²½] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "multiverse_empire.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {}

# Gemini AI í´ë¼ì´ì–¸íŠ¸ ì„¤ì •
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key:
        client = genai.Client(api_key=api_key)
except:
    print("Gemini SDKê°€ ì—†ê±°ë‚˜ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. !gemini ê¸°ëŠ¥ì€ ë¹„í™œì„±í™”ë©ë‹ˆë‹¤.")

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("""
            CREATE TABLE IF NOT EXISTS users (
                nickname TEXT PRIMARY KEY, 
                money INTEGER DEFAULT 1000, 
                bank_money INTEGER DEFAULT 0
            )
        """)
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ë° ë‰´ìŠ¤ ì‹œìŠ¤í…œ]
def background_scheduler():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤ ì‹¤í–‰
        with sqlite3.connect(DB_FILE) as conn:
            # 1. ì´ì ì§€ê¸‰ (1%)
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()
        
        # 2. ì‹¤ì‹œê°„ ê²½ì œ ë‰´ìŠ¤ ì´ë²¤íŠ¸
        news_list = [
            "ğŸ“¢ [ê²½ì œ] ì œêµ­ ì€í–‰ì˜ ê¸ˆë¦¬ê°€ ìƒìŠ¹ ì¡°ì§ì„ ë³´ì…ë‹ˆë‹¤!",
            "ğŸ“¢ [ì†Œì‹] ëŒ€ê·œëª¨ ë‡Œì ˆ ì—ë„ˆì§€ê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ì±„êµ´ íš¨ìœ¨ì´ ì¦ê°€í•©ë‹ˆë‹¤.",
            "ğŸ“¢ [ê³µì§€] í˜„ì¬ ìµœê³  ë¶€ìëŠ” 'ì´ˆì›”ì' ë“±ê¸‰ì„ ìœ ì§€í•˜ê³  ìˆìŠµë‹ˆë‹¤.",
            "ğŸ“¢ [ì´ë²¤íŠ¸] ì§€ê¸ˆ ì±„íŒ…ì„ ì…ë ¥í•˜ë©´ ë³´ë„ˆìŠ¤ í¬ì¸íŠ¸ê°€ ì§€ê¸‰ë  í™•ë¥ ì´ ë†’ìŠµë‹ˆë‹¤!"
        ]
        socketio.emit('message', {'msg': random.choice(news_list), 'type': 'system'}, room='main')

# --- [3. íŠ¹ìˆ˜ ê¸°ëŠ¥ ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 1
        reward = 5000
        update_money(nick, reward, bank=True)
        pattern = f"ğŸŒ€ [{nick}] ë‡Œì ˆ ë™ë ¥ ê°€ë™ ì¤‘... (+{reward}â‚© ì…ê¸ˆ)"
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"{pattern}\në¬´í•œ ë£¨í”„ íšŸìˆ˜: {m_count}íšŒì°¨", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3)

def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [4. ë¼ìš°íŒ… ë° ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸš€ {data['nickname']}ë‹˜ì´ ë©€í‹°ë²„ìŠ¤ ì„œë²„ì— ì ‘ì†í–ˆìŠµë‹ˆë‹¤!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ìˆ˜ìµ ê³µì‹]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ [ëŒ€ìš©ëŸ‰ ë°ì´í„° ë³€í™˜]\nê¸¸ì´: {msg_len}ì\në³´ìƒ: {reward}â‚© ì ë¦½ ì™„ë£Œ\nğŸ”— íŒŒì¼ ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ ì²˜ë¦¬]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        total = user['money'] + user['bank_money']
        res = f"ğŸ’° {nick}ë‹˜ì˜ ìì‚° ë³´ê³ ì„œ\n" \
              f"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" \
              f"ğŸ’µ í˜„ê¸ˆ: {user['money']:,}â‚©\n" \
              f"ğŸ¦ ì€í–‰: {user['bank_money']:,}â‚©\n" \
              f"ğŸ’³ ì´í•©: {total:,}â‚©\n" \
              f"ğŸ† ë“±ê¸‰: {'ì´ˆì›”ì' if total >= 10000000 else 'VIP' if total >= 1000000 else 'í‰ë¯¼'}"
        emit('message', {'msg': res, 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt:,}â‚©ì„ ì€í–‰ì— ì•ˆì „í•˜ê²Œ ë³´ê´€í–ˆìŠµë‹ˆë‹¤. (ë¶„ë‹¹ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ ì€í–‰ì—ì„œ {amt:,}â‚©ì„ ì¶œê¸ˆí–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ì´ ê°€ë™ë˜ì—ˆìŠµë‹ˆë‹¤! (3ì´ˆë‹¹ 5000â‚©)", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆ ì—”ì§„ì„ ì •ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            prompt = " ".join(cmd_parts[1:])
            res = client.models.generate_content(model="gemini-2.0-flash", contents=prompt)
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except Exception as e:
            emit('message', {'msg': f"âŒ ì—ëŸ¬: {str(e)}", 'type': 'system'})

    elif cmd == "!ëª…ë ¹ì–´":
        help_msg = "ğŸ“œ [ëª…ë ¹ì–´ ë¦¬ìŠ¤íŠ¸]\n!ì”ì•¡ - ë‚´ ìì‚° í™•ì¸\n!ì €ê¸ˆ [ì•¡ìˆ˜] - ì€í–‰ì— ì…ê¸ˆ\n!ì¶œê¸ˆ [ì•¡ìˆ˜] - í˜„ê¸ˆí™”\n!ë‡Œì ˆ - ë¬´í•œ ëˆ ë²Œê¸° ì‹œì‘\n!ë‡Œì ˆì¤‘ë‹¨ - ì¤‘ì§€\n!gemini [ì§ˆë¬¸] - AI ë‹µë³€\n!ëª…ë ¹ì–´ - ë„ì›€ë§"
        emit('message', {'msg': help_msg, 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ…
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=background_scheduler, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
import random
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í™˜ê²½] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "multiverse_empire.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {}

# Gemini AI í´ë¼ì´ì–¸íŠ¸ ì„¤ì •
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key:
        client = genai.Client(api_key=api_key)
except:
    print("Gemini SDKê°€ ì—†ê±°ë‚˜ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. !gemini ê¸°ëŠ¥ì€ ë¹„í™œì„±í™”ë©ë‹ˆë‹¤.")

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("""
            CREATE TABLE IF NOT EXISTS users (
                nickname TEXT PRIMARY KEY, 
                money INTEGER DEFAULT 1000, 
                bank_money INTEGER DEFAULT 0
            )
        """)
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ë° ë‰´ìŠ¤ ì‹œìŠ¤í…œ]
def background_scheduler():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤ ì‹¤í–‰
        with sqlite3.connect(DB_FILE) as conn:
            # 1. ì´ì ì§€ê¸‰ (1%)
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()
        
        # 2. ì‹¤ì‹œê°„ ê²½ì œ ë‰´ìŠ¤ ì´ë²¤íŠ¸
        news_list = [
            "ğŸ“¢ [ê²½ì œ] ì œêµ­ ì€í–‰ì˜ ê¸ˆë¦¬ê°€ ìƒìŠ¹ ì¡°ì§ì„ ë³´ì…ë‹ˆë‹¤!",
            "ğŸ“¢ [ì†Œì‹] ëŒ€ê·œëª¨ ë‡Œì ˆ ì—ë„ˆì§€ê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ì±„êµ´ íš¨ìœ¨ì´ ì¦ê°€í•©ë‹ˆë‹¤.",
            "ğŸ“¢ [ê³µì§€] í˜„ì¬ ìµœê³  ë¶€ìëŠ” 'ì´ˆì›”ì' ë“±ê¸‰ì„ ìœ ì§€í•˜ê³  ìˆìŠµë‹ˆë‹¤.",
            "ğŸ“¢ [ì´ë²¤íŠ¸] ì§€ê¸ˆ ì±„íŒ…ì„ ì…ë ¥í•˜ë©´ ë³´ë„ˆìŠ¤ í¬ì¸íŠ¸ê°€ ì§€ê¸‰ë  í™•ë¥ ì´ ë†’ìŠµë‹ˆë‹¤!"
        ]
        socketio.emit('message', {'msg': random.choice(news_list), 'type': 'system'}, room='main')

# --- [3. íŠ¹ìˆ˜ ê¸°ëŠ¥ ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 1
        reward = 5000
        update_money(nick, reward, bank=True)
        pattern = f"ğŸŒ€ [{nick}] ë‡Œì ˆ ë™ë ¥ ê°€ë™ ì¤‘... (+{reward}â‚© ì…ê¸ˆ)"
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"{pattern}\në¬´í•œ ë£¨í”„ íšŸìˆ˜: {m_count}íšŒì°¨", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3)

def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [4. ë¼ìš°íŒ… ë° ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸš€ {data['nickname']}ë‹˜ì´ ë©€í‹°ë²„ìŠ¤ ì„œë²„ì— ì ‘ì†í–ˆìŠµë‹ˆë‹¤!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ìˆ˜ìµ ê³µì‹]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ [ëŒ€ìš©ëŸ‰ ë°ì´í„° ë³€í™˜]\nê¸¸ì´: {msg_len}ì\në³´ìƒ: {reward}â‚© ì ë¦½ ì™„ë£Œ\nğŸ”— íŒŒì¼ ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ ì²˜ë¦¬]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        total = user['money'] + user['bank_money']
        res = f"ğŸ’° {nick}ë‹˜ì˜ ìì‚° ë³´ê³ ì„œ\n" \
              f"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" \
              f"ğŸ’µ í˜„ê¸ˆ: {user['money']:,}â‚©\n" \
              f"ğŸ¦ ì€í–‰: {user['bank_money']:,}â‚©\n" \
              f"ğŸ’³ ì´í•©: {total:,}â‚©\n" \
              f"ğŸ† ë“±ê¸‰: {'ì´ˆì›”ì' if total >= 10000000 else 'VIP' if total >= 1000000 else 'í‰ë¯¼'}"
        emit('message', {'msg': res, 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt:,}â‚©ì„ ì€í–‰ì— ì•ˆì „í•˜ê²Œ ë³´ê´€í–ˆìŠµë‹ˆë‹¤. (ë¶„ë‹¹ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ ì€í–‰ì—ì„œ {amt:,}â‚©ì„ ì¶œê¸ˆí–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ì´ ê°€ë™ë˜ì—ˆìŠµë‹ˆë‹¤! (3ì´ˆë‹¹ 5000â‚©)", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆ ì—”ì§„ì„ ì •ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            prompt = " ".join(cmd_parts[1:])
            res = client.models.generate_content(model="gemini-2.0-flash", contents=prompt)
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except Exception as e:
            emit('message', {'msg': f"âŒ ì—ëŸ¬: {str(e)}", 'type': 'system'})

    elif cmd == "!ëª…ë ¹ì–´":
        help_msg = "ğŸ“œ [ëª…ë ¹ì–´ ë¦¬ìŠ¤íŠ¸]\n!ì”ì•¡ - ë‚´ ìì‚° í™•ì¸\n!ì €ê¸ˆ [ì•¡ìˆ˜] - ì€í–‰ì— ì…ê¸ˆ\n!ì¶œê¸ˆ [ì•¡ìˆ˜] - í˜„ê¸ˆí™”\n!ë‡Œì ˆ - ë¬´í•œ ëˆ ë²Œê¸° ì‹œì‘\n!ë‡Œì ˆì¤‘ë‹¨ - ì¤‘ì§€\n!gemini [ì§ˆë¬¸] - AI ë‹µë³€\n!ëª…ë ¹ì–´ - ë„ì›€ë§"
        emit('message', {'msg': help_msg, 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ…
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=background_scheduler, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
import random
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í™˜ê²½] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "multiverse_empire.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {}

# Gemini AI í´ë¼ì´ì–¸íŠ¸ ì„¤ì •
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key:
        client = genai.Client(api_key=api_key)
except:
    print("Gemini SDKê°€ ì—†ê±°ë‚˜ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. !gemini ê¸°ëŠ¥ì€ ë¹„í™œì„±í™”ë©ë‹ˆë‹¤.")

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("""
            CREATE TABLE IF NOT EXISTS users (
                nickname TEXT PRIMARY KEY, 
                money INTEGER DEFAULT 1000, 
                bank_money INTEGER DEFAULT 0
            )
        """)
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ë° ë‰´ìŠ¤ ì‹œìŠ¤í…œ]
def background_scheduler():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤ ì‹¤í–‰
        with sqlite3.connect(DB_FILE) as conn:
            # 1. ì´ì ì§€ê¸‰ (1%)
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()
        
        # 2. ì‹¤ì‹œê°„ ê²½ì œ ë‰´ìŠ¤ ì´ë²¤íŠ¸
        news_list = [
            "ğŸ“¢ [ê²½ì œ] ì œêµ­ ì€í–‰ì˜ ê¸ˆë¦¬ê°€ ìƒìŠ¹ ì¡°ì§ì„ ë³´ì…ë‹ˆë‹¤!",
            "ğŸ“¢ [ì†Œì‹] ëŒ€ê·œëª¨ ë‡Œì ˆ ì—ë„ˆì§€ê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ì±„êµ´ íš¨ìœ¨ì´ ì¦ê°€í•©ë‹ˆë‹¤.",
            "ğŸ“¢ [ê³µì§€] í˜„ì¬ ìµœê³  ë¶€ìëŠ” 'ì´ˆì›”ì' ë“±ê¸‰ì„ ìœ ì§€í•˜ê³  ìˆìŠµë‹ˆë‹¤.",
            "ğŸ“¢ [ì´ë²¤íŠ¸] ì§€ê¸ˆ ì±„íŒ…ì„ ì…ë ¥í•˜ë©´ ë³´ë„ˆìŠ¤ í¬ì¸íŠ¸ê°€ ì§€ê¸‰ë  í™•ë¥ ì´ ë†’ìŠµë‹ˆë‹¤!"
        ]
        socketio.emit('message', {'msg': random.choice(news_list), 'type': 'system'}, room='main')

# --- [3. íŠ¹ìˆ˜ ê¸°ëŠ¥ ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 1
        reward = 5000
        update_money(nick, reward, bank=True)
        pattern = f"ğŸŒ€ [{nick}] ë‡Œì ˆ ë™ë ¥ ê°€ë™ ì¤‘... (+{reward}â‚© ì…ê¸ˆ)"
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"{pattern}\në¬´í•œ ë£¨í”„ íšŸìˆ˜: {m_count}íšŒì°¨", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3)

def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [4. ë¼ìš°íŒ… ë° ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸš€ {data['nickname']}ë‹˜ì´ ë©€í‹°ë²„ìŠ¤ ì„œë²„ì— ì ‘ì†í–ˆìŠµë‹ˆë‹¤!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ìˆ˜ìµ ê³µì‹]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ [ëŒ€ìš©ëŸ‰ ë°ì´í„° ë³€í™˜]\nê¸¸ì´: {msg_len}ì\në³´ìƒ: {reward}â‚© ì ë¦½ ì™„ë£Œ\nğŸ”— íŒŒì¼ ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ ì²˜ë¦¬]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        total = user['money'] + user['bank_money']
        res = f"ğŸ’° {nick}ë‹˜ì˜ ìì‚° ë³´ê³ ì„œ\n" \
              f"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" \
              f"ğŸ’µ í˜„ê¸ˆ: {user['money']:,}â‚©\n" \
              f"ğŸ¦ ì€í–‰: {user['bank_money']:,}â‚©\n" \
              f"ğŸ’³ ì´í•©: {total:,}â‚©\n" \
              f"ğŸ† ë“±ê¸‰: {'ì´ˆì›”ì' if total >= 10000000 else 'VIP' if total >= 1000000 else 'í‰ë¯¼'}"
        emit('message', {'msg': res, 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt:,}â‚©ì„ ì€í–‰ì— ì•ˆì „í•˜ê²Œ ë³´ê´€í–ˆìŠµë‹ˆë‹¤. (ë¶„ë‹¹ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ ì€í–‰ì—ì„œ {amt:,}â‚©ì„ ì¶œê¸ˆí–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ì´ ê°€ë™ë˜ì—ˆìŠµë‹ˆë‹¤! (3ì´ˆë‹¹ 5000â‚©)", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆ ì—”ì§„ì„ ì •ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            prompt = " ".join(cmd_parts[1:])
            res = client.models.generate_content(model="gemini-2.0-flash", contents=prompt)
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except Exception as e:
            emit('message', {'msg': f"âŒ ì—ëŸ¬: {str(e)}", 'type': 'system'})

    elif cmd == "!ëª…ë ¹ì–´":
        help_msg = "ğŸ“œ [ëª…ë ¹ì–´ ë¦¬ìŠ¤íŠ¸]\n!ì”ì•¡ - ë‚´ ìì‚° í™•ì¸\n!ì €ê¸ˆ [ì•¡ìˆ˜] - ì€í–‰ì— ì…ê¸ˆ\n!ì¶œê¸ˆ [ì•¡ìˆ˜] - í˜„ê¸ˆí™”\n!ë‡Œì ˆ - ë¬´í•œ ëˆ ë²Œê¸° ì‹œì‘\n!ë‡Œì ˆì¤‘ë‹¨ - ì¤‘ì§€\n!gemini [ì§ˆë¬¸] - AI ë‹µë³€\n!ëª…ë ¹ì–´ - ë„ì›€ë§"
        emit('message', {'msg': help_msg, 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ…
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=background_scheduler, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
import random
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í™˜ê²½] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "multiverse_empire.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {}

# Gemini AI í´ë¼ì´ì–¸íŠ¸ ì„¤ì •
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key:
        client = genai.Client(api_key=api_key)
except:
    print("Gemini SDKê°€ ì—†ê±°ë‚˜ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. !gemini ê¸°ëŠ¥ì€ ë¹„í™œì„±í™”ë©ë‹ˆë‹¤.")

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("""
            CREATE TABLE IF NOT EXISTS users (
                nickname TEXT PRIMARY KEY, 
                money INTEGER DEFAULT 1000, 
                bank_money INTEGER DEFAULT 0
            )
        """)
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ë° ë‰´ìŠ¤ ì‹œìŠ¤í…œ]
def background_scheduler():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤ ì‹¤í–‰
        with sqlite3.connect(DB_FILE) as conn:
            # 1. ì´ì ì§€ê¸‰ (1%)
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()
        
        # 2. ì‹¤ì‹œê°„ ê²½ì œ ë‰´ìŠ¤ ì´ë²¤íŠ¸
        news_list = [
            "ğŸ“¢ [ê²½ì œ] ì œêµ­ ì€í–‰ì˜ ê¸ˆë¦¬ê°€ ìƒìŠ¹ ì¡°ì§ì„ ë³´ì…ë‹ˆë‹¤!",
            "ğŸ“¢ [ì†Œì‹] ëŒ€ê·œëª¨ ë‡Œì ˆ ì—ë„ˆì§€ê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ì±„êµ´ íš¨ìœ¨ì´ ì¦ê°€í•©ë‹ˆë‹¤.",
            "ğŸ“¢ [ê³µì§€] í˜„ì¬ ìµœê³  ë¶€ìëŠ” 'ì´ˆì›”ì' ë“±ê¸‰ì„ ìœ ì§€í•˜ê³  ìˆìŠµë‹ˆë‹¤.",
            "ğŸ“¢ [ì´ë²¤íŠ¸] ì§€ê¸ˆ ì±„íŒ…ì„ ì…ë ¥í•˜ë©´ ë³´ë„ˆìŠ¤ í¬ì¸íŠ¸ê°€ ì§€ê¸‰ë  í™•ë¥ ì´ ë†’ìŠµë‹ˆë‹¤!"
        ]
        socketio.emit('message', {'msg': random.choice(news_list), 'type': 'system'}, room='main')

# --- [3. íŠ¹ìˆ˜ ê¸°ëŠ¥ ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 1
        reward = 5000
        update_money(nick, reward, bank=True)
        pattern = f"ğŸŒ€ [{nick}] ë‡Œì ˆ ë™ë ¥ ê°€ë™ ì¤‘... (+{reward}â‚© ì…ê¸ˆ)"
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"{pattern}\në¬´í•œ ë£¨í”„ íšŸìˆ˜: {m_count}íšŒì°¨", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3)

def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [4. ë¼ìš°íŒ… ë° ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸš€ {data['nickname']}ë‹˜ì´ ë©€í‹°ë²„ìŠ¤ ì„œë²„ì— ì ‘ì†í–ˆìŠµë‹ˆë‹¤!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ìˆ˜ìµ ê³µì‹]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ [ëŒ€ìš©ëŸ‰ ë°ì´í„° ë³€í™˜]\nê¸¸ì´: {msg_len}ì\në³´ìƒ: {reward}â‚© ì ë¦½ ì™„ë£Œ\nğŸ”— íŒŒì¼ ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ ì²˜ë¦¬]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        total = user['money'] + user['bank_money']
        res = f"ğŸ’° {nick}ë‹˜ì˜ ìì‚° ë³´ê³ ì„œ\n" \
              f"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" \
              f"ğŸ’µ í˜„ê¸ˆ: {user['money']:,}â‚©\n" \
              f"ğŸ¦ ì€í–‰: {user['bank_money']:,}â‚©\n" \
              f"ğŸ’³ ì´í•©: {total:,}â‚©\n" \
              f"ğŸ† ë“±ê¸‰: {'ì´ˆì›”ì' if total >= 10000000 else 'VIP' if total >= 1000000 else 'í‰ë¯¼'}"
        emit('message', {'msg': res, 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt:,}â‚©ì„ ì€í–‰ì— ì•ˆì „í•˜ê²Œ ë³´ê´€í–ˆìŠµë‹ˆë‹¤. (ë¶„ë‹¹ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ ì€í–‰ì—ì„œ {amt:,}â‚©ì„ ì¶œê¸ˆí–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ì´ ê°€ë™ë˜ì—ˆìŠµë‹ˆë‹¤! (3ì´ˆë‹¹ 5000â‚©)", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆ ì—”ì§„ì„ ì •ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            prompt = " ".join(cmd_parts[1:])
            res = client.models.generate_content(model="gemini-2.0-flash", contents=prompt)
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except Exception as e:
            emit('message', {'msg': f"âŒ ì—ëŸ¬: {str(e)}", 'type': 'system'})

    elif cmd == "!ëª…ë ¹ì–´":
        help_msg = "ğŸ“œ [ëª…ë ¹ì–´ ë¦¬ìŠ¤íŠ¸]\n!ì”ì•¡ - ë‚´ ìì‚° í™•ì¸\n!ì €ê¸ˆ [ì•¡ìˆ˜] - ì€í–‰ì— ì…ê¸ˆ\n!ì¶œê¸ˆ [ì•¡ìˆ˜] - í˜„ê¸ˆí™”\n!ë‡Œì ˆ - ë¬´í•œ ëˆ ë²Œê¸° ì‹œì‘\n!ë‡Œì ˆì¤‘ë‹¨ - ì¤‘ì§€\n!gemini [ì§ˆë¬¸] - AI ë‹µë³€\n!ëª…ë ¹ì–´ - ë„ì›€ë§"
        emit('message', {'msg': help_msg, 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ…
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=background_scheduler, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
import random
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í™˜ê²½] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "multiverse_empire.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {}

# Gemini AI í´ë¼ì´ì–¸íŠ¸ ì„¤ì •
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key:
        client = genai.Client(api_key=api_key)
except:
    print("Gemini SDKê°€ ì—†ê±°ë‚˜ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. !gemini ê¸°ëŠ¥ì€ ë¹„í™œì„±í™”ë©ë‹ˆë‹¤.")

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("""
            CREATE TABLE IF NOT EXISTS users (
                nickname TEXT PRIMARY KEY, 
                money INTEGER DEFAULT 1000, 
                bank_money INTEGER DEFAULT 0
            )
        """)
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ë° ë‰´ìŠ¤ ì‹œìŠ¤í…œ]
def background_scheduler():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤ ì‹¤í–‰
        with sqlite3.connect(DB_FILE) as conn:
            # 1. ì´ì ì§€ê¸‰ (1%)
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()
        
        # 2. ì‹¤ì‹œê°„ ê²½ì œ ë‰´ìŠ¤ ì´ë²¤íŠ¸
        news_list = [
            "ğŸ“¢ [ê²½ì œ] ì œêµ­ ì€í–‰ì˜ ê¸ˆë¦¬ê°€ ìƒìŠ¹ ì¡°ì§ì„ ë³´ì…ë‹ˆë‹¤!",
            "ğŸ“¢ [ì†Œì‹] ëŒ€ê·œëª¨ ë‡Œì ˆ ì—ë„ˆì§€ê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ì±„êµ´ íš¨ìœ¨ì´ ì¦ê°€í•©ë‹ˆë‹¤.",
            "ğŸ“¢ [ê³µì§€] í˜„ì¬ ìµœê³  ë¶€ìëŠ” 'ì´ˆì›”ì' ë“±ê¸‰ì„ ìœ ì§€í•˜ê³  ìˆìŠµë‹ˆë‹¤.",
            "ğŸ“¢ [ì´ë²¤íŠ¸] ì§€ê¸ˆ ì±„íŒ…ì„ ì…ë ¥í•˜ë©´ ë³´ë„ˆìŠ¤ í¬ì¸íŠ¸ê°€ ì§€ê¸‰ë  í™•ë¥ ì´ ë†’ìŠµë‹ˆë‹¤!"
        ]
        socketio.emit('message', {'msg': random.choice(news_list), 'type': 'system'}, room='main')

# --- [3. íŠ¹ìˆ˜ ê¸°ëŠ¥ ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 1
        reward = 5000
        update_money(nick, reward, bank=True)
        pattern = f"ğŸŒ€ [{nick}] ë‡Œì ˆ ë™ë ¥ ê°€ë™ ì¤‘... (+{reward}â‚© ì…ê¸ˆ)"
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"{pattern}\në¬´í•œ ë£¨í”„ íšŸìˆ˜: {m_count}íšŒì°¨", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3)

def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [4. ë¼ìš°íŒ… ë° ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸš€ {data['nickname']}ë‹˜ì´ ë©€í‹°ë²„ìŠ¤ ì„œë²„ì— ì ‘ì†í–ˆìŠµë‹ˆë‹¤!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ìˆ˜ìµ ê³µì‹]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ [ëŒ€ìš©ëŸ‰ ë°ì´í„° ë³€í™˜]\nê¸¸ì´: {msg_len}ì\në³´ìƒ: {reward}â‚© ì ë¦½ ì™„ë£Œ\nğŸ”— íŒŒì¼ ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ ì²˜ë¦¬]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        total = user['money'] + user['bank_money']
        res = f"ğŸ’° {nick}ë‹˜ì˜ ìì‚° ë³´ê³ ì„œ\n" \
              f"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" \
              f"ğŸ’µ í˜„ê¸ˆ: {user['money']:,}â‚©\n" \
              f"ğŸ¦ ì€í–‰: {user['bank_money']:,}â‚©\n" \
              f"ğŸ’³ ì´í•©: {total:,}â‚©\n" \
              f"ğŸ† ë“±ê¸‰: {'ì´ˆì›”ì' if total >= 10000000 else 'VIP' if total >= 1000000 else 'í‰ë¯¼'}"
        emit('message', {'msg': res, 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt:,}â‚©ì„ ì€í–‰ì— ì•ˆì „í•˜ê²Œ ë³´ê´€í–ˆìŠµë‹ˆë‹¤. (ë¶„ë‹¹ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ ì€í–‰ì—ì„œ {amt:,}â‚©ì„ ì¶œê¸ˆí–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ì´ ê°€ë™ë˜ì—ˆìŠµë‹ˆë‹¤! (3ì´ˆë‹¹ 5000â‚©)", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆ ì—”ì§„ì„ ì •ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            prompt = " ".join(cmd_parts[1:])
            res = client.models.generate_content(model="gemini-2.0-flash", contents=prompt)
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except Exception as e:
            emit('message', {'msg': f"âŒ ì—ëŸ¬: {str(e)}", 'type': 'system'})

    elif cmd == "!ëª…ë ¹ì–´":
        help_msg = "ğŸ“œ [ëª…ë ¹ì–´ ë¦¬ìŠ¤íŠ¸]\n!ì”ì•¡ - ë‚´ ìì‚° í™•ì¸\n!ì €ê¸ˆ [ì•¡ìˆ˜] - ì€í–‰ì— ì…ê¸ˆ\n!ì¶œê¸ˆ [ì•¡ìˆ˜] - í˜„ê¸ˆí™”\n!ë‡Œì ˆ - ë¬´í•œ ëˆ ë²Œê¸° ì‹œì‘\n!ë‡Œì ˆì¤‘ë‹¨ - ì¤‘ì§€\n!gemini [ì§ˆë¬¸] - AI ë‹µë³€\n!ëª…ë ¹ì–´ - ë„ì›€ë§"
        emit('message', {'msg': help_msg, 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ…
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=background_scheduler, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
import random
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í™˜ê²½] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "multiverse_empire.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {}

# Gemini AI í´ë¼ì´ì–¸íŠ¸ ì„¤ì •
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key:
        client = genai.Client(api_key=api_key)
except:
    print("Gemini SDKê°€ ì—†ê±°ë‚˜ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. !gemini ê¸°ëŠ¥ì€ ë¹„í™œì„±í™”ë©ë‹ˆë‹¤.")

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("""
            CREATE TABLE IF NOT EXISTS users (
                nickname TEXT PRIMARY KEY, 
                money INTEGER DEFAULT 1000, 
                bank_money INTEGER DEFAULT 0
            )
        """)
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ë° ë‰´ìŠ¤ ì‹œìŠ¤í…œ]
def background_scheduler():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤ ì‹¤í–‰
        with sqlite3.connect(DB_FILE) as conn:
            # 1. ì´ì ì§€ê¸‰ (1%)
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()
        
        # 2. ì‹¤ì‹œê°„ ê²½ì œ ë‰´ìŠ¤ ì´ë²¤íŠ¸
        news_list = [
            "ğŸ“¢ [ê²½ì œ] ì œêµ­ ì€í–‰ì˜ ê¸ˆë¦¬ê°€ ìƒìŠ¹ ì¡°ì§ì„ ë³´ì…ë‹ˆë‹¤!",
            "ğŸ“¢ [ì†Œì‹] ëŒ€ê·œëª¨ ë‡Œì ˆ ì—ë„ˆì§€ê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ì±„êµ´ íš¨ìœ¨ì´ ì¦ê°€í•©ë‹ˆë‹¤.",
            "ğŸ“¢ [ê³µì§€] í˜„ì¬ ìµœê³  ë¶€ìëŠ” 'ì´ˆì›”ì' ë“±ê¸‰ì„ ìœ ì§€í•˜ê³  ìˆìŠµë‹ˆë‹¤.",
            "ğŸ“¢ [ì´ë²¤íŠ¸] ì§€ê¸ˆ ì±„íŒ…ì„ ì…ë ¥í•˜ë©´ ë³´ë„ˆìŠ¤ í¬ì¸íŠ¸ê°€ ì§€ê¸‰ë  í™•ë¥ ì´ ë†’ìŠµë‹ˆë‹¤!"
        ]
        socketio.emit('message', {'msg': random.choice(news_list), 'type': 'system'}, room='main')

# --- [3. íŠ¹ìˆ˜ ê¸°ëŠ¥ ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 1
        reward = 5000
        update_money(nick, reward, bank=True)
        pattern = f"ğŸŒ€ [{nick}] ë‡Œì ˆ ë™ë ¥ ê°€ë™ ì¤‘... (+{reward}â‚© ì…ê¸ˆ)"
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"{pattern}\në¬´í•œ ë£¨í”„ íšŸìˆ˜: {m_count}íšŒì°¨", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3)

def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [4. ë¼ìš°íŒ… ë° ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸš€ {data['nickname']}ë‹˜ì´ ë©€í‹°ë²„ìŠ¤ ì„œë²„ì— ì ‘ì†í–ˆìŠµë‹ˆë‹¤!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ìˆ˜ìµ ê³µì‹]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ [ëŒ€ìš©ëŸ‰ ë°ì´í„° ë³€í™˜]\nê¸¸ì´: {msg_len}ì\në³´ìƒ: {reward}â‚© ì ë¦½ ì™„ë£Œ\nğŸ”— íŒŒì¼ ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ ì²˜ë¦¬]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        total = user['money'] + user['bank_money']
        res = f"ğŸ’° {nick}ë‹˜ì˜ ìì‚° ë³´ê³ ì„œ\n" \
              f"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" \
              f"ğŸ’µ í˜„ê¸ˆ: {user['money']:,}â‚©\n" \
              f"ğŸ¦ ì€í–‰: {user['bank_money']:,}â‚©\n" \
              f"ğŸ’³ ì´í•©: {total:,}â‚©\n" \
              f"ğŸ† ë“±ê¸‰: {'ì´ˆì›”ì' if total >= 10000000 else 'VIP' if total >= 1000000 else 'í‰ë¯¼'}"
        emit('message', {'msg': res, 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt:,}â‚©ì„ ì€í–‰ì— ì•ˆì „í•˜ê²Œ ë³´ê´€í–ˆìŠµë‹ˆë‹¤. (ë¶„ë‹¹ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ ì€í–‰ì—ì„œ {amt:,}â‚©ì„ ì¶œê¸ˆí–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ì´ ê°€ë™ë˜ì—ˆìŠµë‹ˆë‹¤! (3ì´ˆë‹¹ 5000â‚©)", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆ ì—”ì§„ì„ ì •ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            prompt = " ".join(cmd_parts[1:])
            res = client.models.generate_content(model="gemini-2.0-flash", contents=prompt)
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except Exception as e:
            emit('message', {'msg': f"âŒ ì—ëŸ¬: {str(e)}", 'type': 'system'})

    elif cmd == "!ëª…ë ¹ì–´":
        help_msg = "ğŸ“œ [ëª…ë ¹ì–´ ë¦¬ìŠ¤íŠ¸]\n!ì”ì•¡ - ë‚´ ìì‚° í™•ì¸\n!ì €ê¸ˆ [ì•¡ìˆ˜] - ì€í–‰ì— ì…ê¸ˆ\n!ì¶œê¸ˆ [ì•¡ìˆ˜] - í˜„ê¸ˆí™”\n!ë‡Œì ˆ - ë¬´í•œ ëˆ ë²Œê¸° ì‹œì‘\n!ë‡Œì ˆì¤‘ë‹¨ - ì¤‘ì§€\n!gemini [ì§ˆë¬¸] - AI ë‹µë³€\n!ëª…ë ¹ì–´ - ë„ì›€ë§"
        emit('message', {'msg': help_msg, 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ…
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=background_scheduler, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
import random
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í™˜ê²½] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "multiverse_empire.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {}

# Gemini AI í´ë¼ì´ì–¸íŠ¸ ì„¤ì •
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key:
        client = genai.Client(api_key=api_key)
except:
    print("Gemini SDKê°€ ì—†ê±°ë‚˜ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. !gemini ê¸°ëŠ¥ì€ ë¹„í™œì„±í™”ë©ë‹ˆë‹¤.")

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("""
            CREATE TABLE IF NOT EXISTS users (
                nickname TEXT PRIMARY KEY, 
                money INTEGER DEFAULT 1000, 
                bank_money INTEGER DEFAULT 0
            )
        """)
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ë° ë‰´ìŠ¤ ì‹œìŠ¤í…œ]
def background_scheduler():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤ ì‹¤í–‰
        with sqlite3.connect(DB_FILE) as conn:
            # 1. ì´ì ì§€ê¸‰ (1%)
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()
        
        # 2. ì‹¤ì‹œê°„ ê²½ì œ ë‰´ìŠ¤ ì´ë²¤íŠ¸
        news_list = [
            "ğŸ“¢ [ê²½ì œ] ì œêµ­ ì€í–‰ì˜ ê¸ˆë¦¬ê°€ ìƒìŠ¹ ì¡°ì§ì„ ë³´ì…ë‹ˆë‹¤!",
            "ğŸ“¢ [ì†Œì‹] ëŒ€ê·œëª¨ ë‡Œì ˆ ì—ë„ˆì§€ê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ì±„êµ´ íš¨ìœ¨ì´ ì¦ê°€í•©ë‹ˆë‹¤.",
            "ğŸ“¢ [ê³µì§€] í˜„ì¬ ìµœê³  ë¶€ìëŠ” 'ì´ˆì›”ì' ë“±ê¸‰ì„ ìœ ì§€í•˜ê³  ìˆìŠµë‹ˆë‹¤.",
            "ğŸ“¢ [ì´ë²¤íŠ¸] ì§€ê¸ˆ ì±„íŒ…ì„ ì…ë ¥í•˜ë©´ ë³´ë„ˆìŠ¤ í¬ì¸íŠ¸ê°€ ì§€ê¸‰ë  í™•ë¥ ì´ ë†’ìŠµë‹ˆë‹¤!"
        ]
        socketio.emit('message', {'msg': random.choice(news_list), 'type': 'system'}, room='main')

# --- [3. íŠ¹ìˆ˜ ê¸°ëŠ¥ ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 1
        reward = 5000
        update_money(nick, reward, bank=True)
        pattern = f"ğŸŒ€ [{nick}] ë‡Œì ˆ ë™ë ¥ ê°€ë™ ì¤‘... (+{reward}â‚© ì…ê¸ˆ)"
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"{pattern}\në¬´í•œ ë£¨í”„ íšŸìˆ˜: {m_count}íšŒì°¨", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3)

def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [4. ë¼ìš°íŒ… ë° ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸš€ {data['nickname']}ë‹˜ì´ ë©€í‹°ë²„ìŠ¤ ì„œë²„ì— ì ‘ì†í–ˆìŠµë‹ˆë‹¤!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ìˆ˜ìµ ê³µì‹]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ [ëŒ€ìš©ëŸ‰ ë°ì´í„° ë³€í™˜]\nê¸¸ì´: {msg_len}ì\në³´ìƒ: {reward}â‚© ì ë¦½ ì™„ë£Œ\nğŸ”— íŒŒì¼ ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ ì²˜ë¦¬]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        total = user['money'] + user['bank_money']
        res = f"ğŸ’° {nick}ë‹˜ì˜ ìì‚° ë³´ê³ ì„œ\n" \
              f"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" \
              f"ğŸ’µ í˜„ê¸ˆ: {user['money']:,}â‚©\n" \
              f"ğŸ¦ ì€í–‰: {user['bank_money']:,}â‚©\n" \
              f"ğŸ’³ ì´í•©: {total:,}â‚©\n" \
              f"ğŸ† ë“±ê¸‰: {'ì´ˆì›”ì' if total >= 10000000 else 'VIP' if total >= 1000000 else 'í‰ë¯¼'}"
        emit('message', {'msg': res, 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt:,}â‚©ì„ ì€í–‰ì— ì•ˆì „í•˜ê²Œ ë³´ê´€í–ˆìŠµë‹ˆë‹¤. (ë¶„ë‹¹ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ ì€í–‰ì—ì„œ {amt:,}â‚©ì„ ì¶œê¸ˆí–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ì´ ê°€ë™ë˜ì—ˆìŠµë‹ˆë‹¤! (3ì´ˆë‹¹ 5000â‚©)", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆ ì—”ì§„ì„ ì •ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            prompt = " ".join(cmd_parts[1:])
            res = client.models.generate_content(model="gemini-2.0-flash", contents=prompt)
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except Exception as e:
            emit('message', {'msg': f"âŒ ì—ëŸ¬: {str(e)}", 'type': 'system'})

    elif cmd == "!ëª…ë ¹ì–´":
        help_msg = "ğŸ“œ [ëª…ë ¹ì–´ ë¦¬ìŠ¤íŠ¸]\n!ì”ì•¡ - ë‚´ ìì‚° í™•ì¸\n!ì €ê¸ˆ [ì•¡ìˆ˜] - ì€í–‰ì— ì…ê¸ˆ\n!ì¶œê¸ˆ [ì•¡ìˆ˜] - í˜„ê¸ˆí™”\n!ë‡Œì ˆ - ë¬´í•œ ëˆ ë²Œê¸° ì‹œì‘\n!ë‡Œì ˆì¤‘ë‹¨ - ì¤‘ì§€\n!gemini [ì§ˆë¬¸] - AI ë‹µë³€\n!ëª…ë ¹ì–´ - ë„ì›€ë§"
        emit('message', {'msg': help_msg, 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ…
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=background_scheduler, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
import random
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í™˜ê²½] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "multiverse_empire.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {}

# Gemini AI í´ë¼ì´ì–¸íŠ¸ ì„¤ì •
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key:
        client = genai.Client(api_key=api_key)
except:
    print("Gemini SDKê°€ ì—†ê±°ë‚˜ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. !gemini ê¸°ëŠ¥ì€ ë¹„í™œì„±í™”ë©ë‹ˆë‹¤.")

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("""
            CREATE TABLE IF NOT EXISTS users (
                nickname TEXT PRIMARY KEY, 
                money INTEGER DEFAULT 1000, 
                bank_money INTEGER DEFAULT 0
            )
        """)
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ë° ë‰´ìŠ¤ ì‹œìŠ¤í…œ]
def background_scheduler():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤ ì‹¤í–‰
        with sqlite3.connect(DB_FILE) as conn:
            # 1. ì´ì ì§€ê¸‰ (1%)
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()
        
        # 2. ì‹¤ì‹œê°„ ê²½ì œ ë‰´ìŠ¤ ì´ë²¤íŠ¸
        news_list = [
            "ğŸ“¢ [ê²½ì œ] ì œêµ­ ì€í–‰ì˜ ê¸ˆë¦¬ê°€ ìƒìŠ¹ ì¡°ì§ì„ ë³´ì…ë‹ˆë‹¤!",
            "ğŸ“¢ [ì†Œì‹] ëŒ€ê·œëª¨ ë‡Œì ˆ ì—ë„ˆì§€ê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ì±„êµ´ íš¨ìœ¨ì´ ì¦ê°€í•©ë‹ˆë‹¤.",
            "ğŸ“¢ [ê³µì§€] í˜„ì¬ ìµœê³  ë¶€ìëŠ” 'ì´ˆì›”ì' ë“±ê¸‰ì„ ìœ ì§€í•˜ê³  ìˆìŠµë‹ˆë‹¤.",
            "ğŸ“¢ [ì´ë²¤íŠ¸] ì§€ê¸ˆ ì±„íŒ…ì„ ì…ë ¥í•˜ë©´ ë³´ë„ˆìŠ¤ í¬ì¸íŠ¸ê°€ ì§€ê¸‰ë  í™•ë¥ ì´ ë†’ìŠµë‹ˆë‹¤!"
        ]
        socketio.emit('message', {'msg': random.choice(news_list), 'type': 'system'}, room='main')

# --- [3. íŠ¹ìˆ˜ ê¸°ëŠ¥ ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 1
        reward = 5000
        update_money(nick, reward, bank=True)
        pattern = f"ğŸŒ€ [{nick}] ë‡Œì ˆ ë™ë ¥ ê°€ë™ ì¤‘... (+{reward}â‚© ì…ê¸ˆ)"
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"{pattern}\në¬´í•œ ë£¨í”„ íšŸìˆ˜: {m_count}íšŒì°¨", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3)

def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [4. ë¼ìš°íŒ… ë° ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸš€ {data['nickname']}ë‹˜ì´ ë©€í‹°ë²„ìŠ¤ ì„œë²„ì— ì ‘ì†í–ˆìŠµë‹ˆë‹¤!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ìˆ˜ìµ ê³µì‹]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ [ëŒ€ìš©ëŸ‰ ë°ì´í„° ë³€í™˜]\nê¸¸ì´: {msg_len}ì\në³´ìƒ: {reward}â‚© ì ë¦½ ì™„ë£Œ\nğŸ”— íŒŒì¼ ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ ì²˜ë¦¬]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        total = user['money'] + user['bank_money']
        res = f"ğŸ’° {nick}ë‹˜ì˜ ìì‚° ë³´ê³ ì„œ\n" \
              f"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" \
              f"ğŸ’µ í˜„ê¸ˆ: {user['money']:,}â‚©\n" \
              f"ğŸ¦ ì€í–‰: {user['bank_money']:,}â‚©\n" \
              f"ğŸ’³ ì´í•©: {total:,}â‚©\n" \
              f"ğŸ† ë“±ê¸‰: {'ì´ˆì›”ì' if total >= 10000000 else 'VIP' if total >= 1000000 else 'í‰ë¯¼'}"
        emit('message', {'msg': res, 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt:,}â‚©ì„ ì€í–‰ì— ì•ˆì „í•˜ê²Œ ë³´ê´€í–ˆìŠµë‹ˆë‹¤. (ë¶„ë‹¹ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ ì€í–‰ì—ì„œ {amt:,}â‚©ì„ ì¶œê¸ˆí–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ì´ ê°€ë™ë˜ì—ˆìŠµë‹ˆë‹¤! (3ì´ˆë‹¹ 5000â‚©)", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆ ì—”ì§„ì„ ì •ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            prompt = " ".join(cmd_parts[1:])
            res = client.models.generate_content(model="gemini-2.0-flash", contents=prompt)
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except Exception as e:
            emit('message', {'msg': f"âŒ ì—ëŸ¬: {str(e)}", 'type': 'system'})

    elif cmd == "!ëª…ë ¹ì–´":
        help_msg = "ğŸ“œ [ëª…ë ¹ì–´ ë¦¬ìŠ¤íŠ¸]\n!ì”ì•¡ - ë‚´ ìì‚° í™•ì¸\n!ì €ê¸ˆ [ì•¡ìˆ˜] - ì€í–‰ì— ì…ê¸ˆ\n!ì¶œê¸ˆ [ì•¡ìˆ˜] - í˜„ê¸ˆí™”\n!ë‡Œì ˆ - ë¬´í•œ ëˆ ë²Œê¸° ì‹œì‘\n!ë‡Œì ˆì¤‘ë‹¨ - ì¤‘ì§€\n!gemini [ì§ˆë¬¸] - AI ë‹µë³€\n!ëª…ë ¹ì–´ - ë„ì›€ë§"
        emit('message', {'msg': help_msg, 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ…
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=background_scheduler, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
import random
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í™˜ê²½] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "multiverse_empire.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {}

# Gemini AI í´ë¼ì´ì–¸íŠ¸ ì„¤ì •
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key:
        client = genai.Client(api_key=api_key)
except:
    print("Gemini SDKê°€ ì—†ê±°ë‚˜ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. !gemini ê¸°ëŠ¥ì€ ë¹„í™œì„±í™”ë©ë‹ˆë‹¤.")

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("""
            CREATE TABLE IF NOT EXISTS users (
                nickname TEXT PRIMARY KEY, 
                money INTEGER DEFAULT 1000, 
                bank_money INTEGER DEFAULT 0
            )
        """)
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ë° ë‰´ìŠ¤ ì‹œìŠ¤í…œ]
def background_scheduler():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤ ì‹¤í–‰
        with sqlite3.connect(DB_FILE) as conn:
            # 1. ì´ì ì§€ê¸‰ (1%)
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()
        
        # 2. ì‹¤ì‹œê°„ ê²½ì œ ë‰´ìŠ¤ ì´ë²¤íŠ¸
        news_list = [
            "ğŸ“¢ [ê²½ì œ] ì œêµ­ ì€í–‰ì˜ ê¸ˆë¦¬ê°€ ìƒìŠ¹ ì¡°ì§ì„ ë³´ì…ë‹ˆë‹¤!",
            "ğŸ“¢ [ì†Œì‹] ëŒ€ê·œëª¨ ë‡Œì ˆ ì—ë„ˆì§€ê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ì±„êµ´ íš¨ìœ¨ì´ ì¦ê°€í•©ë‹ˆë‹¤.",
            "ğŸ“¢ [ê³µì§€] í˜„ì¬ ìµœê³  ë¶€ìëŠ” 'ì´ˆì›”ì' ë“±ê¸‰ì„ ìœ ì§€í•˜ê³  ìˆìŠµë‹ˆë‹¤.",
            "ğŸ“¢ [ì´ë²¤íŠ¸] ì§€ê¸ˆ ì±„íŒ…ì„ ì…ë ¥í•˜ë©´ ë³´ë„ˆìŠ¤ í¬ì¸íŠ¸ê°€ ì§€ê¸‰ë  í™•ë¥ ì´ ë†’ìŠµë‹ˆë‹¤!"
        ]
        socketio.emit('message', {'msg': random.choice(news_list), 'type': 'system'}, room='main')

# --- [3. íŠ¹ìˆ˜ ê¸°ëŠ¥ ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 1
        reward = 5000
        update_money(nick, reward, bank=True)
        pattern = f"ğŸŒ€ [{nick}] ë‡Œì ˆ ë™ë ¥ ê°€ë™ ì¤‘... (+{reward}â‚© ì…ê¸ˆ)"
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"{pattern}\në¬´í•œ ë£¨í”„ íšŸìˆ˜: {m_count}íšŒì°¨", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3)

def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [4. ë¼ìš°íŒ… ë° ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸš€ {data['nickname']}ë‹˜ì´ ë©€í‹°ë²„ìŠ¤ ì„œë²„ì— ì ‘ì†í–ˆìŠµë‹ˆë‹¤!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ìˆ˜ìµ ê³µì‹]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ [ëŒ€ìš©ëŸ‰ ë°ì´í„° ë³€í™˜]\nê¸¸ì´: {msg_len}ì\në³´ìƒ: {reward}â‚© ì ë¦½ ì™„ë£Œ\nğŸ”— íŒŒì¼ ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ ì²˜ë¦¬]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        total = user['money'] + user['bank_money']
        res = f"ğŸ’° {nick}ë‹˜ì˜ ìì‚° ë³´ê³ ì„œ\n" \
              f"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" \
              f"ğŸ’µ í˜„ê¸ˆ: {user['money']:,}â‚©\n" \
              f"ğŸ¦ ì€í–‰: {user['bank_money']:,}â‚©\n" \
              f"ğŸ’³ ì´í•©: {total:,}â‚©\n" \
              f"ğŸ† ë“±ê¸‰: {'ì´ˆì›”ì' if total >= 10000000 else 'VIP' if total >= 1000000 else 'í‰ë¯¼'}"
        emit('message', {'msg': res, 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt:,}â‚©ì„ ì€í–‰ì— ì•ˆì „í•˜ê²Œ ë³´ê´€í–ˆìŠµë‹ˆë‹¤. (ë¶„ë‹¹ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ ì€í–‰ì—ì„œ {amt:,}â‚©ì„ ì¶œê¸ˆí–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ì´ ê°€ë™ë˜ì—ˆìŠµë‹ˆë‹¤! (3ì´ˆë‹¹ 5000â‚©)", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆ ì—”ì§„ì„ ì •ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            prompt = " ".join(cmd_parts[1:])
            res = client.models.generate_content(model="gemini-2.0-flash", contents=prompt)
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except Exception as e:
            emit('message', {'msg': f"âŒ ì—ëŸ¬: {str(e)}", 'type': 'system'})

    elif cmd == "!ëª…ë ¹ì–´":
        help_msg = "ğŸ“œ [ëª…ë ¹ì–´ ë¦¬ìŠ¤íŠ¸]\n!ì”ì•¡ - ë‚´ ìì‚° í™•ì¸\n!ì €ê¸ˆ [ì•¡ìˆ˜] - ì€í–‰ì— ì…ê¸ˆ\n!ì¶œê¸ˆ [ì•¡ìˆ˜] - í˜„ê¸ˆí™”\n!ë‡Œì ˆ - ë¬´í•œ ëˆ ë²Œê¸° ì‹œì‘\n!ë‡Œì ˆì¤‘ë‹¨ - ì¤‘ì§€\n!gemini [ì§ˆë¬¸] - AI ë‹µë³€\n!ëª…ë ¹ì–´ - ë„ì›€ë§"
        emit('message', {'msg': help_msg, 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ…
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=background_scheduler, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
import random
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í™˜ê²½] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "multiverse_empire.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {}

# Gemini AI í´ë¼ì´ì–¸íŠ¸ ì„¤ì •
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key:
        client = genai.Client(api_key=api_key)
except:
    print("Gemini SDKê°€ ì—†ê±°ë‚˜ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. !gemini ê¸°ëŠ¥ì€ ë¹„í™œì„±í™”ë©ë‹ˆë‹¤.")

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("""
            CREATE TABLE IF NOT EXISTS users (
                nickname TEXT PRIMARY KEY, 
                money INTEGER DEFAULT 1000, 
                bank_money INTEGER DEFAULT 0
            )
        """)
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ë° ë‰´ìŠ¤ ì‹œìŠ¤í…œ]
def background_scheduler():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤ ì‹¤í–‰
        with sqlite3.connect(DB_FILE) as conn:
            # 1. ì´ì ì§€ê¸‰ (1%)
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()
        
        # 2. ì‹¤ì‹œê°„ ê²½ì œ ë‰´ìŠ¤ ì´ë²¤íŠ¸
        news_list = [
            "ğŸ“¢ [ê²½ì œ] ì œêµ­ ì€í–‰ì˜ ê¸ˆë¦¬ê°€ ìƒìŠ¹ ì¡°ì§ì„ ë³´ì…ë‹ˆë‹¤!",
            "ğŸ“¢ [ì†Œì‹] ëŒ€ê·œëª¨ ë‡Œì ˆ ì—ë„ˆì§€ê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ì±„êµ´ íš¨ìœ¨ì´ ì¦ê°€í•©ë‹ˆë‹¤.",
            "ğŸ“¢ [ê³µì§€] í˜„ì¬ ìµœê³  ë¶€ìëŠ” 'ì´ˆì›”ì' ë“±ê¸‰ì„ ìœ ì§€í•˜ê³  ìˆìŠµë‹ˆë‹¤.",
            "ğŸ“¢ [ì´ë²¤íŠ¸] ì§€ê¸ˆ ì±„íŒ…ì„ ì…ë ¥í•˜ë©´ ë³´ë„ˆìŠ¤ í¬ì¸íŠ¸ê°€ ì§€ê¸‰ë  í™•ë¥ ì´ ë†’ìŠµë‹ˆë‹¤!"
        ]
        socketio.emit('message', {'msg': random.choice(news_list), 'type': 'system'}, room='main')

# --- [3. íŠ¹ìˆ˜ ê¸°ëŠ¥ ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 1
        reward = 5000
        update_money(nick, reward, bank=True)
        pattern = f"ğŸŒ€ [{nick}] ë‡Œì ˆ ë™ë ¥ ê°€ë™ ì¤‘... (+{reward}â‚© ì…ê¸ˆ)"
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"{pattern}\në¬´í•œ ë£¨í”„ íšŸìˆ˜: {m_count}íšŒì°¨", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3)

def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [4. ë¼ìš°íŒ… ë° ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸš€ {data['nickname']}ë‹˜ì´ ë©€í‹°ë²„ìŠ¤ ì„œë²„ì— ì ‘ì†í–ˆìŠµë‹ˆë‹¤!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ìˆ˜ìµ ê³µì‹]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ [ëŒ€ìš©ëŸ‰ ë°ì´í„° ë³€í™˜]\nê¸¸ì´: {msg_len}ì\në³´ìƒ: {reward}â‚© ì ë¦½ ì™„ë£Œ\nğŸ”— íŒŒì¼ ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ ì²˜ë¦¬]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        total = user['money'] + user['bank_money']
        res = f"ğŸ’° {nick}ë‹˜ì˜ ìì‚° ë³´ê³ ì„œ\n" \
              f"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" \
              f"ğŸ’µ í˜„ê¸ˆ: {user['money']:,}â‚©\n" \
              f"ğŸ¦ ì€í–‰: {user['bank_money']:,}â‚©\n" \
              f"ğŸ’³ ì´í•©: {total:,}â‚©\n" \
              f"ğŸ† ë“±ê¸‰: {'ì´ˆì›”ì' if total >= 10000000 else 'VIP' if total >= 1000000 else 'í‰ë¯¼'}"
        emit('message', {'msg': res, 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt:,}â‚©ì„ ì€í–‰ì— ì•ˆì „í•˜ê²Œ ë³´ê´€í–ˆìŠµë‹ˆë‹¤. (ë¶„ë‹¹ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ ì€í–‰ì—ì„œ {amt:,}â‚©ì„ ì¶œê¸ˆí–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ì´ ê°€ë™ë˜ì—ˆìŠµë‹ˆë‹¤! (3ì´ˆë‹¹ 5000â‚©)", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆ ì—”ì§„ì„ ì •ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            prompt = " ".join(cmd_parts[1:])
            res = client.models.generate_content(model="gemini-2.0-flash", contents=prompt)
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except Exception as e:
            emit('message', {'msg': f"âŒ ì—ëŸ¬: {str(e)}", 'type': 'system'})

    elif cmd == "!ëª…ë ¹ì–´":
        help_msg = "ğŸ“œ [ëª…ë ¹ì–´ ë¦¬ìŠ¤íŠ¸]\n!ì”ì•¡ - ë‚´ ìì‚° í™•ì¸\n!ì €ê¸ˆ [ì•¡ìˆ˜] - ì€í–‰ì— ì…ê¸ˆ\n!ì¶œê¸ˆ [ì•¡ìˆ˜] - í˜„ê¸ˆí™”\n!ë‡Œì ˆ - ë¬´í•œ ëˆ ë²Œê¸° ì‹œì‘\n!ë‡Œì ˆì¤‘ë‹¨ - ì¤‘ì§€\n!gemini [ì§ˆë¬¸] - AI ë‹µë³€\n!ëª…ë ¹ì–´ - ë„ì›€ë§"
        emit('message', {'msg': help_msg, 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ…
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=background_scheduler, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
import random
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í™˜ê²½] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "multiverse_empire.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {}

# Gemini AI í´ë¼ì´ì–¸íŠ¸ ì„¤ì •
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key:
        client = genai.Client(api_key=api_key)
except:
    print("Gemini SDKê°€ ì—†ê±°ë‚˜ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. !gemini ê¸°ëŠ¥ì€ ë¹„í™œì„±í™”ë©ë‹ˆë‹¤.")

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("""
            CREATE TABLE IF NOT EXISTS users (
                nickname TEXT PRIMARY KEY, 
                money INTEGER DEFAULT 1000, 
                bank_money INTEGER DEFAULT 0
            )
        """)
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ë° ë‰´ìŠ¤ ì‹œìŠ¤í…œ]
def background_scheduler():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤ ì‹¤í–‰
        with sqlite3.connect(DB_FILE) as conn:
            # 1. ì´ì ì§€ê¸‰ (1%)
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()
        
        # 2. ì‹¤ì‹œê°„ ê²½ì œ ë‰´ìŠ¤ ì´ë²¤íŠ¸
        news_list = [
            "ğŸ“¢ [ê²½ì œ] ì œêµ­ ì€í–‰ì˜ ê¸ˆë¦¬ê°€ ìƒìŠ¹ ì¡°ì§ì„ ë³´ì…ë‹ˆë‹¤!",
            "ğŸ“¢ [ì†Œì‹] ëŒ€ê·œëª¨ ë‡Œì ˆ ì—ë„ˆì§€ê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ì±„êµ´ íš¨ìœ¨ì´ ì¦ê°€í•©ë‹ˆë‹¤.",
            "ğŸ“¢ [ê³µì§€] í˜„ì¬ ìµœê³  ë¶€ìëŠ” 'ì´ˆì›”ì' ë“±ê¸‰ì„ ìœ ì§€í•˜ê³  ìˆìŠµë‹ˆë‹¤.",
            "ğŸ“¢ [ì´ë²¤íŠ¸] ì§€ê¸ˆ ì±„íŒ…ì„ ì…ë ¥í•˜ë©´ ë³´ë„ˆìŠ¤ í¬ì¸íŠ¸ê°€ ì§€ê¸‰ë  í™•ë¥ ì´ ë†’ìŠµë‹ˆë‹¤!"
        ]
        socketio.emit('message', {'msg': random.choice(news_list), 'type': 'system'}, room='main')

# --- [3. íŠ¹ìˆ˜ ê¸°ëŠ¥ ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 1
        reward = 5000
        update_money(nick, reward, bank=True)
        pattern = f"ğŸŒ€ [{nick}] ë‡Œì ˆ ë™ë ¥ ê°€ë™ ì¤‘... (+{reward}â‚© ì…ê¸ˆ)"
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"{pattern}\në¬´í•œ ë£¨í”„ íšŸìˆ˜: {m_count}íšŒì°¨", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3)

def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [4. ë¼ìš°íŒ… ë° ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸš€ {data['nickname']}ë‹˜ì´ ë©€í‹°ë²„ìŠ¤ ì„œë²„ì— ì ‘ì†í–ˆìŠµë‹ˆë‹¤!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ìˆ˜ìµ ê³µì‹]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ [ëŒ€ìš©ëŸ‰ ë°ì´í„° ë³€í™˜]\nê¸¸ì´: {msg_len}ì\në³´ìƒ: {reward}â‚© ì ë¦½ ì™„ë£Œ\nğŸ”— íŒŒì¼ ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ ì²˜ë¦¬]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        total = user['money'] + user['bank_money']
        res = f"ğŸ’° {nick}ë‹˜ì˜ ìì‚° ë³´ê³ ì„œ\n" \
              f"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" \
              f"ğŸ’µ í˜„ê¸ˆ: {user['money']:,}â‚©\n" \
              f"ğŸ¦ ì€í–‰: {user['bank_money']:,}â‚©\n" \
              f"ğŸ’³ ì´í•©: {total:,}â‚©\n" \
              f"ğŸ† ë“±ê¸‰: {'ì´ˆì›”ì' if total >= 10000000 else 'VIP' if total >= 1000000 else 'í‰ë¯¼'}"
        emit('message', {'msg': res, 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt:,}â‚©ì„ ì€í–‰ì— ì•ˆì „í•˜ê²Œ ë³´ê´€í–ˆìŠµë‹ˆë‹¤. (ë¶„ë‹¹ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ ì€í–‰ì—ì„œ {amt:,}â‚©ì„ ì¶œê¸ˆí–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ì´ ê°€ë™ë˜ì—ˆìŠµë‹ˆë‹¤! (3ì´ˆë‹¹ 5000â‚©)", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆ ì—”ì§„ì„ ì •ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            prompt = " ".join(cmd_parts[1:])
            res = client.models.generate_content(model="gemini-2.0-flash", contents=prompt)
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except Exception as e:
            emit('message', {'msg': f"âŒ ì—ëŸ¬: {str(e)}", 'type': 'system'})

    elif cmd == "!ëª…ë ¹ì–´":
        help_msg = "ğŸ“œ [ëª…ë ¹ì–´ ë¦¬ìŠ¤íŠ¸]\n!ì”ì•¡ - ë‚´ ìì‚° í™•ì¸\n!ì €ê¸ˆ [ì•¡ìˆ˜] - ì€í–‰ì— ì…ê¸ˆ\n!ì¶œê¸ˆ [ì•¡ìˆ˜] - í˜„ê¸ˆí™”\n!ë‡Œì ˆ - ë¬´í•œ ëˆ ë²Œê¸° ì‹œì‘\n!ë‡Œì ˆì¤‘ë‹¨ - ì¤‘ì§€\n!gemini [ì§ˆë¬¸] - AI ë‹µë³€\n!ëª…ë ¹ì–´ - ë„ì›€ë§"
        emit('message', {'msg': help_msg, 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ…
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=background_scheduler, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
import random
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í™˜ê²½] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "multiverse_empire.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {}

# Gemini AI í´ë¼ì´ì–¸íŠ¸ ì„¤ì •
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key:
        client = genai.Client(api_key=api_key)
except:
    print("Gemini SDKê°€ ì—†ê±°ë‚˜ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. !gemini ê¸°ëŠ¥ì€ ë¹„í™œì„±í™”ë©ë‹ˆë‹¤.")

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("""
            CREATE TABLE IF NOT EXISTS users (
                nickname TEXT PRIMARY KEY, 
                money INTEGER DEFAULT 1000, 
                bank_money INTEGER DEFAULT 0
            )
        """)
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ë° ë‰´ìŠ¤ ì‹œìŠ¤í…œ]
def background_scheduler():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤ ì‹¤í–‰
        with sqlite3.connect(DB_FILE) as conn:
            # 1. ì´ì ì§€ê¸‰ (1%)
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()
        
        # 2. ì‹¤ì‹œê°„ ê²½ì œ ë‰´ìŠ¤ ì´ë²¤íŠ¸
        news_list = [
            "ğŸ“¢ [ê²½ì œ] ì œêµ­ ì€í–‰ì˜ ê¸ˆë¦¬ê°€ ìƒìŠ¹ ì¡°ì§ì„ ë³´ì…ë‹ˆë‹¤!",
            "ğŸ“¢ [ì†Œì‹] ëŒ€ê·œëª¨ ë‡Œì ˆ ì—ë„ˆì§€ê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ì±„êµ´ íš¨ìœ¨ì´ ì¦ê°€í•©ë‹ˆë‹¤.",
            "ğŸ“¢ [ê³µì§€] í˜„ì¬ ìµœê³  ë¶€ìëŠ” 'ì´ˆì›”ì' ë“±ê¸‰ì„ ìœ ì§€í•˜ê³  ìˆìŠµë‹ˆë‹¤.",
            "ğŸ“¢ [ì´ë²¤íŠ¸] ì§€ê¸ˆ ì±„íŒ…ì„ ì…ë ¥í•˜ë©´ ë³´ë„ˆìŠ¤ í¬ì¸íŠ¸ê°€ ì§€ê¸‰ë  í™•ë¥ ì´ ë†’ìŠµë‹ˆë‹¤!"
        ]
        socketio.emit('message', {'msg': random.choice(news_list), 'type': 'system'}, room='main')

# --- [3. íŠ¹ìˆ˜ ê¸°ëŠ¥ ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 1
        reward = 5000
        update_money(nick, reward, bank=True)
        pattern = f"ğŸŒ€ [{nick}] ë‡Œì ˆ ë™ë ¥ ê°€ë™ ì¤‘... (+{reward}â‚© ì…ê¸ˆ)"
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"{pattern}\në¬´í•œ ë£¨í”„ íšŸìˆ˜: {m_count}íšŒì°¨", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3)

def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [4. ë¼ìš°íŒ… ë° ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸš€ {data['nickname']}ë‹˜ì´ ë©€í‹°ë²„ìŠ¤ ì„œë²„ì— ì ‘ì†í–ˆìŠµë‹ˆë‹¤!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ìˆ˜ìµ ê³µì‹]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ [ëŒ€ìš©ëŸ‰ ë°ì´í„° ë³€í™˜]\nê¸¸ì´: {msg_len}ì\në³´ìƒ: {reward}â‚© ì ë¦½ ì™„ë£Œ\nğŸ”— íŒŒì¼ ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ ì²˜ë¦¬]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        total = user['money'] + user['bank_money']
        res = f"ğŸ’° {nick}ë‹˜ì˜ ìì‚° ë³´ê³ ì„œ\n" \
              f"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" \
              f"ğŸ’µ í˜„ê¸ˆ: {user['money']:,}â‚©\n" \
              f"ğŸ¦ ì€í–‰: {user['bank_money']:,}â‚©\n" \
              f"ğŸ’³ ì´í•©: {total:,}â‚©\n" \
              f"ğŸ† ë“±ê¸‰: {'ì´ˆì›”ì' if total >= 10000000 else 'VIP' if total >= 1000000 else 'í‰ë¯¼'}"
        emit('message', {'msg': res, 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt:,}â‚©ì„ ì€í–‰ì— ì•ˆì „í•˜ê²Œ ë³´ê´€í–ˆìŠµë‹ˆë‹¤. (ë¶„ë‹¹ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ ì€í–‰ì—ì„œ {amt:,}â‚©ì„ ì¶œê¸ˆí–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ì´ ê°€ë™ë˜ì—ˆìŠµë‹ˆë‹¤! (3ì´ˆë‹¹ 5000â‚©)", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆ ì—”ì§„ì„ ì •ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            prompt = " ".join(cmd_parts[1:])
            res = client.models.generate_content(model="gemini-2.0-flash", contents=prompt)
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except Exception as e:
            emit('message', {'msg': f"âŒ ì—ëŸ¬: {str(e)}", 'type': 'system'})

    elif cmd == "!ëª…ë ¹ì–´":
        help_msg = "ğŸ“œ [ëª…ë ¹ì–´ ë¦¬ìŠ¤íŠ¸]\n!ì”ì•¡ - ë‚´ ìì‚° í™•ì¸\n!ì €ê¸ˆ [ì•¡ìˆ˜] - ì€í–‰ì— ì…ê¸ˆ\n!ì¶œê¸ˆ [ì•¡ìˆ˜] - í˜„ê¸ˆí™”\n!ë‡Œì ˆ - ë¬´í•œ ëˆ ë²Œê¸° ì‹œì‘\n!ë‡Œì ˆì¤‘ë‹¨ - ì¤‘ì§€\n!gemini [ì§ˆë¬¸] - AI ë‹µë³€\n!ëª…ë ¹ì–´ - ë„ì›€ë§"
        emit('message', {'msg': help_msg, 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ…
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=background_scheduler, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
import random
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í™˜ê²½] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "multiverse_empire.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {}

# Gemini AI í´ë¼ì´ì–¸íŠ¸ ì„¤ì •
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key:
        client = genai.Client(api_key=api_key)
except:
    print("Gemini SDKê°€ ì—†ê±°ë‚˜ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. !gemini ê¸°ëŠ¥ì€ ë¹„í™œì„±í™”ë©ë‹ˆë‹¤.")

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("""
            CREATE TABLE IF NOT EXISTS users (
                nickname TEXT PRIMARY KEY, 
                money INTEGER DEFAULT 1000, 
                bank_money INTEGER DEFAULT 0
            )
        """)
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ë° ë‰´ìŠ¤ ì‹œìŠ¤í…œ]
def background_scheduler():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤ ì‹¤í–‰
        with sqlite3.connect(DB_FILE) as conn:
            # 1. ì´ì ì§€ê¸‰ (1%)
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()
        
        # 2. ì‹¤ì‹œê°„ ê²½ì œ ë‰´ìŠ¤ ì´ë²¤íŠ¸
        news_list = [
            "ğŸ“¢ [ê²½ì œ] ì œêµ­ ì€í–‰ì˜ ê¸ˆë¦¬ê°€ ìƒìŠ¹ ì¡°ì§ì„ ë³´ì…ë‹ˆë‹¤!",
            "ğŸ“¢ [ì†Œì‹] ëŒ€ê·œëª¨ ë‡Œì ˆ ì—ë„ˆì§€ê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ì±„êµ´ íš¨ìœ¨ì´ ì¦ê°€í•©ë‹ˆë‹¤.",
            "ğŸ“¢ [ê³µì§€] í˜„ì¬ ìµœê³  ë¶€ìëŠ” 'ì´ˆì›”ì' ë“±ê¸‰ì„ ìœ ì§€í•˜ê³  ìˆìŠµë‹ˆë‹¤.",
            "ğŸ“¢ [ì´ë²¤íŠ¸] ì§€ê¸ˆ ì±„íŒ…ì„ ì…ë ¥í•˜ë©´ ë³´ë„ˆìŠ¤ í¬ì¸íŠ¸ê°€ ì§€ê¸‰ë  í™•ë¥ ì´ ë†’ìŠµë‹ˆë‹¤!"
        ]
        socketio.emit('message', {'msg': random.choice(news_list), 'type': 'system'}, room='main')

# --- [3. íŠ¹ìˆ˜ ê¸°ëŠ¥ ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 1
        reward = 5000
        update_money(nick, reward, bank=True)
        pattern = f"ğŸŒ€ [{nick}] ë‡Œì ˆ ë™ë ¥ ê°€ë™ ì¤‘... (+{reward}â‚© ì…ê¸ˆ)"
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"{pattern}\në¬´í•œ ë£¨í”„ íšŸìˆ˜: {m_count}íšŒì°¨", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3)

def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [4. ë¼ìš°íŒ… ë° ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸš€ {data['nickname']}ë‹˜ì´ ë©€í‹°ë²„ìŠ¤ ì„œë²„ì— ì ‘ì†í–ˆìŠµë‹ˆë‹¤!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ìˆ˜ìµ ê³µì‹]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ [ëŒ€ìš©ëŸ‰ ë°ì´í„° ë³€í™˜]\nê¸¸ì´: {msg_len}ì\në³´ìƒ: {reward}â‚© ì ë¦½ ì™„ë£Œ\nğŸ”— íŒŒì¼ ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ ì²˜ë¦¬]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        total = user['money'] + user['bank_money']
        res = f"ğŸ’° {nick}ë‹˜ì˜ ìì‚° ë³´ê³ ì„œ\n" \
              f"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" \
              f"ğŸ’µ í˜„ê¸ˆ: {user['money']:,}â‚©\n" \
              f"ğŸ¦ ì€í–‰: {user['bank_money']:,}â‚©\n" \
              f"ğŸ’³ ì´í•©: {total:,}â‚©\n" \
              f"ğŸ† ë“±ê¸‰: {'ì´ˆì›”ì' if total >= 10000000 else 'VIP' if total >= 1000000 else 'í‰ë¯¼'}"
        emit('message', {'msg': res, 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt:,}â‚©ì„ ì€í–‰ì— ì•ˆì „í•˜ê²Œ ë³´ê´€í–ˆìŠµë‹ˆë‹¤. (ë¶„ë‹¹ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ ì€í–‰ì—ì„œ {amt:,}â‚©ì„ ì¶œê¸ˆí–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ì´ ê°€ë™ë˜ì—ˆìŠµë‹ˆë‹¤! (3ì´ˆë‹¹ 5000â‚©)", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆ ì—”ì§„ì„ ì •ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            prompt = " ".join(cmd_parts[1:])
            res = client.models.generate_content(model="gemini-2.0-flash", contents=prompt)
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except Exception as e:
            emit('message', {'msg': f"âŒ ì—ëŸ¬: {str(e)}", 'type': 'system'})

    elif cmd == "!ëª…ë ¹ì–´":
        help_msg = "ğŸ“œ [ëª…ë ¹ì–´ ë¦¬ìŠ¤íŠ¸]\n!ì”ì•¡ - ë‚´ ìì‚° í™•ì¸\n!ì €ê¸ˆ [ì•¡ìˆ˜] - ì€í–‰ì— ì…ê¸ˆ\n!ì¶œê¸ˆ [ì•¡ìˆ˜] - í˜„ê¸ˆí™”\n!ë‡Œì ˆ - ë¬´í•œ ëˆ ë²Œê¸° ì‹œì‘\n!ë‡Œì ˆì¤‘ë‹¨ - ì¤‘ì§€\n!gemini [ì§ˆë¬¸] - AI ë‹µë³€\n!ëª…ë ¹ì–´ - ë„ì›€ë§"
        emit('message', {'msg': help_msg, 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ…
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=background_scheduler, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
import random
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í™˜ê²½] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "multiverse_empire.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {}

# Gemini AI í´ë¼ì´ì–¸íŠ¸ ì„¤ì •
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key:
        client = genai.Client(api_key=api_key)
except:
    print("Gemini SDKê°€ ì—†ê±°ë‚˜ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. !gemini ê¸°ëŠ¥ì€ ë¹„í™œì„±í™”ë©ë‹ˆë‹¤.")

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("""
            CREATE TABLE IF NOT EXISTS users (
                nickname TEXT PRIMARY KEY, 
                money INTEGER DEFAULT 1000, 
                bank_money INTEGER DEFAULT 0
            )
        """)
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ë° ë‰´ìŠ¤ ì‹œìŠ¤í…œ]
def background_scheduler():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤ ì‹¤í–‰
        with sqlite3.connect(DB_FILE) as conn:
            # 1. ì´ì ì§€ê¸‰ (1%)
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()
        
        # 2. ì‹¤ì‹œê°„ ê²½ì œ ë‰´ìŠ¤ ì´ë²¤íŠ¸
        news_list = [
            "ğŸ“¢ [ê²½ì œ] ì œêµ­ ì€í–‰ì˜ ê¸ˆë¦¬ê°€ ìƒìŠ¹ ì¡°ì§ì„ ë³´ì…ë‹ˆë‹¤!",
            "ğŸ“¢ [ì†Œì‹] ëŒ€ê·œëª¨ ë‡Œì ˆ ì—ë„ˆì§€ê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ì±„êµ´ íš¨ìœ¨ì´ ì¦ê°€í•©ë‹ˆë‹¤.",
            "ğŸ“¢ [ê³µì§€] í˜„ì¬ ìµœê³  ë¶€ìëŠ” 'ì´ˆì›”ì' ë“±ê¸‰ì„ ìœ ì§€í•˜ê³  ìˆìŠµë‹ˆë‹¤.",
            "ğŸ“¢ [ì´ë²¤íŠ¸] ì§€ê¸ˆ ì±„íŒ…ì„ ì…ë ¥í•˜ë©´ ë³´ë„ˆìŠ¤ í¬ì¸íŠ¸ê°€ ì§€ê¸‰ë  í™•ë¥ ì´ ë†’ìŠµë‹ˆë‹¤!"
        ]
        socketio.emit('message', {'msg': random.choice(news_list), 'type': 'system'}, room='main')

# --- [3. íŠ¹ìˆ˜ ê¸°ëŠ¥ ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 1
        reward = 5000
        update_money(nick, reward, bank=True)
        pattern = f"ğŸŒ€ [{nick}] ë‡Œì ˆ ë™ë ¥ ê°€ë™ ì¤‘... (+{reward}â‚© ì…ê¸ˆ)"
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"{pattern}\në¬´í•œ ë£¨í”„ íšŸìˆ˜: {m_count}íšŒì°¨", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3)

def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [4. ë¼ìš°íŒ… ë° ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸš€ {data['nickname']}ë‹˜ì´ ë©€í‹°ë²„ìŠ¤ ì„œë²„ì— ì ‘ì†í–ˆìŠµë‹ˆë‹¤!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ìˆ˜ìµ ê³µì‹]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ [ëŒ€ìš©ëŸ‰ ë°ì´í„° ë³€í™˜]\nê¸¸ì´: {msg_len}ì\në³´ìƒ: {reward}â‚© ì ë¦½ ì™„ë£Œ\nğŸ”— íŒŒì¼ ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ ì²˜ë¦¬]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        total = user['money'] + user['bank_money']
        res = f"ğŸ’° {nick}ë‹˜ì˜ ìì‚° ë³´ê³ ì„œ\n" \
              f"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" \
              f"ğŸ’µ í˜„ê¸ˆ: {user['money']:,}â‚©\n" \
              f"ğŸ¦ ì€í–‰: {user['bank_money']:,}â‚©\n" \
              f"ğŸ’³ ì´í•©: {total:,}â‚©\n" \
              f"ğŸ† ë“±ê¸‰: {'ì´ˆì›”ì' if total >= 10000000 else 'VIP' if total >= 1000000 else 'í‰ë¯¼'}"
        emit('message', {'msg': res, 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt:,}â‚©ì„ ì€í–‰ì— ì•ˆì „í•˜ê²Œ ë³´ê´€í–ˆìŠµë‹ˆë‹¤. (ë¶„ë‹¹ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ ì€í–‰ì—ì„œ {amt:,}â‚©ì„ ì¶œê¸ˆí–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ì´ ê°€ë™ë˜ì—ˆìŠµë‹ˆë‹¤! (3ì´ˆë‹¹ 5000â‚©)", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆ ì—”ì§„ì„ ì •ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            prompt = " ".join(cmd_parts[1:])
            res = client.models.generate_content(model="gemini-2.0-flash", contents=prompt)
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except Exception as e:
            emit('message', {'msg': f"âŒ ì—ëŸ¬: {str(e)}", 'type': 'system'})

    elif cmd == "!ëª…ë ¹ì–´":
        help_msg = "ğŸ“œ [ëª…ë ¹ì–´ ë¦¬ìŠ¤íŠ¸]\n!ì”ì•¡ - ë‚´ ìì‚° í™•ì¸\n!ì €ê¸ˆ [ì•¡ìˆ˜] - ì€í–‰ì— ì…ê¸ˆ\n!ì¶œê¸ˆ [ì•¡ìˆ˜] - í˜„ê¸ˆí™”\n!ë‡Œì ˆ - ë¬´í•œ ëˆ ë²Œê¸° ì‹œì‘\n!ë‡Œì ˆì¤‘ë‹¨ - ì¤‘ì§€\n!gemini [ì§ˆë¬¸] - AI ë‹µë³€\n!ëª…ë ¹ì–´ - ë„ì›€ë§"
        emit('message', {'msg': help_msg, 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ…
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=background_scheduler, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
import random
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í™˜ê²½] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "multiverse_empire.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {}

# Gemini AI í´ë¼ì´ì–¸íŠ¸ ì„¤ì •
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key:
        client = genai.Client(api_key=api_key)
except:
    print("Gemini SDKê°€ ì—†ê±°ë‚˜ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. !gemini ê¸°ëŠ¥ì€ ë¹„í™œì„±í™”ë©ë‹ˆë‹¤.")

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("""
            CREATE TABLE IF NOT EXISTS users (
                nickname TEXT PRIMARY KEY, 
                money INTEGER DEFAULT 1000, 
                bank_money INTEGER DEFAULT 0
            )
        """)
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ë° ë‰´ìŠ¤ ì‹œìŠ¤í…œ]
def background_scheduler():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤ ì‹¤í–‰
        with sqlite3.connect(DB_FILE) as conn:
            # 1. ì´ì ì§€ê¸‰ (1%)
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()
        
        # 2. ì‹¤ì‹œê°„ ê²½ì œ ë‰´ìŠ¤ ì´ë²¤íŠ¸
        news_list = [
            "ğŸ“¢ [ê²½ì œ] ì œêµ­ ì€í–‰ì˜ ê¸ˆë¦¬ê°€ ìƒìŠ¹ ì¡°ì§ì„ ë³´ì…ë‹ˆë‹¤!",
            "ğŸ“¢ [ì†Œì‹] ëŒ€ê·œëª¨ ë‡Œì ˆ ì—ë„ˆì§€ê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ì±„êµ´ íš¨ìœ¨ì´ ì¦ê°€í•©ë‹ˆë‹¤.",
            "ğŸ“¢ [ê³µì§€] í˜„ì¬ ìµœê³  ë¶€ìëŠ” 'ì´ˆì›”ì' ë“±ê¸‰ì„ ìœ ì§€í•˜ê³  ìˆìŠµë‹ˆë‹¤.",
            "ğŸ“¢ [ì´ë²¤íŠ¸] ì§€ê¸ˆ ì±„íŒ…ì„ ì…ë ¥í•˜ë©´ ë³´ë„ˆìŠ¤ í¬ì¸íŠ¸ê°€ ì§€ê¸‰ë  í™•ë¥ ì´ ë†’ìŠµë‹ˆë‹¤!"
        ]
        socketio.emit('message', {'msg': random.choice(news_list), 'type': 'system'}, room='main')

# --- [3. íŠ¹ìˆ˜ ê¸°ëŠ¥ ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 1
        reward = 5000
        update_money(nick, reward, bank=True)
        pattern = f"ğŸŒ€ [{nick}] ë‡Œì ˆ ë™ë ¥ ê°€ë™ ì¤‘... (+{reward}â‚© ì…ê¸ˆ)"
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"{pattern}\në¬´í•œ ë£¨í”„ íšŸìˆ˜: {m_count}íšŒì°¨", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3)

def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [4. ë¼ìš°íŒ… ë° ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸš€ {data['nickname']}ë‹˜ì´ ë©€í‹°ë²„ìŠ¤ ì„œë²„ì— ì ‘ì†í–ˆìŠµë‹ˆë‹¤!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ìˆ˜ìµ ê³µì‹]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ [ëŒ€ìš©ëŸ‰ ë°ì´í„° ë³€í™˜]\nê¸¸ì´: {msg_len}ì\në³´ìƒ: {reward}â‚© ì ë¦½ ì™„ë£Œ\nğŸ”— íŒŒì¼ ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ ì²˜ë¦¬]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        total = user['money'] + user['bank_money']
        res = f"ğŸ’° {nick}ë‹˜ì˜ ìì‚° ë³´ê³ ì„œ\n" \
              f"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" \
              f"ğŸ’µ í˜„ê¸ˆ: {user['money']:,}â‚©\n" \
              f"ğŸ¦ ì€í–‰: {user['bank_money']:,}â‚©\n" \
              f"ğŸ’³ ì´í•©: {total:,}â‚©\n" \
              f"ğŸ† ë“±ê¸‰: {'ì´ˆì›”ì' if total >= 10000000 else 'VIP' if total >= 1000000 else 'í‰ë¯¼'}"
        emit('message', {'msg': res, 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt:,}â‚©ì„ ì€í–‰ì— ì•ˆì „í•˜ê²Œ ë³´ê´€í–ˆìŠµë‹ˆë‹¤. (ë¶„ë‹¹ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ ì€í–‰ì—ì„œ {amt:,}â‚©ì„ ì¶œê¸ˆí–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ì´ ê°€ë™ë˜ì—ˆìŠµë‹ˆë‹¤! (3ì´ˆë‹¹ 5000â‚©)", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆ ì—”ì§„ì„ ì •ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            prompt = " ".join(cmd_parts[1:])
            res = client.models.generate_content(model="gemini-2.0-flash", contents=prompt)
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except Exception as e:
            emit('message', {'msg': f"âŒ ì—ëŸ¬: {str(e)}", 'type': 'system'})

    elif cmd == "!ëª…ë ¹ì–´":
        help_msg = "ğŸ“œ [ëª…ë ¹ì–´ ë¦¬ìŠ¤íŠ¸]\n!ì”ì•¡ - ë‚´ ìì‚° í™•ì¸\n!ì €ê¸ˆ [ì•¡ìˆ˜] - ì€í–‰ì— ì…ê¸ˆ\n!ì¶œê¸ˆ [ì•¡ìˆ˜] - í˜„ê¸ˆí™”\n!ë‡Œì ˆ - ë¬´í•œ ëˆ ë²Œê¸° ì‹œì‘\n!ë‡Œì ˆì¤‘ë‹¨ - ì¤‘ì§€\n!gemini [ì§ˆë¬¸] - AI ë‹µë³€\n!ëª…ë ¹ì–´ - ë„ì›€ë§"
        emit('message', {'msg': help_msg, 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ…
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=background_scheduler, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
import random
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í™˜ê²½] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "multiverse_empire.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {}

# Gemini AI í´ë¼ì´ì–¸íŠ¸ ì„¤ì •
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key:
        client = genai.Client(api_key=api_key)
except:
    print("Gemini SDKê°€ ì—†ê±°ë‚˜ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. !gemini ê¸°ëŠ¥ì€ ë¹„í™œì„±í™”ë©ë‹ˆë‹¤.")

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("""
            CREATE TABLE IF NOT EXISTS users (
                nickname TEXT PRIMARY KEY, 
                money INTEGER DEFAULT 1000, 
                bank_money INTEGER DEFAULT 0
            )
        """)
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ë° ë‰´ìŠ¤ ì‹œìŠ¤í…œ]
def background_scheduler():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤ ì‹¤í–‰
        with sqlite3.connect(DB_FILE) as conn:
            # 1. ì´ì ì§€ê¸‰ (1%)
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()
        
        # 2. ì‹¤ì‹œê°„ ê²½ì œ ë‰´ìŠ¤ ì´ë²¤íŠ¸
        news_list = [
            "ğŸ“¢ [ê²½ì œ] ì œêµ­ ì€í–‰ì˜ ê¸ˆë¦¬ê°€ ìƒìŠ¹ ì¡°ì§ì„ ë³´ì…ë‹ˆë‹¤!",
            "ğŸ“¢ [ì†Œì‹] ëŒ€ê·œëª¨ ë‡Œì ˆ ì—ë„ˆì§€ê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ì±„êµ´ íš¨ìœ¨ì´ ì¦ê°€í•©ë‹ˆë‹¤.",
            "ğŸ“¢ [ê³µì§€] í˜„ì¬ ìµœê³  ë¶€ìëŠ” 'ì´ˆì›”ì' ë“±ê¸‰ì„ ìœ ì§€í•˜ê³  ìˆìŠµë‹ˆë‹¤.",
            "ğŸ“¢ [ì´ë²¤íŠ¸] ì§€ê¸ˆ ì±„íŒ…ì„ ì…ë ¥í•˜ë©´ ë³´ë„ˆìŠ¤ í¬ì¸íŠ¸ê°€ ì§€ê¸‰ë  í™•ë¥ ì´ ë†’ìŠµë‹ˆë‹¤!"
        ]
        socketio.emit('message', {'msg': random.choice(news_list), 'type': 'system'}, room='main')

# --- [3. íŠ¹ìˆ˜ ê¸°ëŠ¥ ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 1
        reward = 5000
        update_money(nick, reward, bank=True)
        pattern = f"ğŸŒ€ [{nick}] ë‡Œì ˆ ë™ë ¥ ê°€ë™ ì¤‘... (+{reward}â‚© ì…ê¸ˆ)"
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"{pattern}\në¬´í•œ ë£¨í”„ íšŸìˆ˜: {m_count}íšŒì°¨", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3)

def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [4. ë¼ìš°íŒ… ë° ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸš€ {data['nickname']}ë‹˜ì´ ë©€í‹°ë²„ìŠ¤ ì„œë²„ì— ì ‘ì†í–ˆìŠµë‹ˆë‹¤!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ìˆ˜ìµ ê³µì‹]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ [ëŒ€ìš©ëŸ‰ ë°ì´í„° ë³€í™˜]\nê¸¸ì´: {msg_len}ì\në³´ìƒ: {reward}â‚© ì ë¦½ ì™„ë£Œ\nğŸ”— íŒŒì¼ ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ ì²˜ë¦¬]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        total = user['money'] + user['bank_money']
        res = f"ğŸ’° {nick}ë‹˜ì˜ ìì‚° ë³´ê³ ì„œ\n" \
              f"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" \
              f"ğŸ’µ í˜„ê¸ˆ: {user['money']:,}â‚©\n" \
              f"ğŸ¦ ì€í–‰: {user['bank_money']:,}â‚©\n" \
              f"ğŸ’³ ì´í•©: {total:,}â‚©\n" \
              f"ğŸ† ë“±ê¸‰: {'ì´ˆì›”ì' if total >= 10000000 else 'VIP' if total >= 1000000 else 'í‰ë¯¼'}"
        emit('message', {'msg': res, 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt:,}â‚©ì„ ì€í–‰ì— ì•ˆì „í•˜ê²Œ ë³´ê´€í–ˆìŠµë‹ˆë‹¤. (ë¶„ë‹¹ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ ì€í–‰ì—ì„œ {amt:,}â‚©ì„ ì¶œê¸ˆí–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ì´ ê°€ë™ë˜ì—ˆìŠµë‹ˆë‹¤! (3ì´ˆë‹¹ 5000â‚©)", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆ ì—”ì§„ì„ ì •ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            prompt = " ".join(cmd_parts[1:])
            res = client.models.generate_content(model="gemini-2.0-flash", contents=prompt)
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except Exception as e:
            emit('message', {'msg': f"âŒ ì—ëŸ¬: {str(e)}", 'type': 'system'})

    elif cmd == "!ëª…ë ¹ì–´":
        help_msg = "ğŸ“œ [ëª…ë ¹ì–´ ë¦¬ìŠ¤íŠ¸]\n!ì”ì•¡ - ë‚´ ìì‚° í™•ì¸\n!ì €ê¸ˆ [ì•¡ìˆ˜] - ì€í–‰ì— ì…ê¸ˆ\n!ì¶œê¸ˆ [ì•¡ìˆ˜] - í˜„ê¸ˆí™”\n!ë‡Œì ˆ - ë¬´í•œ ëˆ ë²Œê¸° ì‹œì‘\n!ë‡Œì ˆì¤‘ë‹¨ - ì¤‘ì§€\n!gemini [ì§ˆë¬¸] - AI ë‹µë³€\n!ëª…ë ¹ì–´ - ë„ì›€ë§"
        emit('message', {'msg': help_msg, 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ…
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=background_scheduler, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
import random
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í™˜ê²½] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "multiverse_empire.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {}

# Gemini AI í´ë¼ì´ì–¸íŠ¸ ì„¤ì •
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key:
        client = genai.Client(api_key=api_key)
except:
    print("Gemini SDKê°€ ì—†ê±°ë‚˜ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. !gemini ê¸°ëŠ¥ì€ ë¹„í™œì„±í™”ë©ë‹ˆë‹¤.")

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("""
            CREATE TABLE IF NOT EXISTS users (
                nickname TEXT PRIMARY KEY, 
                money INTEGER DEFAULT 1000, 
                bank_money INTEGER DEFAULT 0
            )
        """)
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ë° ë‰´ìŠ¤ ì‹œìŠ¤í…œ]
def background_scheduler():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤ ì‹¤í–‰
        with sqlite3.connect(DB_FILE) as conn:
            # 1. ì´ì ì§€ê¸‰ (1%)
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()
        
        # 2. ì‹¤ì‹œê°„ ê²½ì œ ë‰´ìŠ¤ ì´ë²¤íŠ¸
        news_list = [
            "ğŸ“¢ [ê²½ì œ] ì œêµ­ ì€í–‰ì˜ ê¸ˆë¦¬ê°€ ìƒìŠ¹ ì¡°ì§ì„ ë³´ì…ë‹ˆë‹¤!",
            "ğŸ“¢ [ì†Œì‹] ëŒ€ê·œëª¨ ë‡Œì ˆ ì—ë„ˆì§€ê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ì±„êµ´ íš¨ìœ¨ì´ ì¦ê°€í•©ë‹ˆë‹¤.",
            "ğŸ“¢ [ê³µì§€] í˜„ì¬ ìµœê³  ë¶€ìëŠ” 'ì´ˆì›”ì' ë“±ê¸‰ì„ ìœ ì§€í•˜ê³  ìˆìŠµë‹ˆë‹¤.",
            "ğŸ“¢ [ì´ë²¤íŠ¸] ì§€ê¸ˆ ì±„íŒ…ì„ ì…ë ¥í•˜ë©´ ë³´ë„ˆìŠ¤ í¬ì¸íŠ¸ê°€ ì§€ê¸‰ë  í™•ë¥ ì´ ë†’ìŠµë‹ˆë‹¤!"
        ]
        socketio.emit('message', {'msg': random.choice(news_list), 'type': 'system'}, room='main')

# --- [3. íŠ¹ìˆ˜ ê¸°ëŠ¥ ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 1
        reward = 5000
        update_money(nick, reward, bank=True)
        pattern = f"ğŸŒ€ [{nick}] ë‡Œì ˆ ë™ë ¥ ê°€ë™ ì¤‘... (+{reward}â‚© ì…ê¸ˆ)"
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"{pattern}\në¬´í•œ ë£¨í”„ íšŸìˆ˜: {m_count}íšŒì°¨", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3)

def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [4. ë¼ìš°íŒ… ë° ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸš€ {data['nickname']}ë‹˜ì´ ë©€í‹°ë²„ìŠ¤ ì„œë²„ì— ì ‘ì†í–ˆìŠµë‹ˆë‹¤!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ìˆ˜ìµ ê³µì‹]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ [ëŒ€ìš©ëŸ‰ ë°ì´í„° ë³€í™˜]\nê¸¸ì´: {msg_len}ì\në³´ìƒ: {reward}â‚© ì ë¦½ ì™„ë£Œ\nğŸ”— íŒŒì¼ ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ ì²˜ë¦¬]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        total = user['money'] + user['bank_money']
        res = f"ğŸ’° {nick}ë‹˜ì˜ ìì‚° ë³´ê³ ì„œ\n" \
              f"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" \
              f"ğŸ’µ í˜„ê¸ˆ: {user['money']:,}â‚©\n" \
              f"ğŸ¦ ì€í–‰: {user['bank_money']:,}â‚©\n" \
              f"ğŸ’³ ì´í•©: {total:,}â‚©\n" \
              f"ğŸ† ë“±ê¸‰: {'ì´ˆì›”ì' if total >= 10000000 else 'VIP' if total >= 1000000 else 'í‰ë¯¼'}"
        emit('message', {'msg': res, 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt:,}â‚©ì„ ì€í–‰ì— ì•ˆì „í•˜ê²Œ ë³´ê´€í–ˆìŠµë‹ˆë‹¤. (ë¶„ë‹¹ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ ì€í–‰ì—ì„œ {amt:,}â‚©ì„ ì¶œê¸ˆí–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ì´ ê°€ë™ë˜ì—ˆìŠµë‹ˆë‹¤! (3ì´ˆë‹¹ 5000â‚©)", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆ ì—”ì§„ì„ ì •ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            prompt = " ".join(cmd_parts[1:])
            res = client.models.generate_content(model="gemini-2.0-flash", contents=prompt)
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except Exception as e:
            emit('message', {'msg': f"âŒ ì—ëŸ¬: {str(e)}", 'type': 'system'})

    elif cmd == "!ëª…ë ¹ì–´":
        help_msg = "ğŸ“œ [ëª…ë ¹ì–´ ë¦¬ìŠ¤íŠ¸]\n!ì”ì•¡ - ë‚´ ìì‚° í™•ì¸\n!ì €ê¸ˆ [ì•¡ìˆ˜] - ì€í–‰ì— ì…ê¸ˆ\n!ì¶œê¸ˆ [ì•¡ìˆ˜] - í˜„ê¸ˆí™”\n!ë‡Œì ˆ - ë¬´í•œ ëˆ ë²Œê¸° ì‹œì‘\n!ë‡Œì ˆì¤‘ë‹¨ - ì¤‘ì§€\n!gemini [ì§ˆë¬¸] - AI ë‹µë³€\n!ëª…ë ¹ì–´ - ë„ì›€ë§"
        emit('message', {'msg': help_msg, 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ…
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=background_scheduler, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
import random
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í™˜ê²½] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "multiverse_empire.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {}

# Gemini AI í´ë¼ì´ì–¸íŠ¸ ì„¤ì •
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key:
        client = genai.Client(api_key=api_key)
except:
    print("Gemini SDKê°€ ì—†ê±°ë‚˜ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. !gemini ê¸°ëŠ¥ì€ ë¹„í™œì„±í™”ë©ë‹ˆë‹¤.")

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("""
            CREATE TABLE IF NOT EXISTS users (
                nickname TEXT PRIMARY KEY, 
                money INTEGER DEFAULT 1000, 
                bank_money INTEGER DEFAULT 0
            )
        """)
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ë° ë‰´ìŠ¤ ì‹œìŠ¤í…œ]
def background_scheduler():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤ ì‹¤í–‰
        with sqlite3.connect(DB_FILE) as conn:
            # 1. ì´ì ì§€ê¸‰ (1%)
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()
        
        # 2. ì‹¤ì‹œê°„ ê²½ì œ ë‰´ìŠ¤ ì´ë²¤íŠ¸
        news_list = [
            "ğŸ“¢ [ê²½ì œ] ì œêµ­ ì€í–‰ì˜ ê¸ˆë¦¬ê°€ ìƒìŠ¹ ì¡°ì§ì„ ë³´ì…ë‹ˆë‹¤!",
            "ğŸ“¢ [ì†Œì‹] ëŒ€ê·œëª¨ ë‡Œì ˆ ì—ë„ˆì§€ê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ì±„êµ´ íš¨ìœ¨ì´ ì¦ê°€í•©ë‹ˆë‹¤.",
            "ğŸ“¢ [ê³µì§€] í˜„ì¬ ìµœê³  ë¶€ìëŠ” 'ì´ˆì›”ì' ë“±ê¸‰ì„ ìœ ì§€í•˜ê³  ìˆìŠµë‹ˆë‹¤.",
            "ğŸ“¢ [ì´ë²¤íŠ¸] ì§€ê¸ˆ ì±„íŒ…ì„ ì…ë ¥í•˜ë©´ ë³´ë„ˆìŠ¤ í¬ì¸íŠ¸ê°€ ì§€ê¸‰ë  í™•ë¥ ì´ ë†’ìŠµë‹ˆë‹¤!"
        ]
        socketio.emit('message', {'msg': random.choice(news_list), 'type': 'system'}, room='main')

# --- [3. íŠ¹ìˆ˜ ê¸°ëŠ¥ ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 1
        reward = 5000
        update_money(nick, reward, bank=True)
        pattern = f"ğŸŒ€ [{nick}] ë‡Œì ˆ ë™ë ¥ ê°€ë™ ì¤‘... (+{reward}â‚© ì…ê¸ˆ)"
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"{pattern}\në¬´í•œ ë£¨í”„ íšŸìˆ˜: {m_count}íšŒì°¨", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3)

def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [4. ë¼ìš°íŒ… ë° ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸš€ {data['nickname']}ë‹˜ì´ ë©€í‹°ë²„ìŠ¤ ì„œë²„ì— ì ‘ì†í–ˆìŠµë‹ˆë‹¤!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ìˆ˜ìµ ê³µì‹]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ [ëŒ€ìš©ëŸ‰ ë°ì´í„° ë³€í™˜]\nê¸¸ì´: {msg_len}ì\në³´ìƒ: {reward}â‚© ì ë¦½ ì™„ë£Œ\nğŸ”— íŒŒì¼ ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ ì²˜ë¦¬]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        total = user['money'] + user['bank_money']
        res = f"ğŸ’° {nick}ë‹˜ì˜ ìì‚° ë³´ê³ ì„œ\n" \
              f"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" \
              f"ğŸ’µ í˜„ê¸ˆ: {user['money']:,}â‚©\n" \
              f"ğŸ¦ ì€í–‰: {user['bank_money']:,}â‚©\n" \
              f"ğŸ’³ ì´í•©: {total:,}â‚©\n" \
              f"ğŸ† ë“±ê¸‰: {'ì´ˆì›”ì' if total >= 10000000 else 'VIP' if total >= 1000000 else 'í‰ë¯¼'}"
        emit('message', {'msg': res, 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt:,}â‚©ì„ ì€í–‰ì— ì•ˆì „í•˜ê²Œ ë³´ê´€í–ˆìŠµë‹ˆë‹¤. (ë¶„ë‹¹ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ ì€í–‰ì—ì„œ {amt:,}â‚©ì„ ì¶œê¸ˆí–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ì´ ê°€ë™ë˜ì—ˆìŠµë‹ˆë‹¤! (3ì´ˆë‹¹ 5000â‚©)", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆ ì—”ì§„ì„ ì •ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            prompt = " ".join(cmd_parts[1:])
            res = client.models.generate_content(model="gemini-2.0-flash", contents=prompt)
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except Exception as e:
            emit('message', {'msg': f"âŒ ì—ëŸ¬: {str(e)}", 'type': 'system'})

    elif cmd == "!ëª…ë ¹ì–´":
        help_msg = "ğŸ“œ [ëª…ë ¹ì–´ ë¦¬ìŠ¤íŠ¸]\n!ì”ì•¡ - ë‚´ ìì‚° í™•ì¸\n!ì €ê¸ˆ [ì•¡ìˆ˜] - ì€í–‰ì— ì…ê¸ˆ\n!ì¶œê¸ˆ [ì•¡ìˆ˜] - í˜„ê¸ˆí™”\n!ë‡Œì ˆ - ë¬´í•œ ëˆ ë²Œê¸° ì‹œì‘\n!ë‡Œì ˆì¤‘ë‹¨ - ì¤‘ì§€\n!gemini [ì§ˆë¬¸] - AI ë‹µë³€\n!ëª…ë ¹ì–´ - ë„ì›€ë§"
        emit('message', {'msg': help_msg, 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ…
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=background_scheduler, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
import random
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í™˜ê²½] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "multiverse_empire.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {}

# Gemini AI í´ë¼ì´ì–¸íŠ¸ ì„¤ì •
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key:
        client = genai.Client(api_key=api_key)
except:
    print("Gemini SDKê°€ ì—†ê±°ë‚˜ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. !gemini ê¸°ëŠ¥ì€ ë¹„í™œì„±í™”ë©ë‹ˆë‹¤.")

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("""
            CREATE TABLE IF NOT EXISTS users (
                nickname TEXT PRIMARY KEY, 
                money INTEGER DEFAULT 1000, 
                bank_money INTEGER DEFAULT 0
            )
        """)
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ë° ë‰´ìŠ¤ ì‹œìŠ¤í…œ]
def background_scheduler():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤ ì‹¤í–‰
        with sqlite3.connect(DB_FILE) as conn:
            # 1. ì´ì ì§€ê¸‰ (1%)
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()
        
        # 2. ì‹¤ì‹œê°„ ê²½ì œ ë‰´ìŠ¤ ì´ë²¤íŠ¸
        news_list = [
            "ğŸ“¢ [ê²½ì œ] ì œêµ­ ì€í–‰ì˜ ê¸ˆë¦¬ê°€ ìƒìŠ¹ ì¡°ì§ì„ ë³´ì…ë‹ˆë‹¤!",
            "ğŸ“¢ [ì†Œì‹] ëŒ€ê·œëª¨ ë‡Œì ˆ ì—ë„ˆì§€ê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ì±„êµ´ íš¨ìœ¨ì´ ì¦ê°€í•©ë‹ˆë‹¤.",
            "ğŸ“¢ [ê³µì§€] í˜„ì¬ ìµœê³  ë¶€ìëŠ” 'ì´ˆì›”ì' ë“±ê¸‰ì„ ìœ ì§€í•˜ê³  ìˆìŠµë‹ˆë‹¤.",
            "ğŸ“¢ [ì´ë²¤íŠ¸] ì§€ê¸ˆ ì±„íŒ…ì„ ì…ë ¥í•˜ë©´ ë³´ë„ˆìŠ¤ í¬ì¸íŠ¸ê°€ ì§€ê¸‰ë  í™•ë¥ ì´ ë†’ìŠµë‹ˆë‹¤!"
        ]
        socketio.emit('message', {'msg': random.choice(news_list), 'type': 'system'}, room='main')

# --- [3. íŠ¹ìˆ˜ ê¸°ëŠ¥ ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 1
        reward = 5000
        update_money(nick, reward, bank=True)
        pattern = f"ğŸŒ€ [{nick}] ë‡Œì ˆ ë™ë ¥ ê°€ë™ ì¤‘... (+{reward}â‚© ì…ê¸ˆ)"
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"{pattern}\në¬´í•œ ë£¨í”„ íšŸìˆ˜: {m_count}íšŒì°¨", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3)

def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [4. ë¼ìš°íŒ… ë° ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸš€ {data['nickname']}ë‹˜ì´ ë©€í‹°ë²„ìŠ¤ ì„œë²„ì— ì ‘ì†í–ˆìŠµë‹ˆë‹¤!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ìˆ˜ìµ ê³µì‹]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ [ëŒ€ìš©ëŸ‰ ë°ì´í„° ë³€í™˜]\nê¸¸ì´: {msg_len}ì\në³´ìƒ: {reward}â‚© ì ë¦½ ì™„ë£Œ\nğŸ”— íŒŒì¼ ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ ì²˜ë¦¬]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        total = user['money'] + user['bank_money']
        res = f"ğŸ’° {nick}ë‹˜ì˜ ìì‚° ë³´ê³ ì„œ\n" \
              f"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" \
              f"ğŸ’µ í˜„ê¸ˆ: {user['money']:,}â‚©\n" \
              f"ğŸ¦ ì€í–‰: {user['bank_money']:,}â‚©\n" \
              f"ğŸ’³ ì´í•©: {total:,}â‚©\n" \
              f"ğŸ† ë“±ê¸‰: {'ì´ˆì›”ì' if total >= 10000000 else 'VIP' if total >= 1000000 else 'í‰ë¯¼'}"
        emit('message', {'msg': res, 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt:,}â‚©ì„ ì€í–‰ì— ì•ˆì „í•˜ê²Œ ë³´ê´€í–ˆìŠµë‹ˆë‹¤. (ë¶„ë‹¹ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ ì€í–‰ì—ì„œ {amt:,}â‚©ì„ ì¶œê¸ˆí–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ì´ ê°€ë™ë˜ì—ˆìŠµë‹ˆë‹¤! (3ì´ˆë‹¹ 5000â‚©)", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆ ì—”ì§„ì„ ì •ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            prompt = " ".join(cmd_parts[1:])
            res = client.models.generate_content(model="gemini-2.0-flash", contents=prompt)
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except Exception as e:
            emit('message', {'msg': f"âŒ ì—ëŸ¬: {str(e)}", 'type': 'system'})

    elif cmd == "!ëª…ë ¹ì–´":
        help_msg = "ğŸ“œ [ëª…ë ¹ì–´ ë¦¬ìŠ¤íŠ¸]\n!ì”ì•¡ - ë‚´ ìì‚° í™•ì¸\n!ì €ê¸ˆ [ì•¡ìˆ˜] - ì€í–‰ì— ì…ê¸ˆ\n!ì¶œê¸ˆ [ì•¡ìˆ˜] - í˜„ê¸ˆí™”\n!ë‡Œì ˆ - ë¬´í•œ ëˆ ë²Œê¸° ì‹œì‘\n!ë‡Œì ˆì¤‘ë‹¨ - ì¤‘ì§€\n!gemini [ì§ˆë¬¸] - AI ë‹µë³€\n!ëª…ë ¹ì–´ - ë„ì›€ë§"
        emit('message', {'msg': help_msg, 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ…
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=background_scheduler, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
import random
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í™˜ê²½] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "multiverse_empire.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {}

# Gemini AI í´ë¼ì´ì–¸íŠ¸ ì„¤ì •
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key:
        client = genai.Client(api_key=api_key)
except:
    print("Gemini SDKê°€ ì—†ê±°ë‚˜ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. !gemini ê¸°ëŠ¥ì€ ë¹„í™œì„±í™”ë©ë‹ˆë‹¤.")

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("""
            CREATE TABLE IF NOT EXISTS users (
                nickname TEXT PRIMARY KEY, 
                money INTEGER DEFAULT 1000, 
                bank_money INTEGER DEFAULT 0
            )
        """)
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ë° ë‰´ìŠ¤ ì‹œìŠ¤í…œ]
def background_scheduler():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤ ì‹¤í–‰
        with sqlite3.connect(DB_FILE) as conn:
            # 1. ì´ì ì§€ê¸‰ (1%)
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()
        
        # 2. ì‹¤ì‹œê°„ ê²½ì œ ë‰´ìŠ¤ ì´ë²¤íŠ¸
        news_list = [
            "ğŸ“¢ [ê²½ì œ] ì œêµ­ ì€í–‰ì˜ ê¸ˆë¦¬ê°€ ìƒìŠ¹ ì¡°ì§ì„ ë³´ì…ë‹ˆë‹¤!",
            "ğŸ“¢ [ì†Œì‹] ëŒ€ê·œëª¨ ë‡Œì ˆ ì—ë„ˆì§€ê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ì±„êµ´ íš¨ìœ¨ì´ ì¦ê°€í•©ë‹ˆë‹¤.",
            "ğŸ“¢ [ê³µì§€] í˜„ì¬ ìµœê³  ë¶€ìëŠ” 'ì´ˆì›”ì' ë“±ê¸‰ì„ ìœ ì§€í•˜ê³  ìˆìŠµë‹ˆë‹¤.",
            "ğŸ“¢ [ì´ë²¤íŠ¸] ì§€ê¸ˆ ì±„íŒ…ì„ ì…ë ¥í•˜ë©´ ë³´ë„ˆìŠ¤ í¬ì¸íŠ¸ê°€ ì§€ê¸‰ë  í™•ë¥ ì´ ë†’ìŠµë‹ˆë‹¤!"
        ]
        socketio.emit('message', {'msg': random.choice(news_list), 'type': 'system'}, room='main')

# --- [3. íŠ¹ìˆ˜ ê¸°ëŠ¥ ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 1
        reward = 5000
        update_money(nick, reward, bank=True)
        pattern = f"ğŸŒ€ [{nick}] ë‡Œì ˆ ë™ë ¥ ê°€ë™ ì¤‘... (+{reward}â‚© ì…ê¸ˆ)"
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"{pattern}\në¬´í•œ ë£¨í”„ íšŸìˆ˜: {m_count}íšŒì°¨", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3)

def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [4. ë¼ìš°íŒ… ë° ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸš€ {data['nickname']}ë‹˜ì´ ë©€í‹°ë²„ìŠ¤ ì„œë²„ì— ì ‘ì†í–ˆìŠµë‹ˆë‹¤!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ìˆ˜ìµ ê³µì‹]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ [ëŒ€ìš©ëŸ‰ ë°ì´í„° ë³€í™˜]\nê¸¸ì´: {msg_len}ì\në³´ìƒ: {reward}â‚© ì ë¦½ ì™„ë£Œ\nğŸ”— íŒŒì¼ ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ ì²˜ë¦¬]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        total = user['money'] + user['bank_money']
        res = f"ğŸ’° {nick}ë‹˜ì˜ ìì‚° ë³´ê³ ì„œ\n" \
              f"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" \
              f"ğŸ’µ í˜„ê¸ˆ: {user['money']:,}â‚©\n" \
              f"ğŸ¦ ì€í–‰: {user['bank_money']:,}â‚©\n" \
              f"ğŸ’³ ì´í•©: {total:,}â‚©\n" \
              f"ğŸ† ë“±ê¸‰: {'ì´ˆì›”ì' if total >= 10000000 else 'VIP' if total >= 1000000 else 'í‰ë¯¼'}"
        emit('message', {'msg': res, 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt:,}â‚©ì„ ì€í–‰ì— ì•ˆì „í•˜ê²Œ ë³´ê´€í–ˆìŠµë‹ˆë‹¤. (ë¶„ë‹¹ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ ì€í–‰ì—ì„œ {amt:,}â‚©ì„ ì¶œê¸ˆí–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ì´ ê°€ë™ë˜ì—ˆìŠµë‹ˆë‹¤! (3ì´ˆë‹¹ 5000â‚©)", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆ ì—”ì§„ì„ ì •ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            prompt = " ".join(cmd_parts[1:])
            res = client.models.generate_content(model="gemini-2.0-flash", contents=prompt)
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except Exception as e:
            emit('message', {'msg': f"âŒ ì—ëŸ¬: {str(e)}", 'type': 'system'})

    elif cmd == "!ëª…ë ¹ì–´":
        help_msg = "ğŸ“œ [ëª…ë ¹ì–´ ë¦¬ìŠ¤íŠ¸]\n!ì”ì•¡ - ë‚´ ìì‚° í™•ì¸\n!ì €ê¸ˆ [ì•¡ìˆ˜] - ì€í–‰ì— ì…ê¸ˆ\n!ì¶œê¸ˆ [ì•¡ìˆ˜] - í˜„ê¸ˆí™”\n!ë‡Œì ˆ - ë¬´í•œ ëˆ ë²Œê¸° ì‹œì‘\n!ë‡Œì ˆì¤‘ë‹¨ - ì¤‘ì§€\n!gemini [ì§ˆë¬¸] - AI ë‹µë³€\n!ëª…ë ¹ì–´ - ë„ì›€ë§"
        emit('message', {'msg': help_msg, 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ…
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=background_scheduler, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
import random
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í™˜ê²½] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "multiverse_empire.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {}

# Gemini AI í´ë¼ì´ì–¸íŠ¸ ì„¤ì •
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key:
        client = genai.Client(api_key=api_key)
except:
    print("Gemini SDKê°€ ì—†ê±°ë‚˜ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. !gemini ê¸°ëŠ¥ì€ ë¹„í™œì„±í™”ë©ë‹ˆë‹¤.")

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("""
            CREATE TABLE IF NOT EXISTS users (
                nickname TEXT PRIMARY KEY, 
                money INTEGER DEFAULT 1000, 
                bank_money INTEGER DEFAULT 0
            )
        """)
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ë° ë‰´ìŠ¤ ì‹œìŠ¤í…œ]
def background_scheduler():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤ ì‹¤í–‰
        with sqlite3.connect(DB_FILE) as conn:
            # 1. ì´ì ì§€ê¸‰ (1%)
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()
        
        # 2. ì‹¤ì‹œê°„ ê²½ì œ ë‰´ìŠ¤ ì´ë²¤íŠ¸
        news_list = [
            "ğŸ“¢ [ê²½ì œ] ì œêµ­ ì€í–‰ì˜ ê¸ˆë¦¬ê°€ ìƒìŠ¹ ì¡°ì§ì„ ë³´ì…ë‹ˆë‹¤!",
            "ğŸ“¢ [ì†Œì‹] ëŒ€ê·œëª¨ ë‡Œì ˆ ì—ë„ˆì§€ê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ì±„êµ´ íš¨ìœ¨ì´ ì¦ê°€í•©ë‹ˆë‹¤.",
            "ğŸ“¢ [ê³µì§€] í˜„ì¬ ìµœê³  ë¶€ìëŠ” 'ì´ˆì›”ì' ë“±ê¸‰ì„ ìœ ì§€í•˜ê³  ìˆìŠµë‹ˆë‹¤.",
            "ğŸ“¢ [ì´ë²¤íŠ¸] ì§€ê¸ˆ ì±„íŒ…ì„ ì…ë ¥í•˜ë©´ ë³´ë„ˆìŠ¤ í¬ì¸íŠ¸ê°€ ì§€ê¸‰ë  í™•ë¥ ì´ ë†’ìŠµë‹ˆë‹¤!"
        ]
        socketio.emit('message', {'msg': random.choice(news_list), 'type': 'system'}, room='main')

# --- [3. íŠ¹ìˆ˜ ê¸°ëŠ¥ ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 1
        reward = 5000
        update_money(nick, reward, bank=True)
        pattern = f"ğŸŒ€ [{nick}] ë‡Œì ˆ ë™ë ¥ ê°€ë™ ì¤‘... (+{reward}â‚© ì…ê¸ˆ)"
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"{pattern}\në¬´í•œ ë£¨í”„ íšŸìˆ˜: {m_count}íšŒì°¨", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3)

def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [4. ë¼ìš°íŒ… ë° ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸš€ {data['nickname']}ë‹˜ì´ ë©€í‹°ë²„ìŠ¤ ì„œë²„ì— ì ‘ì†í–ˆìŠµë‹ˆë‹¤!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ìˆ˜ìµ ê³µì‹]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ [ëŒ€ìš©ëŸ‰ ë°ì´í„° ë³€í™˜]\nê¸¸ì´: {msg_len}ì\në³´ìƒ: {reward}â‚© ì ë¦½ ì™„ë£Œ\nğŸ”— íŒŒì¼ ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ ì²˜ë¦¬]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        total = user['money'] + user['bank_money']
        res = f"ğŸ’° {nick}ë‹˜ì˜ ìì‚° ë³´ê³ ì„œ\n" \
              f"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" \
              f"ğŸ’µ í˜„ê¸ˆ: {user['money']:,}â‚©\n" \
              f"ğŸ¦ ì€í–‰: {user['bank_money']:,}â‚©\n" \
              f"ğŸ’³ ì´í•©: {total:,}â‚©\n" \
              f"ğŸ† ë“±ê¸‰: {'ì´ˆì›”ì' if total >= 10000000 else 'VIP' if total >= 1000000 else 'í‰ë¯¼'}"
        emit('message', {'msg': res, 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt:,}â‚©ì„ ì€í–‰ì— ì•ˆì „í•˜ê²Œ ë³´ê´€í–ˆìŠµë‹ˆë‹¤. (ë¶„ë‹¹ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ ì€í–‰ì—ì„œ {amt:,}â‚©ì„ ì¶œê¸ˆí–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ì´ ê°€ë™ë˜ì—ˆìŠµë‹ˆë‹¤! (3ì´ˆë‹¹ 5000â‚©)", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆ ì—”ì§„ì„ ì •ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            prompt = " ".join(cmd_parts[1:])
            res = client.models.generate_content(model="gemini-2.0-flash", contents=prompt)
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except Exception as e:
            emit('message', {'msg': f"âŒ ì—ëŸ¬: {str(e)}", 'type': 'system'})

    elif cmd == "!ëª…ë ¹ì–´":
        help_msg = "ğŸ“œ [ëª…ë ¹ì–´ ë¦¬ìŠ¤íŠ¸]\n!ì”ì•¡ - ë‚´ ìì‚° í™•ì¸\n!ì €ê¸ˆ [ì•¡ìˆ˜] - ì€í–‰ì— ì…ê¸ˆ\n!ì¶œê¸ˆ [ì•¡ìˆ˜] - í˜„ê¸ˆí™”\n!ë‡Œì ˆ - ë¬´í•œ ëˆ ë²Œê¸° ì‹œì‘\n!ë‡Œì ˆì¤‘ë‹¨ - ì¤‘ì§€\n!gemini [ì§ˆë¬¸] - AI ë‹µë³€\n!ëª…ë ¹ì–´ - ë„ì›€ë§"
        emit('message', {'msg': help_msg, 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ…
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=background_scheduler, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
import random
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í™˜ê²½] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "multiverse_empire.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {}

# Gemini AI í´ë¼ì´ì–¸íŠ¸ ì„¤ì •
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key:
        client = genai.Client(api_key=api_key)
except:
    print("Gemini SDKê°€ ì—†ê±°ë‚˜ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. !gemini ê¸°ëŠ¥ì€ ë¹„í™œì„±í™”ë©ë‹ˆë‹¤.")

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("""
            CREATE TABLE IF NOT EXISTS users (
                nickname TEXT PRIMARY KEY, 
                money INTEGER DEFAULT 1000, 
                bank_money INTEGER DEFAULT 0
            )
        """)
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ë° ë‰´ìŠ¤ ì‹œìŠ¤í…œ]
def background_scheduler():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤ ì‹¤í–‰
        with sqlite3.connect(DB_FILE) as conn:
            # 1. ì´ì ì§€ê¸‰ (1%)
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()
        
        # 2. ì‹¤ì‹œê°„ ê²½ì œ ë‰´ìŠ¤ ì´ë²¤íŠ¸
        news_list = [
            "ğŸ“¢ [ê²½ì œ] ì œêµ­ ì€í–‰ì˜ ê¸ˆë¦¬ê°€ ìƒìŠ¹ ì¡°ì§ì„ ë³´ì…ë‹ˆë‹¤!",
            "ğŸ“¢ [ì†Œì‹] ëŒ€ê·œëª¨ ë‡Œì ˆ ì—ë„ˆì§€ê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ì±„êµ´ íš¨ìœ¨ì´ ì¦ê°€í•©ë‹ˆë‹¤.",
            "ğŸ“¢ [ê³µì§€] í˜„ì¬ ìµœê³  ë¶€ìëŠ” 'ì´ˆì›”ì' ë“±ê¸‰ì„ ìœ ì§€í•˜ê³  ìˆìŠµë‹ˆë‹¤.",
            "ğŸ“¢ [ì´ë²¤íŠ¸] ì§€ê¸ˆ ì±„íŒ…ì„ ì…ë ¥í•˜ë©´ ë³´ë„ˆìŠ¤ í¬ì¸íŠ¸ê°€ ì§€ê¸‰ë  í™•ë¥ ì´ ë†’ìŠµë‹ˆë‹¤!"
        ]
        socketio.emit('message', {'msg': random.choice(news_list), 'type': 'system'}, room='main')

# --- [3. íŠ¹ìˆ˜ ê¸°ëŠ¥ ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 1
        reward = 5000
        update_money(nick, reward, bank=True)
        pattern = f"ğŸŒ€ [{nick}] ë‡Œì ˆ ë™ë ¥ ê°€ë™ ì¤‘... (+{reward}â‚© ì…ê¸ˆ)"
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"{pattern}\në¬´í•œ ë£¨í”„ íšŸìˆ˜: {m_count}íšŒì°¨", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3)

def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [4. ë¼ìš°íŒ… ë° ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸš€ {data['nickname']}ë‹˜ì´ ë©€í‹°ë²„ìŠ¤ ì„œë²„ì— ì ‘ì†í–ˆìŠµë‹ˆë‹¤!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ìˆ˜ìµ ê³µì‹]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ [ëŒ€ìš©ëŸ‰ ë°ì´í„° ë³€í™˜]\nê¸¸ì´: {msg_len}ì\në³´ìƒ: {reward}â‚© ì ë¦½ ì™„ë£Œ\nğŸ”— íŒŒì¼ ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ ì²˜ë¦¬]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        total = user['money'] + user['bank_money']
        res = f"ğŸ’° {nick}ë‹˜ì˜ ìì‚° ë³´ê³ ì„œ\n" \
              f"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" \
              f"ğŸ’µ í˜„ê¸ˆ: {user['money']:,}â‚©\n" \
              f"ğŸ¦ ì€í–‰: {user['bank_money']:,}â‚©\n" \
              f"ğŸ’³ ì´í•©: {total:,}â‚©\n" \
              f"ğŸ† ë“±ê¸‰: {'ì´ˆì›”ì' if total >= 10000000 else 'VIP' if total >= 1000000 else 'í‰ë¯¼'}"
        emit('message', {'msg': res, 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt:,}â‚©ì„ ì€í–‰ì— ì•ˆì „í•˜ê²Œ ë³´ê´€í–ˆìŠµë‹ˆë‹¤. (ë¶„ë‹¹ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ ì€í–‰ì—ì„œ {amt:,}â‚©ì„ ì¶œê¸ˆí–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ì´ ê°€ë™ë˜ì—ˆìŠµë‹ˆë‹¤! (3ì´ˆë‹¹ 5000â‚©)", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆ ì—”ì§„ì„ ì •ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            prompt = " ".join(cmd_parts[1:])
            res = client.models.generate_content(model="gemini-2.0-flash", contents=prompt)
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except Exception as e:
            emit('message', {'msg': f"âŒ ì—ëŸ¬: {str(e)}", 'type': 'system'})

    elif cmd == "!ëª…ë ¹ì–´":
        help_msg = "ğŸ“œ [ëª…ë ¹ì–´ ë¦¬ìŠ¤íŠ¸]\n!ì”ì•¡ - ë‚´ ìì‚° í™•ì¸\n!ì €ê¸ˆ [ì•¡ìˆ˜] - ì€í–‰ì— ì…ê¸ˆ\n!ì¶œê¸ˆ [ì•¡ìˆ˜] - í˜„ê¸ˆí™”\n!ë‡Œì ˆ - ë¬´í•œ ëˆ ë²Œê¸° ì‹œì‘\n!ë‡Œì ˆì¤‘ë‹¨ - ì¤‘ì§€\n!gemini [ì§ˆë¬¸] - AI ë‹µë³€\n!ëª…ë ¹ì–´ - ë„ì›€ë§"
        emit('message', {'msg': help_msg, 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ…
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=background_scheduler, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
import random
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í™˜ê²½] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "multiverse_empire.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {}

# Gemini AI í´ë¼ì´ì–¸íŠ¸ ì„¤ì •
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key:
        client = genai.Client(api_key=api_key)
except:
    print("Gemini SDKê°€ ì—†ê±°ë‚˜ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. !gemini ê¸°ëŠ¥ì€ ë¹„í™œì„±í™”ë©ë‹ˆë‹¤.")

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("""
            CREATE TABLE IF NOT EXISTS users (
                nickname TEXT PRIMARY KEY, 
                money INTEGER DEFAULT 1000, 
                bank_money INTEGER DEFAULT 0
            )
        """)
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ë° ë‰´ìŠ¤ ì‹œìŠ¤í…œ]
def background_scheduler():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤ ì‹¤í–‰
        with sqlite3.connect(DB_FILE) as conn:
            # 1. ì´ì ì§€ê¸‰ (1%)
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()
        
        # 2. ì‹¤ì‹œê°„ ê²½ì œ ë‰´ìŠ¤ ì´ë²¤íŠ¸
        news_list = [
            "ğŸ“¢ [ê²½ì œ] ì œêµ­ ì€í–‰ì˜ ê¸ˆë¦¬ê°€ ìƒìŠ¹ ì¡°ì§ì„ ë³´ì…ë‹ˆë‹¤!",
            "ğŸ“¢ [ì†Œì‹] ëŒ€ê·œëª¨ ë‡Œì ˆ ì—ë„ˆì§€ê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ì±„êµ´ íš¨ìœ¨ì´ ì¦ê°€í•©ë‹ˆë‹¤.",
            "ğŸ“¢ [ê³µì§€] í˜„ì¬ ìµœê³  ë¶€ìëŠ” 'ì´ˆì›”ì' ë“±ê¸‰ì„ ìœ ì§€í•˜ê³  ìˆìŠµë‹ˆë‹¤.",
            "ğŸ“¢ [ì´ë²¤íŠ¸] ì§€ê¸ˆ ì±„íŒ…ì„ ì…ë ¥í•˜ë©´ ë³´ë„ˆìŠ¤ í¬ì¸íŠ¸ê°€ ì§€ê¸‰ë  í™•ë¥ ì´ ë†’ìŠµë‹ˆë‹¤!"
        ]
        socketio.emit('message', {'msg': random.choice(news_list), 'type': 'system'}, room='main')

# --- [3. íŠ¹ìˆ˜ ê¸°ëŠ¥ ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 1
        reward = 5000
        update_money(nick, reward, bank=True)
        pattern = f"ğŸŒ€ [{nick}] ë‡Œì ˆ ë™ë ¥ ê°€ë™ ì¤‘... (+{reward}â‚© ì…ê¸ˆ)"
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"{pattern}\në¬´í•œ ë£¨í”„ íšŸìˆ˜: {m_count}íšŒì°¨", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3)

def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [4. ë¼ìš°íŒ… ë° ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸš€ {data['nickname']}ë‹˜ì´ ë©€í‹°ë²„ìŠ¤ ì„œë²„ì— ì ‘ì†í–ˆìŠµë‹ˆë‹¤!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ìˆ˜ìµ ê³µì‹]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ [ëŒ€ìš©ëŸ‰ ë°ì´í„° ë³€í™˜]\nê¸¸ì´: {msg_len}ì\në³´ìƒ: {reward}â‚© ì ë¦½ ì™„ë£Œ\nğŸ”— íŒŒì¼ ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ ì²˜ë¦¬]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        total = user['money'] + user['bank_money']
        res = f"ğŸ’° {nick}ë‹˜ì˜ ìì‚° ë³´ê³ ì„œ\n" \
              f"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" \
              f"ğŸ’µ í˜„ê¸ˆ: {user['money']:,}â‚©\n" \
              f"ğŸ¦ ì€í–‰: {user['bank_money']:,}â‚©\n" \
              f"ğŸ’³ ì´í•©: {total:,}â‚©\n" \
              f"ğŸ† ë“±ê¸‰: {'ì´ˆì›”ì' if total >= 10000000 else 'VIP' if total >= 1000000 else 'í‰ë¯¼'}"
        emit('message', {'msg': res, 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt:,}â‚©ì„ ì€í–‰ì— ì•ˆì „í•˜ê²Œ ë³´ê´€í–ˆìŠµë‹ˆë‹¤. (ë¶„ë‹¹ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ ì€í–‰ì—ì„œ {amt:,}â‚©ì„ ì¶œê¸ˆí–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ì´ ê°€ë™ë˜ì—ˆìŠµë‹ˆë‹¤! (3ì´ˆë‹¹ 5000â‚©)", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆ ì—”ì§„ì„ ì •ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            prompt = " ".join(cmd_parts[1:])
            res = client.models.generate_content(model="gemini-2.0-flash", contents=prompt)
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except Exception as e:
            emit('message', {'msg': f"âŒ ì—ëŸ¬: {str(e)}", 'type': 'system'})

    elif cmd == "!ëª…ë ¹ì–´":
        help_msg = "ğŸ“œ [ëª…ë ¹ì–´ ë¦¬ìŠ¤íŠ¸]\n!ì”ì•¡ - ë‚´ ìì‚° í™•ì¸\n!ì €ê¸ˆ [ì•¡ìˆ˜] - ì€í–‰ì— ì…ê¸ˆ\n!ì¶œê¸ˆ [ì•¡ìˆ˜] - í˜„ê¸ˆí™”\n!ë‡Œì ˆ - ë¬´í•œ ëˆ ë²Œê¸° ì‹œì‘\n!ë‡Œì ˆì¤‘ë‹¨ - ì¤‘ì§€\n!gemini [ì§ˆë¬¸] - AI ë‹µë³€\n!ëª…ë ¹ì–´ - ë„ì›€ë§"
        emit('message', {'msg': help_msg, 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ…
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=background_scheduler, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
import random
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í™˜ê²½] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "multiverse_empire.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {}

# Gemini AI í´ë¼ì´ì–¸íŠ¸ ì„¤ì •
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key:
        client = genai.Client(api_key=api_key)
except:
    print("Gemini SDKê°€ ì—†ê±°ë‚˜ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. !gemini ê¸°ëŠ¥ì€ ë¹„í™œì„±í™”ë©ë‹ˆë‹¤.")

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("""
            CREATE TABLE IF NOT EXISTS users (
                nickname TEXT PRIMARY KEY, 
                money INTEGER DEFAULT 1000, 
                bank_money INTEGER DEFAULT 0
            )
        """)
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ë° ë‰´ìŠ¤ ì‹œìŠ¤í…œ]
def background_scheduler():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤ ì‹¤í–‰
        with sqlite3.connect(DB_FILE) as conn:
            # 1. ì´ì ì§€ê¸‰ (1%)
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()
        
        # 2. ì‹¤ì‹œê°„ ê²½ì œ ë‰´ìŠ¤ ì´ë²¤íŠ¸
        news_list = [
            "ğŸ“¢ [ê²½ì œ] ì œêµ­ ì€í–‰ì˜ ê¸ˆë¦¬ê°€ ìƒìŠ¹ ì¡°ì§ì„ ë³´ì…ë‹ˆë‹¤!",
            "ğŸ“¢ [ì†Œì‹] ëŒ€ê·œëª¨ ë‡Œì ˆ ì—ë„ˆì§€ê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ì±„êµ´ íš¨ìœ¨ì´ ì¦ê°€í•©ë‹ˆë‹¤.",
            "ğŸ“¢ [ê³µì§€] í˜„ì¬ ìµœê³  ë¶€ìëŠ” 'ì´ˆì›”ì' ë“±ê¸‰ì„ ìœ ì§€í•˜ê³  ìˆìŠµë‹ˆë‹¤.",
            "ğŸ“¢ [ì´ë²¤íŠ¸] ì§€ê¸ˆ ì±„íŒ…ì„ ì…ë ¥í•˜ë©´ ë³´ë„ˆìŠ¤ í¬ì¸íŠ¸ê°€ ì§€ê¸‰ë  í™•ë¥ ì´ ë†’ìŠµë‹ˆë‹¤!"
        ]
        socketio.emit('message', {'msg': random.choice(news_list), 'type': 'system'}, room='main')

# --- [3. íŠ¹ìˆ˜ ê¸°ëŠ¥ ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 1
        reward = 5000
        update_money(nick, reward, bank=True)
        pattern = f"ğŸŒ€ [{nick}] ë‡Œì ˆ ë™ë ¥ ê°€ë™ ì¤‘... (+{reward}â‚© ì…ê¸ˆ)"
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"{pattern}\në¬´í•œ ë£¨í”„ íšŸìˆ˜: {m_count}íšŒì°¨", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3)

def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [4. ë¼ìš°íŒ… ë° ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸš€ {data['nickname']}ë‹˜ì´ ë©€í‹°ë²„ìŠ¤ ì„œë²„ì— ì ‘ì†í–ˆìŠµë‹ˆë‹¤!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ìˆ˜ìµ ê³µì‹]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ [ëŒ€ìš©ëŸ‰ ë°ì´í„° ë³€í™˜]\nê¸¸ì´: {msg_len}ì\në³´ìƒ: {reward}â‚© ì ë¦½ ì™„ë£Œ\nğŸ”— íŒŒì¼ ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ ì²˜ë¦¬]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        total = user['money'] + user['bank_money']
        res = f"ğŸ’° {nick}ë‹˜ì˜ ìì‚° ë³´ê³ ì„œ\n" \
              f"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" \
              f"ğŸ’µ í˜„ê¸ˆ: {user['money']:,}â‚©\n" \
              f"ğŸ¦ ì€í–‰: {user['bank_money']:,}â‚©\n" \
              f"ğŸ’³ ì´í•©: {total:,}â‚©\n" \
              f"ğŸ† ë“±ê¸‰: {'ì´ˆì›”ì' if total >= 10000000 else 'VIP' if total >= 1000000 else 'í‰ë¯¼'}"
        emit('message', {'msg': res, 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt:,}â‚©ì„ ì€í–‰ì— ì•ˆì „í•˜ê²Œ ë³´ê´€í–ˆìŠµë‹ˆë‹¤. (ë¶„ë‹¹ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ ì€í–‰ì—ì„œ {amt:,}â‚©ì„ ì¶œê¸ˆí–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ì´ ê°€ë™ë˜ì—ˆìŠµë‹ˆë‹¤! (3ì´ˆë‹¹ 5000â‚©)", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆ ì—”ì§„ì„ ì •ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            prompt = " ".join(cmd_parts[1:])
            res = client.models.generate_content(model="gemini-2.0-flash", contents=prompt)
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except Exception as e:
            emit('message', {'msg': f"âŒ ì—ëŸ¬: {str(e)}", 'type': 'system'})

    elif cmd == "!ëª…ë ¹ì–´":
        help_msg = "ğŸ“œ [ëª…ë ¹ì–´ ë¦¬ìŠ¤íŠ¸]\n!ì”ì•¡ - ë‚´ ìì‚° í™•ì¸\n!ì €ê¸ˆ [ì•¡ìˆ˜] - ì€í–‰ì— ì…ê¸ˆ\n!ì¶œê¸ˆ [ì•¡ìˆ˜] - í˜„ê¸ˆí™”\n!ë‡Œì ˆ - ë¬´í•œ ëˆ ë²Œê¸° ì‹œì‘\n!ë‡Œì ˆì¤‘ë‹¨ - ì¤‘ì§€\n!gemini [ì§ˆë¬¸] - AI ë‹µë³€\n!ëª…ë ¹ì–´ - ë„ì›€ë§"
        emit('message', {'msg': help_msg, 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ…
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=background_scheduler, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
import random
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í™˜ê²½] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "multiverse_empire.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {}

# Gemini AI í´ë¼ì´ì–¸íŠ¸ ì„¤ì •
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key:
        client = genai.Client(api_key=api_key)
except:
    print("Gemini SDKê°€ ì—†ê±°ë‚˜ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. !gemini ê¸°ëŠ¥ì€ ë¹„í™œì„±í™”ë©ë‹ˆë‹¤.")

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("""
            CREATE TABLE IF NOT EXISTS users (
                nickname TEXT PRIMARY KEY, 
                money INTEGER DEFAULT 1000, 
                bank_money INTEGER DEFAULT 0
            )
        """)
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ë° ë‰´ìŠ¤ ì‹œìŠ¤í…œ]
def background_scheduler():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤ ì‹¤í–‰
        with sqlite3.connect(DB_FILE) as conn:
            # 1. ì´ì ì§€ê¸‰ (1%)
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()
        
        # 2. ì‹¤ì‹œê°„ ê²½ì œ ë‰´ìŠ¤ ì´ë²¤íŠ¸
        news_list = [
            "ğŸ“¢ [ê²½ì œ] ì œêµ­ ì€í–‰ì˜ ê¸ˆë¦¬ê°€ ìƒìŠ¹ ì¡°ì§ì„ ë³´ì…ë‹ˆë‹¤!",
            "ğŸ“¢ [ì†Œì‹] ëŒ€ê·œëª¨ ë‡Œì ˆ ì—ë„ˆì§€ê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ì±„êµ´ íš¨ìœ¨ì´ ì¦ê°€í•©ë‹ˆë‹¤.",
            "ğŸ“¢ [ê³µì§€] í˜„ì¬ ìµœê³  ë¶€ìëŠ” 'ì´ˆì›”ì' ë“±ê¸‰ì„ ìœ ì§€í•˜ê³  ìˆìŠµë‹ˆë‹¤.",
            "ğŸ“¢ [ì´ë²¤íŠ¸] ì§€ê¸ˆ ì±„íŒ…ì„ ì…ë ¥í•˜ë©´ ë³´ë„ˆìŠ¤ í¬ì¸íŠ¸ê°€ ì§€ê¸‰ë  í™•ë¥ ì´ ë†’ìŠµë‹ˆë‹¤!"
        ]
        socketio.emit('message', {'msg': random.choice(news_list), 'type': 'system'}, room='main')

# --- [3. íŠ¹ìˆ˜ ê¸°ëŠ¥ ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 1
        reward = 5000
        update_money(nick, reward, bank=True)
        pattern = f"ğŸŒ€ [{nick}] ë‡Œì ˆ ë™ë ¥ ê°€ë™ ì¤‘... (+{reward}â‚© ì…ê¸ˆ)"
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"{pattern}\në¬´í•œ ë£¨í”„ íšŸìˆ˜: {m_count}íšŒì°¨", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3)

def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [4. ë¼ìš°íŒ… ë° ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸš€ {data['nickname']}ë‹˜ì´ ë©€í‹°ë²„ìŠ¤ ì„œë²„ì— ì ‘ì†í–ˆìŠµë‹ˆë‹¤!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ìˆ˜ìµ ê³µì‹]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ [ëŒ€ìš©ëŸ‰ ë°ì´í„° ë³€í™˜]\nê¸¸ì´: {msg_len}ì\në³´ìƒ: {reward}â‚© ì ë¦½ ì™„ë£Œ\nğŸ”— íŒŒì¼ ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ ì²˜ë¦¬]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        total = user['money'] + user['bank_money']
        res = f"ğŸ’° {nick}ë‹˜ì˜ ìì‚° ë³´ê³ ì„œ\n" \
              f"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" \
              f"ğŸ’µ í˜„ê¸ˆ: {user['money']:,}â‚©\n" \
              f"ğŸ¦ ì€í–‰: {user['bank_money']:,}â‚©\n" \
              f"ğŸ’³ ì´í•©: {total:,}â‚©\n" \
              f"ğŸ† ë“±ê¸‰: {'ì´ˆì›”ì' if total >= 10000000 else 'VIP' if total >= 1000000 else 'í‰ë¯¼'}"
        emit('message', {'msg': res, 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt:,}â‚©ì„ ì€í–‰ì— ì•ˆì „í•˜ê²Œ ë³´ê´€í–ˆìŠµë‹ˆë‹¤. (ë¶„ë‹¹ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ ì€í–‰ì—ì„œ {amt:,}â‚©ì„ ì¶œê¸ˆí–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ì´ ê°€ë™ë˜ì—ˆìŠµë‹ˆë‹¤! (3ì´ˆë‹¹ 5000â‚©)", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆ ì—”ì§„ì„ ì •ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            prompt = " ".join(cmd_parts[1:])
            res = client.models.generate_content(model="gemini-2.0-flash", contents=prompt)
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except Exception as e:
            emit('message', {'msg': f"âŒ ì—ëŸ¬: {str(e)}", 'type': 'system'})

    elif cmd == "!ëª…ë ¹ì–´":
        help_msg = "ğŸ“œ [ëª…ë ¹ì–´ ë¦¬ìŠ¤íŠ¸]\n!ì”ì•¡ - ë‚´ ìì‚° í™•ì¸\n!ì €ê¸ˆ [ì•¡ìˆ˜] - ì€í–‰ì— ì…ê¸ˆ\n!ì¶œê¸ˆ [ì•¡ìˆ˜] - í˜„ê¸ˆí™”\n!ë‡Œì ˆ - ë¬´í•œ ëˆ ë²Œê¸° ì‹œì‘\n!ë‡Œì ˆì¤‘ë‹¨ - ì¤‘ì§€\n!gemini [ì§ˆë¬¸] - AI ë‹µë³€\n!ëª…ë ¹ì–´ - ë„ì›€ë§"
        emit('message', {'msg': help_msg, 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ…
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=background_scheduler, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
import random
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í™˜ê²½] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "multiverse_empire.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {}

# Gemini AI í´ë¼ì´ì–¸íŠ¸ ì„¤ì •
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key:
        client = genai.Client(api_key=api_key)
except:
    print("Gemini SDKê°€ ì—†ê±°ë‚˜ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. !gemini ê¸°ëŠ¥ì€ ë¹„í™œì„±í™”ë©ë‹ˆë‹¤.")

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("""
            CREATE TABLE IF NOT EXISTS users (
                nickname TEXT PRIMARY KEY, 
                money INTEGER DEFAULT 1000, 
                bank_money INTEGER DEFAULT 0
            )
        """)
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ë° ë‰´ìŠ¤ ì‹œìŠ¤í…œ]
def background_scheduler():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤ ì‹¤í–‰
        with sqlite3.connect(DB_FILE) as conn:
            # 1. ì´ì ì§€ê¸‰ (1%)
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()
        
        # 2. ì‹¤ì‹œê°„ ê²½ì œ ë‰´ìŠ¤ ì´ë²¤íŠ¸
        news_list = [
            "ğŸ“¢ [ê²½ì œ] ì œêµ­ ì€í–‰ì˜ ê¸ˆë¦¬ê°€ ìƒìŠ¹ ì¡°ì§ì„ ë³´ì…ë‹ˆë‹¤!",
            "ğŸ“¢ [ì†Œì‹] ëŒ€ê·œëª¨ ë‡Œì ˆ ì—ë„ˆì§€ê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ì±„êµ´ íš¨ìœ¨ì´ ì¦ê°€í•©ë‹ˆë‹¤.",
            "ğŸ“¢ [ê³µì§€] í˜„ì¬ ìµœê³  ë¶€ìëŠ” 'ì´ˆì›”ì' ë“±ê¸‰ì„ ìœ ì§€í•˜ê³  ìˆìŠµë‹ˆë‹¤.",
            "ğŸ“¢ [ì´ë²¤íŠ¸] ì§€ê¸ˆ ì±„íŒ…ì„ ì…ë ¥í•˜ë©´ ë³´ë„ˆìŠ¤ í¬ì¸íŠ¸ê°€ ì§€ê¸‰ë  í™•ë¥ ì´ ë†’ìŠµë‹ˆë‹¤!"
        ]
        socketio.emit('message', {'msg': random.choice(news_list), 'type': 'system'}, room='main')

# --- [3. íŠ¹ìˆ˜ ê¸°ëŠ¥ ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 1
        reward = 5000
        update_money(nick, reward, bank=True)
        pattern = f"ğŸŒ€ [{nick}] ë‡Œì ˆ ë™ë ¥ ê°€ë™ ì¤‘... (+{reward}â‚© ì…ê¸ˆ)"
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"{pattern}\në¬´í•œ ë£¨í”„ íšŸìˆ˜: {m_count}íšŒì°¨", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3)

def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [4. ë¼ìš°íŒ… ë° ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸš€ {data['nickname']}ë‹˜ì´ ë©€í‹°ë²„ìŠ¤ ì„œë²„ì— ì ‘ì†í–ˆìŠµë‹ˆë‹¤!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ìˆ˜ìµ ê³µì‹]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ [ëŒ€ìš©ëŸ‰ ë°ì´í„° ë³€í™˜]\nê¸¸ì´: {msg_len}ì\në³´ìƒ: {reward}â‚© ì ë¦½ ì™„ë£Œ\nğŸ”— íŒŒì¼ ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ ì²˜ë¦¬]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        total = user['money'] + user['bank_money']
        res = f"ğŸ’° {nick}ë‹˜ì˜ ìì‚° ë³´ê³ ì„œ\n" \
              f"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" \
              f"ğŸ’µ í˜„ê¸ˆ: {user['money']:,}â‚©\n" \
              f"ğŸ¦ ì€í–‰: {user['bank_money']:,}â‚©\n" \
              f"ğŸ’³ ì´í•©: {total:,}â‚©\n" \
              f"ğŸ† ë“±ê¸‰: {'ì´ˆì›”ì' if total >= 10000000 else 'VIP' if total >= 1000000 else 'í‰ë¯¼'}"
        emit('message', {'msg': res, 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt:,}â‚©ì„ ì€í–‰ì— ì•ˆì „í•˜ê²Œ ë³´ê´€í–ˆìŠµë‹ˆë‹¤. (ë¶„ë‹¹ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ ì€í–‰ì—ì„œ {amt:,}â‚©ì„ ì¶œê¸ˆí–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ì´ ê°€ë™ë˜ì—ˆìŠµë‹ˆë‹¤! (3ì´ˆë‹¹ 5000â‚©)", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆ ì—”ì§„ì„ ì •ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            prompt = " ".join(cmd_parts[1:])
            res = client.models.generate_content(model="gemini-2.0-flash", contents=prompt)
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except Exception as e:
            emit('message', {'msg': f"âŒ ì—ëŸ¬: {str(e)}", 'type': 'system'})

    elif cmd == "!ëª…ë ¹ì–´":
        help_msg = "ğŸ“œ [ëª…ë ¹ì–´ ë¦¬ìŠ¤íŠ¸]\n!ì”ì•¡ - ë‚´ ìì‚° í™•ì¸\n!ì €ê¸ˆ [ì•¡ìˆ˜] - ì€í–‰ì— ì…ê¸ˆ\n!ì¶œê¸ˆ [ì•¡ìˆ˜] - í˜„ê¸ˆí™”\n!ë‡Œì ˆ - ë¬´í•œ ëˆ ë²Œê¸° ì‹œì‘\n!ë‡Œì ˆì¤‘ë‹¨ - ì¤‘ì§€\n!gemini [ì§ˆë¬¸] - AI ë‹µë³€\n!ëª…ë ¹ì–´ - ë„ì›€ë§"
        emit('message', {'msg': help_msg, 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ…
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=background_scheduler, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
import random
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í™˜ê²½] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "multiverse_empire.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {}

# Gemini AI í´ë¼ì´ì–¸íŠ¸ ì„¤ì •
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key:
        client = genai.Client(api_key=api_key)
except:
    print("Gemini SDKê°€ ì—†ê±°ë‚˜ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. !gemini ê¸°ëŠ¥ì€ ë¹„í™œì„±í™”ë©ë‹ˆë‹¤.")

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("""
            CREATE TABLE IF NOT EXISTS users (
                nickname TEXT PRIMARY KEY, 
                money INTEGER DEFAULT 1000, 
                bank_money INTEGER DEFAULT 0
            )
        """)
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ë° ë‰´ìŠ¤ ì‹œìŠ¤í…œ]
def background_scheduler():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤ ì‹¤í–‰
        with sqlite3.connect(DB_FILE) as conn:
            # 1. ì´ì ì§€ê¸‰ (1%)
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()
        
        # 2. ì‹¤ì‹œê°„ ê²½ì œ ë‰´ìŠ¤ ì´ë²¤íŠ¸
        news_list = [
            "ğŸ“¢ [ê²½ì œ] ì œêµ­ ì€í–‰ì˜ ê¸ˆë¦¬ê°€ ìƒìŠ¹ ì¡°ì§ì„ ë³´ì…ë‹ˆë‹¤!",
            "ğŸ“¢ [ì†Œì‹] ëŒ€ê·œëª¨ ë‡Œì ˆ ì—ë„ˆì§€ê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ì±„êµ´ íš¨ìœ¨ì´ ì¦ê°€í•©ë‹ˆë‹¤.",
            "ğŸ“¢ [ê³µì§€] í˜„ì¬ ìµœê³  ë¶€ìëŠ” 'ì´ˆì›”ì' ë“±ê¸‰ì„ ìœ ì§€í•˜ê³  ìˆìŠµë‹ˆë‹¤.",
            "ğŸ“¢ [ì´ë²¤íŠ¸] ì§€ê¸ˆ ì±„íŒ…ì„ ì…ë ¥í•˜ë©´ ë³´ë„ˆìŠ¤ í¬ì¸íŠ¸ê°€ ì§€ê¸‰ë  í™•ë¥ ì´ ë†’ìŠµë‹ˆë‹¤!"
        ]
        socketio.emit('message', {'msg': random.choice(news_list), 'type': 'system'}, room='main')

# --- [3. íŠ¹ìˆ˜ ê¸°ëŠ¥ ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 1
        reward = 5000
        update_money(nick, reward, bank=True)
        pattern = f"ğŸŒ€ [{nick}] ë‡Œì ˆ ë™ë ¥ ê°€ë™ ì¤‘... (+{reward}â‚© ì…ê¸ˆ)"
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"{pattern}\në¬´í•œ ë£¨í”„ íšŸìˆ˜: {m_count}íšŒì°¨", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3)

def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [4. ë¼ìš°íŒ… ë° ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸš€ {data['nickname']}ë‹˜ì´ ë©€í‹°ë²„ìŠ¤ ì„œë²„ì— ì ‘ì†í–ˆìŠµë‹ˆë‹¤!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ìˆ˜ìµ ê³µì‹]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ [ëŒ€ìš©ëŸ‰ ë°ì´í„° ë³€í™˜]\nê¸¸ì´: {msg_len}ì\në³´ìƒ: {reward}â‚© ì ë¦½ ì™„ë£Œ\nğŸ”— íŒŒì¼ ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ ì²˜ë¦¬]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        total = user['money'] + user['bank_money']
        res = f"ğŸ’° {nick}ë‹˜ì˜ ìì‚° ë³´ê³ ì„œ\n" \
              f"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" \
              f"ğŸ’µ í˜„ê¸ˆ: {user['money']:,}â‚©\n" \
              f"ğŸ¦ ì€í–‰: {user['bank_money']:,}â‚©\n" \
              f"ğŸ’³ ì´í•©: {total:,}â‚©\n" \
              f"ğŸ† ë“±ê¸‰: {'ì´ˆì›”ì' if total >= 10000000 else 'VIP' if total >= 1000000 else 'í‰ë¯¼'}"
        emit('message', {'msg': res, 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt:,}â‚©ì„ ì€í–‰ì— ì•ˆì „í•˜ê²Œ ë³´ê´€í–ˆìŠµë‹ˆë‹¤. (ë¶„ë‹¹ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ ì€í–‰ì—ì„œ {amt:,}â‚©ì„ ì¶œê¸ˆí–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ì´ ê°€ë™ë˜ì—ˆìŠµë‹ˆë‹¤! (3ì´ˆë‹¹ 5000â‚©)", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆ ì—”ì§„ì„ ì •ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            prompt = " ".join(cmd_parts[1:])
            res = client.models.generate_content(model="gemini-2.0-flash", contents=prompt)
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except Exception as e:
            emit('message', {'msg': f"âŒ ì—ëŸ¬: {str(e)}", 'type': 'system'})

    elif cmd == "!ëª…ë ¹ì–´":
        help_msg = "ğŸ“œ [ëª…ë ¹ì–´ ë¦¬ìŠ¤íŠ¸]\n!ì”ì•¡ - ë‚´ ìì‚° í™•ì¸\n!ì €ê¸ˆ [ì•¡ìˆ˜] - ì€í–‰ì— ì…ê¸ˆ\n!ì¶œê¸ˆ [ì•¡ìˆ˜] - í˜„ê¸ˆí™”\n!ë‡Œì ˆ - ë¬´í•œ ëˆ ë²Œê¸° ì‹œì‘\n!ë‡Œì ˆì¤‘ë‹¨ - ì¤‘ì§€\n!gemini [ì§ˆë¬¸] - AI ë‹µë³€\n!ëª…ë ¹ì–´ - ë„ì›€ë§"
        emit('message', {'msg': help_msg, 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ…
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=background_scheduler, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
import random
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í™˜ê²½] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "multiverse_empire.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {}

# Gemini AI í´ë¼ì´ì–¸íŠ¸ ì„¤ì •
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key:
        client = genai.Client(api_key=api_key)
except:
    print("Gemini SDKê°€ ì—†ê±°ë‚˜ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. !gemini ê¸°ëŠ¥ì€ ë¹„í™œì„±í™”ë©ë‹ˆë‹¤.")

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("""
            CREATE TABLE IF NOT EXISTS users (
                nickname TEXT PRIMARY KEY, 
                money INTEGER DEFAULT 1000, 
                bank_money INTEGER DEFAULT 0
            )
        """)
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ë° ë‰´ìŠ¤ ì‹œìŠ¤í…œ]
def background_scheduler():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤ ì‹¤í–‰
        with sqlite3.connect(DB_FILE) as conn:
            # 1. ì´ì ì§€ê¸‰ (1%)
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()
        
        # 2. ì‹¤ì‹œê°„ ê²½ì œ ë‰´ìŠ¤ ì´ë²¤íŠ¸
        news_list = [
            "ğŸ“¢ [ê²½ì œ] ì œêµ­ ì€í–‰ì˜ ê¸ˆë¦¬ê°€ ìƒìŠ¹ ì¡°ì§ì„ ë³´ì…ë‹ˆë‹¤!",
            "ğŸ“¢ [ì†Œì‹] ëŒ€ê·œëª¨ ë‡Œì ˆ ì—ë„ˆì§€ê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ì±„êµ´ íš¨ìœ¨ì´ ì¦ê°€í•©ë‹ˆë‹¤.",
            "ğŸ“¢ [ê³µì§€] í˜„ì¬ ìµœê³  ë¶€ìëŠ” 'ì´ˆì›”ì' ë“±ê¸‰ì„ ìœ ì§€í•˜ê³  ìˆìŠµë‹ˆë‹¤.",
            "ğŸ“¢ [ì´ë²¤íŠ¸] ì§€ê¸ˆ ì±„íŒ…ì„ ì…ë ¥í•˜ë©´ ë³´ë„ˆìŠ¤ í¬ì¸íŠ¸ê°€ ì§€ê¸‰ë  í™•ë¥ ì´ ë†’ìŠµë‹ˆë‹¤!"
        ]
        socketio.emit('message', {'msg': random.choice(news_list), 'type': 'system'}, room='main')

# --- [3. íŠ¹ìˆ˜ ê¸°ëŠ¥ ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 1
        reward = 5000
        update_money(nick, reward, bank=True)
        pattern = f"ğŸŒ€ [{nick}] ë‡Œì ˆ ë™ë ¥ ê°€ë™ ì¤‘... (+{reward}â‚© ì…ê¸ˆ)"
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"{pattern}\në¬´í•œ ë£¨í”„ íšŸìˆ˜: {m_count}íšŒì°¨", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3)

def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [4. ë¼ìš°íŒ… ë° ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸš€ {data['nickname']}ë‹˜ì´ ë©€í‹°ë²„ìŠ¤ ì„œë²„ì— ì ‘ì†í–ˆìŠµë‹ˆë‹¤!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ìˆ˜ìµ ê³µì‹]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ [ëŒ€ìš©ëŸ‰ ë°ì´í„° ë³€í™˜]\nê¸¸ì´: {msg_len}ì\në³´ìƒ: {reward}â‚© ì ë¦½ ì™„ë£Œ\nğŸ”— íŒŒì¼ ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ ì²˜ë¦¬]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        total = user['money'] + user['bank_money']
        res = f"ğŸ’° {nick}ë‹˜ì˜ ìì‚° ë³´ê³ ì„œ\n" \
              f"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" \
              f"ğŸ’µ í˜„ê¸ˆ: {user['money']:,}â‚©\n" \
              f"ğŸ¦ ì€í–‰: {user['bank_money']:,}â‚©\n" \
              f"ğŸ’³ ì´í•©: {total:,}â‚©\n" \
              f"ğŸ† ë“±ê¸‰: {'ì´ˆì›”ì' if total >= 10000000 else 'VIP' if total >= 1000000 else 'í‰ë¯¼'}"
        emit('message', {'msg': res, 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt:,}â‚©ì„ ì€í–‰ì— ì•ˆì „í•˜ê²Œ ë³´ê´€í–ˆìŠµë‹ˆë‹¤. (ë¶„ë‹¹ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ ì€í–‰ì—ì„œ {amt:,}â‚©ì„ ì¶œê¸ˆí–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ì´ ê°€ë™ë˜ì—ˆìŠµë‹ˆë‹¤! (3ì´ˆë‹¹ 5000â‚©)", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆ ì—”ì§„ì„ ì •ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            prompt = " ".join(cmd_parts[1:])
            res = client.models.generate_content(model="gemini-2.0-flash", contents=prompt)
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except Exception as e:
            emit('message', {'msg': f"âŒ ì—ëŸ¬: {str(e)}", 'type': 'system'})

    elif cmd == "!ëª…ë ¹ì–´":
        help_msg = "ğŸ“œ [ëª…ë ¹ì–´ ë¦¬ìŠ¤íŠ¸]\n!ì”ì•¡ - ë‚´ ìì‚° í™•ì¸\n!ì €ê¸ˆ [ì•¡ìˆ˜] - ì€í–‰ì— ì…ê¸ˆ\n!ì¶œê¸ˆ [ì•¡ìˆ˜] - í˜„ê¸ˆí™”\n!ë‡Œì ˆ - ë¬´í•œ ëˆ ë²Œê¸° ì‹œì‘\n!ë‡Œì ˆì¤‘ë‹¨ - ì¤‘ì§€\n!gemini [ì§ˆë¬¸] - AI ë‹µë³€\n!ëª…ë ¹ì–´ - ë„ì›€ë§"
        emit('message', {'msg': help_msg, 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ…
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=background_scheduler, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
import random
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í™˜ê²½] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "multiverse_empire.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {}

# Gemini AI í´ë¼ì´ì–¸íŠ¸ ì„¤ì •
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key:
        client = genai.Client(api_key=api_key)
except:
    print("Gemini SDKê°€ ì—†ê±°ë‚˜ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. !gemini ê¸°ëŠ¥ì€ ë¹„í™œì„±í™”ë©ë‹ˆë‹¤.")

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("""
            CREATE TABLE IF NOT EXISTS users (
                nickname TEXT PRIMARY KEY, 
                money INTEGER DEFAULT 1000, 
                bank_money INTEGER DEFAULT 0
            )
        """)
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ë° ë‰´ìŠ¤ ì‹œìŠ¤í…œ]
def background_scheduler():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤ ì‹¤í–‰
        with sqlite3.connect(DB_FILE) as conn:
            # 1. ì´ì ì§€ê¸‰ (1%)
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()
        
        # 2. ì‹¤ì‹œê°„ ê²½ì œ ë‰´ìŠ¤ ì´ë²¤íŠ¸
        news_list = [
            "ğŸ“¢ [ê²½ì œ] ì œêµ­ ì€í–‰ì˜ ê¸ˆë¦¬ê°€ ìƒìŠ¹ ì¡°ì§ì„ ë³´ì…ë‹ˆë‹¤!",
            "ğŸ“¢ [ì†Œì‹] ëŒ€ê·œëª¨ ë‡Œì ˆ ì—ë„ˆì§€ê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ì±„êµ´ íš¨ìœ¨ì´ ì¦ê°€í•©ë‹ˆë‹¤.",
            "ğŸ“¢ [ê³µì§€] í˜„ì¬ ìµœê³  ë¶€ìëŠ” 'ì´ˆì›”ì' ë“±ê¸‰ì„ ìœ ì§€í•˜ê³  ìˆìŠµë‹ˆë‹¤.",
            "ğŸ“¢ [ì´ë²¤íŠ¸] ì§€ê¸ˆ ì±„íŒ…ì„ ì…ë ¥í•˜ë©´ ë³´ë„ˆìŠ¤ í¬ì¸íŠ¸ê°€ ì§€ê¸‰ë  í™•ë¥ ì´ ë†’ìŠµë‹ˆë‹¤!"
        ]
        socketio.emit('message', {'msg': random.choice(news_list), 'type': 'system'}, room='main')

# --- [3. íŠ¹ìˆ˜ ê¸°ëŠ¥ ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 1
        reward = 5000
        update_money(nick, reward, bank=True)
        pattern = f"ğŸŒ€ [{nick}] ë‡Œì ˆ ë™ë ¥ ê°€ë™ ì¤‘... (+{reward}â‚© ì…ê¸ˆ)"
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"{pattern}\në¬´í•œ ë£¨í”„ íšŸìˆ˜: {m_count}íšŒì°¨", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3)

def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [4. ë¼ìš°íŒ… ë° ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸš€ {data['nickname']}ë‹˜ì´ ë©€í‹°ë²„ìŠ¤ ì„œë²„ì— ì ‘ì†í–ˆìŠµë‹ˆë‹¤!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ìˆ˜ìµ ê³µì‹]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ [ëŒ€ìš©ëŸ‰ ë°ì´í„° ë³€í™˜]\nê¸¸ì´: {msg_len}ì\në³´ìƒ: {reward}â‚© ì ë¦½ ì™„ë£Œ\nğŸ”— íŒŒì¼ ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ ì²˜ë¦¬]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        total = user['money'] + user['bank_money']
        res = f"ğŸ’° {nick}ë‹˜ì˜ ìì‚° ë³´ê³ ì„œ\n" \
              f"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" \
              f"ğŸ’µ í˜„ê¸ˆ: {user['money']:,}â‚©\n" \
              f"ğŸ¦ ì€í–‰: {user['bank_money']:,}â‚©\n" \
              f"ğŸ’³ ì´í•©: {total:,}â‚©\n" \
              f"ğŸ† ë“±ê¸‰: {'ì´ˆì›”ì' if total >= 10000000 else 'VIP' if total >= 1000000 else 'í‰ë¯¼'}"
        emit('message', {'msg': res, 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt:,}â‚©ì„ ì€í–‰ì— ì•ˆì „í•˜ê²Œ ë³´ê´€í–ˆìŠµë‹ˆë‹¤. (ë¶„ë‹¹ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ ì€í–‰ì—ì„œ {amt:,}â‚©ì„ ì¶œê¸ˆí–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ì´ ê°€ë™ë˜ì—ˆìŠµë‹ˆë‹¤! (3ì´ˆë‹¹ 5000â‚©)", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆ ì—”ì§„ì„ ì •ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            prompt = " ".join(cmd_parts[1:])
            res = client.models.generate_content(model="gemini-2.0-flash", contents=prompt)
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except Exception as e:
            emit('message', {'msg': f"âŒ ì—ëŸ¬: {str(e)}", 'type': 'system'})

    elif cmd == "!ëª…ë ¹ì–´":
        help_msg = "ğŸ“œ [ëª…ë ¹ì–´ ë¦¬ìŠ¤íŠ¸]\n!ì”ì•¡ - ë‚´ ìì‚° í™•ì¸\n!ì €ê¸ˆ [ì•¡ìˆ˜] - ì€í–‰ì— ì…ê¸ˆ\n!ì¶œê¸ˆ [ì•¡ìˆ˜] - í˜„ê¸ˆí™”\n!ë‡Œì ˆ - ë¬´í•œ ëˆ ë²Œê¸° ì‹œì‘\n!ë‡Œì ˆì¤‘ë‹¨ - ì¤‘ì§€\n!gemini [ì§ˆë¬¸] - AI ë‹µë³€\n!ëª…ë ¹ì–´ - ë„ì›€ë§"
        emit('message', {'msg': help_msg, 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ…
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=background_scheduler, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
import random
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í™˜ê²½] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "multiverse_empire.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {}

# Gemini AI í´ë¼ì´ì–¸íŠ¸ ì„¤ì •
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key:
        client = genai.Client(api_key=api_key)
except:
    print("Gemini SDKê°€ ì—†ê±°ë‚˜ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. !gemini ê¸°ëŠ¥ì€ ë¹„í™œì„±í™”ë©ë‹ˆë‹¤.")

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("""
            CREATE TABLE IF NOT EXISTS users (
                nickname TEXT PRIMARY KEY, 
                money INTEGER DEFAULT 1000, 
                bank_money INTEGER DEFAULT 0
            )
        """)
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ë° ë‰´ìŠ¤ ì‹œìŠ¤í…œ]
def background_scheduler():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤ ì‹¤í–‰
        with sqlite3.connect(DB_FILE) as conn:
            # 1. ì´ì ì§€ê¸‰ (1%)
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()
        
        # 2. ì‹¤ì‹œê°„ ê²½ì œ ë‰´ìŠ¤ ì´ë²¤íŠ¸
        news_list = [
            "ğŸ“¢ [ê²½ì œ] ì œêµ­ ì€í–‰ì˜ ê¸ˆë¦¬ê°€ ìƒìŠ¹ ì¡°ì§ì„ ë³´ì…ë‹ˆë‹¤!",
            "ğŸ“¢ [ì†Œì‹] ëŒ€ê·œëª¨ ë‡Œì ˆ ì—ë„ˆì§€ê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ì±„êµ´ íš¨ìœ¨ì´ ì¦ê°€í•©ë‹ˆë‹¤.",
            "ğŸ“¢ [ê³µì§€] í˜„ì¬ ìµœê³  ë¶€ìëŠ” 'ì´ˆì›”ì' ë“±ê¸‰ì„ ìœ ì§€í•˜ê³  ìˆìŠµë‹ˆë‹¤.",
            "ğŸ“¢ [ì´ë²¤íŠ¸] ì§€ê¸ˆ ì±„íŒ…ì„ ì…ë ¥í•˜ë©´ ë³´ë„ˆìŠ¤ í¬ì¸íŠ¸ê°€ ì§€ê¸‰ë  í™•ë¥ ì´ ë†’ìŠµë‹ˆë‹¤!"
        ]
        socketio.emit('message', {'msg': random.choice(news_list), 'type': 'system'}, room='main')

# --- [3. íŠ¹ìˆ˜ ê¸°ëŠ¥ ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 1
        reward = 5000
        update_money(nick, reward, bank=True)
        pattern = f"ğŸŒ€ [{nick}] ë‡Œì ˆ ë™ë ¥ ê°€ë™ ì¤‘... (+{reward}â‚© ì…ê¸ˆ)"
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"{pattern}\në¬´í•œ ë£¨í”„ íšŸìˆ˜: {m_count}íšŒì°¨", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3)

def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [4. ë¼ìš°íŒ… ë° ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸš€ {data['nickname']}ë‹˜ì´ ë©€í‹°ë²„ìŠ¤ ì„œë²„ì— ì ‘ì†í–ˆìŠµë‹ˆë‹¤!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ìˆ˜ìµ ê³µì‹]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ [ëŒ€ìš©ëŸ‰ ë°ì´í„° ë³€í™˜]\nê¸¸ì´: {msg_len}ì\në³´ìƒ: {reward}â‚© ì ë¦½ ì™„ë£Œ\nğŸ”— íŒŒì¼ ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ ì²˜ë¦¬]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        total = user['money'] + user['bank_money']
        res = f"ğŸ’° {nick}ë‹˜ì˜ ìì‚° ë³´ê³ ì„œ\n" \
              f"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" \
              f"ğŸ’µ í˜„ê¸ˆ: {user['money']:,}â‚©\n" \
              f"ğŸ¦ ì€í–‰: {user['bank_money']:,}â‚©\n" \
              f"ğŸ’³ ì´í•©: {total:,}â‚©\n" \
              f"ğŸ† ë“±ê¸‰: {'ì´ˆì›”ì' if total >= 10000000 else 'VIP' if total >= 1000000 else 'í‰ë¯¼'}"
        emit('message', {'msg': res, 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt:,}â‚©ì„ ì€í–‰ì— ì•ˆì „í•˜ê²Œ ë³´ê´€í–ˆìŠµë‹ˆë‹¤. (ë¶„ë‹¹ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ ì€í–‰ì—ì„œ {amt:,}â‚©ì„ ì¶œê¸ˆí–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ì´ ê°€ë™ë˜ì—ˆìŠµë‹ˆë‹¤! (3ì´ˆë‹¹ 5000â‚©)", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆ ì—”ì§„ì„ ì •ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            prompt = " ".join(cmd_parts[1:])
            res = client.models.generate_content(model="gemini-2.0-flash", contents=prompt)
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except Exception as e:
            emit('message', {'msg': f"âŒ ì—ëŸ¬: {str(e)}", 'type': 'system'})

    elif cmd == "!ëª…ë ¹ì–´":
        help_msg = "ğŸ“œ [ëª…ë ¹ì–´ ë¦¬ìŠ¤íŠ¸]\n!ì”ì•¡ - ë‚´ ìì‚° í™•ì¸\n!ì €ê¸ˆ [ì•¡ìˆ˜] - ì€í–‰ì— ì…ê¸ˆ\n!ì¶œê¸ˆ [ì•¡ìˆ˜] - í˜„ê¸ˆí™”\n!ë‡Œì ˆ - ë¬´í•œ ëˆ ë²Œê¸° ì‹œì‘\n!ë‡Œì ˆì¤‘ë‹¨ - ì¤‘ì§€\n!gemini [ì§ˆë¬¸] - AI ë‹µë³€\n!ëª…ë ¹ì–´ - ë„ì›€ë§"
        emit('message', {'msg': help_msg, 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ…
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=background_scheduler, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
import random
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í™˜ê²½] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "multiverse_empire.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {}

# Gemini AI í´ë¼ì´ì–¸íŠ¸ ì„¤ì •
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key:
        client = genai.Client(api_key=api_key)
except:
    print("Gemini SDKê°€ ì—†ê±°ë‚˜ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. !gemini ê¸°ëŠ¥ì€ ë¹„í™œì„±í™”ë©ë‹ˆë‹¤.")

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("""
            CREATE TABLE IF NOT EXISTS users (
                nickname TEXT PRIMARY KEY, 
                money INTEGER DEFAULT 1000, 
                bank_money INTEGER DEFAULT 0
            )
        """)
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ë° ë‰´ìŠ¤ ì‹œìŠ¤í…œ]
def background_scheduler():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤ ì‹¤í–‰
        with sqlite3.connect(DB_FILE) as conn:
            # 1. ì´ì ì§€ê¸‰ (1%)
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()
        
        # 2. ì‹¤ì‹œê°„ ê²½ì œ ë‰´ìŠ¤ ì´ë²¤íŠ¸
        news_list = [
            "ğŸ“¢ [ê²½ì œ] ì œêµ­ ì€í–‰ì˜ ê¸ˆë¦¬ê°€ ìƒìŠ¹ ì¡°ì§ì„ ë³´ì…ë‹ˆë‹¤!",
            "ğŸ“¢ [ì†Œì‹] ëŒ€ê·œëª¨ ë‡Œì ˆ ì—ë„ˆì§€ê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ì±„êµ´ íš¨ìœ¨ì´ ì¦ê°€í•©ë‹ˆë‹¤.",
            "ğŸ“¢ [ê³µì§€] í˜„ì¬ ìµœê³  ë¶€ìëŠ” 'ì´ˆì›”ì' ë“±ê¸‰ì„ ìœ ì§€í•˜ê³  ìˆìŠµë‹ˆë‹¤.",
            "ğŸ“¢ [ì´ë²¤íŠ¸] ì§€ê¸ˆ ì±„íŒ…ì„ ì…ë ¥í•˜ë©´ ë³´ë„ˆìŠ¤ í¬ì¸íŠ¸ê°€ ì§€ê¸‰ë  í™•ë¥ ì´ ë†’ìŠµë‹ˆë‹¤!"
        ]
        socketio.emit('message', {'msg': random.choice(news_list), 'type': 'system'}, room='main')

# --- [3. íŠ¹ìˆ˜ ê¸°ëŠ¥ ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 1
        reward = 5000
        update_money(nick, reward, bank=True)
        pattern = f"ğŸŒ€ [{nick}] ë‡Œì ˆ ë™ë ¥ ê°€ë™ ì¤‘... (+{reward}â‚© ì…ê¸ˆ)"
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"{pattern}\në¬´í•œ ë£¨í”„ íšŸìˆ˜: {m_count}íšŒì°¨", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3)

def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [4. ë¼ìš°íŒ… ë° ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸš€ {data['nickname']}ë‹˜ì´ ë©€í‹°ë²„ìŠ¤ ì„œë²„ì— ì ‘ì†í–ˆìŠµë‹ˆë‹¤!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ìˆ˜ìµ ê³µì‹]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ [ëŒ€ìš©ëŸ‰ ë°ì´í„° ë³€í™˜]\nê¸¸ì´: {msg_len}ì\në³´ìƒ: {reward}â‚© ì ë¦½ ì™„ë£Œ\nğŸ”— íŒŒì¼ ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ ì²˜ë¦¬]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        total = user['money'] + user['bank_money']
        res = f"ğŸ’° {nick}ë‹˜ì˜ ìì‚° ë³´ê³ ì„œ\n" \
              f"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" \
              f"ğŸ’µ í˜„ê¸ˆ: {user['money']:,}â‚©\n" \
              f"ğŸ¦ ì€í–‰: {user['bank_money']:,}â‚©\n" \
              f"ğŸ’³ ì´í•©: {total:,}â‚©\n" \
              f"ğŸ† ë“±ê¸‰: {'ì´ˆì›”ì' if total >= 10000000 else 'VIP' if total >= 1000000 else 'í‰ë¯¼'}"
        emit('message', {'msg': res, 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt:,}â‚©ì„ ì€í–‰ì— ì•ˆì „í•˜ê²Œ ë³´ê´€í–ˆìŠµë‹ˆë‹¤. (ë¶„ë‹¹ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ ì€í–‰ì—ì„œ {amt:,}â‚©ì„ ì¶œê¸ˆí–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ì´ ê°€ë™ë˜ì—ˆìŠµë‹ˆë‹¤! (3ì´ˆë‹¹ 5000â‚©)", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆ ì—”ì§„ì„ ì •ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            prompt = " ".join(cmd_parts[1:])
            res = client.models.generate_content(model="gemini-2.0-flash", contents=prompt)
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except Exception as e:
            emit('message', {'msg': f"âŒ ì—ëŸ¬: {str(e)}", 'type': 'system'})

    elif cmd == "!ëª…ë ¹ì–´":
        help_msg = "ğŸ“œ [ëª…ë ¹ì–´ ë¦¬ìŠ¤íŠ¸]\n!ì”ì•¡ - ë‚´ ìì‚° í™•ì¸\n!ì €ê¸ˆ [ì•¡ìˆ˜] - ì€í–‰ì— ì…ê¸ˆ\n!ì¶œê¸ˆ [ì•¡ìˆ˜] - í˜„ê¸ˆí™”\n!ë‡Œì ˆ - ë¬´í•œ ëˆ ë²Œê¸° ì‹œì‘\n!ë‡Œì ˆì¤‘ë‹¨ - ì¤‘ì§€\n!gemini [ì§ˆë¬¸] - AI ë‹µë³€\n!ëª…ë ¹ì–´ - ë„ì›€ë§"
        emit('message', {'msg': help_msg, 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ…
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=background_scheduler, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
import random
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í™˜ê²½] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "multiverse_empire.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {}

# Gemini AI í´ë¼ì´ì–¸íŠ¸ ì„¤ì •
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key:
        client = genai.Client(api_key=api_key)
except:
    print("Gemini SDKê°€ ì—†ê±°ë‚˜ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. !gemini ê¸°ëŠ¥ì€ ë¹„í™œì„±í™”ë©ë‹ˆë‹¤.")

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("""
            CREATE TABLE IF NOT EXISTS users (
                nickname TEXT PRIMARY KEY, 
                money INTEGER DEFAULT 1000, 
                bank_money INTEGER DEFAULT 0
            )
        """)
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ë° ë‰´ìŠ¤ ì‹œìŠ¤í…œ]
def background_scheduler():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤ ì‹¤í–‰
        with sqlite3.connect(DB_FILE) as conn:
            # 1. ì´ì ì§€ê¸‰ (1%)
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()
        
        # 2. ì‹¤ì‹œê°„ ê²½ì œ ë‰´ìŠ¤ ì´ë²¤íŠ¸
        news_list = [
            "ğŸ“¢ [ê²½ì œ] ì œêµ­ ì€í–‰ì˜ ê¸ˆë¦¬ê°€ ìƒìŠ¹ ì¡°ì§ì„ ë³´ì…ë‹ˆë‹¤!",
            "ğŸ“¢ [ì†Œì‹] ëŒ€ê·œëª¨ ë‡Œì ˆ ì—ë„ˆì§€ê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ì±„êµ´ íš¨ìœ¨ì´ ì¦ê°€í•©ë‹ˆë‹¤.",
            "ğŸ“¢ [ê³µì§€] í˜„ì¬ ìµœê³  ë¶€ìëŠ” 'ì´ˆì›”ì' ë“±ê¸‰ì„ ìœ ì§€í•˜ê³  ìˆìŠµë‹ˆë‹¤.",
            "ğŸ“¢ [ì´ë²¤íŠ¸] ì§€ê¸ˆ ì±„íŒ…ì„ ì…ë ¥í•˜ë©´ ë³´ë„ˆìŠ¤ í¬ì¸íŠ¸ê°€ ì§€ê¸‰ë  í™•ë¥ ì´ ë†’ìŠµë‹ˆë‹¤!"
        ]
        socketio.emit('message', {'msg': random.choice(news_list), 'type': 'system'}, room='main')

# --- [3. íŠ¹ìˆ˜ ê¸°ëŠ¥ ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 1
        reward = 5000
        update_money(nick, reward, bank=True)
        pattern = f"ğŸŒ€ [{nick}] ë‡Œì ˆ ë™ë ¥ ê°€ë™ ì¤‘... (+{reward}â‚© ì…ê¸ˆ)"
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"{pattern}\në¬´í•œ ë£¨í”„ íšŸìˆ˜: {m_count}íšŒì°¨", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3)

def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [4. ë¼ìš°íŒ… ë° ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸš€ {data['nickname']}ë‹˜ì´ ë©€í‹°ë²„ìŠ¤ ì„œë²„ì— ì ‘ì†í–ˆìŠµë‹ˆë‹¤!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ìˆ˜ìµ ê³µì‹]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ [ëŒ€ìš©ëŸ‰ ë°ì´í„° ë³€í™˜]\nê¸¸ì´: {msg_len}ì\në³´ìƒ: {reward}â‚© ì ë¦½ ì™„ë£Œ\nğŸ”— íŒŒì¼ ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ ì²˜ë¦¬]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        total = user['money'] + user['bank_money']
        res = f"ğŸ’° {nick}ë‹˜ì˜ ìì‚° ë³´ê³ ì„œ\n" \
              f"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" \
              f"ğŸ’µ í˜„ê¸ˆ: {user['money']:,}â‚©\n" \
              f"ğŸ¦ ì€í–‰: {user['bank_money']:,}â‚©\n" \
              f"ğŸ’³ ì´í•©: {total:,}â‚©\n" \
              f"ğŸ† ë“±ê¸‰: {'ì´ˆì›”ì' if total >= 10000000 else 'VIP' if total >= 1000000 else 'í‰ë¯¼'}"
        emit('message', {'msg': res, 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt:,}â‚©ì„ ì€í–‰ì— ì•ˆì „í•˜ê²Œ ë³´ê´€í–ˆìŠµë‹ˆë‹¤. (ë¶„ë‹¹ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ ì€í–‰ì—ì„œ {amt:,}â‚©ì„ ì¶œê¸ˆí–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ì´ ê°€ë™ë˜ì—ˆìŠµë‹ˆë‹¤! (3ì´ˆë‹¹ 5000â‚©)", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆ ì—”ì§„ì„ ì •ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            prompt = " ".join(cmd_parts[1:])
            res = client.models.generate_content(model="gemini-2.0-flash", contents=prompt)
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except Exception as e:
            emit('message', {'msg': f"âŒ ì—ëŸ¬: {str(e)}", 'type': 'system'})

    elif cmd == "!ëª…ë ¹ì–´":
        help_msg = "ğŸ“œ [ëª…ë ¹ì–´ ë¦¬ìŠ¤íŠ¸]\n!ì”ì•¡ - ë‚´ ìì‚° í™•ì¸\n!ì €ê¸ˆ [ì•¡ìˆ˜] - ì€í–‰ì— ì…ê¸ˆ\n!ì¶œê¸ˆ [ì•¡ìˆ˜] - í˜„ê¸ˆí™”\n!ë‡Œì ˆ - ë¬´í•œ ëˆ ë²Œê¸° ì‹œì‘\n!ë‡Œì ˆì¤‘ë‹¨ - ì¤‘ì§€\n!gemini [ì§ˆë¬¸] - AI ë‹µë³€\n!ëª…ë ¹ì–´ - ë„ì›€ë§"
        emit('message', {'msg': help_msg, 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ…
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=background_scheduler, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
import random
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í™˜ê²½] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "multiverse_empire.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {}

# Gemini AI í´ë¼ì´ì–¸íŠ¸ ì„¤ì •
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key:
        client = genai.Client(api_key=api_key)
except:
    print("Gemini SDKê°€ ì—†ê±°ë‚˜ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. !gemini ê¸°ëŠ¥ì€ ë¹„í™œì„±í™”ë©ë‹ˆë‹¤.")

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("""
            CREATE TABLE IF NOT EXISTS users (
                nickname TEXT PRIMARY KEY, 
                money INTEGER DEFAULT 1000, 
                bank_money INTEGER DEFAULT 0
            )
        """)
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ë° ë‰´ìŠ¤ ì‹œìŠ¤í…œ]
def background_scheduler():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤ ì‹¤í–‰
        with sqlite3.connect(DB_FILE) as conn:
            # 1. ì´ì ì§€ê¸‰ (1%)
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()
        
        # 2. ì‹¤ì‹œê°„ ê²½ì œ ë‰´ìŠ¤ ì´ë²¤íŠ¸
        news_list = [
            "ğŸ“¢ [ê²½ì œ] ì œêµ­ ì€í–‰ì˜ ê¸ˆë¦¬ê°€ ìƒìŠ¹ ì¡°ì§ì„ ë³´ì…ë‹ˆë‹¤!",
            "ğŸ“¢ [ì†Œì‹] ëŒ€ê·œëª¨ ë‡Œì ˆ ì—ë„ˆì§€ê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ì±„êµ´ íš¨ìœ¨ì´ ì¦ê°€í•©ë‹ˆë‹¤.",
            "ğŸ“¢ [ê³µì§€] í˜„ì¬ ìµœê³  ë¶€ìëŠ” 'ì´ˆì›”ì' ë“±ê¸‰ì„ ìœ ì§€í•˜ê³  ìˆìŠµë‹ˆë‹¤.",
            "ğŸ“¢ [ì´ë²¤íŠ¸] ì§€ê¸ˆ ì±„íŒ…ì„ ì…ë ¥í•˜ë©´ ë³´ë„ˆìŠ¤ í¬ì¸íŠ¸ê°€ ì§€ê¸‰ë  í™•ë¥ ì´ ë†’ìŠµë‹ˆë‹¤!"
        ]
        socketio.emit('message', {'msg': random.choice(news_list), 'type': 'system'}, room='main')

# --- [3. íŠ¹ìˆ˜ ê¸°ëŠ¥ ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 1
        reward = 5000
        update_money(nick, reward, bank=True)
        pattern = f"ğŸŒ€ [{nick}] ë‡Œì ˆ ë™ë ¥ ê°€ë™ ì¤‘... (+{reward}â‚© ì…ê¸ˆ)"
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"{pattern}\në¬´í•œ ë£¨í”„ íšŸìˆ˜: {m_count}íšŒì°¨", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3)

def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [4. ë¼ìš°íŒ… ë° ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸš€ {data['nickname']}ë‹˜ì´ ë©€í‹°ë²„ìŠ¤ ì„œë²„ì— ì ‘ì†í–ˆìŠµë‹ˆë‹¤!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ìˆ˜ìµ ê³µì‹]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ [ëŒ€ìš©ëŸ‰ ë°ì´í„° ë³€í™˜]\nê¸¸ì´: {msg_len}ì\në³´ìƒ: {reward}â‚© ì ë¦½ ì™„ë£Œ\nğŸ”— íŒŒì¼ ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ ì²˜ë¦¬]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        total = user['money'] + user['bank_money']
        res = f"ğŸ’° {nick}ë‹˜ì˜ ìì‚° ë³´ê³ ì„œ\n" \
              f"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" \
              f"ğŸ’µ í˜„ê¸ˆ: {user['money']:,}â‚©\n" \
              f"ğŸ¦ ì€í–‰: {user['bank_money']:,}â‚©\n" \
              f"ğŸ’³ ì´í•©: {total:,}â‚©\n" \
              f"ğŸ† ë“±ê¸‰: {'ì´ˆì›”ì' if total >= 10000000 else 'VIP' if total >= 1000000 else 'í‰ë¯¼'}"
        emit('message', {'msg': res, 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt:,}â‚©ì„ ì€í–‰ì— ì•ˆì „í•˜ê²Œ ë³´ê´€í–ˆìŠµë‹ˆë‹¤. (ë¶„ë‹¹ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ ì€í–‰ì—ì„œ {amt:,}â‚©ì„ ì¶œê¸ˆí–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ì´ ê°€ë™ë˜ì—ˆìŠµë‹ˆë‹¤! (3ì´ˆë‹¹ 5000â‚©)", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆ ì—”ì§„ì„ ì •ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            prompt = " ".join(cmd_parts[1:])
            res = client.models.generate_content(model="gemini-2.0-flash", contents=prompt)
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except Exception as e:
            emit('message', {'msg': f"âŒ ì—ëŸ¬: {str(e)}", 'type': 'system'})

    elif cmd == "!ëª…ë ¹ì–´":
        help_msg = "ğŸ“œ [ëª…ë ¹ì–´ ë¦¬ìŠ¤íŠ¸]\n!ì”ì•¡ - ë‚´ ìì‚° í™•ì¸\n!ì €ê¸ˆ [ì•¡ìˆ˜] - ì€í–‰ì— ì…ê¸ˆ\n!ì¶œê¸ˆ [ì•¡ìˆ˜] - í˜„ê¸ˆí™”\n!ë‡Œì ˆ - ë¬´í•œ ëˆ ë²Œê¸° ì‹œì‘\n!ë‡Œì ˆì¤‘ë‹¨ - ì¤‘ì§€\n!gemini [ì§ˆë¬¸] - AI ë‹µë³€\n!ëª…ë ¹ì–´ - ë„ì›€ë§"
        emit('message', {'msg': help_msg, 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ…
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=background_scheduler, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
import random
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í™˜ê²½] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "multiverse_empire.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {}

# Gemini AI í´ë¼ì´ì–¸íŠ¸ ì„¤ì •
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key:
        client = genai.Client(api_key=api_key)
except:
    print("Gemini SDKê°€ ì—†ê±°ë‚˜ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. !gemini ê¸°ëŠ¥ì€ ë¹„í™œì„±í™”ë©ë‹ˆë‹¤.")

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("""
            CREATE TABLE IF NOT EXISTS users (
                nickname TEXT PRIMARY KEY, 
                money INTEGER DEFAULT 1000, 
                bank_money INTEGER DEFAULT 0
            )
        """)
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ë° ë‰´ìŠ¤ ì‹œìŠ¤í…œ]
def background_scheduler():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤ ì‹¤í–‰
        with sqlite3.connect(DB_FILE) as conn:
            # 1. ì´ì ì§€ê¸‰ (1%)
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()
        
        # 2. ì‹¤ì‹œê°„ ê²½ì œ ë‰´ìŠ¤ ì´ë²¤íŠ¸
        news_list = [
            "ğŸ“¢ [ê²½ì œ] ì œêµ­ ì€í–‰ì˜ ê¸ˆë¦¬ê°€ ìƒìŠ¹ ì¡°ì§ì„ ë³´ì…ë‹ˆë‹¤!",
            "ğŸ“¢ [ì†Œì‹] ëŒ€ê·œëª¨ ë‡Œì ˆ ì—ë„ˆì§€ê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ì±„êµ´ íš¨ìœ¨ì´ ì¦ê°€í•©ë‹ˆë‹¤.",
            "ğŸ“¢ [ê³µì§€] í˜„ì¬ ìµœê³  ë¶€ìëŠ” 'ì´ˆì›”ì' ë“±ê¸‰ì„ ìœ ì§€í•˜ê³  ìˆìŠµë‹ˆë‹¤.",
            "ğŸ“¢ [ì´ë²¤íŠ¸] ì§€ê¸ˆ ì±„íŒ…ì„ ì…ë ¥í•˜ë©´ ë³´ë„ˆìŠ¤ í¬ì¸íŠ¸ê°€ ì§€ê¸‰ë  í™•ë¥ ì´ ë†’ìŠµë‹ˆë‹¤!"
        ]
        socketio.emit('message', {'msg': random.choice(news_list), 'type': 'system'}, room='main')

# --- [3. íŠ¹ìˆ˜ ê¸°ëŠ¥ ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 1
        reward = 5000
        update_money(nick, reward, bank=True)
        pattern = f"ğŸŒ€ [{nick}] ë‡Œì ˆ ë™ë ¥ ê°€ë™ ì¤‘... (+{reward}â‚© ì…ê¸ˆ)"
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"{pattern}\në¬´í•œ ë£¨í”„ íšŸìˆ˜: {m_count}íšŒì°¨", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3)

def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [4. ë¼ìš°íŒ… ë° ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸš€ {data['nickname']}ë‹˜ì´ ë©€í‹°ë²„ìŠ¤ ì„œë²„ì— ì ‘ì†í–ˆìŠµë‹ˆë‹¤!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ìˆ˜ìµ ê³µì‹]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ [ëŒ€ìš©ëŸ‰ ë°ì´í„° ë³€í™˜]\nê¸¸ì´: {msg_len}ì\në³´ìƒ: {reward}â‚© ì ë¦½ ì™„ë£Œ\nğŸ”— íŒŒì¼ ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ ì²˜ë¦¬]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        total = user['money'] + user['bank_money']
        res = f"ğŸ’° {nick}ë‹˜ì˜ ìì‚° ë³´ê³ ì„œ\n" \
              f"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" \
              f"ğŸ’µ í˜„ê¸ˆ: {user['money']:,}â‚©\n" \
              f"ğŸ¦ ì€í–‰: {user['bank_money']:,}â‚©\n" \
              f"ğŸ’³ ì´í•©: {total:,}â‚©\n" \
              f"ğŸ† ë“±ê¸‰: {'ì´ˆì›”ì' if total >= 10000000 else 'VIP' if total >= 1000000 else 'í‰ë¯¼'}"
        emit('message', {'msg': res, 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt:,}â‚©ì„ ì€í–‰ì— ì•ˆì „í•˜ê²Œ ë³´ê´€í–ˆìŠµë‹ˆë‹¤. (ë¶„ë‹¹ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ ì€í–‰ì—ì„œ {amt:,}â‚©ì„ ì¶œê¸ˆí–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ì´ ê°€ë™ë˜ì—ˆìŠµë‹ˆë‹¤! (3ì´ˆë‹¹ 5000â‚©)", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆ ì—”ì§„ì„ ì •ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            prompt = " ".join(cmd_parts[1:])
            res = client.models.generate_content(model="gemini-2.0-flash", contents=prompt)
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except Exception as e:
            emit('message', {'msg': f"âŒ ì—ëŸ¬: {str(e)}", 'type': 'system'})

    elif cmd == "!ëª…ë ¹ì–´":
        help_msg = "ğŸ“œ [ëª…ë ¹ì–´ ë¦¬ìŠ¤íŠ¸]\n!ì”ì•¡ - ë‚´ ìì‚° í™•ì¸\n!ì €ê¸ˆ [ì•¡ìˆ˜] - ì€í–‰ì— ì…ê¸ˆ\n!ì¶œê¸ˆ [ì•¡ìˆ˜] - í˜„ê¸ˆí™”\n!ë‡Œì ˆ - ë¬´í•œ ëˆ ë²Œê¸° ì‹œì‘\n!ë‡Œì ˆì¤‘ë‹¨ - ì¤‘ì§€\n!gemini [ì§ˆë¬¸] - AI ë‹µë³€\n!ëª…ë ¹ì–´ - ë„ì›€ë§"
        emit('message', {'msg': help_msg, 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ…
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=background_scheduler, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
import random
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í™˜ê²½] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "multiverse_empire.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {}

# Gemini AI í´ë¼ì´ì–¸íŠ¸ ì„¤ì •
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key:
        client = genai.Client(api_key=api_key)
except:
    print("Gemini SDKê°€ ì—†ê±°ë‚˜ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. !gemini ê¸°ëŠ¥ì€ ë¹„í™œì„±í™”ë©ë‹ˆë‹¤.")

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("""
            CREATE TABLE IF NOT EXISTS users (
                nickname TEXT PRIMARY KEY, 
                money INTEGER DEFAULT 1000, 
                bank_money INTEGER DEFAULT 0
            )
        """)
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ë° ë‰´ìŠ¤ ì‹œìŠ¤í…œ]
def background_scheduler():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤ ì‹¤í–‰
        with sqlite3.connect(DB_FILE) as conn:
            # 1. ì´ì ì§€ê¸‰ (1%)
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()
        
        # 2. ì‹¤ì‹œê°„ ê²½ì œ ë‰´ìŠ¤ ì´ë²¤íŠ¸
        news_list = [
            "ğŸ“¢ [ê²½ì œ] ì œêµ­ ì€í–‰ì˜ ê¸ˆë¦¬ê°€ ìƒìŠ¹ ì¡°ì§ì„ ë³´ì…ë‹ˆë‹¤!",
            "ğŸ“¢ [ì†Œì‹] ëŒ€ê·œëª¨ ë‡Œì ˆ ì—ë„ˆì§€ê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ì±„êµ´ íš¨ìœ¨ì´ ì¦ê°€í•©ë‹ˆë‹¤.",
            "ğŸ“¢ [ê³µì§€] í˜„ì¬ ìµœê³  ë¶€ìëŠ” 'ì´ˆì›”ì' ë“±ê¸‰ì„ ìœ ì§€í•˜ê³  ìˆìŠµë‹ˆë‹¤.",
            "ğŸ“¢ [ì´ë²¤íŠ¸] ì§€ê¸ˆ ì±„íŒ…ì„ ì…ë ¥í•˜ë©´ ë³´ë„ˆìŠ¤ í¬ì¸íŠ¸ê°€ ì§€ê¸‰ë  í™•ë¥ ì´ ë†’ìŠµë‹ˆë‹¤!"
        ]
        socketio.emit('message', {'msg': random.choice(news_list), 'type': 'system'}, room='main')

# --- [3. íŠ¹ìˆ˜ ê¸°ëŠ¥ ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 1
        reward = 5000
        update_money(nick, reward, bank=True)
        pattern = f"ğŸŒ€ [{nick}] ë‡Œì ˆ ë™ë ¥ ê°€ë™ ì¤‘... (+{reward}â‚© ì…ê¸ˆ)"
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"{pattern}\në¬´í•œ ë£¨í”„ íšŸìˆ˜: {m_count}íšŒì°¨", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3)

def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [4. ë¼ìš°íŒ… ë° ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸš€ {data['nickname']}ë‹˜ì´ ë©€í‹°ë²„ìŠ¤ ì„œë²„ì— ì ‘ì†í–ˆìŠµë‹ˆë‹¤!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ìˆ˜ìµ ê³µì‹]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ [ëŒ€ìš©ëŸ‰ ë°ì´í„° ë³€í™˜]\nê¸¸ì´: {msg_len}ì\në³´ìƒ: {reward}â‚© ì ë¦½ ì™„ë£Œ\nğŸ”— íŒŒì¼ ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ ì²˜ë¦¬]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        total = user['money'] + user['bank_money']
        res = f"ğŸ’° {nick}ë‹˜ì˜ ìì‚° ë³´ê³ ì„œ\n" \
              f"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" \
              f"ğŸ’µ í˜„ê¸ˆ: {user['money']:,}â‚©\n" \
              f"ğŸ¦ ì€í–‰: {user['bank_money']:,}â‚©\n" \
              f"ğŸ’³ ì´í•©: {total:,}â‚©\n" \
              f"ğŸ† ë“±ê¸‰: {'ì´ˆì›”ì' if total >= 10000000 else 'VIP' if total >= 1000000 else 'í‰ë¯¼'}"
        emit('message', {'msg': res, 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt:,}â‚©ì„ ì€í–‰ì— ì•ˆì „í•˜ê²Œ ë³´ê´€í–ˆìŠµë‹ˆë‹¤. (ë¶„ë‹¹ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ ì€í–‰ì—ì„œ {amt:,}â‚©ì„ ì¶œê¸ˆí–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ì´ ê°€ë™ë˜ì—ˆìŠµë‹ˆë‹¤! (3ì´ˆë‹¹ 5000â‚©)", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆ ì—”ì§„ì„ ì •ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            prompt = " ".join(cmd_parts[1:])
            res = client.models.generate_content(model="gemini-2.0-flash", contents=prompt)
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except Exception as e:
            emit('message', {'msg': f"âŒ ì—ëŸ¬: {str(e)}", 'type': 'system'})

    elif cmd == "!ëª…ë ¹ì–´":
        help_msg = "ğŸ“œ [ëª…ë ¹ì–´ ë¦¬ìŠ¤íŠ¸]\n!ì”ì•¡ - ë‚´ ìì‚° í™•ì¸\n!ì €ê¸ˆ [ì•¡ìˆ˜] - ì€í–‰ì— ì…ê¸ˆ\n!ì¶œê¸ˆ [ì•¡ìˆ˜] - í˜„ê¸ˆí™”\n!ë‡Œì ˆ - ë¬´í•œ ëˆ ë²Œê¸° ì‹œì‘\n!ë‡Œì ˆì¤‘ë‹¨ - ì¤‘ì§€\n!gemini [ì§ˆë¬¸] - AI ë‹µë³€\n!ëª…ë ¹ì–´ - ë„ì›€ë§"
        emit('message', {'msg': help_msg, 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ…
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=background_scheduler, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
import random
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í™˜ê²½] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "multiverse_empire.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {}

# Gemini AI í´ë¼ì´ì–¸íŠ¸ ì„¤ì •
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key:
        client = genai.Client(api_key=api_key)
except:
    print("Gemini SDKê°€ ì—†ê±°ë‚˜ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. !gemini ê¸°ëŠ¥ì€ ë¹„í™œì„±í™”ë©ë‹ˆë‹¤.")

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("""
            CREATE TABLE IF NOT EXISTS users (
                nickname TEXT PRIMARY KEY, 
                money INTEGER DEFAULT 1000, 
                bank_money INTEGER DEFAULT 0
            )
        """)
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ë° ë‰´ìŠ¤ ì‹œìŠ¤í…œ]
def background_scheduler():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤ ì‹¤í–‰
        with sqlite3.connect(DB_FILE) as conn:
            # 1. ì´ì ì§€ê¸‰ (1%)
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()
        
        # 2. ì‹¤ì‹œê°„ ê²½ì œ ë‰´ìŠ¤ ì´ë²¤íŠ¸
        news_list = [
            "ğŸ“¢ [ê²½ì œ] ì œêµ­ ì€í–‰ì˜ ê¸ˆë¦¬ê°€ ìƒìŠ¹ ì¡°ì§ì„ ë³´ì…ë‹ˆë‹¤!",
            "ğŸ“¢ [ì†Œì‹] ëŒ€ê·œëª¨ ë‡Œì ˆ ì—ë„ˆì§€ê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ì±„êµ´ íš¨ìœ¨ì´ ì¦ê°€í•©ë‹ˆë‹¤.",
            "ğŸ“¢ [ê³µì§€] í˜„ì¬ ìµœê³  ë¶€ìëŠ” 'ì´ˆì›”ì' ë“±ê¸‰ì„ ìœ ì§€í•˜ê³  ìˆìŠµë‹ˆë‹¤.",
            "ğŸ“¢ [ì´ë²¤íŠ¸] ì§€ê¸ˆ ì±„íŒ…ì„ ì…ë ¥í•˜ë©´ ë³´ë„ˆìŠ¤ í¬ì¸íŠ¸ê°€ ì§€ê¸‰ë  í™•ë¥ ì´ ë†’ìŠµë‹ˆë‹¤!"
        ]
        socketio.emit('message', {'msg': random.choice(news_list), 'type': 'system'}, room='main')

# --- [3. íŠ¹ìˆ˜ ê¸°ëŠ¥ ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 1
        reward = 5000
        update_money(nick, reward, bank=True)
        pattern = f"ğŸŒ€ [{nick}] ë‡Œì ˆ ë™ë ¥ ê°€ë™ ì¤‘... (+{reward}â‚© ì…ê¸ˆ)"
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"{pattern}\në¬´í•œ ë£¨í”„ íšŸìˆ˜: {m_count}íšŒì°¨", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3)

def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [4. ë¼ìš°íŒ… ë° ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸš€ {data['nickname']}ë‹˜ì´ ë©€í‹°ë²„ìŠ¤ ì„œë²„ì— ì ‘ì†í–ˆìŠµë‹ˆë‹¤!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ìˆ˜ìµ ê³µì‹]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ [ëŒ€ìš©ëŸ‰ ë°ì´í„° ë³€í™˜]\nê¸¸ì´: {msg_len}ì\në³´ìƒ: {reward}â‚© ì ë¦½ ì™„ë£Œ\nğŸ”— íŒŒì¼ ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ ì²˜ë¦¬]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        total = user['money'] + user['bank_money']
        res = f"ğŸ’° {nick}ë‹˜ì˜ ìì‚° ë³´ê³ ì„œ\n" \
              f"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" \
              f"ğŸ’µ í˜„ê¸ˆ: {user['money']:,}â‚©\n" \
              f"ğŸ¦ ì€í–‰: {user['bank_money']:,}â‚©\n" \
              f"ğŸ’³ ì´í•©: {total:,}â‚©\n" \
              f"ğŸ† ë“±ê¸‰: {'ì´ˆì›”ì' if total >= 10000000 else 'VIP' if total >= 1000000 else 'í‰ë¯¼'}"
        emit('message', {'msg': res, 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt:,}â‚©ì„ ì€í–‰ì— ì•ˆì „í•˜ê²Œ ë³´ê´€í–ˆìŠµë‹ˆë‹¤. (ë¶„ë‹¹ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ ì€í–‰ì—ì„œ {amt:,}â‚©ì„ ì¶œê¸ˆí–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ì´ ê°€ë™ë˜ì—ˆìŠµë‹ˆë‹¤! (3ì´ˆë‹¹ 5000â‚©)", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆ ì—”ì§„ì„ ì •ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            prompt = " ".join(cmd_parts[1:])
            res = client.models.generate_content(model="gemini-2.0-flash", contents=prompt)
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except Exception as e:
            emit('message', {'msg': f"âŒ ì—ëŸ¬: {str(e)}", 'type': 'system'})

    elif cmd == "!ëª…ë ¹ì–´":
        help_msg = "ğŸ“œ [ëª…ë ¹ì–´ ë¦¬ìŠ¤íŠ¸]\n!ì”ì•¡ - ë‚´ ìì‚° í™•ì¸\n!ì €ê¸ˆ [ì•¡ìˆ˜] - ì€í–‰ì— ì…ê¸ˆ\n!ì¶œê¸ˆ [ì•¡ìˆ˜] - í˜„ê¸ˆí™”\n!ë‡Œì ˆ - ë¬´í•œ ëˆ ë²Œê¸° ì‹œì‘\n!ë‡Œì ˆì¤‘ë‹¨ - ì¤‘ì§€\n!gemini [ì§ˆë¬¸] - AI ë‹µë³€\n!ëª…ë ¹ì–´ - ë„ì›€ë§"
        emit('message', {'msg': help_msg, 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ…
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=background_scheduler, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
import random
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í™˜ê²½] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "multiverse_empire.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {}

# Gemini AI í´ë¼ì´ì–¸íŠ¸ ì„¤ì •
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key:
        client = genai.Client(api_key=api_key)
except:
    print("Gemini SDKê°€ ì—†ê±°ë‚˜ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. !gemini ê¸°ëŠ¥ì€ ë¹„í™œì„±í™”ë©ë‹ˆë‹¤.")

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("""
            CREATE TABLE IF NOT EXISTS users (
                nickname TEXT PRIMARY KEY, 
                money INTEGER DEFAULT 1000, 
                bank_money INTEGER DEFAULT 0
            )
        """)
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ë° ë‰´ìŠ¤ ì‹œìŠ¤í…œ]
def background_scheduler():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤ ì‹¤í–‰
        with sqlite3.connect(DB_FILE) as conn:
            # 1. ì´ì ì§€ê¸‰ (1%)
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()
        
        # 2. ì‹¤ì‹œê°„ ê²½ì œ ë‰´ìŠ¤ ì´ë²¤íŠ¸
        news_list = [
            "ğŸ“¢ [ê²½ì œ] ì œêµ­ ì€í–‰ì˜ ê¸ˆë¦¬ê°€ ìƒìŠ¹ ì¡°ì§ì„ ë³´ì…ë‹ˆë‹¤!",
            "ğŸ“¢ [ì†Œì‹] ëŒ€ê·œëª¨ ë‡Œì ˆ ì—ë„ˆì§€ê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ì±„êµ´ íš¨ìœ¨ì´ ì¦ê°€í•©ë‹ˆë‹¤.",
            "ğŸ“¢ [ê³µì§€] í˜„ì¬ ìµœê³  ë¶€ìëŠ” 'ì´ˆì›”ì' ë“±ê¸‰ì„ ìœ ì§€í•˜ê³  ìˆìŠµë‹ˆë‹¤.",
            "ğŸ“¢ [ì´ë²¤íŠ¸] ì§€ê¸ˆ ì±„íŒ…ì„ ì…ë ¥í•˜ë©´ ë³´ë„ˆìŠ¤ í¬ì¸íŠ¸ê°€ ì§€ê¸‰ë  í™•ë¥ ì´ ë†’ìŠµë‹ˆë‹¤!"
        ]
        socketio.emit('message', {'msg': random.choice(news_list), 'type': 'system'}, room='main')

# --- [3. íŠ¹ìˆ˜ ê¸°ëŠ¥ ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 1
        reward = 5000
        update_money(nick, reward, bank=True)
        pattern = f"ğŸŒ€ [{nick}] ë‡Œì ˆ ë™ë ¥ ê°€ë™ ì¤‘... (+{reward}â‚© ì…ê¸ˆ)"
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"{pattern}\në¬´í•œ ë£¨í”„ íšŸìˆ˜: {m_count}íšŒì°¨", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3)

def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [4. ë¼ìš°íŒ… ë° ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸš€ {data['nickname']}ë‹˜ì´ ë©€í‹°ë²„ìŠ¤ ì„œë²„ì— ì ‘ì†í–ˆìŠµë‹ˆë‹¤!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ìˆ˜ìµ ê³µì‹]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ [ëŒ€ìš©ëŸ‰ ë°ì´í„° ë³€í™˜]\nê¸¸ì´: {msg_len}ì\në³´ìƒ: {reward}â‚© ì ë¦½ ì™„ë£Œ\nğŸ”— íŒŒì¼ ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ ì²˜ë¦¬]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        total = user['money'] + user['bank_money']
        res = f"ğŸ’° {nick}ë‹˜ì˜ ìì‚° ë³´ê³ ì„œ\n" \
              f"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" \
              f"ğŸ’µ í˜„ê¸ˆ: {user['money']:,}â‚©\n" \
              f"ğŸ¦ ì€í–‰: {user['bank_money']:,}â‚©\n" \
              f"ğŸ’³ ì´í•©: {total:,}â‚©\n" \
              f"ğŸ† ë“±ê¸‰: {'ì´ˆì›”ì' if total >= 10000000 else 'VIP' if total >= 1000000 else 'í‰ë¯¼'}"
        emit('message', {'msg': res, 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt:,}â‚©ì„ ì€í–‰ì— ì•ˆì „í•˜ê²Œ ë³´ê´€í–ˆìŠµë‹ˆë‹¤. (ë¶„ë‹¹ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ ì€í–‰ì—ì„œ {amt:,}â‚©ì„ ì¶œê¸ˆí–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ì´ ê°€ë™ë˜ì—ˆìŠµë‹ˆë‹¤! (3ì´ˆë‹¹ 5000â‚©)", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆ ì—”ì§„ì„ ì •ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            prompt = " ".join(cmd_parts[1:])
            res = client.models.generate_content(model="gemini-2.0-flash", contents=prompt)
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except Exception as e:
            emit('message', {'msg': f"âŒ ì—ëŸ¬: {str(e)}", 'type': 'system'})

    elif cmd == "!ëª…ë ¹ì–´":
        help_msg = "ğŸ“œ [ëª…ë ¹ì–´ ë¦¬ìŠ¤íŠ¸]\n!ì”ì•¡ - ë‚´ ìì‚° í™•ì¸\n!ì €ê¸ˆ [ì•¡ìˆ˜] - ì€í–‰ì— ì…ê¸ˆ\n!ì¶œê¸ˆ [ì•¡ìˆ˜] - í˜„ê¸ˆí™”\n!ë‡Œì ˆ - ë¬´í•œ ëˆ ë²Œê¸° ì‹œì‘\n!ë‡Œì ˆì¤‘ë‹¨ - ì¤‘ì§€\n!gemini [ì§ˆë¬¸] - AI ë‹µë³€\n!ëª…ë ¹ì–´ - ë„ì›€ë§"
        emit('message', {'msg': help_msg, 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ…
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=background_scheduler, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
import random
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í™˜ê²½] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "multiverse_empire.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {}

# Gemini AI í´ë¼ì´ì–¸íŠ¸ ì„¤ì •
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key:
        client = genai.Client(api_key=api_key)
except:
    print("Gemini SDKê°€ ì—†ê±°ë‚˜ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. !gemini ê¸°ëŠ¥ì€ ë¹„í™œì„±í™”ë©ë‹ˆë‹¤.")

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("""
            CREATE TABLE IF NOT EXISTS users (
                nickname TEXT PRIMARY KEY, 
                money INTEGER DEFAULT 1000, 
                bank_money INTEGER DEFAULT 0
            )
        """)
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ë° ë‰´ìŠ¤ ì‹œìŠ¤í…œ]
def background_scheduler():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤ ì‹¤í–‰
        with sqlite3.connect(DB_FILE) as conn:
            # 1. ì´ì ì§€ê¸‰ (1%)
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()
        
        # 2. ì‹¤ì‹œê°„ ê²½ì œ ë‰´ìŠ¤ ì´ë²¤íŠ¸
        news_list = [
            "ğŸ“¢ [ê²½ì œ] ì œêµ­ ì€í–‰ì˜ ê¸ˆë¦¬ê°€ ìƒìŠ¹ ì¡°ì§ì„ ë³´ì…ë‹ˆë‹¤!",
            "ğŸ“¢ [ì†Œì‹] ëŒ€ê·œëª¨ ë‡Œì ˆ ì—ë„ˆì§€ê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ì±„êµ´ íš¨ìœ¨ì´ ì¦ê°€í•©ë‹ˆë‹¤.",
            "ğŸ“¢ [ê³µì§€] í˜„ì¬ ìµœê³  ë¶€ìëŠ” 'ì´ˆì›”ì' ë“±ê¸‰ì„ ìœ ì§€í•˜ê³  ìˆìŠµë‹ˆë‹¤.",
            "ğŸ“¢ [ì´ë²¤íŠ¸] ì§€ê¸ˆ ì±„íŒ…ì„ ì…ë ¥í•˜ë©´ ë³´ë„ˆìŠ¤ í¬ì¸íŠ¸ê°€ ì§€ê¸‰ë  í™•ë¥ ì´ ë†’ìŠµë‹ˆë‹¤!"
        ]
        socketio.emit('message', {'msg': random.choice(news_list), 'type': 'system'}, room='main')

# --- [3. íŠ¹ìˆ˜ ê¸°ëŠ¥ ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 1
        reward = 5000
        update_money(nick, reward, bank=True)
        pattern = f"ğŸŒ€ [{nick}] ë‡Œì ˆ ë™ë ¥ ê°€ë™ ì¤‘... (+{reward}â‚© ì…ê¸ˆ)"
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"{pattern}\në¬´í•œ ë£¨í”„ íšŸìˆ˜: {m_count}íšŒì°¨", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3)

def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [4. ë¼ìš°íŒ… ë° ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸš€ {data['nickname']}ë‹˜ì´ ë©€í‹°ë²„ìŠ¤ ì„œë²„ì— ì ‘ì†í–ˆìŠµë‹ˆë‹¤!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ìˆ˜ìµ ê³µì‹]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ [ëŒ€ìš©ëŸ‰ ë°ì´í„° ë³€í™˜]\nê¸¸ì´: {msg_len}ì\në³´ìƒ: {reward}â‚© ì ë¦½ ì™„ë£Œ\nğŸ”— íŒŒì¼ ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ ì²˜ë¦¬]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        total = user['money'] + user['bank_money']
        res = f"ğŸ’° {nick}ë‹˜ì˜ ìì‚° ë³´ê³ ì„œ\n" \
              f"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" \
              f"ğŸ’µ í˜„ê¸ˆ: {user['money']:,}â‚©\n" \
              f"ğŸ¦ ì€í–‰: {user['bank_money']:,}â‚©\n" \
              f"ğŸ’³ ì´í•©: {total:,}â‚©\n" \
              f"ğŸ† ë“±ê¸‰: {'ì´ˆì›”ì' if total >= 10000000 else 'VIP' if total >= 1000000 else 'í‰ë¯¼'}"
        emit('message', {'msg': res, 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt:,}â‚©ì„ ì€í–‰ì— ì•ˆì „í•˜ê²Œ ë³´ê´€í–ˆìŠµë‹ˆë‹¤. (ë¶„ë‹¹ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ ì€í–‰ì—ì„œ {amt:,}â‚©ì„ ì¶œê¸ˆí–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ì´ ê°€ë™ë˜ì—ˆìŠµë‹ˆë‹¤! (3ì´ˆë‹¹ 5000â‚©)", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆ ì—”ì§„ì„ ì •ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            prompt = " ".join(cmd_parts[1:])
            res = client.models.generate_content(model="gemini-2.0-flash", contents=prompt)
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except Exception as e:
            emit('message', {'msg': f"âŒ ì—ëŸ¬: {str(e)}", 'type': 'system'})

    elif cmd == "!ëª…ë ¹ì–´":
        help_msg = "ğŸ“œ [ëª…ë ¹ì–´ ë¦¬ìŠ¤íŠ¸]\n!ì”ì•¡ - ë‚´ ìì‚° í™•ì¸\n!ì €ê¸ˆ [ì•¡ìˆ˜] - ì€í–‰ì— ì…ê¸ˆ\n!ì¶œê¸ˆ [ì•¡ìˆ˜] - í˜„ê¸ˆí™”\n!ë‡Œì ˆ - ë¬´í•œ ëˆ ë²Œê¸° ì‹œì‘\n!ë‡Œì ˆì¤‘ë‹¨ - ì¤‘ì§€\n!gemini [ì§ˆë¬¸] - AI ë‹µë³€\n!ëª…ë ¹ì–´ - ë„ì›€ë§"
        emit('message', {'msg': help_msg, 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ…
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=background_scheduler, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
import random
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í™˜ê²½] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "multiverse_empire.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {}

# Gemini AI í´ë¼ì´ì–¸íŠ¸ ì„¤ì •
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key:
        client = genai.Client(api_key=api_key)
except:
    print("Gemini SDKê°€ ì—†ê±°ë‚˜ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. !gemini ê¸°ëŠ¥ì€ ë¹„í™œì„±í™”ë©ë‹ˆë‹¤.")

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("""
            CREATE TABLE IF NOT EXISTS users (
                nickname TEXT PRIMARY KEY, 
                money INTEGER DEFAULT 1000, 
                bank_money INTEGER DEFAULT 0
            )
        """)
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ë° ë‰´ìŠ¤ ì‹œìŠ¤í…œ]
def background_scheduler():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤ ì‹¤í–‰
        with sqlite3.connect(DB_FILE) as conn:
            # 1. ì´ì ì§€ê¸‰ (1%)
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()
        
        # 2. ì‹¤ì‹œê°„ ê²½ì œ ë‰´ìŠ¤ ì´ë²¤íŠ¸
        news_list = [
            "ğŸ“¢ [ê²½ì œ] ì œêµ­ ì€í–‰ì˜ ê¸ˆë¦¬ê°€ ìƒìŠ¹ ì¡°ì§ì„ ë³´ì…ë‹ˆë‹¤!",
            "ğŸ“¢ [ì†Œì‹] ëŒ€ê·œëª¨ ë‡Œì ˆ ì—ë„ˆì§€ê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ì±„êµ´ íš¨ìœ¨ì´ ì¦ê°€í•©ë‹ˆë‹¤.",
            "ğŸ“¢ [ê³µì§€] í˜„ì¬ ìµœê³  ë¶€ìëŠ” 'ì´ˆì›”ì' ë“±ê¸‰ì„ ìœ ì§€í•˜ê³  ìˆìŠµë‹ˆë‹¤.",
            "ğŸ“¢ [ì´ë²¤íŠ¸] ì§€ê¸ˆ ì±„íŒ…ì„ ì…ë ¥í•˜ë©´ ë³´ë„ˆìŠ¤ í¬ì¸íŠ¸ê°€ ì§€ê¸‰ë  í™•ë¥ ì´ ë†’ìŠµë‹ˆë‹¤!"
        ]
        socketio.emit('message', {'msg': random.choice(news_list), 'type': 'system'}, room='main')

# --- [3. íŠ¹ìˆ˜ ê¸°ëŠ¥ ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 1
        reward = 5000
        update_money(nick, reward, bank=True)
        pattern = f"ğŸŒ€ [{nick}] ë‡Œì ˆ ë™ë ¥ ê°€ë™ ì¤‘... (+{reward}â‚© ì…ê¸ˆ)"
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"{pattern}\në¬´í•œ ë£¨í”„ íšŸìˆ˜: {m_count}íšŒì°¨", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3)

def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [4. ë¼ìš°íŒ… ë° ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸš€ {data['nickname']}ë‹˜ì´ ë©€í‹°ë²„ìŠ¤ ì„œë²„ì— ì ‘ì†í–ˆìŠµë‹ˆë‹¤!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ìˆ˜ìµ ê³µì‹]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ [ëŒ€ìš©ëŸ‰ ë°ì´í„° ë³€í™˜]\nê¸¸ì´: {msg_len}ì\në³´ìƒ: {reward}â‚© ì ë¦½ ì™„ë£Œ\nğŸ”— íŒŒì¼ ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ ì²˜ë¦¬]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        total = user['money'] + user['bank_money']
        res = f"ğŸ’° {nick}ë‹˜ì˜ ìì‚° ë³´ê³ ì„œ\n" \
              f"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" \
              f"ğŸ’µ í˜„ê¸ˆ: {user['money']:,}â‚©\n" \
              f"ğŸ¦ ì€í–‰: {user['bank_money']:,}â‚©\n" \
              f"ğŸ’³ ì´í•©: {total:,}â‚©\n" \
              f"ğŸ† ë“±ê¸‰: {'ì´ˆì›”ì' if total >= 10000000 else 'VIP' if total >= 1000000 else 'í‰ë¯¼'}"
        emit('message', {'msg': res, 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt:,}â‚©ì„ ì€í–‰ì— ì•ˆì „í•˜ê²Œ ë³´ê´€í–ˆìŠµë‹ˆë‹¤. (ë¶„ë‹¹ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ ì€í–‰ì—ì„œ {amt:,}â‚©ì„ ì¶œê¸ˆí–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ì´ ê°€ë™ë˜ì—ˆìŠµë‹ˆë‹¤! (3ì´ˆë‹¹ 5000â‚©)", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆ ì—”ì§„ì„ ì •ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            prompt = " ".join(cmd_parts[1:])
            res = client.models.generate_content(model="gemini-2.0-flash", contents=prompt)
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except Exception as e:
            emit('message', {'msg': f"âŒ ì—ëŸ¬: {str(e)}", 'type': 'system'})

    elif cmd == "!ëª…ë ¹ì–´":
        help_msg = "ğŸ“œ [ëª…ë ¹ì–´ ë¦¬ìŠ¤íŠ¸]\n!ì”ì•¡ - ë‚´ ìì‚° í™•ì¸\n!ì €ê¸ˆ [ì•¡ìˆ˜] - ì€í–‰ì— ì…ê¸ˆ\n!ì¶œê¸ˆ [ì•¡ìˆ˜] - í˜„ê¸ˆí™”\n!ë‡Œì ˆ - ë¬´í•œ ëˆ ë²Œê¸° ì‹œì‘\n!ë‡Œì ˆì¤‘ë‹¨ - ì¤‘ì§€\n!gemini [ì§ˆë¬¸] - AI ë‹µë³€\n!ëª…ë ¹ì–´ - ë„ì›€ë§"
        emit('message', {'msg': help_msg, 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ…
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=background_scheduler, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
import random
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í™˜ê²½] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "multiverse_empire.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {}

# Gemini AI í´ë¼ì´ì–¸íŠ¸ ì„¤ì •
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key:
        client = genai.Client(api_key=api_key)
except:
    print("Gemini SDKê°€ ì—†ê±°ë‚˜ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. !gemini ê¸°ëŠ¥ì€ ë¹„í™œì„±í™”ë©ë‹ˆë‹¤.")

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("""
            CREATE TABLE IF NOT EXISTS users (
                nickname TEXT PRIMARY KEY, 
                money INTEGER DEFAULT 1000, 
                bank_money INTEGER DEFAULT 0
            )
        """)
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ë° ë‰´ìŠ¤ ì‹œìŠ¤í…œ]
def background_scheduler():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤ ì‹¤í–‰
        with sqlite3.connect(DB_FILE) as conn:
            # 1. ì´ì ì§€ê¸‰ (1%)
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()
        
        # 2. ì‹¤ì‹œê°„ ê²½ì œ ë‰´ìŠ¤ ì´ë²¤íŠ¸
        news_list = [
            "ğŸ“¢ [ê²½ì œ] ì œêµ­ ì€í–‰ì˜ ê¸ˆë¦¬ê°€ ìƒìŠ¹ ì¡°ì§ì„ ë³´ì…ë‹ˆë‹¤!",
            "ğŸ“¢ [ì†Œì‹] ëŒ€ê·œëª¨ ë‡Œì ˆ ì—ë„ˆì§€ê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ì±„êµ´ íš¨ìœ¨ì´ ì¦ê°€í•©ë‹ˆë‹¤.",
            "ğŸ“¢ [ê³µì§€] í˜„ì¬ ìµœê³  ë¶€ìëŠ” 'ì´ˆì›”ì' ë“±ê¸‰ì„ ìœ ì§€í•˜ê³  ìˆìŠµë‹ˆë‹¤.",
            "ğŸ“¢ [ì´ë²¤íŠ¸] ì§€ê¸ˆ ì±„íŒ…ì„ ì…ë ¥í•˜ë©´ ë³´ë„ˆìŠ¤ í¬ì¸íŠ¸ê°€ ì§€ê¸‰ë  í™•ë¥ ì´ ë†’ìŠµë‹ˆë‹¤!"
        ]
        socketio.emit('message', {'msg': random.choice(news_list), 'type': 'system'}, room='main')

# --- [3. íŠ¹ìˆ˜ ê¸°ëŠ¥ ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 1
        reward = 5000
        update_money(nick, reward, bank=True)
        pattern = f"ğŸŒ€ [{nick}] ë‡Œì ˆ ë™ë ¥ ê°€ë™ ì¤‘... (+{reward}â‚© ì…ê¸ˆ)"
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"{pattern}\në¬´í•œ ë£¨í”„ íšŸìˆ˜: {m_count}íšŒì°¨", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3)

def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [4. ë¼ìš°íŒ… ë° ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸš€ {data['nickname']}ë‹˜ì´ ë©€í‹°ë²„ìŠ¤ ì„œë²„ì— ì ‘ì†í–ˆìŠµë‹ˆë‹¤!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ìˆ˜ìµ ê³µì‹]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ [ëŒ€ìš©ëŸ‰ ë°ì´í„° ë³€í™˜]\nê¸¸ì´: {msg_len}ì\në³´ìƒ: {reward}â‚© ì ë¦½ ì™„ë£Œ\nğŸ”— íŒŒì¼ ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ ì²˜ë¦¬]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        total = user['money'] + user['bank_money']
        res = f"ğŸ’° {nick}ë‹˜ì˜ ìì‚° ë³´ê³ ì„œ\n" \
              f"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" \
              f"ğŸ’µ í˜„ê¸ˆ: {user['money']:,}â‚©\n" \
              f"ğŸ¦ ì€í–‰: {user['bank_money']:,}â‚©\n" \
              f"ğŸ’³ ì´í•©: {total:,}â‚©\n" \
              f"ğŸ† ë“±ê¸‰: {'ì´ˆì›”ì' if total >= 10000000 else 'VIP' if total >= 1000000 else 'í‰ë¯¼'}"
        emit('message', {'msg': res, 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt:,}â‚©ì„ ì€í–‰ì— ì•ˆì „í•˜ê²Œ ë³´ê´€í–ˆìŠµë‹ˆë‹¤. (ë¶„ë‹¹ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ ì€í–‰ì—ì„œ {amt:,}â‚©ì„ ì¶œê¸ˆí–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ì´ ê°€ë™ë˜ì—ˆìŠµë‹ˆë‹¤! (3ì´ˆë‹¹ 5000â‚©)", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆ ì—”ì§„ì„ ì •ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            prompt = " ".join(cmd_parts[1:])
            res = client.models.generate_content(model="gemini-2.0-flash", contents=prompt)
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except Exception as e:
            emit('message', {'msg': f"âŒ ì—ëŸ¬: {str(e)}", 'type': 'system'})

    elif cmd == "!ëª…ë ¹ì–´":
        help_msg = "ğŸ“œ [ëª…ë ¹ì–´ ë¦¬ìŠ¤íŠ¸]\n!ì”ì•¡ - ë‚´ ìì‚° í™•ì¸\n!ì €ê¸ˆ [ì•¡ìˆ˜] - ì€í–‰ì— ì…ê¸ˆ\n!ì¶œê¸ˆ [ì•¡ìˆ˜] - í˜„ê¸ˆí™”\n!ë‡Œì ˆ - ë¬´í•œ ëˆ ë²Œê¸° ì‹œì‘\n!ë‡Œì ˆì¤‘ë‹¨ - ì¤‘ì§€\n!gemini [ì§ˆë¬¸] - AI ë‹µë³€\n!ëª…ë ¹ì–´ - ë„ì›€ë§"
        emit('message', {'msg': help_msg, 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ…
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=background_scheduler, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
import random
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í™˜ê²½] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "multiverse_empire.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {}

# Gemini AI í´ë¼ì´ì–¸íŠ¸ ì„¤ì •
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key:
        client = genai.Client(api_key=api_key)
except:
    print("Gemini SDKê°€ ì—†ê±°ë‚˜ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. !gemini ê¸°ëŠ¥ì€ ë¹„í™œì„±í™”ë©ë‹ˆë‹¤.")

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("""
            CREATE TABLE IF NOT EXISTS users (
                nickname TEXT PRIMARY KEY, 
                money INTEGER DEFAULT 1000, 
                bank_money INTEGER DEFAULT 0
            )
        """)
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ë° ë‰´ìŠ¤ ì‹œìŠ¤í…œ]
def background_scheduler():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤ ì‹¤í–‰
        with sqlite3.connect(DB_FILE) as conn:
            # 1. ì´ì ì§€ê¸‰ (1%)
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()
        
        # 2. ì‹¤ì‹œê°„ ê²½ì œ ë‰´ìŠ¤ ì´ë²¤íŠ¸
        news_list = [
            "ğŸ“¢ [ê²½ì œ] ì œêµ­ ì€í–‰ì˜ ê¸ˆë¦¬ê°€ ìƒìŠ¹ ì¡°ì§ì„ ë³´ì…ë‹ˆë‹¤!",
            "ğŸ“¢ [ì†Œì‹] ëŒ€ê·œëª¨ ë‡Œì ˆ ì—ë„ˆì§€ê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ì±„êµ´ íš¨ìœ¨ì´ ì¦ê°€í•©ë‹ˆë‹¤.",
            "ğŸ“¢ [ê³µì§€] í˜„ì¬ ìµœê³  ë¶€ìëŠ” 'ì´ˆì›”ì' ë“±ê¸‰ì„ ìœ ì§€í•˜ê³  ìˆìŠµë‹ˆë‹¤.",
            "ğŸ“¢ [ì´ë²¤íŠ¸] ì§€ê¸ˆ ì±„íŒ…ì„ ì…ë ¥í•˜ë©´ ë³´ë„ˆìŠ¤ í¬ì¸íŠ¸ê°€ ì§€ê¸‰ë  í™•ë¥ ì´ ë†’ìŠµë‹ˆë‹¤!"
        ]
        socketio.emit('message', {'msg': random.choice(news_list), 'type': 'system'}, room='main')

# --- [3. íŠ¹ìˆ˜ ê¸°ëŠ¥ ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 1
        reward = 5000
        update_money(nick, reward, bank=True)
        pattern = f"ğŸŒ€ [{nick}] ë‡Œì ˆ ë™ë ¥ ê°€ë™ ì¤‘... (+{reward}â‚© ì…ê¸ˆ)"
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"{pattern}\në¬´í•œ ë£¨í”„ íšŸìˆ˜: {m_count}íšŒì°¨", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3)

def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [4. ë¼ìš°íŒ… ë° ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸš€ {data['nickname']}ë‹˜ì´ ë©€í‹°ë²„ìŠ¤ ì„œë²„ì— ì ‘ì†í–ˆìŠµë‹ˆë‹¤!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ìˆ˜ìµ ê³µì‹]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ [ëŒ€ìš©ëŸ‰ ë°ì´í„° ë³€í™˜]\nê¸¸ì´: {msg_len}ì\në³´ìƒ: {reward}â‚© ì ë¦½ ì™„ë£Œ\nğŸ”— íŒŒì¼ ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ ì²˜ë¦¬]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        total = user['money'] + user['bank_money']
        res = f"ğŸ’° {nick}ë‹˜ì˜ ìì‚° ë³´ê³ ì„œ\n" \
              f"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" \
              f"ğŸ’µ í˜„ê¸ˆ: {user['money']:,}â‚©\n" \
              f"ğŸ¦ ì€í–‰: {user['bank_money']:,}â‚©\n" \
              f"ğŸ’³ ì´í•©: {total:,}â‚©\n" \
              f"ğŸ† ë“±ê¸‰: {'ì´ˆì›”ì' if total >= 10000000 else 'VIP' if total >= 1000000 else 'í‰ë¯¼'}"
        emit('message', {'msg': res, 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt:,}â‚©ì„ ì€í–‰ì— ì•ˆì „í•˜ê²Œ ë³´ê´€í–ˆìŠµë‹ˆë‹¤. (ë¶„ë‹¹ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ ì€í–‰ì—ì„œ {amt:,}â‚©ì„ ì¶œê¸ˆí–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ì´ ê°€ë™ë˜ì—ˆìŠµë‹ˆë‹¤! (3ì´ˆë‹¹ 5000â‚©)", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆ ì—”ì§„ì„ ì •ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            prompt = " ".join(cmd_parts[1:])
            res = client.models.generate_content(model="gemini-2.0-flash", contents=prompt)
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except Exception as e:
            emit('message', {'msg': f"âŒ ì—ëŸ¬: {str(e)}", 'type': 'system'})

    elif cmd == "!ëª…ë ¹ì–´":
        help_msg = "ğŸ“œ [ëª…ë ¹ì–´ ë¦¬ìŠ¤íŠ¸]\n!ì”ì•¡ - ë‚´ ìì‚° í™•ì¸\n!ì €ê¸ˆ [ì•¡ìˆ˜] - ì€í–‰ì— ì…ê¸ˆ\n!ì¶œê¸ˆ [ì•¡ìˆ˜] - í˜„ê¸ˆí™”\n!ë‡Œì ˆ - ë¬´í•œ ëˆ ë²Œê¸° ì‹œì‘\n!ë‡Œì ˆì¤‘ë‹¨ - ì¤‘ì§€\n!gemini [ì§ˆë¬¸] - AI ë‹µë³€\n!ëª…ë ¹ì–´ - ë„ì›€ë§"
        emit('message', {'msg': help_msg, 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ…
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=background_scheduler, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
import random
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í™˜ê²½] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "multiverse_empire.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {}

# Gemini AI í´ë¼ì´ì–¸íŠ¸ ì„¤ì •
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key:
        client = genai.Client(api_key=api_key)
except:
    print("Gemini SDKê°€ ì—†ê±°ë‚˜ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. !gemini ê¸°ëŠ¥ì€ ë¹„í™œì„±í™”ë©ë‹ˆë‹¤.")

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("""
            CREATE TABLE IF NOT EXISTS users (
                nickname TEXT PRIMARY KEY, 
                money INTEGER DEFAULT 1000, 
                bank_money INTEGER DEFAULT 0
            )
        """)
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ë° ë‰´ìŠ¤ ì‹œìŠ¤í…œ]
def background_scheduler():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤ ì‹¤í–‰
        with sqlite3.connect(DB_FILE) as conn:
            # 1. ì´ì ì§€ê¸‰ (1%)
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()
        
        # 2. ì‹¤ì‹œê°„ ê²½ì œ ë‰´ìŠ¤ ì´ë²¤íŠ¸
        news_list = [
            "ğŸ“¢ [ê²½ì œ] ì œêµ­ ì€í–‰ì˜ ê¸ˆë¦¬ê°€ ìƒìŠ¹ ì¡°ì§ì„ ë³´ì…ë‹ˆë‹¤!",
            "ğŸ“¢ [ì†Œì‹] ëŒ€ê·œëª¨ ë‡Œì ˆ ì—ë„ˆì§€ê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ì±„êµ´ íš¨ìœ¨ì´ ì¦ê°€í•©ë‹ˆë‹¤.",
            "ğŸ“¢ [ê³µì§€] í˜„ì¬ ìµœê³  ë¶€ìëŠ” 'ì´ˆì›”ì' ë“±ê¸‰ì„ ìœ ì§€í•˜ê³  ìˆìŠµë‹ˆë‹¤.",
            "ğŸ“¢ [ì´ë²¤íŠ¸] ì§€ê¸ˆ ì±„íŒ…ì„ ì…ë ¥í•˜ë©´ ë³´ë„ˆìŠ¤ í¬ì¸íŠ¸ê°€ ì§€ê¸‰ë  í™•ë¥ ì´ ë†’ìŠµë‹ˆë‹¤!"
        ]
        socketio.emit('message', {'msg': random.choice(news_list), 'type': 'system'}, room='main')

# --- [3. íŠ¹ìˆ˜ ê¸°ëŠ¥ ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 1
        reward = 5000
        update_money(nick, reward, bank=True)
        pattern = f"ğŸŒ€ [{nick}] ë‡Œì ˆ ë™ë ¥ ê°€ë™ ì¤‘... (+{reward}â‚© ì…ê¸ˆ)"
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"{pattern}\në¬´í•œ ë£¨í”„ íšŸìˆ˜: {m_count}íšŒì°¨", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3)

def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [4. ë¼ìš°íŒ… ë° ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸš€ {data['nickname']}ë‹˜ì´ ë©€í‹°ë²„ìŠ¤ ì„œë²„ì— ì ‘ì†í–ˆìŠµë‹ˆë‹¤!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ìˆ˜ìµ ê³µì‹]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ [ëŒ€ìš©ëŸ‰ ë°ì´í„° ë³€í™˜]\nê¸¸ì´: {msg_len}ì\në³´ìƒ: {reward}â‚© ì ë¦½ ì™„ë£Œ\nğŸ”— íŒŒì¼ ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ ì²˜ë¦¬]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        total = user['money'] + user['bank_money']
        res = f"ğŸ’° {nick}ë‹˜ì˜ ìì‚° ë³´ê³ ì„œ\n" \
              f"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" \
              f"ğŸ’µ í˜„ê¸ˆ: {user['money']:,}â‚©\n" \
              f"ğŸ¦ ì€í–‰: {user['bank_money']:,}â‚©\n" \
              f"ğŸ’³ ì´í•©: {total:,}â‚©\n" \
              f"ğŸ† ë“±ê¸‰: {'ì´ˆì›”ì' if total >= 10000000 else 'VIP' if total >= 1000000 else 'í‰ë¯¼'}"
        emit('message', {'msg': res, 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt:,}â‚©ì„ ì€í–‰ì— ì•ˆì „í•˜ê²Œ ë³´ê´€í–ˆìŠµë‹ˆë‹¤. (ë¶„ë‹¹ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ ì€í–‰ì—ì„œ {amt:,}â‚©ì„ ì¶œê¸ˆí–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ì´ ê°€ë™ë˜ì—ˆìŠµë‹ˆë‹¤! (3ì´ˆë‹¹ 5000â‚©)", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆ ì—”ì§„ì„ ì •ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            prompt = " ".join(cmd_parts[1:])
            res = client.models.generate_content(model="gemini-2.0-flash", contents=prompt)
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except Exception as e:
            emit('message', {'msg': f"âŒ ì—ëŸ¬: {str(e)}", 'type': 'system'})

    elif cmd == "!ëª…ë ¹ì–´":
        help_msg = "ğŸ“œ [ëª…ë ¹ì–´ ë¦¬ìŠ¤íŠ¸]\n!ì”ì•¡ - ë‚´ ìì‚° í™•ì¸\n!ì €ê¸ˆ [ì•¡ìˆ˜] - ì€í–‰ì— ì…ê¸ˆ\n!ì¶œê¸ˆ [ì•¡ìˆ˜] - í˜„ê¸ˆí™”\n!ë‡Œì ˆ - ë¬´í•œ ëˆ ë²Œê¸° ì‹œì‘\n!ë‡Œì ˆì¤‘ë‹¨ - ì¤‘ì§€\n!gemini [ì§ˆë¬¸] - AI ë‹µë³€\n!ëª…ë ¹ì–´ - ë„ì›€ë§"
        emit('message', {'msg': help_msg, 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ…
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=background_scheduler, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
import random
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í™˜ê²½] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "multiverse_empire.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {}

# Gemini AI í´ë¼ì´ì–¸íŠ¸ ì„¤ì •
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key:
        client = genai.Client(api_key=api_key)
except:
    print("Gemini SDKê°€ ì—†ê±°ë‚˜ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. !gemini ê¸°ëŠ¥ì€ ë¹„í™œì„±í™”ë©ë‹ˆë‹¤.")

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("""
            CREATE TABLE IF NOT EXISTS users (
                nickname TEXT PRIMARY KEY, 
                money INTEGER DEFAULT 1000, 
                bank_money INTEGER DEFAULT 0
            )
        """)
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ë° ë‰´ìŠ¤ ì‹œìŠ¤í…œ]
def background_scheduler():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤ ì‹¤í–‰
        with sqlite3.connect(DB_FILE) as conn:
            # 1. ì´ì ì§€ê¸‰ (1%)
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()
        
        # 2. ì‹¤ì‹œê°„ ê²½ì œ ë‰´ìŠ¤ ì´ë²¤íŠ¸
        news_list = [
            "ğŸ“¢ [ê²½ì œ] ì œêµ­ ì€í–‰ì˜ ê¸ˆë¦¬ê°€ ìƒìŠ¹ ì¡°ì§ì„ ë³´ì…ë‹ˆë‹¤!",
            "ğŸ“¢ [ì†Œì‹] ëŒ€ê·œëª¨ ë‡Œì ˆ ì—ë„ˆì§€ê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ì±„êµ´ íš¨ìœ¨ì´ ì¦ê°€í•©ë‹ˆë‹¤.",
            "ğŸ“¢ [ê³µì§€] í˜„ì¬ ìµœê³  ë¶€ìëŠ” 'ì´ˆì›”ì' ë“±ê¸‰ì„ ìœ ì§€í•˜ê³  ìˆìŠµë‹ˆë‹¤.",
            "ğŸ“¢ [ì´ë²¤íŠ¸] ì§€ê¸ˆ ì±„íŒ…ì„ ì…ë ¥í•˜ë©´ ë³´ë„ˆìŠ¤ í¬ì¸íŠ¸ê°€ ì§€ê¸‰ë  í™•ë¥ ì´ ë†’ìŠµë‹ˆë‹¤!"
        ]
        socketio.emit('message', {'msg': random.choice(news_list), 'type': 'system'}, room='main')

# --- [3. íŠ¹ìˆ˜ ê¸°ëŠ¥ ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 1
        reward = 5000
        update_money(nick, reward, bank=True)
        pattern = f"ğŸŒ€ [{nick}] ë‡Œì ˆ ë™ë ¥ ê°€ë™ ì¤‘... (+{reward}â‚© ì…ê¸ˆ)"
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"{pattern}\në¬´í•œ ë£¨í”„ íšŸìˆ˜: {m_count}íšŒì°¨", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3)

def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [4. ë¼ìš°íŒ… ë° ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸš€ {data['nickname']}ë‹˜ì´ ë©€í‹°ë²„ìŠ¤ ì„œë²„ì— ì ‘ì†í–ˆìŠµë‹ˆë‹¤!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ìˆ˜ìµ ê³µì‹]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ [ëŒ€ìš©ëŸ‰ ë°ì´í„° ë³€í™˜]\nê¸¸ì´: {msg_len}ì\në³´ìƒ: {reward}â‚© ì ë¦½ ì™„ë£Œ\nğŸ”— íŒŒì¼ ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ ì²˜ë¦¬]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        total = user['money'] + user['bank_money']
        res = f"ğŸ’° {nick}ë‹˜ì˜ ìì‚° ë³´ê³ ì„œ\n" \
              f"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" \
              f"ğŸ’µ í˜„ê¸ˆ: {user['money']:,}â‚©\n" \
              f"ğŸ¦ ì€í–‰: {user['bank_money']:,}â‚©\n" \
              f"ğŸ’³ ì´í•©: {total:,}â‚©\n" \
              f"ğŸ† ë“±ê¸‰: {'ì´ˆì›”ì' if total >= 10000000 else 'VIP' if total >= 1000000 else 'í‰ë¯¼'}"
        emit('message', {'msg': res, 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt:,}â‚©ì„ ì€í–‰ì— ì•ˆì „í•˜ê²Œ ë³´ê´€í–ˆìŠµë‹ˆë‹¤. (ë¶„ë‹¹ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ ì€í–‰ì—ì„œ {amt:,}â‚©ì„ ì¶œê¸ˆí–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ì´ ê°€ë™ë˜ì—ˆìŠµë‹ˆë‹¤! (3ì´ˆë‹¹ 5000â‚©)", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆ ì—”ì§„ì„ ì •ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            prompt = " ".join(cmd_parts[1:])
            res = client.models.generate_content(model="gemini-2.0-flash", contents=prompt)
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except Exception as e:
            emit('message', {'msg': f"âŒ ì—ëŸ¬: {str(e)}", 'type': 'system'})

    elif cmd == "!ëª…ë ¹ì–´":
        help_msg = "ğŸ“œ [ëª…ë ¹ì–´ ë¦¬ìŠ¤íŠ¸]\n!ì”ì•¡ - ë‚´ ìì‚° í™•ì¸\n!ì €ê¸ˆ [ì•¡ìˆ˜] - ì€í–‰ì— ì…ê¸ˆ\n!ì¶œê¸ˆ [ì•¡ìˆ˜] - í˜„ê¸ˆí™”\n!ë‡Œì ˆ - ë¬´í•œ ëˆ ë²Œê¸° ì‹œì‘\n!ë‡Œì ˆì¤‘ë‹¨ - ì¤‘ì§€\n!gemini [ì§ˆë¬¸] - AI ë‹µë³€\n!ëª…ë ¹ì–´ - ë„ì›€ë§"
        emit('message', {'msg': help_msg, 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ…
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=background_scheduler, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
import random
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í™˜ê²½] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "multiverse_empire.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {}

# Gemini AI í´ë¼ì´ì–¸íŠ¸ ì„¤ì •
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key:
        client = genai.Client(api_key=api_key)
except:
    print("Gemini SDKê°€ ì—†ê±°ë‚˜ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. !gemini ê¸°ëŠ¥ì€ ë¹„í™œì„±í™”ë©ë‹ˆë‹¤.")

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("""
            CREATE TABLE IF NOT EXISTS users (
                nickname TEXT PRIMARY KEY, 
                money INTEGER DEFAULT 1000, 
                bank_money INTEGER DEFAULT 0
            )
        """)
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ë° ë‰´ìŠ¤ ì‹œìŠ¤í…œ]
def background_scheduler():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤ ì‹¤í–‰
        with sqlite3.connect(DB_FILE) as conn:
            # 1. ì´ì ì§€ê¸‰ (1%)
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()
        
        # 2. ì‹¤ì‹œê°„ ê²½ì œ ë‰´ìŠ¤ ì´ë²¤íŠ¸
        news_list = [
            "ğŸ“¢ [ê²½ì œ] ì œêµ­ ì€í–‰ì˜ ê¸ˆë¦¬ê°€ ìƒìŠ¹ ì¡°ì§ì„ ë³´ì…ë‹ˆë‹¤!",
            "ğŸ“¢ [ì†Œì‹] ëŒ€ê·œëª¨ ë‡Œì ˆ ì—ë„ˆì§€ê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ì±„êµ´ íš¨ìœ¨ì´ ì¦ê°€í•©ë‹ˆë‹¤.",
            "ğŸ“¢ [ê³µì§€] í˜„ì¬ ìµœê³  ë¶€ìëŠ” 'ì´ˆì›”ì' ë“±ê¸‰ì„ ìœ ì§€í•˜ê³  ìˆìŠµë‹ˆë‹¤.",
            "ğŸ“¢ [ì´ë²¤íŠ¸] ì§€ê¸ˆ ì±„íŒ…ì„ ì…ë ¥í•˜ë©´ ë³´ë„ˆìŠ¤ í¬ì¸íŠ¸ê°€ ì§€ê¸‰ë  í™•ë¥ ì´ ë†’ìŠµë‹ˆë‹¤!"
        ]
        socketio.emit('message', {'msg': random.choice(news_list), 'type': 'system'}, room='main')

# --- [3. íŠ¹ìˆ˜ ê¸°ëŠ¥ ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 1
        reward = 5000
        update_money(nick, reward, bank=True)
        pattern = f"ğŸŒ€ [{nick}] ë‡Œì ˆ ë™ë ¥ ê°€ë™ ì¤‘... (+{reward}â‚© ì…ê¸ˆ)"
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"{pattern}\në¬´í•œ ë£¨í”„ íšŸìˆ˜: {m_count}íšŒì°¨", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3)

def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [4. ë¼ìš°íŒ… ë° ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸš€ {data['nickname']}ë‹˜ì´ ë©€í‹°ë²„ìŠ¤ ì„œë²„ì— ì ‘ì†í–ˆìŠµë‹ˆë‹¤!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ìˆ˜ìµ ê³µì‹]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ [ëŒ€ìš©ëŸ‰ ë°ì´í„° ë³€í™˜]\nê¸¸ì´: {msg_len}ì\në³´ìƒ: {reward}â‚© ì ë¦½ ì™„ë£Œ\nğŸ”— íŒŒì¼ ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ ì²˜ë¦¬]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        total = user['money'] + user['bank_money']
        res = f"ğŸ’° {nick}ë‹˜ì˜ ìì‚° ë³´ê³ ì„œ\n" \
              f"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" \
              f"ğŸ’µ í˜„ê¸ˆ: {user['money']:,}â‚©\n" \
              f"ğŸ¦ ì€í–‰: {user['bank_money']:,}â‚©\n" \
              f"ğŸ’³ ì´í•©: {total:,}â‚©\n" \
              f"ğŸ† ë“±ê¸‰: {'ì´ˆì›”ì' if total >= 10000000 else 'VIP' if total >= 1000000 else 'í‰ë¯¼'}"
        emit('message', {'msg': res, 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt:,}â‚©ì„ ì€í–‰ì— ì•ˆì „í•˜ê²Œ ë³´ê´€í–ˆìŠµë‹ˆë‹¤. (ë¶„ë‹¹ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ ì€í–‰ì—ì„œ {amt:,}â‚©ì„ ì¶œê¸ˆí–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ì´ ê°€ë™ë˜ì—ˆìŠµë‹ˆë‹¤! (3ì´ˆë‹¹ 5000â‚©)", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆ ì—”ì§„ì„ ì •ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            prompt = " ".join(cmd_parts[1:])
            res = client.models.generate_content(model="gemini-2.0-flash", contents=prompt)
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except Exception as e:
            emit('message', {'msg': f"âŒ ì—ëŸ¬: {str(e)}", 'type': 'system'})

    elif cmd == "!ëª…ë ¹ì–´":
        help_msg = "ğŸ“œ [ëª…ë ¹ì–´ ë¦¬ìŠ¤íŠ¸]\n!ì”ì•¡ - ë‚´ ìì‚° í™•ì¸\n!ì €ê¸ˆ [ì•¡ìˆ˜] - ì€í–‰ì— ì…ê¸ˆ\n!ì¶œê¸ˆ [ì•¡ìˆ˜] - í˜„ê¸ˆí™”\n!ë‡Œì ˆ - ë¬´í•œ ëˆ ë²Œê¸° ì‹œì‘\n!ë‡Œì ˆì¤‘ë‹¨ - ì¤‘ì§€\n!gemini [ì§ˆë¬¸] - AI ë‹µë³€\n!ëª…ë ¹ì–´ - ë„ì›€ë§"
        emit('message', {'msg': help_msg, 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ…
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=background_scheduler, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
import random
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í™˜ê²½] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "multiverse_empire.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {}

# Gemini AI í´ë¼ì´ì–¸íŠ¸ ì„¤ì •
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key:
        client = genai.Client(api_key=api_key)
except:
    print("Gemini SDKê°€ ì—†ê±°ë‚˜ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. !gemini ê¸°ëŠ¥ì€ ë¹„í™œì„±í™”ë©ë‹ˆë‹¤.")

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("""
            CREATE TABLE IF NOT EXISTS users (
                nickname TEXT PRIMARY KEY, 
                money INTEGER DEFAULT 1000, 
                bank_money INTEGER DEFAULT 0
            )
        """)
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ë° ë‰´ìŠ¤ ì‹œìŠ¤í…œ]
def background_scheduler():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤ ì‹¤í–‰
        with sqlite3.connect(DB_FILE) as conn:
            # 1. ì´ì ì§€ê¸‰ (1%)
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()
        
        # 2. ì‹¤ì‹œê°„ ê²½ì œ ë‰´ìŠ¤ ì´ë²¤íŠ¸
        news_list = [
            "ğŸ“¢ [ê²½ì œ] ì œêµ­ ì€í–‰ì˜ ê¸ˆë¦¬ê°€ ìƒìŠ¹ ì¡°ì§ì„ ë³´ì…ë‹ˆë‹¤!",
            "ğŸ“¢ [ì†Œì‹] ëŒ€ê·œëª¨ ë‡Œì ˆ ì—ë„ˆì§€ê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ì±„êµ´ íš¨ìœ¨ì´ ì¦ê°€í•©ë‹ˆë‹¤.",
            "ğŸ“¢ [ê³µì§€] í˜„ì¬ ìµœê³  ë¶€ìëŠ” 'ì´ˆì›”ì' ë“±ê¸‰ì„ ìœ ì§€í•˜ê³  ìˆìŠµë‹ˆë‹¤.",
            "ğŸ“¢ [ì´ë²¤íŠ¸] ì§€ê¸ˆ ì±„íŒ…ì„ ì…ë ¥í•˜ë©´ ë³´ë„ˆìŠ¤ í¬ì¸íŠ¸ê°€ ì§€ê¸‰ë  í™•ë¥ ì´ ë†’ìŠµë‹ˆë‹¤!"
        ]
        socketio.emit('message', {'msg': random.choice(news_list), 'type': 'system'}, room='main')

# --- [3. íŠ¹ìˆ˜ ê¸°ëŠ¥ ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 1
        reward = 5000
        update_money(nick, reward, bank=True)
        pattern = f"ğŸŒ€ [{nick}] ë‡Œì ˆ ë™ë ¥ ê°€ë™ ì¤‘... (+{reward}â‚© ì…ê¸ˆ)"
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"{pattern}\në¬´í•œ ë£¨í”„ íšŸìˆ˜: {m_count}íšŒì°¨", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3)

def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [4. ë¼ìš°íŒ… ë° ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸš€ {data['nickname']}ë‹˜ì´ ë©€í‹°ë²„ìŠ¤ ì„œë²„ì— ì ‘ì†í–ˆìŠµë‹ˆë‹¤!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ìˆ˜ìµ ê³µì‹]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ [ëŒ€ìš©ëŸ‰ ë°ì´í„° ë³€í™˜]\nê¸¸ì´: {msg_len}ì\në³´ìƒ: {reward}â‚© ì ë¦½ ì™„ë£Œ\nğŸ”— íŒŒì¼ ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ ì²˜ë¦¬]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        total = user['money'] + user['bank_money']
        res = f"ğŸ’° {nick}ë‹˜ì˜ ìì‚° ë³´ê³ ì„œ\n" \
              f"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" \
              f"ğŸ’µ í˜„ê¸ˆ: {user['money']:,}â‚©\n" \
              f"ğŸ¦ ì€í–‰: {user['bank_money']:,}â‚©\n" \
              f"ğŸ’³ ì´í•©: {total:,}â‚©\n" \
              f"ğŸ† ë“±ê¸‰: {'ì´ˆì›”ì' if total >= 10000000 else 'VIP' if total >= 1000000 else 'í‰ë¯¼'}"
        emit('message', {'msg': res, 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt:,}â‚©ì„ ì€í–‰ì— ì•ˆì „í•˜ê²Œ ë³´ê´€í–ˆìŠµë‹ˆë‹¤. (ë¶„ë‹¹ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ ì€í–‰ì—ì„œ {amt:,}â‚©ì„ ì¶œê¸ˆí–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ì´ ê°€ë™ë˜ì—ˆìŠµë‹ˆë‹¤! (3ì´ˆë‹¹ 5000â‚©)", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆ ì—”ì§„ì„ ì •ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            prompt = " ".join(cmd_parts[1:])
            res = client.models.generate_content(model="gemini-2.0-flash", contents=prompt)
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except Exception as e:
            emit('message', {'msg': f"âŒ ì—ëŸ¬: {str(e)}", 'type': 'system'})

    elif cmd == "!ëª…ë ¹ì–´":
        help_msg = "ğŸ“œ [ëª…ë ¹ì–´ ë¦¬ìŠ¤íŠ¸]\n!ì”ì•¡ - ë‚´ ìì‚° í™•ì¸\n!ì €ê¸ˆ [ì•¡ìˆ˜] - ì€í–‰ì— ì…ê¸ˆ\n!ì¶œê¸ˆ [ì•¡ìˆ˜] - í˜„ê¸ˆí™”\n!ë‡Œì ˆ - ë¬´í•œ ëˆ ë²Œê¸° ì‹œì‘\n!ë‡Œì ˆì¤‘ë‹¨ - ì¤‘ì§€\n!gemini [ì§ˆë¬¸] - AI ë‹µë³€\n!ëª…ë ¹ì–´ - ë„ì›€ë§"
        emit('message', {'msg': help_msg, 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ…
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=background_scheduler, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
import random
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í™˜ê²½] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "multiverse_empire.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {}

# Gemini AI í´ë¼ì´ì–¸íŠ¸ ì„¤ì •
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key:
        client = genai.Client(api_key=api_key)
except:
    print("Gemini SDKê°€ ì—†ê±°ë‚˜ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. !gemini ê¸°ëŠ¥ì€ ë¹„í™œì„±í™”ë©ë‹ˆë‹¤.")

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("""
            CREATE TABLE IF NOT EXISTS users (
                nickname TEXT PRIMARY KEY, 
                money INTEGER DEFAULT 1000, 
                bank_money INTEGER DEFAULT 0
            )
        """)
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ë° ë‰´ìŠ¤ ì‹œìŠ¤í…œ]
def background_scheduler():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤ ì‹¤í–‰
        with sqlite3.connect(DB_FILE) as conn:
            # 1. ì´ì ì§€ê¸‰ (1%)
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()
        
        # 2. ì‹¤ì‹œê°„ ê²½ì œ ë‰´ìŠ¤ ì´ë²¤íŠ¸
        news_list = [
            "ğŸ“¢ [ê²½ì œ] ì œêµ­ ì€í–‰ì˜ ê¸ˆë¦¬ê°€ ìƒìŠ¹ ì¡°ì§ì„ ë³´ì…ë‹ˆë‹¤!",
            "ğŸ“¢ [ì†Œì‹] ëŒ€ê·œëª¨ ë‡Œì ˆ ì—ë„ˆì§€ê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ì±„êµ´ íš¨ìœ¨ì´ ì¦ê°€í•©ë‹ˆë‹¤.",
            "ğŸ“¢ [ê³µì§€] í˜„ì¬ ìµœê³  ë¶€ìëŠ” 'ì´ˆì›”ì' ë“±ê¸‰ì„ ìœ ì§€í•˜ê³  ìˆìŠµë‹ˆë‹¤.",
            "ğŸ“¢ [ì´ë²¤íŠ¸] ì§€ê¸ˆ ì±„íŒ…ì„ ì…ë ¥í•˜ë©´ ë³´ë„ˆìŠ¤ í¬ì¸íŠ¸ê°€ ì§€ê¸‰ë  í™•ë¥ ì´ ë†’ìŠµë‹ˆë‹¤!"
        ]
        socketio.emit('message', {'msg': random.choice(news_list), 'type': 'system'}, room='main')

# --- [3. íŠ¹ìˆ˜ ê¸°ëŠ¥ ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 1
        reward = 5000
        update_money(nick, reward, bank=True)
        pattern = f"ğŸŒ€ [{nick}] ë‡Œì ˆ ë™ë ¥ ê°€ë™ ì¤‘... (+{reward}â‚© ì…ê¸ˆ)"
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"{pattern}\në¬´í•œ ë£¨í”„ íšŸìˆ˜: {m_count}íšŒì°¨", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3)

def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [4. ë¼ìš°íŒ… ë° ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸš€ {data['nickname']}ë‹˜ì´ ë©€í‹°ë²„ìŠ¤ ì„œë²„ì— ì ‘ì†í–ˆìŠµë‹ˆë‹¤!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ìˆ˜ìµ ê³µì‹]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ [ëŒ€ìš©ëŸ‰ ë°ì´í„° ë³€í™˜]\nê¸¸ì´: {msg_len}ì\në³´ìƒ: {reward}â‚© ì ë¦½ ì™„ë£Œ\nğŸ”— íŒŒì¼ ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ ì²˜ë¦¬]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        total = user['money'] + user['bank_money']
        res = f"ğŸ’° {nick}ë‹˜ì˜ ìì‚° ë³´ê³ ì„œ\n" \
              f"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" \
              f"ğŸ’µ í˜„ê¸ˆ: {user['money']:,}â‚©\n" \
              f"ğŸ¦ ì€í–‰: {user['bank_money']:,}â‚©\n" \
              f"ğŸ’³ ì´í•©: {total:,}â‚©\n" \
              f"ğŸ† ë“±ê¸‰: {'ì´ˆì›”ì' if total >= 10000000 else 'VIP' if total >= 1000000 else 'í‰ë¯¼'}"
        emit('message', {'msg': res, 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt:,}â‚©ì„ ì€í–‰ì— ì•ˆì „í•˜ê²Œ ë³´ê´€í–ˆìŠµë‹ˆë‹¤. (ë¶„ë‹¹ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ ì€í–‰ì—ì„œ {amt:,}â‚©ì„ ì¶œê¸ˆí–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ì´ ê°€ë™ë˜ì—ˆìŠµë‹ˆë‹¤! (3ì´ˆë‹¹ 5000â‚©)", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆ ì—”ì§„ì„ ì •ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            prompt = " ".join(cmd_parts[1:])
            res = client.models.generate_content(model="gemini-2.0-flash", contents=prompt)
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except Exception as e:
            emit('message', {'msg': f"âŒ ì—ëŸ¬: {str(e)}", 'type': 'system'})

    elif cmd == "!ëª…ë ¹ì–´":
        help_msg = "ğŸ“œ [ëª…ë ¹ì–´ ë¦¬ìŠ¤íŠ¸]\n!ì”ì•¡ - ë‚´ ìì‚° í™•ì¸\n!ì €ê¸ˆ [ì•¡ìˆ˜] - ì€í–‰ì— ì…ê¸ˆ\n!ì¶œê¸ˆ [ì•¡ìˆ˜] - í˜„ê¸ˆí™”\n!ë‡Œì ˆ - ë¬´í•œ ëˆ ë²Œê¸° ì‹œì‘\n!ë‡Œì ˆì¤‘ë‹¨ - ì¤‘ì§€\n!gemini [ì§ˆë¬¸] - AI ë‹µë³€\n!ëª…ë ¹ì–´ - ë„ì›€ë§"
        emit('message', {'msg': help_msg, 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ…
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=background_scheduler, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
import random
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í™˜ê²½] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "multiverse_empire.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {}

# Gemini AI í´ë¼ì´ì–¸íŠ¸ ì„¤ì •
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key:
        client = genai.Client(api_key=api_key)
except:
    print("Gemini SDKê°€ ì—†ê±°ë‚˜ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. !gemini ê¸°ëŠ¥ì€ ë¹„í™œì„±í™”ë©ë‹ˆë‹¤.")

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("""
            CREATE TABLE IF NOT EXISTS users (
                nickname TEXT PRIMARY KEY, 
                money INTEGER DEFAULT 1000, 
                bank_money INTEGER DEFAULT 0
            )
        """)
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ë° ë‰´ìŠ¤ ì‹œìŠ¤í…œ]
def background_scheduler():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤ ì‹¤í–‰
        with sqlite3.connect(DB_FILE) as conn:
            # 1. ì´ì ì§€ê¸‰ (1%)
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()
        
        # 2. ì‹¤ì‹œê°„ ê²½ì œ ë‰´ìŠ¤ ì´ë²¤íŠ¸
        news_list = [
            "ğŸ“¢ [ê²½ì œ] ì œêµ­ ì€í–‰ì˜ ê¸ˆë¦¬ê°€ ìƒìŠ¹ ì¡°ì§ì„ ë³´ì…ë‹ˆë‹¤!",
            "ğŸ“¢ [ì†Œì‹] ëŒ€ê·œëª¨ ë‡Œì ˆ ì—ë„ˆì§€ê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ì±„êµ´ íš¨ìœ¨ì´ ì¦ê°€í•©ë‹ˆë‹¤.",
            "ğŸ“¢ [ê³µì§€] í˜„ì¬ ìµœê³  ë¶€ìëŠ” 'ì´ˆì›”ì' ë“±ê¸‰ì„ ìœ ì§€í•˜ê³  ìˆìŠµë‹ˆë‹¤.",
            "ğŸ“¢ [ì´ë²¤íŠ¸] ì§€ê¸ˆ ì±„íŒ…ì„ ì…ë ¥í•˜ë©´ ë³´ë„ˆìŠ¤ í¬ì¸íŠ¸ê°€ ì§€ê¸‰ë  í™•ë¥ ì´ ë†’ìŠµë‹ˆë‹¤!"
        ]
        socketio.emit('message', {'msg': random.choice(news_list), 'type': 'system'}, room='main')

# --- [3. íŠ¹ìˆ˜ ê¸°ëŠ¥ ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 1
        reward = 5000
        update_money(nick, reward, bank=True)
        pattern = f"ğŸŒ€ [{nick}] ë‡Œì ˆ ë™ë ¥ ê°€ë™ ì¤‘... (+{reward}â‚© ì…ê¸ˆ)"
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"{pattern}\në¬´í•œ ë£¨í”„ íšŸìˆ˜: {m_count}íšŒì°¨", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3)

def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [4. ë¼ìš°íŒ… ë° ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸš€ {data['nickname']}ë‹˜ì´ ë©€í‹°ë²„ìŠ¤ ì„œë²„ì— ì ‘ì†í–ˆìŠµë‹ˆë‹¤!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ìˆ˜ìµ ê³µì‹]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ [ëŒ€ìš©ëŸ‰ ë°ì´í„° ë³€í™˜]\nê¸¸ì´: {msg_len}ì\në³´ìƒ: {reward}â‚© ì ë¦½ ì™„ë£Œ\nğŸ”— íŒŒì¼ ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ ì²˜ë¦¬]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        total = user['money'] + user['bank_money']
        res = f"ğŸ’° {nick}ë‹˜ì˜ ìì‚° ë³´ê³ ì„œ\n" \
              f"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" \
              f"ğŸ’µ í˜„ê¸ˆ: {user['money']:,}â‚©\n" \
              f"ğŸ¦ ì€í–‰: {user['bank_money']:,}â‚©\n" \
              f"ğŸ’³ ì´í•©: {total:,}â‚©\n" \
              f"ğŸ† ë“±ê¸‰: {'ì´ˆì›”ì' if total >= 10000000 else 'VIP' if total >= 1000000 else 'í‰ë¯¼'}"
        emit('message', {'msg': res, 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt:,}â‚©ì„ ì€í–‰ì— ì•ˆì „í•˜ê²Œ ë³´ê´€í–ˆìŠµë‹ˆë‹¤. (ë¶„ë‹¹ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ ì€í–‰ì—ì„œ {amt:,}â‚©ì„ ì¶œê¸ˆí–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ì´ ê°€ë™ë˜ì—ˆìŠµë‹ˆë‹¤! (3ì´ˆë‹¹ 5000â‚©)", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆ ì—”ì§„ì„ ì •ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            prompt = " ".join(cmd_parts[1:])
            res = client.models.generate_content(model="gemini-2.0-flash", contents=prompt)
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except Exception as e:
            emit('message', {'msg': f"âŒ ì—ëŸ¬: {str(e)}", 'type': 'system'})

    elif cmd == "!ëª…ë ¹ì–´":
        help_msg = "ğŸ“œ [ëª…ë ¹ì–´ ë¦¬ìŠ¤íŠ¸]\n!ì”ì•¡ - ë‚´ ìì‚° í™•ì¸\n!ì €ê¸ˆ [ì•¡ìˆ˜] - ì€í–‰ì— ì…ê¸ˆ\n!ì¶œê¸ˆ [ì•¡ìˆ˜] - í˜„ê¸ˆí™”\n!ë‡Œì ˆ - ë¬´í•œ ëˆ ë²Œê¸° ì‹œì‘\n!ë‡Œì ˆì¤‘ë‹¨ - ì¤‘ì§€\n!gemini [ì§ˆë¬¸] - AI ë‹µë³€\n!ëª…ë ¹ì–´ - ë„ì›€ë§"
        emit('message', {'msg': help_msg, 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ…
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=background_scheduler, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
import random
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í™˜ê²½] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "multiverse_empire.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {}

# Gemini AI í´ë¼ì´ì–¸íŠ¸ ì„¤ì •
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key:
        client = genai.Client(api_key=api_key)
except:
    print("Gemini SDKê°€ ì—†ê±°ë‚˜ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. !gemini ê¸°ëŠ¥ì€ ë¹„í™œì„±í™”ë©ë‹ˆë‹¤.")

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("""
            CREATE TABLE IF NOT EXISTS users (
                nickname TEXT PRIMARY KEY, 
                money INTEGER DEFAULT 1000, 
                bank_money INTEGER DEFAULT 0
            )
        """)
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ë° ë‰´ìŠ¤ ì‹œìŠ¤í…œ]
def background_scheduler():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤ ì‹¤í–‰
        with sqlite3.connect(DB_FILE) as conn:
            # 1. ì´ì ì§€ê¸‰ (1%)
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()
        
        # 2. ì‹¤ì‹œê°„ ê²½ì œ ë‰´ìŠ¤ ì´ë²¤íŠ¸
        news_list = [
            "ğŸ“¢ [ê²½ì œ] ì œêµ­ ì€í–‰ì˜ ê¸ˆë¦¬ê°€ ìƒìŠ¹ ì¡°ì§ì„ ë³´ì…ë‹ˆë‹¤!",
            "ğŸ“¢ [ì†Œì‹] ëŒ€ê·œëª¨ ë‡Œì ˆ ì—ë„ˆì§€ê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ì±„êµ´ íš¨ìœ¨ì´ ì¦ê°€í•©ë‹ˆë‹¤.",
            "ğŸ“¢ [ê³µì§€] í˜„ì¬ ìµœê³  ë¶€ìëŠ” 'ì´ˆì›”ì' ë“±ê¸‰ì„ ìœ ì§€í•˜ê³  ìˆìŠµë‹ˆë‹¤.",
            "ğŸ“¢ [ì´ë²¤íŠ¸] ì§€ê¸ˆ ì±„íŒ…ì„ ì…ë ¥í•˜ë©´ ë³´ë„ˆìŠ¤ í¬ì¸íŠ¸ê°€ ì§€ê¸‰ë  í™•ë¥ ì´ ë†’ìŠµë‹ˆë‹¤!"
        ]
        socketio.emit('message', {'msg': random.choice(news_list), 'type': 'system'}, room='main')

# --- [3. íŠ¹ìˆ˜ ê¸°ëŠ¥ ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 1
        reward = 5000
        update_money(nick, reward, bank=True)
        pattern = f"ğŸŒ€ [{nick}] ë‡Œì ˆ ë™ë ¥ ê°€ë™ ì¤‘... (+{reward}â‚© ì…ê¸ˆ)"
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"{pattern}\në¬´í•œ ë£¨í”„ íšŸìˆ˜: {m_count}íšŒì°¨", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3)

def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [4. ë¼ìš°íŒ… ë° ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸš€ {data['nickname']}ë‹˜ì´ ë©€í‹°ë²„ìŠ¤ ì„œë²„ì— ì ‘ì†í–ˆìŠµë‹ˆë‹¤!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ìˆ˜ìµ ê³µì‹]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ [ëŒ€ìš©ëŸ‰ ë°ì´í„° ë³€í™˜]\nê¸¸ì´: {msg_len}ì\në³´ìƒ: {reward}â‚© ì ë¦½ ì™„ë£Œ\nğŸ”— íŒŒì¼ ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ ì²˜ë¦¬]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        total = user['money'] + user['bank_money']
        res = f"ğŸ’° {nick}ë‹˜ì˜ ìì‚° ë³´ê³ ì„œ\n" \
              f"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" \
              f"ğŸ’µ í˜„ê¸ˆ: {user['money']:,}â‚©\n" \
              f"ğŸ¦ ì€í–‰: {user['bank_money']:,}â‚©\n" \
              f"ğŸ’³ ì´í•©: {total:,}â‚©\n" \
              f"ğŸ† ë“±ê¸‰: {'ì´ˆì›”ì' if total >= 10000000 else 'VIP' if total >= 1000000 else 'í‰ë¯¼'}"
        emit('message', {'msg': res, 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt:,}â‚©ì„ ì€í–‰ì— ì•ˆì „í•˜ê²Œ ë³´ê´€í–ˆìŠµë‹ˆë‹¤. (ë¶„ë‹¹ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ ì€í–‰ì—ì„œ {amt:,}â‚©ì„ ì¶œê¸ˆí–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ì´ ê°€ë™ë˜ì—ˆìŠµë‹ˆë‹¤! (3ì´ˆë‹¹ 5000â‚©)", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆ ì—”ì§„ì„ ì •ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            prompt = " ".join(cmd_parts[1:])
            res = client.models.generate_content(model="gemini-2.0-flash", contents=prompt)
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except Exception as e:
            emit('message', {'msg': f"âŒ ì—ëŸ¬: {str(e)}", 'type': 'system'})

    elif cmd == "!ëª…ë ¹ì–´":
        help_msg = "ğŸ“œ [ëª…ë ¹ì–´ ë¦¬ìŠ¤íŠ¸]\n!ì”ì•¡ - ë‚´ ìì‚° í™•ì¸\n!ì €ê¸ˆ [ì•¡ìˆ˜] - ì€í–‰ì— ì…ê¸ˆ\n!ì¶œê¸ˆ [ì•¡ìˆ˜] - í˜„ê¸ˆí™”\n!ë‡Œì ˆ - ë¬´í•œ ëˆ ë²Œê¸° ì‹œì‘\n!ë‡Œì ˆì¤‘ë‹¨ - ì¤‘ì§€\n!gemini [ì§ˆë¬¸] - AI ë‹µë³€\n!ëª…ë ¹ì–´ - ë„ì›€ë§"
        emit('message', {'msg': help_msg, 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ…
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=background_scheduler, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
import random
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í™˜ê²½] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "multiverse_empire.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {}

# Gemini AI í´ë¼ì´ì–¸íŠ¸ ì„¤ì •
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key:
        client = genai.Client(api_key=api_key)
except:
    print("Gemini SDKê°€ ì—†ê±°ë‚˜ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. !gemini ê¸°ëŠ¥ì€ ë¹„í™œì„±í™”ë©ë‹ˆë‹¤.")

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("""
            CREATE TABLE IF NOT EXISTS users (
                nickname TEXT PRIMARY KEY, 
                money INTEGER DEFAULT 1000, 
                bank_money INTEGER DEFAULT 0
            )
        """)
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ë° ë‰´ìŠ¤ ì‹œìŠ¤í…œ]
def background_scheduler():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤ ì‹¤í–‰
        with sqlite3.connect(DB_FILE) as conn:
            # 1. ì´ì ì§€ê¸‰ (1%)
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()
        
        # 2. ì‹¤ì‹œê°„ ê²½ì œ ë‰´ìŠ¤ ì´ë²¤íŠ¸
        news_list = [
            "ğŸ“¢ [ê²½ì œ] ì œêµ­ ì€í–‰ì˜ ê¸ˆë¦¬ê°€ ìƒìŠ¹ ì¡°ì§ì„ ë³´ì…ë‹ˆë‹¤!",
            "ğŸ“¢ [ì†Œì‹] ëŒ€ê·œëª¨ ë‡Œì ˆ ì—ë„ˆì§€ê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ì±„êµ´ íš¨ìœ¨ì´ ì¦ê°€í•©ë‹ˆë‹¤.",
            "ğŸ“¢ [ê³µì§€] í˜„ì¬ ìµœê³  ë¶€ìëŠ” 'ì´ˆì›”ì' ë“±ê¸‰ì„ ìœ ì§€í•˜ê³  ìˆìŠµë‹ˆë‹¤.",
            "ğŸ“¢ [ì´ë²¤íŠ¸] ì§€ê¸ˆ ì±„íŒ…ì„ ì…ë ¥í•˜ë©´ ë³´ë„ˆìŠ¤ í¬ì¸íŠ¸ê°€ ì§€ê¸‰ë  í™•ë¥ ì´ ë†’ìŠµë‹ˆë‹¤!"
        ]
        socketio.emit('message', {'msg': random.choice(news_list), 'type': 'system'}, room='main')

# --- [3. íŠ¹ìˆ˜ ê¸°ëŠ¥ ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 1
        reward = 5000
        update_money(nick, reward, bank=True)
        pattern = f"ğŸŒ€ [{nick}] ë‡Œì ˆ ë™ë ¥ ê°€ë™ ì¤‘... (+{reward}â‚© ì…ê¸ˆ)"
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"{pattern}\në¬´í•œ ë£¨í”„ íšŸìˆ˜: {m_count}íšŒì°¨", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3)

def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [4. ë¼ìš°íŒ… ë° ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸš€ {data['nickname']}ë‹˜ì´ ë©€í‹°ë²„ìŠ¤ ì„œë²„ì— ì ‘ì†í–ˆìŠµë‹ˆë‹¤!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ìˆ˜ìµ ê³µì‹]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ [ëŒ€ìš©ëŸ‰ ë°ì´í„° ë³€í™˜]\nê¸¸ì´: {msg_len}ì\në³´ìƒ: {reward}â‚© ì ë¦½ ì™„ë£Œ\nğŸ”— íŒŒì¼ ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ ì²˜ë¦¬]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        total = user['money'] + user['bank_money']
        res = f"ğŸ’° {nick}ë‹˜ì˜ ìì‚° ë³´ê³ ì„œ\n" \
              f"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" \
              f"ğŸ’µ í˜„ê¸ˆ: {user['money']:,}â‚©\n" \
              f"ğŸ¦ ì€í–‰: {user['bank_money']:,}â‚©\n" \
              f"ğŸ’³ ì´í•©: {total:,}â‚©\n" \
              f"ğŸ† ë“±ê¸‰: {'ì´ˆì›”ì' if total >= 10000000 else 'VIP' if total >= 1000000 else 'í‰ë¯¼'}"
        emit('message', {'msg': res, 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt:,}â‚©ì„ ì€í–‰ì— ì•ˆì „í•˜ê²Œ ë³´ê´€í–ˆìŠµë‹ˆë‹¤. (ë¶„ë‹¹ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ ì€í–‰ì—ì„œ {amt:,}â‚©ì„ ì¶œê¸ˆí–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ì´ ê°€ë™ë˜ì—ˆìŠµë‹ˆë‹¤! (3ì´ˆë‹¹ 5000â‚©)", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆ ì—”ì§„ì„ ì •ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            prompt = " ".join(cmd_parts[1:])
            res = client.models.generate_content(model="gemini-2.0-flash", contents=prompt)
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except Exception as e:
            emit('message', {'msg': f"âŒ ì—ëŸ¬: {str(e)}", 'type': 'system'})

    elif cmd == "!ëª…ë ¹ì–´":
        help_msg = "ğŸ“œ [ëª…ë ¹ì–´ ë¦¬ìŠ¤íŠ¸]\n!ì”ì•¡ - ë‚´ ìì‚° í™•ì¸\n!ì €ê¸ˆ [ì•¡ìˆ˜] - ì€í–‰ì— ì…ê¸ˆ\n!ì¶œê¸ˆ [ì•¡ìˆ˜] - í˜„ê¸ˆí™”\n!ë‡Œì ˆ - ë¬´í•œ ëˆ ë²Œê¸° ì‹œì‘\n!ë‡Œì ˆì¤‘ë‹¨ - ì¤‘ì§€\n!gemini [ì§ˆë¬¸] - AI ë‹µë³€\n!ëª…ë ¹ì–´ - ë„ì›€ë§"
        emit('message', {'msg': help_msg, 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ…
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=background_scheduler, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
import random
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í™˜ê²½] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "multiverse_empire.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {}

# Gemini AI í´ë¼ì´ì–¸íŠ¸ ì„¤ì •
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key:
        client = genai.Client(api_key=api_key)
except:
    print("Gemini SDKê°€ ì—†ê±°ë‚˜ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. !gemini ê¸°ëŠ¥ì€ ë¹„í™œì„±í™”ë©ë‹ˆë‹¤.")

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("""
            CREATE TABLE IF NOT EXISTS users (
                nickname TEXT PRIMARY KEY, 
                money INTEGER DEFAULT 1000, 
                bank_money INTEGER DEFAULT 0
            )
        """)
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ë° ë‰´ìŠ¤ ì‹œìŠ¤í…œ]
def background_scheduler():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤ ì‹¤í–‰
        with sqlite3.connect(DB_FILE) as conn:
            # 1. ì´ì ì§€ê¸‰ (1%)
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()
        
        # 2. ì‹¤ì‹œê°„ ê²½ì œ ë‰´ìŠ¤ ì´ë²¤íŠ¸
        news_list = [
            "ğŸ“¢ [ê²½ì œ] ì œêµ­ ì€í–‰ì˜ ê¸ˆë¦¬ê°€ ìƒìŠ¹ ì¡°ì§ì„ ë³´ì…ë‹ˆë‹¤!",
            "ğŸ“¢ [ì†Œì‹] ëŒ€ê·œëª¨ ë‡Œì ˆ ì—ë„ˆì§€ê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ì±„êµ´ íš¨ìœ¨ì´ ì¦ê°€í•©ë‹ˆë‹¤.",
            "ğŸ“¢ [ê³µì§€] í˜„ì¬ ìµœê³  ë¶€ìëŠ” 'ì´ˆì›”ì' ë“±ê¸‰ì„ ìœ ì§€í•˜ê³  ìˆìŠµë‹ˆë‹¤.",
            "ğŸ“¢ [ì´ë²¤íŠ¸] ì§€ê¸ˆ ì±„íŒ…ì„ ì…ë ¥í•˜ë©´ ë³´ë„ˆìŠ¤ í¬ì¸íŠ¸ê°€ ì§€ê¸‰ë  í™•ë¥ ì´ ë†’ìŠµë‹ˆë‹¤!"
        ]
        socketio.emit('message', {'msg': random.choice(news_list), 'type': 'system'}, room='main')

# --- [3. íŠ¹ìˆ˜ ê¸°ëŠ¥ ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 1
        reward = 5000
        update_money(nick, reward, bank=True)
        pattern = f"ğŸŒ€ [{nick}] ë‡Œì ˆ ë™ë ¥ ê°€ë™ ì¤‘... (+{reward}â‚© ì…ê¸ˆ)"
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"{pattern}\në¬´í•œ ë£¨í”„ íšŸìˆ˜: {m_count}íšŒì°¨", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3)

def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [4. ë¼ìš°íŒ… ë° ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸš€ {data['nickname']}ë‹˜ì´ ë©€í‹°ë²„ìŠ¤ ì„œë²„ì— ì ‘ì†í–ˆìŠµë‹ˆë‹¤!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ìˆ˜ìµ ê³µì‹]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ [ëŒ€ìš©ëŸ‰ ë°ì´í„° ë³€í™˜]\nê¸¸ì´: {msg_len}ì\në³´ìƒ: {reward}â‚© ì ë¦½ ì™„ë£Œ\nğŸ”— íŒŒì¼ ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ ì²˜ë¦¬]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        total = user['money'] + user['bank_money']
        res = f"ğŸ’° {nick}ë‹˜ì˜ ìì‚° ë³´ê³ ì„œ\n" \
              f"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" \
              f"ğŸ’µ í˜„ê¸ˆ: {user['money']:,}â‚©\n" \
              f"ğŸ¦ ì€í–‰: {user['bank_money']:,}â‚©\n" \
              f"ğŸ’³ ì´í•©: {total:,}â‚©\n" \
              f"ğŸ† ë“±ê¸‰: {'ì´ˆì›”ì' if total >= 10000000 else 'VIP' if total >= 1000000 else 'í‰ë¯¼'}"
        emit('message', {'msg': res, 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt:,}â‚©ì„ ì€í–‰ì— ì•ˆì „í•˜ê²Œ ë³´ê´€í–ˆìŠµë‹ˆë‹¤. (ë¶„ë‹¹ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ ì€í–‰ì—ì„œ {amt:,}â‚©ì„ ì¶œê¸ˆí–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ì´ ê°€ë™ë˜ì—ˆìŠµë‹ˆë‹¤! (3ì´ˆë‹¹ 5000â‚©)", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆ ì—”ì§„ì„ ì •ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            prompt = " ".join(cmd_parts[1:])
            res = client.models.generate_content(model="gemini-2.0-flash", contents=prompt)
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except Exception as e:
            emit('message', {'msg': f"âŒ ì—ëŸ¬: {str(e)}", 'type': 'system'})

    elif cmd == "!ëª…ë ¹ì–´":
        help_msg = "ğŸ“œ [ëª…ë ¹ì–´ ë¦¬ìŠ¤íŠ¸]\n!ì”ì•¡ - ë‚´ ìì‚° í™•ì¸\n!ì €ê¸ˆ [ì•¡ìˆ˜] - ì€í–‰ì— ì…ê¸ˆ\n!ì¶œê¸ˆ [ì•¡ìˆ˜] - í˜„ê¸ˆí™”\n!ë‡Œì ˆ - ë¬´í•œ ëˆ ë²Œê¸° ì‹œì‘\n!ë‡Œì ˆì¤‘ë‹¨ - ì¤‘ì§€\n!gemini [ì§ˆë¬¸] - AI ë‹µë³€\n!ëª…ë ¹ì–´ - ë„ì›€ë§"
        emit('message', {'msg': help_msg, 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ…
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=background_scheduler, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
import random
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í™˜ê²½] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "multiverse_empire.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {}

# Gemini AI í´ë¼ì´ì–¸íŠ¸ ì„¤ì •
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key:
        client = genai.Client(api_key=api_key)
except:
    print("Gemini SDKê°€ ì—†ê±°ë‚˜ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. !gemini ê¸°ëŠ¥ì€ ë¹„í™œì„±í™”ë©ë‹ˆë‹¤.")

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("""
            CREATE TABLE IF NOT EXISTS users (
                nickname TEXT PRIMARY KEY, 
                money INTEGER DEFAULT 1000, 
                bank_money INTEGER DEFAULT 0
            )
        """)
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ë° ë‰´ìŠ¤ ì‹œìŠ¤í…œ]
def background_scheduler():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤ ì‹¤í–‰
        with sqlite3.connect(DB_FILE) as conn:
            # 1. ì´ì ì§€ê¸‰ (1%)
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()
        
        # 2. ì‹¤ì‹œê°„ ê²½ì œ ë‰´ìŠ¤ ì´ë²¤íŠ¸
        news_list = [
            "ğŸ“¢ [ê²½ì œ] ì œêµ­ ì€í–‰ì˜ ê¸ˆë¦¬ê°€ ìƒìŠ¹ ì¡°ì§ì„ ë³´ì…ë‹ˆë‹¤!",
            "ğŸ“¢ [ì†Œì‹] ëŒ€ê·œëª¨ ë‡Œì ˆ ì—ë„ˆì§€ê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ì±„êµ´ íš¨ìœ¨ì´ ì¦ê°€í•©ë‹ˆë‹¤.",
            "ğŸ“¢ [ê³µì§€] í˜„ì¬ ìµœê³  ë¶€ìëŠ” 'ì´ˆì›”ì' ë“±ê¸‰ì„ ìœ ì§€í•˜ê³  ìˆìŠµë‹ˆë‹¤.",
            "ğŸ“¢ [ì´ë²¤íŠ¸] ì§€ê¸ˆ ì±„íŒ…ì„ ì…ë ¥í•˜ë©´ ë³´ë„ˆìŠ¤ í¬ì¸íŠ¸ê°€ ì§€ê¸‰ë  í™•ë¥ ì´ ë†’ìŠµë‹ˆë‹¤!"
        ]
        socketio.emit('message', {'msg': random.choice(news_list), 'type': 'system'}, room='main')

# --- [3. íŠ¹ìˆ˜ ê¸°ëŠ¥ ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 1
        reward = 5000
        update_money(nick, reward, bank=True)
        pattern = f"ğŸŒ€ [{nick}] ë‡Œì ˆ ë™ë ¥ ê°€ë™ ì¤‘... (+{reward}â‚© ì…ê¸ˆ)"
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"{pattern}\në¬´í•œ ë£¨í”„ íšŸìˆ˜: {m_count}íšŒì°¨", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3)

def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [4. ë¼ìš°íŒ… ë° ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸš€ {data['nickname']}ë‹˜ì´ ë©€í‹°ë²„ìŠ¤ ì„œë²„ì— ì ‘ì†í–ˆìŠµë‹ˆë‹¤!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ìˆ˜ìµ ê³µì‹]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ [ëŒ€ìš©ëŸ‰ ë°ì´í„° ë³€í™˜]\nê¸¸ì´: {msg_len}ì\në³´ìƒ: {reward}â‚© ì ë¦½ ì™„ë£Œ\nğŸ”— íŒŒì¼ ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ ì²˜ë¦¬]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        total = user['money'] + user['bank_money']
        res = f"ğŸ’° {nick}ë‹˜ì˜ ìì‚° ë³´ê³ ì„œ\n" \
              f"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" \
              f"ğŸ’µ í˜„ê¸ˆ: {user['money']:,}â‚©\n" \
              f"ğŸ¦ ì€í–‰: {user['bank_money']:,}â‚©\n" \
              f"ğŸ’³ ì´í•©: {total:,}â‚©\n" \
              f"ğŸ† ë“±ê¸‰: {'ì´ˆì›”ì' if total >= 10000000 else 'VIP' if total >= 1000000 else 'í‰ë¯¼'}"
        emit('message', {'msg': res, 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt:,}â‚©ì„ ì€í–‰ì— ì•ˆì „í•˜ê²Œ ë³´ê´€í–ˆìŠµë‹ˆë‹¤. (ë¶„ë‹¹ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ ì€í–‰ì—ì„œ {amt:,}â‚©ì„ ì¶œê¸ˆí–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ì´ ê°€ë™ë˜ì—ˆìŠµë‹ˆë‹¤! (3ì´ˆë‹¹ 5000â‚©)", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆ ì—”ì§„ì„ ì •ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            prompt = " ".join(cmd_parts[1:])
            res = client.models.generate_content(model="gemini-2.0-flash", contents=prompt)
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except Exception as e:
            emit('message', {'msg': f"âŒ ì—ëŸ¬: {str(e)}", 'type': 'system'})

    elif cmd == "!ëª…ë ¹ì–´":
        help_msg = "ğŸ“œ [ëª…ë ¹ì–´ ë¦¬ìŠ¤íŠ¸]\n!ì”ì•¡ - ë‚´ ìì‚° í™•ì¸\n!ì €ê¸ˆ [ì•¡ìˆ˜] - ì€í–‰ì— ì…ê¸ˆ\n!ì¶œê¸ˆ [ì•¡ìˆ˜] - í˜„ê¸ˆí™”\n!ë‡Œì ˆ - ë¬´í•œ ëˆ ë²Œê¸° ì‹œì‘\n!ë‡Œì ˆì¤‘ë‹¨ - ì¤‘ì§€\n!gemini [ì§ˆë¬¸] - AI ë‹µë³€\n!ëª…ë ¹ì–´ - ë„ì›€ë§"
        emit('message', {'msg': help_msg, 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ…
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=background_scheduler, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
import random
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í™˜ê²½] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "multiverse_empire.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {}

# Gemini AI í´ë¼ì´ì–¸íŠ¸ ì„¤ì •
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key:
        client = genai.Client(api_key=api_key)
except:
    print("Gemini SDKê°€ ì—†ê±°ë‚˜ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. !gemini ê¸°ëŠ¥ì€ ë¹„í™œì„±í™”ë©ë‹ˆë‹¤.")

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("""
            CREATE TABLE IF NOT EXISTS users (
                nickname TEXT PRIMARY KEY, 
                money INTEGER DEFAULT 1000, 
                bank_money INTEGER DEFAULT 0
            )
        """)
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ë° ë‰´ìŠ¤ ì‹œìŠ¤í…œ]
def background_scheduler():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤ ì‹¤í–‰
        with sqlite3.connect(DB_FILE) as conn:
            # 1. ì´ì ì§€ê¸‰ (1%)
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()
        
        # 2. ì‹¤ì‹œê°„ ê²½ì œ ë‰´ìŠ¤ ì´ë²¤íŠ¸
        news_list = [
            "ğŸ“¢ [ê²½ì œ] ì œêµ­ ì€í–‰ì˜ ê¸ˆë¦¬ê°€ ìƒìŠ¹ ì¡°ì§ì„ ë³´ì…ë‹ˆë‹¤!",
            "ğŸ“¢ [ì†Œì‹] ëŒ€ê·œëª¨ ë‡Œì ˆ ì—ë„ˆì§€ê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ì±„êµ´ íš¨ìœ¨ì´ ì¦ê°€í•©ë‹ˆë‹¤.",
            "ğŸ“¢ [ê³µì§€] í˜„ì¬ ìµœê³  ë¶€ìëŠ” 'ì´ˆì›”ì' ë“±ê¸‰ì„ ìœ ì§€í•˜ê³  ìˆìŠµë‹ˆë‹¤.",
            "ğŸ“¢ [ì´ë²¤íŠ¸] ì§€ê¸ˆ ì±„íŒ…ì„ ì…ë ¥í•˜ë©´ ë³´ë„ˆìŠ¤ í¬ì¸íŠ¸ê°€ ì§€ê¸‰ë  í™•ë¥ ì´ ë†’ìŠµë‹ˆë‹¤!"
        ]
        socketio.emit('message', {'msg': random.choice(news_list), 'type': 'system'}, room='main')

# --- [3. íŠ¹ìˆ˜ ê¸°ëŠ¥ ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 1
        reward = 5000
        update_money(nick, reward, bank=True)
        pattern = f"ğŸŒ€ [{nick}] ë‡Œì ˆ ë™ë ¥ ê°€ë™ ì¤‘... (+{reward}â‚© ì…ê¸ˆ)"
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"{pattern}\në¬´í•œ ë£¨í”„ íšŸìˆ˜: {m_count}íšŒì°¨", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3)

def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [4. ë¼ìš°íŒ… ë° ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸš€ {data['nickname']}ë‹˜ì´ ë©€í‹°ë²„ìŠ¤ ì„œë²„ì— ì ‘ì†í–ˆìŠµë‹ˆë‹¤!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ìˆ˜ìµ ê³µì‹]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ [ëŒ€ìš©ëŸ‰ ë°ì´í„° ë³€í™˜]\nê¸¸ì´: {msg_len}ì\në³´ìƒ: {reward}â‚© ì ë¦½ ì™„ë£Œ\nğŸ”— íŒŒì¼ ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ ì²˜ë¦¬]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        total = user['money'] + user['bank_money']
        res = f"ğŸ’° {nick}ë‹˜ì˜ ìì‚° ë³´ê³ ì„œ\n" \
              f"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" \
              f"ğŸ’µ í˜„ê¸ˆ: {user['money']:,}â‚©\n" \
              f"ğŸ¦ ì€í–‰: {user['bank_money']:,}â‚©\n" \
              f"ğŸ’³ ì´í•©: {total:,}â‚©\n" \
              f"ğŸ† ë“±ê¸‰: {'ì´ˆì›”ì' if total >= 10000000 else 'VIP' if total >= 1000000 else 'í‰ë¯¼'}"
        emit('message', {'msg': res, 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt:,}â‚©ì„ ì€í–‰ì— ì•ˆì „í•˜ê²Œ ë³´ê´€í–ˆìŠµë‹ˆë‹¤. (ë¶„ë‹¹ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ ì€í–‰ì—ì„œ {amt:,}â‚©ì„ ì¶œê¸ˆí–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ì´ ê°€ë™ë˜ì—ˆìŠµë‹ˆë‹¤! (3ì´ˆë‹¹ 5000â‚©)", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆ ì—”ì§„ì„ ì •ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            prompt = " ".join(cmd_parts[1:])
            res = client.models.generate_content(model="gemini-2.0-flash", contents=prompt)
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except Exception as e:
            emit('message', {'msg': f"âŒ ì—ëŸ¬: {str(e)}", 'type': 'system'})

    elif cmd == "!ëª…ë ¹ì–´":
        help_msg = "ğŸ“œ [ëª…ë ¹ì–´ ë¦¬ìŠ¤íŠ¸]\n!ì”ì•¡ - ë‚´ ìì‚° í™•ì¸\n!ì €ê¸ˆ [ì•¡ìˆ˜] - ì€í–‰ì— ì…ê¸ˆ\n!ì¶œê¸ˆ [ì•¡ìˆ˜] - í˜„ê¸ˆí™”\n!ë‡Œì ˆ - ë¬´í•œ ëˆ ë²Œê¸° ì‹œì‘\n!ë‡Œì ˆì¤‘ë‹¨ - ì¤‘ì§€\n!gemini [ì§ˆë¬¸] - AI ë‹µë³€\n!ëª…ë ¹ì–´ - ë„ì›€ë§"
        emit('message', {'msg': help_msg, 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ…
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=background_scheduler, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
import random
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í™˜ê²½] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "multiverse_empire.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {}

# Gemini AI í´ë¼ì´ì–¸íŠ¸ ì„¤ì •
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key:
        client = genai.Client(api_key=api_key)
except:
    print("Gemini SDKê°€ ì—†ê±°ë‚˜ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. !gemini ê¸°ëŠ¥ì€ ë¹„í™œì„±í™”ë©ë‹ˆë‹¤.")

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("""
            CREATE TABLE IF NOT EXISTS users (
                nickname TEXT PRIMARY KEY, 
                money INTEGER DEFAULT 1000, 
                bank_money INTEGER DEFAULT 0
            )
        """)
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ë° ë‰´ìŠ¤ ì‹œìŠ¤í…œ]
def background_scheduler():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤ ì‹¤í–‰
        with sqlite3.connect(DB_FILE) as conn:
            # 1. ì´ì ì§€ê¸‰ (1%)
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()
        
        # 2. ì‹¤ì‹œê°„ ê²½ì œ ë‰´ìŠ¤ ì´ë²¤íŠ¸
        news_list = [
            "ğŸ“¢ [ê²½ì œ] ì œêµ­ ì€í–‰ì˜ ê¸ˆë¦¬ê°€ ìƒìŠ¹ ì¡°ì§ì„ ë³´ì…ë‹ˆë‹¤!",
            "ğŸ“¢ [ì†Œì‹] ëŒ€ê·œëª¨ ë‡Œì ˆ ì—ë„ˆì§€ê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ì±„êµ´ íš¨ìœ¨ì´ ì¦ê°€í•©ë‹ˆë‹¤.",
            "ğŸ“¢ [ê³µì§€] í˜„ì¬ ìµœê³  ë¶€ìëŠ” 'ì´ˆì›”ì' ë“±ê¸‰ì„ ìœ ì§€í•˜ê³  ìˆìŠµë‹ˆë‹¤.",
            "ğŸ“¢ [ì´ë²¤íŠ¸] ì§€ê¸ˆ ì±„íŒ…ì„ ì…ë ¥í•˜ë©´ ë³´ë„ˆìŠ¤ í¬ì¸íŠ¸ê°€ ì§€ê¸‰ë  í™•ë¥ ì´ ë†’ìŠµë‹ˆë‹¤!"
        ]
        socketio.emit('message', {'msg': random.choice(news_list), 'type': 'system'}, room='main')

# --- [3. íŠ¹ìˆ˜ ê¸°ëŠ¥ ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 1
        reward = 5000
        update_money(nick, reward, bank=True)
        pattern = f"ğŸŒ€ [{nick}] ë‡Œì ˆ ë™ë ¥ ê°€ë™ ì¤‘... (+{reward}â‚© ì…ê¸ˆ)"
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"{pattern}\në¬´í•œ ë£¨í”„ íšŸìˆ˜: {m_count}íšŒì°¨", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3)

def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [4. ë¼ìš°íŒ… ë° ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸš€ {data['nickname']}ë‹˜ì´ ë©€í‹°ë²„ìŠ¤ ì„œë²„ì— ì ‘ì†í–ˆìŠµë‹ˆë‹¤!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ìˆ˜ìµ ê³µì‹]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ [ëŒ€ìš©ëŸ‰ ë°ì´í„° ë³€í™˜]\nê¸¸ì´: {msg_len}ì\në³´ìƒ: {reward}â‚© ì ë¦½ ì™„ë£Œ\nğŸ”— íŒŒì¼ ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ ì²˜ë¦¬]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        total = user['money'] + user['bank_money']
        res = f"ğŸ’° {nick}ë‹˜ì˜ ìì‚° ë³´ê³ ì„œ\n" \
              f"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" \
              f"ğŸ’µ í˜„ê¸ˆ: {user['money']:,}â‚©\n" \
              f"ğŸ¦ ì€í–‰: {user['bank_money']:,}â‚©\n" \
              f"ğŸ’³ ì´í•©: {total:,}â‚©\n" \
              f"ğŸ† ë“±ê¸‰: {'ì´ˆì›”ì' if total >= 10000000 else 'VIP' if total >= 1000000 else 'í‰ë¯¼'}"
        emit('message', {'msg': res, 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt:,}â‚©ì„ ì€í–‰ì— ì•ˆì „í•˜ê²Œ ë³´ê´€í–ˆìŠµë‹ˆë‹¤. (ë¶„ë‹¹ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ ì€í–‰ì—ì„œ {amt:,}â‚©ì„ ì¶œê¸ˆí–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ì´ ê°€ë™ë˜ì—ˆìŠµë‹ˆë‹¤! (3ì´ˆë‹¹ 5000â‚©)", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆ ì—”ì§„ì„ ì •ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            prompt = " ".join(cmd_parts[1:])
            res = client.models.generate_content(model="gemini-2.0-flash", contents=prompt)
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except Exception as e:
            emit('message', {'msg': f"âŒ ì—ëŸ¬: {str(e)}", 'type': 'system'})

    elif cmd == "!ëª…ë ¹ì–´":
        help_msg = "ğŸ“œ [ëª…ë ¹ì–´ ë¦¬ìŠ¤íŠ¸]\n!ì”ì•¡ - ë‚´ ìì‚° í™•ì¸\n!ì €ê¸ˆ [ì•¡ìˆ˜] - ì€í–‰ì— ì…ê¸ˆ\n!ì¶œê¸ˆ [ì•¡ìˆ˜] - í˜„ê¸ˆí™”\n!ë‡Œì ˆ - ë¬´í•œ ëˆ ë²Œê¸° ì‹œì‘\n!ë‡Œì ˆì¤‘ë‹¨ - ì¤‘ì§€\n!gemini [ì§ˆë¬¸] - AI ë‹µë³€\n!ëª…ë ¹ì–´ - ë„ì›€ë§"
        emit('message', {'msg': help_msg, 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ…
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=background_scheduler, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
import random
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í™˜ê²½] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "multiverse_empire.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {}

# Gemini AI í´ë¼ì´ì–¸íŠ¸ ì„¤ì •
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key:
        client = genai.Client(api_key=api_key)
except:
    print("Gemini SDKê°€ ì—†ê±°ë‚˜ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. !gemini ê¸°ëŠ¥ì€ ë¹„í™œì„±í™”ë©ë‹ˆë‹¤.")

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("""
            CREATE TABLE IF NOT EXISTS users (
                nickname TEXT PRIMARY KEY, 
                money INTEGER DEFAULT 1000, 
                bank_money INTEGER DEFAULT 0
            )
        """)
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ë° ë‰´ìŠ¤ ì‹œìŠ¤í…œ]
def background_scheduler():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤ ì‹¤í–‰
        with sqlite3.connect(DB_FILE) as conn:
            # 1. ì´ì ì§€ê¸‰ (1%)
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()
        
        # 2. ì‹¤ì‹œê°„ ê²½ì œ ë‰´ìŠ¤ ì´ë²¤íŠ¸
        news_list = [
            "ğŸ“¢ [ê²½ì œ] ì œêµ­ ì€í–‰ì˜ ê¸ˆë¦¬ê°€ ìƒìŠ¹ ì¡°ì§ì„ ë³´ì…ë‹ˆë‹¤!",
            "ğŸ“¢ [ì†Œì‹] ëŒ€ê·œëª¨ ë‡Œì ˆ ì—ë„ˆì§€ê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ì±„êµ´ íš¨ìœ¨ì´ ì¦ê°€í•©ë‹ˆë‹¤.",
            "ğŸ“¢ [ê³µì§€] í˜„ì¬ ìµœê³  ë¶€ìëŠ” 'ì´ˆì›”ì' ë“±ê¸‰ì„ ìœ ì§€í•˜ê³  ìˆìŠµë‹ˆë‹¤.",
            "ğŸ“¢ [ì´ë²¤íŠ¸] ì§€ê¸ˆ ì±„íŒ…ì„ ì…ë ¥í•˜ë©´ ë³´ë„ˆìŠ¤ í¬ì¸íŠ¸ê°€ ì§€ê¸‰ë  í™•ë¥ ì´ ë†’ìŠµë‹ˆë‹¤!"
        ]
        socketio.emit('message', {'msg': random.choice(news_list), 'type': 'system'}, room='main')

# --- [3. íŠ¹ìˆ˜ ê¸°ëŠ¥ ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 1
        reward = 5000
        update_money(nick, reward, bank=True)
        pattern = f"ğŸŒ€ [{nick}] ë‡Œì ˆ ë™ë ¥ ê°€ë™ ì¤‘... (+{reward}â‚© ì…ê¸ˆ)"
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"{pattern}\në¬´í•œ ë£¨í”„ íšŸìˆ˜: {m_count}íšŒì°¨", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3)

def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [4. ë¼ìš°íŒ… ë° ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸš€ {data['nickname']}ë‹˜ì´ ë©€í‹°ë²„ìŠ¤ ì„œë²„ì— ì ‘ì†í–ˆìŠµë‹ˆë‹¤!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ìˆ˜ìµ ê³µì‹]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ [ëŒ€ìš©ëŸ‰ ë°ì´í„° ë³€í™˜]\nê¸¸ì´: {msg_len}ì\në³´ìƒ: {reward}â‚© ì ë¦½ ì™„ë£Œ\nğŸ”— íŒŒì¼ ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ ì²˜ë¦¬]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        total = user['money'] + user['bank_money']
        res = f"ğŸ’° {nick}ë‹˜ì˜ ìì‚° ë³´ê³ ì„œ\n" \
              f"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" \
              f"ğŸ’µ í˜„ê¸ˆ: {user['money']:,}â‚©\n" \
              f"ğŸ¦ ì€í–‰: {user['bank_money']:,}â‚©\n" \
              f"ğŸ’³ ì´í•©: {total:,}â‚©\n" \
              f"ğŸ† ë“±ê¸‰: {'ì´ˆì›”ì' if total >= 10000000 else 'VIP' if total >= 1000000 else 'í‰ë¯¼'}"
        emit('message', {'msg': res, 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt:,}â‚©ì„ ì€í–‰ì— ì•ˆì „í•˜ê²Œ ë³´ê´€í–ˆìŠµë‹ˆë‹¤. (ë¶„ë‹¹ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ ì€í–‰ì—ì„œ {amt:,}â‚©ì„ ì¶œê¸ˆí–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ì´ ê°€ë™ë˜ì—ˆìŠµë‹ˆë‹¤! (3ì´ˆë‹¹ 5000â‚©)", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆ ì—”ì§„ì„ ì •ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            prompt = " ".join(cmd_parts[1:])
            res = client.models.generate_content(model="gemini-2.0-flash", contents=prompt)
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except Exception as e:
            emit('message', {'msg': f"âŒ ì—ëŸ¬: {str(e)}", 'type': 'system'})

    elif cmd == "!ëª…ë ¹ì–´":
        help_msg = "ğŸ“œ [ëª…ë ¹ì–´ ë¦¬ìŠ¤íŠ¸]\n!ì”ì•¡ - ë‚´ ìì‚° í™•ì¸\n!ì €ê¸ˆ [ì•¡ìˆ˜] - ì€í–‰ì— ì…ê¸ˆ\n!ì¶œê¸ˆ [ì•¡ìˆ˜] - í˜„ê¸ˆí™”\n!ë‡Œì ˆ - ë¬´í•œ ëˆ ë²Œê¸° ì‹œì‘\n!ë‡Œì ˆì¤‘ë‹¨ - ì¤‘ì§€\n!gemini [ì§ˆë¬¸] - AI ë‹µë³€\n!ëª…ë ¹ì–´ - ë„ì›€ë§"
        emit('message', {'msg': help_msg, 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ…
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=background_scheduler, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
import random
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í™˜ê²½] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "multiverse_empire.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {}

# Gemini AI í´ë¼ì´ì–¸íŠ¸ ì„¤ì •
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key:
        client = genai.Client(api_key=api_key)
except:
    print("Gemini SDKê°€ ì—†ê±°ë‚˜ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. !gemini ê¸°ëŠ¥ì€ ë¹„í™œì„±í™”ë©ë‹ˆë‹¤.")

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("""
            CREATE TABLE IF NOT EXISTS users (
                nickname TEXT PRIMARY KEY, 
                money INTEGER DEFAULT 1000, 
                bank_money INTEGER DEFAULT 0
            )
        """)
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ë° ë‰´ìŠ¤ ì‹œìŠ¤í…œ]
def background_scheduler():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤ ì‹¤í–‰
        with sqlite3.connect(DB_FILE) as conn:
            # 1. ì´ì ì§€ê¸‰ (1%)
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()
        
        # 2. ì‹¤ì‹œê°„ ê²½ì œ ë‰´ìŠ¤ ì´ë²¤íŠ¸
        news_list = [
            "ğŸ“¢ [ê²½ì œ] ì œêµ­ ì€í–‰ì˜ ê¸ˆë¦¬ê°€ ìƒìŠ¹ ì¡°ì§ì„ ë³´ì…ë‹ˆë‹¤!",
            "ğŸ“¢ [ì†Œì‹] ëŒ€ê·œëª¨ ë‡Œì ˆ ì—ë„ˆì§€ê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ì±„êµ´ íš¨ìœ¨ì´ ì¦ê°€í•©ë‹ˆë‹¤.",
            "ğŸ“¢ [ê³µì§€] í˜„ì¬ ìµœê³  ë¶€ìëŠ” 'ì´ˆì›”ì' ë“±ê¸‰ì„ ìœ ì§€í•˜ê³  ìˆìŠµë‹ˆë‹¤.",
            "ğŸ“¢ [ì´ë²¤íŠ¸] ì§€ê¸ˆ ì±„íŒ…ì„ ì…ë ¥í•˜ë©´ ë³´ë„ˆìŠ¤ í¬ì¸íŠ¸ê°€ ì§€ê¸‰ë  í™•ë¥ ì´ ë†’ìŠµë‹ˆë‹¤!"
        ]
        socketio.emit('message', {'msg': random.choice(news_list), 'type': 'system'}, room='main')

# --- [3. íŠ¹ìˆ˜ ê¸°ëŠ¥ ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 1
        reward = 5000
        update_money(nick, reward, bank=True)
        pattern = f"ğŸŒ€ [{nick}] ë‡Œì ˆ ë™ë ¥ ê°€ë™ ì¤‘... (+{reward}â‚© ì…ê¸ˆ)"
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"{pattern}\në¬´í•œ ë£¨í”„ íšŸìˆ˜: {m_count}íšŒì°¨", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3)

def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [4. ë¼ìš°íŒ… ë° ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸš€ {data['nickname']}ë‹˜ì´ ë©€í‹°ë²„ìŠ¤ ì„œë²„ì— ì ‘ì†í–ˆìŠµë‹ˆë‹¤!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ìˆ˜ìµ ê³µì‹]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ [ëŒ€ìš©ëŸ‰ ë°ì´í„° ë³€í™˜]\nê¸¸ì´: {msg_len}ì\në³´ìƒ: {reward}â‚© ì ë¦½ ì™„ë£Œ\nğŸ”— íŒŒì¼ ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ ì²˜ë¦¬]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        total = user['money'] + user['bank_money']
        res = f"ğŸ’° {nick}ë‹˜ì˜ ìì‚° ë³´ê³ ì„œ\n" \
              f"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" \
              f"ğŸ’µ í˜„ê¸ˆ: {user['money']:,}â‚©\n" \
              f"ğŸ¦ ì€í–‰: {user['bank_money']:,}â‚©\n" \
              f"ğŸ’³ ì´í•©: {total:,}â‚©\n" \
              f"ğŸ† ë“±ê¸‰: {'ì´ˆì›”ì' if total >= 10000000 else 'VIP' if total >= 1000000 else 'í‰ë¯¼'}"
        emit('message', {'msg': res, 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt:,}â‚©ì„ ì€í–‰ì— ì•ˆì „í•˜ê²Œ ë³´ê´€í–ˆìŠµë‹ˆë‹¤. (ë¶„ë‹¹ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ ì€í–‰ì—ì„œ {amt:,}â‚©ì„ ì¶œê¸ˆí–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ì´ ê°€ë™ë˜ì—ˆìŠµë‹ˆë‹¤! (3ì´ˆë‹¹ 5000â‚©)", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆ ì—”ì§„ì„ ì •ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            prompt = " ".join(cmd_parts[1:])
            res = client.models.generate_content(model="gemini-2.0-flash", contents=prompt)
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except Exception as e:
            emit('message', {'msg': f"âŒ ì—ëŸ¬: {str(e)}", 'type': 'system'})

    elif cmd == "!ëª…ë ¹ì–´":
        help_msg = "ğŸ“œ [ëª…ë ¹ì–´ ë¦¬ìŠ¤íŠ¸]\n!ì”ì•¡ - ë‚´ ìì‚° í™•ì¸\n!ì €ê¸ˆ [ì•¡ìˆ˜] - ì€í–‰ì— ì…ê¸ˆ\n!ì¶œê¸ˆ [ì•¡ìˆ˜] - í˜„ê¸ˆí™”\n!ë‡Œì ˆ - ë¬´í•œ ëˆ ë²Œê¸° ì‹œì‘\n!ë‡Œì ˆì¤‘ë‹¨ - ì¤‘ì§€\n!gemini [ì§ˆë¬¸] - AI ë‹µë³€\n!ëª…ë ¹ì–´ - ë„ì›€ë§"
        emit('message', {'msg': help_msg, 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ…
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=background_scheduler, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
import random
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í™˜ê²½] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "multiverse_empire.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {}

# Gemini AI í´ë¼ì´ì–¸íŠ¸ ì„¤ì •
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key:
        client = genai.Client(api_key=api_key)
except:
    print("Gemini SDKê°€ ì—†ê±°ë‚˜ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. !gemini ê¸°ëŠ¥ì€ ë¹„í™œì„±í™”ë©ë‹ˆë‹¤.")

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("""
            CREATE TABLE IF NOT EXISTS users (
                nickname TEXT PRIMARY KEY, 
                money INTEGER DEFAULT 1000, 
                bank_money INTEGER DEFAULT 0
            )
        """)
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ë° ë‰´ìŠ¤ ì‹œìŠ¤í…œ]
def background_scheduler():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤ ì‹¤í–‰
        with sqlite3.connect(DB_FILE) as conn:
            # 1. ì´ì ì§€ê¸‰ (1%)
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()
        
        # 2. ì‹¤ì‹œê°„ ê²½ì œ ë‰´ìŠ¤ ì´ë²¤íŠ¸
        news_list = [
            "ğŸ“¢ [ê²½ì œ] ì œêµ­ ì€í–‰ì˜ ê¸ˆë¦¬ê°€ ìƒìŠ¹ ì¡°ì§ì„ ë³´ì…ë‹ˆë‹¤!",
            "ğŸ“¢ [ì†Œì‹] ëŒ€ê·œëª¨ ë‡Œì ˆ ì—ë„ˆì§€ê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ì±„êµ´ íš¨ìœ¨ì´ ì¦ê°€í•©ë‹ˆë‹¤.",
            "ğŸ“¢ [ê³µì§€] í˜„ì¬ ìµœê³  ë¶€ìëŠ” 'ì´ˆì›”ì' ë“±ê¸‰ì„ ìœ ì§€í•˜ê³  ìˆìŠµë‹ˆë‹¤.",
            "ğŸ“¢ [ì´ë²¤íŠ¸] ì§€ê¸ˆ ì±„íŒ…ì„ ì…ë ¥í•˜ë©´ ë³´ë„ˆìŠ¤ í¬ì¸íŠ¸ê°€ ì§€ê¸‰ë  í™•ë¥ ì´ ë†’ìŠµë‹ˆë‹¤!"
        ]
        socketio.emit('message', {'msg': random.choice(news_list), 'type': 'system'}, room='main')

# --- [3. íŠ¹ìˆ˜ ê¸°ëŠ¥ ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 1
        reward = 5000
        update_money(nick, reward, bank=True)
        pattern = f"ğŸŒ€ [{nick}] ë‡Œì ˆ ë™ë ¥ ê°€ë™ ì¤‘... (+{reward}â‚© ì…ê¸ˆ)"
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"{pattern}\në¬´í•œ ë£¨í”„ íšŸìˆ˜: {m_count}íšŒì°¨", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3)

def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [4. ë¼ìš°íŒ… ë° ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸš€ {data['nickname']}ë‹˜ì´ ë©€í‹°ë²„ìŠ¤ ì„œë²„ì— ì ‘ì†í–ˆìŠµë‹ˆë‹¤!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ìˆ˜ìµ ê³µì‹]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ [ëŒ€ìš©ëŸ‰ ë°ì´í„° ë³€í™˜]\nê¸¸ì´: {msg_len}ì\në³´ìƒ: {reward}â‚© ì ë¦½ ì™„ë£Œ\nğŸ”— íŒŒì¼ ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ ì²˜ë¦¬]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        total = user['money'] + user['bank_money']
        res = f"ğŸ’° {nick}ë‹˜ì˜ ìì‚° ë³´ê³ ì„œ\n" \
              f"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" \
              f"ğŸ’µ í˜„ê¸ˆ: {user['money']:,}â‚©\n" \
              f"ğŸ¦ ì€í–‰: {user['bank_money']:,}â‚©\n" \
              f"ğŸ’³ ì´í•©: {total:,}â‚©\n" \
              f"ğŸ† ë“±ê¸‰: {'ì´ˆì›”ì' if total >= 10000000 else 'VIP' if total >= 1000000 else 'í‰ë¯¼'}"
        emit('message', {'msg': res, 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt:,}â‚©ì„ ì€í–‰ì— ì•ˆì „í•˜ê²Œ ë³´ê´€í–ˆìŠµë‹ˆë‹¤. (ë¶„ë‹¹ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ ì€í–‰ì—ì„œ {amt:,}â‚©ì„ ì¶œê¸ˆí–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ì´ ê°€ë™ë˜ì—ˆìŠµë‹ˆë‹¤! (3ì´ˆë‹¹ 5000â‚©)", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆ ì—”ì§„ì„ ì •ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            prompt = " ".join(cmd_parts[1:])
            res = client.models.generate_content(model="gemini-2.0-flash", contents=prompt)
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except Exception as e:
            emit('message', {'msg': f"âŒ ì—ëŸ¬: {str(e)}", 'type': 'system'})

    elif cmd == "!ëª…ë ¹ì–´":
        help_msg = "ğŸ“œ [ëª…ë ¹ì–´ ë¦¬ìŠ¤íŠ¸]\n!ì”ì•¡ - ë‚´ ìì‚° í™•ì¸\n!ì €ê¸ˆ [ì•¡ìˆ˜] - ì€í–‰ì— ì…ê¸ˆ\n!ì¶œê¸ˆ [ì•¡ìˆ˜] - í˜„ê¸ˆí™”\n!ë‡Œì ˆ - ë¬´í•œ ëˆ ë²Œê¸° ì‹œì‘\n!ë‡Œì ˆì¤‘ë‹¨ - ì¤‘ì§€\n!gemini [ì§ˆë¬¸] - AI ë‹µë³€\n!ëª…ë ¹ì–´ - ë„ì›€ë§"
        emit('message', {'msg': help_msg, 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ…
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=background_scheduler, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
import random
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í™˜ê²½] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "multiverse_empire.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {}

# Gemini AI í´ë¼ì´ì–¸íŠ¸ ì„¤ì •
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key:
        client = genai.Client(api_key=api_key)
except:
    print("Gemini SDKê°€ ì—†ê±°ë‚˜ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. !gemini ê¸°ëŠ¥ì€ ë¹„í™œì„±í™”ë©ë‹ˆë‹¤.")

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("""
            CREATE TABLE IF NOT EXISTS users (
                nickname TEXT PRIMARY KEY, 
                money INTEGER DEFAULT 1000, 
                bank_money INTEGER DEFAULT 0
            )
        """)
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ë° ë‰´ìŠ¤ ì‹œìŠ¤í…œ]
def background_scheduler():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤ ì‹¤í–‰
        with sqlite3.connect(DB_FILE) as conn:
            # 1. ì´ì ì§€ê¸‰ (1%)
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()
        
        # 2. ì‹¤ì‹œê°„ ê²½ì œ ë‰´ìŠ¤ ì´ë²¤íŠ¸
        news_list = [
            "ğŸ“¢ [ê²½ì œ] ì œêµ­ ì€í–‰ì˜ ê¸ˆë¦¬ê°€ ìƒìŠ¹ ì¡°ì§ì„ ë³´ì…ë‹ˆë‹¤!",
            "ğŸ“¢ [ì†Œì‹] ëŒ€ê·œëª¨ ë‡Œì ˆ ì—ë„ˆì§€ê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ì±„êµ´ íš¨ìœ¨ì´ ì¦ê°€í•©ë‹ˆë‹¤.",
            "ğŸ“¢ [ê³µì§€] í˜„ì¬ ìµœê³  ë¶€ìëŠ” 'ì´ˆì›”ì' ë“±ê¸‰ì„ ìœ ì§€í•˜ê³  ìˆìŠµë‹ˆë‹¤.",
            "ğŸ“¢ [ì´ë²¤íŠ¸] ì§€ê¸ˆ ì±„íŒ…ì„ ì…ë ¥í•˜ë©´ ë³´ë„ˆìŠ¤ í¬ì¸íŠ¸ê°€ ì§€ê¸‰ë  í™•ë¥ ì´ ë†’ìŠµë‹ˆë‹¤!"
        ]
        socketio.emit('message', {'msg': random.choice(news_list), 'type': 'system'}, room='main')

# --- [3. íŠ¹ìˆ˜ ê¸°ëŠ¥ ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 1
        reward = 5000
        update_money(nick, reward, bank=True)
        pattern = f"ğŸŒ€ [{nick}] ë‡Œì ˆ ë™ë ¥ ê°€ë™ ì¤‘... (+{reward}â‚© ì…ê¸ˆ)"
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"{pattern}\në¬´í•œ ë£¨í”„ íšŸìˆ˜: {m_count}íšŒì°¨", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3)

def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [4. ë¼ìš°íŒ… ë° ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸš€ {data['nickname']}ë‹˜ì´ ë©€í‹°ë²„ìŠ¤ ì„œë²„ì— ì ‘ì†í–ˆìŠµë‹ˆë‹¤!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ìˆ˜ìµ ê³µì‹]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ [ëŒ€ìš©ëŸ‰ ë°ì´í„° ë³€í™˜]\nê¸¸ì´: {msg_len}ì\në³´ìƒ: {reward}â‚© ì ë¦½ ì™„ë£Œ\nğŸ”— íŒŒì¼ ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ ì²˜ë¦¬]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        total = user['money'] + user['bank_money']
        res = f"ğŸ’° {nick}ë‹˜ì˜ ìì‚° ë³´ê³ ì„œ\n" \
              f"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" \
              f"ğŸ’µ í˜„ê¸ˆ: {user['money']:,}â‚©\n" \
              f"ğŸ¦ ì€í–‰: {user['bank_money']:,}â‚©\n" \
              f"ğŸ’³ ì´í•©: {total:,}â‚©\n" \
              f"ğŸ† ë“±ê¸‰: {'ì´ˆì›”ì' if total >= 10000000 else 'VIP' if total >= 1000000 else 'í‰ë¯¼'}"
        emit('message', {'msg': res, 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt:,}â‚©ì„ ì€í–‰ì— ì•ˆì „í•˜ê²Œ ë³´ê´€í–ˆìŠµë‹ˆë‹¤. (ë¶„ë‹¹ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ ì€í–‰ì—ì„œ {amt:,}â‚©ì„ ì¶œê¸ˆí–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ì´ ê°€ë™ë˜ì—ˆìŠµë‹ˆë‹¤! (3ì´ˆë‹¹ 5000â‚©)", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆ ì—”ì§„ì„ ì •ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            prompt = " ".join(cmd_parts[1:])
            res = client.models.generate_content(model="gemini-2.0-flash", contents=prompt)
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except Exception as e:
            emit('message', {'msg': f"âŒ ì—ëŸ¬: {str(e)}", 'type': 'system'})

    elif cmd == "!ëª…ë ¹ì–´":
        help_msg = "ğŸ“œ [ëª…ë ¹ì–´ ë¦¬ìŠ¤íŠ¸]\n!ì”ì•¡ - ë‚´ ìì‚° í™•ì¸\n!ì €ê¸ˆ [ì•¡ìˆ˜] - ì€í–‰ì— ì…ê¸ˆ\n!ì¶œê¸ˆ [ì•¡ìˆ˜] - í˜„ê¸ˆí™”\n!ë‡Œì ˆ - ë¬´í•œ ëˆ ë²Œê¸° ì‹œì‘\n!ë‡Œì ˆì¤‘ë‹¨ - ì¤‘ì§€\n!gemini [ì§ˆë¬¸] - AI ë‹µë³€\n!ëª…ë ¹ì–´ - ë„ì›€ë§"
        emit('message', {'msg': help_msg, 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ…
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=background_scheduler, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
import random
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í™˜ê²½] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "multiverse_empire.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {}

# Gemini AI í´ë¼ì´ì–¸íŠ¸ ì„¤ì •
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key:
        client = genai.Client(api_key=api_key)
except:
    print("Gemini SDKê°€ ì—†ê±°ë‚˜ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. !gemini ê¸°ëŠ¥ì€ ë¹„í™œì„±í™”ë©ë‹ˆë‹¤.")

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("""
            CREATE TABLE IF NOT EXISTS users (
                nickname TEXT PRIMARY KEY, 
                money INTEGER DEFAULT 1000, 
                bank_money INTEGER DEFAULT 0
            )
        """)
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ë° ë‰´ìŠ¤ ì‹œìŠ¤í…œ]
def background_scheduler():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤ ì‹¤í–‰
        with sqlite3.connect(DB_FILE) as conn:
            # 1. ì´ì ì§€ê¸‰ (1%)
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()
        
        # 2. ì‹¤ì‹œê°„ ê²½ì œ ë‰´ìŠ¤ ì´ë²¤íŠ¸
        news_list = [
            "ğŸ“¢ [ê²½ì œ] ì œêµ­ ì€í–‰ì˜ ê¸ˆë¦¬ê°€ ìƒìŠ¹ ì¡°ì§ì„ ë³´ì…ë‹ˆë‹¤!",
            "ğŸ“¢ [ì†Œì‹] ëŒ€ê·œëª¨ ë‡Œì ˆ ì—ë„ˆì§€ê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ì±„êµ´ íš¨ìœ¨ì´ ì¦ê°€í•©ë‹ˆë‹¤.",
            "ğŸ“¢ [ê³µì§€] í˜„ì¬ ìµœê³  ë¶€ìëŠ” 'ì´ˆì›”ì' ë“±ê¸‰ì„ ìœ ì§€í•˜ê³  ìˆìŠµë‹ˆë‹¤.",
            "ğŸ“¢ [ì´ë²¤íŠ¸] ì§€ê¸ˆ ì±„íŒ…ì„ ì…ë ¥í•˜ë©´ ë³´ë„ˆìŠ¤ í¬ì¸íŠ¸ê°€ ì§€ê¸‰ë  í™•ë¥ ì´ ë†’ìŠµë‹ˆë‹¤!"
        ]
        socketio.emit('message', {'msg': random.choice(news_list), 'type': 'system'}, room='main')

# --- [3. íŠ¹ìˆ˜ ê¸°ëŠ¥ ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 1
        reward = 5000
        update_money(nick, reward, bank=True)
        pattern = f"ğŸŒ€ [{nick}] ë‡Œì ˆ ë™ë ¥ ê°€ë™ ì¤‘... (+{reward}â‚© ì…ê¸ˆ)"
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"{pattern}\në¬´í•œ ë£¨í”„ íšŸìˆ˜: {m_count}íšŒì°¨", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3)

def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [4. ë¼ìš°íŒ… ë° ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸš€ {data['nickname']}ë‹˜ì´ ë©€í‹°ë²„ìŠ¤ ì„œë²„ì— ì ‘ì†í–ˆìŠµë‹ˆë‹¤!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ìˆ˜ìµ ê³µì‹]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ [ëŒ€ìš©ëŸ‰ ë°ì´í„° ë³€í™˜]\nê¸¸ì´: {msg_len}ì\në³´ìƒ: {reward}â‚© ì ë¦½ ì™„ë£Œ\nğŸ”— íŒŒì¼ ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ ì²˜ë¦¬]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        total = user['money'] + user['bank_money']
        res = f"ğŸ’° {nick}ë‹˜ì˜ ìì‚° ë³´ê³ ì„œ\n" \
              f"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" \
              f"ğŸ’µ í˜„ê¸ˆ: {user['money']:,}â‚©\n" \
              f"ğŸ¦ ì€í–‰: {user['bank_money']:,}â‚©\n" \
              f"ğŸ’³ ì´í•©: {total:,}â‚©\n" \
              f"ğŸ† ë“±ê¸‰: {'ì´ˆì›”ì' if total >= 10000000 else 'VIP' if total >= 1000000 else 'í‰ë¯¼'}"
        emit('message', {'msg': res, 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt:,}â‚©ì„ ì€í–‰ì— ì•ˆì „í•˜ê²Œ ë³´ê´€í–ˆìŠµë‹ˆë‹¤. (ë¶„ë‹¹ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ ì€í–‰ì—ì„œ {amt:,}â‚©ì„ ì¶œê¸ˆí–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ì´ ê°€ë™ë˜ì—ˆìŠµë‹ˆë‹¤! (3ì´ˆë‹¹ 5000â‚©)", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆ ì—”ì§„ì„ ì •ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            prompt = " ".join(cmd_parts[1:])
            res = client.models.generate_content(model="gemini-2.0-flash", contents=prompt)
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except Exception as e:
            emit('message', {'msg': f"âŒ ì—ëŸ¬: {str(e)}", 'type': 'system'})

    elif cmd == "!ëª…ë ¹ì–´":
        help_msg = "ğŸ“œ [ëª…ë ¹ì–´ ë¦¬ìŠ¤íŠ¸]\n!ì”ì•¡ - ë‚´ ìì‚° í™•ì¸\n!ì €ê¸ˆ [ì•¡ìˆ˜] - ì€í–‰ì— ì…ê¸ˆ\n!ì¶œê¸ˆ [ì•¡ìˆ˜] - í˜„ê¸ˆí™”\n!ë‡Œì ˆ - ë¬´í•œ ëˆ ë²Œê¸° ì‹œì‘\n!ë‡Œì ˆì¤‘ë‹¨ - ì¤‘ì§€\n!gemini [ì§ˆë¬¸] - AI ë‹µë³€\n!ëª…ë ¹ì–´ - ë„ì›€ë§"
        emit('message', {'msg': help_msg, 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ…
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=background_scheduler, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
import random
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í™˜ê²½] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "multiverse_empire.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {}

# Gemini AI í´ë¼ì´ì–¸íŠ¸ ì„¤ì •
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key:
        client = genai.Client(api_key=api_key)
except:
    print("Gemini SDKê°€ ì—†ê±°ë‚˜ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. !gemini ê¸°ëŠ¥ì€ ë¹„í™œì„±í™”ë©ë‹ˆë‹¤.")

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("""
            CREATE TABLE IF NOT EXISTS users (
                nickname TEXT PRIMARY KEY, 
                money INTEGER DEFAULT 1000, 
                bank_money INTEGER DEFAULT 0
            )
        """)
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ë° ë‰´ìŠ¤ ì‹œìŠ¤í…œ]
def background_scheduler():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤ ì‹¤í–‰
        with sqlite3.connect(DB_FILE) as conn:
            # 1. ì´ì ì§€ê¸‰ (1%)
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()
        
        # 2. ì‹¤ì‹œê°„ ê²½ì œ ë‰´ìŠ¤ ì´ë²¤íŠ¸
        news_list = [
            "ğŸ“¢ [ê²½ì œ] ì œêµ­ ì€í–‰ì˜ ê¸ˆë¦¬ê°€ ìƒìŠ¹ ì¡°ì§ì„ ë³´ì…ë‹ˆë‹¤!",
            "ğŸ“¢ [ì†Œì‹] ëŒ€ê·œëª¨ ë‡Œì ˆ ì—ë„ˆì§€ê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ì±„êµ´ íš¨ìœ¨ì´ ì¦ê°€í•©ë‹ˆë‹¤.",
            "ğŸ“¢ [ê³µì§€] í˜„ì¬ ìµœê³  ë¶€ìëŠ” 'ì´ˆì›”ì' ë“±ê¸‰ì„ ìœ ì§€í•˜ê³  ìˆìŠµë‹ˆë‹¤.",
            "ğŸ“¢ [ì´ë²¤íŠ¸] ì§€ê¸ˆ ì±„íŒ…ì„ ì…ë ¥í•˜ë©´ ë³´ë„ˆìŠ¤ í¬ì¸íŠ¸ê°€ ì§€ê¸‰ë  í™•ë¥ ì´ ë†’ìŠµë‹ˆë‹¤!"
        ]
        socketio.emit('message', {'msg': random.choice(news_list), 'type': 'system'}, room='main')

# --- [3. íŠ¹ìˆ˜ ê¸°ëŠ¥ ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 1
        reward = 5000
        update_money(nick, reward, bank=True)
        pattern = f"ğŸŒ€ [{nick}] ë‡Œì ˆ ë™ë ¥ ê°€ë™ ì¤‘... (+{reward}â‚© ì…ê¸ˆ)"
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"{pattern}\në¬´í•œ ë£¨í”„ íšŸìˆ˜: {m_count}íšŒì°¨", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3)

def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [4. ë¼ìš°íŒ… ë° ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸš€ {data['nickname']}ë‹˜ì´ ë©€í‹°ë²„ìŠ¤ ì„œë²„ì— ì ‘ì†í–ˆìŠµë‹ˆë‹¤!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ìˆ˜ìµ ê³µì‹]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ [ëŒ€ìš©ëŸ‰ ë°ì´í„° ë³€í™˜]\nê¸¸ì´: {msg_len}ì\në³´ìƒ: {reward}â‚© ì ë¦½ ì™„ë£Œ\nğŸ”— íŒŒì¼ ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ ì²˜ë¦¬]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        total = user['money'] + user['bank_money']
        res = f"ğŸ’° {nick}ë‹˜ì˜ ìì‚° ë³´ê³ ì„œ\n" \
              f"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" \
              f"ğŸ’µ í˜„ê¸ˆ: {user['money']:,}â‚©\n" \
              f"ğŸ¦ ì€í–‰: {user['bank_money']:,}â‚©\n" \
              f"ğŸ’³ ì´í•©: {total:,}â‚©\n" \
              f"ğŸ† ë“±ê¸‰: {'ì´ˆì›”ì' if total >= 10000000 else 'VIP' if total >= 1000000 else 'í‰ë¯¼'}"
        emit('message', {'msg': res, 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt:,}â‚©ì„ ì€í–‰ì— ì•ˆì „í•˜ê²Œ ë³´ê´€í–ˆìŠµë‹ˆë‹¤. (ë¶„ë‹¹ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ ì€í–‰ì—ì„œ {amt:,}â‚©ì„ ì¶œê¸ˆí–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ì´ ê°€ë™ë˜ì—ˆìŠµë‹ˆë‹¤! (3ì´ˆë‹¹ 5000â‚©)", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆ ì—”ì§„ì„ ì •ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            prompt = " ".join(cmd_parts[1:])
            res = client.models.generate_content(model="gemini-2.0-flash", contents=prompt)
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except Exception as e:
            emit('message', {'msg': f"âŒ ì—ëŸ¬: {str(e)}", 'type': 'system'})

    elif cmd == "!ëª…ë ¹ì–´":
        help_msg = "ğŸ“œ [ëª…ë ¹ì–´ ë¦¬ìŠ¤íŠ¸]\n!ì”ì•¡ - ë‚´ ìì‚° í™•ì¸\n!ì €ê¸ˆ [ì•¡ìˆ˜] - ì€í–‰ì— ì…ê¸ˆ\n!ì¶œê¸ˆ [ì•¡ìˆ˜] - í˜„ê¸ˆí™”\n!ë‡Œì ˆ - ë¬´í•œ ëˆ ë²Œê¸° ì‹œì‘\n!ë‡Œì ˆì¤‘ë‹¨ - ì¤‘ì§€\n!gemini [ì§ˆë¬¸] - AI ë‹µë³€\n!ëª…ë ¹ì–´ - ë„ì›€ë§"
        emit('message', {'msg': help_msg, 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ…
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=background_scheduler, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
import random
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í™˜ê²½] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "multiverse_empire.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {}

# Gemini AI í´ë¼ì´ì–¸íŠ¸ ì„¤ì •
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key:
        client = genai.Client(api_key=api_key)
except:
    print("Gemini SDKê°€ ì—†ê±°ë‚˜ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. !gemini ê¸°ëŠ¥ì€ ë¹„í™œì„±í™”ë©ë‹ˆë‹¤.")

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("""
            CREATE TABLE IF NOT EXISTS users (
                nickname TEXT PRIMARY KEY, 
                money INTEGER DEFAULT 1000, 
                bank_money INTEGER DEFAULT 0
            )
        """)
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ë° ë‰´ìŠ¤ ì‹œìŠ¤í…œ]
def background_scheduler():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤ ì‹¤í–‰
        with sqlite3.connect(DB_FILE) as conn:
            # 1. ì´ì ì§€ê¸‰ (1%)
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()
        
        # 2. ì‹¤ì‹œê°„ ê²½ì œ ë‰´ìŠ¤ ì´ë²¤íŠ¸
        news_list = [
            "ğŸ“¢ [ê²½ì œ] ì œêµ­ ì€í–‰ì˜ ê¸ˆë¦¬ê°€ ìƒìŠ¹ ì¡°ì§ì„ ë³´ì…ë‹ˆë‹¤!",
            "ğŸ“¢ [ì†Œì‹] ëŒ€ê·œëª¨ ë‡Œì ˆ ì—ë„ˆì§€ê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ì±„êµ´ íš¨ìœ¨ì´ ì¦ê°€í•©ë‹ˆë‹¤.",
            "ğŸ“¢ [ê³µì§€] í˜„ì¬ ìµœê³  ë¶€ìëŠ” 'ì´ˆì›”ì' ë“±ê¸‰ì„ ìœ ì§€í•˜ê³  ìˆìŠµë‹ˆë‹¤.",
            "ğŸ“¢ [ì´ë²¤íŠ¸] ì§€ê¸ˆ ì±„íŒ…ì„ ì…ë ¥í•˜ë©´ ë³´ë„ˆìŠ¤ í¬ì¸íŠ¸ê°€ ì§€ê¸‰ë  í™•ë¥ ì´ ë†’ìŠµë‹ˆë‹¤!"
        ]
        socketio.emit('message', {'msg': random.choice(news_list), 'type': 'system'}, room='main')

# --- [3. íŠ¹ìˆ˜ ê¸°ëŠ¥ ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 1
        reward = 5000
        update_money(nick, reward, bank=True)
        pattern = f"ğŸŒ€ [{nick}] ë‡Œì ˆ ë™ë ¥ ê°€ë™ ì¤‘... (+{reward}â‚© ì…ê¸ˆ)"
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"{pattern}\në¬´í•œ ë£¨í”„ íšŸìˆ˜: {m_count}íšŒì°¨", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3)

def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [4. ë¼ìš°íŒ… ë° ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸš€ {data['nickname']}ë‹˜ì´ ë©€í‹°ë²„ìŠ¤ ì„œë²„ì— ì ‘ì†í–ˆìŠµë‹ˆë‹¤!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ìˆ˜ìµ ê³µì‹]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ [ëŒ€ìš©ëŸ‰ ë°ì´í„° ë³€í™˜]\nê¸¸ì´: {msg_len}ì\në³´ìƒ: {reward}â‚© ì ë¦½ ì™„ë£Œ\nğŸ”— íŒŒì¼ ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ ì²˜ë¦¬]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        total = user['money'] + user['bank_money']
        res = f"ğŸ’° {nick}ë‹˜ì˜ ìì‚° ë³´ê³ ì„œ\n" \
              f"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" \
              f"ğŸ’µ í˜„ê¸ˆ: {user['money']:,}â‚©\n" \
              f"ğŸ¦ ì€í–‰: {user['bank_money']:,}â‚©\n" \
              f"ğŸ’³ ì´í•©: {total:,}â‚©\n" \
              f"ğŸ† ë“±ê¸‰: {'ì´ˆì›”ì' if total >= 10000000 else 'VIP' if total >= 1000000 else 'í‰ë¯¼'}"
        emit('message', {'msg': res, 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt:,}â‚©ì„ ì€í–‰ì— ì•ˆì „í•˜ê²Œ ë³´ê´€í–ˆìŠµë‹ˆë‹¤. (ë¶„ë‹¹ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ ì€í–‰ì—ì„œ {amt:,}â‚©ì„ ì¶œê¸ˆí–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ì´ ê°€ë™ë˜ì—ˆìŠµë‹ˆë‹¤! (3ì´ˆë‹¹ 5000â‚©)", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆ ì—”ì§„ì„ ì •ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            prompt = " ".join(cmd_parts[1:])
            res = client.models.generate_content(model="gemini-2.0-flash", contents=prompt)
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except Exception as e:
            emit('message', {'msg': f"âŒ ì—ëŸ¬: {str(e)}", 'type': 'system'})

    elif cmd == "!ëª…ë ¹ì–´":
        help_msg = "ğŸ“œ [ëª…ë ¹ì–´ ë¦¬ìŠ¤íŠ¸]\n!ì”ì•¡ - ë‚´ ìì‚° í™•ì¸\n!ì €ê¸ˆ [ì•¡ìˆ˜] - ì€í–‰ì— ì…ê¸ˆ\n!ì¶œê¸ˆ [ì•¡ìˆ˜] - í˜„ê¸ˆí™”\n!ë‡Œì ˆ - ë¬´í•œ ëˆ ë²Œê¸° ì‹œì‘\n!ë‡Œì ˆì¤‘ë‹¨ - ì¤‘ì§€\n!gemini [ì§ˆë¬¸] - AI ë‹µë³€\n!ëª…ë ¹ì–´ - ë„ì›€ë§"
        emit('message', {'msg': help_msg, 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ…
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=background_scheduler, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
import random
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í™˜ê²½] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "multiverse_empire.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {}

# Gemini AI í´ë¼ì´ì–¸íŠ¸ ì„¤ì •
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key:
        client = genai.Client(api_key=api_key)
except:
    print("Gemini SDKê°€ ì—†ê±°ë‚˜ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. !gemini ê¸°ëŠ¥ì€ ë¹„í™œì„±í™”ë©ë‹ˆë‹¤.")

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("""
            CREATE TABLE IF NOT EXISTS users (
                nickname TEXT PRIMARY KEY, 
                money INTEGER DEFAULT 1000, 
                bank_money INTEGER DEFAULT 0
            )
        """)
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ë° ë‰´ìŠ¤ ì‹œìŠ¤í…œ]
def background_scheduler():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤ ì‹¤í–‰
        with sqlite3.connect(DB_FILE) as conn:
            # 1. ì´ì ì§€ê¸‰ (1%)
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()
        
        # 2. ì‹¤ì‹œê°„ ê²½ì œ ë‰´ìŠ¤ ì´ë²¤íŠ¸
        news_list = [
            "ğŸ“¢ [ê²½ì œ] ì œêµ­ ì€í–‰ì˜ ê¸ˆë¦¬ê°€ ìƒìŠ¹ ì¡°ì§ì„ ë³´ì…ë‹ˆë‹¤!",
            "ğŸ“¢ [ì†Œì‹] ëŒ€ê·œëª¨ ë‡Œì ˆ ì—ë„ˆì§€ê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ì±„êµ´ íš¨ìœ¨ì´ ì¦ê°€í•©ë‹ˆë‹¤.",
            "ğŸ“¢ [ê³µì§€] í˜„ì¬ ìµœê³  ë¶€ìëŠ” 'ì´ˆì›”ì' ë“±ê¸‰ì„ ìœ ì§€í•˜ê³  ìˆìŠµë‹ˆë‹¤.",
            "ğŸ“¢ [ì´ë²¤íŠ¸] ì§€ê¸ˆ ì±„íŒ…ì„ ì…ë ¥í•˜ë©´ ë³´ë„ˆìŠ¤ í¬ì¸íŠ¸ê°€ ì§€ê¸‰ë  í™•ë¥ ì´ ë†’ìŠµë‹ˆë‹¤!"
        ]
        socketio.emit('message', {'msg': random.choice(news_list), 'type': 'system'}, room='main')

# --- [3. íŠ¹ìˆ˜ ê¸°ëŠ¥ ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 1
        reward = 5000
        update_money(nick, reward, bank=True)
        pattern = f"ğŸŒ€ [{nick}] ë‡Œì ˆ ë™ë ¥ ê°€ë™ ì¤‘... (+{reward}â‚© ì…ê¸ˆ)"
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"{pattern}\në¬´í•œ ë£¨í”„ íšŸìˆ˜: {m_count}íšŒì°¨", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3)

def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [4. ë¼ìš°íŒ… ë° ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸš€ {data['nickname']}ë‹˜ì´ ë©€í‹°ë²„ìŠ¤ ì„œë²„ì— ì ‘ì†í–ˆìŠµë‹ˆë‹¤!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ìˆ˜ìµ ê³µì‹]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ [ëŒ€ìš©ëŸ‰ ë°ì´í„° ë³€í™˜]\nê¸¸ì´: {msg_len}ì\në³´ìƒ: {reward}â‚© ì ë¦½ ì™„ë£Œ\nğŸ”— íŒŒì¼ ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ ì²˜ë¦¬]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        total = user['money'] + user['bank_money']
        res = f"ğŸ’° {nick}ë‹˜ì˜ ìì‚° ë³´ê³ ì„œ\n" \
              f"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" \
              f"ğŸ’µ í˜„ê¸ˆ: {user['money']:,}â‚©\n" \
              f"ğŸ¦ ì€í–‰: {user['bank_money']:,}â‚©\n" \
              f"ğŸ’³ ì´í•©: {total:,}â‚©\n" \
              f"ğŸ† ë“±ê¸‰: {'ì´ˆì›”ì' if total >= 10000000 else 'VIP' if total >= 1000000 else 'í‰ë¯¼'}"
        emit('message', {'msg': res, 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt:,}â‚©ì„ ì€í–‰ì— ì•ˆì „í•˜ê²Œ ë³´ê´€í–ˆìŠµë‹ˆë‹¤. (ë¶„ë‹¹ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ ì€í–‰ì—ì„œ {amt:,}â‚©ì„ ì¶œê¸ˆí–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ì´ ê°€ë™ë˜ì—ˆìŠµë‹ˆë‹¤! (3ì´ˆë‹¹ 5000â‚©)", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆ ì—”ì§„ì„ ì •ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            prompt = " ".join(cmd_parts[1:])
            res = client.models.generate_content(model="gemini-2.0-flash", contents=prompt)
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except Exception as e:
            emit('message', {'msg': f"âŒ ì—ëŸ¬: {str(e)}", 'type': 'system'})

    elif cmd == "!ëª…ë ¹ì–´":
        help_msg = "ğŸ“œ [ëª…ë ¹ì–´ ë¦¬ìŠ¤íŠ¸]\n!ì”ì•¡ - ë‚´ ìì‚° í™•ì¸\n!ì €ê¸ˆ [ì•¡ìˆ˜] - ì€í–‰ì— ì…ê¸ˆ\n!ì¶œê¸ˆ [ì•¡ìˆ˜] - í˜„ê¸ˆí™”\n!ë‡Œì ˆ - ë¬´í•œ ëˆ ë²Œê¸° ì‹œì‘\n!ë‡Œì ˆì¤‘ë‹¨ - ì¤‘ì§€\n!gemini [ì§ˆë¬¸] - AI ë‹µë³€\n!ëª…ë ¹ì–´ - ë„ì›€ë§"
        emit('message', {'msg': help_msg, 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ…
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=background_scheduler, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
import random
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í™˜ê²½] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "multiverse_empire.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {}

# Gemini AI í´ë¼ì´ì–¸íŠ¸ ì„¤ì •
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key:
        client = genai.Client(api_key=api_key)
except:
    print("Gemini SDKê°€ ì—†ê±°ë‚˜ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. !gemini ê¸°ëŠ¥ì€ ë¹„í™œì„±í™”ë©ë‹ˆë‹¤.")

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("""
            CREATE TABLE IF NOT EXISTS users (
                nickname TEXT PRIMARY KEY, 
                money INTEGER DEFAULT 1000, 
                bank_money INTEGER DEFAULT 0
            )
        """)
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ë° ë‰´ìŠ¤ ì‹œìŠ¤í…œ]
def background_scheduler():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤ ì‹¤í–‰
        with sqlite3.connect(DB_FILE) as conn:
            # 1. ì´ì ì§€ê¸‰ (1%)
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()
        
        # 2. ì‹¤ì‹œê°„ ê²½ì œ ë‰´ìŠ¤ ì´ë²¤íŠ¸
        news_list = [
            "ğŸ“¢ [ê²½ì œ] ì œêµ­ ì€í–‰ì˜ ê¸ˆë¦¬ê°€ ìƒìŠ¹ ì¡°ì§ì„ ë³´ì…ë‹ˆë‹¤!",
            "ğŸ“¢ [ì†Œì‹] ëŒ€ê·œëª¨ ë‡Œì ˆ ì—ë„ˆì§€ê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ì±„êµ´ íš¨ìœ¨ì´ ì¦ê°€í•©ë‹ˆë‹¤.",
            "ğŸ“¢ [ê³µì§€] í˜„ì¬ ìµœê³  ë¶€ìëŠ” 'ì´ˆì›”ì' ë“±ê¸‰ì„ ìœ ì§€í•˜ê³  ìˆìŠµë‹ˆë‹¤.",
            "ğŸ“¢ [ì´ë²¤íŠ¸] ì§€ê¸ˆ ì±„íŒ…ì„ ì…ë ¥í•˜ë©´ ë³´ë„ˆìŠ¤ í¬ì¸íŠ¸ê°€ ì§€ê¸‰ë  í™•ë¥ ì´ ë†’ìŠµë‹ˆë‹¤!"
        ]
        socketio.emit('message', {'msg': random.choice(news_list), 'type': 'system'}, room='main')

# --- [3. íŠ¹ìˆ˜ ê¸°ëŠ¥ ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 1
        reward = 5000
        update_money(nick, reward, bank=True)
        pattern = f"ğŸŒ€ [{nick}] ë‡Œì ˆ ë™ë ¥ ê°€ë™ ì¤‘... (+{reward}â‚© ì…ê¸ˆ)"
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"{pattern}\në¬´í•œ ë£¨í”„ íšŸìˆ˜: {m_count}íšŒì°¨", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3)

def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [4. ë¼ìš°íŒ… ë° ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸš€ {data['nickname']}ë‹˜ì´ ë©€í‹°ë²„ìŠ¤ ì„œë²„ì— ì ‘ì†í–ˆìŠµë‹ˆë‹¤!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ìˆ˜ìµ ê³µì‹]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ [ëŒ€ìš©ëŸ‰ ë°ì´í„° ë³€í™˜]\nê¸¸ì´: {msg_len}ì\në³´ìƒ: {reward}â‚© ì ë¦½ ì™„ë£Œ\nğŸ”— íŒŒì¼ ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ ì²˜ë¦¬]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        total = user['money'] + user['bank_money']
        res = f"ğŸ’° {nick}ë‹˜ì˜ ìì‚° ë³´ê³ ì„œ\n" \
              f"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" \
              f"ğŸ’µ í˜„ê¸ˆ: {user['money']:,}â‚©\n" \
              f"ğŸ¦ ì€í–‰: {user['bank_money']:,}â‚©\n" \
              f"ğŸ’³ ì´í•©: {total:,}â‚©\n" \
              f"ğŸ† ë“±ê¸‰: {'ì´ˆì›”ì' if total >= 10000000 else 'VIP' if total >= 1000000 else 'í‰ë¯¼'}"
        emit('message', {'msg': res, 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt:,}â‚©ì„ ì€í–‰ì— ì•ˆì „í•˜ê²Œ ë³´ê´€í–ˆìŠµë‹ˆë‹¤. (ë¶„ë‹¹ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ ì€í–‰ì—ì„œ {amt:,}â‚©ì„ ì¶œê¸ˆí–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ì´ ê°€ë™ë˜ì—ˆìŠµë‹ˆë‹¤! (3ì´ˆë‹¹ 5000â‚©)", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆ ì—”ì§„ì„ ì •ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            prompt = " ".join(cmd_parts[1:])
            res = client.models.generate_content(model="gemini-2.0-flash", contents=prompt)
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except Exception as e:
            emit('message', {'msg': f"âŒ ì—ëŸ¬: {str(e)}", 'type': 'system'})

    elif cmd == "!ëª…ë ¹ì–´":
        help_msg = "ğŸ“œ [ëª…ë ¹ì–´ ë¦¬ìŠ¤íŠ¸]\n!ì”ì•¡ - ë‚´ ìì‚° í™•ì¸\n!ì €ê¸ˆ [ì•¡ìˆ˜] - ì€í–‰ì— ì…ê¸ˆ\n!ì¶œê¸ˆ [ì•¡ìˆ˜] - í˜„ê¸ˆí™”\n!ë‡Œì ˆ - ë¬´í•œ ëˆ ë²Œê¸° ì‹œì‘\n!ë‡Œì ˆì¤‘ë‹¨ - ì¤‘ì§€\n!gemini [ì§ˆë¬¸] - AI ë‹µë³€\n!ëª…ë ¹ì–´ - ë„ì›€ë§"
        emit('message', {'msg': help_msg, 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ…
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=background_scheduler, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
import random
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í™˜ê²½] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "multiverse_empire.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {}

# Gemini AI í´ë¼ì´ì–¸íŠ¸ ì„¤ì •
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key:
        client = genai.Client(api_key=api_key)
except:
    print("Gemini SDKê°€ ì—†ê±°ë‚˜ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. !gemini ê¸°ëŠ¥ì€ ë¹„í™œì„±í™”ë©ë‹ˆë‹¤.")

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("""
            CREATE TABLE IF NOT EXISTS users (
                nickname TEXT PRIMARY KEY, 
                money INTEGER DEFAULT 1000, 
                bank_money INTEGER DEFAULT 0
            )
        """)
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ë° ë‰´ìŠ¤ ì‹œìŠ¤í…œ]
def background_scheduler():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤ ì‹¤í–‰
        with sqlite3.connect(DB_FILE) as conn:
            # 1. ì´ì ì§€ê¸‰ (1%)
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()
        
        # 2. ì‹¤ì‹œê°„ ê²½ì œ ë‰´ìŠ¤ ì´ë²¤íŠ¸
        news_list = [
            "ğŸ“¢ [ê²½ì œ] ì œêµ­ ì€í–‰ì˜ ê¸ˆë¦¬ê°€ ìƒìŠ¹ ì¡°ì§ì„ ë³´ì…ë‹ˆë‹¤!",
            "ğŸ“¢ [ì†Œì‹] ëŒ€ê·œëª¨ ë‡Œì ˆ ì—ë„ˆì§€ê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ì±„êµ´ íš¨ìœ¨ì´ ì¦ê°€í•©ë‹ˆë‹¤.",
            "ğŸ“¢ [ê³µì§€] í˜„ì¬ ìµœê³  ë¶€ìëŠ” 'ì´ˆì›”ì' ë“±ê¸‰ì„ ìœ ì§€í•˜ê³  ìˆìŠµë‹ˆë‹¤.",
            "ğŸ“¢ [ì´ë²¤íŠ¸] ì§€ê¸ˆ ì±„íŒ…ì„ ì…ë ¥í•˜ë©´ ë³´ë„ˆìŠ¤ í¬ì¸íŠ¸ê°€ ì§€ê¸‰ë  í™•ë¥ ì´ ë†’ìŠµë‹ˆë‹¤!"
        ]
        socketio.emit('message', {'msg': random.choice(news_list), 'type': 'system'}, room='main')

# --- [3. íŠ¹ìˆ˜ ê¸°ëŠ¥ ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 1
        reward = 5000
        update_money(nick, reward, bank=True)
        pattern = f"ğŸŒ€ [{nick}] ë‡Œì ˆ ë™ë ¥ ê°€ë™ ì¤‘... (+{reward}â‚© ì…ê¸ˆ)"
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"{pattern}\në¬´í•œ ë£¨í”„ íšŸìˆ˜: {m_count}íšŒì°¨", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3)

def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [4. ë¼ìš°íŒ… ë° ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸš€ {data['nickname']}ë‹˜ì´ ë©€í‹°ë²„ìŠ¤ ì„œë²„ì— ì ‘ì†í–ˆìŠµë‹ˆë‹¤!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ìˆ˜ìµ ê³µì‹]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ [ëŒ€ìš©ëŸ‰ ë°ì´í„° ë³€í™˜]\nê¸¸ì´: {msg_len}ì\në³´ìƒ: {reward}â‚© ì ë¦½ ì™„ë£Œ\nğŸ”— íŒŒì¼ ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ ì²˜ë¦¬]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        total = user['money'] + user['bank_money']
        res = f"ğŸ’° {nick}ë‹˜ì˜ ìì‚° ë³´ê³ ì„œ\n" \
              f"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" \
              f"ğŸ’µ í˜„ê¸ˆ: {user['money']:,}â‚©\n" \
              f"ğŸ¦ ì€í–‰: {user['bank_money']:,}â‚©\n" \
              f"ğŸ’³ ì´í•©: {total:,}â‚©\n" \
              f"ğŸ† ë“±ê¸‰: {'ì´ˆì›”ì' if total >= 10000000 else 'VIP' if total >= 1000000 else 'í‰ë¯¼'}"
        emit('message', {'msg': res, 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt:,}â‚©ì„ ì€í–‰ì— ì•ˆì „í•˜ê²Œ ë³´ê´€í–ˆìŠµë‹ˆë‹¤. (ë¶„ë‹¹ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ ì€í–‰ì—ì„œ {amt:,}â‚©ì„ ì¶œê¸ˆí–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ì´ ê°€ë™ë˜ì—ˆìŠµë‹ˆë‹¤! (3ì´ˆë‹¹ 5000â‚©)", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆ ì—”ì§„ì„ ì •ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            prompt = " ".join(cmd_parts[1:])
            res = client.models.generate_content(model="gemini-2.0-flash", contents=prompt)
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except Exception as e:
            emit('message', {'msg': f"âŒ ì—ëŸ¬: {str(e)}", 'type': 'system'})

    elif cmd == "!ëª…ë ¹ì–´":
        help_msg = "ğŸ“œ [ëª…ë ¹ì–´ ë¦¬ìŠ¤íŠ¸]\n!ì”ì•¡ - ë‚´ ìì‚° í™•ì¸\n!ì €ê¸ˆ [ì•¡ìˆ˜] - ì€í–‰ì— ì…ê¸ˆ\n!ì¶œê¸ˆ [ì•¡ìˆ˜] - í˜„ê¸ˆí™”\n!ë‡Œì ˆ - ë¬´í•œ ëˆ ë²Œê¸° ì‹œì‘\n!ë‡Œì ˆì¤‘ë‹¨ - ì¤‘ì§€\n!gemini [ì§ˆë¬¸] - AI ë‹µë³€\n!ëª…ë ¹ì–´ - ë„ì›€ë§"
        emit('message', {'msg': help_msg, 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ…
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=background_scheduler, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
import random
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í™˜ê²½] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "multiverse_empire.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {}

# Gemini AI í´ë¼ì´ì–¸íŠ¸ ì„¤ì •
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key:
        client = genai.Client(api_key=api_key)
except:
    print("Gemini SDKê°€ ì—†ê±°ë‚˜ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. !gemini ê¸°ëŠ¥ì€ ë¹„í™œì„±í™”ë©ë‹ˆë‹¤.")

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("""
            CREATE TABLE IF NOT EXISTS users (
                nickname TEXT PRIMARY KEY, 
                money INTEGER DEFAULT 1000, 
                bank_money INTEGER DEFAULT 0
            )
        """)
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ë° ë‰´ìŠ¤ ì‹œìŠ¤í…œ]
def background_scheduler():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤ ì‹¤í–‰
        with sqlite3.connect(DB_FILE) as conn:
            # 1. ì´ì ì§€ê¸‰ (1%)
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()
        
        # 2. ì‹¤ì‹œê°„ ê²½ì œ ë‰´ìŠ¤ ì´ë²¤íŠ¸
        news_list = [
            "ğŸ“¢ [ê²½ì œ] ì œêµ­ ì€í–‰ì˜ ê¸ˆë¦¬ê°€ ìƒìŠ¹ ì¡°ì§ì„ ë³´ì…ë‹ˆë‹¤!",
            "ğŸ“¢ [ì†Œì‹] ëŒ€ê·œëª¨ ë‡Œì ˆ ì—ë„ˆì§€ê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ì±„êµ´ íš¨ìœ¨ì´ ì¦ê°€í•©ë‹ˆë‹¤.",
            "ğŸ“¢ [ê³µì§€] í˜„ì¬ ìµœê³  ë¶€ìëŠ” 'ì´ˆì›”ì' ë“±ê¸‰ì„ ìœ ì§€í•˜ê³  ìˆìŠµë‹ˆë‹¤.",
            "ğŸ“¢ [ì´ë²¤íŠ¸] ì§€ê¸ˆ ì±„íŒ…ì„ ì…ë ¥í•˜ë©´ ë³´ë„ˆìŠ¤ í¬ì¸íŠ¸ê°€ ì§€ê¸‰ë  í™•ë¥ ì´ ë†’ìŠµë‹ˆë‹¤!"
        ]
        socketio.emit('message', {'msg': random.choice(news_list), 'type': 'system'}, room='main')

# --- [3. íŠ¹ìˆ˜ ê¸°ëŠ¥ ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 1
        reward = 5000
        update_money(nick, reward, bank=True)
        pattern = f"ğŸŒ€ [{nick}] ë‡Œì ˆ ë™ë ¥ ê°€ë™ ì¤‘... (+{reward}â‚© ì…ê¸ˆ)"
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"{pattern}\në¬´í•œ ë£¨í”„ íšŸìˆ˜: {m_count}íšŒì°¨", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3)

def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [4. ë¼ìš°íŒ… ë° ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸš€ {data['nickname']}ë‹˜ì´ ë©€í‹°ë²„ìŠ¤ ì„œë²„ì— ì ‘ì†í–ˆìŠµë‹ˆë‹¤!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ìˆ˜ìµ ê³µì‹]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ [ëŒ€ìš©ëŸ‰ ë°ì´í„° ë³€í™˜]\nê¸¸ì´: {msg_len}ì\në³´ìƒ: {reward}â‚© ì ë¦½ ì™„ë£Œ\nğŸ”— íŒŒì¼ ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ ì²˜ë¦¬]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        total = user['money'] + user['bank_money']
        res = f"ğŸ’° {nick}ë‹˜ì˜ ìì‚° ë³´ê³ ì„œ\n" \
              f"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" \
              f"ğŸ’µ í˜„ê¸ˆ: {user['money']:,}â‚©\n" \
              f"ğŸ¦ ì€í–‰: {user['bank_money']:,}â‚©\n" \
              f"ğŸ’³ ì´í•©: {total:,}â‚©\n" \
              f"ğŸ† ë“±ê¸‰: {'ì´ˆì›”ì' if total >= 10000000 else 'VIP' if total >= 1000000 else 'í‰ë¯¼'}"
        emit('message', {'msg': res, 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt:,}â‚©ì„ ì€í–‰ì— ì•ˆì „í•˜ê²Œ ë³´ê´€í–ˆìŠµë‹ˆë‹¤. (ë¶„ë‹¹ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ ì€í–‰ì—ì„œ {amt:,}â‚©ì„ ì¶œê¸ˆí–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ì´ ê°€ë™ë˜ì—ˆìŠµë‹ˆë‹¤! (3ì´ˆë‹¹ 5000â‚©)", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆ ì—”ì§„ì„ ì •ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            prompt = " ".join(cmd_parts[1:])
            res = client.models.generate_content(model="gemini-2.0-flash", contents=prompt)
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except Exception as e:
            emit('message', {'msg': f"âŒ ì—ëŸ¬: {str(e)}", 'type': 'system'})

    elif cmd == "!ëª…ë ¹ì–´":
        help_msg = "ğŸ“œ [ëª…ë ¹ì–´ ë¦¬ìŠ¤íŠ¸]\n!ì”ì•¡ - ë‚´ ìì‚° í™•ì¸\n!ì €ê¸ˆ [ì•¡ìˆ˜] - ì€í–‰ì— ì…ê¸ˆ\n!ì¶œê¸ˆ [ì•¡ìˆ˜] - í˜„ê¸ˆí™”\n!ë‡Œì ˆ - ë¬´í•œ ëˆ ë²Œê¸° ì‹œì‘\n!ë‡Œì ˆì¤‘ë‹¨ - ì¤‘ì§€\n!gemini [ì§ˆë¬¸] - AI ë‹µë³€\n!ëª…ë ¹ì–´ - ë„ì›€ë§"
        emit('message', {'msg': help_msg, 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ…
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=background_scheduler, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
import random
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í™˜ê²½] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "multiverse_empire.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {}

# Gemini AI í´ë¼ì´ì–¸íŠ¸ ì„¤ì •
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key:
        client = genai.Client(api_key=api_key)
except:
    print("Gemini SDKê°€ ì—†ê±°ë‚˜ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. !gemini ê¸°ëŠ¥ì€ ë¹„í™œì„±í™”ë©ë‹ˆë‹¤.")

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("""
            CREATE TABLE IF NOT EXISTS users (
                nickname TEXT PRIMARY KEY, 
                money INTEGER DEFAULT 1000, 
                bank_money INTEGER DEFAULT 0
            )
        """)
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ë° ë‰´ìŠ¤ ì‹œìŠ¤í…œ]
def background_scheduler():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤ ì‹¤í–‰
        with sqlite3.connect(DB_FILE) as conn:
            # 1. ì´ì ì§€ê¸‰ (1%)
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()
        
        # 2. ì‹¤ì‹œê°„ ê²½ì œ ë‰´ìŠ¤ ì´ë²¤íŠ¸
        news_list = [
            "ğŸ“¢ [ê²½ì œ] ì œêµ­ ì€í–‰ì˜ ê¸ˆë¦¬ê°€ ìƒìŠ¹ ì¡°ì§ì„ ë³´ì…ë‹ˆë‹¤!",
            "ğŸ“¢ [ì†Œì‹] ëŒ€ê·œëª¨ ë‡Œì ˆ ì—ë„ˆì§€ê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ì±„êµ´ íš¨ìœ¨ì´ ì¦ê°€í•©ë‹ˆë‹¤.",
            "ğŸ“¢ [ê³µì§€] í˜„ì¬ ìµœê³  ë¶€ìëŠ” 'ì´ˆì›”ì' ë“±ê¸‰ì„ ìœ ì§€í•˜ê³  ìˆìŠµë‹ˆë‹¤.",
            "ğŸ“¢ [ì´ë²¤íŠ¸] ì§€ê¸ˆ ì±„íŒ…ì„ ì…ë ¥í•˜ë©´ ë³´ë„ˆìŠ¤ í¬ì¸íŠ¸ê°€ ì§€ê¸‰ë  í™•ë¥ ì´ ë†’ìŠµë‹ˆë‹¤!"
        ]
        socketio.emit('message', {'msg': random.choice(news_list), 'type': 'system'}, room='main')

# --- [3. íŠ¹ìˆ˜ ê¸°ëŠ¥ ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 1
        reward = 5000
        update_money(nick, reward, bank=True)
        pattern = f"ğŸŒ€ [{nick}] ë‡Œì ˆ ë™ë ¥ ê°€ë™ ì¤‘... (+{reward}â‚© ì…ê¸ˆ)"
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"{pattern}\në¬´í•œ ë£¨í”„ íšŸìˆ˜: {m_count}íšŒì°¨", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3)

def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [4. ë¼ìš°íŒ… ë° ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸš€ {data['nickname']}ë‹˜ì´ ë©€í‹°ë²„ìŠ¤ ì„œë²„ì— ì ‘ì†í–ˆìŠµë‹ˆë‹¤!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ìˆ˜ìµ ê³µì‹]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ [ëŒ€ìš©ëŸ‰ ë°ì´í„° ë³€í™˜]\nê¸¸ì´: {msg_len}ì\në³´ìƒ: {reward}â‚© ì ë¦½ ì™„ë£Œ\nğŸ”— íŒŒì¼ ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ ì²˜ë¦¬]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        total = user['money'] + user['bank_money']
        res = f"ğŸ’° {nick}ë‹˜ì˜ ìì‚° ë³´ê³ ì„œ\n" \
              f"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" \
              f"ğŸ’µ í˜„ê¸ˆ: {user['money']:,}â‚©\n" \
              f"ğŸ¦ ì€í–‰: {user['bank_money']:,}â‚©\n" \
              f"ğŸ’³ ì´í•©: {total:,}â‚©\n" \
              f"ğŸ† ë“±ê¸‰: {'ì´ˆì›”ì' if total >= 10000000 else 'VIP' if total >= 1000000 else 'í‰ë¯¼'}"
        emit('message', {'msg': res, 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt:,}â‚©ì„ ì€í–‰ì— ì•ˆì „í•˜ê²Œ ë³´ê´€í–ˆìŠµë‹ˆë‹¤. (ë¶„ë‹¹ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ ì€í–‰ì—ì„œ {amt:,}â‚©ì„ ì¶œê¸ˆí–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ì´ ê°€ë™ë˜ì—ˆìŠµë‹ˆë‹¤! (3ì´ˆë‹¹ 5000â‚©)", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆ ì—”ì§„ì„ ì •ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            prompt = " ".join(cmd_parts[1:])
            res = client.models.generate_content(model="gemini-2.0-flash", contents=prompt)
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except Exception as e:
            emit('message', {'msg': f"âŒ ì—ëŸ¬: {str(e)}", 'type': 'system'})

    elif cmd == "!ëª…ë ¹ì–´":
        help_msg = "ğŸ“œ [ëª…ë ¹ì–´ ë¦¬ìŠ¤íŠ¸]\n!ì”ì•¡ - ë‚´ ìì‚° í™•ì¸\n!ì €ê¸ˆ [ì•¡ìˆ˜] - ì€í–‰ì— ì…ê¸ˆ\n!ì¶œê¸ˆ [ì•¡ìˆ˜] - í˜„ê¸ˆí™”\n!ë‡Œì ˆ - ë¬´í•œ ëˆ ë²Œê¸° ì‹œì‘\n!ë‡Œì ˆì¤‘ë‹¨ - ì¤‘ì§€\n!gemini [ì§ˆë¬¸] - AI ë‹µë³€\n!ëª…ë ¹ì–´ - ë„ì›€ë§"
        emit('message', {'msg': help_msg, 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ…
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=background_scheduler, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
import random
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í™˜ê²½] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "multiverse_empire.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {}

# Gemini AI í´ë¼ì´ì–¸íŠ¸ ì„¤ì •
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key:
        client = genai.Client(api_key=api_key)
except:
    print("Gemini SDKê°€ ì—†ê±°ë‚˜ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. !gemini ê¸°ëŠ¥ì€ ë¹„í™œì„±í™”ë©ë‹ˆë‹¤.")

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("""
            CREATE TABLE IF NOT EXISTS users (
                nickname TEXT PRIMARY KEY, 
                money INTEGER DEFAULT 1000, 
                bank_money INTEGER DEFAULT 0
            )
        """)
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ë° ë‰´ìŠ¤ ì‹œìŠ¤í…œ]
def background_scheduler():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤ ì‹¤í–‰
        with sqlite3.connect(DB_FILE) as conn:
            # 1. ì´ì ì§€ê¸‰ (1%)
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()
        
        # 2. ì‹¤ì‹œê°„ ê²½ì œ ë‰´ìŠ¤ ì´ë²¤íŠ¸
        news_list = [
            "ğŸ“¢ [ê²½ì œ] ì œêµ­ ì€í–‰ì˜ ê¸ˆë¦¬ê°€ ìƒìŠ¹ ì¡°ì§ì„ ë³´ì…ë‹ˆë‹¤!",
            "ğŸ“¢ [ì†Œì‹] ëŒ€ê·œëª¨ ë‡Œì ˆ ì—ë„ˆì§€ê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ì±„êµ´ íš¨ìœ¨ì´ ì¦ê°€í•©ë‹ˆë‹¤.",
            "ğŸ“¢ [ê³µì§€] í˜„ì¬ ìµœê³  ë¶€ìëŠ” 'ì´ˆì›”ì' ë“±ê¸‰ì„ ìœ ì§€í•˜ê³  ìˆìŠµë‹ˆë‹¤.",
            "ğŸ“¢ [ì´ë²¤íŠ¸] ì§€ê¸ˆ ì±„íŒ…ì„ ì…ë ¥í•˜ë©´ ë³´ë„ˆìŠ¤ í¬ì¸íŠ¸ê°€ ì§€ê¸‰ë  í™•ë¥ ì´ ë†’ìŠµë‹ˆë‹¤!"
        ]
        socketio.emit('message', {'msg': random.choice(news_list), 'type': 'system'}, room='main')

# --- [3. íŠ¹ìˆ˜ ê¸°ëŠ¥ ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 1
        reward = 5000
        update_money(nick, reward, bank=True)
        pattern = f"ğŸŒ€ [{nick}] ë‡Œì ˆ ë™ë ¥ ê°€ë™ ì¤‘... (+{reward}â‚© ì…ê¸ˆ)"
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"{pattern}\në¬´í•œ ë£¨í”„ íšŸìˆ˜: {m_count}íšŒì°¨", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3)

def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [4. ë¼ìš°íŒ… ë° ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸš€ {data['nickname']}ë‹˜ì´ ë©€í‹°ë²„ìŠ¤ ì„œë²„ì— ì ‘ì†í–ˆìŠµë‹ˆë‹¤!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ìˆ˜ìµ ê³µì‹]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ [ëŒ€ìš©ëŸ‰ ë°ì´í„° ë³€í™˜]\nê¸¸ì´: {msg_len}ì\në³´ìƒ: {reward}â‚© ì ë¦½ ì™„ë£Œ\nğŸ”— íŒŒì¼ ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ ì²˜ë¦¬]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        total = user['money'] + user['bank_money']
        res = f"ğŸ’° {nick}ë‹˜ì˜ ìì‚° ë³´ê³ ì„œ\n" \
              f"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" \
              f"ğŸ’µ í˜„ê¸ˆ: {user['money']:,}â‚©\n" \
              f"ğŸ¦ ì€í–‰: {user['bank_money']:,}â‚©\n" \
              f"ğŸ’³ ì´í•©: {total:,}â‚©\n" \
              f"ğŸ† ë“±ê¸‰: {'ì´ˆì›”ì' if total >= 10000000 else 'VIP' if total >= 1000000 else 'í‰ë¯¼'}"
        emit('message', {'msg': res, 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt:,}â‚©ì„ ì€í–‰ì— ì•ˆì „í•˜ê²Œ ë³´ê´€í–ˆìŠµë‹ˆë‹¤. (ë¶„ë‹¹ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ ì€í–‰ì—ì„œ {amt:,}â‚©ì„ ì¶œê¸ˆí–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ì´ ê°€ë™ë˜ì—ˆìŠµë‹ˆë‹¤! (3ì´ˆë‹¹ 5000â‚©)", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆ ì—”ì§„ì„ ì •ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            prompt = " ".join(cmd_parts[1:])
            res = client.models.generate_content(model="gemini-2.0-flash", contents=prompt)
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except Exception as e:
            emit('message', {'msg': f"âŒ ì—ëŸ¬: {str(e)}", 'type': 'system'})

    elif cmd == "!ëª…ë ¹ì–´":
        help_msg = "ğŸ“œ [ëª…ë ¹ì–´ ë¦¬ìŠ¤íŠ¸]\n!ì”ì•¡ - ë‚´ ìì‚° í™•ì¸\n!ì €ê¸ˆ [ì•¡ìˆ˜] - ì€í–‰ì— ì…ê¸ˆ\n!ì¶œê¸ˆ [ì•¡ìˆ˜] - í˜„ê¸ˆí™”\n!ë‡Œì ˆ - ë¬´í•œ ëˆ ë²Œê¸° ì‹œì‘\n!ë‡Œì ˆì¤‘ë‹¨ - ì¤‘ì§€\n!gemini [ì§ˆë¬¸] - AI ë‹µë³€\n!ëª…ë ¹ì–´ - ë„ì›€ë§"
        emit('message', {'msg': help_msg, 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ…
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=background_scheduler, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
import random
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í™˜ê²½] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "multiverse_empire.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {}

# Gemini AI í´ë¼ì´ì–¸íŠ¸ ì„¤ì •
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key:
        client = genai.Client(api_key=api_key)
except:
    print("Gemini SDKê°€ ì—†ê±°ë‚˜ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. !gemini ê¸°ëŠ¥ì€ ë¹„í™œì„±í™”ë©ë‹ˆë‹¤.")

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("""
            CREATE TABLE IF NOT EXISTS users (
                nickname TEXT PRIMARY KEY, 
                money INTEGER DEFAULT 1000, 
                bank_money INTEGER DEFAULT 0
            )
        """)
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ë° ë‰´ìŠ¤ ì‹œìŠ¤í…œ]
def background_scheduler():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤ ì‹¤í–‰
        with sqlite3.connect(DB_FILE) as conn:
            # 1. ì´ì ì§€ê¸‰ (1%)
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()
        
        # 2. ì‹¤ì‹œê°„ ê²½ì œ ë‰´ìŠ¤ ì´ë²¤íŠ¸
        news_list = [
            "ğŸ“¢ [ê²½ì œ] ì œêµ­ ì€í–‰ì˜ ê¸ˆë¦¬ê°€ ìƒìŠ¹ ì¡°ì§ì„ ë³´ì…ë‹ˆë‹¤!",
            "ğŸ“¢ [ì†Œì‹] ëŒ€ê·œëª¨ ë‡Œì ˆ ì—ë„ˆì§€ê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ì±„êµ´ íš¨ìœ¨ì´ ì¦ê°€í•©ë‹ˆë‹¤.",
            "ğŸ“¢ [ê³µì§€] í˜„ì¬ ìµœê³  ë¶€ìëŠ” 'ì´ˆì›”ì' ë“±ê¸‰ì„ ìœ ì§€í•˜ê³  ìˆìŠµë‹ˆë‹¤.",
            "ğŸ“¢ [ì´ë²¤íŠ¸] ì§€ê¸ˆ ì±„íŒ…ì„ ì…ë ¥í•˜ë©´ ë³´ë„ˆìŠ¤ í¬ì¸íŠ¸ê°€ ì§€ê¸‰ë  í™•ë¥ ì´ ë†’ìŠµë‹ˆë‹¤!"
        ]
        socketio.emit('message', {'msg': random.choice(news_list), 'type': 'system'}, room='main')

# --- [3. íŠ¹ìˆ˜ ê¸°ëŠ¥ ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 1
        reward = 5000
        update_money(nick, reward, bank=True)
        pattern = f"ğŸŒ€ [{nick}] ë‡Œì ˆ ë™ë ¥ ê°€ë™ ì¤‘... (+{reward}â‚© ì…ê¸ˆ)"
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"{pattern}\në¬´í•œ ë£¨í”„ íšŸìˆ˜: {m_count}íšŒì°¨", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3)

def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [4. ë¼ìš°íŒ… ë° ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸš€ {data['nickname']}ë‹˜ì´ ë©€í‹°ë²„ìŠ¤ ì„œë²„ì— ì ‘ì†í–ˆìŠµë‹ˆë‹¤!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ìˆ˜ìµ ê³µì‹]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ [ëŒ€ìš©ëŸ‰ ë°ì´í„° ë³€í™˜]\nê¸¸ì´: {msg_len}ì\në³´ìƒ: {reward}â‚© ì ë¦½ ì™„ë£Œ\nğŸ”— íŒŒì¼ ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ ì²˜ë¦¬]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        total = user['money'] + user['bank_money']
        res = f"ğŸ’° {nick}ë‹˜ì˜ ìì‚° ë³´ê³ ì„œ\n" \
              f"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" \
              f"ğŸ’µ í˜„ê¸ˆ: {user['money']:,}â‚©\n" \
              f"ğŸ¦ ì€í–‰: {user['bank_money']:,}â‚©\n" \
              f"ğŸ’³ ì´í•©: {total:,}â‚©\n" \
              f"ğŸ† ë“±ê¸‰: {'ì´ˆì›”ì' if total >= 10000000 else 'VIP' if total >= 1000000 else 'í‰ë¯¼'}"
        emit('message', {'msg': res, 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt:,}â‚©ì„ ì€í–‰ì— ì•ˆì „í•˜ê²Œ ë³´ê´€í–ˆìŠµë‹ˆë‹¤. (ë¶„ë‹¹ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ ì€í–‰ì—ì„œ {amt:,}â‚©ì„ ì¶œê¸ˆí–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ì´ ê°€ë™ë˜ì—ˆìŠµë‹ˆë‹¤! (3ì´ˆë‹¹ 5000â‚©)", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆ ì—”ì§„ì„ ì •ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            prompt = " ".join(cmd_parts[1:])
            res = client.models.generate_content(model="gemini-2.0-flash", contents=prompt)
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except Exception as e:
            emit('message', {'msg': f"âŒ ì—ëŸ¬: {str(e)}", 'type': 'system'})

    elif cmd == "!ëª…ë ¹ì–´":
        help_msg = "ğŸ“œ [ëª…ë ¹ì–´ ë¦¬ìŠ¤íŠ¸]\n!ì”ì•¡ - ë‚´ ìì‚° í™•ì¸\n!ì €ê¸ˆ [ì•¡ìˆ˜] - ì€í–‰ì— ì…ê¸ˆ\n!ì¶œê¸ˆ [ì•¡ìˆ˜] - í˜„ê¸ˆí™”\n!ë‡Œì ˆ - ë¬´í•œ ëˆ ë²Œê¸° ì‹œì‘\n!ë‡Œì ˆì¤‘ë‹¨ - ì¤‘ì§€\n!gemini [ì§ˆë¬¸] - AI ë‹µë³€\n!ëª…ë ¹ì–´ - ë„ì›€ë§"
        emit('message', {'msg': help_msg, 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ…
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=background_scheduler, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
import random
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í™˜ê²½] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "multiverse_empire.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {}

# Gemini AI í´ë¼ì´ì–¸íŠ¸ ì„¤ì •
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key:
        client = genai.Client(api_key=api_key)
except:
    print("Gemini SDKê°€ ì—†ê±°ë‚˜ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. !gemini ê¸°ëŠ¥ì€ ë¹„í™œì„±í™”ë©ë‹ˆë‹¤.")

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("""
            CREATE TABLE IF NOT EXISTS users (
                nickname TEXT PRIMARY KEY, 
                money INTEGER DEFAULT 1000, 
                bank_money INTEGER DEFAULT 0
            )
        """)
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ë° ë‰´ìŠ¤ ì‹œìŠ¤í…œ]
def background_scheduler():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤ ì‹¤í–‰
        with sqlite3.connect(DB_FILE) as conn:
            # 1. ì´ì ì§€ê¸‰ (1%)
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()
        
        # 2. ì‹¤ì‹œê°„ ê²½ì œ ë‰´ìŠ¤ ì´ë²¤íŠ¸
        news_list = [
            "ğŸ“¢ [ê²½ì œ] ì œêµ­ ì€í–‰ì˜ ê¸ˆë¦¬ê°€ ìƒìŠ¹ ì¡°ì§ì„ ë³´ì…ë‹ˆë‹¤!",
            "ğŸ“¢ [ì†Œì‹] ëŒ€ê·œëª¨ ë‡Œì ˆ ì—ë„ˆì§€ê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ì±„êµ´ íš¨ìœ¨ì´ ì¦ê°€í•©ë‹ˆë‹¤.",
            "ğŸ“¢ [ê³µì§€] í˜„ì¬ ìµœê³  ë¶€ìëŠ” 'ì´ˆì›”ì' ë“±ê¸‰ì„ ìœ ì§€í•˜ê³  ìˆìŠµë‹ˆë‹¤.",
            "ğŸ“¢ [ì´ë²¤íŠ¸] ì§€ê¸ˆ ì±„íŒ…ì„ ì…ë ¥í•˜ë©´ ë³´ë„ˆìŠ¤ í¬ì¸íŠ¸ê°€ ì§€ê¸‰ë  í™•ë¥ ì´ ë†’ìŠµë‹ˆë‹¤!"
        ]
        socketio.emit('message', {'msg': random.choice(news_list), 'type': 'system'}, room='main')

# --- [3. íŠ¹ìˆ˜ ê¸°ëŠ¥ ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 1
        reward = 5000
        update_money(nick, reward, bank=True)
        pattern = f"ğŸŒ€ [{nick}] ë‡Œì ˆ ë™ë ¥ ê°€ë™ ì¤‘... (+{reward}â‚© ì…ê¸ˆ)"
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"{pattern}\në¬´í•œ ë£¨í”„ íšŸìˆ˜: {m_count}íšŒì°¨", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3)

def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [4. ë¼ìš°íŒ… ë° ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸš€ {data['nickname']}ë‹˜ì´ ë©€í‹°ë²„ìŠ¤ ì„œë²„ì— ì ‘ì†í–ˆìŠµë‹ˆë‹¤!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ìˆ˜ìµ ê³µì‹]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ [ëŒ€ìš©ëŸ‰ ë°ì´í„° ë³€í™˜]\nê¸¸ì´: {msg_len}ì\në³´ìƒ: {reward}â‚© ì ë¦½ ì™„ë£Œ\nğŸ”— íŒŒì¼ ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ ì²˜ë¦¬]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        total = user['money'] + user['bank_money']
        res = f"ğŸ’° {nick}ë‹˜ì˜ ìì‚° ë³´ê³ ì„œ\n" \
              f"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" \
              f"ğŸ’µ í˜„ê¸ˆ: {user['money']:,}â‚©\n" \
              f"ğŸ¦ ì€í–‰: {user['bank_money']:,}â‚©\n" \
              f"ğŸ’³ ì´í•©: {total:,}â‚©\n" \
              f"ğŸ† ë“±ê¸‰: {'ì´ˆì›”ì' if total >= 10000000 else 'VIP' if total >= 1000000 else 'í‰ë¯¼'}"
        emit('message', {'msg': res, 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt:,}â‚©ì„ ì€í–‰ì— ì•ˆì „í•˜ê²Œ ë³´ê´€í–ˆìŠµë‹ˆë‹¤. (ë¶„ë‹¹ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ ì€í–‰ì—ì„œ {amt:,}â‚©ì„ ì¶œê¸ˆí–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ì´ ê°€ë™ë˜ì—ˆìŠµë‹ˆë‹¤! (3ì´ˆë‹¹ 5000â‚©)", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆ ì—”ì§„ì„ ì •ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            prompt = " ".join(cmd_parts[1:])
            res = client.models.generate_content(model="gemini-2.0-flash", contents=prompt)
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except Exception as e:
            emit('message', {'msg': f"âŒ ì—ëŸ¬: {str(e)}", 'type': 'system'})

    elif cmd == "!ëª…ë ¹ì–´":
        help_msg = "ğŸ“œ [ëª…ë ¹ì–´ ë¦¬ìŠ¤íŠ¸]\n!ì”ì•¡ - ë‚´ ìì‚° í™•ì¸\n!ì €ê¸ˆ [ì•¡ìˆ˜] - ì€í–‰ì— ì…ê¸ˆ\n!ì¶œê¸ˆ [ì•¡ìˆ˜] - í˜„ê¸ˆí™”\n!ë‡Œì ˆ - ë¬´í•œ ëˆ ë²Œê¸° ì‹œì‘\n!ë‡Œì ˆì¤‘ë‹¨ - ì¤‘ì§€\n!gemini [ì§ˆë¬¸] - AI ë‹µë³€\n!ëª…ë ¹ì–´ - ë„ì›€ë§"
        emit('message', {'msg': help_msg, 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ…
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=background_scheduler, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
import random
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í™˜ê²½] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "multiverse_empire.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {}

# Gemini AI í´ë¼ì´ì–¸íŠ¸ ì„¤ì •
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key:
        client = genai.Client(api_key=api_key)
except:
    print("Gemini SDKê°€ ì—†ê±°ë‚˜ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. !gemini ê¸°ëŠ¥ì€ ë¹„í™œì„±í™”ë©ë‹ˆë‹¤.")

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("""
            CREATE TABLE IF NOT EXISTS users (
                nickname TEXT PRIMARY KEY, 
                money INTEGER DEFAULT 1000, 
                bank_money INTEGER DEFAULT 0
            )
        """)
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ë° ë‰´ìŠ¤ ì‹œìŠ¤í…œ]
def background_scheduler():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤ ì‹¤í–‰
        with sqlite3.connect(DB_FILE) as conn:
            # 1. ì´ì ì§€ê¸‰ (1%)
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()
        
        # 2. ì‹¤ì‹œê°„ ê²½ì œ ë‰´ìŠ¤ ì´ë²¤íŠ¸
        news_list = [
            "ğŸ“¢ [ê²½ì œ] ì œêµ­ ì€í–‰ì˜ ê¸ˆë¦¬ê°€ ìƒìŠ¹ ì¡°ì§ì„ ë³´ì…ë‹ˆë‹¤!",
            "ğŸ“¢ [ì†Œì‹] ëŒ€ê·œëª¨ ë‡Œì ˆ ì—ë„ˆì§€ê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ì±„êµ´ íš¨ìœ¨ì´ ì¦ê°€í•©ë‹ˆë‹¤.",
            "ğŸ“¢ [ê³µì§€] í˜„ì¬ ìµœê³  ë¶€ìëŠ” 'ì´ˆì›”ì' ë“±ê¸‰ì„ ìœ ì§€í•˜ê³  ìˆìŠµë‹ˆë‹¤.",
            "ğŸ“¢ [ì´ë²¤íŠ¸] ì§€ê¸ˆ ì±„íŒ…ì„ ì…ë ¥í•˜ë©´ ë³´ë„ˆìŠ¤ í¬ì¸íŠ¸ê°€ ì§€ê¸‰ë  í™•ë¥ ì´ ë†’ìŠµë‹ˆë‹¤!"
        ]
        socketio.emit('message', {'msg': random.choice(news_list), 'type': 'system'}, room='main')

# --- [3. íŠ¹ìˆ˜ ê¸°ëŠ¥ ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 1
        reward = 5000
        update_money(nick, reward, bank=True)
        pattern = f"ğŸŒ€ [{nick}] ë‡Œì ˆ ë™ë ¥ ê°€ë™ ì¤‘... (+{reward}â‚© ì…ê¸ˆ)"
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"{pattern}\në¬´í•œ ë£¨í”„ íšŸìˆ˜: {m_count}íšŒì°¨", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3)

def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [4. ë¼ìš°íŒ… ë° ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸš€ {data['nickname']}ë‹˜ì´ ë©€í‹°ë²„ìŠ¤ ì„œë²„ì— ì ‘ì†í–ˆìŠµë‹ˆë‹¤!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ìˆ˜ìµ ê³µì‹]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ [ëŒ€ìš©ëŸ‰ ë°ì´í„° ë³€í™˜]\nê¸¸ì´: {msg_len}ì\në³´ìƒ: {reward}â‚© ì ë¦½ ì™„ë£Œ\nğŸ”— íŒŒì¼ ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ ì²˜ë¦¬]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        total = user['money'] + user['bank_money']
        res = f"ğŸ’° {nick}ë‹˜ì˜ ìì‚° ë³´ê³ ì„œ\n" \
              f"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" \
              f"ğŸ’µ í˜„ê¸ˆ: {user['money']:,}â‚©\n" \
              f"ğŸ¦ ì€í–‰: {user['bank_money']:,}â‚©\n" \
              f"ğŸ’³ ì´í•©: {total:,}â‚©\n" \
              f"ğŸ† ë“±ê¸‰: {'ì´ˆì›”ì' if total >= 10000000 else 'VIP' if total >= 1000000 else 'í‰ë¯¼'}"
        emit('message', {'msg': res, 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt:,}â‚©ì„ ì€í–‰ì— ì•ˆì „í•˜ê²Œ ë³´ê´€í–ˆìŠµë‹ˆë‹¤. (ë¶„ë‹¹ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ ì€í–‰ì—ì„œ {amt:,}â‚©ì„ ì¶œê¸ˆí–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ì´ ê°€ë™ë˜ì—ˆìŠµë‹ˆë‹¤! (3ì´ˆë‹¹ 5000â‚©)", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆ ì—”ì§„ì„ ì •ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            prompt = " ".join(cmd_parts[1:])
            res = client.models.generate_content(model="gemini-2.0-flash", contents=prompt)
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except Exception as e:
            emit('message', {'msg': f"âŒ ì—ëŸ¬: {str(e)}", 'type': 'system'})

    elif cmd == "!ëª…ë ¹ì–´":
        help_msg = "ğŸ“œ [ëª…ë ¹ì–´ ë¦¬ìŠ¤íŠ¸]\n!ì”ì•¡ - ë‚´ ìì‚° í™•ì¸\n!ì €ê¸ˆ [ì•¡ìˆ˜] - ì€í–‰ì— ì…ê¸ˆ\n!ì¶œê¸ˆ [ì•¡ìˆ˜] - í˜„ê¸ˆí™”\n!ë‡Œì ˆ - ë¬´í•œ ëˆ ë²Œê¸° ì‹œì‘\n!ë‡Œì ˆì¤‘ë‹¨ - ì¤‘ì§€\n!gemini [ì§ˆë¬¸] - AI ë‹µë³€\n!ëª…ë ¹ì–´ - ë„ì›€ë§"
        emit('message', {'msg': help_msg, 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ…
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=background_scheduler, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
import random
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í™˜ê²½] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "multiverse_empire.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {}

# Gemini AI í´ë¼ì´ì–¸íŠ¸ ì„¤ì •
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key:
        client = genai.Client(api_key=api_key)
except:
    print("Gemini SDKê°€ ì—†ê±°ë‚˜ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. !gemini ê¸°ëŠ¥ì€ ë¹„í™œì„±í™”ë©ë‹ˆë‹¤.")

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("""
            CREATE TABLE IF NOT EXISTS users (
                nickname TEXT PRIMARY KEY, 
                money INTEGER DEFAULT 1000, 
                bank_money INTEGER DEFAULT 0
            )
        """)
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ë° ë‰´ìŠ¤ ì‹œìŠ¤í…œ]
def background_scheduler():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤ ì‹¤í–‰
        with sqlite3.connect(DB_FILE) as conn:
            # 1. ì´ì ì§€ê¸‰ (1%)
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()
        
        # 2. ì‹¤ì‹œê°„ ê²½ì œ ë‰´ìŠ¤ ì´ë²¤íŠ¸
        news_list = [
            "ğŸ“¢ [ê²½ì œ] ì œêµ­ ì€í–‰ì˜ ê¸ˆë¦¬ê°€ ìƒìŠ¹ ì¡°ì§ì„ ë³´ì…ë‹ˆë‹¤!",
            "ğŸ“¢ [ì†Œì‹] ëŒ€ê·œëª¨ ë‡Œì ˆ ì—ë„ˆì§€ê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ì±„êµ´ íš¨ìœ¨ì´ ì¦ê°€í•©ë‹ˆë‹¤.",
            "ğŸ“¢ [ê³µì§€] í˜„ì¬ ìµœê³  ë¶€ìëŠ” 'ì´ˆì›”ì' ë“±ê¸‰ì„ ìœ ì§€í•˜ê³  ìˆìŠµë‹ˆë‹¤.",
            "ğŸ“¢ [ì´ë²¤íŠ¸] ì§€ê¸ˆ ì±„íŒ…ì„ ì…ë ¥í•˜ë©´ ë³´ë„ˆìŠ¤ í¬ì¸íŠ¸ê°€ ì§€ê¸‰ë  í™•ë¥ ì´ ë†’ìŠµë‹ˆë‹¤!"
        ]
        socketio.emit('message', {'msg': random.choice(news_list), 'type': 'system'}, room='main')

# --- [3. íŠ¹ìˆ˜ ê¸°ëŠ¥ ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 1
        reward = 5000
        update_money(nick, reward, bank=True)
        pattern = f"ğŸŒ€ [{nick}] ë‡Œì ˆ ë™ë ¥ ê°€ë™ ì¤‘... (+{reward}â‚© ì…ê¸ˆ)"
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"{pattern}\në¬´í•œ ë£¨í”„ íšŸìˆ˜: {m_count}íšŒì°¨", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3)

def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [4. ë¼ìš°íŒ… ë° ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸš€ {data['nickname']}ë‹˜ì´ ë©€í‹°ë²„ìŠ¤ ì„œë²„ì— ì ‘ì†í–ˆìŠµë‹ˆë‹¤!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ìˆ˜ìµ ê³µì‹]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ [ëŒ€ìš©ëŸ‰ ë°ì´í„° ë³€í™˜]\nê¸¸ì´: {msg_len}ì\në³´ìƒ: {reward}â‚© ì ë¦½ ì™„ë£Œ\nğŸ”— íŒŒì¼ ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ ì²˜ë¦¬]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        total = user['money'] + user['bank_money']
        res = f"ğŸ’° {nick}ë‹˜ì˜ ìì‚° ë³´ê³ ì„œ\n" \
              f"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" \
              f"ğŸ’µ í˜„ê¸ˆ: {user['money']:,}â‚©\n" \
              f"ğŸ¦ ì€í–‰: {user['bank_money']:,}â‚©\n" \
              f"ğŸ’³ ì´í•©: {total:,}â‚©\n" \
              f"ğŸ† ë“±ê¸‰: {'ì´ˆì›”ì' if total >= 10000000 else 'VIP' if total >= 1000000 else 'í‰ë¯¼'}"
        emit('message', {'msg': res, 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt:,}â‚©ì„ ì€í–‰ì— ì•ˆì „í•˜ê²Œ ë³´ê´€í–ˆìŠµë‹ˆë‹¤. (ë¶„ë‹¹ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ ì€í–‰ì—ì„œ {amt:,}â‚©ì„ ì¶œê¸ˆí–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ì´ ê°€ë™ë˜ì—ˆìŠµë‹ˆë‹¤! (3ì´ˆë‹¹ 5000â‚©)", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆ ì—”ì§„ì„ ì •ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            prompt = " ".join(cmd_parts[1:])
            res = client.models.generate_content(model="gemini-2.0-flash", contents=prompt)
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except Exception as e:
            emit('message', {'msg': f"âŒ ì—ëŸ¬: {str(e)}", 'type': 'system'})

    elif cmd == "!ëª…ë ¹ì–´":
        help_msg = "ğŸ“œ [ëª…ë ¹ì–´ ë¦¬ìŠ¤íŠ¸]\n!ì”ì•¡ - ë‚´ ìì‚° í™•ì¸\n!ì €ê¸ˆ [ì•¡ìˆ˜] - ì€í–‰ì— ì…ê¸ˆ\n!ì¶œê¸ˆ [ì•¡ìˆ˜] - í˜„ê¸ˆí™”\n!ë‡Œì ˆ - ë¬´í•œ ëˆ ë²Œê¸° ì‹œì‘\n!ë‡Œì ˆì¤‘ë‹¨ - ì¤‘ì§€\n!gemini [ì§ˆë¬¸] - AI ë‹µë³€\n!ëª…ë ¹ì–´ - ë„ì›€ë§"
        emit('message', {'msg': help_msg, 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ…
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=background_scheduler, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
import random
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í™˜ê²½] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "multiverse_empire.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {}

# Gemini AI í´ë¼ì´ì–¸íŠ¸ ì„¤ì •
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key:
        client = genai.Client(api_key=api_key)
except:
    print("Gemini SDKê°€ ì—†ê±°ë‚˜ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. !gemini ê¸°ëŠ¥ì€ ë¹„í™œì„±í™”ë©ë‹ˆë‹¤.")

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("""
            CREATE TABLE IF NOT EXISTS users (
                nickname TEXT PRIMARY KEY, 
                money INTEGER DEFAULT 1000, 
                bank_money INTEGER DEFAULT 0
            )
        """)
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ë° ë‰´ìŠ¤ ì‹œìŠ¤í…œ]
def background_scheduler():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤ ì‹¤í–‰
        with sqlite3.connect(DB_FILE) as conn:
            # 1. ì´ì ì§€ê¸‰ (1%)
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()
        
        # 2. ì‹¤ì‹œê°„ ê²½ì œ ë‰´ìŠ¤ ì´ë²¤íŠ¸
        news_list = [
            "ğŸ“¢ [ê²½ì œ] ì œêµ­ ì€í–‰ì˜ ê¸ˆë¦¬ê°€ ìƒìŠ¹ ì¡°ì§ì„ ë³´ì…ë‹ˆë‹¤!",
            "ğŸ“¢ [ì†Œì‹] ëŒ€ê·œëª¨ ë‡Œì ˆ ì—ë„ˆì§€ê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ì±„êµ´ íš¨ìœ¨ì´ ì¦ê°€í•©ë‹ˆë‹¤.",
            "ğŸ“¢ [ê³µì§€] í˜„ì¬ ìµœê³  ë¶€ìëŠ” 'ì´ˆì›”ì' ë“±ê¸‰ì„ ìœ ì§€í•˜ê³  ìˆìŠµë‹ˆë‹¤.",
            "ğŸ“¢ [ì´ë²¤íŠ¸] ì§€ê¸ˆ ì±„íŒ…ì„ ì…ë ¥í•˜ë©´ ë³´ë„ˆìŠ¤ í¬ì¸íŠ¸ê°€ ì§€ê¸‰ë  í™•ë¥ ì´ ë†’ìŠµë‹ˆë‹¤!"
        ]
        socketio.emit('message', {'msg': random.choice(news_list), 'type': 'system'}, room='main')

# --- [3. íŠ¹ìˆ˜ ê¸°ëŠ¥ ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 1
        reward = 5000
        update_money(nick, reward, bank=True)
        pattern = f"ğŸŒ€ [{nick}] ë‡Œì ˆ ë™ë ¥ ê°€ë™ ì¤‘... (+{reward}â‚© ì…ê¸ˆ)"
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"{pattern}\në¬´í•œ ë£¨í”„ íšŸìˆ˜: {m_count}íšŒì°¨", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3)

def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [4. ë¼ìš°íŒ… ë° ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸš€ {data['nickname']}ë‹˜ì´ ë©€í‹°ë²„ìŠ¤ ì„œë²„ì— ì ‘ì†í–ˆìŠµë‹ˆë‹¤!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ìˆ˜ìµ ê³µì‹]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ [ëŒ€ìš©ëŸ‰ ë°ì´í„° ë³€í™˜]\nê¸¸ì´: {msg_len}ì\në³´ìƒ: {reward}â‚© ì ë¦½ ì™„ë£Œ\nğŸ”— íŒŒì¼ ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ ì²˜ë¦¬]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        total = user['money'] + user['bank_money']
        res = f"ğŸ’° {nick}ë‹˜ì˜ ìì‚° ë³´ê³ ì„œ\n" \
              f"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" \
              f"ğŸ’µ í˜„ê¸ˆ: {user['money']:,}â‚©\n" \
              f"ğŸ¦ ì€í–‰: {user['bank_money']:,}â‚©\n" \
              f"ğŸ’³ ì´í•©: {total:,}â‚©\n" \
              f"ğŸ† ë“±ê¸‰: {'ì´ˆì›”ì' if total >= 10000000 else 'VIP' if total >= 1000000 else 'í‰ë¯¼'}"
        emit('message', {'msg': res, 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt:,}â‚©ì„ ì€í–‰ì— ì•ˆì „í•˜ê²Œ ë³´ê´€í–ˆìŠµë‹ˆë‹¤. (ë¶„ë‹¹ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ ì€í–‰ì—ì„œ {amt:,}â‚©ì„ ì¶œê¸ˆí–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ì´ ê°€ë™ë˜ì—ˆìŠµë‹ˆë‹¤! (3ì´ˆë‹¹ 5000â‚©)", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆ ì—”ì§„ì„ ì •ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            prompt = " ".join(cmd_parts[1:])
            res = client.models.generate_content(model="gemini-2.0-flash", contents=prompt)
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except Exception as e:
            emit('message', {'msg': f"âŒ ì—ëŸ¬: {str(e)}", 'type': 'system'})

    elif cmd == "!ëª…ë ¹ì–´":
        help_msg = "ğŸ“œ [ëª…ë ¹ì–´ ë¦¬ìŠ¤íŠ¸]\n!ì”ì•¡ - ë‚´ ìì‚° í™•ì¸\n!ì €ê¸ˆ [ì•¡ìˆ˜] - ì€í–‰ì— ì…ê¸ˆ\n!ì¶œê¸ˆ [ì•¡ìˆ˜] - í˜„ê¸ˆí™”\n!ë‡Œì ˆ - ë¬´í•œ ëˆ ë²Œê¸° ì‹œì‘\n!ë‡Œì ˆì¤‘ë‹¨ - ì¤‘ì§€\n!gemini [ì§ˆë¬¸] - AI ë‹µë³€\n!ëª…ë ¹ì–´ - ë„ì›€ë§"
        emit('message', {'msg': help_msg, 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ…
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=background_scheduler, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
import random
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í™˜ê²½] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "multiverse_empire.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {}

# Gemini AI í´ë¼ì´ì–¸íŠ¸ ì„¤ì •
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key:
        client = genai.Client(api_key=api_key)
except:
    print("Gemini SDKê°€ ì—†ê±°ë‚˜ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. !gemini ê¸°ëŠ¥ì€ ë¹„í™œì„±í™”ë©ë‹ˆë‹¤.")

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("""
            CREATE TABLE IF NOT EXISTS users (
                nickname TEXT PRIMARY KEY, 
                money INTEGER DEFAULT 1000, 
                bank_money INTEGER DEFAULT 0
            )
        """)
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ë° ë‰´ìŠ¤ ì‹œìŠ¤í…œ]
def background_scheduler():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤ ì‹¤í–‰
        with sqlite3.connect(DB_FILE) as conn:
            # 1. ì´ì ì§€ê¸‰ (1%)
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()
        
        # 2. ì‹¤ì‹œê°„ ê²½ì œ ë‰´ìŠ¤ ì´ë²¤íŠ¸
        news_list = [
            "ğŸ“¢ [ê²½ì œ] ì œêµ­ ì€í–‰ì˜ ê¸ˆë¦¬ê°€ ìƒìŠ¹ ì¡°ì§ì„ ë³´ì…ë‹ˆë‹¤!",
            "ğŸ“¢ [ì†Œì‹] ëŒ€ê·œëª¨ ë‡Œì ˆ ì—ë„ˆì§€ê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ì±„êµ´ íš¨ìœ¨ì´ ì¦ê°€í•©ë‹ˆë‹¤.",
            "ğŸ“¢ [ê³µì§€] í˜„ì¬ ìµœê³  ë¶€ìëŠ” 'ì´ˆì›”ì' ë“±ê¸‰ì„ ìœ ì§€í•˜ê³  ìˆìŠµë‹ˆë‹¤.",
            "ğŸ“¢ [ì´ë²¤íŠ¸] ì§€ê¸ˆ ì±„íŒ…ì„ ì…ë ¥í•˜ë©´ ë³´ë„ˆìŠ¤ í¬ì¸íŠ¸ê°€ ì§€ê¸‰ë  í™•ë¥ ì´ ë†’ìŠµë‹ˆë‹¤!"
        ]
        socketio.emit('message', {'msg': random.choice(news_list), 'type': 'system'}, room='main')

# --- [3. íŠ¹ìˆ˜ ê¸°ëŠ¥ ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 1
        reward = 5000
        update_money(nick, reward, bank=True)
        pattern = f"ğŸŒ€ [{nick}] ë‡Œì ˆ ë™ë ¥ ê°€ë™ ì¤‘... (+{reward}â‚© ì…ê¸ˆ)"
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"{pattern}\në¬´í•œ ë£¨í”„ íšŸìˆ˜: {m_count}íšŒì°¨", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3)

def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [4. ë¼ìš°íŒ… ë° ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸš€ {data['nickname']}ë‹˜ì´ ë©€í‹°ë²„ìŠ¤ ì„œë²„ì— ì ‘ì†í–ˆìŠµë‹ˆë‹¤!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ìˆ˜ìµ ê³µì‹]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ [ëŒ€ìš©ëŸ‰ ë°ì´í„° ë³€í™˜]\nê¸¸ì´: {msg_len}ì\në³´ìƒ: {reward}â‚© ì ë¦½ ì™„ë£Œ\nğŸ”— íŒŒì¼ ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ ì²˜ë¦¬]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        total = user['money'] + user['bank_money']
        res = f"ğŸ’° {nick}ë‹˜ì˜ ìì‚° ë³´ê³ ì„œ\n" \
              f"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" \
              f"ğŸ’µ í˜„ê¸ˆ: {user['money']:,}â‚©\n" \
              f"ğŸ¦ ì€í–‰: {user['bank_money']:,}â‚©\n" \
              f"ğŸ’³ ì´í•©: {total:,}â‚©\n" \
              f"ğŸ† ë“±ê¸‰: {'ì´ˆì›”ì' if total >= 10000000 else 'VIP' if total >= 1000000 else 'í‰ë¯¼'}"
        emit('message', {'msg': res, 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt:,}â‚©ì„ ì€í–‰ì— ì•ˆì „í•˜ê²Œ ë³´ê´€í–ˆìŠµë‹ˆë‹¤. (ë¶„ë‹¹ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ ì€í–‰ì—ì„œ {amt:,}â‚©ì„ ì¶œê¸ˆí–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ì´ ê°€ë™ë˜ì—ˆìŠµë‹ˆë‹¤! (3ì´ˆë‹¹ 5000â‚©)", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆ ì—”ì§„ì„ ì •ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            prompt = " ".join(cmd_parts[1:])
            res = client.models.generate_content(model="gemini-2.0-flash", contents=prompt)
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except Exception as e:
            emit('message', {'msg': f"âŒ ì—ëŸ¬: {str(e)}", 'type': 'system'})

    elif cmd == "!ëª…ë ¹ì–´":
        help_msg = "ğŸ“œ [ëª…ë ¹ì–´ ë¦¬ìŠ¤íŠ¸]\n!ì”ì•¡ - ë‚´ ìì‚° í™•ì¸\n!ì €ê¸ˆ [ì•¡ìˆ˜] - ì€í–‰ì— ì…ê¸ˆ\n!ì¶œê¸ˆ [ì•¡ìˆ˜] - í˜„ê¸ˆí™”\n!ë‡Œì ˆ - ë¬´í•œ ëˆ ë²Œê¸° ì‹œì‘\n!ë‡Œì ˆì¤‘ë‹¨ - ì¤‘ì§€\n!gemini [ì§ˆë¬¸] - AI ë‹µë³€\n!ëª…ë ¹ì–´ - ë„ì›€ë§"
        emit('message', {'msg': help_msg, 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ…
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=background_scheduler, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
import random
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í™˜ê²½] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "multiverse_empire.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {}

# Gemini AI í´ë¼ì´ì–¸íŠ¸ ì„¤ì •
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key:
        client = genai.Client(api_key=api_key)
except:
    print("Gemini SDKê°€ ì—†ê±°ë‚˜ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. !gemini ê¸°ëŠ¥ì€ ë¹„í™œì„±í™”ë©ë‹ˆë‹¤.")

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("""
            CREATE TABLE IF NOT EXISTS users (
                nickname TEXT PRIMARY KEY, 
                money INTEGER DEFAULT 1000, 
                bank_money INTEGER DEFAULT 0
            )
        """)
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ë° ë‰´ìŠ¤ ì‹œìŠ¤í…œ]
def background_scheduler():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤ ì‹¤í–‰
        with sqlite3.connect(DB_FILE) as conn:
            # 1. ì´ì ì§€ê¸‰ (1%)
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()
        
        # 2. ì‹¤ì‹œê°„ ê²½ì œ ë‰´ìŠ¤ ì´ë²¤íŠ¸
        news_list = [
            "ğŸ“¢ [ê²½ì œ] ì œêµ­ ì€í–‰ì˜ ê¸ˆë¦¬ê°€ ìƒìŠ¹ ì¡°ì§ì„ ë³´ì…ë‹ˆë‹¤!",
            "ğŸ“¢ [ì†Œì‹] ëŒ€ê·œëª¨ ë‡Œì ˆ ì—ë„ˆì§€ê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ì±„êµ´ íš¨ìœ¨ì´ ì¦ê°€í•©ë‹ˆë‹¤.",
            "ğŸ“¢ [ê³µì§€] í˜„ì¬ ìµœê³  ë¶€ìëŠ” 'ì´ˆì›”ì' ë“±ê¸‰ì„ ìœ ì§€í•˜ê³  ìˆìŠµë‹ˆë‹¤.",
            "ğŸ“¢ [ì´ë²¤íŠ¸] ì§€ê¸ˆ ì±„íŒ…ì„ ì…ë ¥í•˜ë©´ ë³´ë„ˆìŠ¤ í¬ì¸íŠ¸ê°€ ì§€ê¸‰ë  í™•ë¥ ì´ ë†’ìŠµë‹ˆë‹¤!"
        ]
        socketio.emit('message', {'msg': random.choice(news_list), 'type': 'system'}, room='main')

# --- [3. íŠ¹ìˆ˜ ê¸°ëŠ¥ ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 1
        reward = 5000
        update_money(nick, reward, bank=True)
        pattern = f"ğŸŒ€ [{nick}] ë‡Œì ˆ ë™ë ¥ ê°€ë™ ì¤‘... (+{reward}â‚© ì…ê¸ˆ)"
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"{pattern}\në¬´í•œ ë£¨í”„ íšŸìˆ˜: {m_count}íšŒì°¨", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3)

def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [4. ë¼ìš°íŒ… ë° ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸš€ {data['nickname']}ë‹˜ì´ ë©€í‹°ë²„ìŠ¤ ì„œë²„ì— ì ‘ì†í–ˆìŠµë‹ˆë‹¤!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ìˆ˜ìµ ê³µì‹]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ [ëŒ€ìš©ëŸ‰ ë°ì´í„° ë³€í™˜]\nê¸¸ì´: {msg_len}ì\në³´ìƒ: {reward}â‚© ì ë¦½ ì™„ë£Œ\nğŸ”— íŒŒì¼ ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ ì²˜ë¦¬]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        total = user['money'] + user['bank_money']
        res = f"ğŸ’° {nick}ë‹˜ì˜ ìì‚° ë³´ê³ ì„œ\n" \
              f"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" \
              f"ğŸ’µ í˜„ê¸ˆ: {user['money']:,}â‚©\n" \
              f"ğŸ¦ ì€í–‰: {user['bank_money']:,}â‚©\n" \
              f"ğŸ’³ ì´í•©: {total:,}â‚©\n" \
              f"ğŸ† ë“±ê¸‰: {'ì´ˆì›”ì' if total >= 10000000 else 'VIP' if total >= 1000000 else 'í‰ë¯¼'}"
        emit('message', {'msg': res, 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt:,}â‚©ì„ ì€í–‰ì— ì•ˆì „í•˜ê²Œ ë³´ê´€í–ˆìŠµë‹ˆë‹¤. (ë¶„ë‹¹ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ ì€í–‰ì—ì„œ {amt:,}â‚©ì„ ì¶œê¸ˆí–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ì´ ê°€ë™ë˜ì—ˆìŠµë‹ˆë‹¤! (3ì´ˆë‹¹ 5000â‚©)", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆ ì—”ì§„ì„ ì •ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            prompt = " ".join(cmd_parts[1:])
            res = client.models.generate_content(model="gemini-2.0-flash", contents=prompt)
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except Exception as e:
            emit('message', {'msg': f"âŒ ì—ëŸ¬: {str(e)}", 'type': 'system'})

    elif cmd == "!ëª…ë ¹ì–´":
        help_msg = "ğŸ“œ [ëª…ë ¹ì–´ ë¦¬ìŠ¤íŠ¸]\n!ì”ì•¡ - ë‚´ ìì‚° í™•ì¸\n!ì €ê¸ˆ [ì•¡ìˆ˜] - ì€í–‰ì— ì…ê¸ˆ\n!ì¶œê¸ˆ [ì•¡ìˆ˜] - í˜„ê¸ˆí™”\n!ë‡Œì ˆ - ë¬´í•œ ëˆ ë²Œê¸° ì‹œì‘\n!ë‡Œì ˆì¤‘ë‹¨ - ì¤‘ì§€\n!gemini [ì§ˆë¬¸] - AI ë‹µë³€\n!ëª…ë ¹ì–´ - ë„ì›€ë§"
        emit('message', {'msg': help_msg, 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ…
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=background_scheduler, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
import random
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í™˜ê²½] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "multiverse_empire.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {}

# Gemini AI í´ë¼ì´ì–¸íŠ¸ ì„¤ì •
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key:
        client = genai.Client(api_key=api_key)
except:
    print("Gemini SDKê°€ ì—†ê±°ë‚˜ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. !gemini ê¸°ëŠ¥ì€ ë¹„í™œì„±í™”ë©ë‹ˆë‹¤.")

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("""
            CREATE TABLE IF NOT EXISTS users (
                nickname TEXT PRIMARY KEY, 
                money INTEGER DEFAULT 1000, 
                bank_money INTEGER DEFAULT 0
            )
        """)
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ë° ë‰´ìŠ¤ ì‹œìŠ¤í…œ]
def background_scheduler():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤ ì‹¤í–‰
        with sqlite3.connect(DB_FILE) as conn:
            # 1. ì´ì ì§€ê¸‰ (1%)
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()
        
        # 2. ì‹¤ì‹œê°„ ê²½ì œ ë‰´ìŠ¤ ì´ë²¤íŠ¸
        news_list = [
            "ğŸ“¢ [ê²½ì œ] ì œêµ­ ì€í–‰ì˜ ê¸ˆë¦¬ê°€ ìƒìŠ¹ ì¡°ì§ì„ ë³´ì…ë‹ˆë‹¤!",
            "ğŸ“¢ [ì†Œì‹] ëŒ€ê·œëª¨ ë‡Œì ˆ ì—ë„ˆì§€ê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ì±„êµ´ íš¨ìœ¨ì´ ì¦ê°€í•©ë‹ˆë‹¤.",
            "ğŸ“¢ [ê³µì§€] í˜„ì¬ ìµœê³  ë¶€ìëŠ” 'ì´ˆì›”ì' ë“±ê¸‰ì„ ìœ ì§€í•˜ê³  ìˆìŠµë‹ˆë‹¤.",
            "ğŸ“¢ [ì´ë²¤íŠ¸] ì§€ê¸ˆ ì±„íŒ…ì„ ì…ë ¥í•˜ë©´ ë³´ë„ˆìŠ¤ í¬ì¸íŠ¸ê°€ ì§€ê¸‰ë  í™•ë¥ ì´ ë†’ìŠµë‹ˆë‹¤!"
        ]
        socketio.emit('message', {'msg': random.choice(news_list), 'type': 'system'}, room='main')

# --- [3. íŠ¹ìˆ˜ ê¸°ëŠ¥ ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 1
        reward = 5000
        update_money(nick, reward, bank=True)
        pattern = f"ğŸŒ€ [{nick}] ë‡Œì ˆ ë™ë ¥ ê°€ë™ ì¤‘... (+{reward}â‚© ì…ê¸ˆ)"
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"{pattern}\në¬´í•œ ë£¨í”„ íšŸìˆ˜: {m_count}íšŒì°¨", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3)

def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [4. ë¼ìš°íŒ… ë° ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸš€ {data['nickname']}ë‹˜ì´ ë©€í‹°ë²„ìŠ¤ ì„œë²„ì— ì ‘ì†í–ˆìŠµë‹ˆë‹¤!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ìˆ˜ìµ ê³µì‹]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ [ëŒ€ìš©ëŸ‰ ë°ì´í„° ë³€í™˜]\nê¸¸ì´: {msg_len}ì\në³´ìƒ: {reward}â‚© ì ë¦½ ì™„ë£Œ\nğŸ”— íŒŒì¼ ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ ì²˜ë¦¬]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        total = user['money'] + user['bank_money']
        res = f"ğŸ’° {nick}ë‹˜ì˜ ìì‚° ë³´ê³ ì„œ\n" \
              f"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" \
              f"ğŸ’µ í˜„ê¸ˆ: {user['money']:,}â‚©\n" \
              f"ğŸ¦ ì€í–‰: {user['bank_money']:,}â‚©\n" \
              f"ğŸ’³ ì´í•©: {total:,}â‚©\n" \
              f"ğŸ† ë“±ê¸‰: {'ì´ˆì›”ì' if total >= 10000000 else 'VIP' if total >= 1000000 else 'í‰ë¯¼'}"
        emit('message', {'msg': res, 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt:,}â‚©ì„ ì€í–‰ì— ì•ˆì „í•˜ê²Œ ë³´ê´€í–ˆìŠµë‹ˆë‹¤. (ë¶„ë‹¹ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ ì€í–‰ì—ì„œ {amt:,}â‚©ì„ ì¶œê¸ˆí–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ì´ ê°€ë™ë˜ì—ˆìŠµë‹ˆë‹¤! (3ì´ˆë‹¹ 5000â‚©)", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆ ì—”ì§„ì„ ì •ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            prompt = " ".join(cmd_parts[1:])
            res = client.models.generate_content(model="gemini-2.0-flash", contents=prompt)
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except Exception as e:
            emit('message', {'msg': f"âŒ ì—ëŸ¬: {str(e)}", 'type': 'system'})

    elif cmd == "!ëª…ë ¹ì–´":
        help_msg = "ğŸ“œ [ëª…ë ¹ì–´ ë¦¬ìŠ¤íŠ¸]\n!ì”ì•¡ - ë‚´ ìì‚° í™•ì¸\n!ì €ê¸ˆ [ì•¡ìˆ˜] - ì€í–‰ì— ì…ê¸ˆ\n!ì¶œê¸ˆ [ì•¡ìˆ˜] - í˜„ê¸ˆí™”\n!ë‡Œì ˆ - ë¬´í•œ ëˆ ë²Œê¸° ì‹œì‘\n!ë‡Œì ˆì¤‘ë‹¨ - ì¤‘ì§€\n!gemini [ì§ˆë¬¸] - AI ë‹µë³€\n!ëª…ë ¹ì–´ - ë„ì›€ë§"
        emit('message', {'msg': help_msg, 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ…
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=background_scheduler, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
import random
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í™˜ê²½] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "multiverse_empire.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {}

# Gemini AI í´ë¼ì´ì–¸íŠ¸ ì„¤ì •
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key:
        client = genai.Client(api_key=api_key)
except:
    print("Gemini SDKê°€ ì—†ê±°ë‚˜ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. !gemini ê¸°ëŠ¥ì€ ë¹„í™œì„±í™”ë©ë‹ˆë‹¤.")

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("""
            CREATE TABLE IF NOT EXISTS users (
                nickname TEXT PRIMARY KEY, 
                money INTEGER DEFAULT 1000, 
                bank_money INTEGER DEFAULT 0
            )
        """)
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ë° ë‰´ìŠ¤ ì‹œìŠ¤í…œ]
def background_scheduler():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤ ì‹¤í–‰
        with sqlite3.connect(DB_FILE) as conn:
            # 1. ì´ì ì§€ê¸‰ (1%)
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()
        
        # 2. ì‹¤ì‹œê°„ ê²½ì œ ë‰´ìŠ¤ ì´ë²¤íŠ¸
        news_list = [
            "ğŸ“¢ [ê²½ì œ] ì œêµ­ ì€í–‰ì˜ ê¸ˆë¦¬ê°€ ìƒìŠ¹ ì¡°ì§ì„ ë³´ì…ë‹ˆë‹¤!",
            "ğŸ“¢ [ì†Œì‹] ëŒ€ê·œëª¨ ë‡Œì ˆ ì—ë„ˆì§€ê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ì±„êµ´ íš¨ìœ¨ì´ ì¦ê°€í•©ë‹ˆë‹¤.",
            "ğŸ“¢ [ê³µì§€] í˜„ì¬ ìµœê³  ë¶€ìëŠ” 'ì´ˆì›”ì' ë“±ê¸‰ì„ ìœ ì§€í•˜ê³  ìˆìŠµë‹ˆë‹¤.",
            "ğŸ“¢ [ì´ë²¤íŠ¸] ì§€ê¸ˆ ì±„íŒ…ì„ ì…ë ¥í•˜ë©´ ë³´ë„ˆìŠ¤ í¬ì¸íŠ¸ê°€ ì§€ê¸‰ë  í™•ë¥ ì´ ë†’ìŠµë‹ˆë‹¤!"
        ]
        socketio.emit('message', {'msg': random.choice(news_list), 'type': 'system'}, room='main')

# --- [3. íŠ¹ìˆ˜ ê¸°ëŠ¥ ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 1
        reward = 5000
        update_money(nick, reward, bank=True)
        pattern = f"ğŸŒ€ [{nick}] ë‡Œì ˆ ë™ë ¥ ê°€ë™ ì¤‘... (+{reward}â‚© ì…ê¸ˆ)"
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"{pattern}\në¬´í•œ ë£¨í”„ íšŸìˆ˜: {m_count}íšŒì°¨", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3)

def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [4. ë¼ìš°íŒ… ë° ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸš€ {data['nickname']}ë‹˜ì´ ë©€í‹°ë²„ìŠ¤ ì„œë²„ì— ì ‘ì†í–ˆìŠµë‹ˆë‹¤!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ìˆ˜ìµ ê³µì‹]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ [ëŒ€ìš©ëŸ‰ ë°ì´í„° ë³€í™˜]\nê¸¸ì´: {msg_len}ì\në³´ìƒ: {reward}â‚© ì ë¦½ ì™„ë£Œ\nğŸ”— íŒŒì¼ ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ ì²˜ë¦¬]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        total = user['money'] + user['bank_money']
        res = f"ğŸ’° {nick}ë‹˜ì˜ ìì‚° ë³´ê³ ì„œ\n" \
              f"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" \
              f"ğŸ’µ í˜„ê¸ˆ: {user['money']:,}â‚©\n" \
              f"ğŸ¦ ì€í–‰: {user['bank_money']:,}â‚©\n" \
              f"ğŸ’³ ì´í•©: {total:,}â‚©\n" \
              f"ğŸ† ë“±ê¸‰: {'ì´ˆì›”ì' if total >= 10000000 else 'VIP' if total >= 1000000 else 'í‰ë¯¼'}"
        emit('message', {'msg': res, 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt:,}â‚©ì„ ì€í–‰ì— ì•ˆì „í•˜ê²Œ ë³´ê´€í–ˆìŠµë‹ˆë‹¤. (ë¶„ë‹¹ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ ì€í–‰ì—ì„œ {amt:,}â‚©ì„ ì¶œê¸ˆí–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ì´ ê°€ë™ë˜ì—ˆìŠµë‹ˆë‹¤! (3ì´ˆë‹¹ 5000â‚©)", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆ ì—”ì§„ì„ ì •ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            prompt = " ".join(cmd_parts[1:])
            res = client.models.generate_content(model="gemini-2.0-flash", contents=prompt)
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except Exception as e:
            emit('message', {'msg': f"âŒ ì—ëŸ¬: {str(e)}", 'type': 'system'})

    elif cmd == "!ëª…ë ¹ì–´":
        help_msg = "ğŸ“œ [ëª…ë ¹ì–´ ë¦¬ìŠ¤íŠ¸]\n!ì”ì•¡ - ë‚´ ìì‚° í™•ì¸\n!ì €ê¸ˆ [ì•¡ìˆ˜] - ì€í–‰ì— ì…ê¸ˆ\n!ì¶œê¸ˆ [ì•¡ìˆ˜] - í˜„ê¸ˆí™”\n!ë‡Œì ˆ - ë¬´í•œ ëˆ ë²Œê¸° ì‹œì‘\n!ë‡Œì ˆì¤‘ë‹¨ - ì¤‘ì§€\n!gemini [ì§ˆë¬¸] - AI ë‹µë³€\n!ëª…ë ¹ì–´ - ë„ì›€ë§"
        emit('message', {'msg': help_msg, 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ…
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=background_scheduler, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
import random
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í™˜ê²½] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "multiverse_empire.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {}

# Gemini AI í´ë¼ì´ì–¸íŠ¸ ì„¤ì •
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key:
        client = genai.Client(api_key=api_key)
except:
    print("Gemini SDKê°€ ì—†ê±°ë‚˜ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. !gemini ê¸°ëŠ¥ì€ ë¹„í™œì„±í™”ë©ë‹ˆë‹¤.")

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("""
            CREATE TABLE IF NOT EXISTS users (
                nickname TEXT PRIMARY KEY, 
                money INTEGER DEFAULT 1000, 
                bank_money INTEGER DEFAULT 0
            )
        """)
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ë° ë‰´ìŠ¤ ì‹œìŠ¤í…œ]
def background_scheduler():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤ ì‹¤í–‰
        with sqlite3.connect(DB_FILE) as conn:
            # 1. ì´ì ì§€ê¸‰ (1%)
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()
        
        # 2. ì‹¤ì‹œê°„ ê²½ì œ ë‰´ìŠ¤ ì´ë²¤íŠ¸
        news_list = [
            "ğŸ“¢ [ê²½ì œ] ì œêµ­ ì€í–‰ì˜ ê¸ˆë¦¬ê°€ ìƒìŠ¹ ì¡°ì§ì„ ë³´ì…ë‹ˆë‹¤!",
            "ğŸ“¢ [ì†Œì‹] ëŒ€ê·œëª¨ ë‡Œì ˆ ì—ë„ˆì§€ê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ì±„êµ´ íš¨ìœ¨ì´ ì¦ê°€í•©ë‹ˆë‹¤.",
            "ğŸ“¢ [ê³µì§€] í˜„ì¬ ìµœê³  ë¶€ìëŠ” 'ì´ˆì›”ì' ë“±ê¸‰ì„ ìœ ì§€í•˜ê³  ìˆìŠµë‹ˆë‹¤.",
            "ğŸ“¢ [ì´ë²¤íŠ¸] ì§€ê¸ˆ ì±„íŒ…ì„ ì…ë ¥í•˜ë©´ ë³´ë„ˆìŠ¤ í¬ì¸íŠ¸ê°€ ì§€ê¸‰ë  í™•ë¥ ì´ ë†’ìŠµë‹ˆë‹¤!"
        ]
        socketio.emit('message', {'msg': random.choice(news_list), 'type': 'system'}, room='main')

# --- [3. íŠ¹ìˆ˜ ê¸°ëŠ¥ ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 1
        reward = 5000
        update_money(nick, reward, bank=True)
        pattern = f"ğŸŒ€ [{nick}] ë‡Œì ˆ ë™ë ¥ ê°€ë™ ì¤‘... (+{reward}â‚© ì…ê¸ˆ)"
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"{pattern}\në¬´í•œ ë£¨í”„ íšŸìˆ˜: {m_count}íšŒì°¨", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3)

def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [4. ë¼ìš°íŒ… ë° ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸš€ {data['nickname']}ë‹˜ì´ ë©€í‹°ë²„ìŠ¤ ì„œë²„ì— ì ‘ì†í–ˆìŠµë‹ˆë‹¤!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ìˆ˜ìµ ê³µì‹]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ [ëŒ€ìš©ëŸ‰ ë°ì´í„° ë³€í™˜]\nê¸¸ì´: {msg_len}ì\në³´ìƒ: {reward}â‚© ì ë¦½ ì™„ë£Œ\nğŸ”— íŒŒì¼ ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ ì²˜ë¦¬]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        total = user['money'] + user['bank_money']
        res = f"ğŸ’° {nick}ë‹˜ì˜ ìì‚° ë³´ê³ ì„œ\n" \
              f"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" \
              f"ğŸ’µ í˜„ê¸ˆ: {user['money']:,}â‚©\n" \
              f"ğŸ¦ ì€í–‰: {user['bank_money']:,}â‚©\n" \
              f"ğŸ’³ ì´í•©: {total:,}â‚©\n" \
              f"ğŸ† ë“±ê¸‰: {'ì´ˆì›”ì' if total >= 10000000 else 'VIP' if total >= 1000000 else 'í‰ë¯¼'}"
        emit('message', {'msg': res, 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt:,}â‚©ì„ ì€í–‰ì— ì•ˆì „í•˜ê²Œ ë³´ê´€í–ˆìŠµë‹ˆë‹¤. (ë¶„ë‹¹ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ ì€í–‰ì—ì„œ {amt:,}â‚©ì„ ì¶œê¸ˆí–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ì´ ê°€ë™ë˜ì—ˆìŠµë‹ˆë‹¤! (3ì´ˆë‹¹ 5000â‚©)", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆ ì—”ì§„ì„ ì •ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            prompt = " ".join(cmd_parts[1:])
            res = client.models.generate_content(model="gemini-2.0-flash", contents=prompt)
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except Exception as e:
            emit('message', {'msg': f"âŒ ì—ëŸ¬: {str(e)}", 'type': 'system'})

    elif cmd == "!ëª…ë ¹ì–´":
        help_msg = "ğŸ“œ [ëª…ë ¹ì–´ ë¦¬ìŠ¤íŠ¸]\n!ì”ì•¡ - ë‚´ ìì‚° í™•ì¸\n!ì €ê¸ˆ [ì•¡ìˆ˜] - ì€í–‰ì— ì…ê¸ˆ\n!ì¶œê¸ˆ [ì•¡ìˆ˜] - í˜„ê¸ˆí™”\n!ë‡Œì ˆ - ë¬´í•œ ëˆ ë²Œê¸° ì‹œì‘\n!ë‡Œì ˆì¤‘ë‹¨ - ì¤‘ì§€\n!gemini [ì§ˆë¬¸] - AI ë‹µë³€\n!ëª…ë ¹ì–´ - ë„ì›€ë§"
        emit('message', {'msg': help_msg, 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ…
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=background_scheduler, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
import random
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í™˜ê²½] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "multiverse_empire.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {}

# Gemini AI í´ë¼ì´ì–¸íŠ¸ ì„¤ì •
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key:
        client = genai.Client(api_key=api_key)
except:
    print("Gemini SDKê°€ ì—†ê±°ë‚˜ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. !gemini ê¸°ëŠ¥ì€ ë¹„í™œì„±í™”ë©ë‹ˆë‹¤.")

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("""
            CREATE TABLE IF NOT EXISTS users (
                nickname TEXT PRIMARY KEY, 
                money INTEGER DEFAULT 1000, 
                bank_money INTEGER DEFAULT 0
            )
        """)
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ë° ë‰´ìŠ¤ ì‹œìŠ¤í…œ]
def background_scheduler():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤ ì‹¤í–‰
        with sqlite3.connect(DB_FILE) as conn:
            # 1. ì´ì ì§€ê¸‰ (1%)
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()
        
        # 2. ì‹¤ì‹œê°„ ê²½ì œ ë‰´ìŠ¤ ì´ë²¤íŠ¸
        news_list = [
            "ğŸ“¢ [ê²½ì œ] ì œêµ­ ì€í–‰ì˜ ê¸ˆë¦¬ê°€ ìƒìŠ¹ ì¡°ì§ì„ ë³´ì…ë‹ˆë‹¤!",
            "ğŸ“¢ [ì†Œì‹] ëŒ€ê·œëª¨ ë‡Œì ˆ ì—ë„ˆì§€ê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ì±„êµ´ íš¨ìœ¨ì´ ì¦ê°€í•©ë‹ˆë‹¤.",
            "ğŸ“¢ [ê³µì§€] í˜„ì¬ ìµœê³  ë¶€ìëŠ” 'ì´ˆì›”ì' ë“±ê¸‰ì„ ìœ ì§€í•˜ê³  ìˆìŠµë‹ˆë‹¤.",
            "ğŸ“¢ [ì´ë²¤íŠ¸] ì§€ê¸ˆ ì±„íŒ…ì„ ì…ë ¥í•˜ë©´ ë³´ë„ˆìŠ¤ í¬ì¸íŠ¸ê°€ ì§€ê¸‰ë  í™•ë¥ ì´ ë†’ìŠµë‹ˆë‹¤!"
        ]
        socketio.emit('message', {'msg': random.choice(news_list), 'type': 'system'}, room='main')

# --- [3. íŠ¹ìˆ˜ ê¸°ëŠ¥ ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 1
        reward = 5000
        update_money(nick, reward, bank=True)
        pattern = f"ğŸŒ€ [{nick}] ë‡Œì ˆ ë™ë ¥ ê°€ë™ ì¤‘... (+{reward}â‚© ì…ê¸ˆ)"
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"{pattern}\në¬´í•œ ë£¨í”„ íšŸìˆ˜: {m_count}íšŒì°¨", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3)

def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [4. ë¼ìš°íŒ… ë° ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸš€ {data['nickname']}ë‹˜ì´ ë©€í‹°ë²„ìŠ¤ ì„œë²„ì— ì ‘ì†í–ˆìŠµë‹ˆë‹¤!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ìˆ˜ìµ ê³µì‹]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ [ëŒ€ìš©ëŸ‰ ë°ì´í„° ë³€í™˜]\nê¸¸ì´: {msg_len}ì\në³´ìƒ: {reward}â‚© ì ë¦½ ì™„ë£Œ\nğŸ”— íŒŒì¼ ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ ì²˜ë¦¬]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        total = user['money'] + user['bank_money']
        res = f"ğŸ’° {nick}ë‹˜ì˜ ìì‚° ë³´ê³ ì„œ\n" \
              f"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" \
              f"ğŸ’µ í˜„ê¸ˆ: {user['money']:,}â‚©\n" \
              f"ğŸ¦ ì€í–‰: {user['bank_money']:,}â‚©\n" \
              f"ğŸ’³ ì´í•©: {total:,}â‚©\n" \
              f"ğŸ† ë“±ê¸‰: {'ì´ˆì›”ì' if total >= 10000000 else 'VIP' if total >= 1000000 else 'í‰ë¯¼'}"
        emit('message', {'msg': res, 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt:,}â‚©ì„ ì€í–‰ì— ì•ˆì „í•˜ê²Œ ë³´ê´€í–ˆìŠµë‹ˆë‹¤. (ë¶„ë‹¹ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ ì€í–‰ì—ì„œ {amt:,}â‚©ì„ ì¶œê¸ˆí–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ì´ ê°€ë™ë˜ì—ˆìŠµë‹ˆë‹¤! (3ì´ˆë‹¹ 5000â‚©)", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆ ì—”ì§„ì„ ì •ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            prompt = " ".join(cmd_parts[1:])
            res = client.models.generate_content(model="gemini-2.0-flash", contents=prompt)
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except Exception as e:
            emit('message', {'msg': f"âŒ ì—ëŸ¬: {str(e)}", 'type': 'system'})

    elif cmd == "!ëª…ë ¹ì–´":
        help_msg = "ğŸ“œ [ëª…ë ¹ì–´ ë¦¬ìŠ¤íŠ¸]\n!ì”ì•¡ - ë‚´ ìì‚° í™•ì¸\n!ì €ê¸ˆ [ì•¡ìˆ˜] - ì€í–‰ì— ì…ê¸ˆ\n!ì¶œê¸ˆ [ì•¡ìˆ˜] - í˜„ê¸ˆí™”\n!ë‡Œì ˆ - ë¬´í•œ ëˆ ë²Œê¸° ì‹œì‘\n!ë‡Œì ˆì¤‘ë‹¨ - ì¤‘ì§€\n!gemini [ì§ˆë¬¸] - AI ë‹µë³€\n!ëª…ë ¹ì–´ - ë„ì›€ë§"
        emit('message', {'msg': help_msg, 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ…
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=background_scheduler, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
import random
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í™˜ê²½] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "multiverse_empire.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {}

# Gemini AI í´ë¼ì´ì–¸íŠ¸ ì„¤ì •
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key:
        client = genai.Client(api_key=api_key)
except:
    print("Gemini SDKê°€ ì—†ê±°ë‚˜ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. !gemini ê¸°ëŠ¥ì€ ë¹„í™œì„±í™”ë©ë‹ˆë‹¤.")

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("""
            CREATE TABLE IF NOT EXISTS users (
                nickname TEXT PRIMARY KEY, 
                money INTEGER DEFAULT 1000, 
                bank_money INTEGER DEFAULT 0
            )
        """)
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ë° ë‰´ìŠ¤ ì‹œìŠ¤í…œ]
def background_scheduler():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤ ì‹¤í–‰
        with sqlite3.connect(DB_FILE) as conn:
            # 1. ì´ì ì§€ê¸‰ (1%)
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()
        
        # 2. ì‹¤ì‹œê°„ ê²½ì œ ë‰´ìŠ¤ ì´ë²¤íŠ¸
        news_list = [
            "ğŸ“¢ [ê²½ì œ] ì œêµ­ ì€í–‰ì˜ ê¸ˆë¦¬ê°€ ìƒìŠ¹ ì¡°ì§ì„ ë³´ì…ë‹ˆë‹¤!",
            "ğŸ“¢ [ì†Œì‹] ëŒ€ê·œëª¨ ë‡Œì ˆ ì—ë„ˆì§€ê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ì±„êµ´ íš¨ìœ¨ì´ ì¦ê°€í•©ë‹ˆë‹¤.",
            "ğŸ“¢ [ê³µì§€] í˜„ì¬ ìµœê³  ë¶€ìëŠ” 'ì´ˆì›”ì' ë“±ê¸‰ì„ ìœ ì§€í•˜ê³  ìˆìŠµë‹ˆë‹¤.",
            "ğŸ“¢ [ì´ë²¤íŠ¸] ì§€ê¸ˆ ì±„íŒ…ì„ ì…ë ¥í•˜ë©´ ë³´ë„ˆìŠ¤ í¬ì¸íŠ¸ê°€ ì§€ê¸‰ë  í™•ë¥ ì´ ë†’ìŠµë‹ˆë‹¤!"
        ]
        socketio.emit('message', {'msg': random.choice(news_list), 'type': 'system'}, room='main')

# --- [3. íŠ¹ìˆ˜ ê¸°ëŠ¥ ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 1
        reward = 5000
        update_money(nick, reward, bank=True)
        pattern = f"ğŸŒ€ [{nick}] ë‡Œì ˆ ë™ë ¥ ê°€ë™ ì¤‘... (+{reward}â‚© ì…ê¸ˆ)"
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"{pattern}\në¬´í•œ ë£¨í”„ íšŸìˆ˜: {m_count}íšŒì°¨", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3)

def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [4. ë¼ìš°íŒ… ë° ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸš€ {data['nickname']}ë‹˜ì´ ë©€í‹°ë²„ìŠ¤ ì„œë²„ì— ì ‘ì†í–ˆìŠµë‹ˆë‹¤!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ìˆ˜ìµ ê³µì‹]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ [ëŒ€ìš©ëŸ‰ ë°ì´í„° ë³€í™˜]\nê¸¸ì´: {msg_len}ì\në³´ìƒ: {reward}â‚© ì ë¦½ ì™„ë£Œ\nğŸ”— íŒŒì¼ ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ ì²˜ë¦¬]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        total = user['money'] + user['bank_money']
        res = f"ğŸ’° {nick}ë‹˜ì˜ ìì‚° ë³´ê³ ì„œ\n" \
              f"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" \
              f"ğŸ’µ í˜„ê¸ˆ: {user['money']:,}â‚©\n" \
              f"ğŸ¦ ì€í–‰: {user['bank_money']:,}â‚©\n" \
              f"ğŸ’³ ì´í•©: {total:,}â‚©\n" \
              f"ğŸ† ë“±ê¸‰: {'ì´ˆì›”ì' if total >= 10000000 else 'VIP' if total >= 1000000 else 'í‰ë¯¼'}"
        emit('message', {'msg': res, 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt:,}â‚©ì„ ì€í–‰ì— ì•ˆì „í•˜ê²Œ ë³´ê´€í–ˆìŠµë‹ˆë‹¤. (ë¶„ë‹¹ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ ì€í–‰ì—ì„œ {amt:,}â‚©ì„ ì¶œê¸ˆí–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ì´ ê°€ë™ë˜ì—ˆìŠµë‹ˆë‹¤! (3ì´ˆë‹¹ 5000â‚©)", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆ ì—”ì§„ì„ ì •ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            prompt = " ".join(cmd_parts[1:])
            res = client.models.generate_content(model="gemini-2.0-flash", contents=prompt)
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except Exception as e:
            emit('message', {'msg': f"âŒ ì—ëŸ¬: {str(e)}", 'type': 'system'})

    elif cmd == "!ëª…ë ¹ì–´":
        help_msg = "ğŸ“œ [ëª…ë ¹ì–´ ë¦¬ìŠ¤íŠ¸]\n!ì”ì•¡ - ë‚´ ìì‚° í™•ì¸\n!ì €ê¸ˆ [ì•¡ìˆ˜] - ì€í–‰ì— ì…ê¸ˆ\n!ì¶œê¸ˆ [ì•¡ìˆ˜] - í˜„ê¸ˆí™”\n!ë‡Œì ˆ - ë¬´í•œ ëˆ ë²Œê¸° ì‹œì‘\n!ë‡Œì ˆì¤‘ë‹¨ - ì¤‘ì§€\n!gemini [ì§ˆë¬¸] - AI ë‹µë³€\n!ëª…ë ¹ì–´ - ë„ì›€ë§"
        emit('message', {'msg': help_msg, 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ…
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=background_scheduler, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
import random
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í™˜ê²½] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "multiverse_empire.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {}

# Gemini AI í´ë¼ì´ì–¸íŠ¸ ì„¤ì •
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key:
        client = genai.Client(api_key=api_key)
except:
    print("Gemini SDKê°€ ì—†ê±°ë‚˜ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. !gemini ê¸°ëŠ¥ì€ ë¹„í™œì„±í™”ë©ë‹ˆë‹¤.")

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("""
            CREATE TABLE IF NOT EXISTS users (
                nickname TEXT PRIMARY KEY, 
                money INTEGER DEFAULT 1000, 
                bank_money INTEGER DEFAULT 0
            )
        """)
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ë° ë‰´ìŠ¤ ì‹œìŠ¤í…œ]
def background_scheduler():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤ ì‹¤í–‰
        with sqlite3.connect(DB_FILE) as conn:
            # 1. ì´ì ì§€ê¸‰ (1%)
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()
        
        # 2. ì‹¤ì‹œê°„ ê²½ì œ ë‰´ìŠ¤ ì´ë²¤íŠ¸
        news_list = [
            "ğŸ“¢ [ê²½ì œ] ì œêµ­ ì€í–‰ì˜ ê¸ˆë¦¬ê°€ ìƒìŠ¹ ì¡°ì§ì„ ë³´ì…ë‹ˆë‹¤!",
            "ğŸ“¢ [ì†Œì‹] ëŒ€ê·œëª¨ ë‡Œì ˆ ì—ë„ˆì§€ê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ì±„êµ´ íš¨ìœ¨ì´ ì¦ê°€í•©ë‹ˆë‹¤.",
            "ğŸ“¢ [ê³µì§€] í˜„ì¬ ìµœê³  ë¶€ìëŠ” 'ì´ˆì›”ì' ë“±ê¸‰ì„ ìœ ì§€í•˜ê³  ìˆìŠµë‹ˆë‹¤.",
            "ğŸ“¢ [ì´ë²¤íŠ¸] ì§€ê¸ˆ ì±„íŒ…ì„ ì…ë ¥í•˜ë©´ ë³´ë„ˆìŠ¤ í¬ì¸íŠ¸ê°€ ì§€ê¸‰ë  í™•ë¥ ì´ ë†’ìŠµë‹ˆë‹¤!"
        ]
        socketio.emit('message', {'msg': random.choice(news_list), 'type': 'system'}, room='main')

# --- [3. íŠ¹ìˆ˜ ê¸°ëŠ¥ ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 1
        reward = 5000
        update_money(nick, reward, bank=True)
        pattern = f"ğŸŒ€ [{nick}] ë‡Œì ˆ ë™ë ¥ ê°€ë™ ì¤‘... (+{reward}â‚© ì…ê¸ˆ)"
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"{pattern}\në¬´í•œ ë£¨í”„ íšŸìˆ˜: {m_count}íšŒì°¨", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3)

def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [4. ë¼ìš°íŒ… ë° ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸš€ {data['nickname']}ë‹˜ì´ ë©€í‹°ë²„ìŠ¤ ì„œë²„ì— ì ‘ì†í–ˆìŠµë‹ˆë‹¤!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ìˆ˜ìµ ê³µì‹]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ [ëŒ€ìš©ëŸ‰ ë°ì´í„° ë³€í™˜]\nê¸¸ì´: {msg_len}ì\në³´ìƒ: {reward}â‚© ì ë¦½ ì™„ë£Œ\nğŸ”— íŒŒì¼ ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ ì²˜ë¦¬]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        total = user['money'] + user['bank_money']
        res = f"ğŸ’° {nick}ë‹˜ì˜ ìì‚° ë³´ê³ ì„œ\n" \
              f"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" \
              f"ğŸ’µ í˜„ê¸ˆ: {user['money']:,}â‚©\n" \
              f"ğŸ¦ ì€í–‰: {user['bank_money']:,}â‚©\n" \
              f"ğŸ’³ ì´í•©: {total:,}â‚©\n" \
              f"ğŸ† ë“±ê¸‰: {'ì´ˆì›”ì' if total >= 10000000 else 'VIP' if total >= 1000000 else 'í‰ë¯¼'}"
        emit('message', {'msg': res, 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt:,}â‚©ì„ ì€í–‰ì— ì•ˆì „í•˜ê²Œ ë³´ê´€í–ˆìŠµë‹ˆë‹¤. (ë¶„ë‹¹ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ ì€í–‰ì—ì„œ {amt:,}â‚©ì„ ì¶œê¸ˆí–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ì´ ê°€ë™ë˜ì—ˆìŠµë‹ˆë‹¤! (3ì´ˆë‹¹ 5000â‚©)", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆ ì—”ì§„ì„ ì •ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            prompt = " ".join(cmd_parts[1:])
            res = client.models.generate_content(model="gemini-2.0-flash", contents=prompt)
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except Exception as e:
            emit('message', {'msg': f"âŒ ì—ëŸ¬: {str(e)}", 'type': 'system'})

    elif cmd == "!ëª…ë ¹ì–´":
        help_msg = "ğŸ“œ [ëª…ë ¹ì–´ ë¦¬ìŠ¤íŠ¸]\n!ì”ì•¡ - ë‚´ ìì‚° í™•ì¸\n!ì €ê¸ˆ [ì•¡ìˆ˜] - ì€í–‰ì— ì…ê¸ˆ\n!ì¶œê¸ˆ [ì•¡ìˆ˜] - í˜„ê¸ˆí™”\n!ë‡Œì ˆ - ë¬´í•œ ëˆ ë²Œê¸° ì‹œì‘\n!ë‡Œì ˆì¤‘ë‹¨ - ì¤‘ì§€\n!gemini [ì§ˆë¬¸] - AI ë‹µë³€\n!ëª…ë ¹ì–´ - ë„ì›€ë§"
        emit('message', {'msg': help_msg, 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ…
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=background_scheduler, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
import random
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í™˜ê²½] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "multiverse_empire.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {}

# Gemini AI í´ë¼ì´ì–¸íŠ¸ ì„¤ì •
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key:
        client = genai.Client(api_key=api_key)
except:
    print("Gemini SDKê°€ ì—†ê±°ë‚˜ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. !gemini ê¸°ëŠ¥ì€ ë¹„í™œì„±í™”ë©ë‹ˆë‹¤.")

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("""
            CREATE TABLE IF NOT EXISTS users (
                nickname TEXT PRIMARY KEY, 
                money INTEGER DEFAULT 1000, 
                bank_money INTEGER DEFAULT 0
            )
        """)
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ë° ë‰´ìŠ¤ ì‹œìŠ¤í…œ]
def background_scheduler():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤ ì‹¤í–‰
        with sqlite3.connect(DB_FILE) as conn:
            # 1. ì´ì ì§€ê¸‰ (1%)
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()
        
        # 2. ì‹¤ì‹œê°„ ê²½ì œ ë‰´ìŠ¤ ì´ë²¤íŠ¸
        news_list = [
            "ğŸ“¢ [ê²½ì œ] ì œêµ­ ì€í–‰ì˜ ê¸ˆë¦¬ê°€ ìƒìŠ¹ ì¡°ì§ì„ ë³´ì…ë‹ˆë‹¤!",
            "ğŸ“¢ [ì†Œì‹] ëŒ€ê·œëª¨ ë‡Œì ˆ ì—ë„ˆì§€ê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ì±„êµ´ íš¨ìœ¨ì´ ì¦ê°€í•©ë‹ˆë‹¤.",
            "ğŸ“¢ [ê³µì§€] í˜„ì¬ ìµœê³  ë¶€ìëŠ” 'ì´ˆì›”ì' ë“±ê¸‰ì„ ìœ ì§€í•˜ê³  ìˆìŠµë‹ˆë‹¤.",
            "ğŸ“¢ [ì´ë²¤íŠ¸] ì§€ê¸ˆ ì±„íŒ…ì„ ì…ë ¥í•˜ë©´ ë³´ë„ˆìŠ¤ í¬ì¸íŠ¸ê°€ ì§€ê¸‰ë  í™•ë¥ ì´ ë†’ìŠµë‹ˆë‹¤!"
        ]
        socketio.emit('message', {'msg': random.choice(news_list), 'type': 'system'}, room='main')

# --- [3. íŠ¹ìˆ˜ ê¸°ëŠ¥ ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 1
        reward = 5000
        update_money(nick, reward, bank=True)
        pattern = f"ğŸŒ€ [{nick}] ë‡Œì ˆ ë™ë ¥ ê°€ë™ ì¤‘... (+{reward}â‚© ì…ê¸ˆ)"
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"{pattern}\në¬´í•œ ë£¨í”„ íšŸìˆ˜: {m_count}íšŒì°¨", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3)

def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [4. ë¼ìš°íŒ… ë° ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸš€ {data['nickname']}ë‹˜ì´ ë©€í‹°ë²„ìŠ¤ ì„œë²„ì— ì ‘ì†í–ˆìŠµë‹ˆë‹¤!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ìˆ˜ìµ ê³µì‹]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ [ëŒ€ìš©ëŸ‰ ë°ì´í„° ë³€í™˜]\nê¸¸ì´: {msg_len}ì\në³´ìƒ: {reward}â‚© ì ë¦½ ì™„ë£Œ\nğŸ”— íŒŒì¼ ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ ì²˜ë¦¬]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        total = user['money'] + user['bank_money']
        res = f"ğŸ’° {nick}ë‹˜ì˜ ìì‚° ë³´ê³ ì„œ\n" \
              f"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" \
              f"ğŸ’µ í˜„ê¸ˆ: {user['money']:,}â‚©\n" \
              f"ğŸ¦ ì€í–‰: {user['bank_money']:,}â‚©\n" \
              f"ğŸ’³ ì´í•©: {total:,}â‚©\n" \
              f"ğŸ† ë“±ê¸‰: {'ì´ˆì›”ì' if total >= 10000000 else 'VIP' if total >= 1000000 else 'í‰ë¯¼'}"
        emit('message', {'msg': res, 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt:,}â‚©ì„ ì€í–‰ì— ì•ˆì „í•˜ê²Œ ë³´ê´€í–ˆìŠµë‹ˆë‹¤. (ë¶„ë‹¹ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ ì€í–‰ì—ì„œ {amt:,}â‚©ì„ ì¶œê¸ˆí–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ì´ ê°€ë™ë˜ì—ˆìŠµë‹ˆë‹¤! (3ì´ˆë‹¹ 5000â‚©)", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆ ì—”ì§„ì„ ì •ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            prompt = " ".join(cmd_parts[1:])
            res = client.models.generate_content(model="gemini-2.0-flash", contents=prompt)
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except Exception as e:
            emit('message', {'msg': f"âŒ ì—ëŸ¬: {str(e)}", 'type': 'system'})

    elif cmd == "!ëª…ë ¹ì–´":
        help_msg = "ğŸ“œ [ëª…ë ¹ì–´ ë¦¬ìŠ¤íŠ¸]\n!ì”ì•¡ - ë‚´ ìì‚° í™•ì¸\n!ì €ê¸ˆ [ì•¡ìˆ˜] - ì€í–‰ì— ì…ê¸ˆ\n!ì¶œê¸ˆ [ì•¡ìˆ˜] - í˜„ê¸ˆí™”\n!ë‡Œì ˆ - ë¬´í•œ ëˆ ë²Œê¸° ì‹œì‘\n!ë‡Œì ˆì¤‘ë‹¨ - ì¤‘ì§€\n!gemini [ì§ˆë¬¸] - AI ë‹µë³€\n!ëª…ë ¹ì–´ - ë„ì›€ë§"
        emit('message', {'msg': help_msg, 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ…
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=background_scheduler, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
import random
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í™˜ê²½] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "multiverse_empire.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {}

# Gemini AI í´ë¼ì´ì–¸íŠ¸ ì„¤ì •
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key:
        client = genai.Client(api_key=api_key)
except:
    print("Gemini SDKê°€ ì—†ê±°ë‚˜ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. !gemini ê¸°ëŠ¥ì€ ë¹„í™œì„±í™”ë©ë‹ˆë‹¤.")

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("""
            CREATE TABLE IF NOT EXISTS users (
                nickname TEXT PRIMARY KEY, 
                money INTEGER DEFAULT 1000, 
                bank_money INTEGER DEFAULT 0
            )
        """)
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ë° ë‰´ìŠ¤ ì‹œìŠ¤í…œ]
def background_scheduler():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤ ì‹¤í–‰
        with sqlite3.connect(DB_FILE) as conn:
            # 1. ì´ì ì§€ê¸‰ (1%)
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()
        
        # 2. ì‹¤ì‹œê°„ ê²½ì œ ë‰´ìŠ¤ ì´ë²¤íŠ¸
        news_list = [
            "ğŸ“¢ [ê²½ì œ] ì œêµ­ ì€í–‰ì˜ ê¸ˆë¦¬ê°€ ìƒìŠ¹ ì¡°ì§ì„ ë³´ì…ë‹ˆë‹¤!",
            "ğŸ“¢ [ì†Œì‹] ëŒ€ê·œëª¨ ë‡Œì ˆ ì—ë„ˆì§€ê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ì±„êµ´ íš¨ìœ¨ì´ ì¦ê°€í•©ë‹ˆë‹¤.",
            "ğŸ“¢ [ê³µì§€] í˜„ì¬ ìµœê³  ë¶€ìëŠ” 'ì´ˆì›”ì' ë“±ê¸‰ì„ ìœ ì§€í•˜ê³  ìˆìŠµë‹ˆë‹¤.",
            "ğŸ“¢ [ì´ë²¤íŠ¸] ì§€ê¸ˆ ì±„íŒ…ì„ ì…ë ¥í•˜ë©´ ë³´ë„ˆìŠ¤ í¬ì¸íŠ¸ê°€ ì§€ê¸‰ë  í™•ë¥ ì´ ë†’ìŠµë‹ˆë‹¤!"
        ]
        socketio.emit('message', {'msg': random.choice(news_list), 'type': 'system'}, room='main')

# --- [3. íŠ¹ìˆ˜ ê¸°ëŠ¥ ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 1
        reward = 5000
        update_money(nick, reward, bank=True)
        pattern = f"ğŸŒ€ [{nick}] ë‡Œì ˆ ë™ë ¥ ê°€ë™ ì¤‘... (+{reward}â‚© ì…ê¸ˆ)"
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"{pattern}\në¬´í•œ ë£¨í”„ íšŸìˆ˜: {m_count}íšŒì°¨", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3)

def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [4. ë¼ìš°íŒ… ë° ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸš€ {data['nickname']}ë‹˜ì´ ë©€í‹°ë²„ìŠ¤ ì„œë²„ì— ì ‘ì†í–ˆìŠµë‹ˆë‹¤!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ìˆ˜ìµ ê³µì‹]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ [ëŒ€ìš©ëŸ‰ ë°ì´í„° ë³€í™˜]\nê¸¸ì´: {msg_len}ì\në³´ìƒ: {reward}â‚© ì ë¦½ ì™„ë£Œ\nğŸ”— íŒŒì¼ ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ ì²˜ë¦¬]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        total = user['money'] + user['bank_money']
        res = f"ğŸ’° {nick}ë‹˜ì˜ ìì‚° ë³´ê³ ì„œ\n" \
              f"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" \
              f"ğŸ’µ í˜„ê¸ˆ: {user['money']:,}â‚©\n" \
              f"ğŸ¦ ì€í–‰: {user['bank_money']:,}â‚©\n" \
              f"ğŸ’³ ì´í•©: {total:,}â‚©\n" \
              f"ğŸ† ë“±ê¸‰: {'ì´ˆì›”ì' if total >= 10000000 else 'VIP' if total >= 1000000 else 'í‰ë¯¼'}"
        emit('message', {'msg': res, 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt:,}â‚©ì„ ì€í–‰ì— ì•ˆì „í•˜ê²Œ ë³´ê´€í–ˆìŠµë‹ˆë‹¤. (ë¶„ë‹¹ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ ì€í–‰ì—ì„œ {amt:,}â‚©ì„ ì¶œê¸ˆí–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ì´ ê°€ë™ë˜ì—ˆìŠµë‹ˆë‹¤! (3ì´ˆë‹¹ 5000â‚©)", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆ ì—”ì§„ì„ ì •ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            prompt = " ".join(cmd_parts[1:])
            res = client.models.generate_content(model="gemini-2.0-flash", contents=prompt)
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except Exception as e:
            emit('message', {'msg': f"âŒ ì—ëŸ¬: {str(e)}", 'type': 'system'})

    elif cmd == "!ëª…ë ¹ì–´":
        help_msg = "ğŸ“œ [ëª…ë ¹ì–´ ë¦¬ìŠ¤íŠ¸]\n!ì”ì•¡ - ë‚´ ìì‚° í™•ì¸\n!ì €ê¸ˆ [ì•¡ìˆ˜] - ì€í–‰ì— ì…ê¸ˆ\n!ì¶œê¸ˆ [ì•¡ìˆ˜] - í˜„ê¸ˆí™”\n!ë‡Œì ˆ - ë¬´í•œ ëˆ ë²Œê¸° ì‹œì‘\n!ë‡Œì ˆì¤‘ë‹¨ - ì¤‘ì§€\n!gemini [ì§ˆë¬¸] - AI ë‹µë³€\n!ëª…ë ¹ì–´ - ë„ì›€ë§"
        emit('message', {'msg': help_msg, 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ…
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=background_scheduler, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)