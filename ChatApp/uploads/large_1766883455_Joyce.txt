import sqlite3
import os
import time
import threading
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í´ë”] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "empire_master.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
# ëª¨ë“  í™˜ê²½ í˜¸í™˜ì„ ìœ„í•œ threading ëª¨ë“œ
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {} # ë‡Œì ˆ ìƒíƒœ ì €ì¥ìš©

# Gemini AI (ì„¤ì¹˜ë˜ì–´ ìˆì„ ê²½ìš°ë§Œ)
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key: client = genai.Client(api_key=api_key)
except: pass

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("CREATE TABLE IF NOT EXISTS users (nickname TEXT PRIMARY KEY, money INTEGER DEFAULT 1000, bank_money INTEGER DEFAULT 0)")
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ì‹œìŠ¤í…œ]
def interest_system():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤
        with sqlite3.connect(DB_FILE) as conn:
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()

# --- [3. ë‡Œì ˆ(ë¬´í•œ ë£¨í”„) ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 100
        # ë‡Œì ˆ íŒ¨í„´ ìƒì„±
        pattern = f"[:[{nick}].{m_count}â‚©:] " * 5
        reward = 5000
        update_money(nick, reward, bank=True) # ì€í–‰ìœ¼ë¡œ ë°”ë¡œ ì…ê¸ˆ
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"ğŸŒ€ ë‡Œì ˆ ì‹œìŠ¤í…œ ê°€ë™ ì¤‘... \nğŸ’° ì€í–‰ ì…ê¸ˆ: +{reward}â‚©\n{pattern}", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3) # 3ì´ˆ ê°„ê²© ë‡Œì ˆ

# --- [4. ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ ì²˜ë¦¬] ---
def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [5. ë¼ìš°íŒ… ë° ì†Œì¼“ ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸ“¢ {data['nickname']}ë‹˜ ì œêµ­ ê°•ë¦¼!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ê¸€ì ìˆ˜ ë³´ìƒ ê³µì‹: ê¸°ë³¸ 50ì› + 10ìë‹¹ 20ì›]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    # [ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ íŒŒì¼ ë³€í™˜]
    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ ëŒ€ìš©ëŸ‰ ë°ì´í„°(ê¸€ììˆ˜: {msg_len})ê°€ íŒŒì¼ë¡œ ë³€í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.\nğŸ”— ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ íŒë…]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        emit('message', {'msg': f"ğŸ’° {nick}ë‹˜ ìì‚° | í˜„ê¸ˆ: {user['money']}â‚© | ì€í–‰: {user['bank_money']}â‚© | ë“±ê¸‰: {'ì´ˆì›”ì' if user['money']>1000000 else 'í‰ë¯¼'}", 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt}â‚© ì €ê¸ˆ ì„±ê³µ! (ë§¤ë¶„ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ {amt}â‚© ì¶œê¸ˆ ì„±ê³µ!", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ ê°€ë™!", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆì„ ì¤‘ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            res = client.models.generate_content(model="gemini-2.0-flash", contents=msg[8:])
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except: pass

    elif cmd == "!ëª…ë ¹ì–´":
        emit('message', {'msg': "ğŸ“œ !ì”ì•¡, !ì €ê¸ˆ [ì•¡ìˆ˜], !ì¶œê¸ˆ [ì•¡ìˆ˜], !ë‡Œì ˆ, !ë‡Œì ˆì¤‘ë‹¨, !gemini [ì§ˆë¬¸]", 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ… ì „ì†¡
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=interest_system, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í´ë”] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "empire_master.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
# ëª¨ë“  í™˜ê²½ í˜¸í™˜ì„ ìœ„í•œ threading ëª¨ë“œ
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {} # ë‡Œì ˆ ìƒíƒœ ì €ì¥ìš©

# Gemini AI (ì„¤ì¹˜ë˜ì–´ ìˆì„ ê²½ìš°ë§Œ)
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key: client = genai.Client(api_key=api_key)
except: pass

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("CREATE TABLE IF NOT EXISTS users (nickname TEXT PRIMARY KEY, money INTEGER DEFAULT 1000, bank_money INTEGER DEFAULT 0)")
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ì‹œìŠ¤í…œ]
def interest_system():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤
        with sqlite3.connect(DB_FILE) as conn:
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()

# --- [3. ë‡Œì ˆ(ë¬´í•œ ë£¨í”„) ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 100
        # ë‡Œì ˆ íŒ¨í„´ ìƒì„±
        pattern = f"[:[{nick}].{m_count}â‚©:] " * 5
        reward = 5000
        update_money(nick, reward, bank=True) # ì€í–‰ìœ¼ë¡œ ë°”ë¡œ ì…ê¸ˆ
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"ğŸŒ€ ë‡Œì ˆ ì‹œìŠ¤í…œ ê°€ë™ ì¤‘... \nğŸ’° ì€í–‰ ì…ê¸ˆ: +{reward}â‚©\n{pattern}", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3) # 3ì´ˆ ê°„ê²© ë‡Œì ˆ

# --- [4. ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ ì²˜ë¦¬] ---
def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [5. ë¼ìš°íŒ… ë° ì†Œì¼“ ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸ“¢ {data['nickname']}ë‹˜ ì œêµ­ ê°•ë¦¼!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ê¸€ì ìˆ˜ ë³´ìƒ ê³µì‹: ê¸°ë³¸ 50ì› + 10ìë‹¹ 20ì›]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    # [ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ íŒŒì¼ ë³€í™˜]
    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ ëŒ€ìš©ëŸ‰ ë°ì´í„°(ê¸€ììˆ˜: {msg_len})ê°€ íŒŒì¼ë¡œ ë³€í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.\nğŸ”— ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ íŒë…]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        emit('message', {'msg': f"ğŸ’° {nick}ë‹˜ ìì‚° | í˜„ê¸ˆ: {user['money']}â‚© | ì€í–‰: {user['bank_money']}â‚© | ë“±ê¸‰: {'ì´ˆì›”ì' if user['money']>1000000 else 'í‰ë¯¼'}", 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt}â‚© ì €ê¸ˆ ì„±ê³µ! (ë§¤ë¶„ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ {amt}â‚© ì¶œê¸ˆ ì„±ê³µ!", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ ê°€ë™!", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆì„ ì¤‘ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            res = client.models.generate_content(model="gemini-2.0-flash", contents=msg[8:])
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except: pass

    elif cmd == "!ëª…ë ¹ì–´":
        emit('message', {'msg': "ğŸ“œ !ì”ì•¡, !ì €ê¸ˆ [ì•¡ìˆ˜], !ì¶œê¸ˆ [ì•¡ìˆ˜], !ë‡Œì ˆ, !ë‡Œì ˆì¤‘ë‹¨, !gemini [ì§ˆë¬¸]", 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ… ì „ì†¡
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=interest_system, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í´ë”] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "empire_master.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
# ëª¨ë“  í™˜ê²½ í˜¸í™˜ì„ ìœ„í•œ threading ëª¨ë“œ
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {} # ë‡Œì ˆ ìƒíƒœ ì €ì¥ìš©

# Gemini AI (ì„¤ì¹˜ë˜ì–´ ìˆì„ ê²½ìš°ë§Œ)
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key: client = genai.Client(api_key=api_key)
except: pass

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("CREATE TABLE IF NOT EXISTS users (nickname TEXT PRIMARY KEY, money INTEGER DEFAULT 1000, bank_money INTEGER DEFAULT 0)")
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ì‹œìŠ¤í…œ]
def interest_system():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤
        with sqlite3.connect(DB_FILE) as conn:
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()

# --- [3. ë‡Œì ˆ(ë¬´í•œ ë£¨í”„) ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 100
        # ë‡Œì ˆ íŒ¨í„´ ìƒì„±
        pattern = f"[:[{nick}].{m_count}â‚©:] " * 5
        reward = 5000
        update_money(nick, reward, bank=True) # ì€í–‰ìœ¼ë¡œ ë°”ë¡œ ì…ê¸ˆ
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"ğŸŒ€ ë‡Œì ˆ ì‹œìŠ¤í…œ ê°€ë™ ì¤‘... \nğŸ’° ì€í–‰ ì…ê¸ˆ: +{reward}â‚©\n{pattern}", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3) # 3ì´ˆ ê°„ê²© ë‡Œì ˆ

# --- [4. ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ ì²˜ë¦¬] ---
def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [5. ë¼ìš°íŒ… ë° ì†Œì¼“ ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸ“¢ {data['nickname']}ë‹˜ ì œêµ­ ê°•ë¦¼!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ê¸€ì ìˆ˜ ë³´ìƒ ê³µì‹: ê¸°ë³¸ 50ì› + 10ìë‹¹ 20ì›]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    # [ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ íŒŒì¼ ë³€í™˜]
    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ ëŒ€ìš©ëŸ‰ ë°ì´í„°(ê¸€ììˆ˜: {msg_len})ê°€ íŒŒì¼ë¡œ ë³€í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.\nğŸ”— ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ íŒë…]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        emit('message', {'msg': f"ğŸ’° {nick}ë‹˜ ìì‚° | í˜„ê¸ˆ: {user['money']}â‚© | ì€í–‰: {user['bank_money']}â‚© | ë“±ê¸‰: {'ì´ˆì›”ì' if user['money']>1000000 else 'í‰ë¯¼'}", 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt}â‚© ì €ê¸ˆ ì„±ê³µ! (ë§¤ë¶„ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ {amt}â‚© ì¶œê¸ˆ ì„±ê³µ!", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ ê°€ë™!", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆì„ ì¤‘ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            res = client.models.generate_content(model="gemini-2.0-flash", contents=msg[8:])
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except: pass

    elif cmd == "!ëª…ë ¹ì–´":
        emit('message', {'msg': "ğŸ“œ !ì”ì•¡, !ì €ê¸ˆ [ì•¡ìˆ˜], !ì¶œê¸ˆ [ì•¡ìˆ˜], !ë‡Œì ˆ, !ë‡Œì ˆì¤‘ë‹¨, !gemini [ì§ˆë¬¸]", 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ… ì „ì†¡
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=interest_system, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í´ë”] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "empire_master.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
# ëª¨ë“  í™˜ê²½ í˜¸í™˜ì„ ìœ„í•œ threading ëª¨ë“œ
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {} # ë‡Œì ˆ ìƒíƒœ ì €ì¥ìš©

# Gemini AI (ì„¤ì¹˜ë˜ì–´ ìˆì„ ê²½ìš°ë§Œ)
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key: client = genai.Client(api_key=api_key)
except: pass

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("CREATE TABLE IF NOT EXISTS users (nickname TEXT PRIMARY KEY, money INTEGER DEFAULT 1000, bank_money INTEGER DEFAULT 0)")
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ì‹œìŠ¤í…œ]
def interest_system():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤
        with sqlite3.connect(DB_FILE) as conn:
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()

# --- [3. ë‡Œì ˆ(ë¬´í•œ ë£¨í”„) ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 100
        # ë‡Œì ˆ íŒ¨í„´ ìƒì„±
        pattern = f"[:[{nick}].{m_count}â‚©:] " * 5
        reward = 5000
        update_money(nick, reward, bank=True) # ì€í–‰ìœ¼ë¡œ ë°”ë¡œ ì…ê¸ˆ
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"ğŸŒ€ ë‡Œì ˆ ì‹œìŠ¤í…œ ê°€ë™ ì¤‘... \nğŸ’° ì€í–‰ ì…ê¸ˆ: +{reward}â‚©\n{pattern}", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3) # 3ì´ˆ ê°„ê²© ë‡Œì ˆ

# --- [4. ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ ì²˜ë¦¬] ---
def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [5. ë¼ìš°íŒ… ë° ì†Œì¼“ ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸ“¢ {data['nickname']}ë‹˜ ì œêµ­ ê°•ë¦¼!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ê¸€ì ìˆ˜ ë³´ìƒ ê³µì‹: ê¸°ë³¸ 50ì› + 10ìë‹¹ 20ì›]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    # [ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ íŒŒì¼ ë³€í™˜]
    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ ëŒ€ìš©ëŸ‰ ë°ì´í„°(ê¸€ììˆ˜: {msg_len})ê°€ íŒŒì¼ë¡œ ë³€í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.\nğŸ”— ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ íŒë…]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        emit('message', {'msg': f"ğŸ’° {nick}ë‹˜ ìì‚° | í˜„ê¸ˆ: {user['money']}â‚© | ì€í–‰: {user['bank_money']}â‚© | ë“±ê¸‰: {'ì´ˆì›”ì' if user['money']>1000000 else 'í‰ë¯¼'}", 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt}â‚© ì €ê¸ˆ ì„±ê³µ! (ë§¤ë¶„ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ {amt}â‚© ì¶œê¸ˆ ì„±ê³µ!", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ ê°€ë™!", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆì„ ì¤‘ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            res = client.models.generate_content(model="gemini-2.0-flash", contents=msg[8:])
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except: pass

    elif cmd == "!ëª…ë ¹ì–´":
        emit('message', {'msg': "ğŸ“œ !ì”ì•¡, !ì €ê¸ˆ [ì•¡ìˆ˜], !ì¶œê¸ˆ [ì•¡ìˆ˜], !ë‡Œì ˆ, !ë‡Œì ˆì¤‘ë‹¨, !gemini [ì§ˆë¬¸]", 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ… ì „ì†¡
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=interest_system, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í´ë”] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "empire_master.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
# ëª¨ë“  í™˜ê²½ í˜¸í™˜ì„ ìœ„í•œ threading ëª¨ë“œ
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {} # ë‡Œì ˆ ìƒíƒœ ì €ì¥ìš©

# Gemini AI (ì„¤ì¹˜ë˜ì–´ ìˆì„ ê²½ìš°ë§Œ)
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key: client = genai.Client(api_key=api_key)
except: pass

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("CREATE TABLE IF NOT EXISTS users (nickname TEXT PRIMARY KEY, money INTEGER DEFAULT 1000, bank_money INTEGER DEFAULT 0)")
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ì‹œìŠ¤í…œ]
def interest_system():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤
        with sqlite3.connect(DB_FILE) as conn:
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()

# --- [3. ë‡Œì ˆ(ë¬´í•œ ë£¨í”„) ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 100
        # ë‡Œì ˆ íŒ¨í„´ ìƒì„±
        pattern = f"[:[{nick}].{m_count}â‚©:] " * 5
        reward = 5000
        update_money(nick, reward, bank=True) # ì€í–‰ìœ¼ë¡œ ë°”ë¡œ ì…ê¸ˆ
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"ğŸŒ€ ë‡Œì ˆ ì‹œìŠ¤í…œ ê°€ë™ ì¤‘... \nğŸ’° ì€í–‰ ì…ê¸ˆ: +{reward}â‚©\n{pattern}", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3) # 3ì´ˆ ê°„ê²© ë‡Œì ˆ

# --- [4. ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ ì²˜ë¦¬] ---
def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [5. ë¼ìš°íŒ… ë° ì†Œì¼“ ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸ“¢ {data['nickname']}ë‹˜ ì œêµ­ ê°•ë¦¼!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ê¸€ì ìˆ˜ ë³´ìƒ ê³µì‹: ê¸°ë³¸ 50ì› + 10ìë‹¹ 20ì›]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    # [ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ íŒŒì¼ ë³€í™˜]
    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ ëŒ€ìš©ëŸ‰ ë°ì´í„°(ê¸€ììˆ˜: {msg_len})ê°€ íŒŒì¼ë¡œ ë³€í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.\nğŸ”— ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ íŒë…]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        emit('message', {'msg': f"ğŸ’° {nick}ë‹˜ ìì‚° | í˜„ê¸ˆ: {user['money']}â‚© | ì€í–‰: {user['bank_money']}â‚© | ë“±ê¸‰: {'ì´ˆì›”ì' if user['money']>1000000 else 'í‰ë¯¼'}", 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt}â‚© ì €ê¸ˆ ì„±ê³µ! (ë§¤ë¶„ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ {amt}â‚© ì¶œê¸ˆ ì„±ê³µ!", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ ê°€ë™!", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆì„ ì¤‘ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            res = client.models.generate_content(model="gemini-2.0-flash", contents=msg[8:])
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except: pass

    elif cmd == "!ëª…ë ¹ì–´":
        emit('message', {'msg': "ğŸ“œ !ì”ì•¡, !ì €ê¸ˆ [ì•¡ìˆ˜], !ì¶œê¸ˆ [ì•¡ìˆ˜], !ë‡Œì ˆ, !ë‡Œì ˆì¤‘ë‹¨, !gemini [ì§ˆë¬¸]", 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ… ì „ì†¡
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=interest_system, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í´ë”] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "empire_master.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
# ëª¨ë“  í™˜ê²½ í˜¸í™˜ì„ ìœ„í•œ threading ëª¨ë“œ
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {} # ë‡Œì ˆ ìƒíƒœ ì €ì¥ìš©

# Gemini AI (ì„¤ì¹˜ë˜ì–´ ìˆì„ ê²½ìš°ë§Œ)
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key: client = genai.Client(api_key=api_key)
except: pass

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("CREATE TABLE IF NOT EXISTS users (nickname TEXT PRIMARY KEY, money INTEGER DEFAULT 1000, bank_money INTEGER DEFAULT 0)")
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ì‹œìŠ¤í…œ]
def interest_system():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤
        with sqlite3.connect(DB_FILE) as conn:
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()

# --- [3. ë‡Œì ˆ(ë¬´í•œ ë£¨í”„) ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 100
        # ë‡Œì ˆ íŒ¨í„´ ìƒì„±
        pattern = f"[:[{nick}].{m_count}â‚©:] " * 5
        reward = 5000
        update_money(nick, reward, bank=True) # ì€í–‰ìœ¼ë¡œ ë°”ë¡œ ì…ê¸ˆ
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"ğŸŒ€ ë‡Œì ˆ ì‹œìŠ¤í…œ ê°€ë™ ì¤‘... \nğŸ’° ì€í–‰ ì…ê¸ˆ: +{reward}â‚©\n{pattern}", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3) # 3ì´ˆ ê°„ê²© ë‡Œì ˆ

# --- [4. ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ ì²˜ë¦¬] ---
def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [5. ë¼ìš°íŒ… ë° ì†Œì¼“ ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸ“¢ {data['nickname']}ë‹˜ ì œêµ­ ê°•ë¦¼!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ê¸€ì ìˆ˜ ë³´ìƒ ê³µì‹: ê¸°ë³¸ 50ì› + 10ìë‹¹ 20ì›]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    # [ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ íŒŒì¼ ë³€í™˜]
    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ ëŒ€ìš©ëŸ‰ ë°ì´í„°(ê¸€ììˆ˜: {msg_len})ê°€ íŒŒì¼ë¡œ ë³€í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.\nğŸ”— ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ íŒë…]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        emit('message', {'msg': f"ğŸ’° {nick}ë‹˜ ìì‚° | í˜„ê¸ˆ: {user['money']}â‚© | ì€í–‰: {user['bank_money']}â‚© | ë“±ê¸‰: {'ì´ˆì›”ì' if user['money']>1000000 else 'í‰ë¯¼'}", 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt}â‚© ì €ê¸ˆ ì„±ê³µ! (ë§¤ë¶„ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ {amt}â‚© ì¶œê¸ˆ ì„±ê³µ!", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ ê°€ë™!", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆì„ ì¤‘ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            res = client.models.generate_content(model="gemini-2.0-flash", contents=msg[8:])
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except: pass

    elif cmd == "!ëª…ë ¹ì–´":
        emit('message', {'msg': "ğŸ“œ !ì”ì•¡, !ì €ê¸ˆ [ì•¡ìˆ˜], !ì¶œê¸ˆ [ì•¡ìˆ˜], !ë‡Œì ˆ, !ë‡Œì ˆì¤‘ë‹¨, !gemini [ì§ˆë¬¸]", 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ… ì „ì†¡
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=interest_system, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í´ë”] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "empire_master.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
# ëª¨ë“  í™˜ê²½ í˜¸í™˜ì„ ìœ„í•œ threading ëª¨ë“œ
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {} # ë‡Œì ˆ ìƒíƒœ ì €ì¥ìš©

# Gemini AI (ì„¤ì¹˜ë˜ì–´ ìˆì„ ê²½ìš°ë§Œ)
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key: client = genai.Client(api_key=api_key)
except: pass

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("CREATE TABLE IF NOT EXISTS users (nickname TEXT PRIMARY KEY, money INTEGER DEFAULT 1000, bank_money INTEGER DEFAULT 0)")
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ì‹œìŠ¤í…œ]
def interest_system():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤
        with sqlite3.connect(DB_FILE) as conn:
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()

# --- [3. ë‡Œì ˆ(ë¬´í•œ ë£¨í”„) ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 100
        # ë‡Œì ˆ íŒ¨í„´ ìƒì„±
        pattern = f"[:[{nick}].{m_count}â‚©:] " * 5
        reward = 5000
        update_money(nick, reward, bank=True) # ì€í–‰ìœ¼ë¡œ ë°”ë¡œ ì…ê¸ˆ
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"ğŸŒ€ ë‡Œì ˆ ì‹œìŠ¤í…œ ê°€ë™ ì¤‘... \nğŸ’° ì€í–‰ ì…ê¸ˆ: +{reward}â‚©\n{pattern}", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3) # 3ì´ˆ ê°„ê²© ë‡Œì ˆ

# --- [4. ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ ì²˜ë¦¬] ---
def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [5. ë¼ìš°íŒ… ë° ì†Œì¼“ ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸ“¢ {data['nickname']}ë‹˜ ì œêµ­ ê°•ë¦¼!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ê¸€ì ìˆ˜ ë³´ìƒ ê³µì‹: ê¸°ë³¸ 50ì› + 10ìë‹¹ 20ì›]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    # [ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ íŒŒì¼ ë³€í™˜]
    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ ëŒ€ìš©ëŸ‰ ë°ì´í„°(ê¸€ììˆ˜: {msg_len})ê°€ íŒŒì¼ë¡œ ë³€í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.\nğŸ”— ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ íŒë…]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        emit('message', {'msg': f"ğŸ’° {nick}ë‹˜ ìì‚° | í˜„ê¸ˆ: {user['money']}â‚© | ì€í–‰: {user['bank_money']}â‚© | ë“±ê¸‰: {'ì´ˆì›”ì' if user['money']>1000000 else 'í‰ë¯¼'}", 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt}â‚© ì €ê¸ˆ ì„±ê³µ! (ë§¤ë¶„ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ {amt}â‚© ì¶œê¸ˆ ì„±ê³µ!", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ ê°€ë™!", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆì„ ì¤‘ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            res = client.models.generate_content(model="gemini-2.0-flash", contents=msg[8:])
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except: pass

    elif cmd == "!ëª…ë ¹ì–´":
        emit('message', {'msg': "ğŸ“œ !ì”ì•¡, !ì €ê¸ˆ [ì•¡ìˆ˜], !ì¶œê¸ˆ [ì•¡ìˆ˜], !ë‡Œì ˆ, !ë‡Œì ˆì¤‘ë‹¨, !gemini [ì§ˆë¬¸]", 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ… ì „ì†¡
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=interest_system, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í´ë”] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "empire_master.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
# ëª¨ë“  í™˜ê²½ í˜¸í™˜ì„ ìœ„í•œ threading ëª¨ë“œ
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {} # ë‡Œì ˆ ìƒíƒœ ì €ì¥ìš©

# Gemini AI (ì„¤ì¹˜ë˜ì–´ ìˆì„ ê²½ìš°ë§Œ)
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key: client = genai.Client(api_key=api_key)
except: pass

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("CREATE TABLE IF NOT EXISTS users (nickname TEXT PRIMARY KEY, money INTEGER DEFAULT 1000, bank_money INTEGER DEFAULT 0)")
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ì‹œìŠ¤í…œ]
def interest_system():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤
        with sqlite3.connect(DB_FILE) as conn:
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()

# --- [3. ë‡Œì ˆ(ë¬´í•œ ë£¨í”„) ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 100
        # ë‡Œì ˆ íŒ¨í„´ ìƒì„±
        pattern = f"[:[{nick}].{m_count}â‚©:] " * 5
        reward = 5000
        update_money(nick, reward, bank=True) # ì€í–‰ìœ¼ë¡œ ë°”ë¡œ ì…ê¸ˆ
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"ğŸŒ€ ë‡Œì ˆ ì‹œìŠ¤í…œ ê°€ë™ ì¤‘... \nğŸ’° ì€í–‰ ì…ê¸ˆ: +{reward}â‚©\n{pattern}", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3) # 3ì´ˆ ê°„ê²© ë‡Œì ˆ

# --- [4. ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ ì²˜ë¦¬] ---
def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [5. ë¼ìš°íŒ… ë° ì†Œì¼“ ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸ“¢ {data['nickname']}ë‹˜ ì œêµ­ ê°•ë¦¼!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ê¸€ì ìˆ˜ ë³´ìƒ ê³µì‹: ê¸°ë³¸ 50ì› + 10ìë‹¹ 20ì›]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    # [ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ íŒŒì¼ ë³€í™˜]
    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ ëŒ€ìš©ëŸ‰ ë°ì´í„°(ê¸€ììˆ˜: {msg_len})ê°€ íŒŒì¼ë¡œ ë³€í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.\nğŸ”— ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ íŒë…]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        emit('message', {'msg': f"ğŸ’° {nick}ë‹˜ ìì‚° | í˜„ê¸ˆ: {user['money']}â‚© | ì€í–‰: {user['bank_money']}â‚© | ë“±ê¸‰: {'ì´ˆì›”ì' if user['money']>1000000 else 'í‰ë¯¼'}", 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt}â‚© ì €ê¸ˆ ì„±ê³µ! (ë§¤ë¶„ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ {amt}â‚© ì¶œê¸ˆ ì„±ê³µ!", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ ê°€ë™!", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆì„ ì¤‘ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            res = client.models.generate_content(model="gemini-2.0-flash", contents=msg[8:])
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except: pass

    elif cmd == "!ëª…ë ¹ì–´":
        emit('message', {'msg': "ğŸ“œ !ì”ì•¡, !ì €ê¸ˆ [ì•¡ìˆ˜], !ì¶œê¸ˆ [ì•¡ìˆ˜], !ë‡Œì ˆ, !ë‡Œì ˆì¤‘ë‹¨, !gemini [ì§ˆë¬¸]", 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ… ì „ì†¡
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=interest_system, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í´ë”] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "empire_master.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
# ëª¨ë“  í™˜ê²½ í˜¸í™˜ì„ ìœ„í•œ threading ëª¨ë“œ
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {} # ë‡Œì ˆ ìƒíƒœ ì €ì¥ìš©

# Gemini AI (ì„¤ì¹˜ë˜ì–´ ìˆì„ ê²½ìš°ë§Œ)
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key: client = genai.Client(api_key=api_key)
except: pass

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("CREATE TABLE IF NOT EXISTS users (nickname TEXT PRIMARY KEY, money INTEGER DEFAULT 1000, bank_money INTEGER DEFAULT 0)")
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ì‹œìŠ¤í…œ]
def interest_system():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤
        with sqlite3.connect(DB_FILE) as conn:
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()

# --- [3. ë‡Œì ˆ(ë¬´í•œ ë£¨í”„) ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 100
        # ë‡Œì ˆ íŒ¨í„´ ìƒì„±
        pattern = f"[:[{nick}].{m_count}â‚©:] " * 5
        reward = 5000
        update_money(nick, reward, bank=True) # ì€í–‰ìœ¼ë¡œ ë°”ë¡œ ì…ê¸ˆ
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"ğŸŒ€ ë‡Œì ˆ ì‹œìŠ¤í…œ ê°€ë™ ì¤‘... \nğŸ’° ì€í–‰ ì…ê¸ˆ: +{reward}â‚©\n{pattern}", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3) # 3ì´ˆ ê°„ê²© ë‡Œì ˆ

# --- [4. ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ ì²˜ë¦¬] ---
def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [5. ë¼ìš°íŒ… ë° ì†Œì¼“ ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸ“¢ {data['nickname']}ë‹˜ ì œêµ­ ê°•ë¦¼!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ê¸€ì ìˆ˜ ë³´ìƒ ê³µì‹: ê¸°ë³¸ 50ì› + 10ìë‹¹ 20ì›]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    # [ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ íŒŒì¼ ë³€í™˜]
    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ ëŒ€ìš©ëŸ‰ ë°ì´í„°(ê¸€ììˆ˜: {msg_len})ê°€ íŒŒì¼ë¡œ ë³€í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.\nğŸ”— ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ íŒë…]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        emit('message', {'msg': f"ğŸ’° {nick}ë‹˜ ìì‚° | í˜„ê¸ˆ: {user['money']}â‚© | ì€í–‰: {user['bank_money']}â‚© | ë“±ê¸‰: {'ì´ˆì›”ì' if user['money']>1000000 else 'í‰ë¯¼'}", 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt}â‚© ì €ê¸ˆ ì„±ê³µ! (ë§¤ë¶„ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ {amt}â‚© ì¶œê¸ˆ ì„±ê³µ!", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ ê°€ë™!", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆì„ ì¤‘ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            res = client.models.generate_content(model="gemini-2.0-flash", contents=msg[8:])
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except: pass

    elif cmd == "!ëª…ë ¹ì–´":
        emit('message', {'msg': "ğŸ“œ !ì”ì•¡, !ì €ê¸ˆ [ì•¡ìˆ˜], !ì¶œê¸ˆ [ì•¡ìˆ˜], !ë‡Œì ˆ, !ë‡Œì ˆì¤‘ë‹¨, !gemini [ì§ˆë¬¸]", 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ… ì „ì†¡
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=interest_system, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í´ë”] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "empire_master.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
# ëª¨ë“  í™˜ê²½ í˜¸í™˜ì„ ìœ„í•œ threading ëª¨ë“œ
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {} # ë‡Œì ˆ ìƒíƒœ ì €ì¥ìš©

# Gemini AI (ì„¤ì¹˜ë˜ì–´ ìˆì„ ê²½ìš°ë§Œ)
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key: client = genai.Client(api_key=api_key)
except: pass

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("CREATE TABLE IF NOT EXISTS users (nickname TEXT PRIMARY KEY, money INTEGER DEFAULT 1000, bank_money INTEGER DEFAULT 0)")
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ì‹œìŠ¤í…œ]
def interest_system():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤
        with sqlite3.connect(DB_FILE) as conn:
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()

# --- [3. ë‡Œì ˆ(ë¬´í•œ ë£¨í”„) ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 100
        # ë‡Œì ˆ íŒ¨í„´ ìƒì„±
        pattern = f"[:[{nick}].{m_count}â‚©:] " * 5
        reward = 5000
        update_money(nick, reward, bank=True) # ì€í–‰ìœ¼ë¡œ ë°”ë¡œ ì…ê¸ˆ
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"ğŸŒ€ ë‡Œì ˆ ì‹œìŠ¤í…œ ê°€ë™ ì¤‘... \nğŸ’° ì€í–‰ ì…ê¸ˆ: +{reward}â‚©\n{pattern}", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3) # 3ì´ˆ ê°„ê²© ë‡Œì ˆ

# --- [4. ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ ì²˜ë¦¬] ---
def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [5. ë¼ìš°íŒ… ë° ì†Œì¼“ ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸ“¢ {data['nickname']}ë‹˜ ì œêµ­ ê°•ë¦¼!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ê¸€ì ìˆ˜ ë³´ìƒ ê³µì‹: ê¸°ë³¸ 50ì› + 10ìë‹¹ 20ì›]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    # [ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ íŒŒì¼ ë³€í™˜]
    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ ëŒ€ìš©ëŸ‰ ë°ì´í„°(ê¸€ììˆ˜: {msg_len})ê°€ íŒŒì¼ë¡œ ë³€í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.\nğŸ”— ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ íŒë…]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        emit('message', {'msg': f"ğŸ’° {nick}ë‹˜ ìì‚° | í˜„ê¸ˆ: {user['money']}â‚© | ì€í–‰: {user['bank_money']}â‚© | ë“±ê¸‰: {'ì´ˆì›”ì' if user['money']>1000000 else 'í‰ë¯¼'}", 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt}â‚© ì €ê¸ˆ ì„±ê³µ! (ë§¤ë¶„ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ {amt}â‚© ì¶œê¸ˆ ì„±ê³µ!", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ ê°€ë™!", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆì„ ì¤‘ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            res = client.models.generate_content(model="gemini-2.0-flash", contents=msg[8:])
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except: pass

    elif cmd == "!ëª…ë ¹ì–´":
        emit('message', {'msg': "ğŸ“œ !ì”ì•¡, !ì €ê¸ˆ [ì•¡ìˆ˜], !ì¶œê¸ˆ [ì•¡ìˆ˜], !ë‡Œì ˆ, !ë‡Œì ˆì¤‘ë‹¨, !gemini [ì§ˆë¬¸]", 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ… ì „ì†¡
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=interest_system, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í´ë”] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "empire_master.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
# ëª¨ë“  í™˜ê²½ í˜¸í™˜ì„ ìœ„í•œ threading ëª¨ë“œ
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {} # ë‡Œì ˆ ìƒíƒœ ì €ì¥ìš©

# Gemini AI (ì„¤ì¹˜ë˜ì–´ ìˆì„ ê²½ìš°ë§Œ)
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key: client = genai.Client(api_key=api_key)
except: pass

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("CREATE TABLE IF NOT EXISTS users (nickname TEXT PRIMARY KEY, money INTEGER DEFAULT 1000, bank_money INTEGER DEFAULT 0)")
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ì‹œìŠ¤í…œ]
def interest_system():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤
        with sqlite3.connect(DB_FILE) as conn:
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()

# --- [3. ë‡Œì ˆ(ë¬´í•œ ë£¨í”„) ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 100
        # ë‡Œì ˆ íŒ¨í„´ ìƒì„±
        pattern = f"[:[{nick}].{m_count}â‚©:] " * 5
        reward = 5000
        update_money(nick, reward, bank=True) # ì€í–‰ìœ¼ë¡œ ë°”ë¡œ ì…ê¸ˆ
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"ğŸŒ€ ë‡Œì ˆ ì‹œìŠ¤í…œ ê°€ë™ ì¤‘... \nğŸ’° ì€í–‰ ì…ê¸ˆ: +{reward}â‚©\n{pattern}", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3) # 3ì´ˆ ê°„ê²© ë‡Œì ˆ

# --- [4. ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ ì²˜ë¦¬] ---
def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [5. ë¼ìš°íŒ… ë° ì†Œì¼“ ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸ“¢ {data['nickname']}ë‹˜ ì œêµ­ ê°•ë¦¼!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ê¸€ì ìˆ˜ ë³´ìƒ ê³µì‹: ê¸°ë³¸ 50ì› + 10ìë‹¹ 20ì›]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    # [ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ íŒŒì¼ ë³€í™˜]
    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ ëŒ€ìš©ëŸ‰ ë°ì´í„°(ê¸€ììˆ˜: {msg_len})ê°€ íŒŒì¼ë¡œ ë³€í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.\nğŸ”— ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ íŒë…]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        emit('message', {'msg': f"ğŸ’° {nick}ë‹˜ ìì‚° | í˜„ê¸ˆ: {user['money']}â‚© | ì€í–‰: {user['bank_money']}â‚© | ë“±ê¸‰: {'ì´ˆì›”ì' if user['money']>1000000 else 'í‰ë¯¼'}", 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt}â‚© ì €ê¸ˆ ì„±ê³µ! (ë§¤ë¶„ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ {amt}â‚© ì¶œê¸ˆ ì„±ê³µ!", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ ê°€ë™!", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆì„ ì¤‘ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            res = client.models.generate_content(model="gemini-2.0-flash", contents=msg[8:])
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except: pass

    elif cmd == "!ëª…ë ¹ì–´":
        emit('message', {'msg': "ğŸ“œ !ì”ì•¡, !ì €ê¸ˆ [ì•¡ìˆ˜], !ì¶œê¸ˆ [ì•¡ìˆ˜], !ë‡Œì ˆ, !ë‡Œì ˆì¤‘ë‹¨, !gemini [ì§ˆë¬¸]", 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ… ì „ì†¡
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=interest_system, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í´ë”] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "empire_master.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
# ëª¨ë“  í™˜ê²½ í˜¸í™˜ì„ ìœ„í•œ threading ëª¨ë“œ
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {} # ë‡Œì ˆ ìƒíƒœ ì €ì¥ìš©

# Gemini AI (ì„¤ì¹˜ë˜ì–´ ìˆì„ ê²½ìš°ë§Œ)
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key: client = genai.Client(api_key=api_key)
except: pass

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("CREATE TABLE IF NOT EXISTS users (nickname TEXT PRIMARY KEY, money INTEGER DEFAULT 1000, bank_money INTEGER DEFAULT 0)")
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ì‹œìŠ¤í…œ]
def interest_system():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤
        with sqlite3.connect(DB_FILE) as conn:
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()

# --- [3. ë‡Œì ˆ(ë¬´í•œ ë£¨í”„) ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 100
        # ë‡Œì ˆ íŒ¨í„´ ìƒì„±
        pattern = f"[:[{nick}].{m_count}â‚©:] " * 5
        reward = 5000
        update_money(nick, reward, bank=True) # ì€í–‰ìœ¼ë¡œ ë°”ë¡œ ì…ê¸ˆ
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"ğŸŒ€ ë‡Œì ˆ ì‹œìŠ¤í…œ ê°€ë™ ì¤‘... \nğŸ’° ì€í–‰ ì…ê¸ˆ: +{reward}â‚©\n{pattern}", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3) # 3ì´ˆ ê°„ê²© ë‡Œì ˆ

# --- [4. ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ ì²˜ë¦¬] ---
def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [5. ë¼ìš°íŒ… ë° ì†Œì¼“ ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸ“¢ {data['nickname']}ë‹˜ ì œêµ­ ê°•ë¦¼!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ê¸€ì ìˆ˜ ë³´ìƒ ê³µì‹: ê¸°ë³¸ 50ì› + 10ìë‹¹ 20ì›]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    # [ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ íŒŒì¼ ë³€í™˜]
    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ ëŒ€ìš©ëŸ‰ ë°ì´í„°(ê¸€ììˆ˜: {msg_len})ê°€ íŒŒì¼ë¡œ ë³€í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.\nğŸ”— ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ íŒë…]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        emit('message', {'msg': f"ğŸ’° {nick}ë‹˜ ìì‚° | í˜„ê¸ˆ: {user['money']}â‚© | ì€í–‰: {user['bank_money']}â‚© | ë“±ê¸‰: {'ì´ˆì›”ì' if user['money']>1000000 else 'í‰ë¯¼'}", 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt}â‚© ì €ê¸ˆ ì„±ê³µ! (ë§¤ë¶„ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ {amt}â‚© ì¶œê¸ˆ ì„±ê³µ!", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ ê°€ë™!", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆì„ ì¤‘ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            res = client.models.generate_content(model="gemini-2.0-flash", contents=msg[8:])
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except: pass

    elif cmd == "!ëª…ë ¹ì–´":
        emit('message', {'msg': "ğŸ“œ !ì”ì•¡, !ì €ê¸ˆ [ì•¡ìˆ˜], !ì¶œê¸ˆ [ì•¡ìˆ˜], !ë‡Œì ˆ, !ë‡Œì ˆì¤‘ë‹¨, !gemini [ì§ˆë¬¸]", 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ… ì „ì†¡
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=interest_system, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í´ë”] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "empire_master.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
# ëª¨ë“  í™˜ê²½ í˜¸í™˜ì„ ìœ„í•œ threading ëª¨ë“œ
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {} # ë‡Œì ˆ ìƒíƒœ ì €ì¥ìš©

# Gemini AI (ì„¤ì¹˜ë˜ì–´ ìˆì„ ê²½ìš°ë§Œ)
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key: client = genai.Client(api_key=api_key)
except: pass

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("CREATE TABLE IF NOT EXISTS users (nickname TEXT PRIMARY KEY, money INTEGER DEFAULT 1000, bank_money INTEGER DEFAULT 0)")
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ì‹œìŠ¤í…œ]
def interest_system():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤
        with sqlite3.connect(DB_FILE) as conn:
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()

# --- [3. ë‡Œì ˆ(ë¬´í•œ ë£¨í”„) ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 100
        # ë‡Œì ˆ íŒ¨í„´ ìƒì„±
        pattern = f"[:[{nick}].{m_count}â‚©:] " * 5
        reward = 5000
        update_money(nick, reward, bank=True) # ì€í–‰ìœ¼ë¡œ ë°”ë¡œ ì…ê¸ˆ
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"ğŸŒ€ ë‡Œì ˆ ì‹œìŠ¤í…œ ê°€ë™ ì¤‘... \nğŸ’° ì€í–‰ ì…ê¸ˆ: +{reward}â‚©\n{pattern}", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3) # 3ì´ˆ ê°„ê²© ë‡Œì ˆ

# --- [4. ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ ì²˜ë¦¬] ---
def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [5. ë¼ìš°íŒ… ë° ì†Œì¼“ ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸ“¢ {data['nickname']}ë‹˜ ì œêµ­ ê°•ë¦¼!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ê¸€ì ìˆ˜ ë³´ìƒ ê³µì‹: ê¸°ë³¸ 50ì› + 10ìë‹¹ 20ì›]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    # [ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ íŒŒì¼ ë³€í™˜]
    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ ëŒ€ìš©ëŸ‰ ë°ì´í„°(ê¸€ììˆ˜: {msg_len})ê°€ íŒŒì¼ë¡œ ë³€í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.\nğŸ”— ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ íŒë…]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        emit('message', {'msg': f"ğŸ’° {nick}ë‹˜ ìì‚° | í˜„ê¸ˆ: {user['money']}â‚© | ì€í–‰: {user['bank_money']}â‚© | ë“±ê¸‰: {'ì´ˆì›”ì' if user['money']>1000000 else 'í‰ë¯¼'}", 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt}â‚© ì €ê¸ˆ ì„±ê³µ! (ë§¤ë¶„ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ {amt}â‚© ì¶œê¸ˆ ì„±ê³µ!", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ ê°€ë™!", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆì„ ì¤‘ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            res = client.models.generate_content(model="gemini-2.0-flash", contents=msg[8:])
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except: pass

    elif cmd == "!ëª…ë ¹ì–´":
        emit('message', {'msg': "ğŸ“œ !ì”ì•¡, !ì €ê¸ˆ [ì•¡ìˆ˜], !ì¶œê¸ˆ [ì•¡ìˆ˜], !ë‡Œì ˆ, !ë‡Œì ˆì¤‘ë‹¨, !gemini [ì§ˆë¬¸]", 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ… ì „ì†¡
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=interest_system, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í´ë”] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "empire_master.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
# ëª¨ë“  í™˜ê²½ í˜¸í™˜ì„ ìœ„í•œ threading ëª¨ë“œ
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {} # ë‡Œì ˆ ìƒíƒœ ì €ì¥ìš©

# Gemini AI (ì„¤ì¹˜ë˜ì–´ ìˆì„ ê²½ìš°ë§Œ)
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key: client = genai.Client(api_key=api_key)
except: pass

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("CREATE TABLE IF NOT EXISTS users (nickname TEXT PRIMARY KEY, money INTEGER DEFAULT 1000, bank_money INTEGER DEFAULT 0)")
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ì‹œìŠ¤í…œ]
def interest_system():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤
        with sqlite3.connect(DB_FILE) as conn:
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()

# --- [3. ë‡Œì ˆ(ë¬´í•œ ë£¨í”„) ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 100
        # ë‡Œì ˆ íŒ¨í„´ ìƒì„±
        pattern = f"[:[{nick}].{m_count}â‚©:] " * 5
        reward = 5000
        update_money(nick, reward, bank=True) # ì€í–‰ìœ¼ë¡œ ë°”ë¡œ ì…ê¸ˆ
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"ğŸŒ€ ë‡Œì ˆ ì‹œìŠ¤í…œ ê°€ë™ ì¤‘... \nğŸ’° ì€í–‰ ì…ê¸ˆ: +{reward}â‚©\n{pattern}", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3) # 3ì´ˆ ê°„ê²© ë‡Œì ˆ

# --- [4. ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ ì²˜ë¦¬] ---
def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [5. ë¼ìš°íŒ… ë° ì†Œì¼“ ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸ“¢ {data['nickname']}ë‹˜ ì œêµ­ ê°•ë¦¼!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ê¸€ì ìˆ˜ ë³´ìƒ ê³µì‹: ê¸°ë³¸ 50ì› + 10ìë‹¹ 20ì›]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    # [ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ íŒŒì¼ ë³€í™˜]
    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ ëŒ€ìš©ëŸ‰ ë°ì´í„°(ê¸€ììˆ˜: {msg_len})ê°€ íŒŒì¼ë¡œ ë³€í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.\nğŸ”— ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ íŒë…]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        emit('message', {'msg': f"ğŸ’° {nick}ë‹˜ ìì‚° | í˜„ê¸ˆ: {user['money']}â‚© | ì€í–‰: {user['bank_money']}â‚© | ë“±ê¸‰: {'ì´ˆì›”ì' if user['money']>1000000 else 'í‰ë¯¼'}", 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt}â‚© ì €ê¸ˆ ì„±ê³µ! (ë§¤ë¶„ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ {amt}â‚© ì¶œê¸ˆ ì„±ê³µ!", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ ê°€ë™!", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆì„ ì¤‘ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            res = client.models.generate_content(model="gemini-2.0-flash", contents=msg[8:])
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except: pass

    elif cmd == "!ëª…ë ¹ì–´":
        emit('message', {'msg': "ğŸ“œ !ì”ì•¡, !ì €ê¸ˆ [ì•¡ìˆ˜], !ì¶œê¸ˆ [ì•¡ìˆ˜], !ë‡Œì ˆ, !ë‡Œì ˆì¤‘ë‹¨, !gemini [ì§ˆë¬¸]", 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ… ì „ì†¡
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=interest_system, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í´ë”] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "empire_master.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
# ëª¨ë“  í™˜ê²½ í˜¸í™˜ì„ ìœ„í•œ threading ëª¨ë“œ
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {} # ë‡Œì ˆ ìƒíƒœ ì €ì¥ìš©

# Gemini AI (ì„¤ì¹˜ë˜ì–´ ìˆì„ ê²½ìš°ë§Œ)
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key: client = genai.Client(api_key=api_key)
except: pass

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("CREATE TABLE IF NOT EXISTS users (nickname TEXT PRIMARY KEY, money INTEGER DEFAULT 1000, bank_money INTEGER DEFAULT 0)")
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ì‹œìŠ¤í…œ]
def interest_system():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤
        with sqlite3.connect(DB_FILE) as conn:
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()

# --- [3. ë‡Œì ˆ(ë¬´í•œ ë£¨í”„) ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 100
        # ë‡Œì ˆ íŒ¨í„´ ìƒì„±
        pattern = f"[:[{nick}].{m_count}â‚©:] " * 5
        reward = 5000
        update_money(nick, reward, bank=True) # ì€í–‰ìœ¼ë¡œ ë°”ë¡œ ì…ê¸ˆ
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"ğŸŒ€ ë‡Œì ˆ ì‹œìŠ¤í…œ ê°€ë™ ì¤‘... \nğŸ’° ì€í–‰ ì…ê¸ˆ: +{reward}â‚©\n{pattern}", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3) # 3ì´ˆ ê°„ê²© ë‡Œì ˆ

# --- [4. ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ ì²˜ë¦¬] ---
def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [5. ë¼ìš°íŒ… ë° ì†Œì¼“ ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸ“¢ {data['nickname']}ë‹˜ ì œêµ­ ê°•ë¦¼!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ê¸€ì ìˆ˜ ë³´ìƒ ê³µì‹: ê¸°ë³¸ 50ì› + 10ìë‹¹ 20ì›]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    # [ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ íŒŒì¼ ë³€í™˜]
    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ ëŒ€ìš©ëŸ‰ ë°ì´í„°(ê¸€ììˆ˜: {msg_len})ê°€ íŒŒì¼ë¡œ ë³€í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.\nğŸ”— ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ íŒë…]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        emit('message', {'msg': f"ğŸ’° {nick}ë‹˜ ìì‚° | í˜„ê¸ˆ: {user['money']}â‚© | ì€í–‰: {user['bank_money']}â‚© | ë“±ê¸‰: {'ì´ˆì›”ì' if user['money']>1000000 else 'í‰ë¯¼'}", 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt}â‚© ì €ê¸ˆ ì„±ê³µ! (ë§¤ë¶„ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ {amt}â‚© ì¶œê¸ˆ ì„±ê³µ!", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ ê°€ë™!", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆì„ ì¤‘ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            res = client.models.generate_content(model="gemini-2.0-flash", contents=msg[8:])
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except: pass

    elif cmd == "!ëª…ë ¹ì–´":
        emit('message', {'msg': "ğŸ“œ !ì”ì•¡, !ì €ê¸ˆ [ì•¡ìˆ˜], !ì¶œê¸ˆ [ì•¡ìˆ˜], !ë‡Œì ˆ, !ë‡Œì ˆì¤‘ë‹¨, !gemini [ì§ˆë¬¸]", 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ… ì „ì†¡
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=interest_system, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í´ë”] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "empire_master.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
# ëª¨ë“  í™˜ê²½ í˜¸í™˜ì„ ìœ„í•œ threading ëª¨ë“œ
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {} # ë‡Œì ˆ ìƒíƒœ ì €ì¥ìš©

# Gemini AI (ì„¤ì¹˜ë˜ì–´ ìˆì„ ê²½ìš°ë§Œ)
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key: client = genai.Client(api_key=api_key)
except: pass

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("CREATE TABLE IF NOT EXISTS users (nickname TEXT PRIMARY KEY, money INTEGER DEFAULT 1000, bank_money INTEGER DEFAULT 0)")
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ì‹œìŠ¤í…œ]
def interest_system():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤
        with sqlite3.connect(DB_FILE) as conn:
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()

# --- [3. ë‡Œì ˆ(ë¬´í•œ ë£¨í”„) ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 100
        # ë‡Œì ˆ íŒ¨í„´ ìƒì„±
        pattern = f"[:[{nick}].{m_count}â‚©:] " * 5
        reward = 5000
        update_money(nick, reward, bank=True) # ì€í–‰ìœ¼ë¡œ ë°”ë¡œ ì…ê¸ˆ
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"ğŸŒ€ ë‡Œì ˆ ì‹œìŠ¤í…œ ê°€ë™ ì¤‘... \nğŸ’° ì€í–‰ ì…ê¸ˆ: +{reward}â‚©\n{pattern}", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3) # 3ì´ˆ ê°„ê²© ë‡Œì ˆ

# --- [4. ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ ì²˜ë¦¬] ---
def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [5. ë¼ìš°íŒ… ë° ì†Œì¼“ ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸ“¢ {data['nickname']}ë‹˜ ì œêµ­ ê°•ë¦¼!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ê¸€ì ìˆ˜ ë³´ìƒ ê³µì‹: ê¸°ë³¸ 50ì› + 10ìë‹¹ 20ì›]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    # [ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ íŒŒì¼ ë³€í™˜]
    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ ëŒ€ìš©ëŸ‰ ë°ì´í„°(ê¸€ììˆ˜: {msg_len})ê°€ íŒŒì¼ë¡œ ë³€í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.\nğŸ”— ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ íŒë…]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        emit('message', {'msg': f"ğŸ’° {nick}ë‹˜ ìì‚° | í˜„ê¸ˆ: {user['money']}â‚© | ì€í–‰: {user['bank_money']}â‚© | ë“±ê¸‰: {'ì´ˆì›”ì' if user['money']>1000000 else 'í‰ë¯¼'}", 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt}â‚© ì €ê¸ˆ ì„±ê³µ! (ë§¤ë¶„ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ {amt}â‚© ì¶œê¸ˆ ì„±ê³µ!", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ ê°€ë™!", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆì„ ì¤‘ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            res = client.models.generate_content(model="gemini-2.0-flash", contents=msg[8:])
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except: pass

    elif cmd == "!ëª…ë ¹ì–´":
        emit('message', {'msg': "ğŸ“œ !ì”ì•¡, !ì €ê¸ˆ [ì•¡ìˆ˜], !ì¶œê¸ˆ [ì•¡ìˆ˜], !ë‡Œì ˆ, !ë‡Œì ˆì¤‘ë‹¨, !gemini [ì§ˆë¬¸]", 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ… ì „ì†¡
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=interest_system, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í´ë”] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "empire_master.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
# ëª¨ë“  í™˜ê²½ í˜¸í™˜ì„ ìœ„í•œ threading ëª¨ë“œ
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {} # ë‡Œì ˆ ìƒíƒœ ì €ì¥ìš©

# Gemini AI (ì„¤ì¹˜ë˜ì–´ ìˆì„ ê²½ìš°ë§Œ)
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key: client = genai.Client(api_key=api_key)
except: pass

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("CREATE TABLE IF NOT EXISTS users (nickname TEXT PRIMARY KEY, money INTEGER DEFAULT 1000, bank_money INTEGER DEFAULT 0)")
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ì‹œìŠ¤í…œ]
def interest_system():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤
        with sqlite3.connect(DB_FILE) as conn:
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()

# --- [3. ë‡Œì ˆ(ë¬´í•œ ë£¨í”„) ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 100
        # ë‡Œì ˆ íŒ¨í„´ ìƒì„±
        pattern = f"[:[{nick}].{m_count}â‚©:] " * 5
        reward = 5000
        update_money(nick, reward, bank=True) # ì€í–‰ìœ¼ë¡œ ë°”ë¡œ ì…ê¸ˆ
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"ğŸŒ€ ë‡Œì ˆ ì‹œìŠ¤í…œ ê°€ë™ ì¤‘... \nğŸ’° ì€í–‰ ì…ê¸ˆ: +{reward}â‚©\n{pattern}", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3) # 3ì´ˆ ê°„ê²© ë‡Œì ˆ

# --- [4. ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ ì²˜ë¦¬] ---
def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [5. ë¼ìš°íŒ… ë° ì†Œì¼“ ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸ“¢ {data['nickname']}ë‹˜ ì œêµ­ ê°•ë¦¼!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ê¸€ì ìˆ˜ ë³´ìƒ ê³µì‹: ê¸°ë³¸ 50ì› + 10ìë‹¹ 20ì›]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    # [ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ íŒŒì¼ ë³€í™˜]
    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ ëŒ€ìš©ëŸ‰ ë°ì´í„°(ê¸€ììˆ˜: {msg_len})ê°€ íŒŒì¼ë¡œ ë³€í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.\nğŸ”— ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ íŒë…]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        emit('message', {'msg': f"ğŸ’° {nick}ë‹˜ ìì‚° | í˜„ê¸ˆ: {user['money']}â‚© | ì€í–‰: {user['bank_money']}â‚© | ë“±ê¸‰: {'ì´ˆì›”ì' if user['money']>1000000 else 'í‰ë¯¼'}", 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt}â‚© ì €ê¸ˆ ì„±ê³µ! (ë§¤ë¶„ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ {amt}â‚© ì¶œê¸ˆ ì„±ê³µ!", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ ê°€ë™!", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆì„ ì¤‘ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            res = client.models.generate_content(model="gemini-2.0-flash", contents=msg[8:])
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except: pass

    elif cmd == "!ëª…ë ¹ì–´":
        emit('message', {'msg': "ğŸ“œ !ì”ì•¡, !ì €ê¸ˆ [ì•¡ìˆ˜], !ì¶œê¸ˆ [ì•¡ìˆ˜], !ë‡Œì ˆ, !ë‡Œì ˆì¤‘ë‹¨, !gemini [ì§ˆë¬¸]", 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ… ì „ì†¡
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=interest_system, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í´ë”] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "empire_master.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
# ëª¨ë“  í™˜ê²½ í˜¸í™˜ì„ ìœ„í•œ threading ëª¨ë“œ
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {} # ë‡Œì ˆ ìƒíƒœ ì €ì¥ìš©

# Gemini AI (ì„¤ì¹˜ë˜ì–´ ìˆì„ ê²½ìš°ë§Œ)
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key: client = genai.Client(api_key=api_key)
except: pass

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("CREATE TABLE IF NOT EXISTS users (nickname TEXT PRIMARY KEY, money INTEGER DEFAULT 1000, bank_money INTEGER DEFAULT 0)")
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ì‹œìŠ¤í…œ]
def interest_system():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤
        with sqlite3.connect(DB_FILE) as conn:
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()

# --- [3. ë‡Œì ˆ(ë¬´í•œ ë£¨í”„) ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 100
        # ë‡Œì ˆ íŒ¨í„´ ìƒì„±
        pattern = f"[:[{nick}].{m_count}â‚©:] " * 5
        reward = 5000
        update_money(nick, reward, bank=True) # ì€í–‰ìœ¼ë¡œ ë°”ë¡œ ì…ê¸ˆ
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"ğŸŒ€ ë‡Œì ˆ ì‹œìŠ¤í…œ ê°€ë™ ì¤‘... \nğŸ’° ì€í–‰ ì…ê¸ˆ: +{reward}â‚©\n{pattern}", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3) # 3ì´ˆ ê°„ê²© ë‡Œì ˆ

# --- [4. ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ ì²˜ë¦¬] ---
def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [5. ë¼ìš°íŒ… ë° ì†Œì¼“ ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸ“¢ {data['nickname']}ë‹˜ ì œêµ­ ê°•ë¦¼!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ê¸€ì ìˆ˜ ë³´ìƒ ê³µì‹: ê¸°ë³¸ 50ì› + 10ìë‹¹ 20ì›]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    # [ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ íŒŒì¼ ë³€í™˜]
    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ ëŒ€ìš©ëŸ‰ ë°ì´í„°(ê¸€ììˆ˜: {msg_len})ê°€ íŒŒì¼ë¡œ ë³€í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.\nğŸ”— ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ íŒë…]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        emit('message', {'msg': f"ğŸ’° {nick}ë‹˜ ìì‚° | í˜„ê¸ˆ: {user['money']}â‚© | ì€í–‰: {user['bank_money']}â‚© | ë“±ê¸‰: {'ì´ˆì›”ì' if user['money']>1000000 else 'í‰ë¯¼'}", 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt}â‚© ì €ê¸ˆ ì„±ê³µ! (ë§¤ë¶„ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ {amt}â‚© ì¶œê¸ˆ ì„±ê³µ!", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ ê°€ë™!", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆì„ ì¤‘ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            res = client.models.generate_content(model="gemini-2.0-flash", contents=msg[8:])
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except: pass

    elif cmd == "!ëª…ë ¹ì–´":
        emit('message', {'msg': "ğŸ“œ !ì”ì•¡, !ì €ê¸ˆ [ì•¡ìˆ˜], !ì¶œê¸ˆ [ì•¡ìˆ˜], !ë‡Œì ˆ, !ë‡Œì ˆì¤‘ë‹¨, !gemini [ì§ˆë¬¸]", 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ… ì „ì†¡
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=interest_system, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í´ë”] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "empire_master.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
# ëª¨ë“  í™˜ê²½ í˜¸í™˜ì„ ìœ„í•œ threading ëª¨ë“œ
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {} # ë‡Œì ˆ ìƒíƒœ ì €ì¥ìš©

# Gemini AI (ì„¤ì¹˜ë˜ì–´ ìˆì„ ê²½ìš°ë§Œ)
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key: client = genai.Client(api_key=api_key)
except: pass

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("CREATE TABLE IF NOT EXISTS users (nickname TEXT PRIMARY KEY, money INTEGER DEFAULT 1000, bank_money INTEGER DEFAULT 0)")
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ì‹œìŠ¤í…œ]
def interest_system():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤
        with sqlite3.connect(DB_FILE) as conn:
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()

# --- [3. ë‡Œì ˆ(ë¬´í•œ ë£¨í”„) ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 100
        # ë‡Œì ˆ íŒ¨í„´ ìƒì„±
        pattern = f"[:[{nick}].{m_count}â‚©:] " * 5
        reward = 5000
        update_money(nick, reward, bank=True) # ì€í–‰ìœ¼ë¡œ ë°”ë¡œ ì…ê¸ˆ
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"ğŸŒ€ ë‡Œì ˆ ì‹œìŠ¤í…œ ê°€ë™ ì¤‘... \nğŸ’° ì€í–‰ ì…ê¸ˆ: +{reward}â‚©\n{pattern}", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3) # 3ì´ˆ ê°„ê²© ë‡Œì ˆ

# --- [4. ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ ì²˜ë¦¬] ---
def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [5. ë¼ìš°íŒ… ë° ì†Œì¼“ ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸ“¢ {data['nickname']}ë‹˜ ì œêµ­ ê°•ë¦¼!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ê¸€ì ìˆ˜ ë³´ìƒ ê³µì‹: ê¸°ë³¸ 50ì› + 10ìë‹¹ 20ì›]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    # [ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ íŒŒì¼ ë³€í™˜]
    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ ëŒ€ìš©ëŸ‰ ë°ì´í„°(ê¸€ììˆ˜: {msg_len})ê°€ íŒŒì¼ë¡œ ë³€í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.\nğŸ”— ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ íŒë…]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        emit('message', {'msg': f"ğŸ’° {nick}ë‹˜ ìì‚° | í˜„ê¸ˆ: {user['money']}â‚© | ì€í–‰: {user['bank_money']}â‚© | ë“±ê¸‰: {'ì´ˆì›”ì' if user['money']>1000000 else 'í‰ë¯¼'}", 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt}â‚© ì €ê¸ˆ ì„±ê³µ! (ë§¤ë¶„ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ {amt}â‚© ì¶œê¸ˆ ì„±ê³µ!", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ ê°€ë™!", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆì„ ì¤‘ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            res = client.models.generate_content(model="gemini-2.0-flash", contents=msg[8:])
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except: pass

    elif cmd == "!ëª…ë ¹ì–´":
        emit('message', {'msg': "ğŸ“œ !ì”ì•¡, !ì €ê¸ˆ [ì•¡ìˆ˜], !ì¶œê¸ˆ [ì•¡ìˆ˜], !ë‡Œì ˆ, !ë‡Œì ˆì¤‘ë‹¨, !gemini [ì§ˆë¬¸]", 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ… ì „ì†¡
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=interest_system, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í´ë”] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "empire_master.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
# ëª¨ë“  í™˜ê²½ í˜¸í™˜ì„ ìœ„í•œ threading ëª¨ë“œ
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {} # ë‡Œì ˆ ìƒíƒœ ì €ì¥ìš©

# Gemini AI (ì„¤ì¹˜ë˜ì–´ ìˆì„ ê²½ìš°ë§Œ)
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key: client = genai.Client(api_key=api_key)
except: pass

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("CREATE TABLE IF NOT EXISTS users (nickname TEXT PRIMARY KEY, money INTEGER DEFAULT 1000, bank_money INTEGER DEFAULT 0)")
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ì‹œìŠ¤í…œ]
def interest_system():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤
        with sqlite3.connect(DB_FILE) as conn:
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()

# --- [3. ë‡Œì ˆ(ë¬´í•œ ë£¨í”„) ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 100
        # ë‡Œì ˆ íŒ¨í„´ ìƒì„±
        pattern = f"[:[{nick}].{m_count}â‚©:] " * 5
        reward = 5000
        update_money(nick, reward, bank=True) # ì€í–‰ìœ¼ë¡œ ë°”ë¡œ ì…ê¸ˆ
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"ğŸŒ€ ë‡Œì ˆ ì‹œìŠ¤í…œ ê°€ë™ ì¤‘... \nğŸ’° ì€í–‰ ì…ê¸ˆ: +{reward}â‚©\n{pattern}", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3) # 3ì´ˆ ê°„ê²© ë‡Œì ˆ

# --- [4. ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ ì²˜ë¦¬] ---
def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [5. ë¼ìš°íŒ… ë° ì†Œì¼“ ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸ“¢ {data['nickname']}ë‹˜ ì œêµ­ ê°•ë¦¼!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ê¸€ì ìˆ˜ ë³´ìƒ ê³µì‹: ê¸°ë³¸ 50ì› + 10ìë‹¹ 20ì›]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    # [ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ íŒŒì¼ ë³€í™˜]
    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ ëŒ€ìš©ëŸ‰ ë°ì´í„°(ê¸€ììˆ˜: {msg_len})ê°€ íŒŒì¼ë¡œ ë³€í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.\nğŸ”— ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ íŒë…]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        emit('message', {'msg': f"ğŸ’° {nick}ë‹˜ ìì‚° | í˜„ê¸ˆ: {user['money']}â‚© | ì€í–‰: {user['bank_money']}â‚© | ë“±ê¸‰: {'ì´ˆì›”ì' if user['money']>1000000 else 'í‰ë¯¼'}", 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt}â‚© ì €ê¸ˆ ì„±ê³µ! (ë§¤ë¶„ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ {amt}â‚© ì¶œê¸ˆ ì„±ê³µ!", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ ê°€ë™!", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆì„ ì¤‘ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            res = client.models.generate_content(model="gemini-2.0-flash", contents=msg[8:])
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except: pass

    elif cmd == "!ëª…ë ¹ì–´":
        emit('message', {'msg': "ğŸ“œ !ì”ì•¡, !ì €ê¸ˆ [ì•¡ìˆ˜], !ì¶œê¸ˆ [ì•¡ìˆ˜], !ë‡Œì ˆ, !ë‡Œì ˆì¤‘ë‹¨, !gemini [ì§ˆë¬¸]", 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ… ì „ì†¡
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=interest_system, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í´ë”] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "empire_master.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
# ëª¨ë“  í™˜ê²½ í˜¸í™˜ì„ ìœ„í•œ threading ëª¨ë“œ
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {} # ë‡Œì ˆ ìƒíƒœ ì €ì¥ìš©

# Gemini AI (ì„¤ì¹˜ë˜ì–´ ìˆì„ ê²½ìš°ë§Œ)
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key: client = genai.Client(api_key=api_key)
except: pass

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("CREATE TABLE IF NOT EXISTS users (nickname TEXT PRIMARY KEY, money INTEGER DEFAULT 1000, bank_money INTEGER DEFAULT 0)")
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ì‹œìŠ¤í…œ]
def interest_system():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤
        with sqlite3.connect(DB_FILE) as conn:
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()

# --- [3. ë‡Œì ˆ(ë¬´í•œ ë£¨í”„) ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 100
        # ë‡Œì ˆ íŒ¨í„´ ìƒì„±
        pattern = f"[:[{nick}].{m_count}â‚©:] " * 5
        reward = 5000
        update_money(nick, reward, bank=True) # ì€í–‰ìœ¼ë¡œ ë°”ë¡œ ì…ê¸ˆ
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"ğŸŒ€ ë‡Œì ˆ ì‹œìŠ¤í…œ ê°€ë™ ì¤‘... \nğŸ’° ì€í–‰ ì…ê¸ˆ: +{reward}â‚©\n{pattern}", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3) # 3ì´ˆ ê°„ê²© ë‡Œì ˆ

# --- [4. ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ ì²˜ë¦¬] ---
def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [5. ë¼ìš°íŒ… ë° ì†Œì¼“ ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸ“¢ {data['nickname']}ë‹˜ ì œêµ­ ê°•ë¦¼!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ê¸€ì ìˆ˜ ë³´ìƒ ê³µì‹: ê¸°ë³¸ 50ì› + 10ìë‹¹ 20ì›]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    # [ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ íŒŒì¼ ë³€í™˜]
    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ ëŒ€ìš©ëŸ‰ ë°ì´í„°(ê¸€ììˆ˜: {msg_len})ê°€ íŒŒì¼ë¡œ ë³€í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.\nğŸ”— ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ íŒë…]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        emit('message', {'msg': f"ğŸ’° {nick}ë‹˜ ìì‚° | í˜„ê¸ˆ: {user['money']}â‚© | ì€í–‰: {user['bank_money']}â‚© | ë“±ê¸‰: {'ì´ˆì›”ì' if user['money']>1000000 else 'í‰ë¯¼'}", 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt}â‚© ì €ê¸ˆ ì„±ê³µ! (ë§¤ë¶„ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ {amt}â‚© ì¶œê¸ˆ ì„±ê³µ!", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ ê°€ë™!", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆì„ ì¤‘ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            res = client.models.generate_content(model="gemini-2.0-flash", contents=msg[8:])
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except: pass

    elif cmd == "!ëª…ë ¹ì–´":
        emit('message', {'msg': "ğŸ“œ !ì”ì•¡, !ì €ê¸ˆ [ì•¡ìˆ˜], !ì¶œê¸ˆ [ì•¡ìˆ˜], !ë‡Œì ˆ, !ë‡Œì ˆì¤‘ë‹¨, !gemini [ì§ˆë¬¸]", 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ… ì „ì†¡
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=interest_system, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í´ë”] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "empire_master.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
# ëª¨ë“  í™˜ê²½ í˜¸í™˜ì„ ìœ„í•œ threading ëª¨ë“œ
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {} # ë‡Œì ˆ ìƒíƒœ ì €ì¥ìš©

# Gemini AI (ì„¤ì¹˜ë˜ì–´ ìˆì„ ê²½ìš°ë§Œ)
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key: client = genai.Client(api_key=api_key)
except: pass

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("CREATE TABLE IF NOT EXISTS users (nickname TEXT PRIMARY KEY, money INTEGER DEFAULT 1000, bank_money INTEGER DEFAULT 0)")
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ì‹œìŠ¤í…œ]
def interest_system():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤
        with sqlite3.connect(DB_FILE) as conn:
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()

# --- [3. ë‡Œì ˆ(ë¬´í•œ ë£¨í”„) ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 100
        # ë‡Œì ˆ íŒ¨í„´ ìƒì„±
        pattern = f"[:[{nick}].{m_count}â‚©:] " * 5
        reward = 5000
        update_money(nick, reward, bank=True) # ì€í–‰ìœ¼ë¡œ ë°”ë¡œ ì…ê¸ˆ
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"ğŸŒ€ ë‡Œì ˆ ì‹œìŠ¤í…œ ê°€ë™ ì¤‘... \nğŸ’° ì€í–‰ ì…ê¸ˆ: +{reward}â‚©\n{pattern}", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3) # 3ì´ˆ ê°„ê²© ë‡Œì ˆ

# --- [4. ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ ì²˜ë¦¬] ---
def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [5. ë¼ìš°íŒ… ë° ì†Œì¼“ ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸ“¢ {data['nickname']}ë‹˜ ì œêµ­ ê°•ë¦¼!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ê¸€ì ìˆ˜ ë³´ìƒ ê³µì‹: ê¸°ë³¸ 50ì› + 10ìë‹¹ 20ì›]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    # [ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ íŒŒì¼ ë³€í™˜]
    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ ëŒ€ìš©ëŸ‰ ë°ì´í„°(ê¸€ììˆ˜: {msg_len})ê°€ íŒŒì¼ë¡œ ë³€í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.\nğŸ”— ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ íŒë…]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        emit('message', {'msg': f"ğŸ’° {nick}ë‹˜ ìì‚° | í˜„ê¸ˆ: {user['money']}â‚© | ì€í–‰: {user['bank_money']}â‚© | ë“±ê¸‰: {'ì´ˆì›”ì' if user['money']>1000000 else 'í‰ë¯¼'}", 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt}â‚© ì €ê¸ˆ ì„±ê³µ! (ë§¤ë¶„ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ {amt}â‚© ì¶œê¸ˆ ì„±ê³µ!", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ ê°€ë™!", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆì„ ì¤‘ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            res = client.models.generate_content(model="gemini-2.0-flash", contents=msg[8:])
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except: pass

    elif cmd == "!ëª…ë ¹ì–´":
        emit('message', {'msg': "ğŸ“œ !ì”ì•¡, !ì €ê¸ˆ [ì•¡ìˆ˜], !ì¶œê¸ˆ [ì•¡ìˆ˜], !ë‡Œì ˆ, !ë‡Œì ˆì¤‘ë‹¨, !gemini [ì§ˆë¬¸]", 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ… ì „ì†¡
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=interest_system, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í´ë”] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "empire_master.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
# ëª¨ë“  í™˜ê²½ í˜¸í™˜ì„ ìœ„í•œ threading ëª¨ë“œ
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {} # ë‡Œì ˆ ìƒíƒœ ì €ì¥ìš©

# Gemini AI (ì„¤ì¹˜ë˜ì–´ ìˆì„ ê²½ìš°ë§Œ)
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key: client = genai.Client(api_key=api_key)
except: pass

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("CREATE TABLE IF NOT EXISTS users (nickname TEXT PRIMARY KEY, money INTEGER DEFAULT 1000, bank_money INTEGER DEFAULT 0)")
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ì‹œìŠ¤í…œ]
def interest_system():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤
        with sqlite3.connect(DB_FILE) as conn:
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()

# --- [3. ë‡Œì ˆ(ë¬´í•œ ë£¨í”„) ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 100
        # ë‡Œì ˆ íŒ¨í„´ ìƒì„±
        pattern = f"[:[{nick}].{m_count}â‚©:] " * 5
        reward = 5000
        update_money(nick, reward, bank=True) # ì€í–‰ìœ¼ë¡œ ë°”ë¡œ ì…ê¸ˆ
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"ğŸŒ€ ë‡Œì ˆ ì‹œìŠ¤í…œ ê°€ë™ ì¤‘... \nğŸ’° ì€í–‰ ì…ê¸ˆ: +{reward}â‚©\n{pattern}", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3) # 3ì´ˆ ê°„ê²© ë‡Œì ˆ

# --- [4. ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ ì²˜ë¦¬] ---
def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [5. ë¼ìš°íŒ… ë° ì†Œì¼“ ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸ“¢ {data['nickname']}ë‹˜ ì œêµ­ ê°•ë¦¼!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ê¸€ì ìˆ˜ ë³´ìƒ ê³µì‹: ê¸°ë³¸ 50ì› + 10ìë‹¹ 20ì›]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    # [ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ íŒŒì¼ ë³€í™˜]
    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ ëŒ€ìš©ëŸ‰ ë°ì´í„°(ê¸€ììˆ˜: {msg_len})ê°€ íŒŒì¼ë¡œ ë³€í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.\nğŸ”— ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ íŒë…]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        emit('message', {'msg': f"ğŸ’° {nick}ë‹˜ ìì‚° | í˜„ê¸ˆ: {user['money']}â‚© | ì€í–‰: {user['bank_money']}â‚© | ë“±ê¸‰: {'ì´ˆì›”ì' if user['money']>1000000 else 'í‰ë¯¼'}", 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt}â‚© ì €ê¸ˆ ì„±ê³µ! (ë§¤ë¶„ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ {amt}â‚© ì¶œê¸ˆ ì„±ê³µ!", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ ê°€ë™!", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆì„ ì¤‘ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            res = client.models.generate_content(model="gemini-2.0-flash", contents=msg[8:])
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except: pass

    elif cmd == "!ëª…ë ¹ì–´":
        emit('message', {'msg': "ğŸ“œ !ì”ì•¡, !ì €ê¸ˆ [ì•¡ìˆ˜], !ì¶œê¸ˆ [ì•¡ìˆ˜], !ë‡Œì ˆ, !ë‡Œì ˆì¤‘ë‹¨, !gemini [ì§ˆë¬¸]", 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ… ì „ì†¡
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=interest_system, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í´ë”] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "empire_master.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
# ëª¨ë“  í™˜ê²½ í˜¸í™˜ì„ ìœ„í•œ threading ëª¨ë“œ
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {} # ë‡Œì ˆ ìƒíƒœ ì €ì¥ìš©

# Gemini AI (ì„¤ì¹˜ë˜ì–´ ìˆì„ ê²½ìš°ë§Œ)
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key: client = genai.Client(api_key=api_key)
except: pass

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("CREATE TABLE IF NOT EXISTS users (nickname TEXT PRIMARY KEY, money INTEGER DEFAULT 1000, bank_money INTEGER DEFAULT 0)")
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ì‹œìŠ¤í…œ]
def interest_system():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤
        with sqlite3.connect(DB_FILE) as conn:
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()

# --- [3. ë‡Œì ˆ(ë¬´í•œ ë£¨í”„) ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 100
        # ë‡Œì ˆ íŒ¨í„´ ìƒì„±
        pattern = f"[:[{nick}].{m_count}â‚©:] " * 5
        reward = 5000
        update_money(nick, reward, bank=True) # ì€í–‰ìœ¼ë¡œ ë°”ë¡œ ì…ê¸ˆ
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"ğŸŒ€ ë‡Œì ˆ ì‹œìŠ¤í…œ ê°€ë™ ì¤‘... \nğŸ’° ì€í–‰ ì…ê¸ˆ: +{reward}â‚©\n{pattern}", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3) # 3ì´ˆ ê°„ê²© ë‡Œì ˆ

# --- [4. ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ ì²˜ë¦¬] ---
def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [5. ë¼ìš°íŒ… ë° ì†Œì¼“ ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸ“¢ {data['nickname']}ë‹˜ ì œêµ­ ê°•ë¦¼!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ê¸€ì ìˆ˜ ë³´ìƒ ê³µì‹: ê¸°ë³¸ 50ì› + 10ìë‹¹ 20ì›]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    # [ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ íŒŒì¼ ë³€í™˜]
    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ ëŒ€ìš©ëŸ‰ ë°ì´í„°(ê¸€ììˆ˜: {msg_len})ê°€ íŒŒì¼ë¡œ ë³€í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.\nğŸ”— ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ íŒë…]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        emit('message', {'msg': f"ğŸ’° {nick}ë‹˜ ìì‚° | í˜„ê¸ˆ: {user['money']}â‚© | ì€í–‰: {user['bank_money']}â‚© | ë“±ê¸‰: {'ì´ˆì›”ì' if user['money']>1000000 else 'í‰ë¯¼'}", 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt}â‚© ì €ê¸ˆ ì„±ê³µ! (ë§¤ë¶„ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ {amt}â‚© ì¶œê¸ˆ ì„±ê³µ!", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ ê°€ë™!", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆì„ ì¤‘ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            res = client.models.generate_content(model="gemini-2.0-flash", contents=msg[8:])
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except: pass

    elif cmd == "!ëª…ë ¹ì–´":
        emit('message', {'msg': "ğŸ“œ !ì”ì•¡, !ì €ê¸ˆ [ì•¡ìˆ˜], !ì¶œê¸ˆ [ì•¡ìˆ˜], !ë‡Œì ˆ, !ë‡Œì ˆì¤‘ë‹¨, !gemini [ì§ˆë¬¸]", 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ… ì „ì†¡
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=interest_system, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í´ë”] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "empire_master.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
# ëª¨ë“  í™˜ê²½ í˜¸í™˜ì„ ìœ„í•œ threading ëª¨ë“œ
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {} # ë‡Œì ˆ ìƒíƒœ ì €ì¥ìš©

# Gemini AI (ì„¤ì¹˜ë˜ì–´ ìˆì„ ê²½ìš°ë§Œ)
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key: client = genai.Client(api_key=api_key)
except: pass

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("CREATE TABLE IF NOT EXISTS users (nickname TEXT PRIMARY KEY, money INTEGER DEFAULT 1000, bank_money INTEGER DEFAULT 0)")
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ì‹œìŠ¤í…œ]
def interest_system():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤
        with sqlite3.connect(DB_FILE) as conn:
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()

# --- [3. ë‡Œì ˆ(ë¬´í•œ ë£¨í”„) ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 100
        # ë‡Œì ˆ íŒ¨í„´ ìƒì„±
        pattern = f"[:[{nick}].{m_count}â‚©:] " * 5
        reward = 5000
        update_money(nick, reward, bank=True) # ì€í–‰ìœ¼ë¡œ ë°”ë¡œ ì…ê¸ˆ
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"ğŸŒ€ ë‡Œì ˆ ì‹œìŠ¤í…œ ê°€ë™ ì¤‘... \nğŸ’° ì€í–‰ ì…ê¸ˆ: +{reward}â‚©\n{pattern}", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3) # 3ì´ˆ ê°„ê²© ë‡Œì ˆ

# --- [4. ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ ì²˜ë¦¬] ---
def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [5. ë¼ìš°íŒ… ë° ì†Œì¼“ ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸ“¢ {data['nickname']}ë‹˜ ì œêµ­ ê°•ë¦¼!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ê¸€ì ìˆ˜ ë³´ìƒ ê³µì‹: ê¸°ë³¸ 50ì› + 10ìë‹¹ 20ì›]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    # [ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ íŒŒì¼ ë³€í™˜]
    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ ëŒ€ìš©ëŸ‰ ë°ì´í„°(ê¸€ììˆ˜: {msg_len})ê°€ íŒŒì¼ë¡œ ë³€í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.\nğŸ”— ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ íŒë…]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        emit('message', {'msg': f"ğŸ’° {nick}ë‹˜ ìì‚° | í˜„ê¸ˆ: {user['money']}â‚© | ì€í–‰: {user['bank_money']}â‚© | ë“±ê¸‰: {'ì´ˆì›”ì' if user['money']>1000000 else 'í‰ë¯¼'}", 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt}â‚© ì €ê¸ˆ ì„±ê³µ! (ë§¤ë¶„ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ {amt}â‚© ì¶œê¸ˆ ì„±ê³µ!", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ ê°€ë™!", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆì„ ì¤‘ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            res = client.models.generate_content(model="gemini-2.0-flash", contents=msg[8:])
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except: pass

    elif cmd == "!ëª…ë ¹ì–´":
        emit('message', {'msg': "ğŸ“œ !ì”ì•¡, !ì €ê¸ˆ [ì•¡ìˆ˜], !ì¶œê¸ˆ [ì•¡ìˆ˜], !ë‡Œì ˆ, !ë‡Œì ˆì¤‘ë‹¨, !gemini [ì§ˆë¬¸]", 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ… ì „ì†¡
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=interest_system, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í´ë”] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "empire_master.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
# ëª¨ë“  í™˜ê²½ í˜¸í™˜ì„ ìœ„í•œ threading ëª¨ë“œ
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {} # ë‡Œì ˆ ìƒíƒœ ì €ì¥ìš©

# Gemini AI (ì„¤ì¹˜ë˜ì–´ ìˆì„ ê²½ìš°ë§Œ)
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key: client = genai.Client(api_key=api_key)
except: pass

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("CREATE TABLE IF NOT EXISTS users (nickname TEXT PRIMARY KEY, money INTEGER DEFAULT 1000, bank_money INTEGER DEFAULT 0)")
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ì‹œìŠ¤í…œ]
def interest_system():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤
        with sqlite3.connect(DB_FILE) as conn:
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()

# --- [3. ë‡Œì ˆ(ë¬´í•œ ë£¨í”„) ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 100
        # ë‡Œì ˆ íŒ¨í„´ ìƒì„±
        pattern = f"[:[{nick}].{m_count}â‚©:] " * 5
        reward = 5000
        update_money(nick, reward, bank=True) # ì€í–‰ìœ¼ë¡œ ë°”ë¡œ ì…ê¸ˆ
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"ğŸŒ€ ë‡Œì ˆ ì‹œìŠ¤í…œ ê°€ë™ ì¤‘... \nğŸ’° ì€í–‰ ì…ê¸ˆ: +{reward}â‚©\n{pattern}", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3) # 3ì´ˆ ê°„ê²© ë‡Œì ˆ

# --- [4. ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ ì²˜ë¦¬] ---
def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [5. ë¼ìš°íŒ… ë° ì†Œì¼“ ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸ“¢ {data['nickname']}ë‹˜ ì œêµ­ ê°•ë¦¼!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ê¸€ì ìˆ˜ ë³´ìƒ ê³µì‹: ê¸°ë³¸ 50ì› + 10ìë‹¹ 20ì›]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    # [ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ íŒŒì¼ ë³€í™˜]
    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ ëŒ€ìš©ëŸ‰ ë°ì´í„°(ê¸€ììˆ˜: {msg_len})ê°€ íŒŒì¼ë¡œ ë³€í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.\nğŸ”— ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ íŒë…]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        emit('message', {'msg': f"ğŸ’° {nick}ë‹˜ ìì‚° | í˜„ê¸ˆ: {user['money']}â‚© | ì€í–‰: {user['bank_money']}â‚© | ë“±ê¸‰: {'ì´ˆì›”ì' if user['money']>1000000 else 'í‰ë¯¼'}", 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt}â‚© ì €ê¸ˆ ì„±ê³µ! (ë§¤ë¶„ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ {amt}â‚© ì¶œê¸ˆ ì„±ê³µ!", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ ê°€ë™!", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆì„ ì¤‘ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            res = client.models.generate_content(model="gemini-2.0-flash", contents=msg[8:])
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except: pass

    elif cmd == "!ëª…ë ¹ì–´":
        emit('message', {'msg': "ğŸ“œ !ì”ì•¡, !ì €ê¸ˆ [ì•¡ìˆ˜], !ì¶œê¸ˆ [ì•¡ìˆ˜], !ë‡Œì ˆ, !ë‡Œì ˆì¤‘ë‹¨, !gemini [ì§ˆë¬¸]", 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ… ì „ì†¡
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=interest_system, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í´ë”] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "empire_master.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
# ëª¨ë“  í™˜ê²½ í˜¸í™˜ì„ ìœ„í•œ threading ëª¨ë“œ
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {} # ë‡Œì ˆ ìƒíƒœ ì €ì¥ìš©

# Gemini AI (ì„¤ì¹˜ë˜ì–´ ìˆì„ ê²½ìš°ë§Œ)
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key: client = genai.Client(api_key=api_key)
except: pass

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("CREATE TABLE IF NOT EXISTS users (nickname TEXT PRIMARY KEY, money INTEGER DEFAULT 1000, bank_money INTEGER DEFAULT 0)")
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ì‹œìŠ¤í…œ]
def interest_system():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤
        with sqlite3.connect(DB_FILE) as conn:
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()

# --- [3. ë‡Œì ˆ(ë¬´í•œ ë£¨í”„) ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 100
        # ë‡Œì ˆ íŒ¨í„´ ìƒì„±
        pattern = f"[:[{nick}].{m_count}â‚©:] " * 5
        reward = 5000
        update_money(nick, reward, bank=True) # ì€í–‰ìœ¼ë¡œ ë°”ë¡œ ì…ê¸ˆ
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"ğŸŒ€ ë‡Œì ˆ ì‹œìŠ¤í…œ ê°€ë™ ì¤‘... \nğŸ’° ì€í–‰ ì…ê¸ˆ: +{reward}â‚©\n{pattern}", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3) # 3ì´ˆ ê°„ê²© ë‡Œì ˆ

# --- [4. ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ ì²˜ë¦¬] ---
def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [5. ë¼ìš°íŒ… ë° ì†Œì¼“ ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸ“¢ {data['nickname']}ë‹˜ ì œêµ­ ê°•ë¦¼!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ê¸€ì ìˆ˜ ë³´ìƒ ê³µì‹: ê¸°ë³¸ 50ì› + 10ìë‹¹ 20ì›]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    # [ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ íŒŒì¼ ë³€í™˜]
    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ ëŒ€ìš©ëŸ‰ ë°ì´í„°(ê¸€ììˆ˜: {msg_len})ê°€ íŒŒì¼ë¡œ ë³€í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.\nğŸ”— ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ íŒë…]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        emit('message', {'msg': f"ğŸ’° {nick}ë‹˜ ìì‚° | í˜„ê¸ˆ: {user['money']}â‚© | ì€í–‰: {user['bank_money']}â‚© | ë“±ê¸‰: {'ì´ˆì›”ì' if user['money']>1000000 else 'í‰ë¯¼'}", 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt}â‚© ì €ê¸ˆ ì„±ê³µ! (ë§¤ë¶„ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ {amt}â‚© ì¶œê¸ˆ ì„±ê³µ!", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ ê°€ë™!", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆì„ ì¤‘ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            res = client.models.generate_content(model="gemini-2.0-flash", contents=msg[8:])
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except: pass

    elif cmd == "!ëª…ë ¹ì–´":
        emit('message', {'msg': "ğŸ“œ !ì”ì•¡, !ì €ê¸ˆ [ì•¡ìˆ˜], !ì¶œê¸ˆ [ì•¡ìˆ˜], !ë‡Œì ˆ, !ë‡Œì ˆì¤‘ë‹¨, !gemini [ì§ˆë¬¸]", 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ… ì „ì†¡
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=interest_system, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í´ë”] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "empire_master.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
# ëª¨ë“  í™˜ê²½ í˜¸í™˜ì„ ìœ„í•œ threading ëª¨ë“œ
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {} # ë‡Œì ˆ ìƒíƒœ ì €ì¥ìš©

# Gemini AI (ì„¤ì¹˜ë˜ì–´ ìˆì„ ê²½ìš°ë§Œ)
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key: client = genai.Client(api_key=api_key)
except: pass

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("CREATE TABLE IF NOT EXISTS users (nickname TEXT PRIMARY KEY, money INTEGER DEFAULT 1000, bank_money INTEGER DEFAULT 0)")
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ì‹œìŠ¤í…œ]
def interest_system():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤
        with sqlite3.connect(DB_FILE) as conn:
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()

# --- [3. ë‡Œì ˆ(ë¬´í•œ ë£¨í”„) ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 100
        # ë‡Œì ˆ íŒ¨í„´ ìƒì„±
        pattern = f"[:[{nick}].{m_count}â‚©:] " * 5
        reward = 5000
        update_money(nick, reward, bank=True) # ì€í–‰ìœ¼ë¡œ ë°”ë¡œ ì…ê¸ˆ
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"ğŸŒ€ ë‡Œì ˆ ì‹œìŠ¤í…œ ê°€ë™ ì¤‘... \nğŸ’° ì€í–‰ ì…ê¸ˆ: +{reward}â‚©\n{pattern}", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3) # 3ì´ˆ ê°„ê²© ë‡Œì ˆ

# --- [4. ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ ì²˜ë¦¬] ---
def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [5. ë¼ìš°íŒ… ë° ì†Œì¼“ ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸ“¢ {data['nickname']}ë‹˜ ì œêµ­ ê°•ë¦¼!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ê¸€ì ìˆ˜ ë³´ìƒ ê³µì‹: ê¸°ë³¸ 50ì› + 10ìë‹¹ 20ì›]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    # [ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ íŒŒì¼ ë³€í™˜]
    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ ëŒ€ìš©ëŸ‰ ë°ì´í„°(ê¸€ììˆ˜: {msg_len})ê°€ íŒŒì¼ë¡œ ë³€í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.\nğŸ”— ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ íŒë…]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        emit('message', {'msg': f"ğŸ’° {nick}ë‹˜ ìì‚° | í˜„ê¸ˆ: {user['money']}â‚© | ì€í–‰: {user['bank_money']}â‚© | ë“±ê¸‰: {'ì´ˆì›”ì' if user['money']>1000000 else 'í‰ë¯¼'}", 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt}â‚© ì €ê¸ˆ ì„±ê³µ! (ë§¤ë¶„ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ {amt}â‚© ì¶œê¸ˆ ì„±ê³µ!", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ ê°€ë™!", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆì„ ì¤‘ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            res = client.models.generate_content(model="gemini-2.0-flash", contents=msg[8:])
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except: pass

    elif cmd == "!ëª…ë ¹ì–´":
        emit('message', {'msg': "ğŸ“œ !ì”ì•¡, !ì €ê¸ˆ [ì•¡ìˆ˜], !ì¶œê¸ˆ [ì•¡ìˆ˜], !ë‡Œì ˆ, !ë‡Œì ˆì¤‘ë‹¨, !gemini [ì§ˆë¬¸]", 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ… ì „ì†¡
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=interest_system, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í´ë”] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "empire_master.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
# ëª¨ë“  í™˜ê²½ í˜¸í™˜ì„ ìœ„í•œ threading ëª¨ë“œ
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {} # ë‡Œì ˆ ìƒíƒœ ì €ì¥ìš©

# Gemini AI (ì„¤ì¹˜ë˜ì–´ ìˆì„ ê²½ìš°ë§Œ)
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key: client = genai.Client(api_key=api_key)
except: pass

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("CREATE TABLE IF NOT EXISTS users (nickname TEXT PRIMARY KEY, money INTEGER DEFAULT 1000, bank_money INTEGER DEFAULT 0)")
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ì‹œìŠ¤í…œ]
def interest_system():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤
        with sqlite3.connect(DB_FILE) as conn:
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()

# --- [3. ë‡Œì ˆ(ë¬´í•œ ë£¨í”„) ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 100
        # ë‡Œì ˆ íŒ¨í„´ ìƒì„±
        pattern = f"[:[{nick}].{m_count}â‚©:] " * 5
        reward = 5000
        update_money(nick, reward, bank=True) # ì€í–‰ìœ¼ë¡œ ë°”ë¡œ ì…ê¸ˆ
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"ğŸŒ€ ë‡Œì ˆ ì‹œìŠ¤í…œ ê°€ë™ ì¤‘... \nğŸ’° ì€í–‰ ì…ê¸ˆ: +{reward}â‚©\n{pattern}", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3) # 3ì´ˆ ê°„ê²© ë‡Œì ˆ

# --- [4. ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ ì²˜ë¦¬] ---
def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [5. ë¼ìš°íŒ… ë° ì†Œì¼“ ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸ“¢ {data['nickname']}ë‹˜ ì œêµ­ ê°•ë¦¼!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ê¸€ì ìˆ˜ ë³´ìƒ ê³µì‹: ê¸°ë³¸ 50ì› + 10ìë‹¹ 20ì›]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    # [ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ íŒŒì¼ ë³€í™˜]
    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ ëŒ€ìš©ëŸ‰ ë°ì´í„°(ê¸€ììˆ˜: {msg_len})ê°€ íŒŒì¼ë¡œ ë³€í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.\nğŸ”— ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ íŒë…]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        emit('message', {'msg': f"ğŸ’° {nick}ë‹˜ ìì‚° | í˜„ê¸ˆ: {user['money']}â‚© | ì€í–‰: {user['bank_money']}â‚© | ë“±ê¸‰: {'ì´ˆì›”ì' if user['money']>1000000 else 'í‰ë¯¼'}", 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt}â‚© ì €ê¸ˆ ì„±ê³µ! (ë§¤ë¶„ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ {amt}â‚© ì¶œê¸ˆ ì„±ê³µ!", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ ê°€ë™!", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆì„ ì¤‘ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            res = client.models.generate_content(model="gemini-2.0-flash", contents=msg[8:])
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except: pass

    elif cmd == "!ëª…ë ¹ì–´":
        emit('message', {'msg': "ğŸ“œ !ì”ì•¡, !ì €ê¸ˆ [ì•¡ìˆ˜], !ì¶œê¸ˆ [ì•¡ìˆ˜], !ë‡Œì ˆ, !ë‡Œì ˆì¤‘ë‹¨, !gemini [ì§ˆë¬¸]", 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ… ì „ì†¡
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=interest_system, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í´ë”] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "empire_master.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
# ëª¨ë“  í™˜ê²½ í˜¸í™˜ì„ ìœ„í•œ threading ëª¨ë“œ
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {} # ë‡Œì ˆ ìƒíƒœ ì €ì¥ìš©

# Gemini AI (ì„¤ì¹˜ë˜ì–´ ìˆì„ ê²½ìš°ë§Œ)
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key: client = genai.Client(api_key=api_key)
except: pass

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("CREATE TABLE IF NOT EXISTS users (nickname TEXT PRIMARY KEY, money INTEGER DEFAULT 1000, bank_money INTEGER DEFAULT 0)")
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ì‹œìŠ¤í…œ]
def interest_system():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤
        with sqlite3.connect(DB_FILE) as conn:
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()

# --- [3. ë‡Œì ˆ(ë¬´í•œ ë£¨í”„) ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 100
        # ë‡Œì ˆ íŒ¨í„´ ìƒì„±
        pattern = f"[:[{nick}].{m_count}â‚©:] " * 5
        reward = 5000
        update_money(nick, reward, bank=True) # ì€í–‰ìœ¼ë¡œ ë°”ë¡œ ì…ê¸ˆ
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"ğŸŒ€ ë‡Œì ˆ ì‹œìŠ¤í…œ ê°€ë™ ì¤‘... \nğŸ’° ì€í–‰ ì…ê¸ˆ: +{reward}â‚©\n{pattern}", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3) # 3ì´ˆ ê°„ê²© ë‡Œì ˆ

# --- [4. ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ ì²˜ë¦¬] ---
def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [5. ë¼ìš°íŒ… ë° ì†Œì¼“ ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸ“¢ {data['nickname']}ë‹˜ ì œêµ­ ê°•ë¦¼!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ê¸€ì ìˆ˜ ë³´ìƒ ê³µì‹: ê¸°ë³¸ 50ì› + 10ìë‹¹ 20ì›]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    # [ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ íŒŒì¼ ë³€í™˜]
    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ ëŒ€ìš©ëŸ‰ ë°ì´í„°(ê¸€ììˆ˜: {msg_len})ê°€ íŒŒì¼ë¡œ ë³€í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.\nğŸ”— ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ íŒë…]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        emit('message', {'msg': f"ğŸ’° {nick}ë‹˜ ìì‚° | í˜„ê¸ˆ: {user['money']}â‚© | ì€í–‰: {user['bank_money']}â‚© | ë“±ê¸‰: {'ì´ˆì›”ì' if user['money']>1000000 else 'í‰ë¯¼'}", 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt}â‚© ì €ê¸ˆ ì„±ê³µ! (ë§¤ë¶„ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ {amt}â‚© ì¶œê¸ˆ ì„±ê³µ!", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ ê°€ë™!", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆì„ ì¤‘ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            res = client.models.generate_content(model="gemini-2.0-flash", contents=msg[8:])
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except: pass

    elif cmd == "!ëª…ë ¹ì–´":
        emit('message', {'msg': "ğŸ“œ !ì”ì•¡, !ì €ê¸ˆ [ì•¡ìˆ˜], !ì¶œê¸ˆ [ì•¡ìˆ˜], !ë‡Œì ˆ, !ë‡Œì ˆì¤‘ë‹¨, !gemini [ì§ˆë¬¸]", 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ… ì „ì†¡
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=interest_system, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í´ë”] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "empire_master.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
# ëª¨ë“  í™˜ê²½ í˜¸í™˜ì„ ìœ„í•œ threading ëª¨ë“œ
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {} # ë‡Œì ˆ ìƒíƒœ ì €ì¥ìš©

# Gemini AI (ì„¤ì¹˜ë˜ì–´ ìˆì„ ê²½ìš°ë§Œ)
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key: client = genai.Client(api_key=api_key)
except: pass

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("CREATE TABLE IF NOT EXISTS users (nickname TEXT PRIMARY KEY, money INTEGER DEFAULT 1000, bank_money INTEGER DEFAULT 0)")
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ì‹œìŠ¤í…œ]
def interest_system():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤
        with sqlite3.connect(DB_FILE) as conn:
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()

# --- [3. ë‡Œì ˆ(ë¬´í•œ ë£¨í”„) ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 100
        # ë‡Œì ˆ íŒ¨í„´ ìƒì„±
        pattern = f"[:[{nick}].{m_count}â‚©:] " * 5
        reward = 5000
        update_money(nick, reward, bank=True) # ì€í–‰ìœ¼ë¡œ ë°”ë¡œ ì…ê¸ˆ
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"ğŸŒ€ ë‡Œì ˆ ì‹œìŠ¤í…œ ê°€ë™ ì¤‘... \nğŸ’° ì€í–‰ ì…ê¸ˆ: +{reward}â‚©\n{pattern}", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3) # 3ì´ˆ ê°„ê²© ë‡Œì ˆ

# --- [4. ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ ì²˜ë¦¬] ---
def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [5. ë¼ìš°íŒ… ë° ì†Œì¼“ ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸ“¢ {data['nickname']}ë‹˜ ì œêµ­ ê°•ë¦¼!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ê¸€ì ìˆ˜ ë³´ìƒ ê³µì‹: ê¸°ë³¸ 50ì› + 10ìë‹¹ 20ì›]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    # [ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ íŒŒì¼ ë³€í™˜]
    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ ëŒ€ìš©ëŸ‰ ë°ì´í„°(ê¸€ììˆ˜: {msg_len})ê°€ íŒŒì¼ë¡œ ë³€í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.\nğŸ”— ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ íŒë…]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        emit('message', {'msg': f"ğŸ’° {nick}ë‹˜ ìì‚° | í˜„ê¸ˆ: {user['money']}â‚© | ì€í–‰: {user['bank_money']}â‚© | ë“±ê¸‰: {'ì´ˆì›”ì' if user['money']>1000000 else 'í‰ë¯¼'}", 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt}â‚© ì €ê¸ˆ ì„±ê³µ! (ë§¤ë¶„ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ {amt}â‚© ì¶œê¸ˆ ì„±ê³µ!", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ ê°€ë™!", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆì„ ì¤‘ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            res = client.models.generate_content(model="gemini-2.0-flash", contents=msg[8:])
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except: pass

    elif cmd == "!ëª…ë ¹ì–´":
        emit('message', {'msg': "ğŸ“œ !ì”ì•¡, !ì €ê¸ˆ [ì•¡ìˆ˜], !ì¶œê¸ˆ [ì•¡ìˆ˜], !ë‡Œì ˆ, !ë‡Œì ˆì¤‘ë‹¨, !gemini [ì§ˆë¬¸]", 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ… ì „ì†¡
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=interest_system, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í´ë”] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "empire_master.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
# ëª¨ë“  í™˜ê²½ í˜¸í™˜ì„ ìœ„í•œ threading ëª¨ë“œ
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {} # ë‡Œì ˆ ìƒíƒœ ì €ì¥ìš©

# Gemini AI (ì„¤ì¹˜ë˜ì–´ ìˆì„ ê²½ìš°ë§Œ)
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key: client = genai.Client(api_key=api_key)
except: pass

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("CREATE TABLE IF NOT EXISTS users (nickname TEXT PRIMARY KEY, money INTEGER DEFAULT 1000, bank_money INTEGER DEFAULT 0)")
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ì‹œìŠ¤í…œ]
def interest_system():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤
        with sqlite3.connect(DB_FILE) as conn:
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()

# --- [3. ë‡Œì ˆ(ë¬´í•œ ë£¨í”„) ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 100
        # ë‡Œì ˆ íŒ¨í„´ ìƒì„±
        pattern = f"[:[{nick}].{m_count}â‚©:] " * 5
        reward = 5000
        update_money(nick, reward, bank=True) # ì€í–‰ìœ¼ë¡œ ë°”ë¡œ ì…ê¸ˆ
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"ğŸŒ€ ë‡Œì ˆ ì‹œìŠ¤í…œ ê°€ë™ ì¤‘... \nğŸ’° ì€í–‰ ì…ê¸ˆ: +{reward}â‚©\n{pattern}", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3) # 3ì´ˆ ê°„ê²© ë‡Œì ˆ

# --- [4. ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ ì²˜ë¦¬] ---
def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [5. ë¼ìš°íŒ… ë° ì†Œì¼“ ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸ“¢ {data['nickname']}ë‹˜ ì œêµ­ ê°•ë¦¼!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ê¸€ì ìˆ˜ ë³´ìƒ ê³µì‹: ê¸°ë³¸ 50ì› + 10ìë‹¹ 20ì›]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    # [ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ íŒŒì¼ ë³€í™˜]
    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ ëŒ€ìš©ëŸ‰ ë°ì´í„°(ê¸€ììˆ˜: {msg_len})ê°€ íŒŒì¼ë¡œ ë³€í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.\nğŸ”— ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ íŒë…]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        emit('message', {'msg': f"ğŸ’° {nick}ë‹˜ ìì‚° | í˜„ê¸ˆ: {user['money']}â‚© | ì€í–‰: {user['bank_money']}â‚© | ë“±ê¸‰: {'ì´ˆì›”ì' if user['money']>1000000 else 'í‰ë¯¼'}", 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt}â‚© ì €ê¸ˆ ì„±ê³µ! (ë§¤ë¶„ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ {amt}â‚© ì¶œê¸ˆ ì„±ê³µ!", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ ê°€ë™!", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆì„ ì¤‘ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            res = client.models.generate_content(model="gemini-2.0-flash", contents=msg[8:])
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except: pass

    elif cmd == "!ëª…ë ¹ì–´":
        emit('message', {'msg': "ğŸ“œ !ì”ì•¡, !ì €ê¸ˆ [ì•¡ìˆ˜], !ì¶œê¸ˆ [ì•¡ìˆ˜], !ë‡Œì ˆ, !ë‡Œì ˆì¤‘ë‹¨, !gemini [ì§ˆë¬¸]", 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ… ì „ì†¡
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=interest_system, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í´ë”] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "empire_master.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
# ëª¨ë“  í™˜ê²½ í˜¸í™˜ì„ ìœ„í•œ threading ëª¨ë“œ
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {} # ë‡Œì ˆ ìƒíƒœ ì €ì¥ìš©

# Gemini AI (ì„¤ì¹˜ë˜ì–´ ìˆì„ ê²½ìš°ë§Œ)
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key: client = genai.Client(api_key=api_key)
except: pass

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("CREATE TABLE IF NOT EXISTS users (nickname TEXT PRIMARY KEY, money INTEGER DEFAULT 1000, bank_money INTEGER DEFAULT 0)")
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ì‹œìŠ¤í…œ]
def interest_system():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤
        with sqlite3.connect(DB_FILE) as conn:
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()

# --- [3. ë‡Œì ˆ(ë¬´í•œ ë£¨í”„) ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 100
        # ë‡Œì ˆ íŒ¨í„´ ìƒì„±
        pattern = f"[:[{nick}].{m_count}â‚©:] " * 5
        reward = 5000
        update_money(nick, reward, bank=True) # ì€í–‰ìœ¼ë¡œ ë°”ë¡œ ì…ê¸ˆ
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"ğŸŒ€ ë‡Œì ˆ ì‹œìŠ¤í…œ ê°€ë™ ì¤‘... \nğŸ’° ì€í–‰ ì…ê¸ˆ: +{reward}â‚©\n{pattern}", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3) # 3ì´ˆ ê°„ê²© ë‡Œì ˆ

# --- [4. ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ ì²˜ë¦¬] ---
def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [5. ë¼ìš°íŒ… ë° ì†Œì¼“ ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸ“¢ {data['nickname']}ë‹˜ ì œêµ­ ê°•ë¦¼!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ê¸€ì ìˆ˜ ë³´ìƒ ê³µì‹: ê¸°ë³¸ 50ì› + 10ìë‹¹ 20ì›]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    # [ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ íŒŒì¼ ë³€í™˜]
    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ ëŒ€ìš©ëŸ‰ ë°ì´í„°(ê¸€ììˆ˜: {msg_len})ê°€ íŒŒì¼ë¡œ ë³€í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.\nğŸ”— ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ íŒë…]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        emit('message', {'msg': f"ğŸ’° {nick}ë‹˜ ìì‚° | í˜„ê¸ˆ: {user['money']}â‚© | ì€í–‰: {user['bank_money']}â‚© | ë“±ê¸‰: {'ì´ˆì›”ì' if user['money']>1000000 else 'í‰ë¯¼'}", 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt}â‚© ì €ê¸ˆ ì„±ê³µ! (ë§¤ë¶„ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ {amt}â‚© ì¶œê¸ˆ ì„±ê³µ!", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ ê°€ë™!", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆì„ ì¤‘ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            res = client.models.generate_content(model="gemini-2.0-flash", contents=msg[8:])
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except: pass

    elif cmd == "!ëª…ë ¹ì–´":
        emit('message', {'msg': "ğŸ“œ !ì”ì•¡, !ì €ê¸ˆ [ì•¡ìˆ˜], !ì¶œê¸ˆ [ì•¡ìˆ˜], !ë‡Œì ˆ, !ë‡Œì ˆì¤‘ë‹¨, !gemini [ì§ˆë¬¸]", 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ… ì „ì†¡
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=interest_system, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í´ë”] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "empire_master.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
# ëª¨ë“  í™˜ê²½ í˜¸í™˜ì„ ìœ„í•œ threading ëª¨ë“œ
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {} # ë‡Œì ˆ ìƒíƒœ ì €ì¥ìš©

# Gemini AI (ì„¤ì¹˜ë˜ì–´ ìˆì„ ê²½ìš°ë§Œ)
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key: client = genai.Client(api_key=api_key)
except: pass

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("CREATE TABLE IF NOT EXISTS users (nickname TEXT PRIMARY KEY, money INTEGER DEFAULT 1000, bank_money INTEGER DEFAULT 0)")
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ì‹œìŠ¤í…œ]
def interest_system():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤
        with sqlite3.connect(DB_FILE) as conn:
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()

# --- [3. ë‡Œì ˆ(ë¬´í•œ ë£¨í”„) ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 100
        # ë‡Œì ˆ íŒ¨í„´ ìƒì„±
        pattern = f"[:[{nick}].{m_count}â‚©:] " * 5
        reward = 5000
        update_money(nick, reward, bank=True) # ì€í–‰ìœ¼ë¡œ ë°”ë¡œ ì…ê¸ˆ
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"ğŸŒ€ ë‡Œì ˆ ì‹œìŠ¤í…œ ê°€ë™ ì¤‘... \nğŸ’° ì€í–‰ ì…ê¸ˆ: +{reward}â‚©\n{pattern}", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3) # 3ì´ˆ ê°„ê²© ë‡Œì ˆ

# --- [4. ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ ì²˜ë¦¬] ---
def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [5. ë¼ìš°íŒ… ë° ì†Œì¼“ ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸ“¢ {data['nickname']}ë‹˜ ì œêµ­ ê°•ë¦¼!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ê¸€ì ìˆ˜ ë³´ìƒ ê³µì‹: ê¸°ë³¸ 50ì› + 10ìë‹¹ 20ì›]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    # [ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ íŒŒì¼ ë³€í™˜]
    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ ëŒ€ìš©ëŸ‰ ë°ì´í„°(ê¸€ììˆ˜: {msg_len})ê°€ íŒŒì¼ë¡œ ë³€í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.\nğŸ”— ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ íŒë…]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        emit('message', {'msg': f"ğŸ’° {nick}ë‹˜ ìì‚° | í˜„ê¸ˆ: {user['money']}â‚© | ì€í–‰: {user['bank_money']}â‚© | ë“±ê¸‰: {'ì´ˆì›”ì' if user['money']>1000000 else 'í‰ë¯¼'}", 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt}â‚© ì €ê¸ˆ ì„±ê³µ! (ë§¤ë¶„ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ {amt}â‚© ì¶œê¸ˆ ì„±ê³µ!", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ ê°€ë™!", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆì„ ì¤‘ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            res = client.models.generate_content(model="gemini-2.0-flash", contents=msg[8:])
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except: pass

    elif cmd == "!ëª…ë ¹ì–´":
        emit('message', {'msg': "ğŸ“œ !ì”ì•¡, !ì €ê¸ˆ [ì•¡ìˆ˜], !ì¶œê¸ˆ [ì•¡ìˆ˜], !ë‡Œì ˆ, !ë‡Œì ˆì¤‘ë‹¨, !gemini [ì§ˆë¬¸]", 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ… ì „ì†¡
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=interest_system, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í´ë”] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "empire_master.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
# ëª¨ë“  í™˜ê²½ í˜¸í™˜ì„ ìœ„í•œ threading ëª¨ë“œ
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {} # ë‡Œì ˆ ìƒíƒœ ì €ì¥ìš©

# Gemini AI (ì„¤ì¹˜ë˜ì–´ ìˆì„ ê²½ìš°ë§Œ)
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key: client = genai.Client(api_key=api_key)
except: pass

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("CREATE TABLE IF NOT EXISTS users (nickname TEXT PRIMARY KEY, money INTEGER DEFAULT 1000, bank_money INTEGER DEFAULT 0)")
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ì‹œìŠ¤í…œ]
def interest_system():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤
        with sqlite3.connect(DB_FILE) as conn:
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()

# --- [3. ë‡Œì ˆ(ë¬´í•œ ë£¨í”„) ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 100
        # ë‡Œì ˆ íŒ¨í„´ ìƒì„±
        pattern = f"[:[{nick}].{m_count}â‚©:] " * 5
        reward = 5000
        update_money(nick, reward, bank=True) # ì€í–‰ìœ¼ë¡œ ë°”ë¡œ ì…ê¸ˆ
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"ğŸŒ€ ë‡Œì ˆ ì‹œìŠ¤í…œ ê°€ë™ ì¤‘... \nğŸ’° ì€í–‰ ì…ê¸ˆ: +{reward}â‚©\n{pattern}", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3) # 3ì´ˆ ê°„ê²© ë‡Œì ˆ

# --- [4. ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ ì²˜ë¦¬] ---
def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [5. ë¼ìš°íŒ… ë° ì†Œì¼“ ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸ“¢ {data['nickname']}ë‹˜ ì œêµ­ ê°•ë¦¼!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ê¸€ì ìˆ˜ ë³´ìƒ ê³µì‹: ê¸°ë³¸ 50ì› + 10ìë‹¹ 20ì›]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    # [ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ íŒŒì¼ ë³€í™˜]
    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ ëŒ€ìš©ëŸ‰ ë°ì´í„°(ê¸€ììˆ˜: {msg_len})ê°€ íŒŒì¼ë¡œ ë³€í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.\nğŸ”— ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ íŒë…]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        emit('message', {'msg': f"ğŸ’° {nick}ë‹˜ ìì‚° | í˜„ê¸ˆ: {user['money']}â‚© | ì€í–‰: {user['bank_money']}â‚© | ë“±ê¸‰: {'ì´ˆì›”ì' if user['money']>1000000 else 'í‰ë¯¼'}", 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt}â‚© ì €ê¸ˆ ì„±ê³µ! (ë§¤ë¶„ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ {amt}â‚© ì¶œê¸ˆ ì„±ê³µ!", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ ê°€ë™!", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆì„ ì¤‘ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            res = client.models.generate_content(model="gemini-2.0-flash", contents=msg[8:])
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except: pass

    elif cmd == "!ëª…ë ¹ì–´":
        emit('message', {'msg': "ğŸ“œ !ì”ì•¡, !ì €ê¸ˆ [ì•¡ìˆ˜], !ì¶œê¸ˆ [ì•¡ìˆ˜], !ë‡Œì ˆ, !ë‡Œì ˆì¤‘ë‹¨, !gemini [ì§ˆë¬¸]", 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ… ì „ì†¡
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=interest_system, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í´ë”] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "empire_master.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
# ëª¨ë“  í™˜ê²½ í˜¸í™˜ì„ ìœ„í•œ threading ëª¨ë“œ
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {} # ë‡Œì ˆ ìƒíƒœ ì €ì¥ìš©

# Gemini AI (ì„¤ì¹˜ë˜ì–´ ìˆì„ ê²½ìš°ë§Œ)
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key: client = genai.Client(api_key=api_key)
except: pass

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("CREATE TABLE IF NOT EXISTS users (nickname TEXT PRIMARY KEY, money INTEGER DEFAULT 1000, bank_money INTEGER DEFAULT 0)")
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ì‹œìŠ¤í…œ]
def interest_system():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤
        with sqlite3.connect(DB_FILE) as conn:
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()

# --- [3. ë‡Œì ˆ(ë¬´í•œ ë£¨í”„) ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 100
        # ë‡Œì ˆ íŒ¨í„´ ìƒì„±
        pattern = f"[:[{nick}].{m_count}â‚©:] " * 5
        reward = 5000
        update_money(nick, reward, bank=True) # ì€í–‰ìœ¼ë¡œ ë°”ë¡œ ì…ê¸ˆ
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"ğŸŒ€ ë‡Œì ˆ ì‹œìŠ¤í…œ ê°€ë™ ì¤‘... \nğŸ’° ì€í–‰ ì…ê¸ˆ: +{reward}â‚©\n{pattern}", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3) # 3ì´ˆ ê°„ê²© ë‡Œì ˆ

# --- [4. ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ ì²˜ë¦¬] ---
def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [5. ë¼ìš°íŒ… ë° ì†Œì¼“ ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸ“¢ {data['nickname']}ë‹˜ ì œêµ­ ê°•ë¦¼!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ê¸€ì ìˆ˜ ë³´ìƒ ê³µì‹: ê¸°ë³¸ 50ì› + 10ìë‹¹ 20ì›]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    # [ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ íŒŒì¼ ë³€í™˜]
    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ ëŒ€ìš©ëŸ‰ ë°ì´í„°(ê¸€ììˆ˜: {msg_len})ê°€ íŒŒì¼ë¡œ ë³€í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.\nğŸ”— ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ íŒë…]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        emit('message', {'msg': f"ğŸ’° {nick}ë‹˜ ìì‚° | í˜„ê¸ˆ: {user['money']}â‚© | ì€í–‰: {user['bank_money']}â‚© | ë“±ê¸‰: {'ì´ˆì›”ì' if user['money']>1000000 else 'í‰ë¯¼'}", 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt}â‚© ì €ê¸ˆ ì„±ê³µ! (ë§¤ë¶„ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ {amt}â‚© ì¶œê¸ˆ ì„±ê³µ!", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ ê°€ë™!", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆì„ ì¤‘ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            res = client.models.generate_content(model="gemini-2.0-flash", contents=msg[8:])
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except: pass

    elif cmd == "!ëª…ë ¹ì–´":
        emit('message', {'msg': "ğŸ“œ !ì”ì•¡, !ì €ê¸ˆ [ì•¡ìˆ˜], !ì¶œê¸ˆ [ì•¡ìˆ˜], !ë‡Œì ˆ, !ë‡Œì ˆì¤‘ë‹¨, !gemini [ì§ˆë¬¸]", 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ… ì „ì†¡
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=interest_system, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í´ë”] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "empire_master.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
# ëª¨ë“  í™˜ê²½ í˜¸í™˜ì„ ìœ„í•œ threading ëª¨ë“œ
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {} # ë‡Œì ˆ ìƒíƒœ ì €ì¥ìš©

# Gemini AI (ì„¤ì¹˜ë˜ì–´ ìˆì„ ê²½ìš°ë§Œ)
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key: client = genai.Client(api_key=api_key)
except: pass

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("CREATE TABLE IF NOT EXISTS users (nickname TEXT PRIMARY KEY, money INTEGER DEFAULT 1000, bank_money INTEGER DEFAULT 0)")
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ì‹œìŠ¤í…œ]
def interest_system():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤
        with sqlite3.connect(DB_FILE) as conn:
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()

# --- [3. ë‡Œì ˆ(ë¬´í•œ ë£¨í”„) ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 100
        # ë‡Œì ˆ íŒ¨í„´ ìƒì„±
        pattern = f"[:[{nick}].{m_count}â‚©:] " * 5
        reward = 5000
        update_money(nick, reward, bank=True) # ì€í–‰ìœ¼ë¡œ ë°”ë¡œ ì…ê¸ˆ
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"ğŸŒ€ ë‡Œì ˆ ì‹œìŠ¤í…œ ê°€ë™ ì¤‘... \nğŸ’° ì€í–‰ ì…ê¸ˆ: +{reward}â‚©\n{pattern}", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3) # 3ì´ˆ ê°„ê²© ë‡Œì ˆ

# --- [4. ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ ì²˜ë¦¬] ---
def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [5. ë¼ìš°íŒ… ë° ì†Œì¼“ ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸ“¢ {data['nickname']}ë‹˜ ì œêµ­ ê°•ë¦¼!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ê¸€ì ìˆ˜ ë³´ìƒ ê³µì‹: ê¸°ë³¸ 50ì› + 10ìë‹¹ 20ì›]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    # [ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ íŒŒì¼ ë³€í™˜]
    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ ëŒ€ìš©ëŸ‰ ë°ì´í„°(ê¸€ììˆ˜: {msg_len})ê°€ íŒŒì¼ë¡œ ë³€í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.\nğŸ”— ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ íŒë…]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        emit('message', {'msg': f"ğŸ’° {nick}ë‹˜ ìì‚° | í˜„ê¸ˆ: {user['money']}â‚© | ì€í–‰: {user['bank_money']}â‚© | ë“±ê¸‰: {'ì´ˆì›”ì' if user['money']>1000000 else 'í‰ë¯¼'}", 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt}â‚© ì €ê¸ˆ ì„±ê³µ! (ë§¤ë¶„ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ {amt}â‚© ì¶œê¸ˆ ì„±ê³µ!", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ ê°€ë™!", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆì„ ì¤‘ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            res = client.models.generate_content(model="gemini-2.0-flash", contents=msg[8:])
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except: pass

    elif cmd == "!ëª…ë ¹ì–´":
        emit('message', {'msg': "ğŸ“œ !ì”ì•¡, !ì €ê¸ˆ [ì•¡ìˆ˜], !ì¶œê¸ˆ [ì•¡ìˆ˜], !ë‡Œì ˆ, !ë‡Œì ˆì¤‘ë‹¨, !gemini [ì§ˆë¬¸]", 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ… ì „ì†¡
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=interest_system, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í´ë”] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "empire_master.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
# ëª¨ë“  í™˜ê²½ í˜¸í™˜ì„ ìœ„í•œ threading ëª¨ë“œ
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {} # ë‡Œì ˆ ìƒíƒœ ì €ì¥ìš©

# Gemini AI (ì„¤ì¹˜ë˜ì–´ ìˆì„ ê²½ìš°ë§Œ)
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key: client = genai.Client(api_key=api_key)
except: pass

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("CREATE TABLE IF NOT EXISTS users (nickname TEXT PRIMARY KEY, money INTEGER DEFAULT 1000, bank_money INTEGER DEFAULT 0)")
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ì‹œìŠ¤í…œ]
def interest_system():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤
        with sqlite3.connect(DB_FILE) as conn:
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()

# --- [3. ë‡Œì ˆ(ë¬´í•œ ë£¨í”„) ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 100
        # ë‡Œì ˆ íŒ¨í„´ ìƒì„±
        pattern = f"[:[{nick}].{m_count}â‚©:] " * 5
        reward = 5000
        update_money(nick, reward, bank=True) # ì€í–‰ìœ¼ë¡œ ë°”ë¡œ ì…ê¸ˆ
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"ğŸŒ€ ë‡Œì ˆ ì‹œìŠ¤í…œ ê°€ë™ ì¤‘... \nğŸ’° ì€í–‰ ì…ê¸ˆ: +{reward}â‚©\n{pattern}", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3) # 3ì´ˆ ê°„ê²© ë‡Œì ˆ

# --- [4. ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ ì²˜ë¦¬] ---
def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [5. ë¼ìš°íŒ… ë° ì†Œì¼“ ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸ“¢ {data['nickname']}ë‹˜ ì œêµ­ ê°•ë¦¼!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ê¸€ì ìˆ˜ ë³´ìƒ ê³µì‹: ê¸°ë³¸ 50ì› + 10ìë‹¹ 20ì›]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    # [ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ íŒŒì¼ ë³€í™˜]
    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ ëŒ€ìš©ëŸ‰ ë°ì´í„°(ê¸€ììˆ˜: {msg_len})ê°€ íŒŒì¼ë¡œ ë³€í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.\nğŸ”— ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ íŒë…]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        emit('message', {'msg': f"ğŸ’° {nick}ë‹˜ ìì‚° | í˜„ê¸ˆ: {user['money']}â‚© | ì€í–‰: {user['bank_money']}â‚© | ë“±ê¸‰: {'ì´ˆì›”ì' if user['money']>1000000 else 'í‰ë¯¼'}", 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt}â‚© ì €ê¸ˆ ì„±ê³µ! (ë§¤ë¶„ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ {amt}â‚© ì¶œê¸ˆ ì„±ê³µ!", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ ê°€ë™!", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆì„ ì¤‘ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            res = client.models.generate_content(model="gemini-2.0-flash", contents=msg[8:])
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except: pass

    elif cmd == "!ëª…ë ¹ì–´":
        emit('message', {'msg': "ğŸ“œ !ì”ì•¡, !ì €ê¸ˆ [ì•¡ìˆ˜], !ì¶œê¸ˆ [ì•¡ìˆ˜], !ë‡Œì ˆ, !ë‡Œì ˆì¤‘ë‹¨, !gemini [ì§ˆë¬¸]", 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ… ì „ì†¡
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=interest_system, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í´ë”] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "empire_master.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
# ëª¨ë“  í™˜ê²½ í˜¸í™˜ì„ ìœ„í•œ threading ëª¨ë“œ
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {} # ë‡Œì ˆ ìƒíƒœ ì €ì¥ìš©

# Gemini AI (ì„¤ì¹˜ë˜ì–´ ìˆì„ ê²½ìš°ë§Œ)
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key: client = genai.Client(api_key=api_key)
except: pass

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("CREATE TABLE IF NOT EXISTS users (nickname TEXT PRIMARY KEY, money INTEGER DEFAULT 1000, bank_money INTEGER DEFAULT 0)")
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ì‹œìŠ¤í…œ]
def interest_system():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤
        with sqlite3.connect(DB_FILE) as conn:
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()

# --- [3. ë‡Œì ˆ(ë¬´í•œ ë£¨í”„) ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 100
        # ë‡Œì ˆ íŒ¨í„´ ìƒì„±
        pattern = f"[:[{nick}].{m_count}â‚©:] " * 5
        reward = 5000
        update_money(nick, reward, bank=True) # ì€í–‰ìœ¼ë¡œ ë°”ë¡œ ì…ê¸ˆ
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"ğŸŒ€ ë‡Œì ˆ ì‹œìŠ¤í…œ ê°€ë™ ì¤‘... \nğŸ’° ì€í–‰ ì…ê¸ˆ: +{reward}â‚©\n{pattern}", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3) # 3ì´ˆ ê°„ê²© ë‡Œì ˆ

# --- [4. ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ ì²˜ë¦¬] ---
def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [5. ë¼ìš°íŒ… ë° ì†Œì¼“ ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸ“¢ {data['nickname']}ë‹˜ ì œêµ­ ê°•ë¦¼!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ê¸€ì ìˆ˜ ë³´ìƒ ê³µì‹: ê¸°ë³¸ 50ì› + 10ìë‹¹ 20ì›]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    # [ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ íŒŒì¼ ë³€í™˜]
    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ ëŒ€ìš©ëŸ‰ ë°ì´í„°(ê¸€ììˆ˜: {msg_len})ê°€ íŒŒì¼ë¡œ ë³€í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.\nğŸ”— ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ íŒë…]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        emit('message', {'msg': f"ğŸ’° {nick}ë‹˜ ìì‚° | í˜„ê¸ˆ: {user['money']}â‚© | ì€í–‰: {user['bank_money']}â‚© | ë“±ê¸‰: {'ì´ˆì›”ì' if user['money']>1000000 else 'í‰ë¯¼'}", 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt}â‚© ì €ê¸ˆ ì„±ê³µ! (ë§¤ë¶„ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ {amt}â‚© ì¶œê¸ˆ ì„±ê³µ!", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ ê°€ë™!", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆì„ ì¤‘ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            res = client.models.generate_content(model="gemini-2.0-flash", contents=msg[8:])
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except: pass

    elif cmd == "!ëª…ë ¹ì–´":
        emit('message', {'msg': "ğŸ“œ !ì”ì•¡, !ì €ê¸ˆ [ì•¡ìˆ˜], !ì¶œê¸ˆ [ì•¡ìˆ˜], !ë‡Œì ˆ, !ë‡Œì ˆì¤‘ë‹¨, !gemini [ì§ˆë¬¸]", 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ… ì „ì†¡
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=interest_system, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í´ë”] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "empire_master.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
# ëª¨ë“  í™˜ê²½ í˜¸í™˜ì„ ìœ„í•œ threading ëª¨ë“œ
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {} # ë‡Œì ˆ ìƒíƒœ ì €ì¥ìš©

# Gemini AI (ì„¤ì¹˜ë˜ì–´ ìˆì„ ê²½ìš°ë§Œ)
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key: client = genai.Client(api_key=api_key)
except: pass

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("CREATE TABLE IF NOT EXISTS users (nickname TEXT PRIMARY KEY, money INTEGER DEFAULT 1000, bank_money INTEGER DEFAULT 0)")
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ì‹œìŠ¤í…œ]
def interest_system():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤
        with sqlite3.connect(DB_FILE) as conn:
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()

# --- [3. ë‡Œì ˆ(ë¬´í•œ ë£¨í”„) ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 100
        # ë‡Œì ˆ íŒ¨í„´ ìƒì„±
        pattern = f"[:[{nick}].{m_count}â‚©:] " * 5
        reward = 5000
        update_money(nick, reward, bank=True) # ì€í–‰ìœ¼ë¡œ ë°”ë¡œ ì…ê¸ˆ
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"ğŸŒ€ ë‡Œì ˆ ì‹œìŠ¤í…œ ê°€ë™ ì¤‘... \nğŸ’° ì€í–‰ ì…ê¸ˆ: +{reward}â‚©\n{pattern}", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3) # 3ì´ˆ ê°„ê²© ë‡Œì ˆ

# --- [4. ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ ì²˜ë¦¬] ---
def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [5. ë¼ìš°íŒ… ë° ì†Œì¼“ ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸ“¢ {data['nickname']}ë‹˜ ì œêµ­ ê°•ë¦¼!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ê¸€ì ìˆ˜ ë³´ìƒ ê³µì‹: ê¸°ë³¸ 50ì› + 10ìë‹¹ 20ì›]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    # [ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ íŒŒì¼ ë³€í™˜]
    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ ëŒ€ìš©ëŸ‰ ë°ì´í„°(ê¸€ììˆ˜: {msg_len})ê°€ íŒŒì¼ë¡œ ë³€í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.\nğŸ”— ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ íŒë…]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        emit('message', {'msg': f"ğŸ’° {nick}ë‹˜ ìì‚° | í˜„ê¸ˆ: {user['money']}â‚© | ì€í–‰: {user['bank_money']}â‚© | ë“±ê¸‰: {'ì´ˆì›”ì' if user['money']>1000000 else 'í‰ë¯¼'}", 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt}â‚© ì €ê¸ˆ ì„±ê³µ! (ë§¤ë¶„ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ {amt}â‚© ì¶œê¸ˆ ì„±ê³µ!", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ ê°€ë™!", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆì„ ì¤‘ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            res = client.models.generate_content(model="gemini-2.0-flash", contents=msg[8:])
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except: pass

    elif cmd == "!ëª…ë ¹ì–´":
        emit('message', {'msg': "ğŸ“œ !ì”ì•¡, !ì €ê¸ˆ [ì•¡ìˆ˜], !ì¶œê¸ˆ [ì•¡ìˆ˜], !ë‡Œì ˆ, !ë‡Œì ˆì¤‘ë‹¨, !gemini [ì§ˆë¬¸]", 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ… ì „ì†¡
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=interest_system, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í´ë”] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "empire_master.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
# ëª¨ë“  í™˜ê²½ í˜¸í™˜ì„ ìœ„í•œ threading ëª¨ë“œ
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {} # ë‡Œì ˆ ìƒíƒœ ì €ì¥ìš©

# Gemini AI (ì„¤ì¹˜ë˜ì–´ ìˆì„ ê²½ìš°ë§Œ)
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key: client = genai.Client(api_key=api_key)
except: pass

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("CREATE TABLE IF NOT EXISTS users (nickname TEXT PRIMARY KEY, money INTEGER DEFAULT 1000, bank_money INTEGER DEFAULT 0)")
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ì‹œìŠ¤í…œ]
def interest_system():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤
        with sqlite3.connect(DB_FILE) as conn:
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()

# --- [3. ë‡Œì ˆ(ë¬´í•œ ë£¨í”„) ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 100
        # ë‡Œì ˆ íŒ¨í„´ ìƒì„±
        pattern = f"[:[{nick}].{m_count}â‚©:] " * 5
        reward = 5000
        update_money(nick, reward, bank=True) # ì€í–‰ìœ¼ë¡œ ë°”ë¡œ ì…ê¸ˆ
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"ğŸŒ€ ë‡Œì ˆ ì‹œìŠ¤í…œ ê°€ë™ ì¤‘... \nğŸ’° ì€í–‰ ì…ê¸ˆ: +{reward}â‚©\n{pattern}", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3) # 3ì´ˆ ê°„ê²© ë‡Œì ˆ

# --- [4. ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ ì²˜ë¦¬] ---
def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [5. ë¼ìš°íŒ… ë° ì†Œì¼“ ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸ“¢ {data['nickname']}ë‹˜ ì œêµ­ ê°•ë¦¼!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ê¸€ì ìˆ˜ ë³´ìƒ ê³µì‹: ê¸°ë³¸ 50ì› + 10ìë‹¹ 20ì›]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    # [ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ íŒŒì¼ ë³€í™˜]
    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ ëŒ€ìš©ëŸ‰ ë°ì´í„°(ê¸€ììˆ˜: {msg_len})ê°€ íŒŒì¼ë¡œ ë³€í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.\nğŸ”— ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ íŒë…]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        emit('message', {'msg': f"ğŸ’° {nick}ë‹˜ ìì‚° | í˜„ê¸ˆ: {user['money']}â‚© | ì€í–‰: {user['bank_money']}â‚© | ë“±ê¸‰: {'ì´ˆì›”ì' if user['money']>1000000 else 'í‰ë¯¼'}", 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt}â‚© ì €ê¸ˆ ì„±ê³µ! (ë§¤ë¶„ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ {amt}â‚© ì¶œê¸ˆ ì„±ê³µ!", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ ê°€ë™!", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆì„ ì¤‘ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            res = client.models.generate_content(model="gemini-2.0-flash", contents=msg[8:])
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except: pass

    elif cmd == "!ëª…ë ¹ì–´":
        emit('message', {'msg': "ğŸ“œ !ì”ì•¡, !ì €ê¸ˆ [ì•¡ìˆ˜], !ì¶œê¸ˆ [ì•¡ìˆ˜], !ë‡Œì ˆ, !ë‡Œì ˆì¤‘ë‹¨, !gemini [ì§ˆë¬¸]", 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ… ì „ì†¡
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=interest_system, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í´ë”] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "empire_master.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
# ëª¨ë“  í™˜ê²½ í˜¸í™˜ì„ ìœ„í•œ threading ëª¨ë“œ
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {} # ë‡Œì ˆ ìƒíƒœ ì €ì¥ìš©

# Gemini AI (ì„¤ì¹˜ë˜ì–´ ìˆì„ ê²½ìš°ë§Œ)
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key: client = genai.Client(api_key=api_key)
except: pass

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("CREATE TABLE IF NOT EXISTS users (nickname TEXT PRIMARY KEY, money INTEGER DEFAULT 1000, bank_money INTEGER DEFAULT 0)")
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ì‹œìŠ¤í…œ]
def interest_system():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤
        with sqlite3.connect(DB_FILE) as conn:
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()

# --- [3. ë‡Œì ˆ(ë¬´í•œ ë£¨í”„) ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 100
        # ë‡Œì ˆ íŒ¨í„´ ìƒì„±
        pattern = f"[:[{nick}].{m_count}â‚©:] " * 5
        reward = 5000
        update_money(nick, reward, bank=True) # ì€í–‰ìœ¼ë¡œ ë°”ë¡œ ì…ê¸ˆ
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"ğŸŒ€ ë‡Œì ˆ ì‹œìŠ¤í…œ ê°€ë™ ì¤‘... \nğŸ’° ì€í–‰ ì…ê¸ˆ: +{reward}â‚©\n{pattern}", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3) # 3ì´ˆ ê°„ê²© ë‡Œì ˆ

# --- [4. ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ ì²˜ë¦¬] ---
def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [5. ë¼ìš°íŒ… ë° ì†Œì¼“ ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸ“¢ {data['nickname']}ë‹˜ ì œêµ­ ê°•ë¦¼!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ê¸€ì ìˆ˜ ë³´ìƒ ê³µì‹: ê¸°ë³¸ 50ì› + 10ìë‹¹ 20ì›]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    # [ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ íŒŒì¼ ë³€í™˜]
    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ ëŒ€ìš©ëŸ‰ ë°ì´í„°(ê¸€ììˆ˜: {msg_len})ê°€ íŒŒì¼ë¡œ ë³€í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.\nğŸ”— ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ íŒë…]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        emit('message', {'msg': f"ğŸ’° {nick}ë‹˜ ìì‚° | í˜„ê¸ˆ: {user['money']}â‚© | ì€í–‰: {user['bank_money']}â‚© | ë“±ê¸‰: {'ì´ˆì›”ì' if user['money']>1000000 else 'í‰ë¯¼'}", 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt}â‚© ì €ê¸ˆ ì„±ê³µ! (ë§¤ë¶„ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ {amt}â‚© ì¶œê¸ˆ ì„±ê³µ!", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ ê°€ë™!", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆì„ ì¤‘ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            res = client.models.generate_content(model="gemini-2.0-flash", contents=msg[8:])
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except: pass

    elif cmd == "!ëª…ë ¹ì–´":
        emit('message', {'msg': "ğŸ“œ !ì”ì•¡, !ì €ê¸ˆ [ì•¡ìˆ˜], !ì¶œê¸ˆ [ì•¡ìˆ˜], !ë‡Œì ˆ, !ë‡Œì ˆì¤‘ë‹¨, !gemini [ì§ˆë¬¸]", 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ… ì „ì†¡
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=interest_system, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í´ë”] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "empire_master.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
# ëª¨ë“  í™˜ê²½ í˜¸í™˜ì„ ìœ„í•œ threading ëª¨ë“œ
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {} # ë‡Œì ˆ ìƒíƒœ ì €ì¥ìš©

# Gemini AI (ì„¤ì¹˜ë˜ì–´ ìˆì„ ê²½ìš°ë§Œ)
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key: client = genai.Client(api_key=api_key)
except: pass

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("CREATE TABLE IF NOT EXISTS users (nickname TEXT PRIMARY KEY, money INTEGER DEFAULT 1000, bank_money INTEGER DEFAULT 0)")
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ì‹œìŠ¤í…œ]
def interest_system():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤
        with sqlite3.connect(DB_FILE) as conn:
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()

# --- [3. ë‡Œì ˆ(ë¬´í•œ ë£¨í”„) ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 100
        # ë‡Œì ˆ íŒ¨í„´ ìƒì„±
        pattern = f"[:[{nick}].{m_count}â‚©:] " * 5
        reward = 5000
        update_money(nick, reward, bank=True) # ì€í–‰ìœ¼ë¡œ ë°”ë¡œ ì…ê¸ˆ
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"ğŸŒ€ ë‡Œì ˆ ì‹œìŠ¤í…œ ê°€ë™ ì¤‘... \nğŸ’° ì€í–‰ ì…ê¸ˆ: +{reward}â‚©\n{pattern}", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3) # 3ì´ˆ ê°„ê²© ë‡Œì ˆ

# --- [4. ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ ì²˜ë¦¬] ---
def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [5. ë¼ìš°íŒ… ë° ì†Œì¼“ ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸ“¢ {data['nickname']}ë‹˜ ì œêµ­ ê°•ë¦¼!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ê¸€ì ìˆ˜ ë³´ìƒ ê³µì‹: ê¸°ë³¸ 50ì› + 10ìë‹¹ 20ì›]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    # [ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ íŒŒì¼ ë³€í™˜]
    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ ëŒ€ìš©ëŸ‰ ë°ì´í„°(ê¸€ììˆ˜: {msg_len})ê°€ íŒŒì¼ë¡œ ë³€í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.\nğŸ”— ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ íŒë…]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        emit('message', {'msg': f"ğŸ’° {nick}ë‹˜ ìì‚° | í˜„ê¸ˆ: {user['money']}â‚© | ì€í–‰: {user['bank_money']}â‚© | ë“±ê¸‰: {'ì´ˆì›”ì' if user['money']>1000000 else 'í‰ë¯¼'}", 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt}â‚© ì €ê¸ˆ ì„±ê³µ! (ë§¤ë¶„ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ {amt}â‚© ì¶œê¸ˆ ì„±ê³µ!", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ ê°€ë™!", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆì„ ì¤‘ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            res = client.models.generate_content(model="gemini-2.0-flash", contents=msg[8:])
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except: pass

    elif cmd == "!ëª…ë ¹ì–´":
        emit('message', {'msg': "ğŸ“œ !ì”ì•¡, !ì €ê¸ˆ [ì•¡ìˆ˜], !ì¶œê¸ˆ [ì•¡ìˆ˜], !ë‡Œì ˆ, !ë‡Œì ˆì¤‘ë‹¨, !gemini [ì§ˆë¬¸]", 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ… ì „ì†¡
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=interest_system, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í´ë”] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "empire_master.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
# ëª¨ë“  í™˜ê²½ í˜¸í™˜ì„ ìœ„í•œ threading ëª¨ë“œ
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {} # ë‡Œì ˆ ìƒíƒœ ì €ì¥ìš©

# Gemini AI (ì„¤ì¹˜ë˜ì–´ ìˆì„ ê²½ìš°ë§Œ)
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key: client = genai.Client(api_key=api_key)
except: pass

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("CREATE TABLE IF NOT EXISTS users (nickname TEXT PRIMARY KEY, money INTEGER DEFAULT 1000, bank_money INTEGER DEFAULT 0)")
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ì‹œìŠ¤í…œ]
def interest_system():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤
        with sqlite3.connect(DB_FILE) as conn:
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()

# --- [3. ë‡Œì ˆ(ë¬´í•œ ë£¨í”„) ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 100
        # ë‡Œì ˆ íŒ¨í„´ ìƒì„±
        pattern = f"[:[{nick}].{m_count}â‚©:] " * 5
        reward = 5000
        update_money(nick, reward, bank=True) # ì€í–‰ìœ¼ë¡œ ë°”ë¡œ ì…ê¸ˆ
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"ğŸŒ€ ë‡Œì ˆ ì‹œìŠ¤í…œ ê°€ë™ ì¤‘... \nğŸ’° ì€í–‰ ì…ê¸ˆ: +{reward}â‚©\n{pattern}", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3) # 3ì´ˆ ê°„ê²© ë‡Œì ˆ

# --- [4. ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ ì²˜ë¦¬] ---
def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [5. ë¼ìš°íŒ… ë° ì†Œì¼“ ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸ“¢ {data['nickname']}ë‹˜ ì œêµ­ ê°•ë¦¼!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ê¸€ì ìˆ˜ ë³´ìƒ ê³µì‹: ê¸°ë³¸ 50ì› + 10ìë‹¹ 20ì›]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    # [ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ íŒŒì¼ ë³€í™˜]
    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ ëŒ€ìš©ëŸ‰ ë°ì´í„°(ê¸€ììˆ˜: {msg_len})ê°€ íŒŒì¼ë¡œ ë³€í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.\nğŸ”— ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ íŒë…]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        emit('message', {'msg': f"ğŸ’° {nick}ë‹˜ ìì‚° | í˜„ê¸ˆ: {user['money']}â‚© | ì€í–‰: {user['bank_money']}â‚© | ë“±ê¸‰: {'ì´ˆì›”ì' if user['money']>1000000 else 'í‰ë¯¼'}", 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt}â‚© ì €ê¸ˆ ì„±ê³µ! (ë§¤ë¶„ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ {amt}â‚© ì¶œê¸ˆ ì„±ê³µ!", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ ê°€ë™!", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆì„ ì¤‘ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            res = client.models.generate_content(model="gemini-2.0-flash", contents=msg[8:])
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except: pass

    elif cmd == "!ëª…ë ¹ì–´":
        emit('message', {'msg': "ğŸ“œ !ì”ì•¡, !ì €ê¸ˆ [ì•¡ìˆ˜], !ì¶œê¸ˆ [ì•¡ìˆ˜], !ë‡Œì ˆ, !ë‡Œì ˆì¤‘ë‹¨, !gemini [ì§ˆë¬¸]", 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ… ì „ì†¡
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=interest_system, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í´ë”] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "empire_master.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
# ëª¨ë“  í™˜ê²½ í˜¸í™˜ì„ ìœ„í•œ threading ëª¨ë“œ
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {} # ë‡Œì ˆ ìƒíƒœ ì €ì¥ìš©

# Gemini AI (ì„¤ì¹˜ë˜ì–´ ìˆì„ ê²½ìš°ë§Œ)
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key: client = genai.Client(api_key=api_key)
except: pass

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("CREATE TABLE IF NOT EXISTS users (nickname TEXT PRIMARY KEY, money INTEGER DEFAULT 1000, bank_money INTEGER DEFAULT 0)")
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ì‹œìŠ¤í…œ]
def interest_system():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤
        with sqlite3.connect(DB_FILE) as conn:
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()

# --- [3. ë‡Œì ˆ(ë¬´í•œ ë£¨í”„) ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 100
        # ë‡Œì ˆ íŒ¨í„´ ìƒì„±
        pattern = f"[:[{nick}].{m_count}â‚©:] " * 5
        reward = 5000
        update_money(nick, reward, bank=True) # ì€í–‰ìœ¼ë¡œ ë°”ë¡œ ì…ê¸ˆ
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"ğŸŒ€ ë‡Œì ˆ ì‹œìŠ¤í…œ ê°€ë™ ì¤‘... \nğŸ’° ì€í–‰ ì…ê¸ˆ: +{reward}â‚©\n{pattern}", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3) # 3ì´ˆ ê°„ê²© ë‡Œì ˆ

# --- [4. ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ ì²˜ë¦¬] ---
def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [5. ë¼ìš°íŒ… ë° ì†Œì¼“ ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸ“¢ {data['nickname']}ë‹˜ ì œêµ­ ê°•ë¦¼!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ê¸€ì ìˆ˜ ë³´ìƒ ê³µì‹: ê¸°ë³¸ 50ì› + 10ìë‹¹ 20ì›]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    # [ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ íŒŒì¼ ë³€í™˜]
    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ ëŒ€ìš©ëŸ‰ ë°ì´í„°(ê¸€ììˆ˜: {msg_len})ê°€ íŒŒì¼ë¡œ ë³€í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.\nğŸ”— ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ íŒë…]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        emit('message', {'msg': f"ğŸ’° {nick}ë‹˜ ìì‚° | í˜„ê¸ˆ: {user['money']}â‚© | ì€í–‰: {user['bank_money']}â‚© | ë“±ê¸‰: {'ì´ˆì›”ì' if user['money']>1000000 else 'í‰ë¯¼'}", 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt}â‚© ì €ê¸ˆ ì„±ê³µ! (ë§¤ë¶„ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ {amt}â‚© ì¶œê¸ˆ ì„±ê³µ!", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ ê°€ë™!", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆì„ ì¤‘ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            res = client.models.generate_content(model="gemini-2.0-flash", contents=msg[8:])
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except: pass

    elif cmd == "!ëª…ë ¹ì–´":
        emit('message', {'msg': "ğŸ“œ !ì”ì•¡, !ì €ê¸ˆ [ì•¡ìˆ˜], !ì¶œê¸ˆ [ì•¡ìˆ˜], !ë‡Œì ˆ, !ë‡Œì ˆì¤‘ë‹¨, !gemini [ì§ˆë¬¸]", 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ… ì „ì†¡
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=interest_system, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í´ë”] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "empire_master.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
# ëª¨ë“  í™˜ê²½ í˜¸í™˜ì„ ìœ„í•œ threading ëª¨ë“œ
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {} # ë‡Œì ˆ ìƒíƒœ ì €ì¥ìš©

# Gemini AI (ì„¤ì¹˜ë˜ì–´ ìˆì„ ê²½ìš°ë§Œ)
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key: client = genai.Client(api_key=api_key)
except: pass

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("CREATE TABLE IF NOT EXISTS users (nickname TEXT PRIMARY KEY, money INTEGER DEFAULT 1000, bank_money INTEGER DEFAULT 0)")
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ì‹œìŠ¤í…œ]
def interest_system():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤
        with sqlite3.connect(DB_FILE) as conn:
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()

# --- [3. ë‡Œì ˆ(ë¬´í•œ ë£¨í”„) ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 100
        # ë‡Œì ˆ íŒ¨í„´ ìƒì„±
        pattern = f"[:[{nick}].{m_count}â‚©:] " * 5
        reward = 5000
        update_money(nick, reward, bank=True) # ì€í–‰ìœ¼ë¡œ ë°”ë¡œ ì…ê¸ˆ
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"ğŸŒ€ ë‡Œì ˆ ì‹œìŠ¤í…œ ê°€ë™ ì¤‘... \nğŸ’° ì€í–‰ ì…ê¸ˆ: +{reward}â‚©\n{pattern}", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3) # 3ì´ˆ ê°„ê²© ë‡Œì ˆ

# --- [4. ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ ì²˜ë¦¬] ---
def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [5. ë¼ìš°íŒ… ë° ì†Œì¼“ ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸ“¢ {data['nickname']}ë‹˜ ì œêµ­ ê°•ë¦¼!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ê¸€ì ìˆ˜ ë³´ìƒ ê³µì‹: ê¸°ë³¸ 50ì› + 10ìë‹¹ 20ì›]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    # [ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ íŒŒì¼ ë³€í™˜]
    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ ëŒ€ìš©ëŸ‰ ë°ì´í„°(ê¸€ììˆ˜: {msg_len})ê°€ íŒŒì¼ë¡œ ë³€í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.\nğŸ”— ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ íŒë…]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        emit('message', {'msg': f"ğŸ’° {nick}ë‹˜ ìì‚° | í˜„ê¸ˆ: {user['money']}â‚© | ì€í–‰: {user['bank_money']}â‚© | ë“±ê¸‰: {'ì´ˆì›”ì' if user['money']>1000000 else 'í‰ë¯¼'}", 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt}â‚© ì €ê¸ˆ ì„±ê³µ! (ë§¤ë¶„ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ {amt}â‚© ì¶œê¸ˆ ì„±ê³µ!", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ ê°€ë™!", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆì„ ì¤‘ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            res = client.models.generate_content(model="gemini-2.0-flash", contents=msg[8:])
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except: pass

    elif cmd == "!ëª…ë ¹ì–´":
        emit('message', {'msg': "ğŸ“œ !ì”ì•¡, !ì €ê¸ˆ [ì•¡ìˆ˜], !ì¶œê¸ˆ [ì•¡ìˆ˜], !ë‡Œì ˆ, !ë‡Œì ˆì¤‘ë‹¨, !gemini [ì§ˆë¬¸]", 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ… ì „ì†¡
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=interest_system, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í´ë”] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "empire_master.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
# ëª¨ë“  í™˜ê²½ í˜¸í™˜ì„ ìœ„í•œ threading ëª¨ë“œ
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {} # ë‡Œì ˆ ìƒíƒœ ì €ì¥ìš©

# Gemini AI (ì„¤ì¹˜ë˜ì–´ ìˆì„ ê²½ìš°ë§Œ)
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key: client = genai.Client(api_key=api_key)
except: pass

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("CREATE TABLE IF NOT EXISTS users (nickname TEXT PRIMARY KEY, money INTEGER DEFAULT 1000, bank_money INTEGER DEFAULT 0)")
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ì‹œìŠ¤í…œ]
def interest_system():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤
        with sqlite3.connect(DB_FILE) as conn:
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()

# --- [3. ë‡Œì ˆ(ë¬´í•œ ë£¨í”„) ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 100
        # ë‡Œì ˆ íŒ¨í„´ ìƒì„±
        pattern = f"[:[{nick}].{m_count}â‚©:] " * 5
        reward = 5000
        update_money(nick, reward, bank=True) # ì€í–‰ìœ¼ë¡œ ë°”ë¡œ ì…ê¸ˆ
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"ğŸŒ€ ë‡Œì ˆ ì‹œìŠ¤í…œ ê°€ë™ ì¤‘... \nğŸ’° ì€í–‰ ì…ê¸ˆ: +{reward}â‚©\n{pattern}", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3) # 3ì´ˆ ê°„ê²© ë‡Œì ˆ

# --- [4. ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ ì²˜ë¦¬] ---
def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [5. ë¼ìš°íŒ… ë° ì†Œì¼“ ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸ“¢ {data['nickname']}ë‹˜ ì œêµ­ ê°•ë¦¼!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ê¸€ì ìˆ˜ ë³´ìƒ ê³µì‹: ê¸°ë³¸ 50ì› + 10ìë‹¹ 20ì›]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    # [ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ íŒŒì¼ ë³€í™˜]
    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ ëŒ€ìš©ëŸ‰ ë°ì´í„°(ê¸€ììˆ˜: {msg_len})ê°€ íŒŒì¼ë¡œ ë³€í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.\nğŸ”— ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ íŒë…]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        emit('message', {'msg': f"ğŸ’° {nick}ë‹˜ ìì‚° | í˜„ê¸ˆ: {user['money']}â‚© | ì€í–‰: {user['bank_money']}â‚© | ë“±ê¸‰: {'ì´ˆì›”ì' if user['money']>1000000 else 'í‰ë¯¼'}", 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt}â‚© ì €ê¸ˆ ì„±ê³µ! (ë§¤ë¶„ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ {amt}â‚© ì¶œê¸ˆ ì„±ê³µ!", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ ê°€ë™!", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆì„ ì¤‘ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            res = client.models.generate_content(model="gemini-2.0-flash", contents=msg[8:])
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except: pass

    elif cmd == "!ëª…ë ¹ì–´":
        emit('message', {'msg': "ğŸ“œ !ì”ì•¡, !ì €ê¸ˆ [ì•¡ìˆ˜], !ì¶œê¸ˆ [ì•¡ìˆ˜], !ë‡Œì ˆ, !ë‡Œì ˆì¤‘ë‹¨, !gemini [ì§ˆë¬¸]", 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ… ì „ì†¡
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=interest_system, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í´ë”] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "empire_master.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
# ëª¨ë“  í™˜ê²½ í˜¸í™˜ì„ ìœ„í•œ threading ëª¨ë“œ
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {} # ë‡Œì ˆ ìƒíƒœ ì €ì¥ìš©

# Gemini AI (ì„¤ì¹˜ë˜ì–´ ìˆì„ ê²½ìš°ë§Œ)
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key: client = genai.Client(api_key=api_key)
except: pass

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("CREATE TABLE IF NOT EXISTS users (nickname TEXT PRIMARY KEY, money INTEGER DEFAULT 1000, bank_money INTEGER DEFAULT 0)")
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ì‹œìŠ¤í…œ]
def interest_system():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤
        with sqlite3.connect(DB_FILE) as conn:
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()

# --- [3. ë‡Œì ˆ(ë¬´í•œ ë£¨í”„) ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 100
        # ë‡Œì ˆ íŒ¨í„´ ìƒì„±
        pattern = f"[:[{nick}].{m_count}â‚©:] " * 5
        reward = 5000
        update_money(nick, reward, bank=True) # ì€í–‰ìœ¼ë¡œ ë°”ë¡œ ì…ê¸ˆ
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"ğŸŒ€ ë‡Œì ˆ ì‹œìŠ¤í…œ ê°€ë™ ì¤‘... \nğŸ’° ì€í–‰ ì…ê¸ˆ: +{reward}â‚©\n{pattern}", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3) # 3ì´ˆ ê°„ê²© ë‡Œì ˆ

# --- [4. ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ ì²˜ë¦¬] ---
def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [5. ë¼ìš°íŒ… ë° ì†Œì¼“ ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸ“¢ {data['nickname']}ë‹˜ ì œêµ­ ê°•ë¦¼!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ê¸€ì ìˆ˜ ë³´ìƒ ê³µì‹: ê¸°ë³¸ 50ì› + 10ìë‹¹ 20ì›]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    # [ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ íŒŒì¼ ë³€í™˜]
    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ ëŒ€ìš©ëŸ‰ ë°ì´í„°(ê¸€ììˆ˜: {msg_len})ê°€ íŒŒì¼ë¡œ ë³€í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.\nğŸ”— ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ íŒë…]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        emit('message', {'msg': f"ğŸ’° {nick}ë‹˜ ìì‚° | í˜„ê¸ˆ: {user['money']}â‚© | ì€í–‰: {user['bank_money']}â‚© | ë“±ê¸‰: {'ì´ˆì›”ì' if user['money']>1000000 else 'í‰ë¯¼'}", 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt}â‚© ì €ê¸ˆ ì„±ê³µ! (ë§¤ë¶„ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ {amt}â‚© ì¶œê¸ˆ ì„±ê³µ!", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ ê°€ë™!", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆì„ ì¤‘ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            res = client.models.generate_content(model="gemini-2.0-flash", contents=msg[8:])
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except: pass

    elif cmd == "!ëª…ë ¹ì–´":
        emit('message', {'msg': "ğŸ“œ !ì”ì•¡, !ì €ê¸ˆ [ì•¡ìˆ˜], !ì¶œê¸ˆ [ì•¡ìˆ˜], !ë‡Œì ˆ, !ë‡Œì ˆì¤‘ë‹¨, !gemini [ì§ˆë¬¸]", 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ… ì „ì†¡
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=interest_system, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í´ë”] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "empire_master.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
# ëª¨ë“  í™˜ê²½ í˜¸í™˜ì„ ìœ„í•œ threading ëª¨ë“œ
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {} # ë‡Œì ˆ ìƒíƒœ ì €ì¥ìš©

# Gemini AI (ì„¤ì¹˜ë˜ì–´ ìˆì„ ê²½ìš°ë§Œ)
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key: client = genai.Client(api_key=api_key)
except: pass

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("CREATE TABLE IF NOT EXISTS users (nickname TEXT PRIMARY KEY, money INTEGER DEFAULT 1000, bank_money INTEGER DEFAULT 0)")
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ì‹œìŠ¤í…œ]
def interest_system():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤
        with sqlite3.connect(DB_FILE) as conn:
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()

# --- [3. ë‡Œì ˆ(ë¬´í•œ ë£¨í”„) ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 100
        # ë‡Œì ˆ íŒ¨í„´ ìƒì„±
        pattern = f"[:[{nick}].{m_count}â‚©:] " * 5
        reward = 5000
        update_money(nick, reward, bank=True) # ì€í–‰ìœ¼ë¡œ ë°”ë¡œ ì…ê¸ˆ
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"ğŸŒ€ ë‡Œì ˆ ì‹œìŠ¤í…œ ê°€ë™ ì¤‘... \nğŸ’° ì€í–‰ ì…ê¸ˆ: +{reward}â‚©\n{pattern}", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3) # 3ì´ˆ ê°„ê²© ë‡Œì ˆ

# --- [4. ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ ì²˜ë¦¬] ---
def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [5. ë¼ìš°íŒ… ë° ì†Œì¼“ ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸ“¢ {data['nickname']}ë‹˜ ì œêµ­ ê°•ë¦¼!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ê¸€ì ìˆ˜ ë³´ìƒ ê³µì‹: ê¸°ë³¸ 50ì› + 10ìë‹¹ 20ì›]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    # [ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ íŒŒì¼ ë³€í™˜]
    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ ëŒ€ìš©ëŸ‰ ë°ì´í„°(ê¸€ììˆ˜: {msg_len})ê°€ íŒŒì¼ë¡œ ë³€í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.\nğŸ”— ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ íŒë…]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        emit('message', {'msg': f"ğŸ’° {nick}ë‹˜ ìì‚° | í˜„ê¸ˆ: {user['money']}â‚© | ì€í–‰: {user['bank_money']}â‚© | ë“±ê¸‰: {'ì´ˆì›”ì' if user['money']>1000000 else 'í‰ë¯¼'}", 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt}â‚© ì €ê¸ˆ ì„±ê³µ! (ë§¤ë¶„ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ {amt}â‚© ì¶œê¸ˆ ì„±ê³µ!", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ ê°€ë™!", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆì„ ì¤‘ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            res = client.models.generate_content(model="gemini-2.0-flash", contents=msg[8:])
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except: pass

    elif cmd == "!ëª…ë ¹ì–´":
        emit('message', {'msg': "ğŸ“œ !ì”ì•¡, !ì €ê¸ˆ [ì•¡ìˆ˜], !ì¶œê¸ˆ [ì•¡ìˆ˜], !ë‡Œì ˆ, !ë‡Œì ˆì¤‘ë‹¨, !gemini [ì§ˆë¬¸]", 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ… ì „ì†¡
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=interest_system, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í´ë”] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "empire_master.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
# ëª¨ë“  í™˜ê²½ í˜¸í™˜ì„ ìœ„í•œ threading ëª¨ë“œ
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {} # ë‡Œì ˆ ìƒíƒœ ì €ì¥ìš©

# Gemini AI (ì„¤ì¹˜ë˜ì–´ ìˆì„ ê²½ìš°ë§Œ)
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key: client = genai.Client(api_key=api_key)
except: pass

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("CREATE TABLE IF NOT EXISTS users (nickname TEXT PRIMARY KEY, money INTEGER DEFAULT 1000, bank_money INTEGER DEFAULT 0)")
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ì‹œìŠ¤í…œ]
def interest_system():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤
        with sqlite3.connect(DB_FILE) as conn:
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()

# --- [3. ë‡Œì ˆ(ë¬´í•œ ë£¨í”„) ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 100
        # ë‡Œì ˆ íŒ¨í„´ ìƒì„±
        pattern = f"[:[{nick}].{m_count}â‚©:] " * 5
        reward = 5000
        update_money(nick, reward, bank=True) # ì€í–‰ìœ¼ë¡œ ë°”ë¡œ ì…ê¸ˆ
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"ğŸŒ€ ë‡Œì ˆ ì‹œìŠ¤í…œ ê°€ë™ ì¤‘... \nğŸ’° ì€í–‰ ì…ê¸ˆ: +{reward}â‚©\n{pattern}", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3) # 3ì´ˆ ê°„ê²© ë‡Œì ˆ

# --- [4. ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ ì²˜ë¦¬] ---
def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [5. ë¼ìš°íŒ… ë° ì†Œì¼“ ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸ“¢ {data['nickname']}ë‹˜ ì œêµ­ ê°•ë¦¼!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ê¸€ì ìˆ˜ ë³´ìƒ ê³µì‹: ê¸°ë³¸ 50ì› + 10ìë‹¹ 20ì›]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    # [ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ íŒŒì¼ ë³€í™˜]
    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ ëŒ€ìš©ëŸ‰ ë°ì´í„°(ê¸€ììˆ˜: {msg_len})ê°€ íŒŒì¼ë¡œ ë³€í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.\nğŸ”— ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ íŒë…]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        emit('message', {'msg': f"ğŸ’° {nick}ë‹˜ ìì‚° | í˜„ê¸ˆ: {user['money']}â‚© | ì€í–‰: {user['bank_money']}â‚© | ë“±ê¸‰: {'ì´ˆì›”ì' if user['money']>1000000 else 'í‰ë¯¼'}", 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt}â‚© ì €ê¸ˆ ì„±ê³µ! (ë§¤ë¶„ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ {amt}â‚© ì¶œê¸ˆ ì„±ê³µ!", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ ê°€ë™!", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆì„ ì¤‘ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            res = client.models.generate_content(model="gemini-2.0-flash", contents=msg[8:])
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except: pass

    elif cmd == "!ëª…ë ¹ì–´":
        emit('message', {'msg': "ğŸ“œ !ì”ì•¡, !ì €ê¸ˆ [ì•¡ìˆ˜], !ì¶œê¸ˆ [ì•¡ìˆ˜], !ë‡Œì ˆ, !ë‡Œì ˆì¤‘ë‹¨, !gemini [ì§ˆë¬¸]", 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ… ì „ì†¡
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=interest_system, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í´ë”] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "empire_master.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
# ëª¨ë“  í™˜ê²½ í˜¸í™˜ì„ ìœ„í•œ threading ëª¨ë“œ
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {} # ë‡Œì ˆ ìƒíƒœ ì €ì¥ìš©

# Gemini AI (ì„¤ì¹˜ë˜ì–´ ìˆì„ ê²½ìš°ë§Œ)
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key: client = genai.Client(api_key=api_key)
except: pass

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("CREATE TABLE IF NOT EXISTS users (nickname TEXT PRIMARY KEY, money INTEGER DEFAULT 1000, bank_money INTEGER DEFAULT 0)")
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ì‹œìŠ¤í…œ]
def interest_system():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤
        with sqlite3.connect(DB_FILE) as conn:
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()

# --- [3. ë‡Œì ˆ(ë¬´í•œ ë£¨í”„) ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 100
        # ë‡Œì ˆ íŒ¨í„´ ìƒì„±
        pattern = f"[:[{nick}].{m_count}â‚©:] " * 5
        reward = 5000
        update_money(nick, reward, bank=True) # ì€í–‰ìœ¼ë¡œ ë°”ë¡œ ì…ê¸ˆ
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"ğŸŒ€ ë‡Œì ˆ ì‹œìŠ¤í…œ ê°€ë™ ì¤‘... \nğŸ’° ì€í–‰ ì…ê¸ˆ: +{reward}â‚©\n{pattern}", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3) # 3ì´ˆ ê°„ê²© ë‡Œì ˆ

# --- [4. ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ ì²˜ë¦¬] ---
def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [5. ë¼ìš°íŒ… ë° ì†Œì¼“ ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸ“¢ {data['nickname']}ë‹˜ ì œêµ­ ê°•ë¦¼!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ê¸€ì ìˆ˜ ë³´ìƒ ê³µì‹: ê¸°ë³¸ 50ì› + 10ìë‹¹ 20ì›]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    # [ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ íŒŒì¼ ë³€í™˜]
    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ ëŒ€ìš©ëŸ‰ ë°ì´í„°(ê¸€ììˆ˜: {msg_len})ê°€ íŒŒì¼ë¡œ ë³€í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.\nğŸ”— ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ íŒë…]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        emit('message', {'msg': f"ğŸ’° {nick}ë‹˜ ìì‚° | í˜„ê¸ˆ: {user['money']}â‚© | ì€í–‰: {user['bank_money']}â‚© | ë“±ê¸‰: {'ì´ˆì›”ì' if user['money']>1000000 else 'í‰ë¯¼'}", 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt}â‚© ì €ê¸ˆ ì„±ê³µ! (ë§¤ë¶„ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ {amt}â‚© ì¶œê¸ˆ ì„±ê³µ!", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ ê°€ë™!", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆì„ ì¤‘ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            res = client.models.generate_content(model="gemini-2.0-flash", contents=msg[8:])
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except: pass

    elif cmd == "!ëª…ë ¹ì–´":
        emit('message', {'msg': "ğŸ“œ !ì”ì•¡, !ì €ê¸ˆ [ì•¡ìˆ˜], !ì¶œê¸ˆ [ì•¡ìˆ˜], !ë‡Œì ˆ, !ë‡Œì ˆì¤‘ë‹¨, !gemini [ì§ˆë¬¸]", 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ… ì „ì†¡
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=interest_system, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í´ë”] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "empire_master.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
# ëª¨ë“  í™˜ê²½ í˜¸í™˜ì„ ìœ„í•œ threading ëª¨ë“œ
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {} # ë‡Œì ˆ ìƒíƒœ ì €ì¥ìš©

# Gemini AI (ì„¤ì¹˜ë˜ì–´ ìˆì„ ê²½ìš°ë§Œ)
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key: client = genai.Client(api_key=api_key)
except: pass

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("CREATE TABLE IF NOT EXISTS users (nickname TEXT PRIMARY KEY, money INTEGER DEFAULT 1000, bank_money INTEGER DEFAULT 0)")
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ì‹œìŠ¤í…œ]
def interest_system():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤
        with sqlite3.connect(DB_FILE) as conn:
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()

# --- [3. ë‡Œì ˆ(ë¬´í•œ ë£¨í”„) ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 100
        # ë‡Œì ˆ íŒ¨í„´ ìƒì„±
        pattern = f"[:[{nick}].{m_count}â‚©:] " * 5
        reward = 5000
        update_money(nick, reward, bank=True) # ì€í–‰ìœ¼ë¡œ ë°”ë¡œ ì…ê¸ˆ
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"ğŸŒ€ ë‡Œì ˆ ì‹œìŠ¤í…œ ê°€ë™ ì¤‘... \nğŸ’° ì€í–‰ ì…ê¸ˆ: +{reward}â‚©\n{pattern}", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3) # 3ì´ˆ ê°„ê²© ë‡Œì ˆ

# --- [4. ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ ì²˜ë¦¬] ---
def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [5. ë¼ìš°íŒ… ë° ì†Œì¼“ ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸ“¢ {data['nickname']}ë‹˜ ì œêµ­ ê°•ë¦¼!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ê¸€ì ìˆ˜ ë³´ìƒ ê³µì‹: ê¸°ë³¸ 50ì› + 10ìë‹¹ 20ì›]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    # [ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ íŒŒì¼ ë³€í™˜]
    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ ëŒ€ìš©ëŸ‰ ë°ì´í„°(ê¸€ììˆ˜: {msg_len})ê°€ íŒŒì¼ë¡œ ë³€í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.\nğŸ”— ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ íŒë…]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        emit('message', {'msg': f"ğŸ’° {nick}ë‹˜ ìì‚° | í˜„ê¸ˆ: {user['money']}â‚© | ì€í–‰: {user['bank_money']}â‚© | ë“±ê¸‰: {'ì´ˆì›”ì' if user['money']>1000000 else 'í‰ë¯¼'}", 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt}â‚© ì €ê¸ˆ ì„±ê³µ! (ë§¤ë¶„ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ {amt}â‚© ì¶œê¸ˆ ì„±ê³µ!", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ ê°€ë™!", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆì„ ì¤‘ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            res = client.models.generate_content(model="gemini-2.0-flash", contents=msg[8:])
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except: pass

    elif cmd == "!ëª…ë ¹ì–´":
        emit('message', {'msg': "ğŸ“œ !ì”ì•¡, !ì €ê¸ˆ [ì•¡ìˆ˜], !ì¶œê¸ˆ [ì•¡ìˆ˜], !ë‡Œì ˆ, !ë‡Œì ˆì¤‘ë‹¨, !gemini [ì§ˆë¬¸]", 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ… ì „ì†¡
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=interest_system, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í´ë”] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "empire_master.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
# ëª¨ë“  í™˜ê²½ í˜¸í™˜ì„ ìœ„í•œ threading ëª¨ë“œ
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {} # ë‡Œì ˆ ìƒíƒœ ì €ì¥ìš©

# Gemini AI (ì„¤ì¹˜ë˜ì–´ ìˆì„ ê²½ìš°ë§Œ)
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key: client = genai.Client(api_key=api_key)
except: pass

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("CREATE TABLE IF NOT EXISTS users (nickname TEXT PRIMARY KEY, money INTEGER DEFAULT 1000, bank_money INTEGER DEFAULT 0)")
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ì‹œìŠ¤í…œ]
def interest_system():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤
        with sqlite3.connect(DB_FILE) as conn:
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()

# --- [3. ë‡Œì ˆ(ë¬´í•œ ë£¨í”„) ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 100
        # ë‡Œì ˆ íŒ¨í„´ ìƒì„±
        pattern = f"[:[{nick}].{m_count}â‚©:] " * 5
        reward = 5000
        update_money(nick, reward, bank=True) # ì€í–‰ìœ¼ë¡œ ë°”ë¡œ ì…ê¸ˆ
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"ğŸŒ€ ë‡Œì ˆ ì‹œìŠ¤í…œ ê°€ë™ ì¤‘... \nğŸ’° ì€í–‰ ì…ê¸ˆ: +{reward}â‚©\n{pattern}", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3) # 3ì´ˆ ê°„ê²© ë‡Œì ˆ

# --- [4. ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ ì²˜ë¦¬] ---
def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [5. ë¼ìš°íŒ… ë° ì†Œì¼“ ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸ“¢ {data['nickname']}ë‹˜ ì œêµ­ ê°•ë¦¼!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ê¸€ì ìˆ˜ ë³´ìƒ ê³µì‹: ê¸°ë³¸ 50ì› + 10ìë‹¹ 20ì›]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    # [ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ íŒŒì¼ ë³€í™˜]
    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ ëŒ€ìš©ëŸ‰ ë°ì´í„°(ê¸€ììˆ˜: {msg_len})ê°€ íŒŒì¼ë¡œ ë³€í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.\nğŸ”— ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ íŒë…]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        emit('message', {'msg': f"ğŸ’° {nick}ë‹˜ ìì‚° | í˜„ê¸ˆ: {user['money']}â‚© | ì€í–‰: {user['bank_money']}â‚© | ë“±ê¸‰: {'ì´ˆì›”ì' if user['money']>1000000 else 'í‰ë¯¼'}", 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt}â‚© ì €ê¸ˆ ì„±ê³µ! (ë§¤ë¶„ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ {amt}â‚© ì¶œê¸ˆ ì„±ê³µ!", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ ê°€ë™!", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆì„ ì¤‘ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            res = client.models.generate_content(model="gemini-2.0-flash", contents=msg[8:])
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except: pass

    elif cmd == "!ëª…ë ¹ì–´":
        emit('message', {'msg': "ğŸ“œ !ì”ì•¡, !ì €ê¸ˆ [ì•¡ìˆ˜], !ì¶œê¸ˆ [ì•¡ìˆ˜], !ë‡Œì ˆ, !ë‡Œì ˆì¤‘ë‹¨, !gemini [ì§ˆë¬¸]", 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ… ì „ì†¡
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=interest_system, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í´ë”] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "empire_master.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
# ëª¨ë“  í™˜ê²½ í˜¸í™˜ì„ ìœ„í•œ threading ëª¨ë“œ
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {} # ë‡Œì ˆ ìƒíƒœ ì €ì¥ìš©

# Gemini AI (ì„¤ì¹˜ë˜ì–´ ìˆì„ ê²½ìš°ë§Œ)
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key: client = genai.Client(api_key=api_key)
except: pass

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("CREATE TABLE IF NOT EXISTS users (nickname TEXT PRIMARY KEY, money INTEGER DEFAULT 1000, bank_money INTEGER DEFAULT 0)")
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ì‹œìŠ¤í…œ]
def interest_system():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤
        with sqlite3.connect(DB_FILE) as conn:
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()

# --- [3. ë‡Œì ˆ(ë¬´í•œ ë£¨í”„) ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 100
        # ë‡Œì ˆ íŒ¨í„´ ìƒì„±
        pattern = f"[:[{nick}].{m_count}â‚©:] " * 5
        reward = 5000
        update_money(nick, reward, bank=True) # ì€í–‰ìœ¼ë¡œ ë°”ë¡œ ì…ê¸ˆ
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"ğŸŒ€ ë‡Œì ˆ ì‹œìŠ¤í…œ ê°€ë™ ì¤‘... \nğŸ’° ì€í–‰ ì…ê¸ˆ: +{reward}â‚©\n{pattern}", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3) # 3ì´ˆ ê°„ê²© ë‡Œì ˆ

# --- [4. ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ ì²˜ë¦¬] ---
def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [5. ë¼ìš°íŒ… ë° ì†Œì¼“ ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸ“¢ {data['nickname']}ë‹˜ ì œêµ­ ê°•ë¦¼!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ê¸€ì ìˆ˜ ë³´ìƒ ê³µì‹: ê¸°ë³¸ 50ì› + 10ìë‹¹ 20ì›]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    # [ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ íŒŒì¼ ë³€í™˜]
    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ ëŒ€ìš©ëŸ‰ ë°ì´í„°(ê¸€ììˆ˜: {msg_len})ê°€ íŒŒì¼ë¡œ ë³€í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.\nğŸ”— ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ íŒë…]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        emit('message', {'msg': f"ğŸ’° {nick}ë‹˜ ìì‚° | í˜„ê¸ˆ: {user['money']}â‚© | ì€í–‰: {user['bank_money']}â‚© | ë“±ê¸‰: {'ì´ˆì›”ì' if user['money']>1000000 else 'í‰ë¯¼'}", 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt}â‚© ì €ê¸ˆ ì„±ê³µ! (ë§¤ë¶„ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ {amt}â‚© ì¶œê¸ˆ ì„±ê³µ!", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ ê°€ë™!", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆì„ ì¤‘ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            res = client.models.generate_content(model="gemini-2.0-flash", contents=msg[8:])
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except: pass

    elif cmd == "!ëª…ë ¹ì–´":
        emit('message', {'msg': "ğŸ“œ !ì”ì•¡, !ì €ê¸ˆ [ì•¡ìˆ˜], !ì¶œê¸ˆ [ì•¡ìˆ˜], !ë‡Œì ˆ, !ë‡Œì ˆì¤‘ë‹¨, !gemini [ì§ˆë¬¸]", 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ… ì „ì†¡
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=interest_system, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í´ë”] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "empire_master.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
# ëª¨ë“  í™˜ê²½ í˜¸í™˜ì„ ìœ„í•œ threading ëª¨ë“œ
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {} # ë‡Œì ˆ ìƒíƒœ ì €ì¥ìš©

# Gemini AI (ì„¤ì¹˜ë˜ì–´ ìˆì„ ê²½ìš°ë§Œ)
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key: client = genai.Client(api_key=api_key)
except: pass

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("CREATE TABLE IF NOT EXISTS users (nickname TEXT PRIMARY KEY, money INTEGER DEFAULT 1000, bank_money INTEGER DEFAULT 0)")
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ì‹œìŠ¤í…œ]
def interest_system():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤
        with sqlite3.connect(DB_FILE) as conn:
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()

# --- [3. ë‡Œì ˆ(ë¬´í•œ ë£¨í”„) ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 100
        # ë‡Œì ˆ íŒ¨í„´ ìƒì„±
        pattern = f"[:[{nick}].{m_count}â‚©:] " * 5
        reward = 5000
        update_money(nick, reward, bank=True) # ì€í–‰ìœ¼ë¡œ ë°”ë¡œ ì…ê¸ˆ
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"ğŸŒ€ ë‡Œì ˆ ì‹œìŠ¤í…œ ê°€ë™ ì¤‘... \nğŸ’° ì€í–‰ ì…ê¸ˆ: +{reward}â‚©\n{pattern}", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3) # 3ì´ˆ ê°„ê²© ë‡Œì ˆ

# --- [4. ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ ì²˜ë¦¬] ---
def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [5. ë¼ìš°íŒ… ë° ì†Œì¼“ ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸ“¢ {data['nickname']}ë‹˜ ì œêµ­ ê°•ë¦¼!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ê¸€ì ìˆ˜ ë³´ìƒ ê³µì‹: ê¸°ë³¸ 50ì› + 10ìë‹¹ 20ì›]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    # [ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ íŒŒì¼ ë³€í™˜]
    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ ëŒ€ìš©ëŸ‰ ë°ì´í„°(ê¸€ììˆ˜: {msg_len})ê°€ íŒŒì¼ë¡œ ë³€í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.\nğŸ”— ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ íŒë…]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        emit('message', {'msg': f"ğŸ’° {nick}ë‹˜ ìì‚° | í˜„ê¸ˆ: {user['money']}â‚© | ì€í–‰: {user['bank_money']}â‚© | ë“±ê¸‰: {'ì´ˆì›”ì' if user['money']>1000000 else 'í‰ë¯¼'}", 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt}â‚© ì €ê¸ˆ ì„±ê³µ! (ë§¤ë¶„ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ {amt}â‚© ì¶œê¸ˆ ì„±ê³µ!", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ ê°€ë™!", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆì„ ì¤‘ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            res = client.models.generate_content(model="gemini-2.0-flash", contents=msg[8:])
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except: pass

    elif cmd == "!ëª…ë ¹ì–´":
        emit('message', {'msg': "ğŸ“œ !ì”ì•¡, !ì €ê¸ˆ [ì•¡ìˆ˜], !ì¶œê¸ˆ [ì•¡ìˆ˜], !ë‡Œì ˆ, !ë‡Œì ˆì¤‘ë‹¨, !gemini [ì§ˆë¬¸]", 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ… ì „ì†¡
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=interest_system, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í´ë”] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "empire_master.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
# ëª¨ë“  í™˜ê²½ í˜¸í™˜ì„ ìœ„í•œ threading ëª¨ë“œ
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {} # ë‡Œì ˆ ìƒíƒœ ì €ì¥ìš©

# Gemini AI (ì„¤ì¹˜ë˜ì–´ ìˆì„ ê²½ìš°ë§Œ)
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key: client = genai.Client(api_key=api_key)
except: pass

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("CREATE TABLE IF NOT EXISTS users (nickname TEXT PRIMARY KEY, money INTEGER DEFAULT 1000, bank_money INTEGER DEFAULT 0)")
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ì‹œìŠ¤í…œ]
def interest_system():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤
        with sqlite3.connect(DB_FILE) as conn:
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()

# --- [3. ë‡Œì ˆ(ë¬´í•œ ë£¨í”„) ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 100
        # ë‡Œì ˆ íŒ¨í„´ ìƒì„±
        pattern = f"[:[{nick}].{m_count}â‚©:] " * 5
        reward = 5000
        update_money(nick, reward, bank=True) # ì€í–‰ìœ¼ë¡œ ë°”ë¡œ ì…ê¸ˆ
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"ğŸŒ€ ë‡Œì ˆ ì‹œìŠ¤í…œ ê°€ë™ ì¤‘... \nğŸ’° ì€í–‰ ì…ê¸ˆ: +{reward}â‚©\n{pattern}", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3) # 3ì´ˆ ê°„ê²© ë‡Œì ˆ

# --- [4. ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ ì²˜ë¦¬] ---
def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [5. ë¼ìš°íŒ… ë° ì†Œì¼“ ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸ“¢ {data['nickname']}ë‹˜ ì œêµ­ ê°•ë¦¼!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ê¸€ì ìˆ˜ ë³´ìƒ ê³µì‹: ê¸°ë³¸ 50ì› + 10ìë‹¹ 20ì›]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    # [ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ íŒŒì¼ ë³€í™˜]
    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ ëŒ€ìš©ëŸ‰ ë°ì´í„°(ê¸€ììˆ˜: {msg_len})ê°€ íŒŒì¼ë¡œ ë³€í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.\nğŸ”— ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ íŒë…]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        emit('message', {'msg': f"ğŸ’° {nick}ë‹˜ ìì‚° | í˜„ê¸ˆ: {user['money']}â‚© | ì€í–‰: {user['bank_money']}â‚© | ë“±ê¸‰: {'ì´ˆì›”ì' if user['money']>1000000 else 'í‰ë¯¼'}", 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt}â‚© ì €ê¸ˆ ì„±ê³µ! (ë§¤ë¶„ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ {amt}â‚© ì¶œê¸ˆ ì„±ê³µ!", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ ê°€ë™!", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆì„ ì¤‘ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            res = client.models.generate_content(model="gemini-2.0-flash", contents=msg[8:])
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except: pass

    elif cmd == "!ëª…ë ¹ì–´":
        emit('message', {'msg': "ğŸ“œ !ì”ì•¡, !ì €ê¸ˆ [ì•¡ìˆ˜], !ì¶œê¸ˆ [ì•¡ìˆ˜], !ë‡Œì ˆ, !ë‡Œì ˆì¤‘ë‹¨, !gemini [ì§ˆë¬¸]", 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ… ì „ì†¡
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=interest_system, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í´ë”] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "empire_master.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
# ëª¨ë“  í™˜ê²½ í˜¸í™˜ì„ ìœ„í•œ threading ëª¨ë“œ
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {} # ë‡Œì ˆ ìƒíƒœ ì €ì¥ìš©

# Gemini AI (ì„¤ì¹˜ë˜ì–´ ìˆì„ ê²½ìš°ë§Œ)
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key: client = genai.Client(api_key=api_key)
except: pass

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("CREATE TABLE IF NOT EXISTS users (nickname TEXT PRIMARY KEY, money INTEGER DEFAULT 1000, bank_money INTEGER DEFAULT 0)")
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ì‹œìŠ¤í…œ]
def interest_system():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤
        with sqlite3.connect(DB_FILE) as conn:
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()

# --- [3. ë‡Œì ˆ(ë¬´í•œ ë£¨í”„) ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 100
        # ë‡Œì ˆ íŒ¨í„´ ìƒì„±
        pattern = f"[:[{nick}].{m_count}â‚©:] " * 5
        reward = 5000
        update_money(nick, reward, bank=True) # ì€í–‰ìœ¼ë¡œ ë°”ë¡œ ì…ê¸ˆ
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"ğŸŒ€ ë‡Œì ˆ ì‹œìŠ¤í…œ ê°€ë™ ì¤‘... \nğŸ’° ì€í–‰ ì…ê¸ˆ: +{reward}â‚©\n{pattern}", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3) # 3ì´ˆ ê°„ê²© ë‡Œì ˆ

# --- [4. ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ ì²˜ë¦¬] ---
def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [5. ë¼ìš°íŒ… ë° ì†Œì¼“ ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸ“¢ {data['nickname']}ë‹˜ ì œêµ­ ê°•ë¦¼!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ê¸€ì ìˆ˜ ë³´ìƒ ê³µì‹: ê¸°ë³¸ 50ì› + 10ìë‹¹ 20ì›]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    # [ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ íŒŒì¼ ë³€í™˜]
    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ ëŒ€ìš©ëŸ‰ ë°ì´í„°(ê¸€ììˆ˜: {msg_len})ê°€ íŒŒì¼ë¡œ ë³€í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.\nğŸ”— ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ íŒë…]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        emit('message', {'msg': f"ğŸ’° {nick}ë‹˜ ìì‚° | í˜„ê¸ˆ: {user['money']}â‚© | ì€í–‰: {user['bank_money']}â‚© | ë“±ê¸‰: {'ì´ˆì›”ì' if user['money']>1000000 else 'í‰ë¯¼'}", 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt}â‚© ì €ê¸ˆ ì„±ê³µ! (ë§¤ë¶„ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ {amt}â‚© ì¶œê¸ˆ ì„±ê³µ!", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ ê°€ë™!", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆì„ ì¤‘ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            res = client.models.generate_content(model="gemini-2.0-flash", contents=msg[8:])
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except: pass

    elif cmd == "!ëª…ë ¹ì–´":
        emit('message', {'msg': "ğŸ“œ !ì”ì•¡, !ì €ê¸ˆ [ì•¡ìˆ˜], !ì¶œê¸ˆ [ì•¡ìˆ˜], !ë‡Œì ˆ, !ë‡Œì ˆì¤‘ë‹¨, !gemini [ì§ˆë¬¸]", 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ… ì „ì†¡
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=interest_system, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í´ë”] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "empire_master.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
# ëª¨ë“  í™˜ê²½ í˜¸í™˜ì„ ìœ„í•œ threading ëª¨ë“œ
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {} # ë‡Œì ˆ ìƒíƒœ ì €ì¥ìš©

# Gemini AI (ì„¤ì¹˜ë˜ì–´ ìˆì„ ê²½ìš°ë§Œ)
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key: client = genai.Client(api_key=api_key)
except: pass

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("CREATE TABLE IF NOT EXISTS users (nickname TEXT PRIMARY KEY, money INTEGER DEFAULT 1000, bank_money INTEGER DEFAULT 0)")
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ì‹œìŠ¤í…œ]
def interest_system():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤
        with sqlite3.connect(DB_FILE) as conn:
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()

# --- [3. ë‡Œì ˆ(ë¬´í•œ ë£¨í”„) ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 100
        # ë‡Œì ˆ íŒ¨í„´ ìƒì„±
        pattern = f"[:[{nick}].{m_count}â‚©:] " * 5
        reward = 5000
        update_money(nick, reward, bank=True) # ì€í–‰ìœ¼ë¡œ ë°”ë¡œ ì…ê¸ˆ
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"ğŸŒ€ ë‡Œì ˆ ì‹œìŠ¤í…œ ê°€ë™ ì¤‘... \nğŸ’° ì€í–‰ ì…ê¸ˆ: +{reward}â‚©\n{pattern}", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3) # 3ì´ˆ ê°„ê²© ë‡Œì ˆ

# --- [4. ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ ì²˜ë¦¬] ---
def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [5. ë¼ìš°íŒ… ë° ì†Œì¼“ ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸ“¢ {data['nickname']}ë‹˜ ì œêµ­ ê°•ë¦¼!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ê¸€ì ìˆ˜ ë³´ìƒ ê³µì‹: ê¸°ë³¸ 50ì› + 10ìë‹¹ 20ì›]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    # [ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ íŒŒì¼ ë³€í™˜]
    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ ëŒ€ìš©ëŸ‰ ë°ì´í„°(ê¸€ììˆ˜: {msg_len})ê°€ íŒŒì¼ë¡œ ë³€í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.\nğŸ”— ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ íŒë…]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        emit('message', {'msg': f"ğŸ’° {nick}ë‹˜ ìì‚° | í˜„ê¸ˆ: {user['money']}â‚© | ì€í–‰: {user['bank_money']}â‚© | ë“±ê¸‰: {'ì´ˆì›”ì' if user['money']>1000000 else 'í‰ë¯¼'}", 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt}â‚© ì €ê¸ˆ ì„±ê³µ! (ë§¤ë¶„ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ {amt}â‚© ì¶œê¸ˆ ì„±ê³µ!", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ ê°€ë™!", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆì„ ì¤‘ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            res = client.models.generate_content(model="gemini-2.0-flash", contents=msg[8:])
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except: pass

    elif cmd == "!ëª…ë ¹ì–´":
        emit('message', {'msg': "ğŸ“œ !ì”ì•¡, !ì €ê¸ˆ [ì•¡ìˆ˜], !ì¶œê¸ˆ [ì•¡ìˆ˜], !ë‡Œì ˆ, !ë‡Œì ˆì¤‘ë‹¨, !gemini [ì§ˆë¬¸]", 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ… ì „ì†¡
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=interest_system, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í´ë”] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "empire_master.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
# ëª¨ë“  í™˜ê²½ í˜¸í™˜ì„ ìœ„í•œ threading ëª¨ë“œ
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {} # ë‡Œì ˆ ìƒíƒœ ì €ì¥ìš©

# Gemini AI (ì„¤ì¹˜ë˜ì–´ ìˆì„ ê²½ìš°ë§Œ)
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key: client = genai.Client(api_key=api_key)
except: pass

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("CREATE TABLE IF NOT EXISTS users (nickname TEXT PRIMARY KEY, money INTEGER DEFAULT 1000, bank_money INTEGER DEFAULT 0)")
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ì‹œìŠ¤í…œ]
def interest_system():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤
        with sqlite3.connect(DB_FILE) as conn:
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()

# --- [3. ë‡Œì ˆ(ë¬´í•œ ë£¨í”„) ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 100
        # ë‡Œì ˆ íŒ¨í„´ ìƒì„±
        pattern = f"[:[{nick}].{m_count}â‚©:] " * 5
        reward = 5000
        update_money(nick, reward, bank=True) # ì€í–‰ìœ¼ë¡œ ë°”ë¡œ ì…ê¸ˆ
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"ğŸŒ€ ë‡Œì ˆ ì‹œìŠ¤í…œ ê°€ë™ ì¤‘... \nğŸ’° ì€í–‰ ì…ê¸ˆ: +{reward}â‚©\n{pattern}", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3) # 3ì´ˆ ê°„ê²© ë‡Œì ˆ

# --- [4. ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ ì²˜ë¦¬] ---
def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [5. ë¼ìš°íŒ… ë° ì†Œì¼“ ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸ“¢ {data['nickname']}ë‹˜ ì œêµ­ ê°•ë¦¼!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ê¸€ì ìˆ˜ ë³´ìƒ ê³µì‹: ê¸°ë³¸ 50ì› + 10ìë‹¹ 20ì›]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    # [ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ íŒŒì¼ ë³€í™˜]
    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ ëŒ€ìš©ëŸ‰ ë°ì´í„°(ê¸€ììˆ˜: {msg_len})ê°€ íŒŒì¼ë¡œ ë³€í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.\nğŸ”— ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ íŒë…]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        emit('message', {'msg': f"ğŸ’° {nick}ë‹˜ ìì‚° | í˜„ê¸ˆ: {user['money']}â‚© | ì€í–‰: {user['bank_money']}â‚© | ë“±ê¸‰: {'ì´ˆì›”ì' if user['money']>1000000 else 'í‰ë¯¼'}", 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt}â‚© ì €ê¸ˆ ì„±ê³µ! (ë§¤ë¶„ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ {amt}â‚© ì¶œê¸ˆ ì„±ê³µ!", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ ê°€ë™!", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆì„ ì¤‘ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            res = client.models.generate_content(model="gemini-2.0-flash", contents=msg[8:])
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except: pass

    elif cmd == "!ëª…ë ¹ì–´":
        emit('message', {'msg': "ğŸ“œ !ì”ì•¡, !ì €ê¸ˆ [ì•¡ìˆ˜], !ì¶œê¸ˆ [ì•¡ìˆ˜], !ë‡Œì ˆ, !ë‡Œì ˆì¤‘ë‹¨, !gemini [ì§ˆë¬¸]", 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ… ì „ì†¡
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=interest_system, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í´ë”] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "empire_master.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
# ëª¨ë“  í™˜ê²½ í˜¸í™˜ì„ ìœ„í•œ threading ëª¨ë“œ
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {} # ë‡Œì ˆ ìƒíƒœ ì €ì¥ìš©

# Gemini AI (ì„¤ì¹˜ë˜ì–´ ìˆì„ ê²½ìš°ë§Œ)
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key: client = genai.Client(api_key=api_key)
except: pass

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("CREATE TABLE IF NOT EXISTS users (nickname TEXT PRIMARY KEY, money INTEGER DEFAULT 1000, bank_money INTEGER DEFAULT 0)")
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ì‹œìŠ¤í…œ]
def interest_system():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤
        with sqlite3.connect(DB_FILE) as conn:
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()

# --- [3. ë‡Œì ˆ(ë¬´í•œ ë£¨í”„) ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 100
        # ë‡Œì ˆ íŒ¨í„´ ìƒì„±
        pattern = f"[:[{nick}].{m_count}â‚©:] " * 5
        reward = 5000
        update_money(nick, reward, bank=True) # ì€í–‰ìœ¼ë¡œ ë°”ë¡œ ì…ê¸ˆ
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"ğŸŒ€ ë‡Œì ˆ ì‹œìŠ¤í…œ ê°€ë™ ì¤‘... \nğŸ’° ì€í–‰ ì…ê¸ˆ: +{reward}â‚©\n{pattern}", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3) # 3ì´ˆ ê°„ê²© ë‡Œì ˆ

# --- [4. ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ ì²˜ë¦¬] ---
def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [5. ë¼ìš°íŒ… ë° ì†Œì¼“ ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸ“¢ {data['nickname']}ë‹˜ ì œêµ­ ê°•ë¦¼!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ê¸€ì ìˆ˜ ë³´ìƒ ê³µì‹: ê¸°ë³¸ 50ì› + 10ìë‹¹ 20ì›]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    # [ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ íŒŒì¼ ë³€í™˜]
    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ ëŒ€ìš©ëŸ‰ ë°ì´í„°(ê¸€ììˆ˜: {msg_len})ê°€ íŒŒì¼ë¡œ ë³€í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.\nğŸ”— ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ íŒë…]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        emit('message', {'msg': f"ğŸ’° {nick}ë‹˜ ìì‚° | í˜„ê¸ˆ: {user['money']}â‚© | ì€í–‰: {user['bank_money']}â‚© | ë“±ê¸‰: {'ì´ˆì›”ì' if user['money']>1000000 else 'í‰ë¯¼'}", 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt}â‚© ì €ê¸ˆ ì„±ê³µ! (ë§¤ë¶„ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ {amt}â‚© ì¶œê¸ˆ ì„±ê³µ!", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ ê°€ë™!", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆì„ ì¤‘ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            res = client.models.generate_content(model="gemini-2.0-flash", contents=msg[8:])
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except: pass

    elif cmd == "!ëª…ë ¹ì–´":
        emit('message', {'msg': "ğŸ“œ !ì”ì•¡, !ì €ê¸ˆ [ì•¡ìˆ˜], !ì¶œê¸ˆ [ì•¡ìˆ˜], !ë‡Œì ˆ, !ë‡Œì ˆì¤‘ë‹¨, !gemini [ì§ˆë¬¸]", 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ… ì „ì†¡
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=interest_system, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í´ë”] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "empire_master.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
# ëª¨ë“  í™˜ê²½ í˜¸í™˜ì„ ìœ„í•œ threading ëª¨ë“œ
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {} # ë‡Œì ˆ ìƒíƒœ ì €ì¥ìš©

# Gemini AI (ì„¤ì¹˜ë˜ì–´ ìˆì„ ê²½ìš°ë§Œ)
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key: client = genai.Client(api_key=api_key)
except: pass

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("CREATE TABLE IF NOT EXISTS users (nickname TEXT PRIMARY KEY, money INTEGER DEFAULT 1000, bank_money INTEGER DEFAULT 0)")
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ì‹œìŠ¤í…œ]
def interest_system():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤
        with sqlite3.connect(DB_FILE) as conn:
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()

# --- [3. ë‡Œì ˆ(ë¬´í•œ ë£¨í”„) ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 100
        # ë‡Œì ˆ íŒ¨í„´ ìƒì„±
        pattern = f"[:[{nick}].{m_count}â‚©:] " * 5
        reward = 5000
        update_money(nick, reward, bank=True) # ì€í–‰ìœ¼ë¡œ ë°”ë¡œ ì…ê¸ˆ
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"ğŸŒ€ ë‡Œì ˆ ì‹œìŠ¤í…œ ê°€ë™ ì¤‘... \nğŸ’° ì€í–‰ ì…ê¸ˆ: +{reward}â‚©\n{pattern}", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3) # 3ì´ˆ ê°„ê²© ë‡Œì ˆ

# --- [4. ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ ì²˜ë¦¬] ---
def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [5. ë¼ìš°íŒ… ë° ì†Œì¼“ ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸ“¢ {data['nickname']}ë‹˜ ì œêµ­ ê°•ë¦¼!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ê¸€ì ìˆ˜ ë³´ìƒ ê³µì‹: ê¸°ë³¸ 50ì› + 10ìë‹¹ 20ì›]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    # [ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ íŒŒì¼ ë³€í™˜]
    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ ëŒ€ìš©ëŸ‰ ë°ì´í„°(ê¸€ììˆ˜: {msg_len})ê°€ íŒŒì¼ë¡œ ë³€í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.\nğŸ”— ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ íŒë…]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        emit('message', {'msg': f"ğŸ’° {nick}ë‹˜ ìì‚° | í˜„ê¸ˆ: {user['money']}â‚© | ì€í–‰: {user['bank_money']}â‚© | ë“±ê¸‰: {'ì´ˆì›”ì' if user['money']>1000000 else 'í‰ë¯¼'}", 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt}â‚© ì €ê¸ˆ ì„±ê³µ! (ë§¤ë¶„ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ {amt}â‚© ì¶œê¸ˆ ì„±ê³µ!", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ ê°€ë™!", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆì„ ì¤‘ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            res = client.models.generate_content(model="gemini-2.0-flash", contents=msg[8:])
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except: pass

    elif cmd == "!ëª…ë ¹ì–´":
        emit('message', {'msg': "ğŸ“œ !ì”ì•¡, !ì €ê¸ˆ [ì•¡ìˆ˜], !ì¶œê¸ˆ [ì•¡ìˆ˜], !ë‡Œì ˆ, !ë‡Œì ˆì¤‘ë‹¨, !gemini [ì§ˆë¬¸]", 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ… ì „ì†¡
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=interest_system, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í´ë”] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "empire_master.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
# ëª¨ë“  í™˜ê²½ í˜¸í™˜ì„ ìœ„í•œ threading ëª¨ë“œ
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {} # ë‡Œì ˆ ìƒíƒœ ì €ì¥ìš©

# Gemini AI (ì„¤ì¹˜ë˜ì–´ ìˆì„ ê²½ìš°ë§Œ)
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key: client = genai.Client(api_key=api_key)
except: pass

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("CREATE TABLE IF NOT EXISTS users (nickname TEXT PRIMARY KEY, money INTEGER DEFAULT 1000, bank_money INTEGER DEFAULT 0)")
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ì‹œìŠ¤í…œ]
def interest_system():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤
        with sqlite3.connect(DB_FILE) as conn:
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()

# --- [3. ë‡Œì ˆ(ë¬´í•œ ë£¨í”„) ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 100
        # ë‡Œì ˆ íŒ¨í„´ ìƒì„±
        pattern = f"[:[{nick}].{m_count}â‚©:] " * 5
        reward = 5000
        update_money(nick, reward, bank=True) # ì€í–‰ìœ¼ë¡œ ë°”ë¡œ ì…ê¸ˆ
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"ğŸŒ€ ë‡Œì ˆ ì‹œìŠ¤í…œ ê°€ë™ ì¤‘... \nğŸ’° ì€í–‰ ì…ê¸ˆ: +{reward}â‚©\n{pattern}", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3) # 3ì´ˆ ê°„ê²© ë‡Œì ˆ

# --- [4. ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ ì²˜ë¦¬] ---
def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [5. ë¼ìš°íŒ… ë° ì†Œì¼“ ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸ“¢ {data['nickname']}ë‹˜ ì œêµ­ ê°•ë¦¼!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ê¸€ì ìˆ˜ ë³´ìƒ ê³µì‹: ê¸°ë³¸ 50ì› + 10ìë‹¹ 20ì›]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    # [ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ íŒŒì¼ ë³€í™˜]
    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ ëŒ€ìš©ëŸ‰ ë°ì´í„°(ê¸€ììˆ˜: {msg_len})ê°€ íŒŒì¼ë¡œ ë³€í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.\nğŸ”— ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ íŒë…]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        emit('message', {'msg': f"ğŸ’° {nick}ë‹˜ ìì‚° | í˜„ê¸ˆ: {user['money']}â‚© | ì€í–‰: {user['bank_money']}â‚© | ë“±ê¸‰: {'ì´ˆì›”ì' if user['money']>1000000 else 'í‰ë¯¼'}", 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt}â‚© ì €ê¸ˆ ì„±ê³µ! (ë§¤ë¶„ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ {amt}â‚© ì¶œê¸ˆ ì„±ê³µ!", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ ê°€ë™!", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆì„ ì¤‘ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            res = client.models.generate_content(model="gemini-2.0-flash", contents=msg[8:])
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except: pass

    elif cmd == "!ëª…ë ¹ì–´":
        emit('message', {'msg': "ğŸ“œ !ì”ì•¡, !ì €ê¸ˆ [ì•¡ìˆ˜], !ì¶œê¸ˆ [ì•¡ìˆ˜], !ë‡Œì ˆ, !ë‡Œì ˆì¤‘ë‹¨, !gemini [ì§ˆë¬¸]", 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ… ì „ì†¡
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=interest_system, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í´ë”] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "empire_master.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
# ëª¨ë“  í™˜ê²½ í˜¸í™˜ì„ ìœ„í•œ threading ëª¨ë“œ
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {} # ë‡Œì ˆ ìƒíƒœ ì €ì¥ìš©

# Gemini AI (ì„¤ì¹˜ë˜ì–´ ìˆì„ ê²½ìš°ë§Œ)
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key: client = genai.Client(api_key=api_key)
except: pass

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("CREATE TABLE IF NOT EXISTS users (nickname TEXT PRIMARY KEY, money INTEGER DEFAULT 1000, bank_money INTEGER DEFAULT 0)")
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ì‹œìŠ¤í…œ]
def interest_system():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤
        with sqlite3.connect(DB_FILE) as conn:
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()

# --- [3. ë‡Œì ˆ(ë¬´í•œ ë£¨í”„) ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 100
        # ë‡Œì ˆ íŒ¨í„´ ìƒì„±
        pattern = f"[:[{nick}].{m_count}â‚©:] " * 5
        reward = 5000
        update_money(nick, reward, bank=True) # ì€í–‰ìœ¼ë¡œ ë°”ë¡œ ì…ê¸ˆ
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"ğŸŒ€ ë‡Œì ˆ ì‹œìŠ¤í…œ ê°€ë™ ì¤‘... \nğŸ’° ì€í–‰ ì…ê¸ˆ: +{reward}â‚©\n{pattern}", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3) # 3ì´ˆ ê°„ê²© ë‡Œì ˆ

# --- [4. ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ ì²˜ë¦¬] ---
def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [5. ë¼ìš°íŒ… ë° ì†Œì¼“ ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸ“¢ {data['nickname']}ë‹˜ ì œêµ­ ê°•ë¦¼!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ê¸€ì ìˆ˜ ë³´ìƒ ê³µì‹: ê¸°ë³¸ 50ì› + 10ìë‹¹ 20ì›]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    # [ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ íŒŒì¼ ë³€í™˜]
    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ ëŒ€ìš©ëŸ‰ ë°ì´í„°(ê¸€ììˆ˜: {msg_len})ê°€ íŒŒì¼ë¡œ ë³€í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.\nğŸ”— ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ íŒë…]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        emit('message', {'msg': f"ğŸ’° {nick}ë‹˜ ìì‚° | í˜„ê¸ˆ: {user['money']}â‚© | ì€í–‰: {user['bank_money']}â‚© | ë“±ê¸‰: {'ì´ˆì›”ì' if user['money']>1000000 else 'í‰ë¯¼'}", 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt}â‚© ì €ê¸ˆ ì„±ê³µ! (ë§¤ë¶„ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ {amt}â‚© ì¶œê¸ˆ ì„±ê³µ!", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ ê°€ë™!", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆì„ ì¤‘ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            res = client.models.generate_content(model="gemini-2.0-flash", contents=msg[8:])
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except: pass

    elif cmd == "!ëª…ë ¹ì–´":
        emit('message', {'msg': "ğŸ“œ !ì”ì•¡, !ì €ê¸ˆ [ì•¡ìˆ˜], !ì¶œê¸ˆ [ì•¡ìˆ˜], !ë‡Œì ˆ, !ë‡Œì ˆì¤‘ë‹¨, !gemini [ì§ˆë¬¸]", 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ… ì „ì†¡
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=interest_system, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í´ë”] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "empire_master.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
# ëª¨ë“  í™˜ê²½ í˜¸í™˜ì„ ìœ„í•œ threading ëª¨ë“œ
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {} # ë‡Œì ˆ ìƒíƒœ ì €ì¥ìš©

# Gemini AI (ì„¤ì¹˜ë˜ì–´ ìˆì„ ê²½ìš°ë§Œ)
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key: client = genai.Client(api_key=api_key)
except: pass

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("CREATE TABLE IF NOT EXISTS users (nickname TEXT PRIMARY KEY, money INTEGER DEFAULT 1000, bank_money INTEGER DEFAULT 0)")
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ì‹œìŠ¤í…œ]
def interest_system():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤
        with sqlite3.connect(DB_FILE) as conn:
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()

# --- [3. ë‡Œì ˆ(ë¬´í•œ ë£¨í”„) ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 100
        # ë‡Œì ˆ íŒ¨í„´ ìƒì„±
        pattern = f"[:[{nick}].{m_count}â‚©:] " * 5
        reward = 5000
        update_money(nick, reward, bank=True) # ì€í–‰ìœ¼ë¡œ ë°”ë¡œ ì…ê¸ˆ
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"ğŸŒ€ ë‡Œì ˆ ì‹œìŠ¤í…œ ê°€ë™ ì¤‘... \nğŸ’° ì€í–‰ ì…ê¸ˆ: +{reward}â‚©\n{pattern}", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3) # 3ì´ˆ ê°„ê²© ë‡Œì ˆ

# --- [4. ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ ì²˜ë¦¬] ---
def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [5. ë¼ìš°íŒ… ë° ì†Œì¼“ ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸ“¢ {data['nickname']}ë‹˜ ì œêµ­ ê°•ë¦¼!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ê¸€ì ìˆ˜ ë³´ìƒ ê³µì‹: ê¸°ë³¸ 50ì› + 10ìë‹¹ 20ì›]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    # [ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ íŒŒì¼ ë³€í™˜]
    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ ëŒ€ìš©ëŸ‰ ë°ì´í„°(ê¸€ììˆ˜: {msg_len})ê°€ íŒŒì¼ë¡œ ë³€í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.\nğŸ”— ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ íŒë…]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        emit('message', {'msg': f"ğŸ’° {nick}ë‹˜ ìì‚° | í˜„ê¸ˆ: {user['money']}â‚© | ì€í–‰: {user['bank_money']}â‚© | ë“±ê¸‰: {'ì´ˆì›”ì' if user['money']>1000000 else 'í‰ë¯¼'}", 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt}â‚© ì €ê¸ˆ ì„±ê³µ! (ë§¤ë¶„ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ {amt}â‚© ì¶œê¸ˆ ì„±ê³µ!", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ ê°€ë™!", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆì„ ì¤‘ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            res = client.models.generate_content(model="gemini-2.0-flash", contents=msg[8:])
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except: pass

    elif cmd == "!ëª…ë ¹ì–´":
        emit('message', {'msg': "ğŸ“œ !ì”ì•¡, !ì €ê¸ˆ [ì•¡ìˆ˜], !ì¶œê¸ˆ [ì•¡ìˆ˜], !ë‡Œì ˆ, !ë‡Œì ˆì¤‘ë‹¨, !gemini [ì§ˆë¬¸]", 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ… ì „ì†¡
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=interest_system, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í´ë”] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "empire_master.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
# ëª¨ë“  í™˜ê²½ í˜¸í™˜ì„ ìœ„í•œ threading ëª¨ë“œ
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {} # ë‡Œì ˆ ìƒíƒœ ì €ì¥ìš©

# Gemini AI (ì„¤ì¹˜ë˜ì–´ ìˆì„ ê²½ìš°ë§Œ)
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key: client = genai.Client(api_key=api_key)
except: pass

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("CREATE TABLE IF NOT EXISTS users (nickname TEXT PRIMARY KEY, money INTEGER DEFAULT 1000, bank_money INTEGER DEFAULT 0)")
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ì‹œìŠ¤í…œ]
def interest_system():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤
        with sqlite3.connect(DB_FILE) as conn:
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()

# --- [3. ë‡Œì ˆ(ë¬´í•œ ë£¨í”„) ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 100
        # ë‡Œì ˆ íŒ¨í„´ ìƒì„±
        pattern = f"[:[{nick}].{m_count}â‚©:] " * 5
        reward = 5000
        update_money(nick, reward, bank=True) # ì€í–‰ìœ¼ë¡œ ë°”ë¡œ ì…ê¸ˆ
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"ğŸŒ€ ë‡Œì ˆ ì‹œìŠ¤í…œ ê°€ë™ ì¤‘... \nğŸ’° ì€í–‰ ì…ê¸ˆ: +{reward}â‚©\n{pattern}", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3) # 3ì´ˆ ê°„ê²© ë‡Œì ˆ

# --- [4. ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ ì²˜ë¦¬] ---
def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [5. ë¼ìš°íŒ… ë° ì†Œì¼“ ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸ“¢ {data['nickname']}ë‹˜ ì œêµ­ ê°•ë¦¼!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ê¸€ì ìˆ˜ ë³´ìƒ ê³µì‹: ê¸°ë³¸ 50ì› + 10ìë‹¹ 20ì›]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    # [ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ íŒŒì¼ ë³€í™˜]
    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ ëŒ€ìš©ëŸ‰ ë°ì´í„°(ê¸€ììˆ˜: {msg_len})ê°€ íŒŒì¼ë¡œ ë³€í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.\nğŸ”— ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ íŒë…]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        emit('message', {'msg': f"ğŸ’° {nick}ë‹˜ ìì‚° | í˜„ê¸ˆ: {user['money']}â‚© | ì€í–‰: {user['bank_money']}â‚© | ë“±ê¸‰: {'ì´ˆì›”ì' if user['money']>1000000 else 'í‰ë¯¼'}", 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt}â‚© ì €ê¸ˆ ì„±ê³µ! (ë§¤ë¶„ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ {amt}â‚© ì¶œê¸ˆ ì„±ê³µ!", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ ê°€ë™!", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆì„ ì¤‘ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            res = client.models.generate_content(model="gemini-2.0-flash", contents=msg[8:])
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except: pass

    elif cmd == "!ëª…ë ¹ì–´":
        emit('message', {'msg': "ğŸ“œ !ì”ì•¡, !ì €ê¸ˆ [ì•¡ìˆ˜], !ì¶œê¸ˆ [ì•¡ìˆ˜], !ë‡Œì ˆ, !ë‡Œì ˆì¤‘ë‹¨, !gemini [ì§ˆë¬¸]", 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ… ì „ì†¡
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=interest_system, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í´ë”] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "empire_master.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
# ëª¨ë“  í™˜ê²½ í˜¸í™˜ì„ ìœ„í•œ threading ëª¨ë“œ
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {} # ë‡Œì ˆ ìƒíƒœ ì €ì¥ìš©

# Gemini AI (ì„¤ì¹˜ë˜ì–´ ìˆì„ ê²½ìš°ë§Œ)
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key: client = genai.Client(api_key=api_key)
except: pass

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("CREATE TABLE IF NOT EXISTS users (nickname TEXT PRIMARY KEY, money INTEGER DEFAULT 1000, bank_money INTEGER DEFAULT 0)")
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ì‹œìŠ¤í…œ]
def interest_system():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤
        with sqlite3.connect(DB_FILE) as conn:
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()

# --- [3. ë‡Œì ˆ(ë¬´í•œ ë£¨í”„) ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 100
        # ë‡Œì ˆ íŒ¨í„´ ìƒì„±
        pattern = f"[:[{nick}].{m_count}â‚©:] " * 5
        reward = 5000
        update_money(nick, reward, bank=True) # ì€í–‰ìœ¼ë¡œ ë°”ë¡œ ì…ê¸ˆ
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"ğŸŒ€ ë‡Œì ˆ ì‹œìŠ¤í…œ ê°€ë™ ì¤‘... \nğŸ’° ì€í–‰ ì…ê¸ˆ: +{reward}â‚©\n{pattern}", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3) # 3ì´ˆ ê°„ê²© ë‡Œì ˆ

# --- [4. ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ ì²˜ë¦¬] ---
def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [5. ë¼ìš°íŒ… ë° ì†Œì¼“ ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸ“¢ {data['nickname']}ë‹˜ ì œêµ­ ê°•ë¦¼!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ê¸€ì ìˆ˜ ë³´ìƒ ê³µì‹: ê¸°ë³¸ 50ì› + 10ìë‹¹ 20ì›]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    # [ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ íŒŒì¼ ë³€í™˜]
    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ ëŒ€ìš©ëŸ‰ ë°ì´í„°(ê¸€ììˆ˜: {msg_len})ê°€ íŒŒì¼ë¡œ ë³€í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.\nğŸ”— ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ íŒë…]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        emit('message', {'msg': f"ğŸ’° {nick}ë‹˜ ìì‚° | í˜„ê¸ˆ: {user['money']}â‚© | ì€í–‰: {user['bank_money']}â‚© | ë“±ê¸‰: {'ì´ˆì›”ì' if user['money']>1000000 else 'í‰ë¯¼'}", 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt}â‚© ì €ê¸ˆ ì„±ê³µ! (ë§¤ë¶„ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ {amt}â‚© ì¶œê¸ˆ ì„±ê³µ!", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ ê°€ë™!", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆì„ ì¤‘ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            res = client.models.generate_content(model="gemini-2.0-flash", contents=msg[8:])
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except: pass

    elif cmd == "!ëª…ë ¹ì–´":
        emit('message', {'msg': "ğŸ“œ !ì”ì•¡, !ì €ê¸ˆ [ì•¡ìˆ˜], !ì¶œê¸ˆ [ì•¡ìˆ˜], !ë‡Œì ˆ, !ë‡Œì ˆì¤‘ë‹¨, !gemini [ì§ˆë¬¸]", 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ… ì „ì†¡
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=interest_system, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í´ë”] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "empire_master.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
# ëª¨ë“  í™˜ê²½ í˜¸í™˜ì„ ìœ„í•œ threading ëª¨ë“œ
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {} # ë‡Œì ˆ ìƒíƒœ ì €ì¥ìš©

# Gemini AI (ì„¤ì¹˜ë˜ì–´ ìˆì„ ê²½ìš°ë§Œ)
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key: client = genai.Client(api_key=api_key)
except: pass

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("CREATE TABLE IF NOT EXISTS users (nickname TEXT PRIMARY KEY, money INTEGER DEFAULT 1000, bank_money INTEGER DEFAULT 0)")
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ì‹œìŠ¤í…œ]
def interest_system():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤
        with sqlite3.connect(DB_FILE) as conn:
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()

# --- [3. ë‡Œì ˆ(ë¬´í•œ ë£¨í”„) ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 100
        # ë‡Œì ˆ íŒ¨í„´ ìƒì„±
        pattern = f"[:[{nick}].{m_count}â‚©:] " * 5
        reward = 5000
        update_money(nick, reward, bank=True) # ì€í–‰ìœ¼ë¡œ ë°”ë¡œ ì…ê¸ˆ
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"ğŸŒ€ ë‡Œì ˆ ì‹œìŠ¤í…œ ê°€ë™ ì¤‘... \nğŸ’° ì€í–‰ ì…ê¸ˆ: +{reward}â‚©\n{pattern}", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3) # 3ì´ˆ ê°„ê²© ë‡Œì ˆ

# --- [4. ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ ì²˜ë¦¬] ---
def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [5. ë¼ìš°íŒ… ë° ì†Œì¼“ ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸ“¢ {data['nickname']}ë‹˜ ì œêµ­ ê°•ë¦¼!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ê¸€ì ìˆ˜ ë³´ìƒ ê³µì‹: ê¸°ë³¸ 50ì› + 10ìë‹¹ 20ì›]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    # [ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ íŒŒì¼ ë³€í™˜]
    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ ëŒ€ìš©ëŸ‰ ë°ì´í„°(ê¸€ììˆ˜: {msg_len})ê°€ íŒŒì¼ë¡œ ë³€í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.\nğŸ”— ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ íŒë…]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        emit('message', {'msg': f"ğŸ’° {nick}ë‹˜ ìì‚° | í˜„ê¸ˆ: {user['money']}â‚© | ì€í–‰: {user['bank_money']}â‚© | ë“±ê¸‰: {'ì´ˆì›”ì' if user['money']>1000000 else 'í‰ë¯¼'}", 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt}â‚© ì €ê¸ˆ ì„±ê³µ! (ë§¤ë¶„ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ {amt}â‚© ì¶œê¸ˆ ì„±ê³µ!", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ ê°€ë™!", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆì„ ì¤‘ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            res = client.models.generate_content(model="gemini-2.0-flash", contents=msg[8:])
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except: pass

    elif cmd == "!ëª…ë ¹ì–´":
        emit('message', {'msg': "ğŸ“œ !ì”ì•¡, !ì €ê¸ˆ [ì•¡ìˆ˜], !ì¶œê¸ˆ [ì•¡ìˆ˜], !ë‡Œì ˆ, !ë‡Œì ˆì¤‘ë‹¨, !gemini [ì§ˆë¬¸]", 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ… ì „ì†¡
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=interest_system, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í´ë”] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "empire_master.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
# ëª¨ë“  í™˜ê²½ í˜¸í™˜ì„ ìœ„í•œ threading ëª¨ë“œ
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {} # ë‡Œì ˆ ìƒíƒœ ì €ì¥ìš©

# Gemini AI (ì„¤ì¹˜ë˜ì–´ ìˆì„ ê²½ìš°ë§Œ)
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key: client = genai.Client(api_key=api_key)
except: pass

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("CREATE TABLE IF NOT EXISTS users (nickname TEXT PRIMARY KEY, money INTEGER DEFAULT 1000, bank_money INTEGER DEFAULT 0)")
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ì‹œìŠ¤í…œ]
def interest_system():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤
        with sqlite3.connect(DB_FILE) as conn:
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()

# --- [3. ë‡Œì ˆ(ë¬´í•œ ë£¨í”„) ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 100
        # ë‡Œì ˆ íŒ¨í„´ ìƒì„±
        pattern = f"[:[{nick}].{m_count}â‚©:] " * 5
        reward = 5000
        update_money(nick, reward, bank=True) # ì€í–‰ìœ¼ë¡œ ë°”ë¡œ ì…ê¸ˆ
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"ğŸŒ€ ë‡Œì ˆ ì‹œìŠ¤í…œ ê°€ë™ ì¤‘... \nğŸ’° ì€í–‰ ì…ê¸ˆ: +{reward}â‚©\n{pattern}", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3) # 3ì´ˆ ê°„ê²© ë‡Œì ˆ

# --- [4. ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ ì²˜ë¦¬] ---
def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [5. ë¼ìš°íŒ… ë° ì†Œì¼“ ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸ“¢ {data['nickname']}ë‹˜ ì œêµ­ ê°•ë¦¼!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ê¸€ì ìˆ˜ ë³´ìƒ ê³µì‹: ê¸°ë³¸ 50ì› + 10ìë‹¹ 20ì›]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    # [ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ íŒŒì¼ ë³€í™˜]
    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ ëŒ€ìš©ëŸ‰ ë°ì´í„°(ê¸€ììˆ˜: {msg_len})ê°€ íŒŒì¼ë¡œ ë³€í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.\nğŸ”— ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ íŒë…]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        emit('message', {'msg': f"ğŸ’° {nick}ë‹˜ ìì‚° | í˜„ê¸ˆ: {user['money']}â‚© | ì€í–‰: {user['bank_money']}â‚© | ë“±ê¸‰: {'ì´ˆì›”ì' if user['money']>1000000 else 'í‰ë¯¼'}", 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt}â‚© ì €ê¸ˆ ì„±ê³µ! (ë§¤ë¶„ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ {amt}â‚© ì¶œê¸ˆ ì„±ê³µ!", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ ê°€ë™!", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆì„ ì¤‘ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            res = client.models.generate_content(model="gemini-2.0-flash", contents=msg[8:])
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except: pass

    elif cmd == "!ëª…ë ¹ì–´":
        emit('message', {'msg': "ğŸ“œ !ì”ì•¡, !ì €ê¸ˆ [ì•¡ìˆ˜], !ì¶œê¸ˆ [ì•¡ìˆ˜], !ë‡Œì ˆ, !ë‡Œì ˆì¤‘ë‹¨, !gemini [ì§ˆë¬¸]", 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ… ì „ì†¡
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=interest_system, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í´ë”] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "empire_master.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
# ëª¨ë“  í™˜ê²½ í˜¸í™˜ì„ ìœ„í•œ threading ëª¨ë“œ
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {} # ë‡Œì ˆ ìƒíƒœ ì €ì¥ìš©

# Gemini AI (ì„¤ì¹˜ë˜ì–´ ìˆì„ ê²½ìš°ë§Œ)
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key: client = genai.Client(api_key=api_key)
except: pass

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("CREATE TABLE IF NOT EXISTS users (nickname TEXT PRIMARY KEY, money INTEGER DEFAULT 1000, bank_money INTEGER DEFAULT 0)")
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ì‹œìŠ¤í…œ]
def interest_system():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤
        with sqlite3.connect(DB_FILE) as conn:
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()

# --- [3. ë‡Œì ˆ(ë¬´í•œ ë£¨í”„) ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 100
        # ë‡Œì ˆ íŒ¨í„´ ìƒì„±
        pattern = f"[:[{nick}].{m_count}â‚©:] " * 5
        reward = 5000
        update_money(nick, reward, bank=True) # ì€í–‰ìœ¼ë¡œ ë°”ë¡œ ì…ê¸ˆ
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"ğŸŒ€ ë‡Œì ˆ ì‹œìŠ¤í…œ ê°€ë™ ì¤‘... \nğŸ’° ì€í–‰ ì…ê¸ˆ: +{reward}â‚©\n{pattern}", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3) # 3ì´ˆ ê°„ê²© ë‡Œì ˆ

# --- [4. ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ ì²˜ë¦¬] ---
def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [5. ë¼ìš°íŒ… ë° ì†Œì¼“ ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸ“¢ {data['nickname']}ë‹˜ ì œêµ­ ê°•ë¦¼!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ê¸€ì ìˆ˜ ë³´ìƒ ê³µì‹: ê¸°ë³¸ 50ì› + 10ìë‹¹ 20ì›]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    # [ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ íŒŒì¼ ë³€í™˜]
    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ ëŒ€ìš©ëŸ‰ ë°ì´í„°(ê¸€ììˆ˜: {msg_len})ê°€ íŒŒì¼ë¡œ ë³€í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.\nğŸ”— ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ íŒë…]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        emit('message', {'msg': f"ğŸ’° {nick}ë‹˜ ìì‚° | í˜„ê¸ˆ: {user['money']}â‚© | ì€í–‰: {user['bank_money']}â‚© | ë“±ê¸‰: {'ì´ˆì›”ì' if user['money']>1000000 else 'í‰ë¯¼'}", 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt}â‚© ì €ê¸ˆ ì„±ê³µ! (ë§¤ë¶„ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ {amt}â‚© ì¶œê¸ˆ ì„±ê³µ!", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ ê°€ë™!", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆì„ ì¤‘ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            res = client.models.generate_content(model="gemini-2.0-flash", contents=msg[8:])
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except: pass

    elif cmd == "!ëª…ë ¹ì–´":
        emit('message', {'msg': "ğŸ“œ !ì”ì•¡, !ì €ê¸ˆ [ì•¡ìˆ˜], !ì¶œê¸ˆ [ì•¡ìˆ˜], !ë‡Œì ˆ, !ë‡Œì ˆì¤‘ë‹¨, !gemini [ì§ˆë¬¸]", 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ… ì „ì†¡
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=interest_system, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í´ë”] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "empire_master.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
# ëª¨ë“  í™˜ê²½ í˜¸í™˜ì„ ìœ„í•œ threading ëª¨ë“œ
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {} # ë‡Œì ˆ ìƒíƒœ ì €ì¥ìš©

# Gemini AI (ì„¤ì¹˜ë˜ì–´ ìˆì„ ê²½ìš°ë§Œ)
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key: client = genai.Client(api_key=api_key)
except: pass

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("CREATE TABLE IF NOT EXISTS users (nickname TEXT PRIMARY KEY, money INTEGER DEFAULT 1000, bank_money INTEGER DEFAULT 0)")
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ì‹œìŠ¤í…œ]
def interest_system():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤
        with sqlite3.connect(DB_FILE) as conn:
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()

# --- [3. ë‡Œì ˆ(ë¬´í•œ ë£¨í”„) ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 100
        # ë‡Œì ˆ íŒ¨í„´ ìƒì„±
        pattern = f"[:[{nick}].{m_count}â‚©:] " * 5
        reward = 5000
        update_money(nick, reward, bank=True) # ì€í–‰ìœ¼ë¡œ ë°”ë¡œ ì…ê¸ˆ
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"ğŸŒ€ ë‡Œì ˆ ì‹œìŠ¤í…œ ê°€ë™ ì¤‘... \nğŸ’° ì€í–‰ ì…ê¸ˆ: +{reward}â‚©\n{pattern}", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3) # 3ì´ˆ ê°„ê²© ë‡Œì ˆ

# --- [4. ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ ì²˜ë¦¬] ---
def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [5. ë¼ìš°íŒ… ë° ì†Œì¼“ ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸ“¢ {data['nickname']}ë‹˜ ì œêµ­ ê°•ë¦¼!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ê¸€ì ìˆ˜ ë³´ìƒ ê³µì‹: ê¸°ë³¸ 50ì› + 10ìë‹¹ 20ì›]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    # [ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ íŒŒì¼ ë³€í™˜]
    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ ëŒ€ìš©ëŸ‰ ë°ì´í„°(ê¸€ììˆ˜: {msg_len})ê°€ íŒŒì¼ë¡œ ë³€í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.\nğŸ”— ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ íŒë…]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        emit('message', {'msg': f"ğŸ’° {nick}ë‹˜ ìì‚° | í˜„ê¸ˆ: {user['money']}â‚© | ì€í–‰: {user['bank_money']}â‚© | ë“±ê¸‰: {'ì´ˆì›”ì' if user['money']>1000000 else 'í‰ë¯¼'}", 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt}â‚© ì €ê¸ˆ ì„±ê³µ! (ë§¤ë¶„ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ {amt}â‚© ì¶œê¸ˆ ì„±ê³µ!", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ ê°€ë™!", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆì„ ì¤‘ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            res = client.models.generate_content(model="gemini-2.0-flash", contents=msg[8:])
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except: pass

    elif cmd == "!ëª…ë ¹ì–´":
        emit('message', {'msg': "ğŸ“œ !ì”ì•¡, !ì €ê¸ˆ [ì•¡ìˆ˜], !ì¶œê¸ˆ [ì•¡ìˆ˜], !ë‡Œì ˆ, !ë‡Œì ˆì¤‘ë‹¨, !gemini [ì§ˆë¬¸]", 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ… ì „ì†¡
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=interest_system, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í´ë”] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "empire_master.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
# ëª¨ë“  í™˜ê²½ í˜¸í™˜ì„ ìœ„í•œ threading ëª¨ë“œ
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {} # ë‡Œì ˆ ìƒíƒœ ì €ì¥ìš©

# Gemini AI (ì„¤ì¹˜ë˜ì–´ ìˆì„ ê²½ìš°ë§Œ)
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key: client = genai.Client(api_key=api_key)
except: pass

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("CREATE TABLE IF NOT EXISTS users (nickname TEXT PRIMARY KEY, money INTEGER DEFAULT 1000, bank_money INTEGER DEFAULT 0)")
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ì‹œìŠ¤í…œ]
def interest_system():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤
        with sqlite3.connect(DB_FILE) as conn:
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()

# --- [3. ë‡Œì ˆ(ë¬´í•œ ë£¨í”„) ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 100
        # ë‡Œì ˆ íŒ¨í„´ ìƒì„±
        pattern = f"[:[{nick}].{m_count}â‚©:] " * 5
        reward = 5000
        update_money(nick, reward, bank=True) # ì€í–‰ìœ¼ë¡œ ë°”ë¡œ ì…ê¸ˆ
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"ğŸŒ€ ë‡Œì ˆ ì‹œìŠ¤í…œ ê°€ë™ ì¤‘... \nğŸ’° ì€í–‰ ì…ê¸ˆ: +{reward}â‚©\n{pattern}", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3) # 3ì´ˆ ê°„ê²© ë‡Œì ˆ

# --- [4. ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ ì²˜ë¦¬] ---
def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [5. ë¼ìš°íŒ… ë° ì†Œì¼“ ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸ“¢ {data['nickname']}ë‹˜ ì œêµ­ ê°•ë¦¼!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ê¸€ì ìˆ˜ ë³´ìƒ ê³µì‹: ê¸°ë³¸ 50ì› + 10ìë‹¹ 20ì›]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    # [ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ íŒŒì¼ ë³€í™˜]
    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ ëŒ€ìš©ëŸ‰ ë°ì´í„°(ê¸€ììˆ˜: {msg_len})ê°€ íŒŒì¼ë¡œ ë³€í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.\nğŸ”— ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ íŒë…]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        emit('message', {'msg': f"ğŸ’° {nick}ë‹˜ ìì‚° | í˜„ê¸ˆ: {user['money']}â‚© | ì€í–‰: {user['bank_money']}â‚© | ë“±ê¸‰: {'ì´ˆì›”ì' if user['money']>1000000 else 'í‰ë¯¼'}", 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt}â‚© ì €ê¸ˆ ì„±ê³µ! (ë§¤ë¶„ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ {amt}â‚© ì¶œê¸ˆ ì„±ê³µ!", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ ê°€ë™!", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆì„ ì¤‘ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            res = client.models.generate_content(model="gemini-2.0-flash", contents=msg[8:])
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except: pass

    elif cmd == "!ëª…ë ¹ì–´":
        emit('message', {'msg': "ğŸ“œ !ì”ì•¡, !ì €ê¸ˆ [ì•¡ìˆ˜], !ì¶œê¸ˆ [ì•¡ìˆ˜], !ë‡Œì ˆ, !ë‡Œì ˆì¤‘ë‹¨, !gemini [ì§ˆë¬¸]", 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ… ì „ì†¡
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=interest_system, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í´ë”] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "empire_master.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
# ëª¨ë“  í™˜ê²½ í˜¸í™˜ì„ ìœ„í•œ threading ëª¨ë“œ
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {} # ë‡Œì ˆ ìƒíƒœ ì €ì¥ìš©

# Gemini AI (ì„¤ì¹˜ë˜ì–´ ìˆì„ ê²½ìš°ë§Œ)
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key: client = genai.Client(api_key=api_key)
except: pass

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("CREATE TABLE IF NOT EXISTS users (nickname TEXT PRIMARY KEY, money INTEGER DEFAULT 1000, bank_money INTEGER DEFAULT 0)")
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ì‹œìŠ¤í…œ]
def interest_system():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤
        with sqlite3.connect(DB_FILE) as conn:
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()

# --- [3. ë‡Œì ˆ(ë¬´í•œ ë£¨í”„) ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 100
        # ë‡Œì ˆ íŒ¨í„´ ìƒì„±
        pattern = f"[:[{nick}].{m_count}â‚©:] " * 5
        reward = 5000
        update_money(nick, reward, bank=True) # ì€í–‰ìœ¼ë¡œ ë°”ë¡œ ì…ê¸ˆ
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"ğŸŒ€ ë‡Œì ˆ ì‹œìŠ¤í…œ ê°€ë™ ì¤‘... \nğŸ’° ì€í–‰ ì…ê¸ˆ: +{reward}â‚©\n{pattern}", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3) # 3ì´ˆ ê°„ê²© ë‡Œì ˆ

# --- [4. ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ ì²˜ë¦¬] ---
def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [5. ë¼ìš°íŒ… ë° ì†Œì¼“ ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸ“¢ {data['nickname']}ë‹˜ ì œêµ­ ê°•ë¦¼!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ê¸€ì ìˆ˜ ë³´ìƒ ê³µì‹: ê¸°ë³¸ 50ì› + 10ìë‹¹ 20ì›]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    # [ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ íŒŒì¼ ë³€í™˜]
    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ ëŒ€ìš©ëŸ‰ ë°ì´í„°(ê¸€ììˆ˜: {msg_len})ê°€ íŒŒì¼ë¡œ ë³€í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.\nğŸ”— ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ íŒë…]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        emit('message', {'msg': f"ğŸ’° {nick}ë‹˜ ìì‚° | í˜„ê¸ˆ: {user['money']}â‚© | ì€í–‰: {user['bank_money']}â‚© | ë“±ê¸‰: {'ì´ˆì›”ì' if user['money']>1000000 else 'í‰ë¯¼'}", 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt}â‚© ì €ê¸ˆ ì„±ê³µ! (ë§¤ë¶„ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ {amt}â‚© ì¶œê¸ˆ ì„±ê³µ!", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ ê°€ë™!", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆì„ ì¤‘ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            res = client.models.generate_content(model="gemini-2.0-flash", contents=msg[8:])
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except: pass

    elif cmd == "!ëª…ë ¹ì–´":
        emit('message', {'msg': "ğŸ“œ !ì”ì•¡, !ì €ê¸ˆ [ì•¡ìˆ˜], !ì¶œê¸ˆ [ì•¡ìˆ˜], !ë‡Œì ˆ, !ë‡Œì ˆì¤‘ë‹¨, !gemini [ì§ˆë¬¸]", 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ… ì „ì†¡
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=interest_system, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í´ë”] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "empire_master.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
# ëª¨ë“  í™˜ê²½ í˜¸í™˜ì„ ìœ„í•œ threading ëª¨ë“œ
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {} # ë‡Œì ˆ ìƒíƒœ ì €ì¥ìš©

# Gemini AI (ì„¤ì¹˜ë˜ì–´ ìˆì„ ê²½ìš°ë§Œ)
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key: client = genai.Client(api_key=api_key)
except: pass

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("CREATE TABLE IF NOT EXISTS users (nickname TEXT PRIMARY KEY, money INTEGER DEFAULT 1000, bank_money INTEGER DEFAULT 0)")
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ì‹œìŠ¤í…œ]
def interest_system():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤
        with sqlite3.connect(DB_FILE) as conn:
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()

# --- [3. ë‡Œì ˆ(ë¬´í•œ ë£¨í”„) ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 100
        # ë‡Œì ˆ íŒ¨í„´ ìƒì„±
        pattern = f"[:[{nick}].{m_count}â‚©:] " * 5
        reward = 5000
        update_money(nick, reward, bank=True) # ì€í–‰ìœ¼ë¡œ ë°”ë¡œ ì…ê¸ˆ
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"ğŸŒ€ ë‡Œì ˆ ì‹œìŠ¤í…œ ê°€ë™ ì¤‘... \nğŸ’° ì€í–‰ ì…ê¸ˆ: +{reward}â‚©\n{pattern}", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3) # 3ì´ˆ ê°„ê²© ë‡Œì ˆ

# --- [4. ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ ì²˜ë¦¬] ---
def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [5. ë¼ìš°íŒ… ë° ì†Œì¼“ ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸ“¢ {data['nickname']}ë‹˜ ì œêµ­ ê°•ë¦¼!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ê¸€ì ìˆ˜ ë³´ìƒ ê³µì‹: ê¸°ë³¸ 50ì› + 10ìë‹¹ 20ì›]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    # [ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ íŒŒì¼ ë³€í™˜]
    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ ëŒ€ìš©ëŸ‰ ë°ì´í„°(ê¸€ììˆ˜: {msg_len})ê°€ íŒŒì¼ë¡œ ë³€í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.\nğŸ”— ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ íŒë…]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        emit('message', {'msg': f"ğŸ’° {nick}ë‹˜ ìì‚° | í˜„ê¸ˆ: {user['money']}â‚© | ì€í–‰: {user['bank_money']}â‚© | ë“±ê¸‰: {'ì´ˆì›”ì' if user['money']>1000000 else 'í‰ë¯¼'}", 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt}â‚© ì €ê¸ˆ ì„±ê³µ! (ë§¤ë¶„ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ {amt}â‚© ì¶œê¸ˆ ì„±ê³µ!", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ ê°€ë™!", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆì„ ì¤‘ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            res = client.models.generate_content(model="gemini-2.0-flash", contents=msg[8:])
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except: pass

    elif cmd == "!ëª…ë ¹ì–´":
        emit('message', {'msg': "ğŸ“œ !ì”ì•¡, !ì €ê¸ˆ [ì•¡ìˆ˜], !ì¶œê¸ˆ [ì•¡ìˆ˜], !ë‡Œì ˆ, !ë‡Œì ˆì¤‘ë‹¨, !gemini [ì§ˆë¬¸]", 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ… ì „ì†¡
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=interest_system, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í´ë”] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "empire_master.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
# ëª¨ë“  í™˜ê²½ í˜¸í™˜ì„ ìœ„í•œ threading ëª¨ë“œ
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {} # ë‡Œì ˆ ìƒíƒœ ì €ì¥ìš©

# Gemini AI (ì„¤ì¹˜ë˜ì–´ ìˆì„ ê²½ìš°ë§Œ)
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key: client = genai.Client(api_key=api_key)
except: pass

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("CREATE TABLE IF NOT EXISTS users (nickname TEXT PRIMARY KEY, money INTEGER DEFAULT 1000, bank_money INTEGER DEFAULT 0)")
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ì‹œìŠ¤í…œ]
def interest_system():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤
        with sqlite3.connect(DB_FILE) as conn:
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()

# --- [3. ë‡Œì ˆ(ë¬´í•œ ë£¨í”„) ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 100
        # ë‡Œì ˆ íŒ¨í„´ ìƒì„±
        pattern = f"[:[{nick}].{m_count}â‚©:] " * 5
        reward = 5000
        update_money(nick, reward, bank=True) # ì€í–‰ìœ¼ë¡œ ë°”ë¡œ ì…ê¸ˆ
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"ğŸŒ€ ë‡Œì ˆ ì‹œìŠ¤í…œ ê°€ë™ ì¤‘... \nğŸ’° ì€í–‰ ì…ê¸ˆ: +{reward}â‚©\n{pattern}", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3) # 3ì´ˆ ê°„ê²© ë‡Œì ˆ

# --- [4. ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ ì²˜ë¦¬] ---
def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [5. ë¼ìš°íŒ… ë° ì†Œì¼“ ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸ“¢ {data['nickname']}ë‹˜ ì œêµ­ ê°•ë¦¼!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ê¸€ì ìˆ˜ ë³´ìƒ ê³µì‹: ê¸°ë³¸ 50ì› + 10ìë‹¹ 20ì›]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    # [ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ íŒŒì¼ ë³€í™˜]
    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ ëŒ€ìš©ëŸ‰ ë°ì´í„°(ê¸€ììˆ˜: {msg_len})ê°€ íŒŒì¼ë¡œ ë³€í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.\nğŸ”— ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ íŒë…]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        emit('message', {'msg': f"ğŸ’° {nick}ë‹˜ ìì‚° | í˜„ê¸ˆ: {user['money']}â‚© | ì€í–‰: {user['bank_money']}â‚© | ë“±ê¸‰: {'ì´ˆì›”ì' if user['money']>1000000 else 'í‰ë¯¼'}", 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt}â‚© ì €ê¸ˆ ì„±ê³µ! (ë§¤ë¶„ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ {amt}â‚© ì¶œê¸ˆ ì„±ê³µ!", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ ê°€ë™!", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆì„ ì¤‘ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            res = client.models.generate_content(model="gemini-2.0-flash", contents=msg[8:])
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except: pass

    elif cmd == "!ëª…ë ¹ì–´":
        emit('message', {'msg': "ğŸ“œ !ì”ì•¡, !ì €ê¸ˆ [ì•¡ìˆ˜], !ì¶œê¸ˆ [ì•¡ìˆ˜], !ë‡Œì ˆ, !ë‡Œì ˆì¤‘ë‹¨, !gemini [ì§ˆë¬¸]", 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ… ì „ì†¡
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=interest_system, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í´ë”] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "empire_master.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
# ëª¨ë“  í™˜ê²½ í˜¸í™˜ì„ ìœ„í•œ threading ëª¨ë“œ
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {} # ë‡Œì ˆ ìƒíƒœ ì €ì¥ìš©

# Gemini AI (ì„¤ì¹˜ë˜ì–´ ìˆì„ ê²½ìš°ë§Œ)
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key: client = genai.Client(api_key=api_key)
except: pass

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("CREATE TABLE IF NOT EXISTS users (nickname TEXT PRIMARY KEY, money INTEGER DEFAULT 1000, bank_money INTEGER DEFAULT 0)")
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ì‹œìŠ¤í…œ]
def interest_system():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤
        with sqlite3.connect(DB_FILE) as conn:
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()

# --- [3. ë‡Œì ˆ(ë¬´í•œ ë£¨í”„) ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 100
        # ë‡Œì ˆ íŒ¨í„´ ìƒì„±
        pattern = f"[:[{nick}].{m_count}â‚©:] " * 5
        reward = 5000
        update_money(nick, reward, bank=True) # ì€í–‰ìœ¼ë¡œ ë°”ë¡œ ì…ê¸ˆ
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"ğŸŒ€ ë‡Œì ˆ ì‹œìŠ¤í…œ ê°€ë™ ì¤‘... \nğŸ’° ì€í–‰ ì…ê¸ˆ: +{reward}â‚©\n{pattern}", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3) # 3ì´ˆ ê°„ê²© ë‡Œì ˆ

# --- [4. ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ ì²˜ë¦¬] ---
def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [5. ë¼ìš°íŒ… ë° ì†Œì¼“ ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸ“¢ {data['nickname']}ë‹˜ ì œêµ­ ê°•ë¦¼!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ê¸€ì ìˆ˜ ë³´ìƒ ê³µì‹: ê¸°ë³¸ 50ì› + 10ìë‹¹ 20ì›]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    # [ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ íŒŒì¼ ë³€í™˜]
    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ ëŒ€ìš©ëŸ‰ ë°ì´í„°(ê¸€ììˆ˜: {msg_len})ê°€ íŒŒì¼ë¡œ ë³€í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.\nğŸ”— ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ íŒë…]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        emit('message', {'msg': f"ğŸ’° {nick}ë‹˜ ìì‚° | í˜„ê¸ˆ: {user['money']}â‚© | ì€í–‰: {user['bank_money']}â‚© | ë“±ê¸‰: {'ì´ˆì›”ì' if user['money']>1000000 else 'í‰ë¯¼'}", 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt}â‚© ì €ê¸ˆ ì„±ê³µ! (ë§¤ë¶„ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ {amt}â‚© ì¶œê¸ˆ ì„±ê³µ!", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ ê°€ë™!", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆì„ ì¤‘ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            res = client.models.generate_content(model="gemini-2.0-flash", contents=msg[8:])
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except: pass

    elif cmd == "!ëª…ë ¹ì–´":
        emit('message', {'msg': "ğŸ“œ !ì”ì•¡, !ì €ê¸ˆ [ì•¡ìˆ˜], !ì¶œê¸ˆ [ì•¡ìˆ˜], !ë‡Œì ˆ, !ë‡Œì ˆì¤‘ë‹¨, !gemini [ì§ˆë¬¸]", 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ… ì „ì†¡
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=interest_system, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í´ë”] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "empire_master.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
# ëª¨ë“  í™˜ê²½ í˜¸í™˜ì„ ìœ„í•œ threading ëª¨ë“œ
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {} # ë‡Œì ˆ ìƒíƒœ ì €ì¥ìš©

# Gemini AI (ì„¤ì¹˜ë˜ì–´ ìˆì„ ê²½ìš°ë§Œ)
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key: client = genai.Client(api_key=api_key)
except: pass

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("CREATE TABLE IF NOT EXISTS users (nickname TEXT PRIMARY KEY, money INTEGER DEFAULT 1000, bank_money INTEGER DEFAULT 0)")
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ì‹œìŠ¤í…œ]
def interest_system():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤
        with sqlite3.connect(DB_FILE) as conn:
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()

# --- [3. ë‡Œì ˆ(ë¬´í•œ ë£¨í”„) ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 100
        # ë‡Œì ˆ íŒ¨í„´ ìƒì„±
        pattern = f"[:[{nick}].{m_count}â‚©:] " * 5
        reward = 5000
        update_money(nick, reward, bank=True) # ì€í–‰ìœ¼ë¡œ ë°”ë¡œ ì…ê¸ˆ
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"ğŸŒ€ ë‡Œì ˆ ì‹œìŠ¤í…œ ê°€ë™ ì¤‘... \nğŸ’° ì€í–‰ ì…ê¸ˆ: +{reward}â‚©\n{pattern}", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3) # 3ì´ˆ ê°„ê²© ë‡Œì ˆ

# --- [4. ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ ì²˜ë¦¬] ---
def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [5. ë¼ìš°íŒ… ë° ì†Œì¼“ ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸ“¢ {data['nickname']}ë‹˜ ì œêµ­ ê°•ë¦¼!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ê¸€ì ìˆ˜ ë³´ìƒ ê³µì‹: ê¸°ë³¸ 50ì› + 10ìë‹¹ 20ì›]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    # [ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ íŒŒì¼ ë³€í™˜]
    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ ëŒ€ìš©ëŸ‰ ë°ì´í„°(ê¸€ììˆ˜: {msg_len})ê°€ íŒŒì¼ë¡œ ë³€í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.\nğŸ”— ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ íŒë…]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        emit('message', {'msg': f"ğŸ’° {nick}ë‹˜ ìì‚° | í˜„ê¸ˆ: {user['money']}â‚© | ì€í–‰: {user['bank_money']}â‚© | ë“±ê¸‰: {'ì´ˆì›”ì' if user['money']>1000000 else 'í‰ë¯¼'}", 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt}â‚© ì €ê¸ˆ ì„±ê³µ! (ë§¤ë¶„ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ {amt}â‚© ì¶œê¸ˆ ì„±ê³µ!", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ ê°€ë™!", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆì„ ì¤‘ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            res = client.models.generate_content(model="gemini-2.0-flash", contents=msg[8:])
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except: pass

    elif cmd == "!ëª…ë ¹ì–´":
        emit('message', {'msg': "ğŸ“œ !ì”ì•¡, !ì €ê¸ˆ [ì•¡ìˆ˜], !ì¶œê¸ˆ [ì•¡ìˆ˜], !ë‡Œì ˆ, !ë‡Œì ˆì¤‘ë‹¨, !gemini [ì§ˆë¬¸]", 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ… ì „ì†¡
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=interest_system, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í´ë”] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "empire_master.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
# ëª¨ë“  í™˜ê²½ í˜¸í™˜ì„ ìœ„í•œ threading ëª¨ë“œ
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {} # ë‡Œì ˆ ìƒíƒœ ì €ì¥ìš©

# Gemini AI (ì„¤ì¹˜ë˜ì–´ ìˆì„ ê²½ìš°ë§Œ)
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key: client = genai.Client(api_key=api_key)
except: pass

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("CREATE TABLE IF NOT EXISTS users (nickname TEXT PRIMARY KEY, money INTEGER DEFAULT 1000, bank_money INTEGER DEFAULT 0)")
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ì‹œìŠ¤í…œ]
def interest_system():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤
        with sqlite3.connect(DB_FILE) as conn:
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()

# --- [3. ë‡Œì ˆ(ë¬´í•œ ë£¨í”„) ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 100
        # ë‡Œì ˆ íŒ¨í„´ ìƒì„±
        pattern = f"[:[{nick}].{m_count}â‚©:] " * 5
        reward = 5000
        update_money(nick, reward, bank=True) # ì€í–‰ìœ¼ë¡œ ë°”ë¡œ ì…ê¸ˆ
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"ğŸŒ€ ë‡Œì ˆ ì‹œìŠ¤í…œ ê°€ë™ ì¤‘... \nğŸ’° ì€í–‰ ì…ê¸ˆ: +{reward}â‚©\n{pattern}", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3) # 3ì´ˆ ê°„ê²© ë‡Œì ˆ

# --- [4. ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ ì²˜ë¦¬] ---
def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [5. ë¼ìš°íŒ… ë° ì†Œì¼“ ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸ“¢ {data['nickname']}ë‹˜ ì œêµ­ ê°•ë¦¼!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ê¸€ì ìˆ˜ ë³´ìƒ ê³µì‹: ê¸°ë³¸ 50ì› + 10ìë‹¹ 20ì›]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    # [ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ íŒŒì¼ ë³€í™˜]
    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ ëŒ€ìš©ëŸ‰ ë°ì´í„°(ê¸€ììˆ˜: {msg_len})ê°€ íŒŒì¼ë¡œ ë³€í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.\nğŸ”— ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ íŒë…]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        emit('message', {'msg': f"ğŸ’° {nick}ë‹˜ ìì‚° | í˜„ê¸ˆ: {user['money']}â‚© | ì€í–‰: {user['bank_money']}â‚© | ë“±ê¸‰: {'ì´ˆì›”ì' if user['money']>1000000 else 'í‰ë¯¼'}", 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt}â‚© ì €ê¸ˆ ì„±ê³µ! (ë§¤ë¶„ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ {amt}â‚© ì¶œê¸ˆ ì„±ê³µ!", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ ê°€ë™!", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆì„ ì¤‘ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            res = client.models.generate_content(model="gemini-2.0-flash", contents=msg[8:])
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except: pass

    elif cmd == "!ëª…ë ¹ì–´":
        emit('message', {'msg': "ğŸ“œ !ì”ì•¡, !ì €ê¸ˆ [ì•¡ìˆ˜], !ì¶œê¸ˆ [ì•¡ìˆ˜], !ë‡Œì ˆ, !ë‡Œì ˆì¤‘ë‹¨, !gemini [ì§ˆë¬¸]", 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ… ì „ì†¡
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=interest_system, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í´ë”] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "empire_master.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
# ëª¨ë“  í™˜ê²½ í˜¸í™˜ì„ ìœ„í•œ threading ëª¨ë“œ
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {} # ë‡Œì ˆ ìƒíƒœ ì €ì¥ìš©

# Gemini AI (ì„¤ì¹˜ë˜ì–´ ìˆì„ ê²½ìš°ë§Œ)
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key: client = genai.Client(api_key=api_key)
except: pass

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("CREATE TABLE IF NOT EXISTS users (nickname TEXT PRIMARY KEY, money INTEGER DEFAULT 1000, bank_money INTEGER DEFAULT 0)")
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ì‹œìŠ¤í…œ]
def interest_system():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤
        with sqlite3.connect(DB_FILE) as conn:
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()

# --- [3. ë‡Œì ˆ(ë¬´í•œ ë£¨í”„) ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 100
        # ë‡Œì ˆ íŒ¨í„´ ìƒì„±
        pattern = f"[:[{nick}].{m_count}â‚©:] " * 5
        reward = 5000
        update_money(nick, reward, bank=True) # ì€í–‰ìœ¼ë¡œ ë°”ë¡œ ì…ê¸ˆ
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"ğŸŒ€ ë‡Œì ˆ ì‹œìŠ¤í…œ ê°€ë™ ì¤‘... \nğŸ’° ì€í–‰ ì…ê¸ˆ: +{reward}â‚©\n{pattern}", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3) # 3ì´ˆ ê°„ê²© ë‡Œì ˆ

# --- [4. ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ ì²˜ë¦¬] ---
def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [5. ë¼ìš°íŒ… ë° ì†Œì¼“ ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸ“¢ {data['nickname']}ë‹˜ ì œêµ­ ê°•ë¦¼!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ê¸€ì ìˆ˜ ë³´ìƒ ê³µì‹: ê¸°ë³¸ 50ì› + 10ìë‹¹ 20ì›]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    # [ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ íŒŒì¼ ë³€í™˜]
    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ ëŒ€ìš©ëŸ‰ ë°ì´í„°(ê¸€ììˆ˜: {msg_len})ê°€ íŒŒì¼ë¡œ ë³€í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.\nğŸ”— ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ íŒë…]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        emit('message', {'msg': f"ğŸ’° {nick}ë‹˜ ìì‚° | í˜„ê¸ˆ: {user['money']}â‚© | ì€í–‰: {user['bank_money']}â‚© | ë“±ê¸‰: {'ì´ˆì›”ì' if user['money']>1000000 else 'í‰ë¯¼'}", 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt}â‚© ì €ê¸ˆ ì„±ê³µ! (ë§¤ë¶„ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ {amt}â‚© ì¶œê¸ˆ ì„±ê³µ!", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ ê°€ë™!", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆì„ ì¤‘ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            res = client.models.generate_content(model="gemini-2.0-flash", contents=msg[8:])
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except: pass

    elif cmd == "!ëª…ë ¹ì–´":
        emit('message', {'msg': "ğŸ“œ !ì”ì•¡, !ì €ê¸ˆ [ì•¡ìˆ˜], !ì¶œê¸ˆ [ì•¡ìˆ˜], !ë‡Œì ˆ, !ë‡Œì ˆì¤‘ë‹¨, !gemini [ì§ˆë¬¸]", 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ… ì „ì†¡
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=interest_system, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í´ë”] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "empire_master.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
# ëª¨ë“  í™˜ê²½ í˜¸í™˜ì„ ìœ„í•œ threading ëª¨ë“œ
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {} # ë‡Œì ˆ ìƒíƒœ ì €ì¥ìš©

# Gemini AI (ì„¤ì¹˜ë˜ì–´ ìˆì„ ê²½ìš°ë§Œ)
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key: client = genai.Client(api_key=api_key)
except: pass

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("CREATE TABLE IF NOT EXISTS users (nickname TEXT PRIMARY KEY, money INTEGER DEFAULT 1000, bank_money INTEGER DEFAULT 0)")
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ì‹œìŠ¤í…œ]
def interest_system():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤
        with sqlite3.connect(DB_FILE) as conn:
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()

# --- [3. ë‡Œì ˆ(ë¬´í•œ ë£¨í”„) ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 100
        # ë‡Œì ˆ íŒ¨í„´ ìƒì„±
        pattern = f"[:[{nick}].{m_count}â‚©:] " * 5
        reward = 5000
        update_money(nick, reward, bank=True) # ì€í–‰ìœ¼ë¡œ ë°”ë¡œ ì…ê¸ˆ
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"ğŸŒ€ ë‡Œì ˆ ì‹œìŠ¤í…œ ê°€ë™ ì¤‘... \nğŸ’° ì€í–‰ ì…ê¸ˆ: +{reward}â‚©\n{pattern}", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3) # 3ì´ˆ ê°„ê²© ë‡Œì ˆ

# --- [4. ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ ì²˜ë¦¬] ---
def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [5. ë¼ìš°íŒ… ë° ì†Œì¼“ ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸ“¢ {data['nickname']}ë‹˜ ì œêµ­ ê°•ë¦¼!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ê¸€ì ìˆ˜ ë³´ìƒ ê³µì‹: ê¸°ë³¸ 50ì› + 10ìë‹¹ 20ì›]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    # [ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ íŒŒì¼ ë³€í™˜]
    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ ëŒ€ìš©ëŸ‰ ë°ì´í„°(ê¸€ììˆ˜: {msg_len})ê°€ íŒŒì¼ë¡œ ë³€í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.\nğŸ”— ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ íŒë…]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        emit('message', {'msg': f"ğŸ’° {nick}ë‹˜ ìì‚° | í˜„ê¸ˆ: {user['money']}â‚© | ì€í–‰: {user['bank_money']}â‚© | ë“±ê¸‰: {'ì´ˆì›”ì' if user['money']>1000000 else 'í‰ë¯¼'}", 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt}â‚© ì €ê¸ˆ ì„±ê³µ! (ë§¤ë¶„ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ {amt}â‚© ì¶œê¸ˆ ì„±ê³µ!", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ ê°€ë™!", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆì„ ì¤‘ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            res = client.models.generate_content(model="gemini-2.0-flash", contents=msg[8:])
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except: pass

    elif cmd == "!ëª…ë ¹ì–´":
        emit('message', {'msg': "ğŸ“œ !ì”ì•¡, !ì €ê¸ˆ [ì•¡ìˆ˜], !ì¶œê¸ˆ [ì•¡ìˆ˜], !ë‡Œì ˆ, !ë‡Œì ˆì¤‘ë‹¨, !gemini [ì§ˆë¬¸]", 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ… ì „ì†¡
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=interest_system, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í´ë”] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "empire_master.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
# ëª¨ë“  í™˜ê²½ í˜¸í™˜ì„ ìœ„í•œ threading ëª¨ë“œ
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {} # ë‡Œì ˆ ìƒíƒœ ì €ì¥ìš©

# Gemini AI (ì„¤ì¹˜ë˜ì–´ ìˆì„ ê²½ìš°ë§Œ)
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key: client = genai.Client(api_key=api_key)
except: pass

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("CREATE TABLE IF NOT EXISTS users (nickname TEXT PRIMARY KEY, money INTEGER DEFAULT 1000, bank_money INTEGER DEFAULT 0)")
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ì‹œìŠ¤í…œ]
def interest_system():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤
        with sqlite3.connect(DB_FILE) as conn:
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()

# --- [3. ë‡Œì ˆ(ë¬´í•œ ë£¨í”„) ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 100
        # ë‡Œì ˆ íŒ¨í„´ ìƒì„±
        pattern = f"[:[{nick}].{m_count}â‚©:] " * 5
        reward = 5000
        update_money(nick, reward, bank=True) # ì€í–‰ìœ¼ë¡œ ë°”ë¡œ ì…ê¸ˆ
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"ğŸŒ€ ë‡Œì ˆ ì‹œìŠ¤í…œ ê°€ë™ ì¤‘... \nğŸ’° ì€í–‰ ì…ê¸ˆ: +{reward}â‚©\n{pattern}", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3) # 3ì´ˆ ê°„ê²© ë‡Œì ˆ

# --- [4. ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ ì²˜ë¦¬] ---
def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [5. ë¼ìš°íŒ… ë° ì†Œì¼“ ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸ“¢ {data['nickname']}ë‹˜ ì œêµ­ ê°•ë¦¼!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ê¸€ì ìˆ˜ ë³´ìƒ ê³µì‹: ê¸°ë³¸ 50ì› + 10ìë‹¹ 20ì›]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    # [ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ íŒŒì¼ ë³€í™˜]
    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ ëŒ€ìš©ëŸ‰ ë°ì´í„°(ê¸€ììˆ˜: {msg_len})ê°€ íŒŒì¼ë¡œ ë³€í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.\nğŸ”— ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ íŒë…]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        emit('message', {'msg': f"ğŸ’° {nick}ë‹˜ ìì‚° | í˜„ê¸ˆ: {user['money']}â‚© | ì€í–‰: {user['bank_money']}â‚© | ë“±ê¸‰: {'ì´ˆì›”ì' if user['money']>1000000 else 'í‰ë¯¼'}", 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt}â‚© ì €ê¸ˆ ì„±ê³µ! (ë§¤ë¶„ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ {amt}â‚© ì¶œê¸ˆ ì„±ê³µ!", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ ê°€ë™!", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆì„ ì¤‘ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            res = client.models.generate_content(model="gemini-2.0-flash", contents=msg[8:])
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except: pass

    elif cmd == "!ëª…ë ¹ì–´":
        emit('message', {'msg': "ğŸ“œ !ì”ì•¡, !ì €ê¸ˆ [ì•¡ìˆ˜], !ì¶œê¸ˆ [ì•¡ìˆ˜], !ë‡Œì ˆ, !ë‡Œì ˆì¤‘ë‹¨, !gemini [ì§ˆë¬¸]", 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ… ì „ì†¡
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=interest_system, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í´ë”] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "empire_master.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
# ëª¨ë“  í™˜ê²½ í˜¸í™˜ì„ ìœ„í•œ threading ëª¨ë“œ
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {} # ë‡Œì ˆ ìƒíƒœ ì €ì¥ìš©

# Gemini AI (ì„¤ì¹˜ë˜ì–´ ìˆì„ ê²½ìš°ë§Œ)
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key: client = genai.Client(api_key=api_key)
except: pass

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("CREATE TABLE IF NOT EXISTS users (nickname TEXT PRIMARY KEY, money INTEGER DEFAULT 1000, bank_money INTEGER DEFAULT 0)")
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ì‹œìŠ¤í…œ]
def interest_system():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤
        with sqlite3.connect(DB_FILE) as conn:
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()

# --- [3. ë‡Œì ˆ(ë¬´í•œ ë£¨í”„) ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 100
        # ë‡Œì ˆ íŒ¨í„´ ìƒì„±
        pattern = f"[:[{nick}].{m_count}â‚©:] " * 5
        reward = 5000
        update_money(nick, reward, bank=True) # ì€í–‰ìœ¼ë¡œ ë°”ë¡œ ì…ê¸ˆ
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"ğŸŒ€ ë‡Œì ˆ ì‹œìŠ¤í…œ ê°€ë™ ì¤‘... \nğŸ’° ì€í–‰ ì…ê¸ˆ: +{reward}â‚©\n{pattern}", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3) # 3ì´ˆ ê°„ê²© ë‡Œì ˆ

# --- [4. ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ ì²˜ë¦¬] ---
def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [5. ë¼ìš°íŒ… ë° ì†Œì¼“ ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸ“¢ {data['nickname']}ë‹˜ ì œêµ­ ê°•ë¦¼!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ê¸€ì ìˆ˜ ë³´ìƒ ê³µì‹: ê¸°ë³¸ 50ì› + 10ìë‹¹ 20ì›]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    # [ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ íŒŒì¼ ë³€í™˜]
    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ ëŒ€ìš©ëŸ‰ ë°ì´í„°(ê¸€ììˆ˜: {msg_len})ê°€ íŒŒì¼ë¡œ ë³€í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.\nğŸ”— ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ íŒë…]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        emit('message', {'msg': f"ğŸ’° {nick}ë‹˜ ìì‚° | í˜„ê¸ˆ: {user['money']}â‚© | ì€í–‰: {user['bank_money']}â‚© | ë“±ê¸‰: {'ì´ˆì›”ì' if user['money']>1000000 else 'í‰ë¯¼'}", 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt}â‚© ì €ê¸ˆ ì„±ê³µ! (ë§¤ë¶„ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ {amt}â‚© ì¶œê¸ˆ ì„±ê³µ!", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ ê°€ë™!", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆì„ ì¤‘ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            res = client.models.generate_content(model="gemini-2.0-flash", contents=msg[8:])
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except: pass

    elif cmd == "!ëª…ë ¹ì–´":
        emit('message', {'msg': "ğŸ“œ !ì”ì•¡, !ì €ê¸ˆ [ì•¡ìˆ˜], !ì¶œê¸ˆ [ì•¡ìˆ˜], !ë‡Œì ˆ, !ë‡Œì ˆì¤‘ë‹¨, !gemini [ì§ˆë¬¸]", 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ… ì „ì†¡
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=interest_system, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)
import sqlite3
import os
import time
import threading
from flask import Flask, render_template, request, send_from_directory, url_for
from flask_socketio import SocketIO, emit, join_room
from werkzeug.utils import secure_filename

# --- [1. ì„¤ì • ë° í´ë”] ---
PORT = 5001
UPLOAD_FOLDER = 'uploads'
DB_FILE = "empire_master.sqlite"

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
# ëª¨ë“  í™˜ê²½ í˜¸í™˜ì„ ìœ„í•œ threading ëª¨ë“œ
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')

noejul_loops = {} # ë‡Œì ˆ ìƒíƒœ ì €ì¥ìš©

# Gemini AI (ì„¤ì¹˜ë˜ì–´ ìˆì„ ê²½ìš°ë§Œ)
client = None
try:
    from google import genai
    api_key = os.environ.get("GEMINI_API_KEY")
    if api_key: client = genai.Client(api_key=api_key)
except: pass

# --- [2. DB ë° ê²½ì œ ì‹œìŠ¤í…œ] ---
def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute("CREATE TABLE IF NOT EXISTS users (nickname TEXT PRIMARY KEY, money INTEGER DEFAULT 1000, bank_money INTEGER DEFAULT 0)")
        conn.commit()

def get_user(nick):
    with sqlite3.connect(DB_FILE) as conn:
        conn.row_factory = sqlite3.Row
        conn.execute("INSERT OR IGNORE INTO users (nickname, money, bank_money) VALUES (?, 1000, 0)", (nick,))
        return conn.execute("SELECT * FROM users WHERE nickname=?", (nick,)).fetchone()

def update_money(nick, amount, bank=False):
    col = "bank_money" if bank else "money"
    with sqlite3.connect(DB_FILE) as conn:
        conn.execute(f"UPDATE users SET {col} = {col} + ? WHERE nickname = ?", (amount, nick))
        conn.commit()

# [ì‹¤ì‹œê°„ ì´ì ì‹œìŠ¤í…œ]
def interest_system():
    while True:
        time.sleep(60) # 1ë¶„ë§ˆë‹¤
        with sqlite3.connect(DB_FILE) as conn:
            conn.execute("UPDATE users SET bank_money = CAST(bank_money * 1.01 AS INTEGER) WHERE bank_money > 0")
            conn.commit()

# --- [3. ë‡Œì ˆ(ë¬´í•œ ë£¨í”„) ì—”ì§„] ---
def noejul_task(nick):
    m_count = 0
    while noejul_loops.get(nick):
        m_count += 100
        # ë‡Œì ˆ íŒ¨í„´ ìƒì„±
        pattern = f"[:[{nick}].{m_count}â‚©:] " * 5
        reward = 5000
        update_money(nick, reward, bank=True) # ì€í–‰ìœ¼ë¡œ ë°”ë¡œ ì…ê¸ˆ
        socketio.emit('message', {
            'nickname': nick, 
            'msg': f"ğŸŒ€ ë‡Œì ˆ ì‹œìŠ¤í…œ ê°€ë™ ì¤‘... \nğŸ’° ì€í–‰ ì…ê¸ˆ: +{reward}â‚©\n{pattern}", 
            'type': 'noejul'
        }, room='main')
        time.sleep(3) # 3ì´ˆ ê°„ê²© ë‡Œì ˆ

# --- [4. ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ ì²˜ë¦¬] ---
def save_large_text(nick, content):
    filename = f"large_{int(time.time())}_{nick}.txt"
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)
    return url_for('download_file', filename=filename, _external=True)

# --- [5. ë¼ìš°íŒ… ë° ì†Œì¼“ ì´ë²¤íŠ¸] ---
@app.route('/')
def index(): return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files.get('file')
    nick = request.form.get('nickname', 'Unknown')
    if file:
        uname = f"{int(time.time())}_{secure_filename(file.filename)}"
        file.save(os.path.join(app.config['UPLOAD_FOLDER'], uname))
        url = url_for('download_file', filename=uname, _external=True)
        socketio.emit('message', {'msg': f"ğŸ“‚ {nick}ë‹˜ì´ íŒŒì¼ì„ ê³µìœ í•¨: {url}", 'type': 'system'}, room='main')
        return 'OK'
    return 'Fail', 400

@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

@socketio.on('join')
def on_join(data):
    join_room('main')
    emit('message', {'msg': f"ğŸ“¢ {data['nickname']}ë‹˜ ì œêµ­ ê°•ë¦¼!", 'type': 'system'}, room='main')

@socketio.on('send_msg')
def handle_msg(data):
    nick = data['nickname']
    msg = data['msg'].strip()
    if not msg: return

    user = get_user(nick)
    msg_len = len(msg)
    
    # [ê¸€ì ìˆ˜ ë³´ìƒ ê³µì‹: ê¸°ë³¸ 50ì› + 10ìë‹¹ 20ì›]
    reward = 50 + (msg_len // 10) * 20
    update_money(nick, reward)

    # [ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ íŒŒì¼ ë³€í™˜]
    display_msg = msg
    if msg_len > 800:
        file_link = save_large_text(nick, msg)
        display_msg = f"ğŸ“„ ëŒ€ìš©ëŸ‰ ë°ì´í„°(ê¸€ììˆ˜: {msg_len})ê°€ íŒŒì¼ë¡œ ë³€í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.\nğŸ”— ë§í¬: {file_link}"

    # [ëª…ë ¹ì–´ íŒë…]
    cmd_parts = msg.split()
    cmd = cmd_parts[0].lower() if msg.startswith("!") else ""

    if cmd == "!ì”ì•¡":
        emit('message', {'msg': f"ğŸ’° {nick}ë‹˜ ìì‚° | í˜„ê¸ˆ: {user['money']}â‚© | ì€í–‰: {user['bank_money']}â‚© | ë“±ê¸‰: {'ì´ˆì›”ì' if user['money']>1000000 else 'í‰ë¯¼'}", 'type': 'system'})
    
    elif cmd == "!ì €ê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['money'] >= amt:
                update_money(nick, -amt); update_money(nick, amt, bank=True)
                emit('message', {'msg': f"ğŸ¦ {amt}â‚© ì €ê¸ˆ ì„±ê³µ! (ë§¤ë¶„ ì´ì 1%)", 'type': 'system'})
        except: pass

    elif cmd == "!ì¶œê¸ˆ":
        try:
            amt = int(cmd_parts[1])
            if user['bank_money'] >= amt:
                update_money(nick, amt); update_money(nick, -amt, bank=True)
                emit('message', {'msg': f"ğŸ§ {amt}â‚© ì¶œê¸ˆ ì„±ê³µ!", 'type': 'system'})
        except: pass

    elif cmd in ["!ë‡Œì ˆ", "!ë¬´í•œë‡Œì ˆ"]:
        if not noejul_loops.get(nick):
            noejul_loops[nick] = True
            threading.Thread(target=noejul_task, args=(nick,), daemon=True).start()
            emit('message', {'msg': "ğŸŒ€ ë‡Œì ˆ ë¬´í•œ ë™ë ¥ ì—”ì§„ ê°€ë™!", 'type': 'system'})

    elif cmd in ["!ë‡Œì ˆì¤‘ë‹¨", "!ë‡Œì ˆì •ì§€"]:
        noejul_loops[nick] = False
        emit('message', {'msg': "ğŸ›‘ ë‡Œì ˆì„ ì¤‘ì§€í–ˆìŠµë‹ˆë‹¤.", 'type': 'system'})

    elif cmd == "!gemini" and client:
        try:
            res = client.models.generate_content(model="gemini-2.0-flash", contents=msg[8:])
            socketio.emit('message', {'msg': f"ğŸ¤– Gemini: {res.text}", 'type': 'bot'}, room='main')
        except: pass

    elif cmd == "!ëª…ë ¹ì–´":
        emit('message', {'msg': "ğŸ“œ !ì”ì•¡, !ì €ê¸ˆ [ì•¡ìˆ˜], !ì¶œê¸ˆ [ì•¡ìˆ˜], !ë‡Œì ˆ, !ë‡Œì ˆì¤‘ë‹¨, !gemini [ì§ˆë¬¸]", 'type': 'system'})

    else:
        # ì¼ë°˜ ì±„íŒ… ì „ì†¡
        total = user['money'] + user['bank_money']
        rank = "ì´ˆì›”ì" if total >= 10000000 else "VIP" if total >= 1000000 else "í‰ë¯¼"
        socketio.emit('message', {
            'nickname': nick, 'msg': display_msg, 'type': 'chat', 
            'rank': rank, 'reward': f"+{reward}â‚©"
        }, room='main')

if __name__ == '__main__':
    init_db()
    threading.Thread(target=interest_system, daemon=True).start()
    socketio.run(app, host='0.0.0.0', port=PORT, debug=False)