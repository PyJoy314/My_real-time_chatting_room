<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Multiverse Empire Ultimate</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <style>
        /* [ì§€ë°°ì ë° ì‹œìŠ¤í…œ íš¨ê³¼] */
        @keyframes golden-glow {
            0%, 100% { box-shadow: 0 0 20px #ffd700; border-color: #ffd700; }
            50% { box-shadow: 0 0 40px #fff, inset 0 0 20px #ffd700; border-color: #fff; }
        }
        @keyframes screen-flash {
            0% { background: rgba(255, 215, 0, 0); }
            50% { background: rgba(255, 215, 0, 0.2); }
            100% { background: rgba(255, 215, 0, 0); }
        }
        @keyframes news-pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); background: #334155; }
            100% { transform: scale(1); }
        }
        
        body { background: #020617; color: white; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        #chat { flex: 1; overflow-y: auto; padding: 20px; padding-bottom: 140px; scroll-behavior: smooth; }
        
        /* ë­í‚¹ ë° ë“±ê¸‰ ìŠ¤íƒ€ì¼ */
        .rank-ì§€ë°°ì { background: linear-gradient(to right, #ffd700, #ffffff, #ffcc00); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-weight: 900; filter: drop-shadow(0 0 8px gold); }
        .bubble-ì§€ë°°ì { animation: golden-glow 2s infinite !important; background: rgba(255, 215, 0, 0.1) !important; border: 2px solid #ffd700 !important; }
        .crown { font-size: 1.5rem; vertical-align: middle; animation: bounce 2s infinite; display: inline-block; }
        
        /* ì‹œìŠ¤í…œ ë©”ì‹œì§€ ë° !ë­í‚¹ ì§€ì› ìŠ¤íƒ€ì¼ */
        .system-msg { 
            background: #1e293b; 
            color: #94a3b8; 
            padding: 10px 20px; 
            border-radius: 15px; 
            font-size: 12px; 
            border: 1px solid #334155; 
            max-width: 90%; 
            text-align: left; 
            white-space: pre-wrap; /* !ë­í‚¹ ì¤„ë°”ê¿ˆ ìœ ì§€ìš© */
            display: inline-block;
        }
        .news-msg { 
            background: #0f172a; 
            color: #fbbf24; 
            border: 1px solid #fbbf24; 
            animation: news-pulse 0.5s ease-in-out; 
            font-weight: bold; 
            text-align: center;
        }

        #input-area { position: fixed; bottom: 0; left: 0; right: 0; background: #0f172a; padding: 15px; border-top: 1px solid #1e293b; z-index: 1000; }
        .reward-badge { background: #1e293b; color: #fbbf24; padding: 2px 6px; border-radius: 4px; font-size: 10px; margin-left: 5px; }
        .chat-link { color: #38bdf8; text-decoration: underline; font-weight: bold; }
    </style>
</head>
<body id="main-body">
    <div id="ticker">
        ğŸª™ ì‹¤ì‹œê°„ ë¹„íŠ¸ì½”ì¸ ì‹œì„¸: <span id="btc-price">50,000,000</span>â‚©
    </div>

    <div id="chat" class="space-y-4"></div>

    <div id="input-area">
        <div id="f-ready" class="hidden text-xs text-blue-400 mb-2">ğŸ“ íŒŒì¼ì´ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤.</div>
        <div class="flex gap-2">
            <label class="bg-slate-700 p-2 rounded-lg cursor-pointer">
                ğŸ“ <input type="file" id="f-in" class="hidden" onchange="document.getElementById('f-ready').classList.remove('hidden')">
            </label>
            <input type="text" id="msg" class="flex-1 bg-slate-900 border border-slate-700 rounded-lg px-4 text-sm" placeholder="ë©”ì‹œì§€ ì…ë ¥ ë˜ëŠ” ëª…ë ¹ì–´ (!ëª…ë ¹ì–´)" onkeypress="if(event.keyCode==13) send()">
            <button onclick="send()" class="bg-blue-600 px-4 py-2 rounded-lg font-bold">ì „ì†¡</button>
        </div>
    </div>
    <script>
        const socket = io(); // âœ… ê°€ì¥ ë¨¼ì € ì†Œì¼“ì„ ì´ˆê¸°í™”í•´ì•¼ í•©ë‹ˆë‹¤!

        let nick = prompt("ì œêµ­ì—ì„œ ì‚¬ìš©í•  ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:", "Joyce");
        if (!nick) nick = "ìµëª…_" + Math.floor(Math.random() * 1000);
        socket.emit('join', {nickname: nick});

        // ì‹œì„¸ ì—…ë°ì´íŠ¸ ë¦¬ìŠ¤ë„ˆ
        socket.on('price_update', (data) => {
            const priceEl = document.getElementById('btc-price');
            const oldPrice = parseInt(priceEl.innerText.replace(/,/g, '')) || 0;
            priceEl.innerText = data.btc.toLocaleString();
            priceEl.style.color = data.btc > oldPrice ? "#ef4444" : "#3b82f6";
        });

        function linkify(t) { 
            return t.replace(/(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/ig, 
            '<a href="$1" target="_blank" class="chat-link">$1</a>'); 
        }

        socket.on('message', (d) => {
            const chat = document.getElementById('chat'); 
            const div = document.createElement('div');
            const isMaster = d.rank === 'ë©€í‹°ë²„ìŠ¤ ì§€ë°°ì'; 
            const isMe = d.nickname === nick;

            // ì§€ë°°ì ëŒ€í™” ë˜ëŠ” ì œêµ­ ì†ë³´ ë°œìƒ ì‹œ í™”ë©´ í”Œë˜ì‹œ íš¨ê³¼
            if (isMaster || (d.msg && d.msg.includes('ğŸš¨ [ì œêµ­ ì†ë³´]'))) {
                document.getElementById('main-body').style.animation = 'screen-flash 0.8s ease-in-out';
                setTimeout(() => document.getElementById('main-body').style.animation = '', 800);
            }

            // ë©”ì‹œì§€ íƒ€ì…ë³„ ë Œë”ë§
            if (['system', 'noejul', 'bot'].includes(d.type)) {
                const isNews = d.msg.includes('ğŸš¨');
                div.className = "flex justify-center my-2";
                div.innerHTML = `<span class="system-msg ${isNews ? 'news-msg' : ''}">${d.msg}</span>`;
            } else {
                div.className = `flex ${isMe ? 'justify-end' : 'justify-start'} animate-fade-in`;
                div.innerHTML = `
                    <div class="max-w-[85%]">
                        <div class="flex items-center gap-1 mb-1 ${isMe ? 'flex-row-reverse' : ''}">
                            ${isMaster ? '<span class="crown">ğŸ‘‘</span>' : ''}
                            <span class="text-xs font-bold ${isMaster ? 'rank-ì§€ë°°ì' : 'text-slate-400'}">${d.nickname}</span>
                            <span class="text-[9px] text-slate-600 ml-1">[${d.rank}]</span>
                            <span class="reward-badge">${d.reward || ''}</span>
                        </div>
                        <div class="p-4 rounded-2xl bg-slate-800 border border-slate-700 shadow-xl ${isMaster ? 'bubble-ì§€ë°°ì' : ''}">
                            <div class="text-sm whitespace-pre-wrap break-all">${linkify(d.msg)}</div>
                        </div>
                    </div>`;
            }
            chat.appendChild(div); 
            chat.scrollTop = chat.scrollHeight;
        });

        async function send() {
            const i = document.getElementById('msg'); 
            const fi = document.getElementById('f-in');
            
            if (fi.files[0]) {
                const fd = new FormData(); 
                fd.append('file', fi.files[0]); 
                fd.append('nickname', nick);
                await fetch('/upload', { method: 'POST', body: fd }); 
                fi.value = ''; 
                document.getElementById('f-ready').classList.add('hidden');
            }
            
            if (i.value.trim()) { 
                socket.emit('send_msg', {nickname: nick, msg: i.value}); 
                i.value = ''; 
            }
        }
    </script>
</body>
</html>
