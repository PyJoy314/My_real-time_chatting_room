
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini ë©€í‹°ë²„ìŠ¤ ì±„íŒ…ë°© (Web)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <style>
        /* ì»¤ìŠ¤í…€ ìŠ¤íƒ€ì¼ ë° ì¬ì •ì˜ */
        body { font-family: 'Inter', sans-serif; background: #1f2937; color: #f9fafb; }
        /* ìŠ¤í¬ë¡¤ë°” ì»¤ìŠ¤í…€ */
        #chat-window::-webkit-scrollbar { width: 8px; }
        #chat-window::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        #chat-window::-webkit-scrollbar-track { background: #374151; }
        
        .message { margin-bottom: 8px; line-height: 1.4; padding: 4px 0; word-wrap: break-word; }
        .nickname { font-weight: bold; color: #6366f1; margin-right: 8px; }
        
        /* ì±—ë´‡ ë©”ì‹œì§€: í•˜ëŠ˜ìƒ‰, ë°°ê²½ìƒ‰ */
        .bot { color: #38bdf8; border-left: 3px solid #38bdf8; padding-left: 10px; background: #273040; border-radius: 4px; padding: 8px; white-space: pre-wrap; }
        
        /* ì‹œìŠ¤í…œ ë©”ì‹œì§€: ë…¸ë€ìƒ‰ */
        .system { color: #fbbf24; font-style: italic; border-left: 3px solid #fbbf24; padding-left: 10px; }

        /* ëª…ë ¹ì–´ ê²°ê³¼: ë…¹ìƒ‰ */
        .command_result { color: #34d399; border-left: 3px solid #34d399; padding-left: 10px; background: #274030; border-radius: 4px; padding: 8px; white-space: pre-wrap; }
        
        /* ëª¨ë°”ì¼ í™”ë©´ì—ì„œ ì‚¬ìš©ì ëª©ë¡ ìˆ¨ê¸°ê¸°/ë³´ì´ê¸° */
        @media (max-width: 767px) {
            #user-list-container {
                position: absolute;
                top: 0;
                right: 0;
                bottom: 0;
                width: 70%; /* ëª¨ë°”ì¼ì—ì„œ 70% ë„ˆë¹„ */
                z-index: 10;
                transform: translateX(100%);
                transition: transform 0.3s ease-in-out;
            }
            #user-list-container.flex {
                transform: translateX(0);
            }
        }
    </style>
</head>
<body class="h-screen flex flex-col">
    <div id="login-modal" class="fixed inset-0 bg-gray-900 bg-opacity-90 flex items-center justify-center z-20">
        <div class="bg-gray-800 p-8 rounded-lg shadow-xl w-full max-w-md">
            <h2 class="text-2xl font-bold text-indigo-400 mb-6 text-center">Gemini ë©€í‹°ë²„ìŠ¤ ì±„íŒ…ë°© ì ‘ì†</h2>
            <p id="login-status" class="text-red-400 mb-4 text-center hidden">âŒ ì„œë²„ ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>
            <form id="login-form">
                <div class="mb-4">
                    <label for="nickname-input" class="block text-sm font-medium text-gray-300">ë‹‰ë„¤ì„</label>
                    <input type="text" id="nickname-input" class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" required minlength="3" maxlength="15" placeholder="3~15ì (Admin ì‚¬ìš© ì‹œ ë¹„ë°€ë²ˆí˜¸ í•„ìš”)">
                </div>
                <div class="mb-6">
                    <label for="password-input" class="block text-sm font-medium text-gray-300">ë¹„ë°€ë²ˆí˜¸ (Admin ì „ìš©)</label>
                    <input type="password" id="password-input" class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="Admin ì ‘ì† ë¹„ë°€ë²ˆí˜¸">
                </div>
                <button type="submit" id="connect-button" class="w-full bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                    ì ‘ì†í•˜ê¸°
                </button>
            </form>
        </div>
    </div>

    <div id="chat-container" class="flex flex-1 overflow-hidden hidden">
        <div class="flex flex-col flex-1 overflow-hidden p-4">
            <header class="flex items-center justify-between p-2 mb-4 border-b border-gray-700 md:hidden">
                <h1 class="text-xl font-bold text-indigo-400">ë©€í‹°ë²„ìŠ¤ ì±„íŒ…ë°©</h1>
                <button id="toggle-user-list" class="text-gray-300 hover:text-indigo-400 p-2 rounded-md">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-5m0 5l-5-5M4 4h5V4m0 0l-5 5m0 5v5h5M4 20l5-5m5-5l5-5M19 4l-5 5"/></svg>
                </button>
            </header>
            
            <div id="chat-window" class="flex-1 overflow-y-auto bg-gray-800 p-4 rounded-lg shadow-inner mb-4">
                </div>

            <form id="message-form" class="flex gap-2">
                <textarea id="message-input" rows="1" class="flex-1 p-3 bg-gray-700 border border-gray-600 rounded-lg resize-none focus:outline-none focus:ring-2 focus:ring-indigo-500 sm:text-sm" placeholder="ë©”ì‹œì§€ ë˜ëŠ” ëª…ë ¹ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš” (!ëª…ë ¹ì–´)" required oninput="this.style.height='40px'; this.style.height = (this.scrollHeight)+'px';"></textarea>
                <button type="submit" class="bg-indigo-600 text-white py-2 px-4 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 whitespace-nowrap">
                    ì „ì†¡
                </button>
            </form>
        </div>

        <div id="user-list-container" class="hidden md:flex md:flex-col bg-gray-900 w-64 p-4 border-l border-gray-700 md:relative absolute right-0 top-0 bottom-0 z-10">
            <header class="flex items-center justify-between mb-4">
                <h2 class="text-lg font-semibold text-gray-200">ì ‘ì†ì ëª©ë¡ (<span id="user-count">0</span>)</h2>
                <button id="close-user-list" class="text-gray-400 hover:text-white md:hidden">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </header>
            <ul id="user-list" class="flex-1 overflow-y-auto space-y-2">
                </ul>
            <footer class="mt-4 pt-4 border-t border-gray-700">
                <p id="my-nickname" class="text-sm font-medium text-indigo-400"></p>
                <p class="text-xs text-gray-500 mt-1">**Admin** ì ‘ì† ì‹œ ë¹„ë°€ë²ˆí˜¸ '123'</p>
            </footer>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // í´ë¼ì´ì–¸íŠ¸ì—ì„œ ì„œë²„ì˜ í¬íŠ¸ ë²ˆí˜¸ë¥¼ ë™ì ìœ¼ë¡œ ê°€ì ¸ì™€ ì—°ê²°
            const socket = io('http://' + document.domain + ':5001');
            const loginForm = document.getElementById('login-form');
            const loginModal = document.getElementById('login-modal');
            const chatContainer = document.getElementById('chat-container');
            const messageForm = document.getElementById('message-form');
            const messageInput = document.getElementById('message-input');
            const userList = document.getElementById('user-list');
            const userCountSpan = document.getElementById('user-count');
            const myNicknameP = document.getElementById('my-nickname');
            const userListContainer = document.getElementById('user-list-container');
            const toggleButton = document.getElementById('toggle-user-list');
            const closeButton = document.getElementById('close-user-list');

            let currentNickname = ''; // í´ë¼ì´ì–¸íŠ¸ì˜ í˜„ì¬ ë‹‰ë„¤ì„ ì €ì¥

            // 1. ë‹‰ë„¤ì„ ìš”ì²­ ìˆ˜ì‹  ì‹œ ë¡œê·¸ì¸ ëª¨ë‹¬ í‘œì‹œ
            socket.on('request_nickname', () => {
                loginModal.classList.remove('hidden');
                chatContainer.classList.add('hidden');
            });

            // 2. ë‹‰ë„¤ì„ ë“±ë¡ ì‹œë„
            if (loginForm) {
                loginForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const nickname = document.getElementById('nickname-input').value.trim();
                    const password = document.getElementById('password-input').value;
                    
                    if (nickname) {
                        document.getElementById('connect-button').disabled = true;
                        document.getElementById('connect-button').innerText = 'ì ‘ì† ì¤‘...';
                        
                        socket.emit('register_nickname', {
                            nickname: nickname,
                            password: password
                        });
                    }
                });
            }

            // 3. ë‹‰ë„¤ì„ ë“±ë¡ ì„±ê³µ
            socket.on('registration_success', (data) => {
                currentNickname = data.nickname;
                loginModal.classList.add('hidden');
                chatContainer.classList.remove('hidden');
                messageInput.focus();
                
                // ë‚´ ë‹‰ë„¤ì„ ë° ê´€ë¦¬ì ìƒíƒœ í‘œì‹œ
                let nickText = data.nickname;
                if (data.is_admin) {
                    nickText = `ğŸ‘‘ ${nickText} (Admin)`;
                }
                myNicknameP.innerText = `ì ‘ì† ë‹‰ë„¤ì„: ${nickText}`;
                
                // ì ‘ì† ì„±ê³µ ë©”ì‹œì§€
                appendMessage('âœ… ì„œë²„ì— ì ‘ì†í–ˆìŠµë‹ˆë‹¤. í™˜ì˜í•©ë‹ˆë‹¤!', 'system');
                appendMessage('ğŸ’¬ **!ëª…ë ¹ì–´** ë¥¼ ì…ë ¥í•˜ì—¬ ì‚¬ìš© ê°€ëŠ¥í•œ ëª…ë ¹ì–´ë¥¼ í™•ì¸í•´ë³´ì„¸ìš”.', 'system');
            });

            // 4. ë‹‰ë„¤ì„ ë“±ë¡ ì‹¤íŒ¨
            socket.on('registration_failure', (data) => {
                const status = document.getElementById('login-status');
                status.innerText = `âŒ ${data.message}`;
                status.classList.remove('hidden');
                document.getElementById('connect-button').disabled = false;
                document.getElementById('connect-button').innerText = 'ì ‘ì†í•˜ê¸°';
            });

            // 5. ë©”ì‹œì§€ ìˆ˜ì‹  ë° ì¶œë ¥
            socket.on('message', (data) => {
                appendMessage(data.msg, data.type);
            });
            
            // 6. ì ‘ì†ì ëª©ë¡ ì—…ë°ì´íŠ¸
            socket.on('update_users', (data) => {
                userList.innerHTML = '';
                userCountSpan.innerText = data.users.length;
                data.users.forEach(text => {
                    const li = document.createElement('li');
                    li.className = 'text-sm p-1 rounded hover:bg-gray-800';
                    li.innerText = text;
                    userList.appendChild(li);
                });
            });

            // 7. ë©”ì‹œì§€ ì „ì†¡
            if (messageForm) {
                messageForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const msg = messageInput.value.trim();
                    if (msg) {
                        socket.emit('message', { msg: msg });
                        messageInput.value = '';
                        messageInput.style.height = '40px'; // ë†’ì´ ì´ˆê¸°í™”
                    }
                });
            }

            // 8. ê°•ì œ ì—°ê²° í•´ì œ (Admin ì¶”ë°© ë“±)
            socket.on('force_disconnect', () => {
                socket.disconnect();
                appendMessage('ğŸš¨ ì„œë²„ ê´€ë¦¬ìì— ì˜í•´ ì—°ê²°ì´ ê°•ì œ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.', 'system');
                loginModal.classList.remove('hidden');
                chatContainer.classList.add('hidden');
            });

            // 9. ë©”ì‹œì§€ë¥¼ ì±„íŒ… ì°½ì— ì¶”ê°€í•˜ëŠ” í•¨ìˆ˜
            function appendMessage(message, type='general') {
                const window = document.getElementById('chat-window');
                const div = document.createElement('div');
                div.className = 'message ' + type;

                if (type === 'general' || type === 'system') {
                    // ì¼ë°˜/ì‹œìŠ¤í…œ ë©”ì‹œì§€ëŠ” HTML íƒœê·¸ë¥¼ í•´ì„í•˜ê³  ì¤„ ë°”ê¿ˆì„ <br>ë¡œ ì²˜ë¦¬
                    // (ì¼ë°˜ ë©”ì‹œì§€ì˜ ë‹‰ë„¤ì„ íƒœê·¸ ì²˜ë¦¬ë¥¼ ìœ„í•´ innerHTML ì‚¬ìš©)
                    div.innerHTML = message.replace(/\n/g, '<br>'); 
                } else {
                    // ëª…ë ¹ì–´ ê²°ê³¼ë‚˜ ì±—ë´‡ ë©”ì‹œì§€ëŠ” pre-wrap CSSë¥¼ ì‚¬ìš©í•˜ê¸° ìœ„í•´ innerTextë¡œ ì•ˆì „í•˜ê²Œ ì‚½ì…
                    // ëŒ€ì‹  ì¤„ ë°”ê¿ˆ(
)ì´ ê·¸ëŒ€ë¡œ ìœ ì§€ë˜ë„ë¡ CSS (white-space: pre-wrap)ë¥¼ ì‚¬ìš©í•¨.
                    div.innerText = message;
                }

                window.appendChild(div);
                // ìŠ¤í¬ë¡¤ì„ í•­ìƒ ìµœí•˜ë‹¨ìœ¼ë¡œ ë‚´ë¦½ë‹ˆë‹¤.
                window.scrollTop = window.scrollHeight;
            }
            
            // 10. í…ìŠ¤íŠ¸ ì˜ì—­ ìë™ í¬ê¸° ì¡°ì ˆ ë° ì—”í„° ì „ì†¡ ì²˜ë¦¬
            // ìë™ í¬ê¸° ì¡°ì ˆì€ input ì´ë²¤íŠ¸ì— inlineìœ¼ë¡œ ì²˜ë¦¬í–ˆìŠµë‹ˆë‹¤.
            if (messageInput) {
                // ì—”í„° í‚¤ ì…ë ¥ ì‹œ ì „ì†¡ (Shift + EnterëŠ” ì¤„ ë°”ê¿ˆ)
                messageInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        messageForm.dispatchEvent(new Event('submit'));
                    }
                });
            }
            
            // 11. ëª¨ë°”ì¼ ì‚¬ìš©ì ëª©ë¡ í† ê¸€ ê¸°ëŠ¥
            // ë¯¸ë””ì—„ ì‚¬ì´ì¦ˆ(md) ë¯¸ë§Œì—ì„œë§Œ í† ê¸€ ì‘ë™
            if (window.innerWidth < 768) {
                // ì´ˆê¸° ìƒíƒœ: ëª¨ë°”ì¼ì—ì„œëŠ” ì‚¬ìš©ì ëª©ë¡ ìˆ¨ê¹€
                userListContainer.classList.add('hidden');
                userListContainer.classList.remove('flex');

                if (toggleButton) {
                    toggleButton.addEventListener('click', () => {
                        userListContainer.classList.toggle('hidden');
                        userListContainer.classList.toggle('flex');
                    });
                }
                if (closeButton) {
                    closeButton.addEventListener('click', () => {
                        userListContainer.classList.add('hidden');
                        userListContainer.classList.remove('flex');
                    });
                }
            }
            
            // 12. ì—°ê²° í•´ì œ ë° ì˜¤ë¥˜ ì²˜ë¦¬
            socket.on('disconnect', () => {
                appendMessage('ğŸš¨ ì„œë²„ì™€ ì—°ê²°ì´ ëŠì–´ì¡ŒìŠµë‹ˆë‹¤. ìƒˆë¡œê³ ì¹¨ í›„ ë‹¤ì‹œ ì ‘ì†í•´ ì£¼ì„¸ìš”.', 'system');
            });
            
            socket.on('connect_error', (error) => {
                document.getElementById('login-status').innerText = `âŒ ì„œë²„ ì—°ê²° ì˜¤ë¥˜: ${error.message}. ì„œë²„ê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸í•˜ì„¸ìš”.`;
                document.getElementById('login-status').classList.remove('hidden');
                document.getElementById('connect-button').disabled = false;
                document.getElementById('connect-button').innerText = 'ì ‘ì†í•˜ê¸°';
            });

        });
    </script>
</body>
</html>
